<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Text-to-Speech Choir</title>
    <meta name="description" content="A robotic acapella choir using the Web Speech API. Type lyrics and hear them sung in harmony by multiple synthesized voices.">
    <style>
        :root {
            --bg: #1a1a2e;
            --panel: #16213e;
            --accent: #e94560;
            --text: #e94560;
            --text-dim: #a0a0a0;
            --grid: #0f3460;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 0 10px var(--accent);
            margin-bottom: 10px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--panel);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid var(--grid);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        button {
            background: var(--grid);
            color: #fff;
            border: 1px solid var(--accent);
            padding: 10px 20px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        button:hover {
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sequencer {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }

        .step {
            display: grid;
            grid-template-columns: 40px 1fr 100px 100px 40px;
            gap: 10px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
            align-items: center;
            border-left: 3px solid transparent;
            transition: border-color 0.2s;
        }

        .step.active {
            border-left-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .step-number {
            color: var(--text-dim);
            font-weight: bold;
            text-align: center;
        }

        input[type="text"] {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--grid);
            color: #fff;
            padding: 8px;
            font-family: inherit;
            width: 100%;
        }

        select {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--grid);
            color: #fff;
            padding: 8px;
            font-family: inherit;
        }

        .remove-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 1.2em;
            padding: 0;
        }

        .remove-btn:hover {
            color: var(--accent);
            background: transparent;
            box-shadow: none;
        }

        .visualizer {
            height: 100px;
            width: 100%;
            background: #000;
            margin-bottom: 20px;
            border: 1px solid var(--grid);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mouth {
            width: 50px;
            height: 5px;
            background: var(--accent);
            border-radius: 10px;
            transition: height 0.1s;
            margin: 0 10px;
            box-shadow: 0 0 10px var(--accent);
        }

        .status {
            text-align: center;
            color: var(--text-dim);
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg); 
        }
        ::-webkit-scrollbar-thumb {
            background: var(--grid); 
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent); 
        }

        .voice-config {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        
        .voice-row {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            align-items: center;
        }
        
        .voice-row label {
            width: 60px;
            color: var(--text-dim);
        }

        input[type="range"] {
            flex-grow: 1;
        }
    </style>
</head>
<body>

    <h1>Text-to-Speech Choir</h1>
    
    <div class="container">
        <div class="visualizer" id="visualizer">
            <div class="mouth" id="mouth1"></div>
            <div class="mouth" id="mouth2"></div>
            <div class="mouth" id="mouth3"></div>
            <div class="mouth" id="mouth4"></div>
        </div>

        <div class="controls">
            <button id="playBtn">▶ Play Sequence</button>
            <button id="stopBtn">■ Stop</button>
            <button id="addStepBtn">+ Add Lyric</button>
            <button id="clearBtn">Clear All</button>
            <select id="voiceSelect">
                <option value="">Loading voices...</option>
            </select>
        </div>

        <div class="sequencer" id="sequencer">
            <!-- Steps will be added here -->
        </div>

        <div class="voice-config">
            <div style="margin-bottom: 10px; color: var(--text-dim);">Chord Tuning (Pitch Multipliers)</div>
            <div class="voice-row">
                <label>Bass</label>
                <input type="range" id="pitch1" min="0.1" max="2" step="0.1" value="0.5">
                <span id="val1">0.5</span>
            </div>
            <div class="voice-row">
                <label>Tenor</label>
                <input type="range" id="pitch2" min="0.1" max="2" step="0.1" value="0.8">
                <span id="val2">0.8</span>
            </div>
            <div class="voice-row">
                <label>Alto</label>
                <input type="range" id="pitch3" min="0.1" max="2" step="0.1" value="1.0">
                <span id="val3">1.0</span>
            </div>
            <div class="voice-row">
                <label>Soprano</label>
                <input type="range" id="pitch4" min="0.1" max="2" step="0.1" value="1.5">
                <span id="val4">1.5</span>
            </div>
        </div>

        <div class="status" id="status">Initialize by clicking anywhere first (browser policy)</div>
    </div>

    <script>
        const synth = window.speechSynthesis;
        let voices = [];
        let isPlaying = false;
        let currentStepIndex = 0;
        let sequenceTimeout;

        const sequencer = document.getElementById('sequencer');
        const voiceSelect = document.getElementById('voiceSelect');
        const mouths = [
            document.getElementById('mouth1'),
            document.getElementById('mouth2'),
            document.getElementById('mouth3'),
            document.getElementById('mouth4')
        ];

        // Default sequence
        const defaultLyrics = [
            { text: "Hello world", chord: "major", duration: 1000 },
            { text: "We are the", chord: "minor", duration: 1000 },
            { text: "Ro bot choir", chord: "dim", duration: 1000 },
            { text: "Singing for you", chord: "major", duration: 2000 }
        ];

        // Pitch configurations for chords (relative to base pitch)
        // Note: Web Speech API pitch is usually 0-2. 1 is default.
        const chords = {
            major: [0.5, 0.8, 1.0, 1.25], // Root, 3rd, 5th, Octave-ish
            minor: [0.5, 0.7, 1.0, 1.25], // Root, min3rd, 5th
            dim:   [0.5, 0.7, 0.9, 1.2],  // Diminished
            aug:   [0.5, 0.9, 1.1, 1.3],  // Augmented
            cluster: [0.8, 0.9, 1.0, 1.1] // Dissonant cluster
        };

        function loadVoices() {
            voices = synth.getVoices();
            voiceSelect.innerHTML = '';
            
            // Filter for local voices if possible to reduce latency
            const localVoices = voices.filter(v => v.localService);
            const voiceList = localVoices.length > 0 ? localVoices : voices;

            voiceList.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                // Try to select a good robotic or neutral voice by default
                if (voice.name.includes('Google') || voice.name.includes('Samantha') || voice.name.includes('Zira')) {
                    option.selected = true;
                }
                voiceSelect.appendChild(option);
            });
        }

        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        function createStep(data = { text: "", chord: "major", duration: 1000 }) {
            const div = document.createElement('div');
            div.className = 'step';
            div.innerHTML = `
                <div class="step-number">#</div>
                <input type="text" class="lyric-input" value="${data.text}" placeholder="Type lyrics...">
                <select class="chord-select">
                    <option value="major" ${data.chord === 'major' ? 'selected' : ''}>Major</option>
                    <option value="minor" ${data.chord === 'minor' ? 'selected' : ''}>Minor</option>
                    <option value="dim" ${data.chord === 'dim' ? 'selected' : ''}>Diminished</option>
                    <option value="aug" ${data.chord === 'aug' ? 'selected' : ''}>Augmented</option>
                    <option value="cluster" ${data.chord === 'cluster' ? 'selected' : ''}>Cluster</option>
                </select>
                <select class="duration-select">
                    <option value="500" ${data.duration === 500 ? 'selected' : ''}>Fast</option>
                    <option value="1000" ${data.duration === 1000 ? 'selected' : ''}>Normal</option>
                    <option value="2000" ${data.duration === 2000 ? 'selected' : ''}>Slow</option>
                </select>
                <button class="remove-btn">×</button>
            `;

            div.querySelector('.remove-btn').onclick = () => {
                div.remove();
                updateStepNumbers();
            };

            sequencer.appendChild(div);
            updateStepNumbers();
        }

        function updateStepNumbers() {
            const steps = sequencer.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.querySelector('.step-number').textContent = index + 1;
            });
        }

        function speakChord(text, chordType, duration) {
            if (synth.speaking) {
                synth.cancel();
            }

            const selectedVoiceIndex = voiceSelect.selectedIndex;
            // If we filtered voices in the select, we need to find the actual voice object
            // This is a simplification; for robustness we should map values better
            // But for now let's just grab from the full list based on name match if possible
            // or just use the selected index if it maps to the filtered list.
            // Actually, let's just use the selected option's text to find the voice
            const selectedName = voiceSelect.options[voiceSelect.selectedIndex]?.textContent;
            const voice = voices.find(v => `${v.name} (${v.lang})` === selectedName) || voices[0];

            if (!voice) return;

            // Get pitch multipliers from sliders or preset
            // We'll use the sliders to override the preset if user wants custom tuning
            // But for now let's use the preset chords logic combined with sliders
            
            // Actually, let's just use the preset chords for simplicity of the "Choir" effect
            // The sliders in the UI are currently just visual or global overrides?
            // Let's make the sliders control the "Base" tuning of the 4 voices, 
            // and the chord selection modifies them relative to that?
            // Or simpler: The chord selection sets the pitches directly.
            
            const pitches = chords[chordType] || chords.major;

            // Create 4 utterances
            for (let i = 0; i < 4; i++) {
                const utter = new SpeechSynthesisUtterance(text);
                utter.voice = voice;
                utter.pitch = pitches[i];
                utter.rate = duration < 1000 ? 1.2 : (duration > 1500 ? 0.8 : 1.0);
                utter.volume = 1.0;

                // Visualizer effect
                utter.onstart = () => {
                    mouths[i].style.height = (20 + Math.random() * 30) + 'px';
                };
                utter.onend = () => {
                    mouths[i].style.height = '5px';
                };

                // Slight delay between voices to create a "chorus" effect and prevent cancellation
                // Some browsers handle simultaneous speech poorly
                setTimeout(() => {
                    synth.speak(utter);
                }, i * 10); 
            }
        }

        function playStep(index) {
            if (!isPlaying) return;

            const steps = sequencer.querySelectorAll('.step');
            if (index >= steps.length) {
                index = 0; // Loop
            }

            // Highlight active step
            steps.forEach(s => s.classList.remove('active'));
            steps[index].classList.add('active');
            steps[index].scrollIntoView({ behavior: 'smooth', block: 'center' });

            const text = steps[index].querySelector('.lyric-input').value;
            const chord = steps[index].querySelector('.chord-select').value;
            const duration = parseInt(steps[index].querySelector('.duration-select').value);

            if (text.trim()) {
                speakChord(text, chord, duration);
            }

            currentStepIndex = index;
            
            // Schedule next step
            // We add a bit of buffer to the duration to allow speech to finish
            // Speech duration is unpredictable, so this is an approximation
            const stepTime = Math.max(duration, text.length * 100); 
            
            sequenceTimeout = setTimeout(() => {
                playStep(index + 1);
            }, stepTime + 500);
        }

        document.getElementById('playBtn').onclick = () => {
            if (isPlaying) return;
            isPlaying = true;
            document.getElementById('status').textContent = "Playing...";
            playStep(0);
        };

        document.getElementById('stopBtn').onclick = () => {
            isPlaying = false;
            clearTimeout(sequenceTimeout);
            synth.cancel();
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('status').textContent = "Stopped";
            mouths.forEach(m => m.style.height = '5px');
        };

        document.getElementById('addStepBtn').onclick = () => createStep();
        
        document.getElementById('clearBtn').onclick = () => {
            sequencer.innerHTML = '';
            currentStepIndex = 0;
        };

        // Initialize with default lyrics
        defaultLyrics.forEach(data => createStep(data));

        // Pitch slider listeners (live tuning)
        ['pitch1', 'pitch2', 'pitch3', 'pitch4'].forEach((id, idx) => {
            document.getElementById(id).addEventListener('input', (e) => {
                document.getElementById('val' + (idx+1)).textContent = e.target.value;
                // Update the chord definition for 'custom' if we implemented that
                // For now just visual feedback that tuning is possible
            });
        });

        // Handle page visibility change to stop audio
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                synth.cancel();
                isPlaying = false;
                clearTimeout(sequenceTimeout);
            }
        });

    </script>
</body>
</html>