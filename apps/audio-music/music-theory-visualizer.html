<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Theory Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e4;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-button {
            padding: 12px 24px;
            background: #2d3561;
            border: 2px solid #3d4574;
            color: #e4e4e4;
            cursor: pointer;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: #3d4574;
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: #4ecdc4;
            color: #1a1a2e;
            border-color: #4ecdc4;
        }

        .tab-content {
            display: none;
            background: #1e2749;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #4ecdc4;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }

        select, button {
            padding: 10px 20px;
            background: #2d3561;
            border: 2px solid #3d4574;
            color: #e4e4e4;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #3d4574;
            border-color: #4ecdc4;
        }

        button:active {
            transform: scale(0.95);
        }

        .play-button {
            background: #4ecdc4;
            color: #1a1a2e;
            font-weight: bold;
        }

        .play-button:hover {
            background: #45b7d1;
        }

        #circleCanvas {
            display: block;
            margin: 20px auto;
            background: #141b33;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(78, 205, 196, 0.3);
        }

        .piano {
            display: flex;
            margin: 20px auto;
            width: fit-content;
            position: relative;
            height: 200px;
            background: #0a0e1a;
            padding: 10px;
            border-radius: 8px;
        }

        .key {
            width: 40px;
            height: 180px;
            background: white;
            border: 2px solid #333;
            position: relative;
            cursor: pointer;
            transition: all 0.1s;
        }

        .key:hover {
            background: #f0f0f0;
        }

        .key.white {
            z-index: 1;
        }

        .key.black {
            width: 28px;
            height: 110px;
            background: #1a1a1a;
            border: 2px solid #000;
            margin-left: -14px;
            margin-right: -14px;
            z-index: 2;
        }

        .key.black:hover {
            background: #333;
        }

        .key.active {
            background: #ff6b6b !important;
            box-shadow: 0 0 15px #ff6b6b;
        }

        .key.root {
            background: #4ecdc4 !important;
            box-shadow: 0 0 15px #4ecdc4;
        }

        .key-label {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }

        .key.black .key-label {
            color: #fff;
            bottom: 5px;
        }

        .info-panel {
            background: #141b33;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .info-panel h3 {
            color: #4ecdc4;
            margin-bottom: 10px;
        }

        .info-panel p {
            margin: 5px 0;
            line-height: 1.6;
        }

        .chord-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .chord-button {
            padding: 15px;
            background: #2d3561;
            border: 2px solid #3d4574;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .chord-button:hover {
            background: #3d4574;
            border-color: #4ecdc4;
        }

        .chord-button.selected {
            background: #4ecdc4;
            color: #1a1a2e;
            border-color: #4ecdc4;
        }

        .progression-builder {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .progression-slot {
            min-width: 60px;
            padding: 15px;
            background: #2d3561;
            border: 2px dashed #3d4574;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .progression-slot:hover {
            border-color: #4ecdc4;
        }

        .progression-slot.filled {
            background: #4ecdc4;
            color: #1a1a2e;
            border-style: solid;
        }

        .preset-progressions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .preset-button {
            padding: 10px 15px;
            background: #2d3561;
            border: 2px solid #3d4574;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .preset-button:hover {
            background: #3d4574;
        }

        .fretboard {
            margin: 20px auto;
            background: #8b4513;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }

        .fret-row {
            display: flex;
            margin-bottom: 15px;
            position: relative;
        }

        .fret {
            width: 60px;
            height: 30px;
            border-right: 2px solid #666;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fret:first-child {
            border-left: 4px solid #333;
        }

        .fret-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            position: absolute;
            box-shadow: 0 0 10px #4ecdc4;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a2e;
            font-weight: bold;
        }

        .string-label {
            width: 40px;
            text-align: right;
            padding-right: 10px;
            font-weight: bold;
            color: #e4e4e4;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .interval-trainer {
            text-align: center;
        }

        .interval-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .interval-button {
            padding: 15px;
            background: #2d3561;
            border: 2px solid #3d4574;
            border-radius: 8px;
            cursor: pointer;
        }

        .interval-button:hover {
            background: #3d4574;
        }

        .interval-button.correct {
            background: #51cf66;
            border-color: #51cf66;
        }

        .interval-button.incorrect {
            background: #ff6b6b;
            border-color: #ff6b6b;
        }

        .score {
            font-size: 1.5em;
            margin: 20px 0;
            color: #4ecdc4;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            width: 150px;
        }

        .staff {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .staff-lines {
            position: relative;
            height: 100px;
            margin: 20px 0;
        }

        .staff-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #333;
        }

        .note-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1a1a2e;
            transform: translate(-50%, -50%);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .tab-content {
                padding: 15px;
            }

            .piano {
                transform: scale(0.8);
            }

            #circleCanvas {
                width: 300px !important;
                height: 300px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Music Theory Visualizer</h1>

        <div class="tabs">
            <button class="tab-button active" data-tab="circle">Circle of Fifths</button>
            <button class="tab-button" data-tab="scales">Scale Visualizer</button>
            <button class="tab-button" data-tab="chords">Chord Builder</button>
            <button class="tab-button" data-tab="progressions">Progressions</button>
            <button class="tab-button" data-tab="fretboard">Fretboard</button>
            <button class="tab-button" data-tab="trainer">Interval Trainer</button>
        </div>

        <div class="volume-control" style="text-align: center; margin-bottom: 20px;">
            <label>Volume:</label>
            <input type="range" id="volumeSlider" min="0" max="100" value="30">
            <span id="volumeLabel">30%</span>
        </div>

        <!-- Circle of Fifths Tab -->
        <div class="tab-content active" data-tab="circle">
            <h2 class="section-title">Circle of Fifths</h2>
            <p style="text-align: center; margin-bottom: 20px;">Click any note to explore its key relationships</p>
            <canvas id="circleCanvas" width="500" height="500"></canvas>
            <div class="info-panel" id="circleInfo">
                <h3>Key Information</h3>
                <p>Click a note on the circle to see key details</p>
            </div>
        </div>

        <!-- Scale Visualizer Tab -->
        <div class="tab-content" data-tab="scales">
            <h2 class="section-title">Scale Visualizer</h2>
            <div class="controls">
                <select id="scaleRoot">
                    <option value="C">C</option>
                    <option value="C#">C# / Db</option>
                    <option value="D">D</option>
                    <option value="D#">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F# / Gb</option>
                    <option value="G">G</option>
                    <option value="G#">G# / Ab</option>
                    <option value="A">A</option>
                    <option value="A#">A# / Bb</option>
                    <option value="B">B</option>
                </select>
                <select id="scaleType">
                    <option value="major">Major</option>
                    <option value="natural_minor">Natural Minor</option>
                    <option value="harmonic_minor">Harmonic Minor</option>
                    <option value="melodic_minor">Melodic Minor</option>
                    <option value="dorian">Dorian</option>
                    <option value="phrygian">Phrygian</option>
                    <option value="lydian">Lydian</option>
                    <option value="mixolydian">Mixolydian</option>
                    <option value="locrian">Locrian</option>
                    <option value="pentatonic_major">Pentatonic Major</option>
                    <option value="pentatonic_minor">Pentatonic Minor</option>
                    <option value="blues">Blues</option>
                    <option value="chromatic">Chromatic</option>
                    <option value="whole_tone">Whole Tone</option>
                </select>
                <button class="play-button" id="playScale">Play Scale</button>
            </div>
            <div id="scalePiano" class="piano"></div>
            <div class="info-panel" id="scaleInfo">
                <h3>Scale Information</h3>
                <p id="scaleNotes">Notes: -</p>
                <p id="scaleIntervals">Intervals: -</p>
                <p id="scaleDegrees">Degrees: -</p>
            </div>
        </div>

        <!-- Chord Builder Tab -->
        <div class="tab-content" data-tab="chords">
            <h2 class="section-title">Chord Builder</h2>
            <div class="controls">
                <select id="chordRoot">
                    <option value="C">C</option>
                    <option value="C#">C# / Db</option>
                    <option value="D">D</option>
                    <option value="D#">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F# / Gb</option>
                    <option value="G">G</option>
                    <option value="G#">G# / Ab</option>
                    <option value="A">A</option>
                    <option value="A#">A# / Bb</option>
                    <option value="B">B</option>
                </select>
                <select id="chordType">
                    <option value="major">Major</option>
                    <option value="minor">Minor</option>
                    <option value="dim">Diminished</option>
                    <option value="aug">Augmented</option>
                    <option value="maj7">Major 7th</option>
                    <option value="min7">Minor 7th</option>
                    <option value="dom7">Dominant 7th</option>
                    <option value="dim7">Diminished 7th</option>
                    <option value="sus2">Sus2</option>
                    <option value="sus4">Sus4</option>
                    <option value="add9">Add9</option>
                </select>
                <button class="play-button" id="playChordArp">Play (Arpeggiated)</button>
                <button class="play-button" id="playChordTogether">Play (Together)</button>
            </div>
            <div id="chordPiano" class="piano"></div>
            <div class="staff">
                <h3 style="color: #1a1a2e; margin-bottom: 10px;">Staff Notation</h3>
                <div class="staff-lines" id="staffLines">
                    <div class="staff-line" style="top: 0;"></div>
                    <div class="staff-line" style="top: 25%;"></div>
                    <div class="staff-line" style="top: 50%;"></div>
                    <div class="staff-line" style="top: 75%;"></div>
                    <div class="staff-line" style="top: 100%;"></div>
                </div>
            </div>
            <div class="info-panel" id="chordInfo">
                <h3>Chord Information</h3>
                <p id="chordNotes">Notes: -</p>
                <p id="chordIntervals">Intervals: -</p>
                <p id="chordFormula">Formula: -</p>
            </div>
        </div>

        <!-- Progressions Tab -->
        <div class="tab-content" data-tab="progressions">
            <h2 class="section-title">Chord Progression Builder</h2>
            <div class="controls">
                <select id="progressionKey">
                    <option value="C">C Major</option>
                    <option value="C#">C# Major</option>
                    <option value="D">D Major</option>
                    <option value="D#">D# Major</option>
                    <option value="E">E Major</option>
                    <option value="F">F Major</option>
                    <option value="F#">F# Major</option>
                    <option value="G">G Major</option>
                    <option value="G#">G# Major</option>
                    <option value="A">A Major</option>
                    <option value="A#">A# Major</option>
                    <option value="B">B Major</option>
                </select>
                <button class="play-button" id="playProgression">Play Progression</button>
                <button id="clearProgression">Clear</button>
            </div>

            <h3 style="margin: 20px 0; color: #4ecdc4;">Diatonic Chords (Click to add)</h3>
            <div class="chord-grid" id="diatonicChords"></div>

            <h3 style="margin: 20px 0; color: #4ecdc4;">Your Progression</h3>
            <div class="progression-builder" id="progressionSlots"></div>

            <h3 style="margin: 20px 0; color: #4ecdc4;">Common Progressions</h3>
            <div class="preset-progressions">
                <button class="preset-button" data-progression="I,V,vi,IV">I-V-vi-IV (Pop)</button>
                <button class="preset-button" data-progression="I,IV,V,I">I-IV-V-I (Classic)</button>
                <button class="preset-button" data-progression="ii,V,I">ii-V-I (Jazz)</button>
                <button class="preset-button" data-progression="I,vi,IV,V">I-vi-IV-V (50s)</button>
                <button class="preset-button" data-progression="vi,IV,I,V">vi-IV-I-V (Emotional)</button>
                <button class="preset-button" data-progression="I,I,I,I,IV,IV,I,I,V,IV,I,V">12-Bar Blues</button>
            </div>
        </div>

        <!-- Fretboard Tab -->
        <div class="tab-content" data-tab="fretboard">
            <h2 class="section-title">Guitar Fretboard</h2>
            <div class="controls">
                <select id="fretboardRoot">
                    <option value="C">C</option>
                    <option value="C#">C# / Db</option>
                    <option value="D">D</option>
                    <option value="D#">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F# / Gb</option>
                    <option value="G">G</option>
                    <option value="G#">G# / Ab</option>
                    <option value="A">A</option>
                    <option value="A#">A# / Bb</option>
                    <option value="B">B</option>
                </select>
                <select id="fretboardScale">
                    <option value="major">Major Scale</option>
                    <option value="natural_minor">Natural Minor</option>
                    <option value="pentatonic_major">Pentatonic Major</option>
                    <option value="pentatonic_minor">Pentatonic Minor</option>
                    <option value="blues">Blues</option>
                </select>
            </div>
            <div class="fretboard" id="guitarFretboard"></div>
            <p style="text-align: center; margin-top: 20px; color: #4ecdc4;">Standard Tuning: E A D G B E</p>
        </div>

        <!-- Interval Trainer Tab -->
        <div class="tab-content" data-tab="trainer">
            <h2 class="section-title">Interval Ear Trainer</h2>
            <div class="interval-trainer">
                <p style="margin-bottom: 20px;">Listen to the two notes and identify the interval</p>
                <button class="play-button" id="playInterval" style="font-size: 1.2em; padding: 15px 30px;">Play Interval</button>
                <div class="score">Score: <span id="correctCount">0</span> / <span id="totalCount">0</span></div>
                <div class="interval-buttons" id="intervalButtons"></div>
                <button id="newInterval" style="margin-top: 20px;">New Interval</button>
            </div>
        </div>
    </div>

    <script>
        // Audio Context
        let audioCtx = null;
        let masterVolume = 0.3;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkoneAudioContext)();
            }
            return audioCtx;
        }

        // Note frequencies (A4 = 440Hz)
        const noteFrequencies = {
            'C': 261.63, 'C#': 277.18, 'Db': 277.18,
            'D': 293.66, 'D#': 311.13, 'Eb': 311.13,
            'E': 329.63,
            'F': 349.23, 'F#': 369.99, 'Gb': 369.99,
            'G': 392.00, 'G#': 415.30, 'Ab': 415.30,
            'A': 440.00, 'A#': 466.16, 'Bb': 466.16,
            'B': 493.88
        };

        // Scale patterns (semitones from root)
        const scalePatterns = {
            major: [0, 2, 4, 5, 7, 9, 11, 12],
            natural_minor: [0, 2, 3, 5, 7, 8, 10, 12],
            harmonic_minor: [0, 2, 3, 5, 7, 8, 11, 12],
            melodic_minor: [0, 2, 3, 5, 7, 9, 11, 12],
            dorian: [0, 2, 3, 5, 7, 9, 10, 12],
            phrygian: [0, 1, 3, 5, 7, 8, 10, 12],
            lydian: [0, 2, 4, 6, 7, 9, 11, 12],
            mixolydian: [0, 2, 4, 5, 7, 9, 10, 12],
            locrian: [0, 1, 3, 5, 6, 8, 10, 12],
            pentatonic_major: [0, 2, 4, 7, 9, 12],
            pentatonic_minor: [0, 3, 5, 7, 10, 12],
            blues: [0, 3, 5, 6, 7, 10, 12],
            chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
            whole_tone: [0, 2, 4, 6, 8, 10, 12]
        };

        // Chord formulas (semitones from root)
        const chordFormulas = {
            major: [0, 4, 7],
            minor: [0, 3, 7],
            dim: [0, 3, 6],
            aug: [0, 4, 8],
            maj7: [0, 4, 7, 11],
            min7: [0, 3, 7, 10],
            dom7: [0, 4, 7, 10],
            dim7: [0, 3, 6, 9],
            sus2: [0, 2, 7],
            sus4: [0, 5, 7],
            add9: [0, 4, 7, 14]
        };

        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const circleOfFifths = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'C#', 'G#', 'D#', 'A#', 'F'];
        const circleOfFifthsFlat = ['C', 'G', 'D', 'A', 'E', 'B', 'Gb', 'Db', 'Ab', 'Eb', 'Bb', 'F'];

        // Play a note
        function playNote(frequency, duration = 0.5, startTime = 0) {
            const ctx = initAudio();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, ctx.currentTime + startTime);

            gainNode.gain.setValueAtTime(0, ctx.currentTime + startTime);
            gainNode.gain.linearRampToValueAtTime(masterVolume * 0.3, ctx.currentTime + startTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + startTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            oscillator.start(ctx.currentTime + startTime);
            oscillator.stop(ctx.currentTime + startTime + duration);

            return oscillator;
        }

        // Get note frequency at octave
        function getNoteFrequency(noteName, octave = 4) {
            const baseFreq = noteFrequencies[noteName];
            return baseFreq * Math.pow(2, octave - 4);
        }

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                button.classList.add('active');
                document.querySelector(`.tab-content[data-tab="${tab}"]`).classList.add('active');

                if (tab === 'circle') drawCircleOfFifths();
                if (tab === 'scales') updateScaleVisualization();
                if (tab === 'chords') updateChordVisualization();
                if (tab === 'progressions') updateProgressionView();
                if (tab === 'fretboard') updateFretboard();
            });
        });

        // Volume control
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            masterVolume = e.target.value / 100;
            document.getElementById('volumeLabel').textContent = e.target.value + '%';
        });

        // Circle of Fifths
        function drawCircleOfFifths(selectedNote = null) {
            const canvas = document.getElementById('circleCanvas');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 180;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw outer circle
            ctx.strokeStyle = '#3d4574';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.stroke();

            // Draw major keys
            circleOfFifthsFlat.forEach((note, i) => {
                const angle = (i * 30 - 90) * Math.PI / 180;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                const isSelected = note === selectedNote;

                ctx.fillStyle = isSelected ? '#4ecdc4' : '#ff6b6b';
                ctx.beginPath();
                ctx.arc(x, y, 30, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#1a1a2e';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(note, x, y);
            });

            // Draw inner circle for relative minors
            const innerRadius = 110;
            const relativeMinors = ['Am', 'Em', 'Bm', 'F#m', 'C#m', 'G#m', 'D#m', 'A#m', 'Fm', 'Cm', 'Gm', 'Dm'];

            relativeMinors.forEach((note, i) => {
                const angle = (i * 30 - 90) * Math.PI / 180;
                const x = centerX + innerRadius * Math.cos(angle);
                const y = centerY + innerRadius * Math.sin(angle);

                const majorNote = circleOfFifthsFlat[i];
                const isRelated = majorNote === selectedNote;

                ctx.fillStyle = isRelated ? '#45b7d1' : '#9b59b6';
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(note, x, y);
            });

            if (selectedNote) {
                updateCircleInfo(selectedNote);
            }
        }

        // Click handler for circle
        document.getElementById('circleCanvas').addEventListener('click', (e) => {
            const canvas = e.target;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 180;

            circleOfFifthsFlat.forEach((note, i) => {
                const angle = (i * 30 - 90) * Math.PI / 180;
                const noteX = centerX + radius * Math.cos(angle);
                const noteY = centerY + radius * Math.sin(angle);
                const distance = Math.sqrt((x - noteX) ** 2 + (y - noteY) ** 2);

                if (distance < 30) {
                    drawCircleOfFifths(note);
                    playNote(getNoteFrequency(note.replace('b', '#')), 0.5);
                }
            });
        });

        function updateCircleInfo(note) {
            const index = circleOfFifthsFlat.indexOf(note);
            const relativeMinor = ['Am', 'Em', 'Bm', 'F#m', 'C#m', 'G#m', 'D#m', 'A#m', 'Fm', 'Cm', 'Gm', 'Dm'][index];
            const sharps = Math.max(0, index);
            const flats = index > 6 ? 12 - index : 0;

            const info = document.getElementById('circleInfo');
            info.innerHTML = `
                <h3>${note} Major</h3>
                <p><strong>Relative Minor:</strong> ${relativeMinor}</p>
                <p><strong>Key Signature:</strong> ${sharps > 0 ? sharps + ' sharps' : flats > 0 ? flats + ' flats' : 'No sharps or flats'}</p>
                <p><strong>Dominant (V):</strong> ${circleOfFifthsFlat[(index + 1) % 12]}</p>
                <p><strong>Subdominant (IV):</strong> ${circleOfFifthsFlat[(index + 11) % 12]}</p>
            `;
        }

        // Piano keyboard generator
        function createPiano(containerId, octaves = 2) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            const keyPattern = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

            for (let octave = 4; octave < 4 + octaves; octave++) {
                keyPattern.forEach(note => {
                    const key = document.createElement('div');
                    key.className = note.includes('#') ? 'key black' : 'key white';
                    key.dataset.note = note;
                    key.dataset.octave = octave;

                    if (!note.includes('#')) {
                        const label = document.createElement('div');
                        label.className = 'key-label';
                        label.textContent = note;
                        key.appendChild(label);
                    }

                    key.addEventListener('click', () => {
                        playNote(getNoteFrequency(note, octave), 0.5);
                    });

                    container.appendChild(key);
                });
            }
        }

        // Scale Visualizer
        function updateScaleVisualization() {
            const root = document.getElementById('scaleRoot').value;
            const scaleType = document.getElementById('scaleType').value;
            const pattern = scalePatterns[scaleType];

            const rootIndex = notes.indexOf(root);
            const scaleNotes = pattern.map(interval => notes[(rootIndex + interval) % 12]);

            // Update piano
            const piano = document.getElementById('scalePiano');
            const keys = piano.querySelectorAll('.key');
            keys.forEach(key => {
                key.classList.remove('active', 'root');
                const note = key.dataset.note;
                if (scaleNotes.includes(note)) {
                    if (note === root) {
                        key.classList.add('root');
                    } else {
                        key.classList.add('active');
                    }
                }
            });

            // Update info
            const intervals = [];
            for (let i = 1; i < pattern.length; i++) {
                const diff = pattern[i] - pattern[i - 1];
                intervals.push(diff === 1 ? 'H' : diff === 2 ? 'W' : diff + 'st');
            }

            document.getElementById('scaleNotes').textContent = `Notes: ${scaleNotes.join(', ')}`;
            document.getElementById('scaleIntervals').textContent = `Intervals: ${intervals.join(' - ')}`;
            document.getElementById('scaleDegrees').textContent = `Degrees: 1 ${pattern.slice(1, -1).map((_, i) => i + 2).join(' ')} 8`;
        }

        document.getElementById('scaleRoot').addEventListener('change', updateScaleVisualization);
        document.getElementById('scaleType').addEventListener('change', updateScaleVisualization);

        document.getElementById('playScale').addEventListener('click', () => {
            const root = document.getElementById('scaleRoot').value;
            const scaleType = document.getElementById('scaleType').value;
            const pattern = scalePatterns[scaleType];

            const rootIndex = notes.indexOf(root);
            pattern.forEach((interval, i) => {
                const note = notes[(rootIndex + interval) % 12];
                const octave = interval >= 12 ? 5 : 4;
                playNote(getNoteFrequency(note, octave), 0.4, i * 0.25);
            });
        });

        // Chord Builder
        function updateChordVisualization() {
            const root = document.getElementById('chordRoot').value;
            const chordType = document.getElementById('chordType').value;
            const formula = chordFormulas[chordType];

            const rootIndex = notes.indexOf(root);
            const chordNotes = formula.map(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                return notes[noteIndex];
            });

            // Update piano
            const piano = document.getElementById('chordPiano');
            const keys = piano.querySelectorAll('.key');
            keys.forEach(key => {
                key.classList.remove('active', 'root');
                const note = key.dataset.note;
                if (chordNotes.includes(note)) {
                    if (note === root) {
                        key.classList.add('root');
                    } else {
                        key.classList.add('active');
                    }
                }
            });

            // Update staff
            updateStaff(chordNotes);

            // Update info
            const intervalNames = {
                0: 'Root', 2: 'm2', 3: 'm3', 4: 'M3', 5: 'P4',
                6: 'TT', 7: 'P5', 8: 'm6', 9: 'M6', 10: 'm7',
                11: 'M7', 14: 'M9'
            };

            document.getElementById('chordNotes').textContent = `Notes: ${chordNotes.join(', ')}`;
            document.getElementById('chordIntervals').textContent = `Intervals: ${formula.map(i => intervalNames[i] || i).join(', ')}`;
            document.getElementById('chordFormula').textContent = `Formula: ${formula.join('-')}`;
        }

        function updateStaff(chordNotes) {
            const container = document.getElementById('staffLines');
            const existingNotes = container.querySelectorAll('.note-dot');
            existingNotes.forEach(n => n.remove());

            const notePositions = {
                'C': 100, 'D': 87.5, 'E': 75, 'F': 62.5, 'G': 50,
                'A': 37.5, 'B': 25, 'C#': 93.75, 'D#': 81.25,
                'F#': 56.25, 'G#': 43.75, 'A#': 31.25
            };

            chordNotes.forEach((note, i) => {
                const dot = document.createElement('div');
                dot.className = 'note-dot';
                dot.style.left = (100 + i * 60) + 'px';
                dot.style.top = notePositions[note] + '%';
                container.appendChild(dot);
            });
        }

        document.getElementById('chordRoot').addEventListener('change', updateChordVisualization);
        document.getElementById('chordType').addEventListener('change', updateChordVisualization);

        document.getElementById('playChordArp').addEventListener('click', () => {
            const root = document.getElementById('chordRoot').value;
            const chordType = document.getElementById('chordType').value;
            const formula = chordFormulas[chordType];

            const rootIndex = notes.indexOf(root);
            formula.forEach((interval, i) => {
                const note = notes[(rootIndex + interval) % 12];
                const octave = interval >= 12 ? 5 : 4;
                playNote(getNoteFrequency(note, octave), 0.5, i * 0.2);
            });
        });

        document.getElementById('playChordTogether').addEventListener('click', () => {
            const root = document.getElementById('chordRoot').value;
            const chordType = document.getElementById('chordType').value;
            const formula = chordFormulas[chordType];

            const rootIndex = notes.indexOf(root);
            formula.forEach(interval => {
                const note = notes[(rootIndex + interval) % 12];
                const octave = interval >= 12 ? 5 : 4;
                playNote(getNoteFrequency(note, octave), 1.5);
            });
        });

        // Chord Progressions
        let currentProgression = [];

        function updateProgressionView() {
            const key = document.getElementById('progressionKey').value;
            const keyIndex = notes.indexOf(key);
            const majorScale = scalePatterns.major.slice(0, -1);

            const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'];
            const chordTypes = ['major', 'minor', 'minor', 'major', 'major', 'minor', 'dim'];

            const diatonicContainer = document.getElementById('diatonicChords');
            diatonicContainer.innerHTML = '';

            romanNumerals.forEach((numeral, i) => {
                const root = notes[(keyIndex + majorScale[i]) % 12];
                const type = chordTypes[i];

                const button = document.createElement('div');
                button.className = 'chord-button';
                button.innerHTML = `<strong>${numeral}</strong><br>${root} ${type}`;
                button.addEventListener('click', () => {
                    currentProgression.push({ numeral, root, type });
                    updateProgressionSlots();
                });
                diatonicContainer.appendChild(button);
            });

            updateProgressionSlots();
        }

        function updateProgressionSlots() {
            const container = document.getElementById('progressionSlots');
            container.innerHTML = '';

            if (currentProgression.length === 0) {
                container.innerHTML = '<p style="color: #888;">Click diatonic chords above to build your progression</p>';
                return;
            }

            currentProgression.forEach((chord, i) => {
                const slot = document.createElement('div');
                slot.className = 'progression-slot filled';
                slot.innerHTML = `<strong>${chord.numeral}</strong><br><small>${chord.root}</small>`;
                slot.addEventListener('click', () => {
                    currentProgression.splice(i, 1);
                    updateProgressionSlots();
                });
                container.appendChild(slot);
            });
        }

        document.getElementById('progressionKey').addEventListener('change', updateProgressionView);

        document.getElementById('clearProgression').addEventListener('click', () => {
            currentProgression = [];
            updateProgressionSlots();
        });

        document.getElementById('playProgression').addEventListener('click', () => {
            if (currentProgression.length === 0) return;

            currentProgression.forEach((chord, i) => {
                const formula = chordFormulas[chord.type];
                const rootIndex = notes.indexOf(chord.root);

                formula.forEach(interval => {
                    const note = notes[(rootIndex + interval) % 12];
                    playNote(getNoteFrequency(note, 4), 0.8, i * 0.8);
                });
            });
        });

        // Preset progressions
        document.querySelectorAll('.preset-button').forEach(button => {
            button.addEventListener('click', () => {
                const progression = button.dataset.progression.split(',');
                const key = document.getElementById('progressionKey').value;
                const keyIndex = notes.indexOf(key);
                const majorScale = scalePatterns.major.slice(0, -1);

                const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'];
                const chordTypes = ['major', 'minor', 'minor', 'major', 'major', 'minor', 'dim'];

                currentProgression = progression.map(numeral => {
                    const index = romanNumerals.indexOf(numeral);
                    const root = notes[(keyIndex + majorScale[index]) % 12];
                    const type = chordTypes[index];
                    return { numeral, root, type };
                });

                updateProgressionSlots();
            });
        });

        // Fretboard
        function updateFretboard() {
            const root = document.getElementById('fretboardRoot').value;
            const scaleType = document.getElementById('fretboardScale').value;
            const pattern = scalePatterns[scaleType];

            const rootIndex = notes.indexOf(root);
            const scaleNotes = pattern.map(interval => notes[(rootIndex + interval) % 12]);

            const tuning = ['E', 'A', 'D', 'G', 'B', 'E'];
            const container = document.getElementById('guitarFretboard');
            container.innerHTML = '';

            tuning.forEach(stringNote => {
                const row = document.createElement('div');
                row.className = 'fret-row';

                const label = document.createElement('div');
                label.className = 'string-label';
                label.textContent = stringNote;
                row.appendChild(label);

                const stringIndex = notes.indexOf(stringNote);

                for (let fret = 0; fret <= 12; fret++) {
                    const fretDiv = document.createElement('div');
                    fretDiv.className = 'fret';

                    const noteIndex = (stringIndex + fret) % 12;
                    const note = notes[noteIndex];

                    if (scaleNotes.includes(note)) {
                        const marker = document.createElement('div');
                        marker.className = 'fret-marker';
                        marker.textContent = note === root ? 'R' : '';
                        if (note === root) marker.style.background = '#ff6b6b';
                        fretDiv.appendChild(marker);
                    }

                    row.appendChild(fretDiv);
                }

                container.appendChild(row);
            });
        }

        document.getElementById('fretboardRoot').addEventListener('change', updateFretboard);
        document.getElementById('fretboardScale').addEventListener('change', updateFretboard);

        // Interval Trainer
        const intervals = [
            { name: 'Unison', semitones: 0 },
            { name: 'Minor 2nd', semitones: 1 },
            { name: 'Major 2nd', semitones: 2 },
            { name: 'Minor 3rd', semitones: 3 },
            { name: 'Major 3rd', semitones: 4 },
            { name: 'Perfect 4th', semitones: 5 },
            { name: 'Tritone', semitones: 6 },
            { name: 'Perfect 5th', semitones: 7 },
            { name: 'Minor 6th', semitones: 8 },
            { name: 'Major 6th', semitones: 9 },
            { name: 'Minor 7th', semitones: 10 },
            { name: 'Major 7th', semitones: 11 },
            { name: 'Octave', semitones: 12 }
        ];

        let currentInterval = null;
        let correctCount = 0;
        let totalCount = 0;

        function initIntervalTrainer() {
            const container = document.getElementById('intervalButtons');
            container.innerHTML = '';

            intervals.forEach(interval => {
                const button = document.createElement('button');
                button.className = 'interval-button';
                button.textContent = interval.name;
                button.addEventListener('click', () => checkInterval(interval, button));
                container.appendChild(button);
            });

            generateNewInterval();
        }

        function generateNewInterval() {
            currentInterval = intervals[Math.floor(Math.random() * intervals.length)];
            document.querySelectorAll('.interval-button').forEach(btn => {
                btn.classList.remove('correct', 'incorrect');
                btn.disabled = false;
            });
        }

        function checkInterval(guessed, button) {
            totalCount++;
            document.getElementById('totalCount').textContent = totalCount;

            if (guessed.semitones === currentInterval.semitones) {
                button.classList.add('correct');
                correctCount++;
                document.getElementById('correctCount').textContent = correctCount;
            } else {
                button.classList.add('incorrect');
                document.querySelectorAll('.interval-button').forEach(btn => {
                    if (btn.textContent === currentInterval.name) {
                        btn.classList.add('correct');
                    }
                });
            }

            document.querySelectorAll('.interval-button').forEach(btn => btn.disabled = true);
        }

        document.getElementById('playInterval').addEventListener('click', () => {
            if (!currentInterval) return;

            const baseNote = notes[Math.floor(Math.random() * notes.length)];
            const baseIndex = notes.indexOf(baseNote);
            const secondIndex = (baseIndex + currentInterval.semitones) % 12;
            const secondNote = notes[secondIndex];

            playNote(getNoteFrequency(baseNote, 4), 0.5, 0);
            playNote(getNoteFrequency(secondNote, 4), 0.5, 0.6);
        });

        document.getElementById('newInterval').addEventListener('click', generateNewInterval);

        // Initialize
        createPiano('scalePiano', 2);
        createPiano('chordPiano', 2);
        drawCircleOfFifths();
        updateScaleVisualization();
        updateChordVisualization();
        initIntervalTrainer();
    </script>
</body>
</html>