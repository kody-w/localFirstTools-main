<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rhythm Grid - Drum Machine & Sequencer</title>
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="audio_music">
<meta name="rappterzoo:tags" content="music,drum-machine,sequencer,audio,interactive,synthesizer">
<meta name="rappterzoo:type" content="audio">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:linear-gradient(135deg,#0a0a1a,#1a0a2a);color:#e0e0e0;font-family:'Segoe UI',Tahoma,sans-serif;min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow-x:hidden;padding:20px}
h1{font-size:28px;color:#ff6b9d;text-shadow:0 0 20px rgba(255,107,157,0.3);margin-bottom:5px;font-weight:300;letter-spacing:3px}
.subtitle{color:#666;font-size:12px;margin-bottom:20px;letter-spacing:2px}
#transport{display:flex;align-items:center;gap:12px;margin-bottom:20px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:12px 20px}
.tbtn{width:44px;height:44px;border-radius:50%;border:2px solid #444;background:rgba(255,255,255,0.05);color:#ddd;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.tbtn:hover{border-color:#ff6b9d;background:rgba(255,107,157,0.1);transform:scale(1.1)}
.tbtn.playing{border-color:#00ff88;background:rgba(0,255,136,0.15);color:#00ff88;box-shadow:0 0 15px rgba(0,255,136,0.3)}
.tbtn.recording{border-color:#ff4444;background:rgba(255,68,68,0.15);color:#ff4444;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 20px rgba(255,68,68,0.5)}}
#bpm-display{font-size:32px;color:#ff6b9d;font-weight:200;min-width:80px;text-align:center}
#bpm-label{font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px}
.bpm-ctrl{display:flex;flex-direction:column;align-items:center}
.bpm-adj{display:flex;gap:4px;margin-top:4px}
.bpm-btn{width:28px;height:22px;background:rgba(255,107,157,0.1);border:1px solid rgba(255,107,157,0.2);border-radius:4px;color:#ff6b9d;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.bpm-btn:hover{background:rgba(255,107,157,0.2);transform:translateY(-1px)}
#swing-display{font-size:14px;color:#aaa}
#grid-container{background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:15px;overflow-x:auto;max-width:100%;margin-bottom:15px}
#grid{display:flex;flex-direction:column;gap:2px;min-width:fit-content}
.grid-row{display:flex;align-items:center;gap:2px}
.row-label{width:80px;font-size:11px;color:#888;text-align:right;padding-right:8px;flex-shrink:0;white-space:nowrap}
.cell{width:36px;height:36px;border-radius:4px;cursor:pointer;transition:all 0.1s;border:1px solid transparent;position:relative}
.cell.off{background:rgba(255,255,255,0.03)}
.cell.off:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.1)}
.cell.on{box-shadow:inset 0 0 10px rgba(0,0,0,0.3)}
.cell.accent{border-color:rgba(255,255,255,0.2) !important}
.cell.playing{border-color:#fff !important;box-shadow:0 0 10px rgba(255,255,255,0.3);transform:scale(1.05)}
.cell.beat-marker{border-bottom:2px solid rgba(255,255,255,0.1)}
.step-numbers{display:flex;gap:2px;margin-left:82px;margin-bottom:4px}
.step-num{width:36px;text-align:center;font-size:9px;color:#555}
.step-num.beat{color:#888}
#kit-select{display:flex;gap:6px;margin-bottom:15px;flex-wrap:wrap;justify-content:center}
.kit-btn{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:8px 16px;color:#aaa;font-size:12px;cursor:pointer;transition:all 0.2s}
.kit-btn:hover{background:rgba(255,255,255,0.1);color:#fff}
.kit-btn.active{background:rgba(255,107,157,0.15);border-color:#ff6b9d;color:#ff6b9d}
#pattern-bar{display:flex;gap:6px;margin-bottom:15px;flex-wrap:wrap;justify-content:center}
.pat-btn{width:36px;height:30px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:5px;color:#888;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.pat-btn:hover{background:rgba(255,255,255,0.1)}
.pat-btn.active{background:rgba(255,107,157,0.15);border-color:#ff6b9d;color:#ff6b9d}
.pat-btn.has-data{background:rgba(0,255,136,0.08);border-color:rgba(0,255,136,0.2)}
#actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:15px}
.abtn{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:8px 14px;color:#aaa;font-size:11px;cursor:pointer;transition:all 0.15s}
.abtn:hover{background:rgba(255,255,255,0.1);color:#fff;transform:translateY(-1px)}
#fx-panel{display:flex;gap:15px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:12px 18px;margin-bottom:15px;flex-wrap:wrap;justify-content:center}
.fx-knob{display:flex;flex-direction:column;align-items:center;gap:4px}
.fx-label{font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px}
.fx-value{font-size:14px;color:#ff6b9d}
.fx-slider{width:80px;height:4px;-webkit-appearance:none;appearance:none;background:#333;border-radius:2px;outline:none}
.fx-slider::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:#ff6b9d;border-radius:50%;cursor:pointer;box-shadow:0 0 6px rgba(255,107,157,0.4)}
#visualizer{width:100%;max-width:800px;height:60px;background:rgba(0,0,0,0.3);border-radius:8px;margin-bottom:10px;overflow:hidden}
#vis-canvas{width:100%;height:100%;display:block}
@media(max-width:768px){
h1{font-size:22px}
.cell{width:28px;height:28px}
.row-label{width:60px;font-size:9px}
.step-numbers{margin-left:62px}
.step-num{width:28px;font-size:8px}
#bpm-display{font-size:24px}
#transport{padding:8px 12px;gap:8px}
.tbtn{width:38px;height:38px;font-size:15px}
}
</style>
</head>
<body>
<h1>RHYTHM GRID</h1>
<div class="subtitle">DRUM MACHINE + SEQUENCER</div>

<div id="transport">
  <div class="tbtn" id="btn-play" onclick="togglePlay()">|></div>
  <div class="tbtn" id="btn-stop" onclick="stop()">[]</div>
  <div class="tbtn" id="btn-rec" onclick="toggleRec()">o</div>
  <div class="bpm-ctrl">
    <div id="bpm-display">120</div>
    <div id="bpm-label">BPM</div>
    <div class="bpm-adj">
      <div class="bpm-btn" onclick="adjBPM(-10)">--</div>
      <div class="bpm-btn" onclick="adjBPM(-1)">-</div>
      <div class="bpm-btn" onclick="adjBPM(1)">+</div>
      <div class="bpm-btn" onclick="adjBPM(10)">++</div>
    </div>
  </div>
  <div class="bpm-ctrl">
    <div id="swing-display">Swing: 0%</div>
    <input type="range" class="fx-slider" min="0" max="80" value="0" oninput="S.swing=+this.value;document.getElementById('swing-display').textContent='Swing: '+this.value+'%'">
  </div>
</div>

<div id="kit-select">
  <button class="kit-btn active" onclick="setKit('808')">808</button>
  <button class="kit-btn" onclick="setKit('909')">909</button>
  <button class="kit-btn" onclick="setKit('lofi')">Lo-Fi</button>
  <button class="kit-btn" onclick="setKit('acoustic')">Acoustic</button>
  <button class="kit-btn" onclick="setKit('synth')">Synth</button>
</div>

<div id="pattern-bar">
  <div class="pat-btn active" onclick="selectPattern(0)">1</div>
  <div class="pat-btn" onclick="selectPattern(1)">2</div>
  <div class="pat-btn" onclick="selectPattern(2)">3</div>
  <div class="pat-btn" onclick="selectPattern(3)">4</div>
  <div class="pat-btn" onclick="selectPattern(4)">5</div>
  <div class="pat-btn" onclick="selectPattern(5)">6</div>
  <div class="pat-btn" onclick="selectPattern(6)">7</div>
  <div class="pat-btn" onclick="selectPattern(7)">8</div>
</div>

<div id="visualizer"><canvas id="vis-canvas"></canvas></div>

<div id="grid-container">
  <div class="step-numbers" id="step-numbers"></div>
  <div id="grid"></div>
</div>

<div id="fx-panel">
  <div class="fx-knob"><span class="fx-label">Volume</span><span class="fx-value" id="fxv-vol">80%</span><input type="range" class="fx-slider" min="0" max="100" value="80" oninput="S.volume=+this.value/100;document.getElementById('fxv-vol').textContent=this.value+'%'"></div>
  <div class="fx-knob"><span class="fx-label">Reverb</span><span class="fx-value" id="fxv-rev">20%</span><input type="range" class="fx-slider" min="0" max="100" value="20" oninput="S.reverb=+this.value/100;document.getElementById('fxv-rev').textContent=this.value+'%'"></div>
  <div class="fx-knob"><span class="fx-label">Distort</span><span class="fx-value" id="fxv-dist">0%</span><input type="range" class="fx-slider" min="0" max="100" value="0" oninput="S.distortion=+this.value/100;document.getElementById('fxv-dist').textContent=this.value+'%'"></div>
  <div class="fx-knob"><span class="fx-label">Pitch</span><span class="fx-value" id="fxv-pitch">0</span><input type="range" class="fx-slider" min="-12" max="12" value="0" oninput="S.pitch=+this.value;document.getElementById('fxv-pitch').textContent=this.value"></div>
</div>

<div id="actions">
  <button class="abtn" onclick="clearPattern()">Clear Pattern</button>
  <button class="abtn" onclick="randomize()">Randomize</button>
  <button class="abtn" onclick="copyPattern()">Copy Pattern</button>
  <button class="abtn" onclick="pastePattern()">Paste Pattern</button>
  <button class="abtn" onclick="saveProject()">Save Project</button>
  <button class="abtn" onclick="loadProject()">Load Project</button>
  <button class="abtn" onclick="exportJSON()">Export JSON</button>
</div>

<script>
// ===== STATE =====
const STEPS=16;
const INSTRUMENTS=[
  {name:'Kick',color:'#ff4444'},
  {name:'Snare',color:'#ff8844'},
  {name:'Hi-Hat C',color:'#ffcc44'},
  {name:'Hi-Hat O',color:'#aaff44'},
  {name:'Clap',color:'#44ff88'},
  {name:'Tom High',color:'#44ffcc'},
  {name:'Tom Low',color:'#44aaff'},
  {name:'Cymbal',color:'#4488ff'},
  {name:'Rim',color:'#8844ff'},
  {name:'Perc',color:'#cc44ff'},
];

const S={
  bpm:120,swing:0,volume:0.8,reverb:0.2,distortion:0,pitch:0,
  kit:'808',playing:false,recording:false,
  step:0,patterns:[],currentPattern:0,
  clipboard:null,
  analyserData:null
};

// Init patterns
for(let p=0;p<8;p++){
  S.patterns[p]=[];
  for(let i=0;i<INSTRUMENTS.length;i++){
    S.patterns[p][i]=new Array(STEPS).fill(false);
  }
}

// ===== AUDIO =====
let audioCtx=null;
let analyser=null;
let masterGain=null;

function initAudio(){
  if(audioCtx)return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain();
  masterGain.gain.value=S.volume;
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=256;
  masterGain.connect(analyser);
  analyser.connect(audioCtx.destination);
  S.analyserData=new Uint8Array(analyser.frequencyBinCount);
}

// ===== DRUM SYNTH =====
const KITS={
  '808':{
    kick:{freq:55,decay:0.5,type:'sine',sweep:150},
    snare:{freq:200,decay:0.15,noise:0.3,type:'triangle'},
    hihatC:{freq:6000,decay:0.05,noise:0.8,type:'square'},
    hihatO:{freq:5000,decay:0.2,noise:0.7,type:'square'},
    clap:{freq:1000,decay:0.1,noise:0.5,type:'sawtooth'},
    tomH:{freq:200,decay:0.2,type:'sine',sweep:80},
    tomL:{freq:100,decay:0.3,type:'sine',sweep:60},
    cymbal:{freq:8000,decay:0.6,noise:0.9,type:'square'},
    rim:{freq:800,decay:0.03,type:'triangle'},
    perc:{freq:2000,decay:0.08,noise:0.4,type:'sine'}
  },
  '909':{
    kick:{freq:60,decay:0.4,type:'sine',sweep:200},
    snare:{freq:250,decay:0.12,noise:0.35,type:'triangle'},
    hihatC:{freq:7000,decay:0.04,noise:0.85,type:'square'},
    hihatO:{freq:6000,decay:0.25,noise:0.75,type:'square'},
    clap:{freq:1200,decay:0.08,noise:0.6,type:'sawtooth'},
    tomH:{freq:250,decay:0.18,type:'sine',sweep:100},
    tomL:{freq:120,decay:0.25,type:'sine',sweep:70},
    cymbal:{freq:9000,decay:0.5,noise:0.9,type:'square'},
    rim:{freq:900,decay:0.025,type:'triangle'},
    perc:{freq:2500,decay:0.06,noise:0.3,type:'sine'}
  },
  'lofi':{
    kick:{freq:45,decay:0.6,type:'sine',sweep:100},
    snare:{freq:180,decay:0.2,noise:0.4,type:'triangle'},
    hihatC:{freq:4000,decay:0.06,noise:0.6,type:'square'},
    hihatO:{freq:3500,decay:0.3,noise:0.5,type:'square'},
    clap:{freq:800,decay:0.15,noise:0.4,type:'sawtooth'},
    tomH:{freq:180,decay:0.25,type:'sine',sweep:70},
    tomL:{freq:90,decay:0.35,type:'sine',sweep:50},
    cymbal:{freq:5000,decay:0.7,noise:0.7,type:'square'},
    rim:{freq:600,decay:0.04,type:'triangle'},
    perc:{freq:1500,decay:0.1,noise:0.5,type:'sine'}
  },
  'acoustic':{
    kick:{freq:65,decay:0.35,type:'sine',sweep:180},
    snare:{freq:280,decay:0.1,noise:0.45,type:'triangle'},
    hihatC:{freq:8000,decay:0.03,noise:0.9,type:'square'},
    hihatO:{freq:7000,decay:0.15,noise:0.8,type:'square'},
    clap:{freq:1100,decay:0.06,noise:0.55,type:'sawtooth'},
    tomH:{freq:300,decay:0.15,type:'sine',sweep:120},
    tomL:{freq:150,decay:0.22,type:'sine',sweep:80},
    cymbal:{freq:10000,decay:0.4,noise:0.95,type:'square'},
    rim:{freq:1000,decay:0.02,type:'triangle'},
    perc:{freq:3000,decay:0.05,noise:0.2,type:'sine'}
  },
  'synth':{
    kick:{freq:50,decay:0.45,type:'sine',sweep:300},
    snare:{freq:220,decay:0.13,noise:0.25,type:'sawtooth'},
    hihatC:{freq:5500,decay:0.05,noise:0.7,type:'square'},
    hihatO:{freq:4500,decay:0.22,noise:0.6,type:'square'},
    clap:{freq:900,decay:0.12,noise:0.35,type:'square'},
    tomH:{freq:220,decay:0.2,type:'sawtooth',sweep:90},
    tomL:{freq:110,decay:0.28,type:'sawtooth',sweep:55},
    cymbal:{freq:7000,decay:0.55,noise:0.8,type:'square'},
    rim:{freq:700,decay:0.035,type:'square'},
    perc:{freq:1800,decay:0.09,noise:0.3,type:'sawtooth'}
  }
};

const INST_KEYS=['kick','snare','hihatC','hihatO','clap','tomH','tomL','cymbal','rim','perc'];

function playDrum(instIdx){
  if(!audioCtx)initAudio();
  const key=INST_KEYS[instIdx];
  const params=KITS[S.kit][key];
  if(!params)return;
  const now=audioCtx.currentTime;
  const pitchMult=Math.pow(2,S.pitch/12);
  const g=audioCtx.createGain();
  g.gain.setValueAtTime(S.volume*0.4,now);
  g.gain.exponentialRampToValueAtTime(0.001,now+params.decay);
  // Distortion
  if(S.distortion>0){
    const ws=audioCtx.createWaveShaper();
    const k=S.distortion*100;
    const curve=new Float32Array(44100);
    for(let i=0;i<44100;i++){const x=i*2/44100-1;curve[i]=(3+k)*x*20/(Math.PI+k*Math.abs(x*20))}
    ws.curve=curve;ws.oversample='4x';
    g.connect(ws);ws.connect(masterGain);
  }else{g.connect(masterGain)}
  // Tonal component
  const o=audioCtx.createOscillator();
  o.type=params.type;
  o.frequency.setValueAtTime((params.freq+(params.sweep||0))*pitchMult,now);
  if(params.sweep)o.frequency.exponentialRampToValueAtTime(params.freq*pitchMult,now+params.decay*0.5);
  o.connect(g);o.start(now);o.stop(now+params.decay);
  // Noise component
  if(params.noise){
    const bufSize=audioCtx.sampleRate*params.decay;
    const buf=audioCtx.createBuffer(1,bufSize,audioCtx.sampleRate);
    const data=buf.getChannelData(0);
    for(let i=0;i<bufSize;i++)data[i]=(Math.random()*2-1)*params.noise;
    const ns=audioCtx.createBufferSource();ns.buffer=buf;
    const ng=audioCtx.createGain();
    ng.gain.setValueAtTime(S.volume*0.3*params.noise,now);
    ng.gain.exponentialRampToValueAtTime(0.001,now+params.decay);
    const filt=audioCtx.createBiquadFilter();filt.type='bandpass';filt.frequency.value=params.freq*pitchMult;filt.Q.value=1;
    ns.connect(filt);filt.connect(ng);
    if(S.distortion>0){const ws2=audioCtx.createWaveShaper();const k2=S.distortion*50;const c2=new Float32Array(44100);for(let j=0;j<44100;j++){const x=j*2/44100-1;c2[j]=(3+k2)*x*10/(Math.PI+k2*Math.abs(x*10))}ws2.curve=c2;ng.connect(ws2);ws2.connect(masterGain)}
    else{ng.connect(masterGain)}
    ns.start(now);ns.stop(now+params.decay);
  }
}

// ===== SEQUENCER =====
let intervalId=null;
let stepCount=0;

function togglePlay(){
  initAudio();
  if(S.playing){S.playing=false;clearInterval(intervalId);document.getElementById('btn-play').classList.remove('playing');return}
  S.playing=true;S.step=0;document.getElementById('btn-play').classList.add('playing');
  scheduleStep();
}

function stop(){
  S.playing=false;S.recording=false;S.step=0;clearInterval(intervalId);
  document.getElementById('btn-play').classList.remove('playing');
  document.getElementById('btn-rec').classList.remove('recording');
  renderGrid();
}

function toggleRec(){
  initAudio();
  S.recording=!S.recording;
  document.getElementById('btn-rec').classList.toggle('recording',S.recording);
  if(S.recording&&!S.playing)togglePlay();
}

function scheduleStep(){
  clearInterval(intervalId);
  const msPerStep=60000/(S.bpm*4);
  intervalId=setInterval(()=>{
    if(!S.playing)return;
    const pat=S.patterns[S.currentPattern];
    for(let i=0;i<INSTRUMENTS.length;i++){
      if(pat[i][S.step])playDrum(i);
    }
    highlightStep(S.step);
    S.step=(S.step+1)%STEPS;
    // Swing: delay even steps
    if(S.swing>0&&S.step%2===1){
      clearInterval(intervalId);
      setTimeout(()=>{if(S.playing)scheduleStep()},msPerStep*S.swing/100);
      return;
    }
  },60000/(S.bpm*4));
}

function adjBPM(d){S.bpm=Math.max(40,Math.min(300,S.bpm+d));document.getElementById('bpm-display').textContent=S.bpm;if(S.playing){clearInterval(intervalId);scheduleStep()}}

function setKit(k){
  S.kit=k;
  document.querySelectorAll('.kit-btn').forEach(b=>b.classList.toggle('active',b.textContent===k.charAt(0).toUpperCase()+k.slice(1)||b.textContent===k));
  document.querySelectorAll('.kit-btn').forEach(b=>{
    const map={'808':'808','909':'909','Lo-Fi':'lofi','Acoustic':'acoustic','Synth':'synth'};
    b.classList.toggle('active',map[b.textContent]===k);
  });
}

function selectPattern(p){
  S.currentPattern=p;
  document.querySelectorAll('.pat-btn').forEach((b,i)=>b.classList.toggle('active',i===p));
  renderGrid();
}

// ===== GRID RENDERING =====
function renderGrid(){
  const grid=document.getElementById('grid');
  const pat=S.patterns[S.currentPattern];
  // Step numbers
  const sn=document.getElementById('step-numbers');
  sn.innerHTML='';
  for(let s=0;s<STEPS;s++){
    const d=document.createElement('div');d.className='step-num'+(s%4===0?' beat':'');d.textContent=s+1;sn.appendChild(d);
  }
  grid.innerHTML='';
  for(let i=0;i<INSTRUMENTS.length;i++){
    const row=document.createElement('div');row.className='grid-row';
    const label=document.createElement('div');label.className='row-label';label.textContent=INSTRUMENTS[i].name;
    label.style.color=INSTRUMENTS[i].color;row.appendChild(label);
    for(let s=0;s<STEPS;s++){
      const cell=document.createElement('div');
      cell.className='cell '+(pat[i][s]?'on':'off');
      if(pat[i][s])cell.style.background=INSTRUMENTS[i].color;
      if(s%4===0)cell.classList.add('beat-marker');
      cell.dataset.inst=i;cell.dataset.step=s;
      cell.addEventListener('mousedown',e=>{toggleCell(i,s,cell);e.preventDefault()});
      cell.addEventListener('touchstart',e=>{toggleCell(i,s,cell);e.preventDefault()});
      row.appendChild(cell);
    }
    grid.appendChild(row);
  }
}

function toggleCell(inst,step,el){
  initAudio();
  const pat=S.patterns[S.currentPattern];
  pat[inst][step]=!pat[inst][step];
  el.classList.toggle('on',pat[inst][step]);
  el.classList.toggle('off',!pat[inst][step]);
  if(pat[inst][step]){el.style.background=INSTRUMENTS[inst].color;playDrum(inst)}
  else{el.style.background=''}
  updatePatternBtns();
}

function highlightStep(step){
  document.querySelectorAll('.cell.playing').forEach(c=>c.classList.remove('playing'));
  document.querySelectorAll('.cell[data-step="'+step+'"]').forEach(c=>c.classList.add('playing'));
}

function updatePatternBtns(){
  document.querySelectorAll('.pat-btn').forEach((b,i)=>{
    const hasData=S.patterns[i].some(row=>row.some(c=>c));
    b.classList.toggle('has-data',hasData&&i!==S.currentPattern);
  });
}

// ===== PATTERN OPS =====
function clearPattern(){S.patterns[S.currentPattern]=S.patterns[S.currentPattern].map(()=>new Array(STEPS).fill(false));renderGrid();updatePatternBtns()}
function randomize(){
  const pat=S.patterns[S.currentPattern];
  const densities=[0.6,0.25,0.4,0.15,0.15,0.1,0.1,0.05,0.1,0.15];
  for(let i=0;i<INSTRUMENTS.length;i++)for(let s=0;s<STEPS;s++)pat[i][s]=Math.random()<densities[i];
  renderGrid();updatePatternBtns();
}
function copyPattern(){S.clipboard=S.patterns[S.currentPattern].map(r=>r.slice())}
function pastePattern(){if(S.clipboard){S.patterns[S.currentPattern]=S.clipboard.map(r=>r.slice());renderGrid();updatePatternBtns()}}

// ===== SAVE/LOAD =====
function saveProject(){
  const data={bpm:S.bpm,kit:S.kit,swing:S.swing,volume:S.volume,reverb:S.reverb,distortion:S.distortion,pitch:S.pitch,patterns:S.patterns,currentPattern:S.currentPattern};
  try{localStorage.setItem('rhythmGrid_project',JSON.stringify(data))}catch(e){}
}
function loadProject(){
  try{const d=localStorage.getItem('rhythmGrid_project');if(d){const p=JSON.parse(d);S.bpm=p.bpm||120;S.kit=p.kit||'808';S.swing=p.swing||0;S.volume=p.volume||0.8;S.reverb=p.reverb||0.2;S.distortion=p.distortion||0;S.pitch=p.pitch||0;S.patterns=p.patterns||S.patterns;S.currentPattern=p.currentPattern||0;
  document.getElementById('bpm-display').textContent=S.bpm;setKit(S.kit);renderGrid();updatePatternBtns()}}catch(e){}}
function exportJSON(){
  const data={bpm:S.bpm,kit:S.kit,swing:S.swing,patterns:S.patterns};
  const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.download='rhythm-grid-'+Date.now()+'.json';a.href=URL.createObjectURL(b);a.click();
}

// ===== VISUALIZER =====
const visCanvas=document.getElementById('vis-canvas');
const visCtx=visCanvas.getContext('2d');
function resizeVis(){visCanvas.width=visCanvas.offsetWidth;visCanvas.height=visCanvas.offsetHeight}
addEventListener('resize',resizeVis);resizeVis();

function drawVis(){
  visCtx.fillStyle='rgba(0,0,0,0.3)';visCtx.fillRect(0,0,visCanvas.width,visCanvas.height);
  if(analyser&&S.analyserData){
    analyser.getByteFrequencyData(S.analyserData);
    const bars=S.analyserData.length;const bw=visCanvas.width/bars;
    for(let i=0;i<bars;i++){
      const v=S.analyserData[i]/255;
      const h=v*visCanvas.height;
      const hue=i/bars*360;
      visCtx.fillStyle='hsl('+hue+',80%,'+(30+v*40)+'%)';
      visCtx.fillRect(i*bw,visCanvas.height-h,bw-1,h);
    }
  }
  requestAnimationFrame(drawVis);
}

// ===== KEYBOARD =====
addEventListener('keydown',e=>{
  if(e.key===' '){e.preventDefault();togglePlay()}
  if(e.key==='Escape')stop();
  // Number keys play drums
  if(e.key>='0'&&e.key<='9'){const idx=+e.key===0?9:+e.key-1;if(idx<INSTRUMENTS.length){initAudio();playDrum(idx);if(S.recording&&S.playing){S.patterns[S.currentPattern][idx][S.step]=true;renderGrid()}}}
});

// ===== INIT =====
loadProject();
renderGrid();
updatePatternBtns();
drawVis();
// Auto-save every 10 seconds
setInterval(saveProject,10000);
</script>
</body>
</html>