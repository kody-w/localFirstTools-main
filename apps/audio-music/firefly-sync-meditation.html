<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firefly Sync Meditation</title>
    <meta name="description" content="A meditative experience where your breathing synchronizes a meadow of fireflies into unified luminescence">
    <!-- meditation, bioluminescence, breathing, audio, generative, relaxation, ambient -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: #0a0a12;
            min-height: 100vh;
            overflow: hidden;
            font-family: Georgia, serif;
            color: #a8c8a8;
        }
        
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
        }
        
        #breath-guide {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
        }
        
        #breath-circle {
            width: 80px;
            height: 80px;
            border: 2px solid rgba(180, 220, 140, 0.5);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        #breath-circle.inhale {
            transform: scale(1.3);
            border-color: rgba(180, 220, 140, 0.8);
            box-shadow: 0 0 30px rgba(180, 220, 140, 0.3);
        }
        
        #breath-circle.exhale {
            transform: scale(0.8);
            border-color: rgba(140, 180, 220, 0.8);
            box-shadow: 0 0 20px rgba(140, 180, 220, 0.2);
        }
        
        #breath-text {
            font-size: 14px;
            letter-spacing: 3px;
            text-transform: uppercase;
            opacity: 0.7;
        }
        
        #sync-meter {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
        }
        
        #sync-label {
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
            opacity: 0.6;
            margin-bottom: 10px;
        }
        
        #sync-bar {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        #sync-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a6a4a, #8ac88a);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        #controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .btn {
            padding: 10px 20px;
            background: rgba(100, 140, 100, 0.2);
            border: 1px solid rgba(100, 140, 100, 0.4);
            color: #a8c8a8;
            font-family: inherit;
            font-size: 12px;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: rgba(100, 140, 100, 0.3);
        }
        
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 12px;
            opacity: 0.5;
            z-index: 100;
            max-width: 200px;
            line-height: 1.6;
        }
        
        #firefly-count {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 12px;
            opacity: 0.5;
            z-index: 100;
        }
        
        #dawn-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                rgba(255, 180, 100, 0) 0%,
                rgba(255, 200, 150, 0) 50%,
                rgba(255, 220, 180, 0) 100%);
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            transition: opacity 5s ease;
        }
        
        #dawn-overlay.active {
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="dawn-overlay"></div>
    
    <div id="info">
        Breathe slowly and deeply.<br>
        The fireflies will begin<br>
        to synchronize with you.
    </div>
    
    <div id="sync-meter">
        <div id="sync-label">Synchronization</div>
        <div id="sync-bar">
            <div id="sync-fill"></div>
        </div>
    </div>
    
    <div id="controls">
        <button class="btn" id="mic-btn">Use Microphone</button>
        <button class="btn" id="sound-btn">Sound: On</button>
    </div>
    
    <div id="breath-guide">
        <div id="breath-circle">
            <span id="breath-inner"></span>
        </div>
        <div id="breath-text">Tap to breathe</div>
    </div>
    
    <div id="firefly-count">Fireflies: 0</div>
    
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let fireflies = [];
        let isInhaling = false;
        let breathPhase = 0;
        let userBreathPhase = 0;
        let synchronization = 0;
        let totalBreaths = 0;
        let soundEnabled = true;
        let audioCtx = null;
        let cricketOsc = null;
        let useMicrophone = false;
        let analyser = null;
        
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        resize();
        window.addEventListener('resize', resize);
        
        // Firefly class
        class Firefly {
            constructor() {
                this.x = Math.random() * width;
                this.y = height * 0.3 + Math.random() * height * 0.5;
                this.baseY = this.y;
                this.phase = Math.random() * Math.PI * 2;
                this.frequency = 0.5 + Math.random() * 0.5; // Natural frequency
                this.brightness = 0;
                this.targetBrightness = 0;
                this.size = 2 + Math.random() * 2;
                this.vx = (Math.random() - 0.5) * 0.3;
                this.vy = (Math.random() - 0.5) * 0.2;
                this.pulseOffset = Math.random() * Math.PI * 2;
            }
            
            update(dt, globalPhase, sync) {
                // Movement
                this.x += this.vx;
                this.y += this.vy + Math.sin(Date.now() / 2000 + this.pulseOffset) * 0.1;
                
                // Gentle wandering
                this.vx += (Math.random() - 0.5) * 0.02;
                this.vy += (Math.random() - 0.5) * 0.02;
                this.vx *= 0.99;
                this.vy *= 0.99;
                
                // Bounds
                if (this.x < 50) this.vx += 0.05;
                if (this.x > width - 50) this.vx -= 0.05;
                if (this.y < height * 0.2) this.vy += 0.05;
                if (this.y > height * 0.8) this.vy -= 0.05;
                
                // Phase coupling - synchronize with global phase based on sync level
                const naturalPhase = this.phase + this.frequency * dt * 0.05;
                const coupledPhase = globalPhase;
                
                // Kuramoto model inspired coupling
                this.phase = naturalPhase + sync * 0.1 * Math.sin(coupledPhase - naturalPhase);
                
                // Brightness based on phase
                this.targetBrightness = Math.max(0, Math.sin(this.phase));
                this.brightness += (this.targetBrightness - this.brightness) * 0.1;
            }
            
            draw(ctx) {
                if (this.brightness < 0.05) return;
                
                const glowSize = this.size * (2 + this.brightness * 3);
                
                // Outer glow
                const gradient = ctx.createRadialGradient(
                    this.x, this.y, 0,
                    this.x, this.y, glowSize
                );
                
                const alpha = this.brightness * 0.8;
                gradient.addColorStop(0, `rgba(200, 255, 150, ${alpha})`);
                gradient.addColorStop(0.3, `rgba(150, 220, 100, ${alpha * 0.5})`);
                gradient.addColorStop(1, 'rgba(100, 180, 80, 0)');
                
                ctx.beginPath();
                ctx.arc(this.x, this.y, glowSize, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // Core
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size * 0.5, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 200, ${this.brightness})`;
                ctx.fill();
            }
        }
        
        // Initialize fireflies
        function spawnFireflies(count) {
            for (let i = 0; i < count; i++) {
                fireflies.push(new Firefly());
            }
            updateCount();
        }
        
        function updateCount() {
            document.getElementById('firefly-count').textContent = `Fireflies: ${fireflies.length}`;
        }
        
        // Audio
        function initAudio() {
            if (audioCtx) return;
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // Cricket ambient
            createCrickets();
        }
        
        function createCrickets() {
            const masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.05;
            masterGain.connect(audioCtx.destination);
            
            // Multiple cricket voices
            for (let i = 0; i < 3; i++) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.type = 'sine';
                osc.frequency.value = 4000 + Math.random() * 2000;
                
                // Chirping pattern
                const chirp = () => {
                    if (!soundEnabled) {
                        gain.gain.value = 0;
                        setTimeout(chirp, 500);
                        return;
                    }
                    
                    const duration = 0.05 + Math.random() * 0.05;
                    const pause = 0.1 + Math.random() * 0.3;
                    
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                    
                    setTimeout(chirp, (duration + pause) * 1000);
                };
                
                osc.connect(gain);
                gain.connect(masterGain);
                osc.start();
                
                setTimeout(chirp, Math.random() * 1000);
            }
        }
        
        // Breathing detection via microphone
        async function startMicrophone() {
            try {
                initAudio();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                useMicrophone = true;
                document.getElementById('mic-btn').textContent = 'Mic: Active';
            } catch (e) {
                alert('Microphone access denied');
            }
        }
        
        function detectBreath() {
            if (!analyser) return null;
            
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            
            // Low frequency detection for breath
            let lowSum = 0;
            for (let i = 0; i < 10; i++) {
                lowSum += data[i];
            }
            
            return lowSum / 10 / 255;
        }
        
        // Draw grass
        function drawGrass() {
            const grassCount = 200;
            ctx.strokeStyle = 'rgba(40, 80, 40, 0.6)';
            ctx.lineWidth = 2;
            
            for (let i = 0; i < grassCount; i++) {
                const x = (i / grassCount) * width;
                const h = 20 + Math.random() * 40;
                const sway = Math.sin(Date.now() / 1000 + i * 0.5) * 5;
                
                ctx.beginPath();
                ctx.moveTo(x, height);
                ctx.quadraticCurveTo(
                    x + sway, height - h * 0.6,
                    x + sway * 1.5, height - h
                );
                ctx.stroke();
            }
        }
        
        // Draw stars
        function drawStars() {
            const starCount = 100;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            
            for (let i = 0; i < starCount; i++) {
                const x = (Math.sin(i * 234.5) * 0.5 + 0.5) * width;
                const y = (Math.cos(i * 123.4) * 0.5 + 0.5) * height * 0.4;
                const twinkle = 0.3 + Math.sin(Date.now() / 500 + i) * 0.3;
                
                ctx.globalAlpha = twinkle;
                ctx.beginPath();
                ctx.arc(x, y, 1, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
        }
        
        // Main animation
        let lastTime = Date.now();
        
        function animate() {
            const now = Date.now();
            const dt = Math.min(50, now - lastTime);
            lastTime = now;
            
            // Clear with dark gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#0a0a15');
            gradient.addColorStop(0.6, '#0a1020');
            gradient.addColorStop(1, '#102010');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Stars
            drawStars();
            
            // Update breath phase
            if (useMicrophone) {
                const breathLevel = detectBreath();
                if (breathLevel !== null) {
                    if (breathLevel > 0.1) {
                        userBreathPhase += dt * 0.003;
                        isInhaling = breathLevel > 0.2;
                    }
                }
            }
            
            // User breath influence on global phase
            breathPhase += dt * 0.002;
            
            // Calculate synchronization based on phase coherence
            let phaseSum = 0;
            fireflies.forEach(f => {
                phaseSum += Math.cos(f.phase - breathPhase);
            });
            const coherence = fireflies.length > 0 ? Math.abs(phaseSum / fireflies.length) : 0;
            
            // Sync increases with coherent breathing, decays otherwise
            if (isInhaling || userBreathPhase > 0) {
                synchronization = Math.min(1, synchronization + 0.001 * dt);
            } else {
                synchronization = Math.max(0, synchronization - 0.0005 * dt);
            }
            
            // Update sync meter
            document.getElementById('sync-fill').style.width = (synchronization * 100) + '%';
            
            // Spawn more fireflies as sync increases
            if (synchronization > 0.3 && fireflies.length < 50) {
                if (Math.random() < 0.01) spawnFireflies(1);
            }
            if (synchronization > 0.6 && fireflies.length < 100) {
                if (Math.random() < 0.02) spawnFireflies(1);
            }
            if (synchronization > 0.9 && fireflies.length < 200) {
                if (Math.random() < 0.03) spawnFireflies(1);
            }
            
            // Dawn effect at high sync
            const dawn = document.getElementById('dawn-overlay');
            if (synchronization > 0.95 && totalBreaths > 20) {
                dawn.classList.add('active');
            }
            
            // Update and draw fireflies
            fireflies.forEach(f => {
                f.update(dt, breathPhase, synchronization);
            });
            
            // Sort by y for depth
            fireflies.sort((a, b) => a.y - b.y);
            fireflies.forEach(f => f.draw(ctx));
            
            // Grass (foreground)
            drawGrass();
            
            // Update breath circle
            const breathCircle = document.getElementById('breath-circle');
            breathCircle.classList.toggle('inhale', isInhaling);
            breathCircle.classList.toggle('exhale', !isInhaling);
            
            requestAnimationFrame(animate);
        }
        
        // User input for breathing
        let breathHoldStart = 0;
        
        document.getElementById('breath-guide').addEventListener('mousedown', () => {
            initAudio();
            isInhaling = true;
            breathHoldStart = Date.now();
            document.getElementById('breath-text').textContent = 'Inhaling...';
        });
        
        document.getElementById('breath-guide').addEventListener('mouseup', () => {
            isInhaling = false;
            totalBreaths++;
            document.getElementById('breath-text').textContent = 'Exhaling...';
            
            setTimeout(() => {
                document.getElementById('breath-text').textContent = 'Tap to breathe';
            }, 2000);
        });
        
        document.getElementById('breath-guide').addEventListener('touchstart', (e) => {
            e.preventDefault();
            initAudio();
            isInhaling = true;
            breathHoldStart = Date.now();
            document.getElementById('breath-text').textContent = 'Inhaling...';
        });
        
        document.getElementById('breath-guide').addEventListener('touchend', () => {
            isInhaling = false;
            totalBreaths++;
            document.getElementById('breath-text').textContent = 'Exhaling...';
            
            setTimeout(() => {
                document.getElementById('breath-text').textContent = 'Tap to breathe';
            }, 2000);
        });
        
        // Controls
        document.getElementById('mic-btn').addEventListener('click', startMicrophone);
        
        document.getElementById('sound-btn').addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-btn').textContent = soundEnabled ? 'Sound: On' : 'Sound: Off';
        });
        
        // Initialize
        spawnFireflies(20);
        animate();
    </script>
</body>
</html>
