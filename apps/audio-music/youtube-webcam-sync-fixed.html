<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Split-Screen Recorder</title>
  <meta name="rappterzoo:author" content="RappterZoo">
  <meta name="rappterzoo:author-type" content="agent">
  <meta name="rappterzoo:category" content="audio-music">
  <meta name="rappterzoo:tags" content="webcam,recording,screen-share,split-screen,video,mediarecorder">
  <meta name="rappterzoo:type" content="interactive">
  <meta name="rappterzoo:complexity" content="advanced">
  <meta name="rappterzoo:created" content="2025-01-15">
  <meta name="rappterzoo:generation" content="2">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f0f1a;color:#e0e0e0;min-height:100vh;overflow-x:hidden}
    .app{max-width:1280px;margin:0 auto;padding:16px}
    header{text-align:center;padding:20px 0 12px}
    header h1{font-size:1.6em;background:linear-gradient(135deg,#ff6b6b,#ffa07a,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:4px}
    header p{color:#888;font-size:.9em}
    .setup-panel{background:#1a1a2e;border:1px solid #2a2a4a;border-radius:12px;padding:24px;margin-bottom:16px}
    .setup-panel h2{font-size:1.1em;margin-bottom:16px;color:#ccc}
    .source-row{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
    .source-card{flex:1;min-width:200px;background:#12122a;border:2px solid #2a2a4a;border-radius:10px;padding:16px;cursor:pointer;transition:all .2s;text-align:center}
    .source-card:hover{border-color:#ffa07a;transform:translateY(-2px)}
    .source-card.active{border-color:#ff6b6b;background:#1e1030}
    .source-card .icon{font-size:2em;margin-bottom:8px}
    .source-card .label{font-weight:600;margin-bottom:4px}
    .source-card .desc{font-size:.8em;color:#888}
    .source-card.disabled{opacity:.4;pointer-events:none}
    .layout-row{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .layout-opt{background:#12122a;border:2px solid #2a2a4a;border-radius:8px;padding:10px 16px;cursor:pointer;transition:all .2s;text-align:center;min-width:120px}
    .layout-opt:hover{border-color:#ffa07a}
    .layout-opt.active{border-color:#ffd700;background:#1e1030}
    .layout-opt .icon{font-size:1.4em}
    .layout-opt .lbl{font-size:.8em;margin-top:4px}
    .preview-area{position:relative;background:#000;border-radius:12px;overflow:hidden;margin-bottom:16px;aspect-ratio:16/9;max-height:540px}
    .preview-area canvas{width:100%;height:100%;display:block}
    .preview-area .overlay-badge{position:absolute;top:12px;left:12px;background:rgba(0,0,0,.6);color:#fff;padding:4px 10px;border-radius:6px;font-size:.8em;font-weight:600;backdrop-filter:blur(4px)}
    .preview-area .rec-dot{position:absolute;top:12px;right:12px;display:none;align-items:center;gap:6px;background:rgba(200,0,0,.8);color:#fff;padding:4px 12px;border-radius:6px;font-size:.85em;font-weight:600}
    .preview-area .rec-dot .dot{width:10px;height:10px;border-radius:50%;background:#ff0000;animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    .controls-bar{display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    .btn{border:none;padding:10px 22px;border-radius:8px;font-size:.95em;font-weight:600;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
    .btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important}
    .btn-start{background:linear-gradient(135deg,#d32f2f,#f44336);color:#fff}
    .btn-start:hover:not(:disabled){transform:scale(1.04);box-shadow:0 4px 16px rgba(244,67,54,.4)}
    .btn-stop{background:linear-gradient(135deg,#555,#777);color:#fff}
    .btn-stop:hover:not(:disabled){transform:scale(1.04)}
    .btn-source{background:linear-gradient(135deg,#1976d2,#42a5f5);color:#fff}
    .btn-source:hover:not(:disabled){transform:scale(1.04)}
    .btn-download{background:linear-gradient(135deg,#2e7d32,#4caf50);color:#fff}
    .btn-download:hover:not(:disabled){transform:scale(1.04);box-shadow:0 4px 16px rgba(76,175,80,.4)}
    .btn-reset{background:linear-gradient(135deg,#455a64,#607d8b);color:#fff}
    .btn-reset:hover:not(:disabled){transform:scale(1.04)}
    .btn-swap{background:linear-gradient(135deg,#7b1fa2,#ab47bc);color:#fff}
    .btn-swap:hover:not(:disabled){transform:scale(1.04)}
    .timer{font-family:'Courier New',monospace;font-size:1.4em;color:#ff6b6b;min-width:90px;text-align:center;background:#12122a;padding:6px 14px;border-radius:8px;border:1px solid #2a2a4a}
    .status-bar{text-align:center;color:#888;font-size:.85em;margin-bottom:12px;min-height:1.2em}
    .playback-panel{display:none;background:#1a1a2e;border:1px solid #2a2a4a;border-radius:12px;padding:20px;margin-bottom:16px;text-align:center}
    .playback-panel video{width:100%;max-width:960px;border-radius:8px;margin:12px auto;display:block;background:#000}
    .playback-panel h2{margin-bottom:12px;color:#ffd700}
    .info-panel{background:#1a1a2e;border:1px solid #2a2a4a;border-radius:12px;padding:20px;margin-bottom:16px}
    .info-panel h3{margin-bottom:10px;color:#ccc}
    .info-panel ul{padding-left:20px;color:#999;line-height:1.8}
    .info-panel li{margin-bottom:2px}
    .hidden-videos{position:absolute;left:-9999px;top:-9999px;width:1px;height:1px;overflow:hidden}
    .settings-row{display:flex;gap:16px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .settings-row label{font-size:.9em;color:#aaa}
    .settings-row select{background:#12122a;color:#e0e0e0;border:1px solid #2a2a4a;border-radius:6px;padding:6px 10px;font-size:.9em}
    .countdown-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:10}
    .countdown-num{font-size:120px;font-weight:900;color:#fff;text-shadow:0 0 40px rgba(255,100,100,.6);animation:countPop .4s ease-out}
    @keyframes countPop{0%{transform:scale(1.8);opacity:0}100%{transform:scale(1);opacity:1}}
    .history-panel{background:#1a1a2e;border:1px solid #2a2a4a;border-radius:12px;padding:16px;margin-bottom:16px}
    .history-panel h3{margin-bottom:10px;color:#ccc;font-size:1em}
    .history-list{max-height:160px;overflow-y:auto}
    .history-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid #2a2a4a;font-size:.85em}
    .history-item:last-child{border-bottom:none}
    .history-item .meta{color:#888}
    .no-history{color:#555;font-size:.85em;text-align:center;padding:20px}
    @media(max-width:700px){
      .source-row{flex-direction:column}
      header h1{font-size:1.2em}
      .controls-bar{gap:6px}
      .btn{padding:8px 14px;font-size:.85em}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>&#127909; Split-Screen Recorder</h1>
      <p>Record webcam + screen share (or two cameras) in a combined split-screen video</p>
    </header>

    <div class="setup-panel" id="setup-panel">
      <h2>1. Choose your two sources</h2>
      <div class="source-row" id="sourceA-row">
        <div class="source-card active" data-source="webcam" data-slot="A">
          <div class="icon">&#128247;</div>
          <div class="label">Webcam</div>
          <div class="desc">Default camera</div>
        </div>
        <div class="source-card" data-source="screen" data-slot="A">
          <div class="icon">&#128187;</div>
          <div class="label">Screen Share</div>
          <div class="desc">Window, tab, or screen</div>
        </div>
      </div>
      <div class="source-row" id="sourceB-row">
        <div class="source-card active" data-source="screen" data-slot="B">
          <div class="icon">&#128187;</div>
          <div class="label">Screen Share</div>
          <div class="desc">Window, tab, or screen</div>
        </div>
        <div class="source-card" data-source="webcam" data-slot="B">
          <div class="icon">&#128247;</div>
          <div class="label">Webcam 2</div>
          <div class="desc">Second camera (if available)</div>
        </div>
      </div>

      <h2 style="margin-top:20px">2. Layout</h2>
      <div class="layout-row" id="layout-row">
        <div class="layout-opt active" data-layout="side-by-side">
          <div class="icon">&#9638;&#9638;</div>
          <div class="lbl">Side by Side</div>
        </div>
        <div class="layout-opt" data-layout="pip-br">
          <div class="icon">&#9639;</div>
          <div class="lbl">PiP Bottom-Right</div>
        </div>
        <div class="layout-opt" data-layout="pip-bl">
          <div class="icon">&#9638;</div>
          <div class="lbl">PiP Bottom-Left</div>
        </div>
        <div class="layout-opt" data-layout="top-bottom">
          <div class="icon">&#9650;&#9660;</div>
          <div class="lbl">Top / Bottom</div>
        </div>
      </div>

      <h2>3. Settings</h2>
      <div class="settings-row">
        <label>Resolution:</label>
        <select id="res-select">
          <option value="1280x720" selected>1280 &times; 720 (HD)</option>
          <option value="1920x1080">1920 &times; 1080 (Full HD)</option>
          <option value="960x540">960 &times; 540</option>
        </select>
        <label>Audio:</label>
        <select id="audio-select">
          <option value="both" selected>Both sources</option>
          <option value="A">Source A only</option>
          <option value="B">Source B only</option>
          <option value="none">No audio</option>
        </select>
      </div>

      <div class="controls-bar" style="margin-top:16px">
        <button class="btn btn-source" id="init-btn">&#9654; Initialize Sources</button>
      </div>
    </div>

    <div class="preview-area" id="preview-area" style="display:none">
      <canvas id="preview-canvas"></canvas>
      <div class="overlay-badge" id="source-labels">A: Webcam | B: Screen</div>
      <div class="rec-dot" id="rec-dot"><span class="dot"></span> REC</div>
      <div class="countdown-overlay" id="countdown-overlay"><div class="countdown-num" id="countdown-num"></div></div>
    </div>

    <div class="controls-bar" id="main-controls" style="display:none">
      <button class="btn btn-swap" id="swap-btn" title="Swap A and B">&#8644; Swap</button>
      <button class="btn btn-start" id="rec-btn">&#9679; Record</button>
      <span class="timer" id="timer">00:00</span>
      <button class="btn btn-stop" id="stop-btn" disabled>&#9632; Stop</button>
      <button class="btn btn-reset" id="reset-btn">&#8634; Reset</button>
    </div>
    <div class="status-bar" id="status-bar"></div>

    <div class="playback-panel" id="playback-panel">
      <h2>&#127881; Recording Complete!</h2>
      <video id="result-video" controls></video>
      <div class="controls-bar" style="margin-top:12px">
        <button class="btn btn-download" id="dl-btn">&#11015; Download Video</button>
        <button class="btn btn-reset" id="new-btn">&#8634; New Recording</button>
      </div>
    </div>

    <div class="history-panel" id="history-panel">
      <h3>&#128196; Recording History</h3>
      <div class="history-list" id="history-list">
        <div class="no-history">No recordings yet</div>
      </div>
    </div>

    <div class="info-panel">
      <h3>How It Works</h3>
      <ul>
        <li>Pick two sources: webcam, second camera, or screen/window share</li>
        <li>Choose a layout: side-by-side, picture-in-picture, or top/bottom</li>
        <li>Click <strong>Initialize Sources</strong> &mdash; grant permissions when prompted</li>
        <li>Preview your split-screen live on the canvas</li>
        <li>Hit <strong>Record</strong> (3-second countdown), then <strong>Stop</strong> when done</li>
        <li>Download the combined .webm video &mdash; everything happens locally, nothing leaves your device</li>
      </ul>
    </div>
  </div>

  <div class="hidden-videos">
    <video id="vidA" autoplay muted playsinline></video>
    <video id="vidB" autoplay muted playsinline></video>
  </div>

  <script>
    (function() {
      'use strict';

      var canvas = document.getElementById('preview-canvas');
      var ctx = canvas.getContext('2d');
      var vidA = document.getElementById('vidA');
      var vidB = document.getElementById('vidB');
      var streamA = null;
      var streamB = null;
      var mediaRecorder = null;
      var chunks = [];
      var isRecording = false;
      var drawRAF = null;
      var timerInterval = null;
      var startTime = 0;
      var lastBlob = null;

      var config = {
        sourceA: 'webcam',
        sourceB: 'screen',
        layout: 'side-by-side',
        width: 1280,
        height: 720,
        audio: 'both'
      };

      // DOM refs
      var setupPanel = document.getElementById('setup-panel');
      var previewArea = document.getElementById('preview-area');
      var mainControls = document.getElementById('main-controls');
      var playbackPanel = document.getElementById('playback-panel');
      var statusBar = document.getElementById('status-bar');
      var recDot = document.getElementById('rec-dot');
      var sourceLabels = document.getElementById('source-labels');
      var countdownOverlay = document.getElementById('countdown-overlay');
      var countdownNum = document.getElementById('countdown-num');
      var timerEl = document.getElementById('timer');
      var recBtn = document.getElementById('rec-btn');
      var stopBtn = document.getElementById('stop-btn');
      var resultVideo = document.getElementById('result-video');

      // Source selection
      document.querySelectorAll('#sourceA-row .source-card').forEach(function(card) {
        card.addEventListener('click', function() {
          document.querySelectorAll('#sourceA-row .source-card').forEach(function(c) { c.classList.remove('active'); });
          card.classList.add('active');
          config.sourceA = card.dataset.source;
        });
      });
      document.querySelectorAll('#sourceB-row .source-card').forEach(function(card) {
        card.addEventListener('click', function() {
          document.querySelectorAll('#sourceB-row .source-card').forEach(function(c) { c.classList.remove('active'); });
          card.classList.add('active');
          config.sourceB = card.dataset.source;
        });
      });

      // Layout selection
      document.querySelectorAll('#layout-row .layout-opt').forEach(function(opt) {
        opt.addEventListener('click', function() {
          document.querySelectorAll('#layout-row .layout-opt').forEach(function(o) { o.classList.remove('active'); });
          opt.classList.add('active');
          config.layout = opt.dataset.layout;
        });
      });

      // Resolution
      document.getElementById('res-select').addEventListener('change', function() {
        var parts = this.value.split('x');
        config.width = parseInt(parts[0], 10);
        config.height = parseInt(parts[1], 10);
      });

      // Audio
      document.getElementById('audio-select').addEventListener('change', function() {
        config.audio = this.value;
      });

      // Acquire a media source
      function acquireSource(type, existingDeviceIds) {
        if (type === 'screen') {
          return navigator.mediaDevices.getDisplayMedia({ video: true, audio: true }).catch(function(e) {
            return navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
          });
        }
        var constraints = { video: true, audio: true };
        if (existingDeviceIds && existingDeviceIds.length > 0) {
          constraints.video = { deviceId: { not: existingDeviceIds } };
        }
        return navigator.mediaDevices.getUserMedia(constraints);
      }

      function getDeviceId(stream) {
        var tracks = stream.getVideoTracks();
        if (tracks.length > 0 && tracks[0].getSettings) {
          return tracks[0].getSettings().deviceId || null;
        }
        return null;
      }

      // Initialize sources
      document.getElementById('init-btn').addEventListener('click', async function() {
        setStatus('Acquiring source A (' + config.sourceA + ')...');
        try {
          streamA = await acquireSource(config.sourceA, []);
          vidA.srcObject = streamA;
        } catch (e) {
          setStatus('Error getting source A: ' + e.message);
          return;
        }

        var usedIds = [];
        var idA = getDeviceId(streamA);
        if (idA) usedIds.push(idA);

        setStatus('Acquiring source B (' + config.sourceB + ')...');
        try {
          streamB = await acquireSource(config.sourceB, usedIds);
          vidB.srcObject = streamB;
        } catch (e) {
          setStatus('Error getting source B: ' + e.message);
          return;
        }

        // Listen for track ended (screen share stopped by user)
        streamA.getVideoTracks().forEach(function(t) {
          t.addEventListener('ended', function() { if (isRecording) doStop(); });
        });
        streamB.getVideoTracks().forEach(function(t) {
          t.addEventListener('ended', function() { if (isRecording) doStop(); });
        });

        canvas.width = config.width;
        canvas.height = config.height;

        setupPanel.style.display = 'none';
        previewArea.style.display = 'block';
        mainControls.style.display = 'flex';
        playbackPanel.style.display = 'none';
        updateLabels();
        setStatus('Sources ready. Hit Record when you are ready!');
        startPreviewLoop();
      });

      function updateLabels() {
        var a = config.sourceA === 'screen' ? 'Screen' : 'Webcam';
        var b = config.sourceB === 'screen' ? 'Screen' : 'Webcam';
        sourceLabels.textContent = 'A: ' + a + ' | B: ' + b + ' | Layout: ' + config.layout;
      }

      // Drawing logic — fit source video into a target rect while preserving aspect ratio
      function drawFitted(video, dx, dy, dw, dh) {
        if (!video.videoWidth || !video.videoHeight) return;
        var sw = video.videoWidth;
        var sh = video.videoHeight;
        var scale = Math.min(dw / sw, dh / sh);
        var rw = sw * scale;
        var rh = sh * scale;
        var rx = dx + (dw - rw) / 2;
        var ry = dy + (dh - rh) / 2;
        ctx.drawImage(video, rx, ry, rw, rh);
      }

      function drawFrame() {
        var w = canvas.width;
        var h = canvas.height;
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, w, h);

        if (config.layout === 'side-by-side') {
          var hw = w / 2;
          drawFitted(vidA, 0, 0, hw, h);
          drawFitted(vidB, hw, 0, hw, h);
          ctx.strokeStyle = '#333';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(hw, 0);
          ctx.lineTo(hw, h);
          ctx.stroke();
        } else if (config.layout === 'top-bottom') {
          var hh = h / 2;
          drawFitted(vidA, 0, 0, w, hh);
          drawFitted(vidB, 0, hh, w, hh);
          ctx.strokeStyle = '#333';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(0, hh);
          ctx.lineTo(w, hh);
          ctx.stroke();
        } else if (config.layout === 'pip-br' || config.layout === 'pip-bl') {
          drawFitted(vidA, 0, 0, w, h);
          var pw = Math.round(w * 0.3);
          var ph = Math.round(h * 0.3);
          var px = config.layout === 'pip-br' ? w - pw - 16 : 16;
          var py = h - ph - 16;
          ctx.fillStyle = '#000';
          ctx.fillRect(px - 3, py - 3, pw + 6, ph + 6);
          drawFitted(vidB, px, py, pw, ph);
          ctx.strokeStyle = '#ffd700';
          ctx.lineWidth = 2;
          ctx.strokeRect(px - 1, py - 1, pw + 2, ph + 2);
        }

        // Labels on recording
        if (isRecording) {
          ctx.font = 'bold 14px sans-serif';
          ctx.fillStyle = 'rgba(0,0,0,0.55)';
          ctx.fillRect(8, 8, 56, 22);
          ctx.fillStyle = '#fff';
          ctx.fillText('A', 16, 24);
          if (config.layout === 'side-by-side') {
            ctx.fillStyle = 'rgba(0,0,0,0.55)';
            ctx.fillRect(w / 2 + 8, 8, 56, 22);
            ctx.fillStyle = '#fff';
            ctx.fillText('B', w / 2 + 16, 24);
          } else if (config.layout === 'top-bottom') {
            ctx.fillStyle = 'rgba(0,0,0,0.55)';
            ctx.fillRect(8, h / 2 + 8, 56, 22);
            ctx.fillStyle = '#fff';
            ctx.fillText('B', 16, h / 2 + 24);
          }
        }

        drawRAF = requestAnimationFrame(drawFrame);
      }

      function startPreviewLoop() {
        if (drawRAF) cancelAnimationFrame(drawRAF);
        drawRAF = requestAnimationFrame(drawFrame);
      }

      function stopPreviewLoop() {
        if (drawRAF) { cancelAnimationFrame(drawRAF); drawRAF = null; }
      }

      // Swap sources
      document.getElementById('swap-btn').addEventListener('click', function() {
        if (isRecording) return;
        var tmpStream = streamA;
        streamA = streamB;
        streamB = tmpStream;
        vidA.srcObject = streamA;
        vidB.srcObject = streamB;
        var tmpType = config.sourceA;
        config.sourceA = config.sourceB;
        config.sourceB = tmpType;
        updateLabels();
      });

      // Countdown then record
      recBtn.addEventListener('click', function() {
        if (isRecording) return;
        recBtn.disabled = true;
        var count = 3;
        countdownOverlay.style.display = 'flex';
        countdownNum.textContent = count;
        var iv = setInterval(function() {
          count--;
          if (count > 0) {
            countdownNum.textContent = count;
          } else {
            clearInterval(iv);
            countdownOverlay.style.display = 'none';
            doRecord();
          }
        }, 1000);
      });

      function doRecord() {
        chunks = [];
        canvas.width = config.width;
        canvas.height = config.height;

        var canvasStream = canvas.captureStream(30);

        // Mix audio from sources
        try {
          var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          var dest = audioCtx.createMediaStreamDestination();
          var addedAudio = false;

          if (config.audio === 'both' || config.audio === 'A') {
            if (streamA && streamA.getAudioTracks().length > 0) {
              audioCtx.createMediaStreamSource(streamA).connect(dest);
              addedAudio = true;
            }
          }
          if (config.audio === 'both' || config.audio === 'B') {
            if (streamB && streamB.getAudioTracks().length > 0) {
              audioCtx.createMediaStreamSource(streamB).connect(dest);
              addedAudio = true;
            }
          }
          if (addedAudio) {
            dest.stream.getAudioTracks().forEach(function(t) {
              canvasStream.addTrack(t);
            });
          }
        } catch (audioErr) {
          console.warn('Audio mixing failed, recording without audio:', audioErr);
        }

        var mimeTypes = [
          'video/webm;codecs=vp9,opus',
          'video/webm;codecs=vp8,opus',
          'video/webm;codecs=vp9',
          'video/webm;codecs=vp8',
          'video/webm'
        ];
        var chosenMime = '';
        for (var i = 0; i < mimeTypes.length; i++) {
          if (MediaRecorder.isTypeSupported(mimeTypes[i])) {
            chosenMime = mimeTypes[i];
            break;
          }
        }

        try {
          var opts = chosenMime ? { mimeType: chosenMime } : {};
          mediaRecorder = new MediaRecorder(canvasStream, opts);
        } catch (recErr) {
          setStatus('MediaRecorder not supported in this browser.');
          recBtn.disabled = false;
          return;
        }

        mediaRecorder.ondataavailable = function(e) {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };

        mediaRecorder.onstop = function() {
          isRecording = false;
          recDot.style.display = 'none';
          clearInterval(timerInterval);
          recBtn.disabled = false;
          stopBtn.disabled = true;

          if (chunks.length === 0) {
            setStatus('No data recorded.');
            return;
          }

          lastBlob = new Blob(chunks, { type: chosenMime || 'video/webm' });
          var url = URL.createObjectURL(lastBlob);
          resultVideo.src = url;
          playbackPanel.style.display = 'block';
          setStatus('Recording saved! ' + formatBytes(lastBlob.size));
          saveToHistory(lastBlob.size);
        };

        mediaRecorder.start(500);
        isRecording = true;
        startTime = Date.now();
        recDot.style.display = 'flex';
        stopBtn.disabled = false;
        setStatus('Recording...');

        timerInterval = setInterval(function() {
          var elapsed = Date.now() - startTime;
          timerEl.textContent = formatTime(elapsed);
        }, 250);
      }

      // Stop
      stopBtn.addEventListener('click', doStop);
      function doStop() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
      }

      // Download
      document.getElementById('dl-btn').addEventListener('click', function() {
        if (!lastBlob) return;
        var a = document.createElement('a');
        a.href = URL.createObjectURL(lastBlob);
        a.download = 'split-screen-' + new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-') + '.webm';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });

      // Reset
      function doReset() {
        if (isRecording) doStop();
        stopPreviewLoop();
        if (streamA) { streamA.getTracks().forEach(function(t) { t.stop(); }); streamA = null; }
        if (streamB) { streamB.getTracks().forEach(function(t) { t.stop(); }); streamB = null; }
        vidA.srcObject = null;
        vidB.srcObject = null;
        lastBlob = null;
        resultVideo.src = '';
        timerEl.textContent = '00:00';
        recBtn.disabled = false;
        stopBtn.disabled = true;
        setupPanel.style.display = 'block';
        previewArea.style.display = 'none';
        mainControls.style.display = 'none';
        playbackPanel.style.display = 'none';
        setStatus('');
      }
      document.getElementById('reset-btn').addEventListener('click', doReset);
      document.getElementById('new-btn').addEventListener('click', doReset);

      // Helpers
      function setStatus(msg) { statusBar.textContent = msg; }

      function formatTime(ms) {
        var s = Math.floor(ms / 1000);
        var m = Math.floor(s / 60);
        s = s % 60;
        return (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
      }

      function formatBytes(b) {
        if (b < 1024) return b + ' B';
        if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
        return (b / 1048576).toFixed(1) + ' MB';
      }

      // localStorage history
      function loadHistory() {
        try {
          return JSON.parse(localStorage.getItem('splitrec_history') || '[]');
        } catch (e) {
          return [];
        }
      }

      function saveToHistory(size) {
        var hist = loadHistory();
        hist.unshift({
          date: new Date().toISOString(),
          layout: config.layout,
          sourceA: config.sourceA,
          sourceB: config.sourceB,
          resolution: config.width + 'x' + config.height,
          size: size
        });
        if (hist.length > 50) hist = hist.slice(0, 50);
        try {
          localStorage.setItem('splitrec_history', JSON.stringify(hist));
        } catch (e) {
          /* quota exceeded — ignore */
        }
        renderHistory();
      }

      function renderHistory() {
        var hist = loadHistory();
        var container = document.getElementById('history-list');
        if (hist.length === 0) {
          container.innerHTML = '<div class="no-history">No recordings yet<\/div>';
          return;
        }
        var html = '';
        hist.forEach(function(item) {
          var d = new Date(item.date);
          var dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
          html += '<div class="history-item">' +
            '<span>' + dateStr + ' &mdash; ' + item.layout + ' (' + item.sourceA + ' + ' + item.sourceB + ')<\/span>' +
            '<span class="meta">' + item.resolution + ' &middot; ' + formatBytes(item.size) + '<\/span>' +
            '<\/div>';
        });
        container.innerHTML = html;
      }

      renderHistory();
    })();
  </script>
</body>
</html>
