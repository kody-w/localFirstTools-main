<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Vault - Local-First Personal Memory Tool</title>
    <meta name="description" content="A comprehensive local-first personal memory and productivity tool with screen capture, audio recording, timeline, and powerful search. Privacy-focused alternative to Rewind.ai.">
    <!-- memory, productivity, screen-capture, audio, timeline, search, local-first, privacy -->
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --bg-hover: #1a4a7a;
            --accent: #00d4ff;
            --accent-dim: rgba(0, 212, 255, 0.2);
            --accent-glow: rgba(0, 212, 255, 0.4);
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --text-muted: #6a6a8a;
            --danger: #ff4757;
            --success: #2ed573;
            --warning: #ffa502;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-card);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-dim);
        }

        /* Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            background: rgba(15, 52, 96, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent) 0%, #0099cc 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent), #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Status Indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.3s ease;
        }

        .status-dot.recording {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }

        .status-dot.active {
            background: var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); }
            50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(255, 71, 87, 0); }
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #0099cc 100%);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 24px;
            background: rgba(15, 52, 96, 0.5);
            border-bottom: 1px solid var(--border);
        }

        .nav-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }

        .nav-tab.active {
            color: var(--accent);
            background: var(--accent-dim);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* Capture Controls */
        .capture-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .capture-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .capture-group label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .capture-buttons {
            display: flex;
            gap: 8px;
        }

        /* Select Styling */
        select {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }

        select:focus {
            border-color: var(--accent);
        }

        /* Search Bar */
        .search-container {
            position: relative;
            margin-bottom: 24px;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 20px;
        }

        .search-filters {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 6px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-chip:hover, .filter-chip.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Timeline */
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .view-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: var(--radius-sm);
        }

        .view-btn {
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .view-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
        }

        /* Grid View */
        .entries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        /* List View */
        .entries-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .entries-list .entry-card {
            display: flex;
            flex-direction: row;
            gap: 16px;
        }

        .entries-list .entry-thumbnail {
            width: 160px;
            height: 100px;
            flex-shrink: 0;
        }

        .entries-list .entry-content {
            flex: 1;
        }

        /* Entry Card */
        .entry-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .entry-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: var(--accent-dim);
        }

        .entry-thumbnail {
            width: 100%;
            height: 160px;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }

        .entry-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .entry-thumbnail.audio {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2d1f5c 0%, #1a1a2e 100%);
        }

        .audio-icon {
            font-size: 48px;
            color: var(--accent);
        }

        .entry-type-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .entry-type-badge.screen { color: var(--accent); }
        .entry-type-badge.audio { color: #ff6b9d; }
        .entry-type-badge.bookmark { color: var(--warning); }

        .entry-starred {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            color: var(--warning);
        }

        .entry-content {
            padding: 16px;
        }

        .entry-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .entry-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .entry-notes {
            font-size: 14px;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .entry-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 3px 8px;
            background: var(--accent-dim);
            color: var(--accent);
            border-radius: 4px;
            font-size: 11px;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
        }

        .entry-action {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .entry-action:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Audio Waveform */
        .waveform-container {
            height: 80px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            margin: 16px 0;
            overflow: hidden;
            position: relative;
        }

        .waveform-canvas {
            width: 100%;
            height: 100%;
        }

        .waveform-time {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 12px;
            color: var(--text-muted);
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.2s ease;
        }

        .form-input:focus, .form-textarea:focus {
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .stat-change {
            font-size: 12px;
            margin-top: 8px;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* Storage Usage */
        .storage-bar {
            height: 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            overflow: hidden;
            margin: 16px 0;
        }

        .storage-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #0099cc);
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        .storage-legend {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .storage-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .storage-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .storage-dot.screenshots { background: var(--accent); }
        .storage-dot.audio { background: #ff6b9d; }
        .storage-dot.bookmarks { background: var(--warning); }

        /* Tag Cloud */
        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .tag-cloud .tag {
            padding: 8px 16px;
            font-size: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .tag-cloud .tag:hover {
            transform: scale(1.1);
        }

        .tag-cloud .tag.size-1 { font-size: 12px; opacity: 0.7; }
        .tag-cloud .tag.size-2 { font-size: 14px; opacity: 0.8; }
        .tag-cloud .tag.size-3 { font-size: 16px; opacity: 0.9; }
        .tag-cloud .tag.size-4 { font-size: 18px; }
        .tag-cloud .tag.size-5 { font-size: 20px; font-weight: 600; }

        /* Activity Chart */
        .activity-chart {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 120px;
        }

        .chart-bar {
            flex: 1;
            background: var(--accent-dim);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 4px;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            background: var(--accent);
        }

        .chart-bar-inner {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--accent);
            border-radius: 4px 4px 0 0;
        }

        .chart-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Settings */
        .settings-section {
            margin-bottom: 32px;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
        }

        .settings-info h4 {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .settings-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-secondary);
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: 0.3s;
        }

        input:checked + .toggle-slider {
            background: var(--accent);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background: white;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #0099cc 100%);
            border: none;
            color: var(--bg-primary);
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 20px var(--accent-glow);
            transition: all 0.3s ease;
            z-index: 50;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px var(--accent-glow);
        }

        .fab.recording {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }

        /* Quick Actions Menu */
        .quick-actions {
            position: fixed;
            bottom: 110px;
            right: 32px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 49;
        }

        .quick-actions.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .quick-action {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 30px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .quick-action:hover {
            background: var(--bg-hover);
            transform: translateX(-8px);
        }

        /* Keyboard Shortcuts Help */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
        }

        .shortcut-key {
            padding: 4px 10px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            color: var(--accent);
            border: 1px solid var(--border);
        }

        .shortcut-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .empty-text {
            font-size: 14px;
            max-width: 400px;
            margin: 0 auto 24px;
            line-height: 1.6;
        }

        /* Highlight */
        .highlight {
            background: var(--accent-dim);
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 14px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            box-shadow: var(--shadow);
            animation: slideUp 0.3s ease;
        }

        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--accent); }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Password Protection */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .password-card {
            background: var(--bg-card);
            padding: 40px;
            border-radius: var(--radius);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .password-card h2 {
            margin-bottom: 24px;
        }

        .password-input {
            width: 100%;
            padding: 14px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 16px;
            text-align: center;
            letter-spacing: 4px;
            margin-bottom: 20px;
        }

        /* Preview Image */
        .preview-image {
            width: 100%;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
        }

        /* Audio Player */
        .audio-player {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }

        .audio-player button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: var(--bg-primary);
            font-size: 20px;
            cursor: pointer;
        }

        .audio-progress {
            flex: 1;
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .audio-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            width: 0%;
        }

        /* Import/Export in header */
        .data-controls {
            display: flex;
            gap: 8px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .logo-text {
                font-size: 20px;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .nav-tabs {
                padding: 8px 16px;
                overflow-x: auto;
            }

            .main-content {
                padding: 16px;
            }

            .capture-controls {
                flex-direction: column;
            }

            .entries-grid {
                grid-template-columns: 1fr;
            }

            .entries-list .entry-card {
                flex-direction: column;
            }

            .entries-list .entry-thumbnail {
                width: 100%;
                height: 160px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
                font-size: 24px;
            }

            .quick-actions {
                right: 20px;
                bottom: 90px;
            }

            .modal {
                width: 95%;
            }

            .shortcuts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 28px;
            }

            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Collections Section */
        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }

        .collection-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .collection-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .collection-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-dim);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .collection-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .collection-count {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Interval Preview */
        .interval-preview {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay (hidden by default) -->
    <div id="passwordOverlay" class="password-overlay hidden">
        <div class="password-card">
            <div class="logo-icon" style="margin: 0 auto 20px; width: 60px; height: 60px; font-size: 28px;">&#128274;</div>
            <h2>Memory Vault Locked</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">Enter your password to access your memories</p>
            <input type="password" id="passwordInput" class="password-input" placeholder="******" autocomplete="off" onkeydown="if(event.key==='Enter')unlockVault()">
            <button class="btn btn-primary" style="width: 100%;" onclick="unlockVault()">Unlock</button>
        </div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">&#128240;</div>
                <span class="logo-text">Memory Vault</span>
            </div>

            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Ready</span>
            </div>

            <div class="header-actions">
                <div class="data-controls">
                    <button class="btn btn-secondary btn-sm" onclick="exportAllData()" title="Export all data as JSON">
                        &#128229; Export
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('importFile').click()" title="Import data from JSON">
                        &#128228; Import
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(event)">
                </div>
                <button class="btn btn-secondary btn-icon" onclick="showModal('settingsModal')" title="Settings">
                    &#9881;
                </button>
                <button class="btn btn-secondary btn-icon" onclick="showModal('shortcutsModal')" title="Keyboard Shortcuts">
                    &#9000;
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs" role="navigation" aria-label="Main navigation">
            <button class="nav-tab active" data-tab="timeline" onclick="switchTab('timeline')">&#128197; Timeline</button>
            <button class="nav-tab" data-tab="capture" onclick="switchTab('capture')">&#127909; Capture</button>
            <button class="nav-tab" data-tab="collections" onclick="switchTab('collections')">&#128194; Collections</button>
            <button class="nav-tab" data-tab="stats" onclick="switchTab('stats')">&#128200; Statistics</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Timeline Tab -->
            <section id="timelineTab" class="tab-content">
                <!-- Search -->
                <div class="search-container">
                    <span class="search-icon">&#128269;</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search your memories... (press / to focus)" oninput="debouncedSearch()">
                    <div class="search-filters">
                        <button class="filter-chip active" data-filter="all" onclick="setFilter('all')">All</button>
                        <button class="filter-chip" data-filter="screen" onclick="setFilter('screen')">&#128247; Screenshots</button>
                        <button class="filter-chip" data-filter="audio" onclick="setFilter('audio')">&#127908; Audio</button>
                        <button class="filter-chip" data-filter="bookmark" onclick="setFilter('bookmark')">&#11088; Bookmarks</button>
                        <button class="filter-chip" data-filter="starred" onclick="setFilter('starred')">&#9733; Starred</button>
                        <input type="date" class="filter-chip" id="dateFilter" onchange="applyFilters()" style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary);">
                    </div>
                </div>

                <!-- Timeline Header -->
                <div class="timeline-header">
                    <h2 id="entriesCount">0 Memories</h2>
                    <div class="view-toggle">
                        <button class="view-btn active" id="gridViewBtn" onclick="setView('grid')" title="Grid View">&#9783;</button>
                        <button class="view-btn" id="listViewBtn" onclick="setView('list')" title="List View">&#9776;</button>
                    </div>
                </div>

                <!-- Entries Container -->
                <div id="entriesContainer" class="entries-grid">
                    <!-- Entries will be rendered here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state hidden">
                    <div class="empty-icon">&#128247;</div>
                    <h3 class="empty-title">No memories yet</h3>
                    <p class="empty-text">Start capturing your screen or recording audio to build your memory vault. Everything stays private on your device.</p>
                    <button class="btn btn-primary" onclick="switchTab('capture')">Start Capturing</button>
                </div>

                <!-- Load More -->
                <div id="loadMoreContainer" class="hidden" style="text-align: center; padding: 20px;">
                    <button class="btn btn-secondary" onclick="loadMoreEntries()">Load More</button>
                </div>
            </section>

            <!-- Capture Tab -->
            <section id="captureTab" class="tab-content hidden">
                <h2 style="margin-bottom: 24px;">Capture Controls</h2>

                <!-- Screen Capture -->
                <div class="capture-controls">
                    <div class="capture-group" style="flex: 1;">
                        <label>Screen Capture</label>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                            Capture screenshots of your screen automatically or manually. Perfect for documenting your work.
                        </p>
                        <div class="capture-buttons">
                            <button class="btn btn-primary" id="startScreenCapture" onclick="toggleScreenCapture()">
                                &#128247; Start Auto-Capture
                            </button>
                            <button class="btn btn-secondary" onclick="captureScreenNow()">
                                &#128248; Capture Now
                            </button>
                        </div>
                    </div>
                    <div class="capture-group">
                        <label>Capture Interval</label>
                        <select id="captureInterval" onchange="updateCaptureInterval()">
                            <option value="5000">Every 5 seconds</option>
                            <option value="15000" selected>Every 15 seconds</option>
                            <option value="30000">Every 30 seconds</option>
                            <option value="60000">Every 1 minute</option>
                            <option value="300000">Every 5 minutes</option>
                        </select>
                        <div class="interval-preview" id="intervalPreview">
                            <span class="status-dot"></span>
                            <span>Not capturing</span>
                        </div>
                    </div>
                </div>

                <!-- Screen Preview -->
                <div id="screenPreviewContainer" class="hidden" style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 12px;">Current Screen Preview</h3>
                    <video id="screenPreview" autoplay muted style="width: 100%; max-width: 800px; border-radius: var(--radius); background: var(--bg-secondary);"></video>
                </div>

                <!-- Audio Recording -->
                <div class="capture-controls">
                    <div class="capture-group" style="flex: 1;">
                        <label>Audio Recording</label>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                            Record audio from your microphone. Great for capturing voice notes and meetings.
                        </p>
                        <div class="capture-buttons">
                            <button class="btn btn-primary" id="startAudioRecording" onclick="toggleAudioRecording()">
                                &#127908; Start Recording
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Audio Waveform -->
                <div id="audioWaveformContainer" class="hidden">
                    <h3 style="margin-bottom: 12px;">Recording in Progress</h3>
                    <div class="waveform-container">
                        <canvas id="waveformCanvas" class="waveform-canvas"></canvas>
                        <div class="waveform-time" id="recordingTime">00:00</div>
                    </div>
                </div>

                <!-- Quick Bookmark -->
                <div class="capture-controls" style="margin-top: 24px;">
                    <div class="capture-group" style="flex: 1;">
                        <label>Quick Bookmark</label>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                            Create a text bookmark to mark important moments. Press <span class="shortcut-key">B</span> anywhere to quickly add a bookmark.
                        </p>
                        <div style="display: flex; gap: 12px;">
                            <input type="text" class="form-input" id="quickBookmarkText" placeholder="Enter bookmark note..." style="flex: 1;">
                            <button class="btn btn-primary" onclick="addQuickBookmark()">
                                &#11088; Add Bookmark
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Captures Preview -->
                <div style="margin-top: 32px;">
                    <h3 style="margin-bottom: 16px;">Recent Captures</h3>
                    <div id="recentCaptures" class="entries-grid" style="max-height: 400px; overflow-y: auto;">
                        <!-- Recent captures will be rendered here -->
                    </div>
                </div>
            </section>

            <!-- Collections Tab -->
            <section id="collectionsTab" class="tab-content hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2>Collections</h2>
                    <button class="btn btn-primary" onclick="showModal('newCollectionModal')">
                        &#43; New Collection
                    </button>
                </div>

                <div id="collectionsContainer" class="collections-grid">
                    <!-- Collections will be rendered here -->
                </div>

                <div id="collectionsEmptyState" class="empty-state hidden">
                    <div class="empty-icon">&#128194;</div>
                    <h3 class="empty-title">No collections yet</h3>
                    <p class="empty-text">Create collections to organize your memories by project, topic, or any category you like.</p>
                    <button class="btn btn-primary" onclick="showModal('newCollectionModal')">Create Collection</button>
                </div>
            </section>

            <!-- Stats Tab -->
            <section id="statsTab" class="tab-content hidden">
                <h2 style="margin-bottom: 24px;">Statistics Dashboard</h2>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalCaptures">0</div>
                        <div class="stat-label">Total Captures</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTodayCaptures">0</div>
                        <div class="stat-label">Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statWeekCaptures">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statScreenshots">0</div>
                        <div class="stat-label">Screenshots</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statAudioRecordings">0</div>
                        <div class="stat-label">Audio Recordings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statBookmarks">0</div>
                        <div class="stat-label">Bookmarks</div>
                    </div>
                </div>

                <!-- Activity Chart -->
                <div class="activity-chart">
                    <h3 class="chart-title">Activity (Last 7 Days)</h3>
                    <div class="chart-bars" id="activityChart">
                        <!-- Chart bars will be rendered here -->
                    </div>
                    <div class="chart-labels" id="chartLabels">
                        <!-- Labels will be rendered here -->
                    </div>
                </div>

                <!-- Storage Usage -->
                <div class="stat-card" style="margin-bottom: 24px;">
                    <h3 class="chart-title">Storage Usage</h3>
                    <div class="storage-bar">
                        <div class="storage-fill" id="storageFill" style="width: 0%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                        <span id="storageUsed" style="font-size: 14px;">0 MB used</span>
                        <span style="font-size: 14px; color: var(--text-muted);">Estimated capacity: 50 MB</span>
                    </div>
                    <div class="storage-legend">
                        <div class="storage-item">
                            <div class="storage-dot screenshots"></div>
                            <span id="storageScreenshots">Screenshots: 0 MB</span>
                        </div>
                        <div class="storage-item">
                            <div class="storage-dot audio"></div>
                            <span id="storageAudio">Audio: 0 MB</span>
                        </div>
                        <div class="storage-item">
                            <div class="storage-dot bookmarks"></div>
                            <span id="storageBookmarks">Bookmarks: 0 KB</span>
                        </div>
                    </div>
                </div>

                <!-- Tag Cloud -->
                <div style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px;">Popular Tags</h3>
                    <div class="tag-cloud" id="tagCloud">
                        <!-- Tags will be rendered here -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="fab" onclick="toggleQuickActions()" title="Quick Actions" aria-label="Quick actions menu">
        &#43;
    </button>

    <!-- Quick Actions Menu -->
    <div class="quick-actions" id="quickActions">
        <button class="quick-action" onclick="captureScreenNow(); toggleQuickActions();">
            &#128248; Quick Screenshot
        </button>
        <button class="quick-action" onclick="toggleAudioRecording(); toggleQuickActions();">
            &#127908; Record Audio
        </button>
        <button class="quick-action" onclick="showBookmarkModal(); toggleQuickActions();">
            &#11088; Add Bookmark
        </button>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modals -->
    <!-- Entry Detail Modal -->
    <div class="modal-overlay" id="entryModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="entryModalTitle">Memory Details</h3>
                <button class="modal-close" onclick="closeModal('entryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="entryModalContent">
                    <!-- Entry content will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="deleteEntry(currentEntryId)">&#128465; Delete</button>
                <button class="btn btn-secondary" onclick="exportEntry(currentEntryId)">&#128229; Export</button>
                <button class="btn btn-primary" onclick="saveEntryChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4 class="settings-title">Privacy & Security</h4>
                    <div class="settings-row">
                        <div class="settings-info">
                            <h4>Password Protection</h4>
                            <p>Require password to access your vault</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="passwordToggle" onchange="togglePasswordProtection()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="passwordSetup" class="hidden" style="padding: 16px; background: var(--bg-card); border-radius: var(--radius-sm); margin-bottom: 12px;">
                        <div class="form-group">
                            <label class="form-label">Set Password</label>
                            <input type="password" class="form-input" id="newPassword" placeholder="Enter new password">
                        </div>
                        <button class="btn btn-primary" onclick="setPassword()">Set Password</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 class="settings-title">Data Management</h4>
                    <div class="settings-row">
                        <div class="settings-info">
                            <h4>Auto-Cleanup</h4>
                            <p>Automatically delete entries older than 30 days</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoCleanupToggle" onchange="toggleAutoCleanup()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-row">
                        <div class="settings-info">
                            <h4>Clear All Data</h4>
                            <p>Permanently delete all memories from this device</p>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="confirmClearAll()">Clear All</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h4 class="settings-title">Privacy Notice</h4>
                    <div style="padding: 16px; background: var(--bg-card); border-radius: var(--radius-sm); font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                        <p style="margin-bottom: 12px;"><strong style="color: var(--success);">&#10003; 100% Local Storage</strong></p>
                        <p>All your data is stored locally in your browser using IndexedDB. Nothing is ever sent to any server.</p>
                        <p style="margin-top: 12px;"><strong style="color: var(--accent);">&#128274; Your Privacy Matters</strong></p>
                        <p>Screenshots and audio recordings never leave your device. Export your data anytime to back it up.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal-overlay" id="shortcutsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Keyboard Shortcuts</h3>
                <button class="modal-close" onclick="closeModal('shortcutsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-item">
                        <span class="shortcut-key">B</span>
                        <span class="shortcut-desc">Quick Bookmark</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">S</span>
                        <span class="shortcut-desc">Capture Screenshot</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">R</span>
                        <span class="shortcut-desc">Toggle Recording</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">/</span>
                        <span class="shortcut-desc">Focus Search</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">Esc</span>
                        <span class="shortcut-desc">Close Modal</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">1</span>
                        <span class="shortcut-desc">Timeline Tab</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">2</span>
                        <span class="shortcut-desc">Capture Tab</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">3</span>
                        <span class="shortcut-desc">Collections Tab</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">4</span>
                        <span class="shortcut-desc">Statistics Tab</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-key">?</span>
                        <span class="shortcut-desc">Show Shortcuts</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Collection Modal -->
    <div class="modal-overlay" id="newCollectionModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Create Collection</h3>
                <button class="modal-close" onclick="closeModal('newCollectionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Collection Name</label>
                    <input type="text" class="form-input" id="collectionName" placeholder="e.g., Work Projects">
                </div>
                <div class="form-group">
                    <label class="form-label">Icon (emoji)</label>
                    <input type="text" class="form-input" id="collectionIcon" placeholder="&#128194;" value="&#128194;" maxlength="2">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newCollectionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createCollection()">Create</button>
            </div>
        </div>
    </div>

    <!-- Quick Bookmark Modal -->
    <div class="modal-overlay" id="bookmarkModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Add Bookmark</h3>
                <button class="modal-close" onclick="closeModal('bookmarkModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Note</label>
                    <textarea class="form-textarea" id="bookmarkNote" placeholder="What do you want to remember?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Tags (comma separated)</label>
                    <input type="text" class="form-input" id="bookmarkTags" placeholder="work, important, meeting">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('bookmarkModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveBookmark()">Save Bookmark</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Memory Vault - Local-First Personal Memory Tool
        // ============================================

        // App Configuration
        const APP_NAME = 'memory-vault';
        const DB_NAME = 'MemoryVaultDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'entries';
        const COLLECTIONS_STORE = 'collections';
        const SETTINGS_STORE = 'settings';

        // State Management
        let db = null;
        let currentEntryId = null;
        let currentFilter = 'all';
        let currentView = 'grid';
        let currentPage = 0;
        const PAGE_SIZE = 20;
        let screenStream = null;
        let screenCaptureInterval = null;
        let isCapturing = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let audioContext = null;
        let analyser = null;
        let animationId = null;
        let recordingStartTime = null;
        let searchTimeout = null;

        // ============================================
        // IndexedDB Database Setup
        // ============================================

        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;

                    // Entries store
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        const entriesStore = database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        entriesStore.createIndex('timestamp', 'timestamp', { unique: false });
                        entriesStore.createIndex('type', 'type', { unique: false });
                        entriesStore.createIndex('starred', 'starred', { unique: false });
                        entriesStore.createIndex('collectionId', 'collectionId', { unique: false });
                    }

                    // Collections store
                    if (!database.objectStoreNames.contains(COLLECTIONS_STORE)) {
                        const collectionsStore = database.createObjectStore(COLLECTIONS_STORE, { keyPath: 'id' });
                        collectionsStore.createIndex('name', 'name', { unique: false });
                    }

                    // Settings store
                    if (!database.objectStoreNames.contains(SETTINGS_STORE)) {
                        database.createObjectStore(SETTINGS_STORE, { keyPath: 'key' });
                    }
                };
            });
        }

        // Generic database operations
        async function dbAdd(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function dbPut(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function dbGet(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function dbDelete(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function dbGetAll(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        async function dbClear(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ============================================
        // Entry Management
        // ============================================

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        async function addEntry(entry) {
            const fullEntry = {
                id: generateId(),
                timestamp: Date.now(),
                starred: false,
                tags: [],
                notes: '',
                collectionId: null,
                ...entry
            };

            await dbAdd(STORE_NAME, fullEntry);
            showToast('Memory captured!', 'success');
            updateStats();
            return fullEntry;
        }

        async function updateEntry(id, updates) {
            const entry = await dbGet(STORE_NAME, id);
            if (entry) {
                const updatedEntry = { ...entry, ...updates };
                await dbPut(STORE_NAME, updatedEntry);
                return updatedEntry;
            }
            return null;
        }

        async function deleteEntry(id) {
            if (confirm('Are you sure you want to delete this memory?')) {
                await dbDelete(STORE_NAME, id);
                closeModal('entryModal');
                loadEntries();
                updateStats();
                showToast('Memory deleted', 'info');
            }
        }

        async function getEntries(options = {}) {
            const { filter = 'all', search = '', page = 0, limit = PAGE_SIZE, dateFilter = '' } = options;
            let entries = await dbGetAll(STORE_NAME);

            // Apply type filter
            if (filter !== 'all') {
                if (filter === 'starred') {
                    entries = entries.filter(e => e.starred);
                } else {
                    entries = entries.filter(e => e.type === filter);
                }
            }

            // Apply date filter
            if (dateFilter) {
                const filterDate = new Date(dateFilter);
                const startOfDay = new Date(filterDate.setHours(0, 0, 0, 0)).getTime();
                const endOfDay = new Date(filterDate.setHours(23, 59, 59, 999)).getTime();
                entries = entries.filter(e => e.timestamp >= startOfDay && e.timestamp <= endOfDay);
            }

            // Apply search
            if (search) {
                const searchLower = search.toLowerCase();
                entries = entries.filter(e => {
                    const searchableText = [
                        e.notes || '',
                        e.transcription || '',
                        ...(e.tags || [])
                    ].join(' ').toLowerCase();

                    // Fuzzy matching - check if all search terms appear
                    const searchTerms = searchLower.split(' ').filter(t => t.length > 0);
                    return searchTerms.every(term =>
                        searchableText.includes(term) ||
                        fuzzyMatch(term, searchableText)
                    );
                });
            }

            // Sort by timestamp descending
            entries.sort((a, b) => b.timestamp - a.timestamp);

            // Pagination
            const start = page * limit;
            const paginatedEntries = entries.slice(start, start + limit);

            return {
                entries: paginatedEntries,
                total: entries.length,
                hasMore: start + limit < entries.length
            };
        }

        // Simple fuzzy matching
        function fuzzyMatch(pattern, text) {
            let patternIdx = 0;
            for (let i = 0; i < text.length && patternIdx < pattern.length; i++) {
                if (text[i] === pattern[patternIdx]) {
                    patternIdx++;
                }
            }
            return patternIdx === pattern.length;
        }

        // ============================================
        // Screen Capture
        // ============================================

        async function startScreenCapture() {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: 'screen' }
                });

                // Show preview
                const preview = document.getElementById('screenPreview');
                preview.srcObject = screenStream;
                document.getElementById('screenPreviewContainer').classList.remove('hidden');

                // Handle stream end
                screenStream.getVideoTracks()[0].onended = () => {
                    stopScreenCapture();
                };

                return true;
            } catch (error) {
                console.error('Screen capture error:', error);
                showToast('Screen capture permission denied', 'error');
                return false;
            }
        }

        function stopScreenCapture() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            if (screenCaptureInterval) {
                clearInterval(screenCaptureInterval);
                screenCaptureInterval = null;
            }

            isCapturing = false;
            document.getElementById('screenPreviewContainer').classList.add('hidden');
            document.getElementById('startScreenCapture').innerHTML = '&#128247; Start Auto-Capture';
            document.getElementById('intervalPreview').innerHTML = '<span class="status-dot"></span><span>Not capturing</span>';
            updateStatus('Ready', 'idle');
        }

        async function toggleScreenCapture() {
            if (isCapturing) {
                stopScreenCapture();
                showToast('Auto-capture stopped', 'info');
            } else {
                const success = await startScreenCapture();
                if (success) {
                    isCapturing = true;
                    const interval = parseInt(document.getElementById('captureInterval').value);

                    // Capture immediately
                    await captureFrame();

                    // Start interval
                    screenCaptureInterval = setInterval(captureFrame, interval);

                    document.getElementById('startScreenCapture').innerHTML = '&#9209; Stop Capture';
                    updateIntervalPreview(interval);
                    updateStatus('Capturing', 'active');
                    showToast('Auto-capture started', 'success');
                }
            }
        }

        function updateIntervalPreview(interval) {
            const seconds = interval / 1000;
            const text = seconds >= 60 ? `Every ${seconds / 60} min` : `Every ${seconds}s`;
            document.getElementById('intervalPreview').innerHTML =
                '<span class="status-dot active"></span><span>' + text + '</span>';
        }

        function updateCaptureInterval() {
            if (isCapturing) {
                clearInterval(screenCaptureInterval);
                const interval = parseInt(document.getElementById('captureInterval').value);
                screenCaptureInterval = setInterval(captureFrame, interval);
                updateIntervalPreview(interval);
            }
        }

        async function captureFrame() {
            if (!screenStream) return;

            const video = document.getElementById('screenPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            await addEntry({
                type: 'screen',
                data: imageData,
                width: canvas.width,
                height: canvas.height
            });

            loadEntries();
        }

        async function captureScreenNow() {
            if (!screenStream) {
                const success = await startScreenCapture();
                if (success) {
                    // Wait for video to be ready
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await captureFrame();
                    stopScreenCapture();
                }
            } else {
                await captureFrame();
            }
        }

        // ============================================
        // Audio Recording
        // ============================================

        async function toggleAudioRecording() {
            if (isRecording) {
                stopAudioRecording();
            } else {
                await startAudioRecording();
            }
        }

        async function startAudioRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Setup audio context for visualization
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;

                // Setup media recorder
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = async () => {
                        const duration = Date.now() - recordingStartTime;
                        await addEntry({
                            type: 'audio',
                            data: reader.result,
                            duration: duration,
                            transcription: ''
                        });
                        loadEntries();
                    };
                    reader.readAsDataURL(audioBlob);

                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();

                // Update UI
                document.getElementById('startAudioRecording').innerHTML = '&#9209; Stop Recording';
                document.getElementById('startAudioRecording').classList.add('btn-danger');
                document.getElementById('startAudioRecording').classList.remove('btn-primary');
                document.getElementById('audioWaveformContainer').classList.remove('hidden');
                document.getElementById('fab').classList.add('recording');
                updateStatus('Recording', 'recording');

                // Start visualization
                drawWaveform();
                updateRecordingTime();

                showToast('Recording started', 'success');
            } catch (error) {
                console.error('Audio recording error:', error);
                showToast('Microphone access denied', 'error');
            }
        }

        function stopAudioRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            isRecording = false;

            // Cleanup
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            // Update UI
            document.getElementById('startAudioRecording').innerHTML = '&#127908; Start Recording';
            document.getElementById('startAudioRecording').classList.remove('btn-danger');
            document.getElementById('startAudioRecording').classList.add('btn-primary');
            document.getElementById('audioWaveformContainer').classList.add('hidden');
            document.getElementById('fab').classList.remove('recording');
            updateStatus('Ready', 'idle');

            showToast('Recording saved', 'success');
        }

        function drawWaveform() {
            if (!isRecording || !analyser) return;

            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);

            function draw() {
                if (!isRecording) return;

                animationId = requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);

                ctx.fillStyle = 'rgba(22, 33, 62, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const barWidth = (canvas.width / 2 / bufferLength) * 2.5;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = (dataArray[i] / 255) * (canvas.height / 2 - 10);

                    const gradient = ctx.createLinearGradient(0, canvas.height / 4, 0, canvas.height / 4 - barHeight);
                    gradient.addColorStop(0, '#00d4ff');
                    gradient.addColorStop(1, '#0099cc');

                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, (canvas.height / 4) - barHeight / 2, barWidth, barHeight);

                    x += barWidth + 1;
                }
            }

            draw();
        }

        function updateRecordingTime() {
            if (!isRecording) return;

            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;

            document.getElementById('recordingTime').textContent =
                `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            setTimeout(updateRecordingTime, 1000);
        }

        // ============================================
        // Bookmarks
        // ============================================

        async function addQuickBookmark() {
            const text = document.getElementById('quickBookmarkText').value.trim();
            if (!text) {
                showToast('Please enter a bookmark note', 'error');
                return;
            }

            await addEntry({
                type: 'bookmark',
                notes: text,
                data: null
            });

            document.getElementById('quickBookmarkText').value = '';
            loadEntries();
        }

        function showBookmarkModal() {
            showModal('bookmarkModal');
            document.getElementById('bookmarkNote').focus();
        }

        async function saveBookmark() {
            const note = document.getElementById('bookmarkNote').value.trim();
            const tagsInput = document.getElementById('bookmarkTags').value.trim();

            if (!note) {
                showToast('Please enter a note', 'error');
                return;
            }

            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            await addEntry({
                type: 'bookmark',
                notes: note,
                tags: tags,
                data: null
            });

            document.getElementById('bookmarkNote').value = '';
            document.getElementById('bookmarkTags').value = '';
            closeModal('bookmarkModal');
            loadEntries();
        }

        // ============================================
        // Collections
        // ============================================

        async function createCollection() {
            const name = document.getElementById('collectionName').value.trim();
            const icon = document.getElementById('collectionIcon').value || '';

            if (!name) {
                showToast('Please enter a collection name', 'error');
                return;
            }

            const collection = {
                id: generateId(),
                name: name,
                icon: icon,
                createdAt: Date.now()
            };

            await dbAdd(COLLECTIONS_STORE, collection);
            document.getElementById('collectionName').value = '';
            closeModal('newCollectionModal');
            loadCollections();
            showToast('Collection created', 'success');
        }

        async function loadCollections() {
            const collections = await dbGetAll(COLLECTIONS_STORE);
            const container = document.getElementById('collectionsContainer');
            const emptyState = document.getElementById('collectionsEmptyState');

            if (collections.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Get entry counts per collection
            const entries = await dbGetAll(STORE_NAME);
            const countMap = {};
            entries.forEach(e => {
                if (e.collectionId) {
                    countMap[e.collectionId] = (countMap[e.collectionId] || 0) + 1;
                }
            });

            container.innerHTML = collections.map(col => `
                <div class="collection-card" onclick="filterByCollection('${col.id}')">
                    <div class="collection-icon">${col.icon}</div>
                    <div class="collection-name">${escapeHtml(col.name)}</div>
                    <div class="collection-count">${countMap[col.id] || 0} memories</div>
                </div>
            `).join('');
        }

        function filterByCollection(collectionId) {
            switchTab('timeline');
            // TODO: Add collection filter
            showToast('Filtering by collection', 'info');
        }

        // ============================================
        // UI Rendering
        // ============================================

        async function loadEntries() {
            const search = document.getElementById('searchInput').value;
            const dateFilter = document.getElementById('dateFilter').value;

            const result = await getEntries({
                filter: currentFilter,
                search: search,
                page: currentPage,
                dateFilter: dateFilter
            });

            const container = document.getElementById('entriesContainer');
            const emptyState = document.getElementById('emptyState');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            const countElement = document.getElementById('entriesCount');

            countElement.textContent = `${result.total} ${result.total === 1 ? 'Memory' : 'Memories'}`;

            if (result.total === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                loadMoreContainer.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            loadMoreContainer.classList.toggle('hidden', !result.hasMore);

            container.className = currentView === 'grid' ? 'entries-grid' : 'entries-list';

            container.innerHTML = result.entries.map(entry => renderEntryCard(entry)).join('');
        }

        function renderEntryCard(entry) {
            const time = formatTime(entry.timestamp);
            const typeLabel = entry.type === 'screen' ? 'Screenshot' :
                             entry.type === 'audio' ? 'Audio' : 'Bookmark';

            let thumbnailContent = '';
            if (entry.type === 'screen' && entry.data) {
                thumbnailContent = `<img src="${entry.data}" alt="Screenshot" loading="lazy">`;
            } else if (entry.type === 'audio') {
                thumbnailContent = '<div class="audio-icon">&#127911;</div>';
            } else {
                thumbnailContent = '<div class="audio-icon">&#11088;</div>';
            }

            const tagsHtml = (entry.tags || []).slice(0, 3).map(tag =>
                `<span class="tag">${escapeHtml(tag)}</span>`
            ).join('');

            return `
                <div class="entry-card" onclick="openEntryModal('${entry.id}')">
                    <div class="entry-thumbnail ${entry.type === 'audio' || entry.type === 'bookmark' ? 'audio' : ''}">
                        ${thumbnailContent}
                        <span class="entry-type-badge ${entry.type}">${typeLabel}</span>
                        ${entry.starred ? '<span class="entry-starred">&#9733;</span>' : ''}
                    </div>
                    <div class="entry-content">
                        <div class="entry-time">${time}</div>
                        ${entry.notes ? `<div class="entry-notes">${escapeHtml(entry.notes)}</div>` : ''}
                        ${tagsHtml ? `<div class="entry-tags">${tagsHtml}</div>` : ''}
                    </div>
                </div>
            `;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;

            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // Entry Modal
        // ============================================

        async function openEntryModal(id) {
            const entry = await dbGet(STORE_NAME, id);
            if (!entry) return;

            currentEntryId = id;

            const modalTitle = document.getElementById('entryModalTitle');
            const modalContent = document.getElementById('entryModalContent');

            const typeLabel = entry.type === 'screen' ? 'Screenshot' :
                             entry.type === 'audio' ? 'Audio Recording' : 'Bookmark';

            modalTitle.textContent = typeLabel + ' - ' + new Date(entry.timestamp).toLocaleString();

            let contentHtml = '';

            // Preview
            if (entry.type === 'screen' && entry.data) {
                contentHtml += `<img src="${entry.data}" class="preview-image" alt="Screenshot">`;
            } else if (entry.type === 'audio' && entry.data) {
                contentHtml += `
                    <div class="audio-player">
                        <button onclick="toggleAudioPlayback(this)" data-audio="${entry.data}">&#9654;</button>
                        <div class="audio-progress" onclick="seekAudio(event)">
                            <div class="audio-progress-fill" id="audioProgress"></div>
                        </div>
                        <span id="audioTime">${formatDuration(entry.duration || 0)}</span>
                    </div>
                    <audio id="modalAudio" src="${entry.data}"></audio>
                `;
            }

            // Notes/Transcription
            contentHtml += `
                <div class="form-group">
                    <label class="form-label">${entry.type === 'audio' ? 'Transcription / Notes' : 'Notes'}</label>
                    <textarea class="form-textarea" id="entryNotes" placeholder="Add notes...">${entry.notes || ''}</textarea>
                </div>
            `;

            // Tags
            contentHtml += `
                <div class="form-group">
                    <label class="form-label">Tags (comma separated)</label>
                    <input type="text" class="form-input" id="entryTags" value="${(entry.tags || []).join(', ')}" placeholder="work, important, project">
                </div>
            `;

            // Star toggle
            contentHtml += `
                <div class="settings-row" style="margin-top: 16px;">
                    <div class="settings-info">
                        <h4>&#9733; Star this memory</h4>
                        <p>Starred memories are easy to find</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="entryStar" ${entry.starred ? 'checked' : ''}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `;

            modalContent.innerHTML = contentHtml;
            showModal('entryModal');
        }

        async function saveEntryChanges() {
            if (!currentEntryId) return;

            const notes = document.getElementById('entryNotes').value;
            const tagsInput = document.getElementById('entryTags').value;
            const starred = document.getElementById('entryStar').checked;

            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            await updateEntry(currentEntryId, { notes, tags, starred });
            closeModal('entryModal');
            loadEntries();
            updateStats();
            showToast('Changes saved', 'success');
        }

        let currentAudio = null;

        function toggleAudioPlayback(button) {
            const audio = document.getElementById('modalAudio');

            if (audio.paused) {
                audio.play();
                button.innerHTML = '&#10074;&#10074;';
                currentAudio = audio;

                audio.ontimeupdate = () => {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    document.getElementById('audioProgress').style.width = progress + '%';
                };

                audio.onended = () => {
                    button.innerHTML = '&#9654;';
                };
            } else {
                audio.pause();
                button.innerHTML = '&#9654;';
            }
        }

        // ============================================
        // Statistics
        // ============================================

        async function updateStats() {
            const entries = await dbGetAll(STORE_NAME);
            const now = Date.now();
            const dayMs = 24 * 60 * 60 * 1000;
            const weekMs = 7 * dayMs;

            const todayStart = new Date().setHours(0, 0, 0, 0);
            const weekStart = now - weekMs;

            const today = entries.filter(e => e.timestamp >= todayStart).length;
            const week = entries.filter(e => e.timestamp >= weekStart).length;
            const screenshots = entries.filter(e => e.type === 'screen').length;
            const audio = entries.filter(e => e.type === 'audio').length;
            const bookmarks = entries.filter(e => e.type === 'bookmark').length;

            document.getElementById('statTotalCaptures').textContent = entries.length;
            document.getElementById('statTodayCaptures').textContent = today;
            document.getElementById('statWeekCaptures').textContent = week;
            document.getElementById('statScreenshots').textContent = screenshots;
            document.getElementById('statAudioRecordings').textContent = audio;
            document.getElementById('statBookmarks').textContent = bookmarks;

            // Activity chart (last 7 days)
            const chartData = [];
            const labels = [];

            for (let i = 6; i >= 0; i--) {
                const dayStart = new Date();
                dayStart.setDate(dayStart.getDate() - i);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(dayStart);
                dayEnd.setHours(23, 59, 59, 999);

                const count = entries.filter(e =>
                    e.timestamp >= dayStart.getTime() && e.timestamp <= dayEnd.getTime()
                ).length;

                chartData.push(count);
                labels.push(dayStart.toLocaleDateString('en-US', { weekday: 'short' }));
            }

            const maxCount = Math.max(...chartData, 1);

            document.getElementById('activityChart').innerHTML = chartData.map(count =>
                `<div class="chart-bar" style="height: ${(count / maxCount) * 100}%;" title="${count} captures"></div>`
            ).join('');

            document.getElementById('chartLabels').innerHTML = labels.map(l =>
                `<span>${l}</span>`
            ).join('');

            // Storage estimate
            await updateStorageStats(entries);

            // Tag cloud
            updateTagCloud(entries);
        }

        async function updateStorageStats(entries) {
            let screenshotSize = 0;
            let audioSize = 0;
            let bookmarkSize = 0;

            entries.forEach(e => {
                const size = e.data ? e.data.length * 0.75 : 0; // Base64 to bytes estimate
                if (e.type === 'screen') screenshotSize += size;
                else if (e.type === 'audio') audioSize += size;
                else bookmarkSize += JSON.stringify(e).length;
            });

            const totalSize = screenshotSize + audioSize + bookmarkSize;
            const totalMB = (totalSize / (1024 * 1024)).toFixed(2);
            const maxMB = 50;

            document.getElementById('storageUsed').textContent = `${totalMB} MB used`;
            document.getElementById('storageFill').style.width = `${Math.min((totalSize / (maxMB * 1024 * 1024)) * 100, 100)}%`;

            document.getElementById('storageScreenshots').textContent =
                `Screenshots: ${(screenshotSize / (1024 * 1024)).toFixed(2)} MB`;
            document.getElementById('storageAudio').textContent =
                `Audio: ${(audioSize / (1024 * 1024)).toFixed(2)} MB`;
            document.getElementById('storageBookmarks').textContent =
                `Bookmarks: ${(bookmarkSize / 1024).toFixed(2)} KB`;
        }

        function updateTagCloud(entries) {
            const tagCounts = {};
            entries.forEach(e => {
                (e.tags || []).forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });

            const sortedTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);

            if (sortedTags.length === 0) {
                document.getElementById('tagCloud').innerHTML =
                    '<span style="color: var(--text-muted);">No tags yet. Add tags to your memories to see them here.</span>';
                return;
            }

            const maxCount = Math.max(...sortedTags.map(t => t[1]));

            document.getElementById('tagCloud').innerHTML = sortedTags.map(([tag, count]) => {
                const size = Math.ceil((count / maxCount) * 5);
                return `<span class="tag size-${size}" onclick="searchByTag('${escapeHtml(tag)}')">${escapeHtml(tag)} (${count})</span>`;
            }).join('');
        }

        function searchByTag(tag) {
            switchTab('timeline');
            document.getElementById('searchInput').value = tag;
            debouncedSearch();
        }

        // ============================================
        // Import/Export
        // ============================================

        async function exportAllData() {
            showToast('Preparing export...', 'info');

            const entries = await dbGetAll(STORE_NAME);
            const collections = await dbGetAll(COLLECTIONS_STORE);
            const settings = await dbGetAll(SETTINGS_STORE);

            const exportData = {
                version: 1,
                exportedAt: new Date().toISOString(),
                appName: APP_NAME,
                data: {
                    entries,
                    collections,
                    settings
                }
            };

            const jsonStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `memory-vault-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            URL.revokeObjectURL(url);
            showToast(`Exported ${entries.length} memories`, 'success');
        }

        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importData = JSON.parse(e.target.result);

                    if (!importData.data || !importData.data.entries) {
                        throw new Error('Invalid file format');
                    }

                    const confirmImport = confirm(
                        `Import ${importData.data.entries.length} memories?\n\n` +
                        `This will add to your existing data. Exported on: ${importData.exportedAt}`
                    );

                    if (!confirmImport) return;

                    // Import entries
                    for (const entry of importData.data.entries) {
                        try {
                            await dbPut(STORE_NAME, entry);
                        } catch (err) {
                            console.warn('Skipped duplicate entry:', entry.id);
                        }
                    }

                    // Import collections
                    if (importData.data.collections) {
                        for (const collection of importData.data.collections) {
                            try {
                                await dbPut(COLLECTIONS_STORE, collection);
                            } catch (err) {
                                console.warn('Skipped duplicate collection:', collection.id);
                            }
                        }
                    }

                    loadEntries();
                    loadCollections();
                    updateStats();
                    showToast(`Imported ${importData.data.entries.length} memories`, 'success');
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Invalid import file', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        async function exportEntry(id) {
            const entry = await dbGet(STORE_NAME, id);
            if (!entry) return;

            const exportData = {
                version: 1,
                exportedAt: new Date().toISOString(),
                appName: APP_NAME,
                entry: entry
            };

            const jsonStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `memory-${id}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            URL.revokeObjectURL(url);
            showToast('Entry exported', 'success');
        }

        // ============================================
        // Settings & Security
        // ============================================

        async function getSetting(key) {
            const setting = await dbGet(SETTINGS_STORE, key);
            return setting ? setting.value : null;
        }

        async function setSetting(key, value) {
            await dbPut(SETTINGS_STORE, { key, value });
        }

        async function checkPasswordProtection() {
            const hasPassword = await getSetting('password');
            const isLocked = await getSetting('isLocked');

            document.getElementById('passwordToggle').checked = !!hasPassword;

            if (hasPassword && isLocked !== false) {
                document.getElementById('passwordOverlay').classList.remove('hidden');
                document.getElementById('passwordInput').focus();
            }
        }

        async function togglePasswordProtection() {
            const toggle = document.getElementById('passwordToggle');
            const passwordSetup = document.getElementById('passwordSetup');

            if (toggle.checked) {
                passwordSetup.classList.remove('hidden');
            } else {
                passwordSetup.classList.add('hidden');
                await setSetting('password', null);
                showToast('Password protection disabled', 'info');
            }
        }

        async function setPassword() {
            const password = document.getElementById('newPassword').value;
            if (!password || password.length < 4) {
                showToast('Password must be at least 4 characters', 'error');
                return;
            }

            // Simple hash (not cryptographically secure, but better than plaintext)
            const hash = btoa(password);
            await setSetting('password', hash);
            await setSetting('isLocked', true);

            document.getElementById('newPassword').value = '';
            document.getElementById('passwordSetup').classList.add('hidden');
            showToast('Password set successfully', 'success');
        }

        async function unlockVault() {
            const input = document.getElementById('passwordInput');
            const password = input.value;
            const storedHash = await getSetting('password');

            if (btoa(password) === storedHash) {
                await setSetting('isLocked', false);
                document.getElementById('passwordOverlay').classList.add('hidden');
                input.value = '';
                showToast('Welcome back!', 'success');
            } else {
                input.value = '';
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 500);
                showToast('Incorrect password', 'error');
            }
        }

        async function toggleAutoCleanup() {
            const toggle = document.getElementById('autoCleanupToggle');
            await setSetting('autoCleanup', toggle.checked);
            showToast(toggle.checked ? 'Auto-cleanup enabled' : 'Auto-cleanup disabled', 'info');
        }

        async function confirmClearAll() {
            const confirm1 = confirm('Are you sure you want to delete ALL memories? This cannot be undone.');
            if (!confirm1) return;

            const confirm2 = prompt('Type "DELETE" to confirm:');
            if (confirm2 !== 'DELETE') {
                showToast('Deletion cancelled', 'info');
                return;
            }

            await dbClear(STORE_NAME);
            await dbClear(COLLECTIONS_STORE);

            loadEntries();
            loadCollections();
            updateStats();
            showToast('All data cleared', 'info');
        }

        // ============================================
        // UI Utilities
        // ============================================

        function switchTab(tabName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName + 'Tab').classList.remove('hidden');

            // Load tab-specific data
            if (tabName === 'timeline') loadEntries();
            if (tabName === 'collections') loadCollections();
            if (tabName === 'stats') updateStats();
            if (tabName === 'capture') loadRecentCaptures();
        }

        async function loadRecentCaptures() {
            const result = await getEntries({ limit: 6 });
            const container = document.getElementById('recentCaptures');

            if (result.entries.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">No recent captures</p>';
                return;
            }

            container.innerHTML = result.entries.map(entry => renderEntryCard(entry)).join('');
        }

        function setView(view) {
            currentView = view;
            document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            loadEntries();
        }

        function setFilter(filter) {
            currentFilter = filter;
            currentPage = 0;

            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.filter === filter);
            });

            loadEntries();
        }

        function applyFilters() {
            currentPage = 0;
            loadEntries();
        }

        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 0;
                loadEntries();
            }, 300);
        }

        function loadMoreEntries() {
            currentPage++;
            loadEntries();
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');

            // Stop audio if playing
            const audio = document.getElementById('modalAudio');
            if (audio) audio.pause();
        }

        function toggleQuickActions() {
            const quickActions = document.getElementById('quickActions');
            const fab = document.getElementById('fab');

            quickActions.classList.toggle('active');
            fab.innerHTML = quickActions.classList.contains('active') ? '&times;' : '+';
        }

        function updateStatus(text, state) {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            dot.className = 'status-dot';
            if (state === 'recording') dot.classList.add('recording');
            else if (state === 'active') dot.classList.add('active');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============================================
        // Keyboard Shortcuts
        // ============================================

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in input
                if (e.target.matches('input, textarea, select')) {
                    if (e.key === 'Escape') {
                        e.target.blur();
                    }
                    return;
                }

                // Check for modal
                const activeModal = document.querySelector('.modal-overlay.active');
                if (activeModal) {
                    if (e.key === 'Escape') {
                        activeModal.classList.remove('active');
                    }
                    return;
                }

                switch (e.key.toLowerCase()) {
                    case 'b':
                        showBookmarkModal();
                        break;
                    case 's':
                        if (!e.ctrlKey && !e.metaKey) {
                            captureScreenNow();
                        }
                        break;
                    case 'r':
                        toggleAudioRecording();
                        break;
                    case '/':
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                        break;
                    case '?':
                        showModal('shortcutsModal');
                        break;
                    case '1':
                        switchTab('timeline');
                        break;
                    case '2':
                        switchTab('capture');
                        break;
                    case '3':
                        switchTab('collections');
                        break;
                    case '4':
                        switchTab('stats');
                        break;
                    case 'escape':
                        const quickActions = document.getElementById('quickActions');
                        if (quickActions.classList.contains('active')) {
                            toggleQuickActions();
                        }
                        break;
                }
            });
        }

        // ============================================
        // Initialization
        // ============================================

        async function init() {
            try {
                await initDatabase();
                await checkPasswordProtection();
                await loadEntries();
                await loadCollections();
                await updateStats();
                setupKeyboardShortcuts();

                // Load settings
                const autoCleanup = await getSetting('autoCleanup');
                document.getElementById('autoCleanupToggle').checked = !!autoCleanup;

                console.log('Memory Vault initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Error initializing app', 'error');
            }
        }

        // Lock vault when closing/leaving page
        window.addEventListener('beforeunload', async () => {
            const hasPassword = await getSetting('password');
            if (hasPassword) {
                await setSetting('isLocked', true);
            }
        });

        // Start the app
        init();
    </script>
</body>
</html>
