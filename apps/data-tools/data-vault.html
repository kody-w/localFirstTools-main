<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Vault</title>
<meta name="rappterzoo:category" content="data_tools">
<meta name="rappterzoo:type" content="interface">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:author" content="RappterZoo">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:tags" content="files,storage,base64,vault">
<meta name="rappterzoo:generation" content="1">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0a0a0f; color: #e0e0e8; min-height: 100vh;
  display: flex; flex-direction: column;
}
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: #12121a; }
::-webkit-scrollbar-thumb { background: #2a2a3a; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

header {
  background: linear-gradient(135deg, #0f0f18 0%, #161625 100%);
  border-bottom: 1px solid #1e1e2e; padding: 16px 24px;
  display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
}
header h1 {
  font-size: 1.4rem; font-weight: 700; color: #f0f0ff;
  display: flex; align-items: center; gap: 8px;
}
header h1 .icon { font-size: 1.6rem; }
.storage-bar {
  flex: 1; min-width: 200px; max-width: 320px;
  background: #1a1a28; border-radius: 8px; height: 28px;
  position: relative; overflow: hidden; border: 1px solid #2a2a3a;
}
.storage-fill {
  height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa);
  border-radius: 8px; transition: width 0.4s ease;
}
.storage-label {
  position: absolute; inset: 0; display: flex; align-items: center;
  justify-content: center; font-size: 0.75rem; font-weight: 600; color: #c0c0d0;
}
.header-actions { display: flex; gap: 8px; margin-left: auto; }
.btn {
  padding: 7px 14px; border-radius: 6px; border: 1px solid #2a2a3a;
  background: #1a1a28; color: #c0c0d0; font-size: 0.82rem; cursor: pointer;
  transition: all 0.2s; display: flex; align-items: center; gap: 6px;
}
.btn:hover { background: #252538; border-color: #3b82f6; color: #f0f0ff; }
.btn.primary { background: #3b82f6; border-color: #3b82f6; color: #fff; }
.btn.primary:hover { background: #2563eb; }
.btn.danger:hover { border-color: #ef4444; color: #ef4444; }

.toolbar {
  background: #0e0e16; border-bottom: 1px solid #1a1a28; padding: 10px 24px;
  display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
}
.search-box {
  flex: 1; min-width: 180px; max-width: 360px; position: relative;
}
.search-box input {
  width: 100%; padding: 8px 12px 8px 34px; border-radius: 6px;
  border: 1px solid #2a2a3a; background: #12121a; color: #e0e0e8;
  font-size: 0.85rem; outline: none; transition: border 0.2s;
}
.search-box input:focus { border-color: #3b82f6; }
.search-box .search-icon {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  color: #555; font-size: 0.9rem;
}
.sort-group { display: flex; align-items: center; gap: 6px; }
.sort-group label { font-size: 0.78rem; color: #888; }
.sort-group select {
  padding: 6px 10px; border-radius: 6px; border: 1px solid #2a2a3a;
  background: #12121a; color: #c0c0d0; font-size: 0.82rem; outline: none;
}
.view-toggle { display: flex; gap: 0; }
.view-toggle button {
  padding: 6px 12px; border: 1px solid #2a2a3a; background: #12121a;
  color: #888; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
}
.view-toggle button:first-child { border-radius: 6px 0 0 6px; }
.view-toggle button:last-child { border-radius: 0 6px 6px 0; border-left: none; }
.view-toggle button.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }

.main { display: flex; flex: 1; overflow: hidden; }

.file-area {
  flex: 1; padding: 20px; overflow-y: auto; position: relative;
}

.drop-zone {
  border: 2px dashed #2a2a3a; border-radius: 12px; padding: 48px 24px;
  text-align: center; transition: all 0.3s; margin-bottom: 20px; cursor: pointer;
}
.drop-zone.dragover {
  border-color: #3b82f6; background: rgba(59,130,246,0.08);
  box-shadow: 0 0 30px rgba(59,130,246,0.15);
}
.drop-zone .drop-icon { font-size: 2.5rem; margin-bottom: 10px; }
.drop-zone p { color: #888; font-size: 0.9rem; }
.drop-zone .hint { color: #555; font-size: 0.78rem; margin-top: 6px; }

.file-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 14px;
}
.file-grid.list-view {
  grid-template-columns: 1fr; gap: 4px;
}

.file-card {
  background: linear-gradient(145deg, #12121c, #161625);
  border: 1px solid #1e1e2e; border-radius: 10px; padding: 16px;
  cursor: pointer; transition: all 0.25s; position: relative;
}
.file-card:hover {
  border-color: #3b82f6; transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(59,130,246,0.12);
}
.file-card.selected { border-color: #3b82f6; background: rgba(59,130,246,0.06); }
.file-card .file-icon { font-size: 2rem; margin-bottom: 8px; }
.file-card .file-name {
  font-size: 0.85rem; font-weight: 600; color: #e0e0f0;
  word-break: break-all; margin-bottom: 4px;
}
.file-card .file-meta {
  font-size: 0.72rem; color: #666; display: flex; justify-content: space-between;
}
.file-card .file-name-input {
  background: #0a0a0f; border: 1px solid #3b82f6; border-radius: 4px;
  color: #e0e0f0; font-size: 0.85rem; padding: 2px 6px; width: 100%;
  outline: none;
}

.list-view .file-card {
  display: flex; align-items: center; gap: 14px; padding: 10px 16px;
  border-radius: 6px;
}
.list-view .file-card .file-icon { font-size: 1.3rem; margin-bottom: 0; min-width: 32px; text-align: center; }
.list-view .file-card .file-name { margin-bottom: 0; flex: 1; }
.list-view .file-card .file-meta { flex-shrink: 0; gap: 16px; min-width: 180px; }

.preview-panel {
  width: 360px; background: #0e0e16; border-left: 1px solid #1a1a28;
  padding: 20px; overflow-y: auto; display: none; flex-direction: column; gap: 14px;
}
.preview-panel.open { display: flex; }
.preview-panel h3 {
  font-size: 0.95rem; color: #e0e0f0; word-break: break-all;
  border-bottom: 1px solid #1e1e2e; padding-bottom: 10px;
}
.preview-meta { font-size: 0.78rem; color: #888; line-height: 1.8; }
.preview-meta strong { color: #aaa; }
.preview-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.preview-content {
  flex: 1; background: #0a0a12; border: 1px solid #1a1a28; border-radius: 8px;
  padding: 12px; overflow: auto; font-size: 0.8rem; min-height: 120px;
}
.preview-content img { max-width: 100%; border-radius: 6px; }
.preview-content pre {
  white-space: pre-wrap; word-break: break-all; color: #a0a0b0;
  font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.78rem; line-height: 1.5;
}

.empty-state {
  text-align: center; padding: 60px 20px; color: #555;
}
.empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; }

.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  display: flex; align-items: center; justify-content: center;
  z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.modal-overlay.active { opacity: 1; pointer-events: all; }
.modal {
  background: #161625; border: 1px solid #2a2a3a; border-radius: 12px;
  padding: 24px; max-width: 480px; width: 90%; max-height: 80vh; overflow-y: auto;
}
.modal h3 { margin-bottom: 14px; font-size: 1.1rem; color: #f0f0ff; }
.modal textarea {
  width: 100%; height: 200px; background: #0a0a12; border: 1px solid #2a2a3a;
  border-radius: 8px; color: #c0c0d0; font-family: monospace; font-size: 0.8rem;
  padding: 10px; outline: none; resize: vertical;
}
.modal textarea:focus { border-color: #3b82f6; }
.modal .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 14px; }

.toast {
  position: fixed; bottom: 24px; right: 24px; background: #1e1e2e;
  border: 1px solid #3b82f6; border-radius: 8px; padding: 12px 20px;
  color: #e0e0f0; font-size: 0.85rem; z-index: 2000;
  transform: translateY(80px); opacity: 0; transition: all 0.3s;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.error { border-color: #ef4444; }

@media (max-width: 768px) {
  .preview-panel { width: 100%; position: fixed; inset: 0; z-index: 500; }
  .file-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
  header { padding: 12px 16px; }
  .file-area { padding: 14px; }
  .storage-bar { max-width: 100%; }
}
</style>
</head>
<body>

<header>
  <h1><span class="icon">üîê</span> Data Vault</h1>
  <div class="storage-bar">
    <div class="storage-fill" id="storageFill" style="width:0%"></div>
    <div class="storage-label" id="storageLabel">0 KB / 5 MB</div>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="exportVault()" title="Export vault as JSON">üì§ Export</button>
    <button class="btn" onclick="showImportModal()" title="Import vault from JSON">üì• Import</button>
  </div>
</header>

<div class="toolbar">
  <div class="search-box">
    <span class="search-icon">üîç</span>
    <input type="text" id="searchInput" placeholder="Search files..." oninput="renderFiles()">
  </div>
  <div class="sort-group">
    <label>Sort:</label>
    <select id="sortSelect" onchange="renderFiles()">
      <option value="date-desc">Newest</option>
      <option value="date-asc">Oldest</option>
      <option value="name-asc">Name A-Z</option>
      <option value="name-desc">Name Z-A</option>
      <option value="size-desc">Largest</option>
      <option value="size-asc">Smallest</option>
      <option value="type-asc">Type</option>
    </select>
  </div>
  <div class="view-toggle">
    <button id="gridBtn" class="active" onclick="setView('grid')" title="Grid view">‚äû</button>
    <button id="listBtn" onclick="setView('list')" title="List view">‚ò∞</button>
  </div>
  <span style="font-size:0.78rem;color:#555" id="fileCount">0 files</span>
</div>

<div class="main">
  <div class="file-area">
    <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
      <div class="drop-icon">üìÅ</div>
      <p>Drop files here or click to upload</p>
      <p class="hint">Files are stored as base64 in localStorage</p>
    </div>
    <input type="file" id="fileInput" multiple hidden>
    <div class="file-grid" id="fileGrid"></div>
    <div class="empty-state" id="emptyState" style="display:none">
      <div class="empty-icon">üìÇ</div>
      <p>No files in vault</p>
    </div>
  </div>

  <div class="preview-panel" id="previewPanel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="previewTitle">File Preview</h3>
      <button class="btn" onclick="closePreview()" style="padding:4px 10px">‚úï</button>
    </div>
    <div class="preview-meta" id="previewMeta"></div>
    <div class="preview-actions" id="previewActions"></div>
    <div class="preview-content" id="previewContent"></div>
  </div>
</div>

<div class="modal-overlay" id="importModal">
  <div class="modal">
    <h3>üì• Import Vault</h3>
    <p style="font-size:0.85rem;color:#888;margin-bottom:10px">Paste exported JSON or select a file:</p>
    <input type="file" id="importFileInput" accept=".json" style="margin-bottom:10px;color:#888;font-size:0.82rem">
    <textarea id="importTextarea" placeholder='Paste vault JSON here...'></textarea>
    <div class="modal-actions">
      <button class="btn" onclick="closeImportModal()">Cancel</button>
      <button class="btn primary" onclick="importVault()">Import</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3 id="confirmTitle">Confirm</h3>
    <p id="confirmMsg" style="color:#aaa;font-size:0.9rem;margin-bottom:16px"></p>
    <div class="modal-actions">
      <button class="btn" onclick="closeConfirm()">Cancel</button>
      <button class="btn danger" id="confirmBtn" onclick="confirmAction()">Delete</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const VAULT_KEY = 'data-vault-files';
const MAX_STORAGE = 5 * 1024 * 1024; // 5MB approximate localStorage limit
let vaultFiles = [];
let currentView = 'grid';
let selectedFileId = null;
let pendingConfirmAction = null;

function init() {
  loadVault();
  setupDragDrop();
  setupFileInput();
  updateStorageBar();
  renderFiles();
}

function loadVault() {
  try {
    const raw = localStorage.getItem(VAULT_KEY);
    vaultFiles = raw ? JSON.parse(raw) : [];
  } catch (e) {
    vaultFiles = [];
  }
}

function saveVault() {
  try {
    localStorage.setItem(VAULT_KEY, JSON.stringify(vaultFiles));
    updateStorageBar();
  } catch (e) {
    showToast('Storage full! Remove some files.', true);
  }
}

function updateStorageBar() {
  let used = 0;
  try {
    for (let k in localStorage) {
      if (localStorage.hasOwnProperty(k)) {
        used += localStorage.getItem(k).length * 2;
      }
    }
  } catch (e) {}
  const pct = Math.min(100, (used / MAX_STORAGE) * 100);
  document.getElementById('storageFill').style.width = pct.toFixed(1) + '%';
  document.getElementById('storageLabel').textContent =
    formatSize(used) + ' / ' + formatSize(MAX_STORAGE);
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
}

/* File type detection and icons */
function getFileCategory(name, type) {
  const ext = name.split('.').pop().toLowerCase();
  if (type.startsWith('image/') || ['png','jpg','jpeg','gif','svg','webp','bmp','ico'].includes(ext)) return 'image';
  if (type === 'application/json' || ext === 'json') return 'json';
  if (ext === 'csv') return 'csv';
  if (type === 'application/pdf' || ext === 'pdf') return 'pdf';
  if (type.startsWith('text/') || ['txt','md','html','css','js','ts','py','xml','yaml','yml','toml','sh','bat','log','ini','cfg'].includes(ext)) return 'text';
  return 'other';
}

function getFileIcon(category) {
  const icons = { image: 'üñºÔ∏è', text: 'üìÑ', json: 'üìã', csv: 'üìä', pdf: 'üìï', other: 'üì¶' };
  return icons[category] || 'üì¶';
}

/* Drag and drop handling */
function setupDragDrop() {
  const zone = document.getElementById('dropZone');
  ['dragenter', 'dragover'].forEach(evt => {
    zone.addEventListener(evt, e => { e.preventDefault(); zone.classList.add('dragover'); });
  });
  ['dragleave', 'drop'].forEach(evt => {
    zone.addEventListener(evt, e => { e.preventDefault(); zone.classList.remove('dragover'); });
  });
  zone.addEventListener('drop', e => {
    const files = e.dataTransfer.files;
    if (files.length) handleFiles(files);
  });
  // Allow dropping anywhere on the file area
  const area = document.querySelector('.file-area');
  area.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
  area.addEventListener('dragleave', e => { zone.classList.remove('dragover'); });
  area.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover');
    if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
  });
}

function setupFileInput() {
  document.getElementById('fileInput').addEventListener('change', e => {
    if (e.target.files.length) handleFiles(e.target.files);
    e.target.value = '';
  });
  document.getElementById('importFileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => { document.getElementById('importTextarea').value = ev.target.result; };
    reader.readAsText(file);
  });
}

/* Read files using FileReader.readAsDataURL to encode as base64 data URI */
function handleFiles(fileList) {
  let count = 0;
  const total = fileList.length;
  Array.from(fileList).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      // The result is a base64-encoded data URI string
      const dataUrl = e.target.result;
      const entry = {
        id: generateId(),
        name: file.name,
        type: file.type || 'application/octet-stream',
        size: file.size,
        date: new Date().toISOString(),
        data: dataUrl  // base64 data URI from readAsDataURL
      };
      vaultFiles.push(entry);
      count++;
      if (count === total) {
        saveVault();
        renderFiles();
        showToast(`${total} file${total > 1 ? 's' : ''} added to vault`);
      }
    };
    reader.readAsDataURL(file);
  });
}

/* Render file listing */
function renderFiles() {
  const query = document.getElementById('searchInput').value.toLowerCase().trim();
  const sortVal = document.getElementById('sortSelect').value;
  let files = vaultFiles.filter(f => !query || f.name.toLowerCase().includes(query));

  const [sortKey, sortDir] = sortVal.split('-');
  files.sort((a, b) => {
    let cmp = 0;
    if (sortKey === 'name') cmp = a.name.localeCompare(b.name);
    else if (sortKey === 'date') cmp = new Date(a.date) - new Date(b.date);
    else if (sortKey === 'size') cmp = a.size - b.size;
    else if (sortKey === 'type') cmp = getFileCategory(a.name, a.type).localeCompare(getFileCategory(b.name, b.type));
    return sortDir === 'desc' ? -cmp : cmp;
  });

  const grid = document.getElementById('fileGrid');
  const empty = document.getElementById('emptyState');
  document.getElementById('fileCount').textContent = files.length + ' file' + (files.length !== 1 ? 's' : '');

  if (files.length === 0 && vaultFiles.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = files.length === 0 ? 'block' : 'none';

  grid.innerHTML = files.map(f => {
    const cat = getFileCategory(f.name, f.type);
    const icon = getFileIcon(cat);
    const sel = f.id === selectedFileId ? ' selected' : '';
    const dateStr = new Date(f.date).toLocaleDateString();
    return `<div class="file-card${sel}" data-id="${f.id}" onclick="selectFile('${f.id}')" ondblclick="openPreview('${f.id}')">
      <div class="file-icon">${icon}</div>
      <div class="file-name" id="fname-${f.id}" ondblclick="event.stopPropagation();startRename('${f.id}')">${escHtml(f.name)}</div>
      <div class="file-meta"><span>${formatSize(f.size)}</span><span>${dateStr}</span></div>
    </div>`;
  }).join('');
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

/* View toggle */
function setView(mode) {
  currentView = mode;
  const grid = document.getElementById('fileGrid');
  grid.classList.toggle('list-view', mode === 'list');
  document.getElementById('gridBtn').classList.toggle('active', mode === 'grid');
  document.getElementById('listBtn').classList.toggle('active', mode === 'list');
}

/* File selection and preview */
function selectFile(id) {
  selectedFileId = id;
  renderFiles();
  openPreview(id);
}

function openPreview(id) {
  const file = vaultFiles.find(f => f.id === id);
  if (!file) return;
  selectedFileId = id;
  const panel = document.getElementById('previewPanel');
  panel.classList.add('open');

  document.getElementById('previewTitle').textContent = file.name;
  document.getElementById('previewMeta').innerHTML =
    `<strong>Type:</strong> ${escHtml(file.type)}<br>` +
    `<strong>Size:</strong> ${formatSize(file.size)}<br>` +
    `<strong>Added:</strong> ${new Date(file.date).toLocaleString()}<br>` +
    `<strong>Category:</strong> ${getFileCategory(file.name, file.type)}`;

  document.getElementById('previewActions').innerHTML =
    `<button class="btn" onclick="downloadFile('${id}')">üíæ Download</button>` +
    `<button class="btn" onclick="startRename('${id}')">‚úèÔ∏è Rename</button>` +
    `<button class="btn danger" onclick="confirmDelete('${id}')">üóëÔ∏è Delete</button>`;

  renderPreviewContent(file);
  renderFiles();
}

function renderPreviewContent(file) {
  const container = document.getElementById('previewContent');
  const cat = getFileCategory(file.name, file.type);

  if (cat === 'image') {
    container.innerHTML = `<img src="${file.data}" alt="${escHtml(file.name)}">`;
    return;
  }

  // For text-based formats, decode the base64 data URI to display content
  if (cat === 'text' || cat === 'json' || cat === 'csv') {
    try {
      const b64 = file.data.split(',')[1];
      const text = atob(b64);
      if (cat === 'json') {
        try {
          const parsed = JSON.parse(text);
          container.innerHTML = `<pre>${escHtml(JSON.stringify(parsed, null, 2))}</pre>`;
        } catch (e) {
          container.innerHTML = `<pre>${escHtml(text)}</pre>`;
        }
      } else if (cat === 'csv') {
        const rows = text.split('\n').slice(0, 50);
        let table = '<table style="border-collapse:collapse;width:100%;font-size:0.75rem">';
        rows.forEach((row, i) => {
          const cells = row.split(',');
          const tag = i === 0 ? 'th' : 'td';
          table += '<tr>' + cells.map(c =>
            `<${tag} style="border:1px solid #2a2a3a;padding:4px 8px;color:#b0b0c0;text-align:left">${escHtml(c.trim())}</${tag}>`
          ).join('') + '</tr>';
        });
        table += '</table>';
        if (rows.length >= 50) table += '<p style="color:#666;margin-top:8px;font-size:0.75rem">Showing first 50 rows...</p>';
        container.innerHTML = table;
      } else {
        container.innerHTML = `<pre>${escHtml(text.substring(0, 10000))}${text.length > 10000 ? '\n...(truncated)' : ''}</pre>`;
      }
    } catch (e) {
      container.innerHTML = '<pre style="color:#ef4444">Could not decode file content</pre>';
    }
    return;
  }

  // Binary/PDF/other: show hex dump from base64 data
  try {
    const b64 = file.data.split(',')[1];
    const raw = atob(b64);
    const bytes = Math.min(raw.length, 256);
    let hex = '';
    for (let i = 0; i < bytes; i++) {
      if (i > 0 && i % 16 === 0) hex += '\n';
      else if (i > 0) hex += ' ';
      hex += raw.charCodeAt(i).toString(16).padStart(2, '0');
    }
    if (raw.length > 256) hex += '\n... (' + formatSize(raw.length) + ' total)';
    container.innerHTML = `<pre style="color:#60a5fa">${hex}</pre>`;
  } catch (e) {
    container.innerHTML = '<pre style="color:#666">No preview available</pre>';
  }
}

function closePreview() {
  document.getElementById('previewPanel').classList.remove('open');
  selectedFileId = null;
  renderFiles();
}

/* Download file from vault back to disk */
function downloadFile(id) {
  const file = vaultFiles.find(f => f.id === id);
  if (!file) return;
  const a = document.createElement('a');
  a.href = file.data;
  a.download = file.name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  showToast('Downloaded: ' + file.name);
}

/* Rename file inline */
function startRename(id) {
  const file = vaultFiles.find(f => f.id === id);
  if (!file) return;
  const el = document.getElementById('fname-' + id);
  if (!el) return;
  const input = document.createElement('input');
  input.className = 'file-name-input';
  input.value = file.name;
  input.onclick = e => e.stopPropagation();
  input.ondblclick = e => e.stopPropagation();
  input.onkeydown = e => {
    if (e.key === 'Enter') finishRename(id, input.value);
    if (e.key === 'Escape') renderFiles();
  };
  input.onblur = () => finishRename(id, input.value);
  el.innerHTML = '';
  el.appendChild(input);
  input.focus();
  input.select();
}

function finishRename(id, newName) {
  const file = vaultFiles.find(f => f.id === id);
  if (!file || !newName.trim()) { renderFiles(); return; }
  file.name = newName.trim();
  saveVault();
  renderFiles();
  if (selectedFileId === id) openPreview(id);
  showToast('Renamed to: ' + file.name);
}

/* Delete with confirmation */
function confirmDelete(id) {
  const file = vaultFiles.find(f => f.id === id);
  if (!file) return;
  document.getElementById('confirmTitle').textContent = 'Delete File';
  document.getElementById('confirmMsg').textContent = `Are you sure you want to delete "${file.name}"? This cannot be undone.`;
  document.getElementById('confirmBtn').textContent = 'Delete';
  document.getElementById('confirmModal').classList.add('active');
  pendingConfirmAction = () => {
    vaultFiles = vaultFiles.filter(f => f.id !== id);
    saveVault();
    if (selectedFileId === id) closePreview();
    renderFiles();
    showToast('Deleted: ' + file.name);
  };
}

function confirmAction() {
  if (pendingConfirmAction) pendingConfirmAction();
  closeConfirm();
}

function closeConfirm() {
  document.getElementById('confirmModal').classList.remove('active');
  pendingConfirmAction = null;
}

/* Export entire vault as JSON (import/export feature) */
function exportVault() {
  if (vaultFiles.length === 0) { showToast('Vault is empty', true); return; }
  const exportData = {
    version: 1,
    exported: new Date().toISOString(),
    source: 'data-vault',
    files: vaultFiles
  };
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'data-vault-export-' + new Date().toISOString().slice(0, 10) + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('Vault exported as JSON');
}

/* Import vault from JSON */
function showImportModal() {
  document.getElementById('importTextarea').value = '';
  document.getElementById('importModal').classList.add('active');
}

function closeImportModal() {
  document.getElementById('importModal').classList.remove('active');
}

function importVault() {
  const text = document.getElementById('importTextarea').value.trim();
  if (!text) { showToast('No data to import', true); return; }
  try {
    const data = JSON.parse(text);
    const files = data.files || data;
    if (!Array.isArray(files)) throw new Error('Invalid format');
    let imported = 0;
    files.forEach(f => {
      if (f.name && f.data) {
        if (!f.id) f.id = generateId();
        if (!f.date) f.date = new Date().toISOString();
        if (!f.type) f.type = 'application/octet-stream';
        if (!f.size) f.size = Math.round((f.data.length * 3) / 4);
        // Verify it contains base64 data
        if (!vaultFiles.find(v => v.name === f.name && v.size === f.size)) {
          vaultFiles.push(f);
          imported++;
        }
      }
    });
    saveVault();
    renderFiles();
    closeImportModal();
    showToast(`Imported ${imported} file${imported !== 1 ? 's' : ''}`);
  } catch (e) {
    showToast('Invalid JSON: ' + e.message, true);
  }
}

/* Toast notification */
function showToast(msg, isError) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast' + (isError ? ' error' : '');
  requestAnimationFrame(() => t.classList.add('show'));
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 2800);
}

/* Keyboard shortcuts */
document.addEventListener('keydown', e => {
  if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
  if (e.key === 'Escape') {
    closePreview();
    closeImportModal();
    closeConfirm();
  }
  if (e.key === 'Delete' && selectedFileId && document.activeElement.tagName !== 'INPUT') {
    confirmDelete(selectedFileId);
  }
});

/* Close modals on overlay click */
document.getElementById('importModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeImportModal();
});
document.getElementById('confirmModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeConfirm();
});

init();
</script>
</body>
</html>
