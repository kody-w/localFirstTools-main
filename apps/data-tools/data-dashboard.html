<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Dashboard</title>
<meta name="rappterzoo:category" content="data_tools">
<meta name="rappterzoo:type" content="interface">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:author" content="RappterZoo">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:tags" content="csv,data,charts,analytics,dashboard">
<meta name="rappterzoo:generation" content="1">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0a0a0f;--bg2:#12121a;--bg3:#1a1a26;--bg4:#22222f;--accent:#3b82f6;--accent2:#60a5fa;--text:#e2e8f0;--text2:#94a3b8;--border:#2a2a3a;--green:#22c55e;--red:#ef4444;--orange:#f59e0b;--purple:#a855f7}
html,body{height:100%;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}
::selection{background:var(--accent);color:#fff}
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--accent)}

.app{display:flex;flex-direction:column;height:100vh}
header{background:var(--bg2);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;gap:16px;flex-shrink:0}
header h1{font-size:1.3rem;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
header .subtitle{color:var(--text2);font-size:.8rem;margin-left:auto}

.toolbar{background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 24px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;flex-shrink:0}
.btn{background:var(--bg3);color:var(--text);border:1px solid var(--border);padding:7px 16px;border-radius:6px;cursor:pointer;font-size:.82rem;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{background:var(--bg4);border-color:var(--accent)}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.primary:hover{background:var(--accent2)}
.btn svg{width:14px;height:14px;fill:currentColor}
input[type="file"]{display:none}
select,.text-input{background:var(--bg3);color:var(--text);border:1px solid var(--border);padding:7px 12px;border-radius:6px;font-size:.82rem;outline:none;transition:border-color .15s}
select:focus,.text-input:focus{border-color:var(--accent)}
.text-input{min-width:220px}

.main{display:flex;flex:1;overflow:hidden}
.sidebar{width:280px;background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0;padding:16px}
.sidebar h3{font-size:.75rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text2);margin-bottom:10px}
.stat-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px}
.stat-card .label{font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.05em}
.stat-card .value{font-size:1.4rem;font-weight:700;color:var(--accent2);margin-top:2px}
.stat-card .sub{font-size:.72rem;color:var(--text2);margin-top:4px}
.col-stats{margin-top:14px}
.col-stat{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:10px;margin-bottom:6px}
.col-stat .col-name{font-size:.78rem;font-weight:600;color:var(--accent2);margin-bottom:4px}
.col-stat .metrics{display:grid;grid-template-columns:1fr 1fr;gap:3px}
.col-stat .metric{font-size:.68rem;color:var(--text2)}
.col-stat .metric span{color:var(--text);font-weight:600}

.content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0}
.tab{padding:10px 20px;cursor:pointer;font-size:.82rem;color:var(--text2);border-bottom:2px solid transparent;transition:all .15s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent2);border-bottom-color:var(--accent)}

.panel{flex:1;overflow:hidden;display:none}
.panel.active{display:flex;flex-direction:column}

/* Import panel */
.import-panel{padding:32px;display:flex;flex-direction:column;align-items:center;gap:20px;overflow-y:auto}
.drop-zone{width:100%;max-width:600px;border:2px dashed var(--border);border-radius:12px;padding:48px 24px;text-align:center;transition:all .2s;cursor:pointer}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--accent);background:rgba(59,130,246,.05)}
.drop-zone h2{font-size:1.1rem;margin-bottom:8px}
.drop-zone p{color:var(--text2);font-size:.85rem}
.paste-area{width:100%;max-width:600px}
.paste-area textarea{width:100%;height:160px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;color:var(--text);font-family:'Cascadia Code','Fira Code',monospace;font-size:.8rem;resize:vertical;outline:none}
.paste-area textarea:focus{border-color:var(--accent)}
.paste-actions{margin-top:8px;display:flex;gap:8px}
.sample-btn{margin-top:4px}

/* Table panel */
.table-container{flex:1;overflow:auto;padding:0}
table{width:100%;border-collapse:collapse;font-size:.8rem}
thead{position:sticky;top:0;z-index:2}
th{background:var(--bg3);color:var(--text2);font-weight:600;padding:10px 14px;text-align:left;cursor:pointer;user-select:none;border-bottom:2px solid var(--border);white-space:nowrap;transition:background .15s}
th:hover{background:var(--bg4);color:var(--text)}
th .sort-icon{margin-left:4px;opacity:.4;font-size:.7rem}
th.sorted .sort-icon{opacity:1;color:var(--accent)}
td{padding:8px 14px;border-bottom:1px solid var(--border);max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
tr:nth-child(even){background:var(--bg2)}
tr:nth-child(odd){background:var(--bg)}
tr:hover td{background:var(--bg3)}

/* Chart panel */
.chart-panel{padding:16px;overflow-y:auto}
.chart-controls{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.chart-wrapper{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px;display:flex;justify-content:center;align-items:center}
.chart-wrapper canvas{max-width:100%;border-radius:6px}

/* Filter bar in table */
.filter-bar{padding:8px 14px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0}
.filter-bar label{font-size:.78rem;color:var(--text2)}
.row-count{margin-left:auto;font-size:.75rem;color:var(--text2)}

/* Responsive */
@media(max-width:800px){
  .sidebar{display:none}
  .toolbar{padding:8px 12px}
  header{padding:10px 14px}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>⬡ Data Dashboard</h1>
    <span class="subtitle">JSON &amp; CSV Analytics — RappterZoo</span>
  </header>

  <div class="toolbar">
    <button class="btn primary" id="btnUpload" title="Upload CSV or JSON file">
      <svg viewBox="0 0 20 20"><path d="M10 3l-6 6h4v6h4V9h4z"/></svg>
      Upload File
    </button>
    <input type="file" id="fileInput" accept=".csv,.json,.tsv,.txt">
    <button class="btn" id="btnExport" title="Export filtered data as CSV download">
      <svg viewBox="0 0 20 20"><path d="M10 17l6-6h-4V5H8v6H4z"/></svg>
      Export CSV
    </button>
    <button class="btn" id="btnClear" title="Clear data">✕ Clear</button>
    <div style="flex:1"></div>
    <span id="datasetName" style="font-size:.78rem;color:var(--text2)">No data loaded</span>
  </div>

  <div class="main">
    <aside class="sidebar" id="sidebar">
      <h3>Summary Stats</h3>
      <div id="summaryStats">
        <div class="stat-card"><div class="label">Rows</div><div class="value" id="statRows">—</div></div>
        <div class="stat-card"><div class="label">Columns</div><div class="value" id="statCols">—</div></div>
        <div class="stat-card"><div class="label">Numeric Columns</div><div class="value" id="statNumeric">—</div></div>
      </div>
      <div class="col-stats" id="colStats"></div>
    </aside>

    <div class="content">
      <div class="tabs">
        <div class="tab active" data-tab="import">Import</div>
        <div class="tab" data-tab="table">Table</div>
        <div class="tab" data-tab="chart">Chart</div>
      </div>

      <!-- Import Panel -->
      <div class="panel active" id="panel-import">
        <div class="import-panel">
          <div class="drop-zone" id="dropZone">
            <h2>Drop CSV or JSON file here</h2>
            <p>or click "Upload File" above · supports .csv, .json, .tsv</p>
          </div>
          <div class="paste-area">
            <textarea id="pasteArea" placeholder="Or paste CSV / JSON data here..."></textarea>
            <div class="paste-actions">
              <button class="btn primary" id="btnParse">Parse Data</button>
              <button class="btn sample-btn" id="btnSample">Load Sample Data</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Table Panel -->
      <div class="panel" id="panel-table">
        <div class="filter-bar">
          <label>Filter / Sort rows:</label>
          <input type="text" class="text-input" id="filterInput" placeholder="Type to filter across all columns…">
          <span class="row-count" id="rowCount"></span>
        </div>
        <div class="table-container" id="tableContainer">
          <table id="dataTable"><thead></thead><tbody></tbody></table>
        </div>
      </div>

      <!-- Chart Panel -->
      <div class="panel" id="panel-chart">
        <div class="chart-panel">
          <div class="chart-controls">
            <label style="font-size:.78rem;color:var(--text2)">Chart Type:</label>
            <select id="chartType">
              <option value="bar">Bar Chart</option>
              <option value="line">Line Chart</option>
              <option value="pie">Pie Chart</option>
            </select>
            <label style="font-size:.78rem;color:var(--text2)">X Axis:</label>
            <select id="xAxis"></select>
            <label style="font-size:.78rem;color:var(--text2)">Y Axis:</label>
            <select id="yAxis"></select>
            <button class="btn primary" id="btnDraw">Draw</button>
          </div>
          <div class="chart-wrapper">
            <canvas id="chartCanvas" width="800" height="450"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
'use strict';

/* ── State ─────────────────────────────────────── */
let headers = [];
let rawData = [];
let filteredData = [];
let sortCol = -1;
let sortAsc = true;
let datasetLabel = '';

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

/* ── Tab switching ─────────────────────────────── */
$$('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    $$('.tab').forEach(t => t.classList.remove('active'));
    $$('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    const p = $('#panel-' + tab.dataset.tab);
    if (p) p.classList.add('active');
    if (tab.dataset.tab === 'chart' && headers.length) drawChart();
  });
});

/* ── File Upload ───────────────────────────────── */
$('#btnUpload').addEventListener('click', () => $('#fileInput').click());
$('#fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  datasetLabel = file.name;
  const reader = new FileReader();
  reader.onload = ev => { ingestData(ev.target.result); };
  reader.readAsText(file);
});

/* ── Drop zone ─────────────────────────────────── */
const dz = $('#dropZone');
['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.add('dragover'); }));
['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.classList.remove('dragover'); }));
dz.addEventListener('drop', e => {
  const file = e.dataTransfer.files[0];
  if (!file) return;
  datasetLabel = file.name;
  const reader = new FileReader();
  reader.onload = ev => { ingestData(ev.target.result); };
  reader.readAsText(file);
});
dz.addEventListener('click', () => $('#fileInput').click());

/* ── Paste parse ───────────────────────────────── */
$('#btnParse').addEventListener('click', () => {
  const txt = $('#pasteArea').value.trim();
  if (!txt) return;
  datasetLabel = 'Pasted Data';
  ingestData(txt);
});

/* ── Sample data ───────────────────────────────── */
$('#btnSample').addEventListener('click', () => {
  const sample = [
    {Month:'Jan',Revenue:4200,Users:120,Bounce:34,Sessions:580},
    {Month:'Feb',Revenue:5100,Users:145,Bounce:31,Sessions:720},
    {Month:'Mar',Revenue:4800,Users:132,Bounce:29,Sessions:650},
    {Month:'Apr',Revenue:6200,Users:178,Bounce:26,Sessions:890},
    {Month:'May',Revenue:7100,Users:210,Bounce:23,Sessions:1050},
    {Month:'Jun',Revenue:6800,Users:198,Bounce:25,Sessions:980},
    {Month:'Jul',Revenue:7900,Users:245,Bounce:21,Sessions:1200},
    {Month:'Aug',Revenue:8200,Users:260,Bounce:19,Sessions:1350},
    {Month:'Sep',Revenue:7400,Users:230,Bounce:22,Sessions:1120},
    {Month:'Oct',Revenue:8800,Users:290,Bounce:18,Sessions:1480},
    {Month:'Nov',Revenue:9500,Users:320,Bounce:16,Sessions:1620},
    {Month:'Dec',Revenue:10200,Users:355,Bounce:14,Sessions:1780}
  ];
  datasetLabel = 'Sample Dataset';
  loadParsed(Object.keys(sample[0]), sample.map(r => Object.values(r)));
});

/* ── Clear ─────────────────────────────────────── */
$('#btnClear').addEventListener('click', () => {
  headers = []; rawData = []; filteredData = [];
  sortCol = -1; datasetLabel = '';
  $('#dataTable').querySelector('thead').innerHTML = '';
  $('#dataTable').querySelector('tbody').innerHTML = '';
  $('#statRows').textContent = '—';
  $('#statCols').textContent = '—';
  $('#statNumeric').textContent = '—';
  $('#colStats').innerHTML = '';
  $('#filterInput').value = '';
  $('#rowCount').textContent = '';
  $('#datasetName').textContent = 'No data loaded';
  $('#xAxis').innerHTML = '';
  $('#yAxis').innerHTML = '';
  clearCanvas();
  try { localStorage.removeItem('dd_data'); } catch(e){}
});

/* ── Export CSV ────────────────────────────────── */
$('#btnExport').addEventListener('click', () => {
  if (!headers.length) return;
  const rows = [headers.join(',')];
  filteredData.forEach(r => {
    rows.push(r.map(c => {
      const s = String(c);
      return s.includes(',') || s.includes('\x22') || s.includes('\n')
        ? '\x22' + s.replace(/\x22/g,'\x22\x22') + '\x22' : s;
    }).join(','));
  });
  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (datasetLabel || 'export') .replace(/\.[^.]+$/,'') + '_filtered.csv';
  a.click();
  URL.revokeObjectURL(a.href);
});

/* ── Filter ────────────────────────────────────── */
$('#filterInput').addEventListener('input', () => {
  applyFilter();
  renderTable();
});

/* ── Data Ingestion ────────────────────────────── */
function ingestData(raw) {
  raw = raw.trim();
  let h, rows;
  // Auto-detect JSON vs CSV
  if (raw.charAt(0) === '[' || raw.charAt(0) === '{') {
    try {
      let parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) parsed = [parsed];
      if (!parsed.length) return;
      h = Object.keys(parsed[0]);
      rows = parsed.map(obj => h.map(k => obj[k] !== undefined ? obj[k] : ''));
    } catch(e) {
      alert('JSON parse error: ' + e.message);
      return;
    }
  } else {
    // CSV / TSV parse
    const result = parseCSV(raw);
    h = result.headers;
    rows = result.rows;
  }
  loadParsed(h, rows);
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (!lines.length) return {headers:[],rows:[]};
  const delim = detectDelimiter(lines[0]);
  const hdr = splitCSVLine(lines[0], delim);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const cells = splitCSVLine(lines[i], delim);
    while (cells.length < hdr.length) cells.push('');
    rows.push(cells.slice(0, hdr.length).map(autoType));
  }
  return {headers: hdr, rows};
}

function detectDelimiter(line) {
  const counts = {',':0, '\t':0, ';':0, '|':0};
  for (const ch of line) { if (ch in counts) counts[ch]++; }
  let best = ',', max = 0;
  for (const [d,c] of Object.entries(counts)) { if (c > max) { max = c; best = d; } }
  return best;
}

function splitCSVLine(line, delim) {
  const cells = [];
  let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (inQ) {
      if (ch === '"') {
        if (i + 1 < line.length && line[i+1] === '"') { cur += '"'; i++; }
        else inQ = false;
      } else cur += ch;
    } else {
      if (ch === '"') inQ = true;
      else if (ch === delim) { cells.push(autoType(cur.trim())); cur = ''; }
      else cur += ch;
    }
  }
  cells.push(autoType(cur.trim()));
  return cells;
}

function autoType(val) {
  if (val === '' || val === null || val === undefined) return '';
  if (val === 'true') return true;
  if (val === 'false') return false;
  const n = Number(val);
  if (!isNaN(n) && val !== '') return n;
  return val;
}

/* ── Load parsed data ──────────────────────────── */
function loadParsed(h, rows) {
  headers = h;
  rawData = rows;
  sortCol = -1;
  sortAsc = true;
  applyFilter();
  renderTable();
  computeStats();
  populateAxisSelectors();
  $('#datasetName').textContent = datasetLabel || 'Dataset';
  // Switch to table tab
  $$('.tab').forEach(t => t.classList.remove('active'));
  $$('.panel').forEach(p => p.classList.remove('active'));
  $$('.tab')[1].classList.add('active');
  $('#panel-table').classList.add('active');
  // Persist to localStorage
  saveToLocalStorage();
}

/* ── Filter logic ──────────────────────────────── */
function applyFilter() {
  const q = ($('#filterInput').value || '').toLowerCase();
  if (!q) { filteredData = rawData.slice(); }
  else {
    filteredData = rawData.filter(row =>
      row.some(cell => String(cell).toLowerCase().includes(q))
    );
  }
  $('#rowCount').textContent = filteredData.length + ' of ' + rawData.length + ' rows';
}

/* ── Table Render ──────────────────────────────── */
function renderTable() {
  const thead = $('#dataTable').querySelector('thead');
  const tbody = $('#dataTable').querySelector('tbody');
  // Header
  thead.innerHTML = '<tr>' + headers.map((h, i) => {
    const cls = sortCol === i ? ' class="sorted"' : '';
    const icon = sortCol === i ? (sortAsc ? '▲' : '▼') : '⇅';
    return '<th' + cls + ' data-col="' + i + '">' + esc(h) +
      ' <span class="sort-icon">' + icon + '</span></th>';
  }).join('') + '</tr>';
  // Sort click handlers
  thead.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const ci = parseInt(th.dataset.col);
      if (sortCol === ci) sortAsc = !sortAsc;
      else { sortCol = ci; sortAsc = true; }
      filteredData.sort((a, b) => {
        let va = a[ci], vb = b[ci];
        if (typeof va === 'number' && typeof vb === 'number') return sortAsc ? va - vb : vb - va;
        va = String(va).toLowerCase(); vb = String(vb).toLowerCase();
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
      });
      renderTable();
    });
  });
  // Body — virtualise for performance
  const maxShow = 500;
  const show = filteredData.slice(0, maxShow);
  tbody.innerHTML = show.map(row =>
    '<tr>' + row.map(c => '<td title="' + esc(String(c)) + '">' + esc(String(c)) + '</td>').join('') + '</tr>'
  ).join('');
  if (filteredData.length > maxShow) {
    tbody.innerHTML += '<tr><td colspan="' + headers.length +
      '" style="text-align:center;color:var(--text2);padding:16px">Showing first ' +
      maxShow + ' of ' + filteredData.length + ' rows</td></tr>';
  }
}

function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\x22/g,'&quot;');
}

/* ── Stats ─────────────────────────────────────── */
function computeStats() {
  $('#statRows').textContent = rawData.length.toLocaleString();
  $('#statCols').textContent = headers.length;
  const numCols = [];
  headers.forEach((h, i) => {
    const vals = rawData.map(r => r[i]).filter(v => typeof v === 'number' && !isNaN(v));
    if (vals.length > rawData.length * 0.3) numCols.push({name: h, idx: i, vals});
  });
  $('#statNumeric').textContent = numCols.length;
  const container = $('#colStats');
  container.innerHTML = '<h3 style="margin-bottom:8px">Column Details</h3>';
  numCols.forEach(col => {
    const min = Math.min(...col.vals);
    const max = Math.max(...col.vals);
    const avg = col.vals.reduce((a,b)=>a+b,0)/col.vals.length;
    const sum = col.vals.reduce((a,b)=>a+b,0);
    container.innerHTML += '<div class="col-stat">' +
      '<div class="col-name">' + esc(col.name) + '</div>' +
      '<div class="metrics">' +
      '<div class="metric">Min: <span>' + fmt(min) + '</span></div>' +
      '<div class="metric">Max: <span>' + fmt(max) + '</span></div>' +
      '<div class="metric">Avg: <span>' + fmt(avg) + '</span></div>' +
      '<div class="metric">Sum: <span>' + fmt(sum) + '</span></div>' +
      '</div></div>';
  });
}

function fmt(n) {
  if (Number.isInteger(n)) return n.toLocaleString();
  return n.toFixed(2).replace(/\.?0+$/, '');
}

/* ── Axis selectors ────────────────────────────── */
function populateAxisSelectors() {
  const xs = $('#xAxis'), ys = $('#yAxis');
  xs.innerHTML = ''; ys.innerHTML = '';
  headers.forEach((h, i) => {
    xs.innerHTML += '<option value="' + i + '">' + esc(h) + '</option>';
    ys.innerHTML += '<option value="' + i + '">' + esc(h) + '</option>';
  });
  // Default: first column X, second (or first numeric) Y
  if (headers.length > 1) {
    ys.value = '1';
    // Try to pick first numeric column for Y
    for (let i = 0; i < headers.length; i++) {
      const vals = rawData.map(r => r[i]).filter(v => typeof v === 'number');
      if (vals.length > rawData.length * 0.3) { ys.value = String(i); break; }
    }
  }
}

/* ── Chart Drawing on canvas element ───────────── */
$('#btnDraw').addEventListener('click', drawChart);
$('#chartType').addEventListener('change', drawChart);

function drawChart() {
  const canvas = $('#chartCanvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = 800, h = 450;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  const type = $('#chartType').value;
  const xi = parseInt($('#xAxis').value);
  const yi = parseInt($('#yAxis').value);
  if (isNaN(xi) || isNaN(yi) || !filteredData.length) { clearCanvas(); return; }

  // Aggregate: group by X, average Y values
  const groups = {};
  const order = [];
  filteredData.forEach(row => {
    const key = String(row[xi]);
    const val = typeof row[yi] === 'number' ? row[yi] : parseFloat(row[yi]);
    if (isNaN(val)) return;
    if (!(key in groups)) { groups[key] = {sum:0, count:0}; order.push(key); }
    groups[key].sum += val;
    groups[key].count++;
  });
  const labels = order;
  const values = labels.map(k => groups[k].sum / groups[k].count);

  if (!labels.length) { clearCanvas(); return; }

  // Clear
  ctx.fillStyle = '#12121a';
  ctx.fillRect(0, 0, w, h);

  if (type === 'pie') drawPie(ctx, w, h, labels, values);
  else if (type === 'line') drawLine(ctx, w, h, labels, values);
  else drawBar(ctx, w, h, labels, values);
}

function clearCanvas() {
  const canvas = $('#chartCanvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  canvas.width = 800 * dpr; canvas.height = 450 * dpr;
  canvas.style.width = '800px'; canvas.style.height = '450px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.fillStyle = '#12121a';
  ctx.fillRect(0,0,800,450);
  ctx.fillStyle = '#94a3b8';
  ctx.font = '14px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText('Load data and select axes to render a chart', 400, 225);
}

/* ── Bar Chart ─────────────────────────────────── */
function drawBar(ctx, w, h, labels, values) {
  const pad = {top:40, right:30, bottom:70, left:70};
  const cw = w - pad.left - pad.right;
  const ch = h - pad.top - pad.bottom;
  const maxVal = Math.max(...values, 1);
  const minVal = Math.min(...values, 0);
  const range = maxVal - Math.min(minVal, 0);
  const barW = Math.max(4, Math.min(50, cw / labels.length - 6));
  const gap = (cw - barW * labels.length) / (labels.length + 1);
  const colors = generatePalette(labels.length);
  const zeroY = pad.top + ch - (ch * (0 - Math.min(minVal,0)) / range);

  // Grid lines
  const ticks = niceSteps(Math.min(minVal,0), maxVal, 6);
  ctx.strokeStyle = '#2a2a3a';
  ctx.lineWidth = 1;
  ctx.font = '11px system-ui';
  ctx.fillStyle = '#94a3b8';
  ctx.textAlign = 'right';
  ticks.forEach(v => {
    const y = pad.top + ch - (ch * (v - Math.min(minVal,0)) / range);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    ctx.fillText(shortNum(v), pad.left - 8, y + 4);
  });

  // Bars with gradient
  labels.forEach((label, i) => {
    const x = pad.left + gap + i * (barW + gap);
    const barH = (ch * values[i]) / range;
    const y = zeroY - barH;
    const grad = ctx.createLinearGradient(x, y, x, zeroY);
    grad.addColorStop(0, colors[i]);
    grad.addColorStop(1, adjustAlpha(colors[i], 0.5));
    ctx.fillStyle = grad;
    roundRect(ctx, x, Math.min(y, zeroY), barW, Math.abs(barH), 3);
    ctx.fill();
    // Label
    ctx.save();
    ctx.translate(x + barW / 2, zeroY + 12);
    ctx.rotate(labels.length > 10 ? -Math.PI/4 : 0);
    ctx.fillStyle = '#94a3b8';
    ctx.font = '10px system-ui';
    ctx.textAlign = labels.length > 10 ? 'right' : 'center';
    ctx.fillText(truncate(label, 12), 0, 0);
    ctx.restore();
    // Value on top
    ctx.fillStyle = '#e2e8f0';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(shortNum(values[i]), x + barW/2, Math.min(y, zeroY) - 6);
  });

  // Title
  ctx.fillStyle = '#e2e8f0'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Bar Chart — ' + headers[$('#xAxis').value] + ' vs ' + headers[$('#yAxis').value], w/2, 22);
}

/* ── Line Chart ────────────────────────────────── */
function drawLine(ctx, w, h, labels, values) {
  const pad = {top:40, right:30, bottom:70, left:70};
  const cw = w - pad.left - pad.right;
  const ch = h - pad.top - pad.bottom;
  const maxVal = Math.max(...values, 1);
  const minVal = Math.min(...values, 0);
  const range = maxVal - minVal || 1;

  // Grid
  const ticks = niceSteps(minVal, maxVal, 6);
  ctx.strokeStyle = '#2a2a3a'; ctx.lineWidth = 1;
  ctx.font = '11px system-ui'; ctx.fillStyle = '#94a3b8'; ctx.textAlign = 'right';
  ticks.forEach(v => {
    const y = pad.top + ch - (ch * (v - minVal) / range);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    ctx.fillText(shortNum(v), pad.left - 8, y + 4);
  });

  const pts = values.map((v, i) => ({
    x: pad.left + (cw * i) / Math.max(labels.length - 1, 1),
    y: pad.top + ch - (ch * (v - minVal) / range)
  }));

  // Area fill
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + ch);
  grad.addColorStop(0, 'rgba(59,130,246,0.3)');
  grad.addColorStop(1, 'rgba(59,130,246,0)');
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pad.top + ch);
  pts.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(pts[pts.length-1].x, pad.top + ch);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2.5; ctx.lineJoin = 'round';
  pts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
  ctx.stroke();

  // Dots
  pts.forEach((p, i) => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
    ctx.fillStyle = '#3b82f6'; ctx.fill();
    ctx.strokeStyle = '#12121a'; ctx.lineWidth = 2; ctx.stroke();
  });

  // X labels
  const step = Math.max(1, Math.floor(labels.length / 20));
  labels.forEach((label, i) => {
    if (i % step !== 0 && i !== labels.length - 1) return;
    ctx.save();
    ctx.translate(pts[i].x, pad.top + ch + 14);
    ctx.rotate(labels.length > 10 ? -Math.PI/4 : 0);
    ctx.fillStyle = '#94a3b8'; ctx.font = '10px system-ui';
    ctx.textAlign = labels.length > 10 ? 'right' : 'center';
    ctx.fillText(truncate(label, 12), 0, 0);
    ctx.restore();
  });

  ctx.fillStyle = '#e2e8f0'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Line Chart — ' + headers[$('#xAxis').value] + ' vs ' + headers[$('#yAxis').value], w/2, 22);
}

/* ── Pie Chart ─────────────────────────────────── */
function drawPie(ctx, w, h, labels, values) {
  const cx = w/2 - 80, cy = h/2 + 10, r = Math.min(w, h) * 0.33;
  const total = values.reduce((a,b) => a + Math.abs(b), 0) || 1;
  const colors = generatePalette(labels.length);

  let angle = -Math.PI / 2;
  labels.forEach((label, i) => {
    const slice = (Math.abs(values[i]) / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, angle, angle + slice);
    ctx.closePath();
    ctx.fillStyle = colors[i];
    ctx.fill();
    ctx.strokeStyle = '#12121a'; ctx.lineWidth = 2; ctx.stroke();

    // Label line
    const mid = angle + slice / 2;
    if (slice > 0.08) {
      const lx = cx + Math.cos(mid) * (r + 16);
      const ly = cy + Math.sin(mid) * (r + 16);
      ctx.fillStyle = '#e2e8f0'; ctx.font = '10px system-ui';
      ctx.textAlign = lx > cx ? 'left' : 'right';
      ctx.fillText(truncate(label, 10) + ' (' + ((Math.abs(values[i])/total)*100).toFixed(1) + '%)', lx, ly + 3);
    }
    angle += slice;
  });

  // Legend
  const legendX = w - 180, legendY = 50;
  const maxLegend = Math.min(labels.length, 15);
  for (let i = 0; i < maxLegend; i++) {
    ctx.fillStyle = colors[i];
    ctx.fillRect(legendX, legendY + i * 20, 12, 12);
    ctx.fillStyle = '#94a3b8'; ctx.font = '11px system-ui'; ctx.textAlign = 'left';
    ctx.fillText(truncate(labels[i], 16), legendX + 18, legendY + i * 20 + 10);
  }

  ctx.fillStyle = '#e2e8f0'; ctx.font = 'bold 14px system-ui'; ctx.textAlign = 'center';
  ctx.fillText('Pie Chart — ' + headers[$('#yAxis').value] + ' by ' + headers[$('#xAxis').value], w/2, 22);
}

/* ── Chart helpers ─────────────────────────────── */
function generatePalette(n) {
  const base = ['#3b82f6','#22c55e','#f59e0b','#ef4444','#a855f7','#ec4899','#06b6d4','#84cc16','#f97316','#6366f1','#14b8a6','#e879f9'];
  const out = [];
  for (let i = 0; i < n; i++) out.push(base[i % base.length]);
  return out;
}

function adjustAlpha(hex, alpha) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return 'rgba('+r+','+g+','+b+','+alpha+')';
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

function niceSteps(min, max, count) {
  const range = max - min || 1;
  const step = range / count;
  const mag = Math.pow(10, Math.floor(Math.log10(step)));
  const nice = [1, 2, 5, 10].map(m => m * mag).find(m => m >= step) || step;
  const start = Math.floor(min / nice) * nice;
  const ticks = [];
  for (let v = start; v <= max + nice * 0.01; v += nice) ticks.push(parseFloat(v.toFixed(10)));
  return ticks;
}

function shortNum(n) {
  if (Math.abs(n) >= 1e6) return (n/1e6).toFixed(1)+'M';
  if (Math.abs(n) >= 1e3) return (n/1e3).toFixed(1)+'K';
  return Number.isInteger(n) ? String(n) : n.toFixed(2);
}

function truncate(s, n) { return s.length > n ? s.slice(0, n) + '…' : s; }

/* ── localStorage persistence ──────────────────── */
function saveToLocalStorage() {
  try {
    const data = JSON.stringify({headers, rawData, label: datasetLabel});
    localStorage.setItem('dd_data', data);
  } catch(e) { /* quota exceeded, ignore */ }
}

function loadFromLocalStorage() {
  try {
    const stored = localStorage.getItem('dd_data');
    if (!stored) return;
    const {headers: h, rawData: r, label} = JSON.parse(stored);
    if (h && h.length && r && r.length) {
      datasetLabel = label || 'Saved Dataset';
      loadParsed(h, r);
    }
  } catch(e) { /* corrupted data, ignore */ }
}

/* ── Init ──────────────────────────────────────── */
clearCanvas();
loadFromLocalStorage();

})();
</script>
</body>
</html>
