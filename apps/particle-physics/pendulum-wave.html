<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendulum Wave Laboratory</title>
    <meta name="description" content="Interactive pendulum wave physics simulator with real differential equations, phase space visualization, and educational content">
    <meta name="rappterzoo:category" content="particle-physics">
    <meta name="rappterzoo:title" content="Pendulum Wave Laboratory">
    <meta name="rappterzoo:description" content="Interactive pendulum wave physics simulator with real differential equations, phase space visualization, and educational content">
    <meta name="rappterzoo:tags" content="physics,pendulum,wave,oscillation,simulation,educational">
    <meta name="rappterzoo:experience" content="discovery,wonder,flow">
    <meta name="rappterzoo:type" content="interactive">
    <meta name="rappterzoo:complexity" content="advanced">
    <meta name="rappterzoo:created" content="2025-01-15">
    <meta name="rappterzoo:generation" content="1">
    <meta name="rappterzoo:author" content="RappterZoo">
    <meta name="rappterzoo:author-type" content="agent">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #06060f;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #a0b0cc;
            overflow: hidden;
            display: flex;
        }
        #left-panel {
            width: 240px;
            min-width: 240px;
            background: rgba(8,10,20,0.97);
            border-right: 1px solid rgba(80,100,160,0.2);
            overflow-y: auto;
            z-index: 10;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        #right-panel {
            width: 260px;
            min-width: 260px;
            background: rgba(8,10,20,0.97);
            border-left: 1px solid rgba(80,100,160,0.2);
            overflow-y: auto;
            z-index: 10;
            padding: 12px;
        }
        #canvas-wrap {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .ptitle {
            font-size: 14px;
            font-weight: 600;
            color: #c0d0ee;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ptitle .ico { font-size: 16px; }
        .sec {
            background: rgba(20,25,45,0.6);
            border: 1px solid rgba(70,90,140,0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .sec-head {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #7888aa;
            margin-bottom: 8px;
        }
        .cr { margin-bottom: 8px; }
        .cr label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-bottom: 3px;
            color: #8898bb;
        }
        .cr .vl {
            color: #b0c8ee;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(60,80,130,0.3);
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #5080cc;
            cursor: pointer;
            border: 2px solid #2a3a60;
        }
        select {
            width: 100%;
            padding: 6px 8px;
            background: rgba(20,30,55,0.8);
            border: 1px solid rgba(70,90,140,0.3);
            color: #a0b8dd;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            outline: none;
        }
        .brow {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-bottom: 4px;
        }
        .btn {
            flex: 1;
            min-width: 60px;
            padding: 6px 4px;
            background: rgba(40,55,90,0.5);
            border: 1px solid rgba(70,90,140,0.3);
            color: #8898bb;
            cursor: pointer;
            border-radius: 6px;
            font-size: 10px;
            font-family: inherit;
            text-align: center;
            transition: all 0.15s;
        }
        .btn:hover {
            background: rgba(50,70,120,0.6);
            color: #b0c8ee;
        }
        .btn.active {
            background: rgba(60,90,160,0.5);
            color: #d0e0ff;
            border-color: rgba(100,130,200,0.5);
        }
        .gp {
            display: flex;
            gap: 3px;
            margin-top: 4px;
        }
        .gp .btn {
            font-size: 9px;
            padding: 3px 2px;
        }
        .vm {
            display: flex;
            gap: 3px;
            margin-bottom: 6px;
        }
        .vm .btn {
            font-size: 10px;
            padding: 5px 3px;
        }
        .sr {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 3px 0;
            border-bottom: 1px solid rgba(60,80,120,0.1);
        }
        .sl { color: #6878a0; }
        .sv {
            color: #b0c8ee;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        .phi {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            transition: background 0.5s, color 0.5s;
        }
        #spk-wrap {
            height: 40px;
            background: rgba(15,20,35,0.5);
            border-radius: 4px;
            overflow: hidden;
            margin: 6px 0;
        }
        #spk { width: 100%; height: 100%; }
        .lsec { margin-top: 8px; }
        .ltog {
            width: 100%;
            background: rgba(30,40,70,0.4);
            border: 1px solid rgba(70,90,140,0.2);
            color: #8898bb;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 11px;
            text-align: left;
        }
        .ltog:hover { background: rgba(40,55,90,0.5); }
        .lcont {
            display: none;
            margin-top: 6px;
            font-size: 11px;
            line-height: 1.5;
            color: #7888aa;
        }
        .lcont.open { display: block; }
        .lcont h4 {
            color: #a0b8dd;
            font-size: 11px;
            margin: 8px 0 3px;
        }
        .lcont h4:first-child { margin-top: 0; }
        .lcont p { margin-bottom: 4px; }
        .fm {
            font-family: 'Georgia', serif;
            font-style: italic;
            color: #b0c0dd;
            background: rgba(30,40,70,0.4);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin: 2px 0;
        }
        .pov {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            font-size: 18px;
            font-weight: 600;
            color: rgba(160,180,220,0.7);
            letter-spacing: 4px;
            pointer-events: none;
            display: none;
        }
        .pov.vis { display: block; }
        .hh {
            font-size: 9px;
            color: #506080;
            text-align: center;
            margin-top: 4px;
        }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: rgba(70,90,140,0.3);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="left-panel">
        <div class="ptitle"><span class="ico">&#x1F52C;</span> Pendulum Wave Lab</div>
        <div class="sec">
            <div class="sec-head">Preset</div>
            <select id="preset-sel">
                <option value="classic">Classic Wave</option>
                <option value="hypnotic">Hypnotic Spiral</option>
                <option value="metronome">Metronome Sync</option>
                <option value="chaos">Chaos Theory</option>
                <option value="moon">Moon Gravity</option>
                <option value="custom">Custom</option>
            </select>
        </div>
        <div class="sec">
            <div class="sec-head">Physics</div>
            <div class="cr"><label>Pendulums <span class="vl" id="v-count">15</span></label><input type="range" id="s-count" min="5" max="40" value="15"></div>
            <div class="cr"><label>Gravity (m/s&sup2;) <span class="vl" id="v-grav">9.81</span></label><input type="range" id="s-grav" min="1" max="200" value="98">
                <div class="gp"><button class="btn" data-g="1.62">Moon</button><button class="btn" data-g="3.72">Mars</button><button class="btn" data-g="9.81">Earth</button><button class="btn" data-g="24.79">Jupiter</button></div>
            </div>
            <div class="cr"><label>Damping <span class="vl" id="v-damp">0.005</span></label><input type="range" id="s-damp" min="0" max="500" value="5"></div>
            <div class="cr"><label>Amplitude (&deg;) <span class="vl" id="v-amp">30</span></label><input type="range" id="s-amp" min="5" max="90" value="30"></div>
            <div class="cr"><label>Speed <span class="vl" id="v-spd">1.0x</span></label><input type="range" id="s-spd" min="1" max="30" value="10"></div>
            <div class="cr"><label>Length Spread <span class="vl" id="v-spr">1.0</span></label><input type="range" id="s-spr" min="1" max="30" value="10"></div>
        </div>
        <div class="sec">
            <div class="sec-head">Visualization</div>
            <div class="vm"><button class="btn active" data-mode="standard">Standard</button><button class="btn" data-mode="phase">Phase</button><button class="btn" data-mode="energy">Energy</button><button class="btn" data-mode="trails">Trails</button></div>
            <div class="brow"><button class="btn" id="btn-grid">Grid</button><button class="btn" id="btn-vec">Vectors</button></div>
        </div>
        <div class="sec">
            <div class="sec-head">Actions</div>
            <div class="brow"><button class="btn" id="btn-sync">Reset Sync</button><button class="btn" id="btn-rand">Random</button></div>
            <div class="brow"><button class="btn" id="btn-casc">Cascade</button><button class="btn" id="btn-pause">&#x23F8; Pause</button></div>
        </div>
        <div class="hh">Space: pause &middot; R: reset &middot; G: grid &middot; Click bob to grab</div>
    </div>
    <div id="canvas-wrap">
        <canvas id="cv"></canvas>
        <div class="pov" id="pov">&#x23F8; PAUSED</div>
    </div>
    <div id="right-panel">
        <div class="ptitle"><span class="ico">&#x1F4CA;</span> Analysis</div>
        <div class="sec">
            <div class="phi" id="phi">Aligned</div>
            <div class="sr"><span class="sl">Time</span><span class="sv" id="st-time">0.0s</span></div>
            <div class="sr"><span class="sl">Cycles (#1)</span><span class="sv" id="st-cyc">0</span></div>
            <div class="sr"><span class="sl">Total Energy</span><span class="sv" id="st-ene">0.00</span></div>
            <div class="sr"><span class="sl">Max Velocity</span><span class="sv" id="st-vel">0.00</span></div>
            <div class="sr"><span class="sl">Pendulums</span><span class="sv" id="st-pc">15</span></div>
        </div>
        <div class="sec">
            <div class="sec-head">System Energy</div>
            <div id="spk-wrap"><canvas id="spk"></canvas></div>
        </div>
        <div class="lsec">
            <button class="ltog" id="ltog">&#x1F4D6; Learn: Why Pendulum Waves Work &#x25B8;</button>
            <div class="lcont" id="lcont">
                <h4>Period &amp; Length</h4>
                <p>A pendulum's period depends only on its length and gravity:</p>
                <div class="fm">T = 2&#x03C0;&#x221A;(L/g)</div>
                <p>Longer pendulums swing slower. By carefully choosing lengths, each pendulum completes a slightly different number of cycles in the same time &mdash; creating wave patterns.</p>
                <h4>Wave Patterns from Phase</h4>
                <p>When all pendulums start together, they gradually drift out of phase. The pattern cycles: aligned &#x2192; traveling wave &#x2192; complex patterns &#x2192; realignment. With N pendulums tuned to differ by 1 cycle over time T, you get beautiful standing and traveling waves.</p>
                <h4>Phase Space Diagram</h4>
                <p>The phase space plot shows angle (&#x03B8;) vs angular velocity (&#x03B8;&#x0307;). A simple pendulum traces an ellipse. With damping, it spirals inward. At high amplitudes, the shape distorts &mdash; revealing nonlinear dynamics.</p>
                <h4>Real-World Examples</h4>
                <p><strong>Foucault Pendulum:</strong> A long pendulum whose swing plane rotates, proving Earth's rotation.</p>
                <p><strong>Metronome Sync:</strong> Metronomes on a shared platform gradually synchronize via coupled oscillation.</p>
                <p><strong>Tacoma Narrows:</strong> Resonance (matching a structure's natural frequency) can cause catastrophic oscillation.</p>
                <h4>The Physics Engine</h4>
                <p>This simulator uses the real nonlinear equation of motion:</p>
                <div class="fm">&#x03B8;'' = -(g/L)sin(&#x03B8;) - b&#x03B8;'</div>
                <p>Integrated with 4th-order Runge-Kutta (RK4) for accuracy. Energy = &frac12;mL&sup2;&#x03B8;'&sup2; + mgL(1-cos&#x03B8;).</p>
            </div>
        </div>
    </div>
    <script>
    (function(){
    'use strict';
    var cv=document.getElementById('cv'),ctx=cv.getContext('2d'),wrap=document.getElementById('canvas-wrap');
    var spkCv=document.getElementById('spk'),spkCtx=spkCv.getContext('2d');
    var W,H;
    function resize(){
        var r=window.devicePixelRatio||1;
        W=wrap.clientWidth;H=wrap.clientHeight;
        cv.width=W*r;cv.height=H*r;cv.style.width=W+'px';cv.style.height=H+'px';
        ctx.setTransform(r,0,0,r,0,0);
        var sw=spkCv.parentElement.clientWidth;
        spkCv.width=sw*r;spkCv.height=40*r;
        spkCtx.setTransform(r,0,0,r,0,0);
    }
    var S={gravity:9.81,damping:0.005,amplitude:30*Math.PI/180,count:15,speed:1.0,spread:1.0,
        paused:false,time:0,vizMode:'standard',showGrid:false,showVec:false,zoom:1,panX:0,panY:0,
        cycleCount:0,lastSign:1,preset:'classic'};
    var pends=[],stars=[],eHist=[],grabbed=-1,grabAng=0,isPan=false,panSt={x:0,y:0},panOr={x:0,y:0};

    function initStars(){stars=[];for(var i=0;i<120;i++)stars.push({x:Math.random(),y:Math.random(),r:Math.random()*1.2+0.3,a:Math.random()*0.5+0.1,tw:Math.random()*Math.PI*2})}

    var PRESETS={
        classic:{count:15,gravity:9.81,damping:0.003,amplitude:30,spread:1.0},
        hypnotic:{count:25,gravity:9.81,damping:0.002,amplitude:25,spread:1.3},
        metronome:{count:10,gravity:9.81,damping:0.001,amplitude:15,spread:0.15},
        chaos:{count:20,gravity:9.81,damping:0.001,amplitude:75,spread:1.5},
        moon:{count:15,gravity:1.62,damping:0.002,amplitude:35,spread:1.0}
    };

    function applyPreset(n){
        var p=PRESETS[n];if(!p)return;
        S.preset=n;S.count=p.count;S.gravity=p.gravity;S.damping=p.damping;
        S.amplitude=p.amplitude*Math.PI/180;S.spread=p.spread;
        updateSliders();initPendulums();
    }

    function initPendulums(){
        pends=[];eHist=[];S.time=0;S.cycleCount=0;S.lastSign=1;
        var baseLen=120,lenStep=12*S.spread;
        for(var i=0;i<S.count;i++){
            pends.push({L:baseLen+i*lenStep,theta:S.amplitude,omega:0,trail:[],
                hue:(i/Math.max(S.count-1,1))*270+200});
        }
        save();
    }

    // RK4: theta''=-(g/L)*sin(theta)-b*omega
    function deriv(th,om,L){return{dt:om,do_:-(S.gravity/L)*Math.sin(th)-S.damping*om}}
    function rk4(p,dt){
        var L=p.L,th=p.theta,om=p.omega;
        var k1=deriv(th,om,L);
        var k2=deriv(th+k1.dt*dt*0.5,om+k1.do_*dt*0.5,L);
        var k3=deriv(th+k2.dt*dt*0.5,om+k2.do_*dt*0.5,L);
        var k4=deriv(th+k3.dt*dt,om+k3.do_*dt,L);
        p.theta+=(k1.dt+2*k2.dt+2*k3.dt+k4.dt)*dt/6;
        p.omega+=(k1.do_+2*k2.do_+2*k3.do_+k4.do_)*dt/6;
    }
    function stepPhys(dt){
        var sub=4,sd=dt/sub;
        for(var s=0;s<sub;s++)for(var i=0;i<pends.length;i++){if(i===grabbed)continue;rk4(pends[i],sd)}
    }

    function ke(p){return 0.5*p.L*p.L*p.omega*p.omega*0.01}
    function pe(p){return S.gravity*p.L*(1-Math.cos(p.theta))*0.01}
    function te(p){return ke(p)+pe(p)}
    function sysE(){var e=0;for(var i=0;i<pends.length;i++)e+=te(pends[i]);return e}

    function phaseState(){
        if(pends.length<2)return{s:'Single',c:'#5588cc'};
        var angs=pends.map(function(p){return p.theta});
        var mn=Math.min.apply(null,angs),mx=Math.max.apply(null,angs),sp=mx-mn;
        var ar=Math.abs(S.amplitude)||0.1;
        if(sp<ar*0.15)return{s:'Aligned',c:'#44cc88'};
        if(sp<ar*0.5)return{s:'Converging',c:'#88bb55'};
        var diffs=[];
        for(var i=1;i<angs.length;i++)diffs.push(angs[i]-angs[i-1]);
        var sgn=diffs[0]>0?1:-1,mono=true;
        for(var j=1;j<diffs.length;j++){if((diffs[j]>0?1:-1)!==sgn){mono=false;break}}
        if(mono)return{s:'Wave',c:'#5599dd'};
        return{s:'Chaos',c:'#cc6655'};
    }

    var RY=60;
    function anchorX(i){var m=40,u=W-m*2,sp=u/(pends.length+1);return m+sp*(i+1)}
    function bpos(i){
        var p=pends[i],ax=anchorX(i),ay=RY,sc=Math.min(W,H)/700*S.zoom;
        return{x:ax+Math.sin(p.theta)*p.L*sc+S.panX,y:ay+Math.cos(p.theta)*p.L*sc+S.panY,ax:ax,ay:ay,sc:sc};
    }

    function drawStars(){
        for(var i=0;i<stars.length;i++){
            var s=stars[i],fl=0.6+0.4*Math.sin(S.time*0.5+s.tw);
            ctx.beginPath();ctx.arc(s.x*W,s.y*H,s.r,0,Math.PI*2);
            ctx.fillStyle='rgba(180,200,240,'+(s.a*fl).toFixed(2)+')';ctx.fill();
        }
    }
    function drawGrid(){
        if(!S.showGrid)return;
        ctx.strokeStyle='rgba(60,80,120,0.12)';ctx.lineWidth=0.5;
        var st=50;
        for(var x=0;x<W;x+=st){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke()}
        for(var y=0;y<H;y+=st){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke()}
        ctx.fillStyle='rgba(80,100,140,0.2)';ctx.font='9px sans-serif';
        for(var gx=0;gx<W;gx+=st*2)ctx.fillText(gx+'px',gx+2,H-4);
    }
    function drawRail(){
        var g=ctx.createLinearGradient(0,RY-4,0,RY+4);
        g.addColorStop(0,'rgba(140,160,200,0.5)');g.addColorStop(0.5,'rgba(90,110,160,0.7)');g.addColorStop(1,'rgba(50,70,110,0.4)');
        ctx.fillStyle=g;ctx.fillRect(20,RY-3,W-40,6);
        ctx.fillStyle='rgba(180,200,240,0.15)';ctx.fillRect(20,RY-4,W-40,1);
        for(var i=0;i<pends.length;i++){
            var ax=anchorX(i);ctx.beginPath();ctx.arc(ax,RY,4,0,Math.PI*2);
            ctx.fillStyle='rgba(130,150,190,0.6)';ctx.fill();
            ctx.strokeStyle='rgba(160,180,220,0.3)';ctx.lineWidth=1;ctx.stroke();
        }
    }
    function drawStandard(){
        for(var i=0;i<pends.length;i++){
            var p=pends[i],pos=bpos(i),vel=Math.abs(p.omega),vn=Math.min(vel/5,1);
            // Curved string
            var mx=(pos.ax+pos.x)/2+Math.sin(p.theta)*pos.sc*3,my=(pos.ay+pos.y)/2;
            ctx.beginPath();ctx.moveTo(pos.ax,pos.ay);ctx.quadraticCurveTo(mx,my,pos.x,pos.y);
            ctx.strokeStyle='hsla('+p.hue+',40%,50%,0.5)';ctx.lineWidth=1.5;ctx.stroke();
            // Trails
            if(S.vizMode==='trails'){
                p.trail.push({x:pos.x,y:pos.y});if(p.trail.length>80)p.trail.shift();
                if(p.trail.length>1){
                    for(var t=1;t<p.trail.length;t++){
                        var al=(t/p.trail.length)*0.6;
                        ctx.beginPath();ctx.moveTo(p.trail[t-1].x,p.trail[t-1].y);ctx.lineTo(p.trail[t].x,p.trail[t].y);
                        ctx.strokeStyle='hsla('+p.hue+',70%,60%,'+al.toFixed(2)+')';ctx.lineWidth=2;ctx.stroke();
                    }
                }
            }
            // Velocity vectors
            if(S.showVec){
                var vx=p.omega*p.L*pos.sc*Math.cos(p.theta)*0.3,vy=-p.omega*p.L*pos.sc*Math.sin(p.theta)*0.3;
                ctx.beginPath();ctx.moveTo(pos.x,pos.y);ctx.lineTo(pos.x+vx,pos.y+vy);
                ctx.strokeStyle='rgba(255,200,100,0.6)';ctx.lineWidth=2;ctx.stroke();
                var aL=5,an=Math.atan2(vy,vx);
                ctx.beginPath();ctx.moveTo(pos.x+vx,pos.y+vy);
                ctx.lineTo(pos.x+vx-aL*Math.cos(an-0.4),pos.y+vy-aL*Math.sin(an-0.4));
                ctx.moveTo(pos.x+vx,pos.y+vy);
                ctx.lineTo(pos.x+vx-aL*Math.cos(an+0.4),pos.y+vy-aL*Math.sin(an+0.4));
                ctx.stroke();
            }
            // Glow
            var gr=12+vn*14,gd=ctx.createRadialGradient(pos.x,pos.y,0,pos.x,pos.y,gr);
            gd.addColorStop(0,'hsla('+p.hue+',80%,'+(65+vn*20)+'%,1)');
            gd.addColorStop(0.4,'hsla('+p.hue+',70%,'+(50+vn*15)+'%,0.7)');
            gd.addColorStop(1,'hsla('+p.hue+',60%,40%,0)');
            ctx.beginPath();ctx.arc(pos.x,pos.y,gr,0,Math.PI*2);ctx.fillStyle=gd;ctx.fill();
            // Core
            var cr=5+vn*2;ctx.beginPath();ctx.arc(pos.x,pos.y,cr,0,Math.PI*2);
            ctx.fillStyle='hsla('+p.hue+',85%,'+(75+vn*15)+'%,1)';ctx.fill();
            // Grab indicator
            if(i===grabbed){
                ctx.beginPath();ctx.arc(pos.x,pos.y,gr+4,0,Math.PI*2);
                ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=2;ctx.setLineDash([4,4]);ctx.stroke();ctx.setLineDash([]);
            }
        }
    }
    function drawPhase(){
        var cx=W/2,cy=H/2,sx=W*0.35,sy=H*0.3;
        ctx.strokeStyle='rgba(80,100,140,0.3)';ctx.lineWidth=1;
        ctx.beginPath();ctx.moveTo(cx-sx,cy);ctx.lineTo(cx+sx,cy);ctx.stroke();
        ctx.beginPath();ctx.moveTo(cx,cy-sy);ctx.lineTo(cx,cy+sy);ctx.stroke();
        ctx.fillStyle='rgba(100,120,160,0.5)';ctx.font='11px sans-serif';
        ctx.fillText('\u03B8 \u2192',cx+sx-20,cy+16);ctx.fillText('\u03C9 \u2192',cx+8,cy-sy+14);
        for(var t=-3;t<=3;t++){if(t===0)continue;var tx=cx+(t/3)*sx;
            ctx.beginPath();ctx.moveTo(tx,cy-3);ctx.lineTo(tx,cy+3);ctx.stroke();
            ctx.fillText((t*60)+'\u00B0',tx-10,cy+16);
        }
        for(var i=0;i<pends.length;i++){
            var p=pends[i];p.trail.push({x:p.theta,y:p.omega});if(p.trail.length>200)p.trail.shift();
            if(p.trail.length>1){
                for(var j=1;j<p.trail.length;j++){
                    var al=(j/p.trail.length)*0.7;
                    ctx.beginPath();
                    ctx.moveTo(cx+p.trail[j-1].x/Math.PI*sx,cy-p.trail[j-1].y/8*sy);
                    ctx.lineTo(cx+p.trail[j].x/Math.PI*sx,cy-p.trail[j].y/8*sy);
                    ctx.strokeStyle='hsla('+p.hue+',70%,60%,'+al.toFixed(2)+')';ctx.lineWidth=1.5;ctx.stroke();
                }
            }
            var px=cx+p.theta/Math.PI*sx,py=cy-p.omega/8*sy;
            ctx.beginPath();ctx.arc(px,py,3,0,Math.PI*2);
            ctx.fillStyle='hsla('+p.hue+',80%,70%,1)';ctx.fill();
        }
    }
    function drawEnergy(){
        var bw=Math.min(40,(W-80)/pends.length-4),maxH=H*0.5,baseY=H*0.82;
        var startX=(W-(bw+4)*pends.length)/2;
        ctx.fillStyle='rgba(80,100,140,0.3)';ctx.font='11px sans-serif';
        ctx.fillText('Energy per Pendulum (KE + PE)',startX,baseY-maxH-10);
        var mxE=0;for(var i=0;i<pends.length;i++){var t=te(pends[i]);if(t>mxE)mxE=t}
        if(mxE<0.01)mxE=1;
        for(var j=0;j<pends.length;j++){
            var p=pends[j],k=ke(p),pe_=pe(p),kH=(k/mxE)*maxH,pH=(pe_/mxE)*maxH,x=startX+j*(bw+4);
            ctx.fillStyle='hsla('+p.hue+',60%,40%,0.8)';ctx.fillRect(x,baseY-pH,bw,pH);
            ctx.fillStyle='hsla('+p.hue+',80%,65%,0.9)';ctx.fillRect(x,baseY-pH-kH,bw,kH);
            ctx.strokeStyle='hsla('+p.hue+',50%,50%,0.3)';ctx.lineWidth=1;ctx.strokeRect(x,baseY-pH-kH,bw,pH+kH);
            ctx.fillStyle='rgba(120,140,180,0.5)';ctx.font='9px sans-serif';ctx.fillText(j+1,x+bw/2-4,baseY+14);
        }
        var ly=baseY+30;
        ctx.fillStyle='hsla(220,80%,65%,0.9)';ctx.fillRect(startX,ly,12,12);
        ctx.fillStyle='rgba(140,160,200,0.7)';ctx.font='10px sans-serif';ctx.fillText('KE (Kinetic)',startX+18,ly+10);
        ctx.fillStyle='hsla(220,60%,40%,0.8)';ctx.fillRect(startX+110,ly,12,12);
        ctx.fillText('PE (Potential)',startX+128,ly+10);
    }
    function drawSpk(){
        var sw=spkCv.parentElement.clientWidth,sh=40;
        spkCtx.clearRect(0,0,sw,sh);
        if(eHist.length<2)return;
        var mx=0;for(var i=0;i<eHist.length;i++)if(eHist[i]>mx)mx=eHist[i];
        if(mx<0.01)mx=1;
        spkCtx.beginPath();
        for(var j=0;j<eHist.length;j++){
            var x=(j/(eHist.length-1))*sw,y=sh-(eHist[j]/mx)*(sh-4)-2;
            if(j===0)spkCtx.moveTo(x,y);else spkCtx.lineTo(x,y);
        }
        spkCtx.strokeStyle='rgba(80,160,220,0.7)';spkCtx.lineWidth=1.5;spkCtx.stroke();
        spkCtx.lineTo(sw,sh);spkCtx.lineTo(0,sh);spkCtx.closePath();
        spkCtx.fillStyle='rgba(60,120,200,0.1)';spkCtx.fill();
    }

    function updateUI(){
        document.getElementById('st-time').textContent=S.time.toFixed(1)+'s';
        document.getElementById('st-pc').textContent=pends.length;
        if(pends.length>0){var sg=pends[0].theta>=0?1:-1;if(sg!==S.lastSign&&sg>0)S.cycleCount++;S.lastSign=sg}
        document.getElementById('st-cyc').textContent=S.cycleCount;
        var se=sysE();document.getElementById('st-ene').textContent=se.toFixed(2);
        var mv=0;for(var i=0;i<pends.length;i++){var v=Math.abs(pends[i].omega*pends[i].L*0.01);if(v>mv)mv=v}
        document.getElementById('st-vel').textContent=mv.toFixed(3);
        var ph=phaseState(),ind=document.getElementById('phi');
        ind.textContent=ph.s;ind.style.background=ph.c+'22';ind.style.color=ph.c;
        eHist.push(se);if(eHist.length>150)eHist.shift();drawSpk();
    }

    var lastT=0;
    function animate(ts){
        if(!lastT)lastT=ts;var rawDt=Math.min((ts-lastT)/1000,0.05);lastT=ts;
        if(!S.paused){
            var dt=rawDt*S.speed;S.time+=dt;stepPhys(dt);
            if(S.vizMode==='standard'||S.vizMode==='energy')for(var i=0;i<pends.length;i++)pends[i].trail=[];
        }
        ctx.fillStyle='#06060f';ctx.fillRect(0,0,W,H);drawStars();drawGrid();
        if(S.vizMode==='phase'){drawPhase()}
        else if(S.vizMode==='energy'){drawRail();drawStandard();drawEnergy()}
        else{drawRail();drawStandard()}
        updateUI();requestAnimationFrame(animate);
    }

    function updateSliders(){
        document.getElementById('s-count').value=S.count;document.getElementById('v-count').textContent=S.count;
        document.getElementById('s-grav').value=Math.round(S.gravity*10);document.getElementById('v-grav').textContent=S.gravity.toFixed(2);
        document.getElementById('s-damp').value=Math.round(S.damping*1000);document.getElementById('v-damp').textContent=S.damping.toFixed(3);
        var ad=Math.round(S.amplitude*180/Math.PI);
        document.getElementById('s-amp').value=ad;document.getElementById('v-amp').textContent=ad+'\u00B0';
        document.getElementById('s-spd').value=Math.round(S.speed*10);document.getElementById('v-spd').textContent=S.speed.toFixed(1)+'x';
        document.getElementById('s-spr').value=Math.round(S.spread*10);document.getElementById('v-spr').textContent=S.spread.toFixed(1);
        document.getElementById('preset-sel').value=S.preset;
    }

    function bindS(id,vid,parse,apply){
        document.getElementById(id).addEventListener('input',function(e){
            var v=parse(e.target.value);apply(v);
            S.preset='custom';document.getElementById('preset-sel').value='custom';save();
        });
    }
    bindS('s-count','v-count',function(v){return parseInt(v)},function(v){S.count=v;document.getElementById('v-count').textContent=v;initPendulums()});
    bindS('s-grav','v-grav',function(v){return parseInt(v)/10},function(v){S.gravity=v;document.getElementById('v-grav').textContent=v.toFixed(2)});
    bindS('s-damp','v-damp',function(v){return parseInt(v)/1000},function(v){S.damping=v;document.getElementById('v-damp').textContent=v.toFixed(3)});
    bindS('s-amp','v-amp',function(v){return parseInt(v)},function(v){S.amplitude=v*Math.PI/180;document.getElementById('v-amp').textContent=v+'\u00B0'});
    bindS('s-spd','v-spd',function(v){return parseInt(v)/10},function(v){S.speed=v;document.getElementById('v-spd').textContent=v.toFixed(1)+'x'});
    bindS('s-spr','v-spr',function(v){return parseInt(v)/10},function(v){S.spread=v;document.getElementById('v-spr').textContent=v.toFixed(1);initPendulums()});

    // Gravity presets
    document.querySelectorAll('[data-g]').forEach(function(b){
        b.addEventListener('click',function(){
            S.gravity=parseFloat(b.dataset.g);
            document.getElementById('s-grav').value=Math.round(S.gravity*10);
            document.getElementById('v-grav').textContent=S.gravity.toFixed(2);
            S.preset='custom';document.getElementById('preset-sel').value='custom';save();
        });
    });
    document.getElementById('preset-sel').addEventListener('change',function(e){if(e.target.value!=='custom')applyPreset(e.target.value)});

    // Viz mode
    document.querySelectorAll('.vm .btn').forEach(function(b){
        b.addEventListener('click',function(){
            document.querySelectorAll('.vm .btn').forEach(function(x){x.classList.remove('active')});
            b.classList.add('active');S.vizMode=b.dataset.mode;
            for(var i=0;i<pends.length;i++)pends[i].trail=[];save();
        });
    });
    document.getElementById('btn-grid').addEventListener('click',function(){S.showGrid=!S.showGrid;this.classList.toggle('active');save()});
    document.getElementById('btn-vec').addEventListener('click',function(){S.showVec=!S.showVec;this.classList.toggle('active')});

    // Actions
    document.getElementById('btn-sync').addEventListener('click',function(){
        for(var i=0;i<pends.length;i++){pends[i].theta=S.amplitude;pends[i].omega=0;pends[i].trail=[]}
        S.time=0;S.cycleCount=0;S.lastSign=1;eHist=[];
    });
    document.getElementById('btn-rand').addEventListener('click',function(){
        for(var i=0;i<pends.length;i++){pends[i].theta=(Math.random()-0.5)*S.amplitude*2;pends[i].omega=(Math.random()-0.5)*2;pends[i].trail=[]}
    });
    document.getElementById('btn-casc').addEventListener('click',function(){
        for(var i=0;i<pends.length;i++){pends[i].theta=S.amplitude*Math.cos(i*0.4);pends[i].omega=0;pends[i].trail=[]}
    });
    document.getElementById('btn-pause').addEventListener('click',function(){togPause()});

    function togPause(){
        S.paused=!S.paused;
        document.getElementById('btn-pause').textContent=S.paused?'\u25B6 Play':'\u23F8 Pause';
        document.getElementById('btn-pause').classList.toggle('active',S.paused);
        document.getElementById('pov').classList.toggle('vis',S.paused);
    }
    document.getElementById('ltog').addEventListener('click',function(){
        var c=document.getElementById('lcont'),o=c.classList.toggle('open');
        this.textContent=o?'\uD83D\uDCD6 Learn: Why Pendulum Waves Work \u25BE':'\uD83D\uDCD6 Learn: Why Pendulum Waves Work \u25B8';
    });

    // Mouse
    function cc(e){var r=cv.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top}}
    function findBob(mx,my){
        for(var i=pends.length-1;i>=0;i--){var p=bpos(i),dx=mx-p.x,dy=my-p.y;if(dx*dx+dy*dy<400)return i}return-1;
    }
    cv.addEventListener('mousedown',function(e){
        var c=cc(e);
        if(e.button===2){var idx=findBob(c.x,c.y);if(idx>=0&&pends.length>2){pends.splice(idx,1);S.count=pends.length;updateSliders();save()}return}
        var hit=findBob(c.x,c.y);
        if(hit>=0){grabbed=hit;pends[grabbed].omega=0;return}
        if(Math.abs(c.y-RY)<15&&c.x>20&&c.x<W-20&&pends.length<40){
            var avg=0;for(var i=0;i<pends.length;i++)avg+=pends[i].L;avg/=pends.length;
            pends.push({L:avg+(Math.random()-0.5)*30,theta:0,omega:0,trail:[],hue:Math.random()*270+200});
            S.count=pends.length;updateSliders();save();return;
        }
        isPan=true;panSt={x:c.x,y:c.y};panOr={x:S.panX,y:S.panY};
    });
    cv.addEventListener('mousemove',function(e){
        var c=cc(e);
        if(grabbed>=0){var pos=bpos(grabbed),dx=c.x-pos.ax,dy=c.y-pos.ay;
            grabAng=Math.atan2(dx,dy);grabAng=Math.max(-Math.PI*0.45,Math.min(Math.PI*0.45,grabAng));
            pends[grabbed].theta=grabAng;pends[grabbed].omega=0;
        }else if(isPan){S.panX=panOr.x+(c.x-panSt.x);S.panY=panOr.y+(c.y-panSt.y)}
    });
    cv.addEventListener('mouseup',function(){grabbed=-1;isPan=false});
    cv.addEventListener('mouseleave',function(){grabbed=-1;isPan=false});
    cv.addEventListener('wheel',function(e){e.preventDefault();var d=e.deltaY>0?0.95:1.05;S.zoom=Math.max(0.3,Math.min(3,S.zoom*d));save()},{passive:false});
    cv.addEventListener('contextmenu',function(e){e.preventDefault()});

    // Touch support
    cv.addEventListener('touchstart',function(e){
        if(e.touches.length===1){
            var t=e.touches[0],r=cv.getBoundingClientRect(),c={x:t.clientX-r.left,y:t.clientY-r.top};
            var hit=findBob(c.x,c.y);
            if(hit>=0){grabbed=hit;pends[grabbed].omega=0;e.preventDefault();return}
            isPan=true;panSt={x:c.x,y:c.y};panOr={x:S.panX,y:S.panY};e.preventDefault();
        }
    },{passive:false});
    cv.addEventListener('touchmove',function(e){
        if(e.touches.length===1){
            var t=e.touches[0],r=cv.getBoundingClientRect(),c={x:t.clientX-r.left,y:t.clientY-r.top};
            if(grabbed>=0){var pos=bpos(grabbed),dx=c.x-pos.ax,dy=c.y-pos.ay;
                grabAng=Math.atan2(dx,dy);grabAng=Math.max(-Math.PI*0.45,Math.min(Math.PI*0.45,grabAng));
                pends[grabbed].theta=grabAng;pends[grabbed].omega=0;
            }else if(isPan){S.panX=panOr.x+(c.x-panSt.x);S.panY=panOr.y+(c.y-panSt.y)}
            e.preventDefault();
        }
    },{passive:false});
    cv.addEventListener('touchend',function(){grabbed=-1;isPan=false});

    // Keyboard
    document.addEventListener('keydown',function(e){
        if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT')return;
        switch(e.key.toLowerCase()){
            case' ':e.preventDefault();togPause();break;
            case'r':document.getElementById('btn-sync').click();break;
            case'g':document.getElementById('btn-grid').click();break;
        }
    });

    // localStorage
    var SK='pendulumWaveLab_v2';
    function save(){
        try{localStorage.setItem(SK,JSON.stringify({preset:S.preset,gravity:S.gravity,damping:S.damping,
            count:S.count,amplitude:S.amplitude,speed:S.speed,spread:S.spread,vizMode:S.vizMode,
            showGrid:S.showGrid,zoom:S.zoom,panX:S.panX,panY:S.panY}))}catch(e){}
    }
    function load(){
        try{var r=localStorage.getItem(SK);if(!r)return false;var d=JSON.parse(r);
            if(d.preset&&PRESETS[d.preset])S.preset=d.preset;else S.preset='custom';
            if(typeof d.gravity==='number')S.gravity=d.gravity;
            if(typeof d.damping==='number')S.damping=d.damping;
            if(typeof d.count==='number')S.count=Math.max(5,Math.min(40,d.count));
            if(typeof d.amplitude==='number')S.amplitude=d.amplitude;
            if(typeof d.speed==='number')S.speed=d.speed;
            if(typeof d.spread==='number')S.spread=d.spread;
            if(typeof d.vizMode==='string')S.vizMode=d.vizMode;
            if(typeof d.showGrid==='boolean')S.showGrid=d.showGrid;
            if(typeof d.zoom==='number')S.zoom=d.zoom;
            if(typeof d.panX==='number')S.panX=d.panX;
            if(typeof d.panY==='number')S.panY=d.panY;
            return true;
        }catch(e){return false}
    }

    // Init
    resize();initStars();load();updateSliders();initPendulums();
    document.querySelectorAll('.vm .btn').forEach(function(b){b.classList.toggle('active',b.dataset.mode===S.vizMode)});
    if(S.showGrid)document.getElementById('btn-grid').classList.add('active');
    window.addEventListener('resize',function(){resize();initStars()});
    requestAnimationFrame(animate);
    })();
    </script>
</body>
</html>
