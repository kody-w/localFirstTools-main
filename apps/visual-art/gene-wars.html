<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GENE WARS: Dynasty of Beasts</title>
    <meta name="description" content="Auto-battler with creature breeding. Design creatures by splicing traits, watch them fight, breed winners, build dynasties across generations.">
    <meta name="theme-color" content="#0a0a0f">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-dark: #0a0a0f;
            --bg-mid: #12121a;
            --bg-light: #1a1a25;
            --accent: #00ff88;
            --accent-dim: #00aa55;
            --danger: #ff4466;
            --warning: #ffaa00;
            --info: #00aaff;
            --text: #e0e0e0;
            --text-dim: #888;
            --gold: #ffd700;
            --purple: #aa66ff;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(180deg, var(--bg-mid) 0%, var(--bg-dark) 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,255,136,0.2);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: 3px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--info) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-bar {
            display: flex;
            gap: 25px;
            font-size: 0.9rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-icon { font-size: 1.1rem; }
        .stat-value { color: var(--accent); font-weight: bold; }

        /* Navigation */
        nav {
            display: flex;
            gap: 5px;
            padding: 10px 20px;
            background: var(--bg-mid);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        nav button {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 0.95rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        nav button:hover { color: var(--text); background: rgba(255,255,255,0.05); }
        nav button.active { color: var(--accent); background: rgba(0,255,136,0.1); }

        /* Main Content */
        main {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .view { display: none; }
        .view.active { display: block; }

        /* Stable View */
        .stable-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .creature-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .creature-card:hover {
            transform: translateY(-3px);
            border-color: rgba(0,255,136,0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .creature-card.selected {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0,255,136,0.2);
        }

        .creature-card.champion::before {
            content: 'üëë';
            position: absolute;
            top: -10px;
            right: 10px;
            font-size: 1.5rem;
        }

        .creature-preview {
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

        .creature-canvas {
            image-rendering: pixelated;
        }

        .creature-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .generation-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            background: rgba(170,102,255,0.2);
            color: var(--purple);
            border-radius: 10px;
        }

        .creature-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin: 10px 0;
            font-size: 0.8rem;
        }

        .mini-stat {
            text-align: center;
            padding: 5px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }

        .mini-stat-label { color: var(--text-dim); font-size: 0.7rem; }
        .mini-stat-value { font-weight: bold; }

        .trait-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .trait-tag {
            font-size: 0.75rem;
            padding: 3px 8px;
            background: rgba(0,170,255,0.15);
            color: var(--info);
            border-radius: 5px;
        }

        .trait-tag.synergy {
            background: rgba(255,215,0,0.15);
            color: var(--gold);
        }

        .creature-record {
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .wins { color: var(--accent); }
        .losses { color: var(--danger); }

        /* Arena View */
        .arena-container {
            display: grid;
            grid-template-columns: 250px 1fr 250px;
            gap: 20px;
            min-height: 500px;
        }

        .arena-side {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 15px;
        }

        .arena-side h3 {
            margin-bottom: 15px;
            color: var(--text-dim);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .arena-battlefield {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            min-height: 400px;
        }

        .battlefield-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .arena-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .fight-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--danger) 0%, #cc2244 100%);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s;
        }

        .fight-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 30px rgba(255,68,102,0.4);
        }

        .fight-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .health-bar-container {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .health-bar-wrapper {
            flex: 1;
            max-width: 200px;
        }

        .health-bar-wrapper:last-child {
            text-align: right;
        }

        .health-bar-wrapper:last-child .health-bar-inner {
            margin-left: auto;
        }

        .fighter-name {
            font-size: 0.9rem;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .health-bar {
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
        }

        .health-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--danger) 0%, var(--warning) 50%, var(--accent) 100%);
            transition: width 0.3s;
            border-radius: 10px;
        }

        /* Breeding View */
        .breeding-container {
            display: grid;
            grid-template-columns: 1fr 200px 1fr;
            gap: 20px;
            align-items: start;
        }

        .parent-slot {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            border: 2px dashed rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .parent-slot.filled {
            border-style: solid;
            border-color: rgba(0,255,136,0.3);
        }

        .parent-slot.dragover {
            border-color: var(--accent);
            background: rgba(0,255,136,0.05);
        }

        .parent-label {
            color: var(--text-dim);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .breeding-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding-top: 50px;
        }

        .breed-btn {
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--purple) 0%, #8844cc 100%);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .breed-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 30px rgba(170,102,255,0.4);
        }

        .breed-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .offspring-preview {
            background: var(--bg-mid);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            min-width: 200px;
        }

        .mutation-chance {
            font-size: 0.85rem;
            color: var(--warning);
            margin-top: 10px;
        }

        /* Lab View */
        .lab-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .trait-pool {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
        }

        .trait-pool h3 {
            margin-bottom: 15px;
            color: var(--accent);
        }

        .trait-category {
            margin-bottom: 20px;
        }

        .trait-category-title {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .trait-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .trait-item {
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: help;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .trait-item:hover {
            background: rgba(0,170,255,0.1);
            border-color: rgba(0,170,255,0.3);
        }

        .trait-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .synergy-list {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 20px;
        }

        .synergy-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .synergy-formula {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .synergy-plus { color: var(--text-dim); }
        .synergy-equals { color: var(--gold); font-weight: bold; }
        .synergy-result { color: var(--gold); font-weight: bold; }

        .synergy-desc {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 5px;
        }

        /* Opponent Selection */
        .opponent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .opponent-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .opponent-card:hover { border-color: rgba(255,68,102,0.5); }
        .opponent-card.selected { border-color: var(--danger); background: rgba(255,68,102,0.1); }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            background: var(--bg-light);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn:hover { background: rgba(255,255,255,0.1); }
        .btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        .btn-primary { background: var(--accent); color: var(--bg-dark); border-color: var(--accent); }
        .btn-danger { background: var(--danger); border-color: var(--danger); }

        /* Battle Log */
        .battle-log {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.8rem;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-top: 15px;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .log-damage { color: var(--danger); }
        .log-heal { color: var(--accent); }
        .log-ability { color: var(--gold); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal {
            background: var(--bg-mid);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: var(--accent);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* Import/Export */
        .share-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .share-section textarea {
            width: 100%;
            height: 100px;
            background: var(--bg-dark);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text);
            padding: 10px;
            font-family: monospace;
            font-size: 0.8rem;
            resize: none;
            margin-top: 10px;
        }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .shake { animation: shake 0.2s ease-in-out; }
        .flash { animation: flash 0.2s ease-in-out; }

        /* Floating damage */
        .damage-number {
            position: absolute;
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 100;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(0.5); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .empty-state-icon { font-size: 4rem; margin-bottom: 20px; }

        /* Creature Detail Panel */
        .detail-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: var(--bg-mid);
            border-left: 1px solid rgba(255,255,255,0.1);
            z-index: 500;
            transition: right 0.3s;
            overflow-y: auto;
            padding: 20px;
        }

        .detail-panel.open { right: 0; }

        .detail-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .detail-creature-preview {
            text-align: center;
            padding: 30px 0;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h4 {
            color: var(--text-dim);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .stat-bar-label {
            width: 60px;
            font-size: 0.85rem;
        }

        .stat-bar-track {
            flex: 1;
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .stat-bar-fill.hp { background: var(--accent); }
        .stat-bar-fill.atk { background: var(--danger); }
        .stat-bar-fill.def { background: var(--info); }
        .stat-bar-fill.spd { background: var(--warning); }

        .stat-bar-value {
            width: 40px;
            text-align: right;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .lineage {
            font-size: 0.85rem;
            color: var(--text-dim);
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .lineage-parent {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--bg-light); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2a2a3a; }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background: var(--bg-light);
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid var(--accent);
            animation: slideIn 0.3s ease-out;
        }

        .toast.error { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Tutorial overlay */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .tutorial-content {
            max-width: 600px;
            padding: 40px;
            text-align: center;
        }

        .tutorial-content h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tutorial-content p {
            color: var(--text-dim);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .tutorial-steps {
            text-align: left;
            margin: 30px 0;
        }

        .tutorial-step {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            background: var(--accent);
            color: var(--bg-dark);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-text h4 { margin-bottom: 5px; }
        .step-text p { margin: 0; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="tutorial-overlay" id="tutorial">
        <div class="tutorial-content">
            <h1>GENE WARS</h1>
            <p>Dynasty of Beasts</p>

            <div class="tutorial-steps">
                <div class="tutorial-step">
                    <div class="step-number">1</div>
                    <div class="step-text">
                        <h4>Build Your Stable</h4>
                        <p>Collect creatures with unique genetic traits. Each trait affects combat abilities.</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">2</div>
                    <div class="step-text">
                        <h4>Fight in the Arena</h4>
                        <p>Watch your creatures battle autonomously. Winners gain glory, losers... well.</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">3</div>
                    <div class="step-text">
                        <h4>Breed Champions</h4>
                        <p>Combine traits from two parents. Discover powerful synergies and rare mutations.</p>
                    </div>
                </div>
                <div class="tutorial-step">
                    <div class="step-number">4</div>
                    <div class="step-text">
                        <h4>Build a Dynasty</h4>
                        <p>Track lineages across generations. Export your champions to challenge friends.</p>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="startGame()" style="font-size: 1.2rem; padding: 15px 40px;">
                Begin Your Legacy
            </button>
        </div>
    </div>

    <header>
        <div class="logo">GENE WARS</div>
        <div class="stats-bar">
            <div class="stat">
                <span class="stat-icon">üß¨</span>
                <span>Creatures: <span class="stat-value" id="creature-count">0</span></span>
            </div>
            <div class="stat">
                <span class="stat-icon">üèÜ</span>
                <span>Wins: <span class="stat-value" id="total-wins">0</span></span>
            </div>
            <div class="stat">
                <span class="stat-icon">üìä</span>
                <span>Generation: <span class="stat-value" id="max-generation">1</span></span>
            </div>
            <div class="stat">
                <span class="stat-icon">üíÄ</span>
                <span>Culled: <span class="stat-value" id="total-culled">0</span></span>
            </div>
        </div>
    </header>

    <nav>
        <button class="active" data-view="stable">Stable</button>
        <button data-view="arena">Arena</button>
        <button data-view="breeding">Breeding Lab</button>
        <button data-view="lab">Gene Lab</button>
        <button onclick="showImportExport()">Import/Export</button>
    </nav>

    <main>
        <!-- Stable View -->
        <div class="view active" id="stable-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Your Stable</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="generateRandomCreature()">+ Random Creature</button>
                    <button class="btn btn-danger" onclick="cullSelected()">Cull Selected</button>
                </div>
            </div>
            <div class="stable-grid" id="stable-grid">
                <div class="empty-state">
                    <div class="empty-state-icon">üß¨</div>
                    <p>Your stable is empty. Generate some creatures to begin!</p>
                </div>
            </div>
        </div>

        <!-- Arena View -->
        <div class="view" id="arena-view">
            <div class="arena-container">
                <div class="arena-side">
                    <h3>Your Fighter</h3>
                    <div id="player-fighter-slot">
                        <p style="color: var(--text-dim); font-size: 0.9rem;">Select a creature from your stable</p>
                    </div>
                    <div class="opponent-grid" id="player-creature-list"></div>
                </div>

                <div class="arena-battlefield" id="battlefield">
                    <canvas class="battlefield-canvas" id="battle-canvas"></canvas>
                    <div class="health-bar-container" id="health-bars" style="display: none;">
                        <div class="health-bar-wrapper">
                            <div class="fighter-name" id="p1-name">Player</div>
                            <div class="health-bar">
                                <div class="health-bar-inner" id="p1-health" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="health-bar-wrapper">
                            <div class="fighter-name" id="p2-name">Opponent</div>
                            <div class="health-bar">
                                <div class="health-bar-inner" id="p2-health" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="arena-controls">
                        <button class="fight-btn" id="fight-btn" onclick="startBattle()" disabled>SELECT FIGHTERS</button>
                    </div>
                </div>

                <div class="arena-side">
                    <h3>Opponent</h3>
                    <div id="opponent-fighter-slot">
                        <p style="color: var(--text-dim); font-size: 0.9rem;">Select an opponent to battle</p>
                    </div>
                    <div class="opponent-grid" id="opponent-list"></div>
                    <button class="btn" style="width: 100%; margin-top: 15px;" onclick="generateOpponents()">New Opponents</button>
                    <div class="battle-log" id="battle-log"></div>
                </div>
            </div>
        </div>

        <!-- Breeding View -->
        <div class="view" id="breeding-view">
            <h2 style="margin-bottom: 20px;">Breeding Lab</h2>
            <div class="breeding-container">
                <div class="parent-slot" id="parent1-slot" ondrop="dropParent(event, 1)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                    <div class="parent-label">Parent 1</div>
                    <p style="color: var(--text-dim);">Drag a creature here</p>
                </div>

                <div class="breeding-center">
                    <div style="font-size: 3rem;">üß¨</div>
                    <button class="breed-btn" id="breed-btn" onclick="breedCreatures()" disabled>BREED</button>
                    <div class="mutation-chance">
                        Mutation Chance: <span id="mutation-rate">15%</span>
                    </div>
                    <div class="offspring-preview" id="offspring-preview" style="display: none;">
                        <h4>Potential Offspring</h4>
                        <div id="offspring-traits"></div>
                    </div>
                </div>

                <div class="parent-slot" id="parent2-slot" ondrop="dropParent(event, 2)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                    <div class="parent-label">Parent 2</div>
                    <p style="color: var(--text-dim);">Drag a creature here</p>
                </div>
            </div>

            <h3 style="margin: 30px 0 15px;">Available for Breeding</h3>
            <div class="stable-grid" id="breeding-grid"></div>
        </div>

        <!-- Gene Lab View -->
        <div class="view" id="lab-view">
            <div class="lab-container">
                <div class="trait-pool">
                    <h3>Trait Encyclopedia</h3>

                    <div class="trait-category">
                        <div class="trait-category-title">Physical</div>
                        <div class="trait-grid" id="physical-traits"></div>
                    </div>

                    <div class="trait-category">
                        <div class="trait-category-title">Abilities</div>
                        <div class="trait-grid" id="ability-traits"></div>
                    </div>

                    <div class="trait-category">
                        <div class="trait-category-title">Elements</div>
                        <div class="trait-grid" id="element-traits"></div>
                    </div>
                </div>

                <div class="synergy-list">
                    <h3 style="margin-bottom: 20px; color: var(--gold);">Discovered Synergies</h3>
                    <p style="color: var(--text-dim); margin-bottom: 20px; font-size: 0.9rem;">
                        When certain traits combine, they create powerful synergy abilities!
                    </p>
                    <div id="synergy-list"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detail-panel">
        <button class="detail-close" onclick="closeDetailPanel()">√ó</button>
        <div id="detail-content"></div>
    </div>

    <!-- Import/Export Modal -->
    <div class="modal-overlay" id="import-export-modal">
        <div class="modal">
            <h2>Import / Export</h2>

            <div class="share-section">
                <h4>Export Creature</h4>
                <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 10px;">
                    Select a creature to export, then share the code with friends.
                </p>
                <select id="export-creature-select" style="width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid rgba(255,255,255,0.1); border-radius: 5px; color: var(--text);">
                    <option value="">Select a creature...</option>
                </select>
                <textarea id="export-code" readonly placeholder="Creature code will appear here..."></textarea>
                <button class="btn" onclick="copyExportCode()" style="margin-top: 10px;">Copy Code</button>
            </div>

            <div class="share-section">
                <h4>Import Creature</h4>
                <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 10px;">
                    Paste a creature code to add it to your stable.
                </p>
                <textarea id="import-code" placeholder="Paste creature code here..."></textarea>
                <button class="btn btn-primary" onclick="importCreature()" style="margin-top: 10px;">Import</button>
            </div>

            <div class="share-section">
                <h4>Full Save</h4>
                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="exportFullSave()">Export All Data</button>
                    <button class="btn" onclick="document.getElementById('import-file').click()">Import Save File</button>
                    <input type="file" id="import-file" accept=".json" onchange="importFullSave(event)" style="display: none;">
                </div>
            </div>

            <div class="share-section" style="border-color: var(--danger);">
                <h4 style="color: var(--danger);">Danger Zone</h4>
                <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 10px;">
                    If storage is full, export your save first, then clear data.
                </p>
                <button class="btn btn-danger" onclick="clearAllStorage()">Clear All Data</button>
            </div>

            <div class="modal-actions">
                <button class="btn" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container" role="status" aria-live="polite" aria-atomic="false"></div>

    <script>
        // ==================== GAME STATE ====================
        const state = {
            creatures: [],
            opponents: [],
            selectedCreature: null,
            selectedOpponent: null,
            parent1: null,
            parent2: null,
            battleInProgress: false,
            stats: {
                totalWins: 0,
                totalCulled: 0,
                maxGeneration: 1,
                discoveredSynergies: []
            }
        };

        // ==================== TRAIT SYSTEM ====================
        const TRAITS = {
            physical: {
                claws: { name: 'Claws', desc: '+15% attack damage', stat: 'atk', mod: 1.15, icon: 'ü¶∑' },
                shell: { name: 'Shell', desc: '+20% defense', stat: 'def', mod: 1.20, icon: 'üêö' },
                wings: { name: 'Wings', desc: '+25% speed', stat: 'spd', mod: 1.25, icon: 'ü¶ã' },
                fangs: { name: 'Fangs', desc: '+10% attack, lifesteal on hit', stat: 'atk', mod: 1.10, icon: 'ü¶∑', ability: 'lifesteal' },
                spikes: { name: 'Spikes', desc: 'Reflect 15% damage taken', stat: 'def', mod: 1.05, icon: 'ü¶î', ability: 'reflect' },
                bulk: { name: 'Bulk', desc: '+30% HP', stat: 'hp', mod: 1.30, icon: 'üí™' },
                agile: { name: 'Agile', desc: '+20% speed, +10% dodge', stat: 'spd', mod: 1.20, icon: 'üêá', ability: 'dodge' },
                armored: { name: 'Armored', desc: '+25% defense, -10% speed', stat: 'def', mod: 1.25, icon: 'üõ°Ô∏è', debuff: { stat: 'spd', mod: 0.9 } }
            },
            abilities: {
                regen: { name: 'Regeneration', desc: 'Heal 3% HP per turn', icon: 'üíö', ability: 'regen' },
                berserk: { name: 'Berserker', desc: '+50% attack when below 30% HP', icon: 'üò§', ability: 'berserk' },
                venom: { name: 'Venomous', desc: 'Attacks poison for 5% HP/turn', icon: 'üêç', ability: 'poison' },
                swift: { name: 'Swift Strike', desc: '20% chance for double attack', icon: '‚ö°', ability: 'doubleStrike' },
                tough: { name: 'Tough Hide', desc: 'Reduce all damage by 5', icon: 'ü™®', ability: 'flatReduce' },
                frenzy: { name: 'Frenzy', desc: '+5% attack per hit landed', icon: 'üî•', ability: 'frenzy' }
            },
            elements: {
                fire: { name: 'Fire', desc: '+20% attack, weak to water', icon: 'üî•', stat: 'atk', mod: 1.20, weakness: 'water' },
                water: { name: 'Water', desc: '+15% HP, weak to electric', icon: 'üíß', stat: 'hp', mod: 1.15, weakness: 'electric' },
                electric: { name: 'Electric', desc: '+30% speed, weak to fire', icon: '‚ö°', stat: 'spd', mod: 1.30, weakness: 'fire' },
                shadow: { name: 'Shadow', desc: '+15% dodge, +10% attack', icon: 'üåë', stat: 'atk', mod: 1.10, ability: 'shadowDodge' },
                nature: { name: 'Nature', desc: 'Enhanced regeneration', icon: 'üåø', ability: 'enhancedRegen' }
            }
        };

        const SYNERGIES = [
            { traits: ['wings', 'spikes'], name: 'Dive Bomb', desc: 'First attack deals 2x damage', icon: 'üí•' },
            { traits: ['shell', 'spikes'], name: 'Counter', desc: 'Reflect 30% damage instead of 15%', icon: 'üîÑ' },
            { traits: ['fangs', 'berserk'], name: 'Blood Frenzy', desc: 'Lifesteal doubles when below 30% HP', icon: 'ü©∏' },
            { traits: ['agile', 'swift'], name: 'Blur', desc: '40% dodge chance, guaranteed double on crit', icon: 'üí®' },
            { traits: ['bulk', 'regen'], name: 'Titan', desc: 'Regenerate 6% HP per turn', icon: 'üèîÔ∏è' },
            { traits: ['fire', 'berserk'], name: 'Inferno', desc: 'Below 30% HP: attacks burn all enemies', icon: 'üåã' },
            { traits: ['venom', 'fangs'], name: 'Necrosis', desc: 'Poison deals 10% HP/turn', icon: '‚ò†Ô∏è' },
            { traits: ['shadow', 'agile'], name: 'Phase', desc: 'First 2 attacks always miss', icon: 'üëª' },
            { traits: ['electric', 'swift'], name: 'Lightning', desc: '50% triple attack chance', icon: 'üå©Ô∏è' },
            { traits: ['armored', 'tough'], name: 'Fortress', desc: 'Reduce all damage by 15, +10% HP', icon: 'üè∞' },
            { traits: ['nature', 'regen'], name: 'Eternal', desc: 'Revive once with 25% HP', icon: 'üå≥' },
            { traits: ['water', 'shell'], name: 'Tidal', desc: 'Damage reduction scales with missing HP', icon: 'üåä' }
        ];

        // ==================== CREATURE GENERATION ====================
        const NAMES_PREFIX = ['Shadow', 'Crimson', 'Azure', 'Golden', 'Void', 'Storm', 'Frost', 'Ember', 'Toxic', 'Iron', 'Crystal', 'Phantom', 'Thunder', 'Savage', 'Ancient', 'Primal', 'Chaos', 'Doom', 'Mystic', 'Feral'];
        const NAMES_SUFFIX = ['Fang', 'Claw', 'Wing', 'Scale', 'Horn', 'Tail', 'Maw', 'Eye', 'Heart', 'Soul', 'Bane', 'Fury', 'Rage', 'Storm', 'Drake', 'Beast', 'Wyrm', 'Fiend', 'Hunter', 'Stalker'];

        function generateName() {
            return NAMES_PREFIX[Math.floor(Math.random() * NAMES_PREFIX.length)] +
                   NAMES_SUFFIX[Math.floor(Math.random() * NAMES_SUFFIX.length)];
        }

        function generateCreatureId() {
            return 'c_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function getRandomTraits(count = 3) {
            const allTraits = [];
            for (const category in TRAITS) {
                for (const trait in TRAITS[category]) {
                    allTraits.push(trait);
                }
            }

            const selected = [];
            const shuffled = allTraits.sort(() => Math.random() - 0.5);

            for (let i = 0; i < Math.min(count, shuffled.length); i++) {
                if (!selected.includes(shuffled[i])) {
                    selected.push(shuffled[i]);
                }
            }

            return selected;
        }

        function calculateStats(traits) {
            let stats = { hp: 100, atk: 20, def: 10, spd: 10 };

            for (const traitName of traits) {
                const trait = getTraitData(traitName);
                if (trait && trait.stat) {
                    stats[trait.stat] = Math.floor(stats[trait.stat] * trait.mod);
                }
                if (trait && trait.debuff) {
                    stats[trait.debuff.stat] = Math.floor(stats[trait.debuff.stat] * trait.debuff.mod);
                }
            }

            return stats;
        }

        function getTraitData(traitName) {
            for (const category in TRAITS) {
                if (TRAITS[category][traitName]) {
                    return TRAITS[category][traitName];
                }
            }
            return null;
        }

        function getTraitCategory(traitName) {
            for (const category in TRAITS) {
                if (TRAITS[category][traitName]) {
                    return category;
                }
            }
            return null;
        }

        function getSynergies(traits) {
            const synergies = [];
            for (const synergy of SYNERGIES) {
                if (synergy.traits.every(t => traits.includes(t))) {
                    synergies.push(synergy);
                    if (!state.stats.discoveredSynergies.includes(synergy.name)) {
                        state.stats.discoveredSynergies.push(synergy.name);
                        showToast(`New synergy discovered: ${synergy.name}!`, 'warning');
                    }
                }
            }
            return synergies;
        }

        function generateCreature(traits = null, generation = 1, parents = null) {
            const creatureTraits = traits || getRandomTraits(2 + Math.floor(Math.random() * 2));
            const stats = calculateStats(creatureTraits);

            return {
                id: generateCreatureId(),
                name: generateName(),
                traits: creatureTraits,
                synergies: getSynergies(creatureTraits),
                stats: stats,
                baseStats: { ...stats },
                generation: generation,
                parents: parents,
                wins: 0,
                losses: 0,
                created: Date.now(),
                color: generateCreatureColor(creatureTraits)
            };
        }

        function generateCreatureColor(traits) {
            // Color based on traits
            if (traits.includes('fire')) return { primary: '#ff4444', secondary: '#ff8800' };
            if (traits.includes('water')) return { primary: '#4488ff', secondary: '#00ccff' };
            if (traits.includes('electric')) return { primary: '#ffff00', secondary: '#ffaa00' };
            if (traits.includes('shadow')) return { primary: '#6600aa', secondary: '#220044' };
            if (traits.includes('nature')) return { primary: '#44aa44', secondary: '#88ff88' };

            // Random otherwise
            const hue = Math.floor(Math.random() * 360);
            return {
                primary: `hsl(${hue}, 70%, 50%)`,
                secondary: `hsl(${(hue + 30) % 360}, 60%, 40%)`
            };
        }

        function generateRandomCreature() {
            const creature = generateCreature();
            state.creatures.push(creature);
            saveState();
            renderStable();
            showToast(`${creature.name} joined your stable!`);
        }

        // ==================== CREATURE RENDERING ====================
        function renderCreatureCanvas(creature, size = 100) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            canvas.className = 'creature-canvas';
            const ctx = canvas.getContext('2d');

            // Background glow
            const gradient = ctx.createRadialGradient(size/2, size/2, 0, size/2, size/2, size/2);
            gradient.addColorStop(0, creature.color.primary + '40');
            gradient.addColorStop(1, 'transparent');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, size, size);

            // Body
            ctx.fillStyle = creature.color.primary;
            ctx.beginPath();

            const bodyType = creature.traits.includes('bulk') ? 'large' :
                           creature.traits.includes('agile') ? 'slim' : 'normal';

            if (bodyType === 'large') {
                ctx.ellipse(size/2, size/2 + 5, size/3, size/2.5, 0, 0, Math.PI * 2);
            } else if (bodyType === 'slim') {
                ctx.ellipse(size/2, size/2, size/5, size/2.5, 0, 0, Math.PI * 2);
            } else {
                ctx.ellipse(size/2, size/2, size/4, size/3, 0, 0, Math.PI * 2);
            }
            ctx.fill();

            // Shell
            if (creature.traits.includes('shell') || creature.traits.includes('armored')) {
                ctx.strokeStyle = creature.color.secondary;
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(size/2, size/2, size/3, Math.PI * 0.8, Math.PI * 2.2);
                ctx.stroke();
            }

            // Wings
            if (creature.traits.includes('wings')) {
                ctx.fillStyle = creature.color.secondary + 'aa';
                ctx.beginPath();
                ctx.ellipse(size/4, size/3, size/6, size/4, -0.5, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(size * 3/4, size/3, size/6, size/4, 0.5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Spikes
            if (creature.traits.includes('spikes')) {
                ctx.fillStyle = '#444';
                for (let i = 0; i < 5; i++) {
                    const angle = (Math.PI * 0.3) + (i * Math.PI * 0.28);
                    const x = size/2 + Math.cos(angle) * size/3;
                    const y = size/2 + Math.sin(angle) * size/3;
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x + Math.cos(angle) * 10, y + Math.sin(angle) * 10);
                    ctx.lineTo(x + Math.cos(angle + 0.5) * 5, y + Math.sin(angle + 0.5) * 5);
                    ctx.fill();
                }
            }

            // Eyes
            ctx.fillStyle = '#fff';
            const eyeY = size/2 - 5;
            ctx.beginPath();
            ctx.arc(size/2 - 10, eyeY, 6, 0, Math.PI * 2);
            ctx.arc(size/2 + 10, eyeY, 6, 0, Math.PI * 2);
            ctx.fill();

            // Pupils
            ctx.fillStyle = '#111';
            ctx.beginPath();
            ctx.arc(size/2 - 8, eyeY, 3, 0, Math.PI * 2);
            ctx.arc(size/2 + 12, eyeY, 3, 0, Math.PI * 2);
            ctx.fill();

            // Claws/Fangs
            if (creature.traits.includes('claws') || creature.traits.includes('fangs')) {
                ctx.fillStyle = '#eee';
                ctx.beginPath();
                ctx.moveTo(size/2 - 8, size/2 + 15);
                ctx.lineTo(size/2 - 5, size/2 + 25);
                ctx.lineTo(size/2 - 2, size/2 + 15);
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(size/2 + 8, size/2 + 15);
                ctx.lineTo(size/2 + 5, size/2 + 25);
                ctx.lineTo(size/2 + 2, size/2 + 15);
                ctx.fill();
            }

            // Element effects
            if (creature.traits.includes('fire')) {
                ctx.fillStyle = '#ff4400';
                for (let i = 0; i < 5; i++) {
                    ctx.beginPath();
                    ctx.arc(
                        size/2 + (Math.random() - 0.5) * 30,
                        size/4 + Math.random() * 10,
                        3 + Math.random() * 3,
                        0, Math.PI * 2
                    );
                    ctx.fill();
                }
            }

            if (creature.traits.includes('electric')) {
                ctx.strokeStyle = '#ffff00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(size/2, 5);
                ctx.lineTo(size/2 + 5, 15);
                ctx.lineTo(size/2 - 5, 25);
                ctx.lineTo(size/2 + 3, 35);
                ctx.stroke();
            }

            return canvas;
        }

        // ==================== UI RENDERING ====================
        function renderStable() {
            const grid = document.getElementById('stable-grid');

            if (state.creatures.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üß¨</div>
                        <p>Your stable is empty. Generate some creatures to begin!</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = state.creatures.map(creature => `
                <div class="creature-card ${creature.wins >= 5 ? 'champion' : ''} ${state.selectedCreature?.id === creature.id ? 'selected' : ''}"
                     onclick="selectCreature('${creature.id}')"
                     draggable="true"
                     ondragstart="dragCreature(event, '${creature.id}')">
                    <div class="creature-preview" id="preview-${creature.id}"></div>
                    <div class="creature-name">
                        ${creature.name}
                        <span class="generation-badge">Gen ${creature.generation}</span>
                    </div>
                    <div class="creature-stats">
                        <div class="mini-stat">
                            <div class="mini-stat-label">HP</div>
                            <div class="mini-stat-value" style="color: var(--accent)">${creature.stats.hp}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-label">ATK</div>
                            <div class="mini-stat-value" style="color: var(--danger)">${creature.stats.atk}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-label">DEF</div>
                            <div class="mini-stat-value" style="color: var(--info)">${creature.stats.def}</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-label">SPD</div>
                            <div class="mini-stat-value" style="color: var(--warning)">${creature.stats.spd}</div>
                        </div>
                    </div>
                    <div class="trait-list">
                        ${creature.traits.map(t => {
                            const data = getTraitData(t);
                            return `<span class="trait-tag" title="${data?.desc || ''}">${data?.icon || ''} ${data?.name || t}</span>`;
                        }).join('')}
                        ${creature.synergies.map(s => `<span class="trait-tag synergy" title="${s.desc}">${s.icon} ${s.name}</span>`).join('')}
                    </div>
                    <div class="creature-record">
                        Record: <span class="wins">${creature.wins}W</span> / <span class="losses">${creature.losses}L</span>
                    </div>
                </div>
            `).join('');

            // Render creature previews
            state.creatures.forEach(creature => {
                const container = document.getElementById(`preview-${creature.id}`);
                if (container) {
                    container.innerHTML = '';
                    container.appendChild(renderCreatureCanvas(creature, 100));
                }
            });

            updateStats();
        }

        function selectCreature(id) {
            const creature = state.creatures.find(c => c.id === id);
            if (creature) {
                state.selectedCreature = creature;
                showDetailPanel(creature);
                renderStable();
            }
        }

        function showDetailPanel(creature) {
            const panel = document.getElementById('detail-panel');
            const content = document.getElementById('detail-content');

            content.innerHTML = `
                <div class="detail-creature-preview" id="detail-preview"></div>
                <h3 style="text-align: center; margin-bottom: 5px;">${creature.name}</h3>
                <p style="text-align: center; color: var(--text-dim); margin-bottom: 20px;">Generation ${creature.generation}</p>

                <div class="detail-section">
                    <h4>Stats</h4>
                    <div class="stat-bar">
                        <span class="stat-bar-label">HP</span>
                        <div class="stat-bar-track">
                            <div class="stat-bar-fill hp" style="width: ${Math.min(100, creature.stats.hp / 2)}%"></div>
                        </div>
                        <span class="stat-bar-value">${creature.stats.hp}</span>
                    </div>
                    <div class="stat-bar">
                        <span class="stat-bar-label">Attack</span>
                        <div class="stat-bar-track">
                            <div class="stat-bar-fill atk" style="width: ${Math.min(100, creature.stats.atk * 2)}%"></div>
                        </div>
                        <span class="stat-bar-value">${creature.stats.atk}</span>
                    </div>
                    <div class="stat-bar">
                        <span class="stat-bar-label">Defense</span>
                        <div class="stat-bar-track">
                            <div class="stat-bar-fill def" style="width: ${Math.min(100, creature.stats.def * 3)}%"></div>
                        </div>
                        <span class="stat-bar-value">${creature.stats.def}</span>
                    </div>
                    <div class="stat-bar">
                        <span class="stat-bar-label">Speed</span>
                        <div class="stat-bar-track">
                            <div class="stat-bar-fill spd" style="width: ${Math.min(100, creature.stats.spd * 3)}%"></div>
                        </div>
                        <span class="stat-bar-value">${creature.stats.spd}</span>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>Traits</h4>
                    <div class="trait-list">
                        ${creature.traits.map(t => {
                            const data = getTraitData(t);
                            return `<span class="trait-tag">${data?.icon || ''} ${data?.name || t}</span>`;
                        }).join('')}
                    </div>
                </div>

                ${creature.synergies.length > 0 ? `
                <div class="detail-section">
                    <h4>Synergies</h4>
                    <div class="trait-list">
                        ${creature.synergies.map(s => `<span class="trait-tag synergy">${s.icon} ${s.name}</span>`).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="detail-section">
                    <h4>Battle Record</h4>
                    <p style="font-size: 1.5rem; text-align: center;">
                        <span class="wins">${creature.wins}</span> - <span class="losses">${creature.losses}</span>
                    </p>
                </div>

                ${creature.parents ? `
                <div class="detail-section">
                    <h4>Lineage</h4>
                    <div class="lineage">
                        <div class="lineage-parent">Parent 1: ${creature.parents.parent1Name}</div>
                        <div class="lineage-parent">Parent 2: ${creature.parents.parent2Name}</div>
                    </div>
                </div>
                ` : ''}

                <div style="margin-top: 20px;">
                    <button class="btn btn-danger" style="width: 100%;" onclick="cullCreature('${creature.id}')">
                        Cull Creature
                    </button>
                </div>
            `;

            const preview = document.getElementById('detail-preview');
            preview.appendChild(renderCreatureCanvas(creature, 150));

            panel.classList.add('open');
        }

        function closeDetailPanel() {
            document.getElementById('detail-panel').classList.remove('open');
            state.selectedCreature = null;
            renderStable();
        }

        function cullCreature(id) {
            const index = state.creatures.findIndex(c => c.id === id);
            if (index !== -1) {
                const name = state.creatures[index].name;
                state.creatures.splice(index, 1);
                state.stats.totalCulled++;
                closeDetailPanel();
                saveState();
                renderStable();
                showToast(`${name} has been culled.`, 'error');
            }
        }

        function cullSelected() {
            if (!state.selectedCreature) {
                showToast('No creature selected', 'error');
                return;
            }
            cullCreature(state.selectedCreature.id);
        }

        // ==================== ARENA ====================
        function renderArena() {
            // Render player creature list
            const playerList = document.getElementById('player-creature-list');
            playerList.innerHTML = state.creatures.map(c => `
                <div class="opponent-card ${state.selectedCreature?.id === c.id ? 'selected' : ''}"
                     onclick="selectPlayerFighter('${c.id}')">
                    <div style="font-weight: bold; margin-bottom: 5px;">${c.name}</div>
                    <div style="font-size: 0.75rem; color: var(--text-dim);">
                        ${c.stats.hp} HP | ${c.stats.atk} ATK
                    </div>
                </div>
            `).join('');

            // Render opponent list
            const opponentList = document.getElementById('opponent-list');
            opponentList.innerHTML = state.opponents.map(c => `
                <div class="opponent-card ${state.selectedOpponent?.id === c.id ? 'selected' : ''}"
                     onclick="selectOpponent('${c.id}')">
                    <div style="font-weight: bold; margin-bottom: 5px;">${c.name}</div>
                    <div style="font-size: 0.75rem; color: var(--text-dim);">
                        ${c.stats.hp} HP | ${c.stats.atk} ATK
                    </div>
                </div>
            `).join('');

            updateFightButton();
        }

        function selectPlayerFighter(id) {
            const creature = state.creatures.find(c => c.id === id);
            if (creature) {
                state.selectedCreature = creature;
                const slot = document.getElementById('player-fighter-slot');
                slot.innerHTML = '';
                slot.appendChild(renderCreatureCanvas(creature, 80));
                slot.innerHTML += `<div style="margin-top: 10px; font-weight: bold;">${creature.name}</div>`;
                renderArena();
            }
        }

        function selectOpponent(id) {
            const creature = state.opponents.find(c => c.id === id);
            if (creature) {
                state.selectedOpponent = creature;
                const slot = document.getElementById('opponent-fighter-slot');
                slot.innerHTML = '';
                slot.appendChild(renderCreatureCanvas(creature, 80));
                slot.innerHTML += `<div style="margin-top: 10px; font-weight: bold;">${creature.name}</div>`;
                renderArena();
            }
        }

        function generateOpponents() {
            state.opponents = [];
            const avgStats = state.creatures.length > 0
                ? state.creatures.reduce((sum, c) => sum + c.stats.hp + c.stats.atk, 0) / state.creatures.length / 2
                : 60;

            for (let i = 0; i < 4; i++) {
                const traits = getRandomTraits(2 + Math.floor(Math.random() * 2));
                const creature = generateCreature(traits);
                // Scale opponent difficulty
                const scale = 0.8 + Math.random() * 0.4;
                creature.stats.hp = Math.floor(creature.stats.hp * scale);
                creature.stats.atk = Math.floor(creature.stats.atk * scale);
                state.opponents.push(creature);
            }

            renderArena();
        }

        function updateFightButton() {
            const btn = document.getElementById('fight-btn');
            if (state.selectedCreature && state.selectedOpponent && !state.battleInProgress) {
                btn.disabled = false;
                btn.textContent = 'FIGHT!';
            } else if (state.battleInProgress) {
                btn.disabled = true;
                btn.textContent = 'BATTLING...';
            } else {
                btn.disabled = true;
                btn.textContent = 'SELECT FIGHTERS';
            }
        }

        // ==================== BATTLE SYSTEM ====================
        async function startBattle() {
            if (!state.selectedCreature || !state.selectedOpponent || state.battleInProgress) return;

            state.battleInProgress = true;
            updateFightButton();

            // Clone creatures for battle
            const fighter1 = {
                ...state.selectedCreature,
                currentHp: state.selectedCreature.stats.hp,
                maxHp: state.selectedCreature.stats.hp,
                effects: [],
                frenzyStacks: 0,
                hasRevived: false,
                phaseCharges: state.selectedCreature.synergies.some(s => s.name === 'Phase') ? 2 : 0,
                firstAttack: true
            };

            const fighter2 = {
                ...state.selectedOpponent,
                currentHp: state.selectedOpponent.stats.hp,
                maxHp: state.selectedOpponent.stats.hp,
                effects: [],
                frenzyStacks: 0,
                hasRevived: false,
                phaseCharges: 0,
                firstAttack: true
            };

            // Show health bars
            document.getElementById('health-bars').style.display = 'flex';
            document.getElementById('p1-name').textContent = fighter1.name;
            document.getElementById('p2-name').textContent = fighter2.name;

            // Clear battle log
            const log = document.getElementById('battle-log');
            log.innerHTML = '';

            // Start battle
            await runBattle(fighter1, fighter2, log);
        }

        async function runBattle(f1, f2, log) {
            const canvas = document.getElementById('battle-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;

            let turn = 0;
            const maxTurns = 50;

            // Determine who goes first based on speed
            let attacker = f1.stats.spd >= f2.stats.spd ? f1 : f2;
            let defender = attacker === f1 ? f2 : f1;

            while (f1.currentHp > 0 && f2.currentHp > 0 && turn < maxTurns) {
                turn++;

                // Process turn
                await processTurn(attacker, defender, log, ctx, canvas);

                // Check for death/revival
                if (defender.currentHp <= 0) {
                    if (canRevive(defender)) {
                        defender.currentHp = Math.floor(defender.maxHp * 0.25);
                        defender.hasRevived = true;
                        addLogEntry(log, `${defender.name} revives with Eternal!`, 'log-heal');
                    } else {
                        break;
                    }
                }

                // Swap attacker/defender
                [attacker, defender] = [defender, attacker];

                // Update health bars
                updateHealthBars(f1, f2);

                await delay(400);
            }

            // Determine winner
            const winner = f1.currentHp > 0 ? f1 : f2;
            const loser = winner === f1 ? f2 : f1;

            addLogEntry(log, `${winner.name} WINS!`, 'log-ability');

            // Update records
            if (winner.id === state.selectedCreature.id) {
                state.selectedCreature.wins++;
                state.stats.totalWins++;
                showToast(`${winner.name} is victorious!`, 'success');
            } else {
                state.selectedCreature.losses++;
                showToast(`${state.selectedCreature.name} was defeated...`, 'error');
            }

            // Remove defeated opponent from pool
            const oppIndex = state.opponents.findIndex(o => o.id === state.selectedOpponent.id);
            if (oppIndex !== -1) {
                state.opponents.splice(oppIndex, 1);
            }

            state.battleInProgress = false;
            state.selectedOpponent = null;
            document.getElementById('opponent-fighter-slot').innerHTML = '<p style="color: var(--text-dim); font-size: 0.9rem;">Select an opponent to battle</p>';

            saveState();
            renderArena();
            updateFightButton();
        }

        async function processTurn(attacker, defender, log, ctx, canvas) {
            // Apply effects (poison, regen)
            await processEffects(attacker, log);

            if (attacker.currentHp <= 0) return;

            // Check for dodge
            const dodgeChance = calculateDodgeChance(defender);
            if (Math.random() < dodgeChance && attacker.phaseCharges <= 0) {
                addLogEntry(log, `${defender.name} dodges!`, 'log-heal');
                return;
            }

            // Phase charges
            if (defender.phaseCharges > 0) {
                defender.phaseCharges--;
                addLogEntry(log, `${defender.name} phases through the attack!`, 'log-heal');
                return;
            }

            // Calculate damage
            let damage = calculateDamage(attacker, defender);

            // Dive Bomb (first attack 2x)
            if (attacker.firstAttack && attacker.synergies.some(s => s.name === 'Dive Bomb')) {
                damage *= 2;
                addLogEntry(log, `${attacker.name} uses DIVE BOMB!`, 'log-ability');
            }
            attacker.firstAttack = false;

            // Berserk
            if (attacker.currentHp / attacker.maxHp < 0.3 && hasTrait(attacker, 'berserk')) {
                damage = Math.floor(damage * 1.5);
                addLogEntry(log, `${attacker.name} goes BERSERK!`, 'log-ability');
            }

            // Frenzy stacks
            if (hasTrait(attacker, 'frenzy')) {
                damage = Math.floor(damage * (1 + attacker.frenzyStacks * 0.05));
                attacker.frenzyStacks++;
            }

            // Apply damage
            defender.currentHp = Math.max(0, defender.currentHp - damage);
            addLogEntry(log, `${attacker.name} deals ${damage} damage!`, 'log-damage');

            // Show floating damage
            showFloatingDamage(canvas, defender === state.selectedCreature ? 150 : canvas.width - 150, 200, damage);

            // Reflect damage (Spikes/Counter)
            const reflectPercent = attacker.synergies.some(s => s.name === 'Counter') ? 0.30 :
                                  hasTrait(defender, 'spikes') ? 0.15 : 0;
            if (reflectPercent > 0) {
                const reflected = Math.floor(damage * reflectPercent);
                attacker.currentHp = Math.max(0, attacker.currentHp - reflected);
                addLogEntry(log, `${attacker.name} takes ${reflected} reflected damage!`, 'log-damage');
            }

            // Lifesteal
            if (hasTrait(attacker, 'fangs')) {
                let healAmount = Math.floor(damage * 0.15);
                if (attacker.synergies.some(s => s.name === 'Blood Frenzy') && attacker.currentHp / attacker.maxHp < 0.3) {
                    healAmount *= 2;
                }
                attacker.currentHp = Math.min(attacker.maxHp, attacker.currentHp + healAmount);
                addLogEntry(log, `${attacker.name} heals ${healAmount} HP!`, 'log-heal');
            }

            // Poison
            if (hasTrait(attacker, 'venom')) {
                const poisonDamage = attacker.synergies.some(s => s.name === 'Necrosis') ? 0.10 : 0.05;
                defender.effects.push({ type: 'poison', damage: poisonDamage, duration: 3 });
                addLogEntry(log, `${defender.name} is poisoned!`, 'log-ability');
            }

            // Double/Triple strike
            let extraStrikes = 0;
            if (hasTrait(attacker, 'swift') && Math.random() < 0.2) extraStrikes = 1;
            if (attacker.synergies.some(s => s.name === 'Lightning') && Math.random() < 0.5) extraStrikes = 2;
            if (attacker.synergies.some(s => s.name === 'Blur') && Math.random() < 0.3) extraStrikes = 1;

            for (let i = 0; i < extraStrikes; i++) {
                await delay(200);
                const extraDamage = calculateDamage(attacker, defender);
                defender.currentHp = Math.max(0, defender.currentHp - extraDamage);
                addLogEntry(log, `${attacker.name} strikes again for ${extraDamage}!`, 'log-damage');
            }

            // Animate hit
            drawBattleScene(ctx, canvas, attacker, defender, true);
        }

        async function processEffects(creature, log) {
            // Regeneration
            if (hasTrait(creature, 'regen')) {
                let healPercent = creature.synergies.some(s => s.name === 'Titan') ? 0.06 : 0.03;
                if (hasTrait(creature, 'nature')) healPercent *= 1.5;
                const heal = Math.floor(creature.maxHp * healPercent);
                creature.currentHp = Math.min(creature.maxHp, creature.currentHp + heal);
                addLogEntry(log, `${creature.name} regenerates ${heal} HP`, 'log-heal');
            }

            // Process poison/other effects
            for (let i = creature.effects.length - 1; i >= 0; i--) {
                const effect = creature.effects[i];
                if (effect.type === 'poison') {
                    const damage = Math.floor(creature.maxHp * effect.damage);
                    creature.currentHp = Math.max(0, creature.currentHp - damage);
                    addLogEntry(log, `${creature.name} takes ${damage} poison damage`, 'log-damage');
                    effect.duration--;
                    if (effect.duration <= 0) {
                        creature.effects.splice(i, 1);
                    }
                }
            }
        }

        function calculateDamage(attacker, defender) {
            let baseDamage = attacker.stats.atk;

            // Defense reduction
            let defense = defender.stats.def;
            if (hasTrait(defender, 'tough')) {
                baseDamage -= 5;
            }
            if (defender.synergies.some(s => s.name === 'Fortress')) {
                baseDamage -= 15;
            }

            // Tidal synergy
            if (defender.synergies.some(s => s.name === 'Tidal')) {
                const missingHpPercent = 1 - (defender.currentHp / defender.maxHp);
                defense += Math.floor(defense * missingHpPercent * 0.5);
            }

            // Element weakness
            const attackerElement = getElement(attacker);
            const defenderElement = getElement(defender);
            if (attackerElement && defenderElement) {
                const weaknesses = { fire: 'electric', water: 'fire', electric: 'water' };
                if (weaknesses[defenderElement] === attackerElement) {
                    baseDamage = Math.floor(baseDamage * 1.5);
                }
            }

            const damage = Math.max(1, Math.floor(baseDamage * (100 / (100 + defense))));
            return damage + Math.floor(Math.random() * 5) - 2; // Small variance
        }

        function calculateDodgeChance(creature) {
            let chance = 0;
            if (hasTrait(creature, 'agile')) chance += 0.10;
            if (hasTrait(creature, 'shadow')) chance += 0.15;
            if (creature.synergies.some(s => s.name === 'Blur')) chance = 0.40;
            return chance;
        }

        function canRevive(creature) {
            return creature.synergies.some(s => s.name === 'Eternal') && !creature.hasRevived;
        }

        function hasTrait(creature, traitName) {
            return creature.traits.includes(traitName);
        }

        function getElement(creature) {
            const elements = ['fire', 'water', 'electric', 'shadow', 'nature'];
            return creature.traits.find(t => elements.includes(t));
        }

        function updateHealthBars(f1, f2) {
            document.getElementById('p1-health').style.width = `${(f1.currentHp / f1.maxHp) * 100}%`;
            document.getElementById('p2-health').style.width = `${(f2.currentHp / f2.maxHp) * 100}%`;
        }

        function drawBattleScene(ctx, canvas, attacker, defender, hit = false) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw fighters
            const c1 = renderCreatureCanvas(attacker, 100);
            const c2 = renderCreatureCanvas(defender, 100);

            ctx.drawImage(c1, 100, canvas.height/2 - 50);

            if (hit) {
                ctx.save();
                ctx.translate(canvas.width - 200, canvas.height/2 - 50);
                ctx.translate(50, 50);
                ctx.rotate(Math.random() * 0.2 - 0.1);
                ctx.translate(-50, -50);
                ctx.drawImage(c2, 0, 0);
                ctx.restore();
            } else {
                ctx.drawImage(c2, canvas.width - 200, canvas.height/2 - 50);
            }
        }

        function showFloatingDamage(canvas, x, y, damage) {
            const container = canvas.parentElement;
            const div = document.createElement('div');
            div.className = 'damage-number';
            div.style.left = x + 'px';
            div.style.top = y + 'px';
            div.style.color = '#ff4466';
            div.textContent = '-' + damage;
            container.appendChild(div);

            setTimeout(() => div.remove(), 1000);
        }

        function addLogEntry(log, text, className = '') {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + className;
            entry.textContent = text;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ==================== BREEDING ====================
        function renderBreeding() {
            const grid = document.getElementById('breeding-grid');
            grid.innerHTML = state.creatures.map(creature => `
                <div class="creature-card"
                     draggable="true"
                     ondragstart="dragCreature(event, '${creature.id}')">
                    <div class="creature-preview" id="breed-preview-${creature.id}"></div>
                    <div class="creature-name">
                        ${creature.name}
                        <span class="generation-badge">Gen ${creature.generation}</span>
                    </div>
                    <div class="trait-list">
                        ${creature.traits.map(t => {
                            const data = getTraitData(t);
                            return `<span class="trait-tag">${data?.icon || ''} ${data?.name || t}</span>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            state.creatures.forEach(creature => {
                const container = document.getElementById(`breed-preview-${creature.id}`);
                if (container) {
                    container.innerHTML = '';
                    container.appendChild(renderCreatureCanvas(creature, 80));
                }
            });

            updateBreedButton();
        }

        function dragCreature(event, id) {
            event.dataTransfer.setData('creatureId', id);
        }

        function allowDrop(event) {
            event.preventDefault();
            event.target.closest('.parent-slot')?.classList.add('dragover');
        }

        function leaveDrop(event) {
            event.target.closest('.parent-slot')?.classList.remove('dragover');
        }

        function dropParent(event, parentNum) {
            event.preventDefault();
            event.target.closest('.parent-slot')?.classList.remove('dragover');

            const id = event.dataTransfer.getData('creatureId');
            const creature = state.creatures.find(c => c.id === id);

            if (!creature) return;

            // Prevent same creature as both parents
            if (parentNum === 1 && state.parent2?.id === id) return;
            if (parentNum === 2 && state.parent1?.id === id) return;

            if (parentNum === 1) {
                state.parent1 = creature;
                renderParentSlot('parent1-slot', creature);
            } else {
                state.parent2 = creature;
                renderParentSlot('parent2-slot', creature);
            }

            updateBreedButton();
            previewOffspring();
        }

        function renderParentSlot(slotId, creature) {
            const slot = document.getElementById(slotId);
            slot.classList.add('filled');
            slot.innerHTML = `
                <div class="parent-label">Parent ${slotId.includes('1') ? '1' : '2'}</div>
            `;
            slot.appendChild(renderCreatureCanvas(creature, 100));
            slot.innerHTML += `
                <div style="margin-top: 10px; font-weight: bold;">${creature.name}</div>
                <div class="trait-list" style="margin-top: 10px;">
                    ${creature.traits.map(t => {
                        const data = getTraitData(t);
                        return `<span class="trait-tag">${data?.icon || ''} ${data?.name || t}</span>`;
                    }).join('')}
                </div>
                <button class="btn" style="margin-top: 10px;" onclick="clearParent(${slotId.includes('1') ? 1 : 2})">Remove</button>
            `;
        }

        function clearParent(num) {
            if (num === 1) {
                state.parent1 = null;
                document.getElementById('parent1-slot').innerHTML = `
                    <div class="parent-label">Parent 1</div>
                    <p style="color: var(--text-dim);">Drag a creature here</p>
                `;
                document.getElementById('parent1-slot').classList.remove('filled');
            } else {
                state.parent2 = null;
                document.getElementById('parent2-slot').innerHTML = `
                    <div class="parent-label">Parent 2</div>
                    <p style="color: var(--text-dim);">Drag a creature here</p>
                `;
                document.getElementById('parent2-slot').classList.remove('filled');
            }

            document.getElementById('offspring-preview').style.display = 'none';
            updateBreedButton();
        }

        function updateBreedButton() {
            const btn = document.getElementById('breed-btn');
            btn.disabled = !state.parent1 || !state.parent2;
        }

        function previewOffspring() {
            if (!state.parent1 || !state.parent2) return;

            const preview = document.getElementById('offspring-preview');
            const traitsDiv = document.getElementById('offspring-traits');

            // Calculate potential traits
            const allTraits = [...state.parent1.traits, ...state.parent2.traits];
            const uniqueTraits = [...new Set(allTraits)];

            traitsDiv.innerHTML = `
                <p style="font-size: 0.85rem; color: var(--text-dim); margin: 10px 0;">Possible traits:</p>
                <div class="trait-list" style="justify-content: center;">
                    ${uniqueTraits.map(t => {
                        const data = getTraitData(t);
                        return `<span class="trait-tag">${data?.icon || ''} ${data?.name || t}</span>`;
                    }).join('')}
                </div>
            `;

            preview.style.display = 'block';
        }

        function breedCreatures() {
            if (!state.parent1 || !state.parent2) return;

            // Combine traits from both parents
            const allTraits = [...state.parent1.traits, ...state.parent2.traits];
            const uniqueTraits = [...new Set(allTraits)];

            // Select traits (with some randomness)
            const numTraits = 2 + Math.floor(Math.random() * 2);
            const selectedTraits = [];

            // Each trait has a chance based on how many parents have it
            for (const trait of uniqueTraits) {
                const count = allTraits.filter(t => t === trait).length;
                const chance = count === 2 ? 0.8 : 0.5;
                if (Math.random() < chance && selectedTraits.length < numTraits + 1) {
                    selectedTraits.push(trait);
                }
            }

            // Ensure minimum traits
            while (selectedTraits.length < numTraits) {
                const remaining = uniqueTraits.filter(t => !selectedTraits.includes(t));
                if (remaining.length === 0) break;
                selectedTraits.push(remaining[Math.floor(Math.random() * remaining.length)]);
            }

            // Mutation chance
            const mutationChance = 0.15;
            if (Math.random() < mutationChance) {
                // Add a random trait not from parents
                const allPossibleTraits = [];
                for (const category in TRAITS) {
                    for (const trait in TRAITS[category]) {
                        if (!selectedTraits.includes(trait)) {
                            allPossibleTraits.push(trait);
                        }
                    }
                }
                if (allPossibleTraits.length > 0) {
                    const mutation = allPossibleTraits[Math.floor(Math.random() * allPossibleTraits.length)];
                    selectedTraits.push(mutation);
                    showToast(`Mutation! Offspring gained ${getTraitData(mutation)?.name || mutation}!`, 'warning');
                }
            }

            // Create offspring
            const generation = Math.max(state.parent1.generation, state.parent2.generation) + 1;
            const offspring = generateCreature(selectedTraits, generation, {
                parent1Name: state.parent1.name,
                parent2Name: state.parent2.name,
                parent1Id: state.parent1.id,
                parent2Id: state.parent2.id
            });

            state.creatures.push(offspring);
            state.stats.maxGeneration = Math.max(state.stats.maxGeneration, generation);

            // Clear parents
            clearParent(1);
            clearParent(2);

            saveState();
            renderBreeding();
            showToast(`${offspring.name} was born! Generation ${generation}`, 'success');
        }

        // ==================== GENE LAB ====================
        function renderLab() {
            // Physical traits
            document.getElementById('physical-traits').innerHTML = Object.entries(TRAITS.physical).map(([key, trait]) => `
                <div class="trait-item" title="${trait.desc}">
                    ${trait.icon} ${trait.name}
                </div>
            `).join('');

            // Ability traits
            document.getElementById('ability-traits').innerHTML = Object.entries(TRAITS.abilities).map(([key, trait]) => `
                <div class="trait-item" title="${trait.desc}">
                    ${trait.icon} ${trait.name}
                </div>
            `).join('');

            // Element traits
            document.getElementById('element-traits').innerHTML = Object.entries(TRAITS.elements).map(([key, trait]) => `
                <div class="trait-item" title="${trait.desc}">
                    ${trait.icon} ${trait.name}
                </div>
            `).join('');

            // Synergies
            document.getElementById('synergy-list').innerHTML = SYNERGIES.map(synergy => {
                const discovered = state.stats.discoveredSynergies.includes(synergy.name);
                const t1 = getTraitData(synergy.traits[0]);
                const t2 = getTraitData(synergy.traits[1]);

                return `
                    <div class="synergy-item" style="${discovered ? '' : 'opacity: 0.4;'}">
                        <div>
                            <div class="synergy-formula">
                                <span>${t1?.icon || ''} ${discovered ? t1?.name : '???'}</span>
                                <span class="synergy-plus">+</span>
                                <span>${t2?.icon || ''} ${discovered ? t2?.name : '???'}</span>
                                <span class="synergy-equals">=</span>
                                <span class="synergy-result">${synergy.icon} ${discovered ? synergy.name : '???'}</span>
                            </div>
                            <div class="synergy-desc">${discovered ? synergy.desc : 'Undiscovered synergy'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== IMPORT/EXPORT ====================
        function showImportExport() {
            const modal = document.getElementById('import-export-modal');
            modal.classList.add('active');

            // Populate creature select
            const select = document.getElementById('export-creature-select');
            select.innerHTML = '<option value="">Select a creature...</option>' +
                state.creatures.map(c => `<option value="${c.id}">${c.name} (Gen ${c.generation})</option>`).join('');

            select.onchange = () => {
                const creature = state.creatures.find(c => c.id === select.value);
                if (creature) {
                    document.getElementById('export-code').value = btoa(JSON.stringify(creature));
                }
            };
        }

        function closeModal() {
            document.getElementById('import-export-modal').classList.remove('active');
        }

        function copyExportCode() {
            const code = document.getElementById('export-code');
            code.select();
            document.execCommand('copy');
            showToast('Code copied to clipboard!');
        }

        function importCreature() {
            try {
                const code = document.getElementById('import-code').value.trim();
                const creature = JSON.parse(atob(code));

                // Regenerate ID to avoid conflicts
                creature.id = generateCreatureId();
                creature.wins = 0;
                creature.losses = 0;
                creature.created = Date.now();

                state.creatures.push(creature);
                saveState();
                renderStable();
                closeModal();
                showToast(`${creature.name} imported successfully!`);
            } catch (e) {
                showToast('Invalid creature code', 'error');
            }
        }

        function exportFullSave() {
            const data = {
                version: 1,
                creatures: state.creatures,
                stats: state.stats,
                exported: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gene-wars-save-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Save exported!');
        }

        function importFullSave(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    state.creatures = data.creatures || [];
                    state.stats = data.stats || state.stats;
                    saveState();
                    renderStable();
                    closeModal();
                    showToast('Save imported successfully!');
                } catch (err) {
                    showToast('Invalid save file', 'error');
                }
            };
            reader.readAsText(file);
        }

        // ==================== NAVIGATION ====================
        document.querySelectorAll('nav button[data-view]').forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;

                // Update nav buttons
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Show view
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(`${view}-view`).classList.add('active');

                // Initialize view
                if (view === 'arena') {
                    if (state.opponents.length === 0) generateOpponents();
                    renderArena();
                } else if (view === 'breeding') {
                    renderBreeding();
                } else if (view === 'lab') {
                    renderLab();
                }
            });
        });

        // ==================== UTILITIES ====================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        function updateStats() {
            document.getElementById('creature-count').textContent = state.creatures.length;
            document.getElementById('total-wins').textContent = state.stats.totalWins;
            document.getElementById('max-generation').textContent = state.stats.maxGeneration;
            document.getElementById('total-culled').textContent = state.stats.totalCulled;
        }

        function saveState() {
            try {
                localStorage.setItem('geneWars', JSON.stringify({
                    creatures: state.creatures,
                    stats: state.stats
                }));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('Storage full! Export your save to free space.', 'error');
                    showStorageWarning();
                }
            }
        }

        function showStorageWarning() {
            const used = new Blob([JSON.stringify(localStorage)]).size;
            const usedMB = (used / 1024 / 1024).toFixed(2);
            console.warn(`localStorage usage: ~${usedMB}MB`);
        }

        function clearAllStorage() {
            if (confirm('This will delete ALL Gene Wars data. Export your save first! Continue?')) {
                localStorage.removeItem('geneWars');
                localStorage.removeItem('geneWarsTutorialSeen');
                state.creatures = [];
                state.stats = { totalWins: 0, totalCulled: 0, maxGeneration: 1, discoveredSynergies: [] };
                renderStable();
                showToast('All data cleared!', 'warning');
            }
        }

        function loadState() {
            const saved = localStorage.getItem('geneWars');
            if (saved) {
                const data = JSON.parse(saved);
                state.creatures = data.creatures || [];
                state.stats = data.stats || state.stats;

                // Recalculate synergies for loaded creatures
                state.creatures.forEach(c => {
                    c.synergies = getSynergies(c.traits);
                });
            }
        }

        function startGame() {
            document.getElementById('tutorial').style.display = 'none';
            try {
                localStorage.setItem('geneWarsTutorialSeen', 'true');
            } catch (e) {
                // Storage full, continue anyway
            }

            // Generate starting creatures if new game
            if (state.creatures.length === 0) {
                for (let i = 0; i < 3; i++) {
                    state.creatures.push(generateCreature());
                }
                saveState();
            }

            renderStable();
        }

        // ==================== INITIALIZATION ====================
        function init() {
            loadState();

            // Check if tutorial was seen
            if (localStorage.getItem('geneWarsTutorialSeen')) {
                document.getElementById('tutorial').style.display = 'none';
                renderStable();
            }

            updateStats();
        }

        init();
    </script>
</body>
</html>
