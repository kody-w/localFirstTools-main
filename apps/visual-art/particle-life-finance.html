<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Particle Life Finance - Your Budget as a Living Ecosystem</title>
    <meta name="description" content="Visualize your finances as an emergent particle ecosystem. Income, expenses, and savings interact through attraction and repulsion forces.">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="color-scheme" content="dark">
    <!-- Tags: simulation, finance, emergent, particles, canvas, productivity -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 320px;
            background: #111118;
            border-right: 1px solid #222;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #222;
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #00d9a5 0%, #667eea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .section {
            padding: 20px 24px;
            border-bottom: 1px solid #222;
        }

        .section h2 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #555;
            margin-bottom: 16px;
        }

        /* Balance Display */
        .balance-card {
            background: linear-gradient(135deg, rgba(0, 217, 165, 0.1), rgba(102, 126, 234, 0.1));
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .balance-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
        }

        .balance-amount {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }

        .balance-amount.positive {
            color: #00d9a5;
        }

        .balance-amount.negative {
            color: #ff6b6b;
        }

        .ecosystem-health {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }

        .health-stat {
            flex: 1;
        }

        .health-stat-label {
            font-size: 10px;
            color: #666;
            margin-bottom: 4px;
        }

        .health-stat-value {
            font-size: 14px;
            font-weight: 600;
        }

        /* Add Transaction Form */
        .add-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 11px;
            color: #666;
        }

        .form-group input, .form-group select {
            padding: 10px 12px;
            background: #1a1a22;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .type-toggle {
            display: flex;
            gap: 8px;
        }

        .type-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #333;
            background: #1a1a22;
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .type-btn:hover {
            border-color: #555;
        }

        .type-btn.active.income {
            background: rgba(0, 217, 165, 0.2);
            border-color: #00d9a5;
            color: #00d9a5;
        }

        .type-btn.active.expense {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .add-btn {
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* Category Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #1a1a22;
            border-radius: 20px;
            font-size: 11px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Transaction History */
        .transactions {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px 24px;
        }

        .transaction {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #1a1a22;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .transaction-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-desc {
            font-size: 13px;
            margin-bottom: 2px;
        }

        .transaction-category {
            font-size: 11px;
            color: #666;
        }

        .transaction-amount {
            font-size: 14px;
            font-weight: 600;
        }

        .transaction-amount.income {
            color: #00d9a5;
        }

        .transaction-amount.expense {
            color: #ff6b6b;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #444;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
        }

        .delete-btn:hover {
            color: #ff6b6b;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            position: relative;
            background: #0a0a0f;
        }

        #particleCanvas {
            width: 100%;
            height: 100%;
        }

        /* Ecosystem Info Overlay */
        .ecosystem-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 16px 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid #333;
        }

        .ecosystem-info h3 {
            font-size: 12px;
            color: #888;
            margin-bottom: 12px;
        }

        .force-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .force-arrows {
            font-size: 14px;
        }

        .attract {
            color: #00d9a5;
        }

        .repel {
            color: #ff6b6b;
        }

        /* Simulation Controls */
        .sim-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 16px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
        }

        .sim-btn {
            padding: 8px 16px;
            background: #222;
            border: 1px solid #333;
            border-radius: 20px;
            color: #888;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sim-btn:hover {
            background: #333;
            color: #fff;
        }

        .sim-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: #fff;
        }

        .share-btn {
            padding: 8px 16px;
            background: rgba(0, 217, 165, 0.2);
            border: 1px solid rgba(0, 217, 165, 0.4);
            border-radius: 20px;
            color: #00d9a5;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-btn:hover {
            background: rgba(0, 217, 165, 0.4);
            color: #fff;
            transform: scale(1.05);
        }

        .share-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            padding: 12px 24px;
            background: rgba(38, 222, 129, 0.9);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            pointer-events: none;
        }

        .share-toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Import/Export */
        .data-controls {
            display: flex;
            gap: 8px;
            padding: 16px 24px;
            border-top: 1px solid #222;
        }

        .data-btn {
            flex: 1;
            padding: 10px;
            background: #1a1a22;
            border: 1px solid #333;
            border-radius: 6px;
            color: #888;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .data-btn:hover {
            background: #222;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Particle Life Finance</h1>
            <p>Your budget as a living ecosystem. Income attracts savings, expenses cluster by category. A healthy ecosystem = healthy finances.</p>
        </div>

        <div class="section">
            <h2>Financial Health</h2>
            <div class="balance-card">
                <div class="balance-label">Net Balance</div>
                <div class="balance-amount" id="netBalance">$0.00</div>
                <div class="ecosystem-health">
                    <div class="health-stat">
                        <div class="health-stat-label">Ecosystem Stability</div>
                        <div class="health-stat-value" id="stabilityScore">--</div>
                    </div>
                    <div class="health-stat">
                        <div class="health-stat-label">Particles</div>
                        <div class="health-stat-value" id="particleCount">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Add Transaction</h2>
            <div class="add-form">
                <div class="type-toggle">
                    <button class="type-btn income active" data-type="income">+ Income</button>
                    <button class="type-btn expense" data-type="expense">- Expense</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="amount" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="category">
                            <optgroup label="Income">
                                <option value="salary">Salary</option>
                                <option value="freelance">Freelance</option>
                                <option value="investment">Investment</option>
                                <option value="gift">Gift</option>
                            </optgroup>
                            <optgroup label="Expenses">
                                <option value="housing">Housing</option>
                                <option value="food">Food & Dining</option>
                                <option value="transport">Transport</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="shopping">Shopping</option>
                                <option value="utilities">Utilities</option>
                                <option value="health">Health</option>
                                <option value="savings">Savings</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="description" placeholder="What's this for?">
                </div>
                <button class="add-btn" id="addTransaction">Add to Ecosystem</button>
            </div>
        </div>

        <div class="section">
            <h2>Particle Species</h2>
            <div class="legend" id="legend"></div>
        </div>

        <div class="section" style="flex: 1;">
            <h2>Recent Transactions</h2>
        </div>
        <div class="transactions" id="transactions"></div>

        <div class="data-controls">
            <button class="data-btn" id="exportBtn">Export JSON</button>
            <button class="data-btn" id="importBtn">Import JSON</button>
            <input type="file" id="importFile" accept=".json" style="display:none;">
        </div>
    </div>

    <div class="canvas-area">
        <canvas id="particleCanvas"></canvas>

        <div class="ecosystem-info">
            <h3>Force Relationships</h3>
            <div class="force-indicator">
                <span class="force-arrows attract">‚Üí‚Üê</span>
                <span>Income attracts Savings</span>
            </div>
            <div class="force-indicator">
                <span class="force-arrows repel">‚Üê‚Üí</span>
                <span>Expenses repel each other</span>
            </div>
            <div class="force-indicator">
                <span class="force-arrows attract">‚Üí‚Üê</span>
                <span>Same categories cluster</span>
            </div>
        </div>

        <div class="sim-controls">
            <button class="sim-btn active" id="playBtn">Play</button>
            <button class="sim-btn" id="resetBtn">Reset Positions</button>
            <button class="sim-btn" id="clearBtn">Clear All</button>
            <button class="share-btn" id="shareBtn">üì∏ Share Ecosystem</button>
        </div>
        <div class="share-toast" id="shareToast">Screenshot copied!</div>
    </div>

    <script>
        // ========== Category Definitions ==========
        const categories = {
            // Income (greens)
            salary: { color: '#00d9a5', type: 'income', label: 'Salary' },
            freelance: { color: '#00b894', type: 'income', label: 'Freelance' },
            investment: { color: '#55efc4', type: 'income', label: 'Investment' },
            gift: { color: '#81ecec', type: 'income', label: 'Gift' },
            // Expenses (various colors)
            housing: { color: '#e17055', type: 'expense', label: 'Housing' },
            food: { color: '#fdcb6e', type: 'expense', label: 'Food' },
            transport: { color: '#74b9ff', type: 'expense', label: 'Transport' },
            entertainment: { color: '#a29bfe', type: 'expense', label: 'Entertainment' },
            shopping: { color: '#fd79a8', type: 'expense', label: 'Shopping' },
            utilities: { color: '#636e72', type: 'expense', label: 'Utilities' },
            health: { color: '#ff7675', type: 'expense', label: 'Health' },
            // Savings (gold/special)
            savings: { color: '#ffeaa7', type: 'savings', label: 'Savings' },
        };

        // Force matrix - how categories interact
        // Positive = attract, Negative = repel
        const forceRules = {
            income: {
                income: 0.5,      // Income particles slightly attract each other
                expense: -0.3,   // Income repels expenses
                savings: 1.0,    // Income strongly attracts savings
            },
            expense: {
                income: -0.3,    // Expenses repel income
                expense: -0.2,   // Expenses slightly repel each other
                savings: -0.5,   // Expenses repel savings
            },
            savings: {
                income: 1.0,     // Savings strongly attracted to income
                expense: -0.5,   // Savings repel expenses
                savings: 0.3,    // Savings slightly attract each other
            }
        };

        // Same-category attraction bonus
        const sameCategoryBonus = 0.8;

        // ========== Data State ==========
        let transactions = JSON.parse(localStorage.getItem('particleFinanceData') || '[]');
        let particles = [];
        let isPlaying = true;
        let transactionType = 'income';

        // ========== Canvas Setup ==========
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ========== Particle Class ==========
        class Particle {
            constructor(transaction) {
                this.id = transaction.id;
                this.amount = transaction.amount;
                this.category = transaction.category;
                this.type = categories[transaction.category].type;
                this.color = categories[transaction.category].color;
                this.description = transaction.description;

                // Size based on amount (logarithmic scale)
                this.radius = Math.max(5, Math.min(30, Math.log10(transaction.amount + 1) * 10));

                // Random starting position
                const width = canvas.offsetWidth;
                const height = canvas.offsetHeight;
                this.x = Math.random() * (width - 100) + 50;
                this.y = Math.random() * (height - 100) + 50;

                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
            }

            update(particles) {
                if (!isPlaying) return;

                const width = canvas.offsetWidth;
                const height = canvas.offsetHeight;

                // Calculate forces from other particles
                let fx = 0, fy = 0;

                particles.forEach(other => {
                    if (other.id === this.id) return;

                    const dx = other.x - this.x;
                    const dy = other.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 5 || dist > 200) return;

                    // Get force multiplier from rules
                    let force = forceRules[this.type][other.type];

                    // Bonus for same category
                    if (this.category === other.category) {
                        force += sameCategoryBonus;
                    }

                    // Force decreases with distance
                    const strength = force / (dist * 0.1);

                    fx += (dx / dist) * strength;
                    fy += (dy / dist) * strength;
                });

                // Apply forces
                this.vx += fx * 0.5;
                this.vy += fy * 0.5;

                // Friction
                this.vx *= 0.95;
                this.vy *= 0.95;

                // Update position
                this.x += this.vx;
                this.y += this.vy;

                // Boundary collision
                if (this.x < this.radius) {
                    this.x = this.radius;
                    this.vx *= -0.5;
                }
                if (this.x > width - this.radius) {
                    this.x = width - this.radius;
                    this.vx *= -0.5;
                }
                if (this.y < this.radius) {
                    this.y = this.radius;
                    this.vy *= -0.5;
                }
                if (this.y > height - this.radius) {
                    this.y = height - this.radius;
                    this.vy *= -0.5;
                }
            }

            draw() {
                // Glow effect
                const gradient = ctx.createRadialGradient(
                    this.x, this.y, 0,
                    this.x, this.y, this.radius * 2
                );
                gradient.addColorStop(0, this.color + '40');
                gradient.addColorStop(1, 'transparent');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius * 2, 0, Math.PI * 2);
                ctx.fill();

                // Main particle
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();

                // Inner highlight
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.arc(this.x - this.radius * 0.3, this.y - this.radius * 0.3, this.radius * 0.3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // ========== Celebration Particle System ==========
        let celebrationParticles = [];

        class CelebrationParticle {
            constructor(x, y, color, type = 'confetti') {
                this.x = x;
                this.y = y;
                this.color = color;
                this.type = type;
                this.life = 1.0;
                this.decay = 0.015 + Math.random() * 0.01;

                if (type === 'confetti') {
                    this.vx = (Math.random() - 0.5) * 15;
                    this.vy = -Math.random() * 12 - 5;
                    this.gravity = 0.3;
                    this.rotation = Math.random() * Math.PI * 2;
                    this.rotationSpeed = (Math.random() - 0.5) * 0.3;
                    this.width = 4 + Math.random() * 6;
                    this.height = 2 + Math.random() * 4;
                } else if (type === 'sparkle') {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 8 + 3;
                    this.vx = Math.cos(angle) * speed;
                    this.vy = Math.sin(angle) * speed;
                    this.gravity = 0;
                    this.size = 2 + Math.random() * 4;
                    this.decay = 0.03 + Math.random() * 0.02;
                } else if (type === 'burst') {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 15 + 8;
                    this.vx = Math.cos(angle) * speed;
                    this.vy = Math.sin(angle) * speed;
                    this.gravity = 0.15;
                    this.size = 3 + Math.random() * 5;
                    this.trail = [];
                }
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += this.gravity || 0;
                this.vx *= 0.98;
                this.life -= this.decay;

                if (this.type === 'confetti') {
                    this.rotation += this.rotationSpeed;
                } else if (this.type === 'burst') {
                    this.trail.push({ x: this.x, y: this.y, life: 0.5 });
                    if (this.trail.length > 10) this.trail.shift();
                    this.trail.forEach(t => t.life -= 0.05);
                }
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.life;

                if (this.type === 'confetti') {
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation);
                    ctx.fillStyle = this.color;
                    ctx.fillRect(-this.width / 2, -this.height / 2, this.width, this.height);
                } else if (this.type === 'sparkle') {
                    // Draw sparkle as a 4-point star
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    const s = this.size;
                    ctx.moveTo(this.x, this.y - s);
                    ctx.lineTo(this.x + s * 0.3, this.y);
                    ctx.lineTo(this.x, this.y + s);
                    ctx.lineTo(this.x - s * 0.3, this.y);
                    ctx.closePath();
                    ctx.fill();
                    ctx.beginPath();
                    ctx.moveTo(this.x - s, this.y);
                    ctx.lineTo(this.x, this.y + s * 0.3);
                    ctx.lineTo(this.x + s, this.y);
                    ctx.lineTo(this.x, this.y - s * 0.3);
                    ctx.closePath();
                    ctx.fill();
                } else if (this.type === 'burst') {
                    // Draw trail
                    this.trail.forEach((t, i) => {
                        ctx.globalAlpha = t.life * this.life;
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(t.x, t.y, this.size * (i / this.trail.length), 0, Math.PI * 2);
                        ctx.fill();
                    });
                    // Draw head
                    ctx.globalAlpha = this.life;
                    ctx.fillStyle = '#fff';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size * 0.6, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }
        }

        const celebrationColors = {
            income: ['#00d9a5', '#00b894', '#55efc4', '#81ecec', '#ffffff'],
            expense: ['#e17055', '#fdcb6e', '#ff7675', '#fab1a0'],
            savings: ['#74b9ff', '#667eea', '#a29bfe', '#ffffff'],
            mega: ['#ffd700', '#ff6b6b', '#00d9a5', '#667eea', '#ff9ff3', '#ffffff']
        };

        function triggerCelebration(x, y, intensity = 'small', colorType = 'income') {
            const colors = celebrationColors[colorType] || celebrationColors.income;
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;

            // Use center if x,y not provided
            if (!x) x = width / 2;
            if (!y) y = height / 2;

            if (intensity === 'small') {
                // Small burst of sparkles
                for (let i = 0; i < 15; i++) {
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    celebrationParticles.push(new CelebrationParticle(x, y, color, 'sparkle'));
                }
            } else if (intensity === 'medium') {
                // Confetti shower
                for (let i = 0; i < 30; i++) {
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const px = x + (Math.random() - 0.5) * 100;
                    celebrationParticles.push(new CelebrationParticle(px, y - 20, color, 'confetti'));
                }
                // Plus sparkles
                for (let i = 0; i < 20; i++) {
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    celebrationParticles.push(new CelebrationParticle(x, y, color, 'sparkle'));
                }
            } else if (intensity === 'mega') {
                // MEGA celebration - multiple bursts across screen
                const megaColors = celebrationColors.mega;
                for (let burst = 0; burst < 5; burst++) {
                    const bx = Math.random() * width;
                    const by = height * 0.3 + Math.random() * height * 0.4;
                    setTimeout(() => {
                        for (let i = 0; i < 25; i++) {
                            const color = megaColors[Math.floor(Math.random() * megaColors.length)];
                            celebrationParticles.push(new CelebrationParticle(bx, by, color, 'burst'));
                        }
                        for (let i = 0; i < 40; i++) {
                            const color = megaColors[Math.floor(Math.random() * megaColors.length)];
                            const px = bx + (Math.random() - 0.5) * 150;
                            celebrationParticles.push(new CelebrationParticle(px, by - 30, color, 'confetti'));
                        }
                    }, burst * 200);
                }
            }
        }

        function updateCelebrationParticles() {
            celebrationParticles.forEach(p => p.update());
            celebrationParticles = celebrationParticles.filter(p => p.life > 0);
        }

        function drawCelebrationParticles() {
            celebrationParticles.forEach(p => p.draw());
        }

        // ========== Simulation ==========
        function createParticlesFromTransactions() {
            particles = transactions.map(t => new Particle(t));
        }

        function animate() {
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;

            // Clear with trail effect
            ctx.fillStyle = 'rgba(10, 10, 15, 0.2)';
            ctx.fillRect(0, 0, width, height);

            // Draw connection lines between attracted particles
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            particles.forEach((p1, i) => {
                particles.slice(i + 1).forEach(p2 => {
                    const dx = p2.x - p1.x;
                    const dy = p2.y - p1.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 100) {
                        const force = forceRules[p1.type][p2.type];
                        if (force > 0 || p1.category === p2.category) {
                            ctx.globalAlpha = (1 - dist / 100) * 0.3;
                            ctx.beginPath();
                            ctx.moveTo(p1.x, p1.y);
                            ctx.lineTo(p2.x, p2.y);
                            ctx.stroke();
                        }
                    }
                });
            });
            ctx.globalAlpha = 1;

            // Update and draw particles
            particles.forEach(p => p.update(particles));
            particles.forEach(p => p.draw());

            // Update and draw celebration particles
            updateCelebrationParticles();
            drawCelebrationParticles();

            // Update stats
            updateStats();

            requestAnimationFrame(animate);
        }

        // ========== UI Functions ==========
        function updateUI() {
            // Update balance
            const income = transactions.filter(t => categories[t.category].type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => categories[t.category].type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            const savings = transactions.filter(t => categories[t.category].type === 'savings')
                .reduce((sum, t) => sum + t.amount, 0);
            const net = income - expenses + savings;

            const balanceEl = document.getElementById('netBalance');
            balanceEl.textContent = formatCurrency(net);
            balanceEl.className = 'balance-amount ' + (net >= 0 ? 'positive' : 'negative');

            document.getElementById('particleCount').textContent = particles.length;

            // Update legend
            const usedCategories = [...new Set(transactions.map(t => t.category))];
            const legendEl = document.getElementById('legend');
            legendEl.innerHTML = usedCategories.map(cat => `
                <div class="legend-item">
                    <span class="legend-dot" style="background: ${categories[cat].color}"></span>
                    ${categories[cat].label}
                </div>
            `).join('');

            // Update transactions list
            const transEl = document.getElementById('transactions');
            transEl.innerHTML = transactions.slice().reverse().map(t => `
                <div class="transaction">
                    <span class="transaction-dot" style="background: ${categories[t.category].color}"></span>
                    <div class="transaction-info">
                        <div class="transaction-desc">${t.description || categories[t.category].label}</div>
                        <div class="transaction-category">${categories[t.category].label}</div>
                    </div>
                    <span class="transaction-amount ${categories[t.category].type}">
                        ${categories[t.category].type === 'expense' ? '-' : '+'}${formatCurrency(t.amount)}
                    </span>
                    <button class="delete-btn" data-id="${t.id}">√ó</button>
                </div>
            `).join('');

            // Delete handlers
            transEl.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = () => deleteTransaction(btn.dataset.id);
            });

            // Save to localStorage
            localStorage.setItem('particleFinanceData', JSON.stringify(transactions));
        }

        function updateStats() {
            // Calculate ecosystem stability based on velocity
            const avgVelocity = particles.reduce((sum, p) =>
                sum + Math.sqrt(p.vx * p.vx + p.vy * p.vy), 0) / Math.max(1, particles.length);

            let stability = 'Chaotic';
            if (avgVelocity < 0.5) stability = 'Very Stable';
            else if (avgVelocity < 1) stability = 'Stable';
            else if (avgVelocity < 2) stability = 'Active';
            else if (avgVelocity < 4) stability = 'Turbulent';

            document.getElementById('stabilityScore').textContent = stability;
        }

        function formatCurrency(amount) {
            return '$' + Math.abs(amount).toFixed(2);
        }

        function addTransaction() {
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            // Calculate balance before transaction
            const balanceBefore = transactions.reduce((sum, t) => {
                const type = categories[t.category].type;
                return sum + (type === 'income' ? t.amount : -t.amount);
            }, 0);

            const transaction = {
                id: Date.now().toString(),
                amount,
                category,
                description,
                date: new Date().toISOString()
            };

            transactions.push(transaction);
            const newParticle = new Particle(transaction);
            particles.push(newParticle);

            // Calculate balance after transaction
            const type = categories[category].type;
            const balanceAfter = balanceBefore + (type === 'income' ? amount : -amount);

            // Trigger celebration based on transaction type and amount
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            const celebX = newParticle.x || width / 2;
            const celebY = newParticle.y || height / 2;

            if (type === 'income') {
                if (amount >= 1000) {
                    // Large income - medium celebration
                    triggerCelebration(celebX, celebY, 'medium', 'income');
                } else {
                    // Regular income - small celebration
                    triggerCelebration(celebX, celebY, 'small', 'income');
                }
            } else if (type === 'savings') {
                // Savings get a nice celebration too
                triggerCelebration(celebX, celebY, 'small', 'savings');
            }

            // MEGA celebration when balance crosses from negative to positive!
            if (balanceBefore < 0 && balanceAfter >= 0) {
                setTimeout(() => {
                    triggerCelebration(null, null, 'mega', 'mega');
                }, 300);
            }

            updateUI();

            // Clear form
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
        }

        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            particles = particles.filter(p => p.id !== id);
            updateUI();
        }

        function resetPositions() {
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            particles.forEach(p => {
                p.x = Math.random() * (width - 100) + 50;
                p.y = Math.random() * (height - 100) + 50;
                p.vx = (Math.random() - 0.5) * 2;
                p.vy = (Math.random() - 0.5) * 2;
            });
        }

        function clearAll() {
            if (confirm('Clear all transactions? This cannot be undone.')) {
                transactions = [];
                particles = [];
                localStorage.removeItem('particleFinanceData');
                updateUI();
            }
        }

        // ========== Event Handlers ==========
        document.querySelectorAll('.type-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                transactionType = btn.dataset.type;

                // Update category dropdown
                const categorySelect = document.getElementById('category');
                if (transactionType === 'income') {
                    categorySelect.value = 'salary';
                } else {
                    categorySelect.value = 'food';
                }
            };
        });

        document.getElementById('addTransaction').onclick = addTransaction;
        document.getElementById('amount').addEventListener('keypress', e => {
            if (e.key === 'Enter') addTransaction();
        });

        document.getElementById('playBtn').onclick = function() {
            isPlaying = !isPlaying;
            this.textContent = isPlaying ? 'Pause' : 'Play';
            this.classList.toggle('active', isPlaying);
        };

        document.getElementById('resetBtn').onclick = resetPositions;
        document.getElementById('clearBtn').onclick = clearAll;

        // Export/Import
        document.getElementById('exportBtn').onclick = () => {
            const data = JSON.stringify(transactions, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'particle-finance-data.json';
            a.click();
            URL.revokeObjectURL(url);
        };

        document.getElementById('importBtn').onclick = () => {
            document.getElementById('importFile').click();
        };

        document.getElementById('importFile').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        transactions = data;
                        createParticlesFromTransactions();
                        updateUI();
                    }
                } catch (err) {
                    alert('Invalid JSON file');
                }
            };
            reader.readAsText(file);
        };

        // ========== Initialize ==========
        createParticlesFromTransactions();
        updateUI();
        animate();

        // Add sample data if empty
        if (transactions.length === 0) {
            const sampleData = [
                { id: '1', amount: 5000, category: 'salary', description: 'Monthly Salary', date: new Date().toISOString() },
                { id: '2', amount: 1200, category: 'housing', description: 'Rent', date: new Date().toISOString() },
                { id: '3', amount: 400, category: 'food', description: 'Groceries', date: new Date().toISOString() },
                { id: '4', amount: 150, category: 'utilities', description: 'Electric Bill', date: new Date().toISOString() },
                { id: '5', amount: 200, category: 'entertainment', description: 'Subscriptions', date: new Date().toISOString() },
                { id: '6', amount: 500, category: 'savings', description: 'Monthly Savings', date: new Date().toISOString() },
                { id: '7', amount: 100, category: 'transport', description: 'Gas', date: new Date().toISOString() },
                { id: '8', amount: 300, category: 'freelance', description: 'Side Project', date: new Date().toISOString() },
            ];
            transactions = sampleData;
            createParticlesFromTransactions();
            updateUI();
        }

        // ========== SCREENSHOT/SHARE FUNCTIONALITY ==========
        const shareBtn = document.getElementById('shareBtn');
        const shareToast = document.getElementById('shareToast');

        function showToast(msg) {
            shareToast.textContent = msg;
            shareToast.classList.add('visible');
            setTimeout(() => shareToast.classList.remove('visible'), 2500);
        }

        shareBtn.addEventListener('click', async () => {
            try {
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        showToast('Ecosystem screenshot copied to clipboard!');
                    } catch (err) {
                        downloadScreenshot();
                    }
                }, 'image/png');
            } catch (err) {
                downloadScreenshot();
            }
        });

        function downloadScreenshot() {
            const link = document.createElement('a');
            link.download = `particle-finance-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('Screenshot downloaded!');
        }
    </script>
</body>
</html>
