<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="3d_immersive">
<meta name="rappterzoo:tags" content="canvas,3d,space,flight,audio,game,procedural,particles">
<meta name="rappterzoo:type" content="game">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="1">
<title>Nebula Flight - 3D Space Combat</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;overflow:hidden;font-family:'Segoe UI',sans-serif;color:#fff}
canvas{display:block;cursor:crosshair}
#title{position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at center,#050520 0%,#000 80%);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
#title h1{font-size:50px;color:#ff6644;text-shadow:0 0 40px rgba(255,100,50,0.5);margin-bottom:8px;letter-spacing:4px}
#title .sub{font-size:16px;color:#aa4422;margin-bottom:40px}
.btn{background:linear-gradient(135deg,rgba(255,100,50,0.15),rgba(255,100,50,0.03));border:1px solid rgba(255,100,50,0.4);color:#ff6644;padding:14px 40px;font-size:16px;border-radius:6px;cursor:pointer;margin:6px;min-width:200px;font-family:inherit;transition:all 0.3s}
.btn:hover{background:linear-gradient(135deg,rgba(255,100,50,0.3),rgba(255,100,50,0.1));border-color:#ff6644;transform:translateY(-2px);box-shadow:0 4px 25px rgba(255,100,50,0.4)}
.dr{display:flex;gap:10px;margin:10px 0}
.db{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);color:#888;padding:8px 20px;border-radius:4px;cursor:pointer;transition:all 0.3s;font-family:inherit;font-size:13px}
.db:hover,.db.active{background:rgba(255,100,50,0.2);border-color:#ff6644;color:#ff6644}
#hud{position:fixed;top:10px;left:10px;background:rgba(0,0,0,0.75);border:1px solid rgba(255,100,50,0.3);border-radius:8px;padding:12px 16px;font-size:13px;z-index:10;backdrop-filter:blur(5px);min-width:210px;display:none}
#hud h3{color:#ff6644;margin-bottom:8px}
.hs{display:flex;justify-content:space-between;margin:3px 0}.hs .hl{color:#aa4422}.hs .hv{color:#fff;font-weight:bold}
.hb{height:5px;background:rgba(255,255,255,0.1);border-radius:3px;margin:3px 0}
.hb-f{height:100%;border-radius:3px;transition:width 0.2s}
#sb{position:fixed;top:10px;right:10px;background:rgba(0,0,0,0.75);border:1px solid rgba(255,200,50,0.3);border-radius:8px;padding:12px 16px;font-size:12px;z-index:10;backdrop-filter:blur(5px);min-width:160px;display:none}
#sb h3{color:#fc8;margin-bottom:6px}
.se{display:flex;justify-content:space-between;margin:2px 0}
#pause{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(8px)}
#pause h2{font-size:36px;color:#ff6644;margin-bottom:20px}
#gover{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:300;backdrop-filter:blur(10px)}
#gover h2{font-size:42px;margin-bottom:10px}
.go-sc{font-size:24px;color:#ff6644;margin-bottom:10px}
.go-g{display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;margin:20px 0;text-align:left}
.go-g .gl{color:#aa4422}.go-g .gv{color:#fff;font-weight:bold}
#radar{position:fixed;bottom:10px;right:10px;width:140px;height:140px;border:1px solid rgba(255,100,50,0.3);border-radius:50%;background:rgba(0,0,0,0.6);z-index:10;display:none}
#hint{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);font-size:11px;color:rgba(255,255,255,0.2);z-index:10;display:none}
#tp{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:none;gap:10px;z-index:20}
.tb{width:50px;height:50px;border-radius:50%;background:rgba(255,100,50,0.15);border:2px solid rgba(255,100,50,0.4);color:#ff6644;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;touch-action:manipulation}
@media(max-width:768px){#title h1{font-size:28px}#tp{display:flex}#hud{font-size:11px;padding:8px}}
</style>
</head>
<body>
<div id="title">
  <h1>NEBULA FLIGHT</h1>
  <div class="sub">3D Space Combat</div>
  <div style="color:#557;margin-bottom:15px;font-size:13px">Difficulty:</div>
  <div class="dr">
    <button class="db" data-d="easy">Easy</button>
    <button class="db active" data-d="normal">Normal</button>
    <button class="db" data-d="hard">Hard</button>
  </div>
  <button class="btn" id="b-start" style="margin-top:20px">Launch</button>
  <button class="btn" id="b-tut" style="font-size:13px;padding:10px 30px">Tutorial</button>
  <div style="margin-top:30px;color:#445;font-size:12px">WASD: Fly | Mouse: Aim | Click: Fire | Space: Afterburner | Shift: Roll | 1-3: Weapons | ESC: Pause</div>
</div>
<div id="pause"><h2>PAUSED</h2><button class="btn" id="b-res">Resume</button><button class="btn" id="b-quit">Quit</button></div>
<div id="gover">
  <h2 id="go-t">SHOT DOWN</h2>
  <div class="go-sc" id="go-fs"></div>
  <div class="go-g" id="go-sg"></div>
  <button class="btn" id="b-retry">Fly Again (R)</button>
  <button class="btn" id="b-menu" style="font-size:13px;padding:10px 30px">Main Menu</button>
</div>
<div id="hud">
  <h3>NEBULA FLIGHT</h3>
  <div class="hs"><span class="hl">Score</span><span class="hv" id="h-sc">0</span></div>
  <div class="hs"><span class="hl">Kills</span><span class="hv" id="h-kills">0</span></div>
  <div class="hs"><span class="hl">Wave</span><span class="hv" id="h-wave">1</span></div>
  <div class="hs"><span class="hl">Combo</span><span class="hv" id="h-cmb">0</span></div>
  <div class="hs"><span class="hl">Weapon</span><span class="hv" id="h-wpn">Laser</span></div>
  <div style="margin-top:6px">
    <div class="hs"><span class="hl">Hull</span></div>
    <div class="hb"><div class="hb-f" id="bar-hull" style="width:100%;background:linear-gradient(90deg,#f44,#4f4)"></div></div>
  </div>
  <div>
    <div class="hs"><span class="hl">Shield</span></div>
    <div class="hb"><div class="hb-f" id="bar-shd" style="width:100%;background:linear-gradient(90deg,#08f,#0cf)"></div></div>
  </div>
  <div>
    <div class="hs"><span class="hl">Energy</span></div>
    <div class="hb"><div class="hb-f" id="bar-eng" style="width:100%;background:linear-gradient(90deg,#f80,#ff0)"></div></div>
  </div>
</div>
<div id="sb"><h3>HIGH SCORES</h3><div id="sb-list"></div></div>
<div id="hint">WASD: Fly | Mouse: Aim & Shoot | Space: Afterburner | 1-3: Weapons | ESC: Pause</div>
<canvas id="radar" width="140" height="140"></canvas>
<div id="tp">
  <button class="tb" id="tl2">&#9664;</button>
  <button class="tb" id="tu2">&#9650;</button>
  <button class="tb" id="td2">&#9660;</button>
  <button class="tb" id="tr2">&#9654;</button>
  <button class="tb" id="tf2" style="background:rgba(255,0,0,0.2);border-color:rgba(255,0,0,0.5);color:#f44">F</button>
  <button class="tb" id="tb2" style="background:rgba(255,136,0,0.2);border-color:rgba(255,136,0,0.5);color:#f80">B</button>
</div>
<canvas id="c"></canvas>
<script>
// ===== AUDIO =====
class SpaceAudio{
  constructor(){this.ctx=null;this.g=null;this.on=false}
  init(){if(this.on)return;try{this.ctx=new(window.AudioContext||window.webkitAudioContext)();this.g=this.ctx.createGain();this.g.gain.value=0.2;this.g.connect(this.ctx.destination);this.on=true;this.drone()}catch(e){}}
  t(f,d,tp,v,p){if(!this.on)return;const o=this.ctx.createOscillator(),g=this.ctx.createGain(),pa=this.ctx.createStereoPanner();o.type=tp||'sine';o.frequency.setValueAtTime(f,this.ctx.currentTime);g.gain.setValueAtTime((v||0.1)*0.25,this.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+(d||0.2));pa.pan.value=p||0;o.connect(g);g.connect(pa);pa.connect(this.g);o.start();o.stop(this.ctx.currentTime+(d||0.2))}
  laser(){this.t(800+Math.random()*200,0.08,'square',0.1);this.t(600,0.06,'sawtooth',0.08)}
  missile(){this.t(200,0.3,'sawtooth',0.15);setTimeout(()=>this.t(400,0.2,'square',0.1),100)}
  plasma(){for(let i=0;i<3;i++)setTimeout(()=>this.t(300+i*150,0.15,'triangle',0.1),i*30)}
  hit(){this.t(120,0.1,'sawtooth',0.2);this.t(80,0.12,'square',0.15)}
  kill(){this.t(440,0.1,'sine',0.12);setTimeout(()=>this.t(660,0.12,'sine',0.1),50)}
  explode(){if(!this.on)return;const b=this.ctx.createBuffer(1,this.ctx.sampleRate*0.6,this.ctx.sampleRate);const d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.exp(-i/(this.ctx.sampleRate*0.12));const s=this.ctx.createBufferSource();s.buffer=b;const g=this.ctx.createGain();g.gain.value=0.2;s.connect(g);g.connect(this.g);s.start()}
  combo(){this.t(660,0.05,'square',0.08);setTimeout(()=>this.t(880,0.06,'square',0.08),30)}
  levelUp(){[523,659,784,1047].forEach((n,i)=>setTimeout(()=>this.t(n,0.2,'sine',0.1),i*70))}
  click(){this.t(500,0.04,'sine',0.06)}
  boost(){for(let i=0;i<4;i++)setTimeout(()=>this.t(150+i*50,0.15,'sawtooth',0.08),i*25)}
  drone(){if(!this.on)return;const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type='sine';o.frequency.value=30;g.gain.value=0.01;o.connect(g);g.connect(this.g);o.start()}
  boss(){for(let i=0;i<3;i++)setTimeout(()=>this.t(80+i*30,0.4,'sawtooth',0.15),i*120)}
}

// ===== CONSTANTS =====
const ST={TITLE:0,PLAY:1,PAUSE:2,OVER:3};
const DIFFS={easy:{spawnMult:0.6,hpMult:0.7,dmgMult:0.5},normal:{spawnMult:1,hpMult:1,dmgMult:1},hard:{spawnMult:1.5,hpMult:1.5,dmgMult:1.5}};
const WEAPONS=[
  {name:'Laser',color:'#ff4444',speed:800,damage:5,rate:0.1,energy:3,size:2},
  {name:'Plasma',color:'#44ff44',speed:500,damage:12,rate:0.3,energy:8,size:4},
  {name:'Missile',color:'#ffaa00',speed:350,damage:25,rate:0.8,energy:15,size:5}
];
const ENEMY_SHIPS=[
  {name:'Scout',color:'#ff4444',hp:5,speed:100,damage:3,radius:12,score:50},
  {name:'Fighter',color:'#ff8844',hp:10,speed:80,damage:8,radius:16,score:100},
  {name:'Bomber',color:'#44aaff',hp:20,speed:50,damage:15,radius:22,score:200},
  {name:'Interceptor',color:'#ff44ff',hp:8,speed:150,damage:6,radius:10,score:150},
  {name:'Destroyer',color:'#44ff44',hp:35,speed:30,damage:20,radius:30,score:350}
];

// ===== STATE =====
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const radarCanvas=document.getElementById('radar');
const rCtx=radarCanvas.getContext('2d');
const sfx=new SpaceAudio();
let gSt=ST.TITLE,diff='normal';
let score=0,kills=0,wave=1,combo=0,comboTimer=0,maxCombo=0;
let hull=100,shield=50,energy=100;
let curWeapon=0,shootTimer=0;
let shakeAmt=0,gameTime=0;
let afterburner=false;

// 3D space
let px=0,py=0,pz=0,pvx=0,pvy=0,pvz=0;
let yaw=0,pitch=0,roll=0;
let speed=100;

let bullets=[],enemies2=[],particles2=[],stars=[],nebulaClouds=[];
let keys2={},mouseX2=0,mouseY2=0,mouseDown2=false;
let touchD2={x:0,y:0},touchFire=false;
let waveTimer=0,waveActive=false,enemiesThisWave=0,enemiesKilled=0;
let highScores2=[];

function resize2(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;initBG()}
window.addEventListener('resize',resize2);
resize2();

function initBG(){
  stars=[];
  for(let i=0;i<200;i++){
    stars.push({
      x:(Math.random()-0.5)*4000,y:(Math.random()-0.5)*4000,z:(Math.random()-0.5)*4000,
      size:Math.random()*2,brightness:0.3+Math.random()*0.7
    });
  }
  nebulaClouds=[];
  const colors=['#ff440010','#4488ff10','#ff00ff08','#44ff4408','#ffcc0008'];
  for(let i=0;i<12;i++){
    nebulaClouds.push({
      x:(Math.random()-0.5)*3000,y:(Math.random()-0.5)*3000,z:(Math.random()-0.5)*3000,
      radius:200+Math.random()*400,color:colors[Math.floor(Math.random()*colors.length)]
    });
  }
}

const FOV2=350;
function project(wx,wy,wz){
  const dx=wx-px,dy=wy-py,dz=wz-pz;
  const cosY=Math.cos(-yaw),sinY=Math.sin(-yaw);
  const cosP=Math.cos(-pitch),sinP=Math.sin(-pitch);
  const rx=dx*cosY-dz*sinY;
  const rz2=dx*sinY+dz*cosY;
  const ry=dy*cosP-rz2*sinP;
  const rz=dy*sinP+rz2*cosP;
  if(rz<=1)return null;
  const scale=FOV2/rz;
  return{sx:canvas.width/2+rx*scale,sy:canvas.height/2-ry*scale,scale,z:rz};
}

// ===== GAME =====
function startGame2(){
  gSt=ST.PLAY;
  score=0;kills=0;wave=1;combo=0;comboTimer=0;maxCombo=0;
  hull=100;shield=50;energy=100;curWeapon=0;shootTimer=0;
  shakeAmt=0;gameTime=0;afterburner=false;
  px=0;py=0;pz=0;pvx=0;pvy=0;pvz=0;
  yaw=0;pitch=0;roll=0;speed=100;
  bullets=[];enemies2=[];particles2=[];
  waveTimer=0;waveActive=false;enemiesThisWave=0;enemiesKilled=0;
  document.getElementById('title').style.display='none';
  document.getElementById('gover').style.display='none';
  document.getElementById('pause').style.display='none';
  ['hud','sb','hint','radar'].forEach(id=>document.getElementById(id).style.display='block');
  sfx.init();
  startWave();
}

function startWave(){
  waveActive=true;
  enemiesThisWave=5+wave*3;
  enemiesKilled=0;waveTimer=0;
  sfx.levelUp();
  if(wave%5===0){
    // Boss wave
    setTimeout(()=>{
      const boss={
        x:px+Math.sin(yaw)*500,y:py,z:pz+Math.cos(yaw)*500,
        vx:0,vy:0,vz:0,
        type:{name:'Dreadnought',color:'#ff0000',hp:50+wave*10,speed:25,damage:30,radius:50,score:1000},
        hp:50+wave*10,alive:true,flashTimer:0,attackTimer:2,isBoss:true,phase:0,spinAngle:0
      };
      enemies2.push(boss);
      sfx.boss();
    },2000);
  }
}

function spawnEnemy(){
  const angle=Math.random()*Math.PI*2;
  const dist=400+Math.random()*300;
  const typeIdx=Math.min(Math.floor(Math.random()*(1+wave*0.4)),ENEMY_SHIPS.length-1);
  const type=ENEMY_SHIPS[typeIdx];
  const dc=DIFFS[diff];
  enemies2.push({
    x:px+Math.cos(angle)*dist,
    y:py+(Math.random()-0.5)*200,
    z:pz+Math.sin(angle)*dist,
    vx:0,vy:0,vz:0,
    type,hp:Math.ceil(type.hp*dc.hpMult),
    alive:true,flashTimer:0,attackTimer:1+Math.random()*2,
    isBoss:false,shootTimer:2+Math.random()*3
  });
}

function fire(){
  if(energy<WEAPONS[curWeapon].energy)return;
  const w=WEAPONS[curWeapon];
  energy-=w.energy;
  const fx=Math.sin(yaw)*Math.cos(pitch);
  const fy=Math.sin(pitch);
  const fz=Math.cos(yaw)*Math.cos(pitch);
  bullets.push({
    x:px+fx*20,y:py+fy*20,z:pz+fz*20,
    vx:fx*w.speed+pvx,vy:fy*w.speed+pvy,vz:fz*w.speed+pvz,
    damage:w.damage,color:w.color,size:w.size,
    alive:true,age:0,isEnemy:false
  });
  if(curWeapon===0)sfx.laser();
  else if(curWeapon===1)sfx.plasma();
  else sfx.missile();
}

function endGame2(ending){
  gSt=ST.OVER;
  const titles={destroyed:'SHOT DOWN',victory:'SECTOR CLEARED',retreat:'RETREAT'};
  document.getElementById('go-t').textContent=titles[ending]||'GAME OVER';
  document.getElementById('go-t').style.color=ending==='victory'?'#44ff44':'#ff4444';
  document.getElementById('go-fs').textContent='Score: '+score.toLocaleString();
  document.getElementById('go-sg').innerHTML=`
    <span class="gl">Wave</span><span class="gv">${wave}</span>
    <span class="gl">Kills</span><span class="gv">${kills}</span>
    <span class="gl">Max Combo</span><span class="gv">${maxCombo}x</span>
    <span class="gl">Time</span><span class="gv">${Math.floor(gameTime)}s</span>
    <span class="gl">Weapon</span><span class="gv">${WEAPONS[curWeapon].name}</span>
    <span class="gl">Difficulty</span><span class="gv">${diff}</span>
  `;
  document.getElementById('gover').style.display='flex';
  highScores2.push({score,wave,kills,date:new Date().toLocaleDateString()});
  highScores2.sort((a,b)=>b.score-a.score);
  highScores2=highScores2.slice(0,10);
  try{localStorage.setItem('nf_scores',JSON.stringify(highScores2))}catch(e){}
}

// ===== UPDATE =====
let spawnT=0;
function update2(dt){
  if(gSt!==ST.PLAY)return;
  gameTime+=dt;
  const dc=DIFFS[diff];
  // Player movement
  let ax=0,ay=0,az=0;
  if(keys2['KeyW']||keys2['ArrowUp']||touchD2.y<0)az=1;
  if(keys2['KeyS']||keys2['ArrowDown']||touchD2.y>0)az=-1;
  if(keys2['KeyA']||keys2['ArrowLeft']||touchD2.x<0)ax=-1;
  if(keys2['KeyD']||keys2['ArrowRight']||touchD2.x>0)ax=1;
  if(keys2['KeyQ'])ay=1;
  if(keys2['KeyE'])ay=-1;
  afterburner=keys2['Space']&&energy>0;
  const spd=afterburner?speed*2.5:speed;
  if(afterburner)energy-=20*dt;
  const fx=Math.sin(yaw)*Math.cos(pitch),fy=Math.sin(pitch),fz=Math.cos(yaw)*Math.cos(pitch);
  const rx2=Math.cos(yaw),rz2=-Math.sin(yaw);
  pvx+=(az*fx+ax*rx2)*spd*dt*3;
  pvy+=(az*fy+ay*spd*0.5)*dt*3;
  pvz+=(az*fz+ax*rz2)*spd*dt*3;
  pvx*=0.95;pvy*=0.95;pvz*=0.95;
  px+=pvx*dt;py+=pvy*dt;pz+=pvz*dt;
  // Energy regen
  energy=Math.min(100,energy+10*dt);
  // Shield regen
  shield=Math.min(50,shield+3*dt);
  // Shooting
  shootTimer-=dt;
  if((mouseDown2||touchFire)&&shootTimer<=0){
    shootTimer=WEAPONS[curWeapon].rate;
    fire();
  }
  // Wave management
  if(waveActive){
    spawnT+=dt;
    const sr=Math.max(0.5,2-wave*0.1)/dc.spawnMult;
    if(spawnT>sr&&enemiesKilled+enemies2.filter(e=>!e.isBoss).length<enemiesThisWave){
      spawnT=0;spawnEnemy();
    }
    if(enemiesKilled>=enemiesThisWave&&enemies2.length===0){
      waveActive=false;wave++;score+=wave*200;
      sfx.levelUp();
      if(wave>15){endGame2('victory');return;}
      setTimeout(()=>{if(gSt===ST.PLAY)startWave()},3000);
    }
  }
  // Bullets
  bullets.forEach(b=>{
    b.x+=b.vx*dt;b.y+=b.vy*dt;b.z+=b.vz*dt;
    b.age+=dt;
    if(b.age>3)b.alive=false;
    if(b.isEnemy){
      const dx=px-b.x,dy=py-b.y,dz=pz-b.z;
      const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
      if(dist<20){
        b.alive=false;
        const dmg=b.damage*dc.dmgMult;
        if(shield>0){shield-=dmg;if(shield<0){hull+=shield;shield=0;}}
        else hull-=dmg;
        shakeAmt=6;sfx.hit();
        spawnP2(b.x,b.y,b.z,5,'#ff4444');
        if(hull<=0){sfx.explode();endGame2('destroyed');return;}
      }
    }else{
      enemies2.forEach(e=>{
        if(!e.alive)return;
        const dx=e.x-b.x,dy=e.y-b.y,dz=e.z-b.z;
        const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
        if(dist<e.type.radius+b.size){
          b.alive=false;e.hp-=b.damage;e.flashTimer=0.1;
          shakeAmt=2;
          spawnP2(b.x,b.y,b.z,5,b.color);
          if(e.hp<=0){
            e.alive=false;kills++;enemiesKilled++;
            combo++;comboTimer=2;if(combo>maxCombo)maxCombo=combo;
            score+=Math.floor(e.type.score*(1+combo*0.2));
            sfx.kill();if(combo>3)sfx.combo();
            spawnP2(e.x,e.y,e.z,20,e.type.color);
            if(e.isBoss){sfx.explode();score+=2000;}
          }
        }
      });
    }
  });
  bullets=bullets.filter(b=>b.alive);
  // Enemies
  enemies2.forEach(e=>{
    if(!e.alive)return;
    e.flashTimer=Math.max(0,e.flashTimer-dt);
    const dx=px-e.x,dy=py-e.y,dz=pz-e.z;
    const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
    if(dist>20){
      const spd2=e.type.speed;
      e.vx+=(dx/dist)*spd2*dt*2;
      e.vy+=(dy/dist)*spd2*dt*2;
      e.vz+=(dz/dist)*spd2*dt*2;
    }
    e.vx*=0.97;e.vy*=0.97;e.vz*=0.97;
    e.x+=e.vx*dt;e.y+=e.vy*dt;e.z+=e.vz*dt;
    // Shoot
    e.shootTimer-=dt;
    if(e.shootTimer<=0&&dist<600){
      e.shootTimer=2+Math.random()*2;
      const bspd=200;
      bullets.push({
        x:e.x,y:e.y,z:e.z,
        vx:(dx/dist)*bspd,vy:(dy/dist)*bspd,vz:(dz/dist)*bspd,
        damage:e.type.damage,color:e.type.color,size:3,alive:true,age:0,isEnemy:true
      });
    }
    // Collision
    if(dist<e.type.radius+15){
      hull-=e.type.damage*0.5*dt;
      shakeAmt=4;
      if(hull<=0){sfx.explode();endGame2('destroyed');}
    }
  });
  enemies2=enemies2.filter(e=>e.alive);
  // Particles
  particles2.forEach(p2=>{p2.x+=p2.vx*dt;p2.y+=p2.vy*dt;p2.z+=p2.vz*dt;p2.life-=dt;});
  particles2=particles2.filter(p2=>p2.life>0);
  // Combo
  if(comboTimer>0){comboTimer-=dt;if(comboTimer<=0)combo=0;}
  // Shake
  shakeAmt*=0.9;if(shakeAmt<0.1)shakeAmt=0;
  // Cap
  if(bullets.length>100)bullets.splice(0,bullets.length-100);
  if(particles2.length>300)particles2.splice(0,particles2.length-300);
  updateHUD2();
}

function spawnP2(x,y,z,count,color){
  for(let i=0;i<count;i++){
    particles2.push({
      x,y,z,
      vx:(Math.random()-0.5)*200,vy:(Math.random()-0.5)*200,vz:(Math.random()-0.5)*200,
      color,life:0.5+Math.random()*0.5,maxLife:1,size:1+Math.random()*3
    });
  }
}

function updateHUD2(){
  document.getElementById('h-sc').textContent=score.toLocaleString();
  document.getElementById('h-kills').textContent=kills;
  document.getElementById('h-wave').textContent=wave;
  document.getElementById('h-cmb').textContent=combo>0?combo+'x':'0';
  document.getElementById('h-wpn').textContent=WEAPONS[curWeapon].name;
  document.getElementById('bar-hull').style.width=hull+'%';
  document.getElementById('bar-shd').style.width=(shield/50*100)+'%';
  document.getElementById('bar-eng').style.width=energy+'%';
  // Scoreboard
  const sbEl=document.getElementById('sb-list');
  if(!highScores2.length){sbEl.innerHTML='<div style="color:#555">No scores yet</div>';}
  else sbEl.innerHTML=highScores2.slice(0,5).map((s,i)=>`<div class="se"><span style="color:#fc8">${i+1}.</span><span style="color:#aaa;flex:1">W${s.wave}</span><span style="color:#fff;font-weight:bold">${s.score.toLocaleString()}</span></div>`).join('');
}

// ===== RENDER =====
function render2(){
  ctx.save();
  if(shakeAmt>0)ctx.translate((Math.random()-0.5)*shakeAmt*2,(Math.random()-0.5)*shakeAmt*2);
  ctx.fillStyle='#020208';ctx.fillRect(0,0,canvas.width,canvas.height);
  // Stars
  const t=performance.now()*0.001;
  stars.forEach(s=>{
    const p=project(s.x,s.y,s.z);
    if(!p||p.z<1)return;
    const b=s.brightness*(0.6+Math.sin(t+s.x*0.01)*0.4);
    ctx.fillStyle=`rgba(255,255,255,${b*Math.min(1,p.scale*2)})`;
    ctx.fillRect(p.sx,p.sy,Math.max(1,s.size*p.scale*0.3),Math.max(1,s.size*p.scale*0.3));
  });
  // Nebula clouds
  nebulaClouds.forEach(nc=>{
    const p=project(nc.x,nc.y,nc.z);
    if(!p||p.z<10)return;
    const r=nc.radius*p.scale;
    if(r<5)return;
    const gg=ctx.createRadialGradient(p.sx,p.sy,0,p.sx,p.sy,r);
    gg.addColorStop(0,nc.color);gg.addColorStop(1,'transparent');
    ctx.beginPath();ctx.arc(p.sx,p.sy,r,0,Math.PI*2);
    ctx.fillStyle=gg;ctx.fill();
  });
  if(gSt===ST.PLAY||gSt===ST.PAUSE){
    // Bullets
    bullets.forEach(b=>{
      const p=project(b.x,b.y,b.z);
      if(!p||p.z<1)return;
      const r=b.size*p.scale;
      if(r<0.5)return;
      ctx.beginPath();ctx.arc(p.sx,p.sy,Math.max(1,r),0,Math.PI*2);
      ctx.fillStyle=b.color;ctx.fill();
      const gg=ctx.createRadialGradient(p.sx,p.sy,0,p.sx,p.sy,r*3);
      gg.addColorStop(0,b.color+'40');gg.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(p.sx,p.sy,r*3,0,Math.PI*2);
      ctx.fillStyle=gg;ctx.fill();
    });
    // Enemies
    enemies2.forEach(e=>{
      if(!e.alive)return;
      const p=project(e.x,e.y,e.z);
      if(!p||p.z<1)return;
      const r=e.type.radius*p.scale;
      if(r<1)return;
      const flash=e.flashTimer>0;
      // Glow
      const gg=ctx.createRadialGradient(p.sx,p.sy,0,p.sx,p.sy,r*2.5);
      gg.addColorStop(0,(flash?'#fff':e.type.color)+'30');gg.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(p.sx,p.sy,r*2.5,0,Math.PI*2);
      ctx.fillStyle=gg;ctx.fill();
      // Ship shape
      ctx.save();ctx.translate(p.sx,p.sy);
      ctx.beginPath();
      ctx.moveTo(0,-r);ctx.lineTo(-r*0.8,r*0.5);ctx.lineTo(0,r*0.3);ctx.lineTo(r*0.8,r*0.5);
      ctx.closePath();
      ctx.fillStyle=flash?'#fff':e.type.color;ctx.fill();
      ctx.restore();
      // HP bar
      if(e.type.hp>5){
        const bw=r*3;
        ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(p.sx-bw/2,p.sy-r-8,bw,3);
        ctx.fillStyle=e.hp>e.type.hp*0.3?'#4f4':'#f44';
        ctx.fillRect(p.sx-bw/2,p.sy-r-8,bw*(e.hp/(e.isBoss?50+wave*10:e.type.hp)),3);
      }
      if(e.isBoss){
        ctx.fillStyle='#fff';ctx.font='10px sans-serif';ctx.textAlign='center';
        ctx.fillText('DREADNOUGHT',p.sx,p.sy-r-12);
      }
    });
    // Particles
    particles2.forEach(pt=>{
      const p=project(pt.x,pt.y,pt.z);
      if(!p||p.z<1)return;
      const alpha=pt.life/pt.maxLife;
      ctx.fillStyle=pt.color+Math.floor(alpha*200).toString(16).padStart(2,'0');
      ctx.beginPath();ctx.arc(p.sx,p.sy,Math.max(1,pt.size*p.scale),0,Math.PI*2);ctx.fill();
    });
    // Crosshair
    const cx2=canvas.width/2,cy2=canvas.height/2;
    ctx.strokeStyle='rgba(255,100,50,0.5)';ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(cx2,cy2,20,0,Math.PI*2);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx2-30,cy2);ctx.lineTo(cx2-8,cy2);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx2+8,cy2);ctx.lineTo(cx2+30,cy2);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx2,cy2-30);ctx.lineTo(cx2,cy2-8);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx2,cy2+8);ctx.lineTo(cx2,cy2+30);ctx.stroke();
    // Afterburner effect
    if(afterburner){
      for(let i=0;i<5;i++){
        const lx=canvas.width*Math.random(),ly=canvas.height*Math.random();
        ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(lx+(Math.random()-0.5)*5,ly+20+Math.random()*30);
        ctx.strokeStyle='rgba(255,200,100,0.15)';ctx.lineWidth=1;ctx.stroke();
      }
    }
    // Combo
    if(combo>2){
      ctx.fillStyle=`rgba(255,100,50,${Math.min(1,combo*0.1)})`;
      ctx.font=`bold ${18+combo}px sans-serif`;ctx.textAlign='right';
      ctx.fillText(combo+'x',canvas.width-20,canvas.height/2);
    }
  }
  ctx.restore();
  // Radar
  renderRadar();
}

function renderRadar(){
  rCtx.fillStyle='rgba(0,0,0,0.7)';rCtx.fillRect(0,0,140,140);
  rCtx.strokeStyle='rgba(255,100,50,0.2)';rCtx.lineWidth=0.5;
  rCtx.beginPath();rCtx.arc(70,70,30,0,Math.PI*2);rCtx.stroke();
  rCtx.beginPath();rCtx.arc(70,70,60,0,Math.PI*2);rCtx.stroke();
  // Enemies on radar
  enemies2.forEach(e=>{
    if(!e.alive)return;
    const dx=(e.x-px)*0.05,dz=(e.z-pz)*0.05;
    const cosY=Math.cos(-yaw),sinY=Math.sin(-yaw);
    const rx3=dx*cosY-dz*sinY,rz3=dx*sinY+dz*cosY;
    const ex=70+rx3,ey=70-rz3;
    if(ex>5&&ex<135&&ey>5&&ey<135){
      rCtx.fillStyle=e.isBoss?'#ff0':e.type.color;
      rCtx.fillRect(ex-2,ey-2,4,4);
    }
  });
  // Player dot
  rCtx.fillStyle='#0f0';rCtx.beginPath();rCtx.arc(70,70,2,0,Math.PI*2);rCtx.fill();
  // Direction
  rCtx.strokeStyle='#0f0';rCtx.lineWidth=1;rCtx.beginPath();rCtx.moveTo(70,70);rCtx.lineTo(70,70-8);rCtx.stroke();
}

// ===== INPUT =====
document.addEventListener('keydown',e=>{
  keys2[e.code]=true;
  if(e.code==='Escape'){
    if(gSt===ST.PLAY){gSt=ST.PAUSE;document.getElementById('pause').style.display='flex';}
    else if(gSt===ST.PAUSE){gSt=ST.PLAY;document.getElementById('pause').style.display='none';}
  }
  if(e.code==='KeyR'&&(gSt===ST.OVER||gSt===ST.PLAY))startGame2();
  if(e.code==='Space')e.preventDefault();
  if(e.code==='Digit1'){curWeapon=0;}
  if(e.code==='Digit2'){curWeapon=1;}
  if(e.code==='Digit3'){curWeapon=2;}
});
document.addEventListener('keyup',e=>{keys2[e.code]=false;});
canvas.addEventListener('mousedown',()=>{mouseDown2=true;sfx.init();});
canvas.addEventListener('mouseup',()=>{mouseDown2=false;});
canvas.addEventListener('mousemove',e=>{
  if(gSt===ST.PLAY){
    yaw+=(e.movementX||0)*0.002;
    pitch=Math.max(-Math.PI/3,Math.min(Math.PI/3,pitch-(e.movementY||0)*0.002));
  }
  mouseX2=e.clientX;mouseY2=e.clientY;
});
canvas.addEventListener('click',()=>{if(gSt===ST.PLAY)canvas.requestPointerLock&&canvas.requestPointerLock();});
document.addEventListener('pointerlockchange',()=>{});

// Touch
canvas.addEventListener('touchstart',e=>{e.preventDefault();sfx.init();mouseDown2=true;mouseX2=e.touches[0].clientX;mouseY2=e.touches[0].clientY;},{passive:false});
canvas.addEventListener('touchmove',e=>{e.preventDefault();const t2=e.touches[0];yaw+=(t2.clientX-mouseX2)*0.003;pitch=Math.max(-Math.PI/3,Math.min(Math.PI/3,pitch-(t2.clientY-mouseY2)*0.003));mouseX2=t2.clientX;mouseY2=t2.clientY;},{passive:false});
canvas.addEventListener('touchend',()=>{mouseDown2=false;});
['tl2','tr2','tu2','td2','tf2','tb2'].forEach(id=>{
  const el=document.getElementById(id);if(!el)return;
  el.addEventListener('touchstart',e=>{e.preventDefault();sfx.init();
    if(id==='tl2')touchD2.x=-1;if(id==='tr2')touchD2.x=1;
    if(id==='tu2')touchD2.y=-1;if(id==='td2')touchD2.y=1;
    if(id==='tf2')touchFire=true;
    if(id==='tb2')keys2['Space']=true;
  },{passive:false});
  el.addEventListener('touchend',()=>{
    if(id==='tl2'||id==='tr2')touchD2.x=0;
    if(id==='tu2'||id==='td2')touchD2.y=0;
    if(id==='tf2')touchFire=false;
    if(id==='tb2')keys2['Space']=false;
  });
});

// Menu
document.querySelectorAll('.db').forEach(b=>{
  b.addEventListener('click',()=>{document.querySelectorAll('.db').forEach(x=>x.classList.remove('active'));b.classList.add('active');diff=b.dataset.d;sfx.init();sfx.click();});
});
document.getElementById('b-start').addEventListener('click',()=>{sfx.init();sfx.click();startGame2();});
document.getElementById('b-tut').addEventListener('click',()=>{sfx.init();sfx.click();startGame2();});
document.getElementById('b-res').addEventListener('click',()=>{gSt=ST.PLAY;document.getElementById('pause').style.display='none';sfx.click();canvas.requestPointerLock&&canvas.requestPointerLock();});
document.getElementById('b-quit').addEventListener('click',()=>{gSt=ST.TITLE;document.getElementById('pause').style.display='none';document.getElementById('title').style.display='flex';['hud','sb','hint','radar'].forEach(id=>document.getElementById(id).style.display='none');sfx.click();});
document.getElementById('b-retry').addEventListener('click',()=>{sfx.click();startGame2();});
document.getElementById('b-menu').addEventListener('click',()=>{gSt=ST.TITLE;document.getElementById('gover').style.display='none';document.getElementById('title').style.display='flex';['hud','sb','hint','radar'].forEach(id=>document.getElementById(id).style.display='none');sfx.click();});

// ===== LOOP =====
let lastT2=0;
function loop2(ts){
  const dt=Math.min((ts-lastT2)/1000,0.05);
  lastT2=ts;
  update2(dt);
  render2();
  requestAnimationFrame(loop2);
}
try{const s=localStorage.getItem('nf_scores');if(s)highScores2=JSON.parse(s);}catch(e){}
lastT2=performance.now();
requestAnimationFrame(loop2);
</script>
</body>
</html>