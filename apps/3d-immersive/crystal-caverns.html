<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="3d_immersive">
<meta name="rappterzoo:tags" content="canvas,3d,procedural,exploration,audio,game,crystals">
<meta name="rappterzoo:type" content="game">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="1">
<title>Crystal Caverns - 3D Exploration Game</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;overflow:hidden;font-family:'Segoe UI',sans-serif;color:#fff}
canvas{display:block}
#title{position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at center,#0a0020 0%,#000 80%);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
#title h1{font-size:48px;color:#cc66ff;text-shadow:0 0 40px rgba(200,100,255,0.5);margin-bottom:8px;letter-spacing:4px}
#title .sub{font-size:16px;color:#8844aa;margin-bottom:40px}
.btn{background:linear-gradient(135deg,rgba(200,100,255,0.15),rgba(200,100,255,0.03));border:1px solid rgba(200,100,255,0.4);color:#cc66ff;padding:14px 40px;font-size:16px;border-radius:6px;cursor:pointer;margin:6px;min-width:200px;font-family:inherit;transition:all 0.3s}
.btn:hover{background:linear-gradient(135deg,rgba(200,100,255,0.3),rgba(200,100,255,0.1));border-color:#cc66ff;transform:translateY(-2px);box-shadow:0 4px 25px rgba(200,100,255,0.4)}
.dr{display:flex;gap:10px;margin:10px 0}
.db{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);color:#888;padding:8px 20px;border-radius:4px;cursor:pointer;transition:all 0.3s;font-family:inherit;font-size:13px}
.db:hover,.db.active{background:rgba(200,100,255,0.2);border-color:#cc66ff;color:#cc66ff}
#hud{position:fixed;top:10px;left:10px;background:rgba(0,0,0,0.75);border:1px solid rgba(200,100,255,0.3);border-radius:8px;padding:12px 16px;font-size:13px;z-index:10;backdrop-filter:blur(5px);min-width:210px;display:none}
#hud h3{color:#cc66ff;margin-bottom:8px}
.hs{display:flex;justify-content:space-between;margin:3px 0}.hs .hl{color:#8844aa}.hs .hv{color:#fff;font-weight:bold}
.hb{height:5px;background:rgba(255,255,255,0.1);border-radius:3px;margin:3px 0}
.hb-f{height:100%;border-radius:3px;transition:width 0.2s}
#inv{position:fixed;top:10px;right:10px;background:rgba(0,0,0,0.75);border:1px solid rgba(255,200,50,0.3);border-radius:8px;padding:12px 16px;font-size:12px;z-index:10;backdrop-filter:blur(5px);min-width:170px;display:none}
#inv h3{color:#fc8;margin-bottom:6px}
.ie{display:flex;justify-content:space-between;margin:2px 0;align-items:center}
.ie .ic{width:10px;height:10px;border-radius:50%;margin-right:6px}
#pause-s{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(8px)}
#pause-s h2{font-size:36px;color:#cc66ff;margin-bottom:20px}
#go-s{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:300;backdrop-filter:blur(10px)}
#go-s h2{font-size:42px;margin-bottom:10px}
.go-sc{font-size:24px;color:#cc66ff;margin-bottom:10px}
.go-g{display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;margin:20px 0;text-align:left}
.go-g .gl{color:#8844aa}.go-g .gv{color:#fff;font-weight:bold}
#hint{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);font-size:11px;color:rgba(255,255,255,0.2);z-index:10;display:none}
#tp{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:none;gap:10px;z-index:20}
.tb{width:56px;height:56px;border-radius:50%;background:rgba(200,100,255,0.15);border:2px solid rgba(200,100,255,0.4);color:#cc66ff;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;touch-action:manipulation}
#minimap{position:fixed;bottom:60px;right:10px;width:120px;height:120px;border:1px solid rgba(200,100,255,0.3);border-radius:8px;background:rgba(0,0,0,0.7);z-index:10;display:none}
@media(max-width:768px){#title h1{font-size:30px}#tp{display:flex}#hud{font-size:11px;padding:8px}}
</style>
</head>
<body>
<div id="title">
  <h1>CRYSTAL CAVERNS</h1>
  <div class="sub">3D Exploration Game</div>
  <div style="color:#557;margin-bottom:15px;font-size:13px">Difficulty:</div>
  <div class="dr">
    <button class="db" data-d="easy">Easy</button>
    <button class="db active" data-d="normal">Normal</button>
    <button class="db" data-d="hard">Hard</button>
  </div>
  <button class="btn" id="b-start" style="margin-top:20px">Explore</button>
  <button class="btn" id="b-tut" style="font-size:13px;padding:10px 30px">Tutorial</button>
  <div style="margin-top:30px;color:#445;font-size:12px">WASD: Move | Mouse: Look | Click: Mine | E: Use Item | Space: Jump | ESC: Pause | R: Restart</div>
</div>
<div id="pause-s"><h2>PAUSED</h2><button class="btn" id="b-res">Resume</button><button class="btn" id="b-quit">Quit</button></div>
<div id="go-s">
  <h2 id="go-t">EXPEDITION COMPLETE</h2>
  <div class="go-sc" id="go-fs"></div>
  <div class="go-g" id="go-sg"></div>
  <button class="btn" id="b-retry">Explore Again (R)</button>
  <button class="btn" id="b-menu" style="font-size:13px;padding:10px 30px">Main Menu</button>
</div>
<div id="hud">
  <h3>CRYSTAL CAVERNS</h3>
  <div class="hs"><span class="hl">Score</span><span class="hv" id="h-sc">0</span></div>
  <div class="hs"><span class="hl">Depth</span><span class="hv" id="h-dep">0m</span></div>
  <div class="hs"><span class="hl">Crystals</span><span class="hv" id="h-cry">0</span></div>
  <div class="hs"><span class="hl">Level</span><span class="hv" id="h-lvl">1</span></div>
  <div class="hs"><span class="hl">Combo</span><span class="hv" id="h-cmb">0</span></div>
  <div style="margin-top:6px">
    <div class="hs"><span class="hl">Health</span></div>
    <div class="hb"><div class="hb-f" id="bar-hp" style="width:100%;background:linear-gradient(90deg,#f44,#4f4)"></div></div>
  </div>
  <div>
    <div class="hs"><span class="hl">Light</span></div>
    <div class="hb"><div class="hb-f" id="bar-lt" style="width:100%;background:linear-gradient(90deg,#440,#ff0)"></div></div>
  </div>
  <div>
    <div class="hs"><span class="hl">Pickaxe</span></div>
    <div class="hb"><div class="hb-f" id="bar-pk" style="width:100%;background:linear-gradient(90deg,#666,#ccc)"></div></div>
  </div>
</div>
<div id="inv">
  <h3>INVENTORY</h3>
  <div id="inv-list"></div>
</div>
<div id="hint">WASD: Move | Mouse: Look | Click: Mine | E: Use | Space: Jump | ESC: Pause</div>
<div id="tp">
  <button class="tb" id="tl">&#9664;</button>
  <button class="tb" id="tu">&#9650;</button>
  <button class="tb" id="td">&#9660;</button>
  <button class="tb" id="tr">&#9654;</button>
  <button class="tb" id="tj" style="background:rgba(100,255,100,0.15);border-color:rgba(100,255,100,0.4);color:#4f4">J</button>
  <button class="tb" id="tm" style="background:rgba(255,100,100,0.15);border-color:rgba(255,100,100,0.4);color:#f44">M</button>
</div>
<canvas id="minimap" width="120" height="120"></canvas>
<canvas id="c"></canvas>
<script>
// ===== AUDIO =====
class CavAudio {
  constructor(){this.ctx=null;this.g=null;this.on=false}
  init(){if(this.on)return;try{this.ctx=new(window.AudioContext||window.webkitAudioContext)();this.g=this.ctx.createGain();this.g.gain.value=0.2;this.g.connect(this.ctx.destination);this.on=true;this.ambience()}catch(e){}}
  t(f,d,tp,v){if(!this.on)return;const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type=tp||'sine';o.frequency.setValueAtTime(f,this.ctx.currentTime);g.gain.setValueAtTime((v||0.1)*0.3,this.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+(d||0.2));o.connect(g);g.connect(this.g);o.start();o.stop(this.ctx.currentTime+(d||0.2))}
  mine(){this.t(200,0.08,'square',0.15);this.t(150,0.1,'sawtooth',0.1)}
  collect(){this.t(880,0.1,'sine',0.12);setTimeout(()=>this.t(1100,0.12,'sine',0.1),50);setTimeout(()=>this.t(1320,0.15,'sine',0.08),100)}
  hit(){this.t(100,0.12,'sawtooth',0.2);this.t(70,0.15,'square',0.15)}
  jump(){this.t(300,0.1,'sine',0.08);setTimeout(()=>this.t(500,0.12,'sine',0.06),50)}
  levelUp(){[523,659,784,1047].forEach((n,i)=>setTimeout(()=>this.t(n,0.25,'sine',0.1),i*80))}
  combo(){this.t(660,0.06,'square',0.08);setTimeout(()=>this.t(880,0.08,'square',0.08),40)}
  click(){this.t(500,0.05,'sine',0.06)}
  ambience(){if(!this.on)return;const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type='sine';o.frequency.value=45;g.gain.value=0.01;o.connect(g);g.connect(this.g);o.start()}
  drip(){if(!this.on)return;const f=800+Math.random()*400;this.t(f,0.3,'sine',0.03)}
  crystal(){this.t(1200+Math.random()*400,0.4,'sine',0.05);this.t(600+Math.random()*200,0.5,'triangle',0.03)}
}

// ===== CONSTANTS =====
const ST={TITLE:0,PLAY:1,PAUSE:2,OVER:3};
const DIFFS={easy:{enemies:0.5,crystals:1.3,hp:150},normal:{enemies:1,crystals:1,hp:100},hard:{enemies:1.5,crystals:0.7,hp:70}};
const CRYSTAL_TYPES=[
  {name:'Amethyst',color:'#cc66ff',value:10,rarity:0.3},
  {name:'Sapphire',color:'#4488ff',value:25,rarity:0.25},
  {name:'Ruby',color:'#ff4444',value:30,rarity:0.2},
  {name:'Emerald',color:'#44ff44',value:40,rarity:0.15},
  {name:'Diamond',color:'#ffffff',value:100,rarity:0.07},
  {name:'Void Crystal',color:'#8800ff',value:200,rarity:0.03}
];
const ENEMY_TYPES=[
  {name:'Cave Bat',color:'#886666',hp:2,speed:60,damage:5,radius:8},
  {name:'Crystal Golem',color:'#cc88ff',hp:8,speed:30,damage:15,radius:20},
  {name:'Shadow',color:'#333344',hp:4,speed:80,damage:10,radius:12},
  {name:'Cave Spider',color:'#668844',hp:3,speed:100,damage:8,radius:10},
  {name:'Ancient Guardian',color:'#ffcc44',hp:20,speed:20,damage:25,radius:30}
];

// ===== STATE =====
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const mmCanvas=document.getElementById('minimap');
const mmCtx=mmCanvas.getContext('2d');
const sfx=new CavAudio();
let gSt=ST.TITLE,diff='normal';
let score=0,crystalsFound=0,depth=0,level=1,combo=0,comboTimer=0,maxCombo=0;
let health=100,maxHealth=100,light=100,pickaxeDurability=100;
let shakeAmt=0,gameTime=0;
let totalMined=0,enemiesDefeated=0;

// Player
let px=0,py=0,pz=0,pvx=0,pvy=0,pvz=0;
let pAngle=0,pPitch=0;
let grounded=true;

// World
let rooms=[];
let crystals=[];
let enemies=[];
let particles=[];
let inventory={};

// Input
let keys={},mouseX=0,mouseY=0,mouseDown=false,locked=false;
let touchD={x:0,y:0};

function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}
window.addEventListener('resize',resize);
resize();

// ===== ROOM GENERATION =====
class Room {
  constructor(cx,cy,cz,w,h,d,type){
    this.cx=cx;this.cy=cy;this.cz=cz;
    this.w=w;this.h=h;this.d=d;
    this.type=type||'normal';
    this.explored=false;
    this.walls=[];
    this.generateWalls();
  }
  generateWalls(){
    // Simple box room with walls
    this.walls=[
      {x:this.cx-this.w/2,y:this.cy,z:this.cz,w:0.1,h:this.h,d:this.d,normal:{x:1,y:0,z:0}},
      {x:this.cx+this.w/2,y:this.cy,z:this.cz,w:0.1,h:this.h,d:this.d,normal:{x:-1,y:0,z:0}},
      {x:this.cx,y:this.cy,z:this.cz-this.d/2,w:this.w,h:this.h,d:0.1,normal:{x:0,y:0,z:1}},
      {x:this.cx,y:this.cy,z:this.cz+this.d/2,w:this.w,h:this.h,d:0.1,normal:{x:0,y:0,z:-1}},
      {x:this.cx,y:this.cy-this.h/2,z:this.cz,w:this.w,h:0.1,d:this.d,normal:{x:0,y:1,z:0}},// floor
      {x:this.cx,y:this.cy+this.h/2,z:this.cz,w:this.w,h:0.1,d:this.d,normal:{x:0,y:-1,z:0}} // ceiling
    ];
  }
  contains(x,y,z){
    return x>this.cx-this.w/2&&x<this.cx+this.w/2&&
           y>this.cy-this.h/2&&y<this.cy+this.h/2&&
           z>this.cz-this.d/2&&z<this.cz+this.d/2;
  }
}

function generateCavern(){
  rooms=[];crystals=[];enemies=[];
  // Generate connected rooms
  const numRooms=8+level*2;
  let rx=0,ry=0,rz=0;
  for(let i=0;i<numRooms;i++){
    const w=100+Math.random()*150;
    const h=60+Math.random()*80;
    const d=100+Math.random()*150;
    const type=i===numRooms-1?'boss':(Math.random()<0.2?'treasure':'normal');
    rooms.push(new Room(rx,ry,rz,w,h,d,type));
    // Next room direction
    const dir=Math.floor(Math.random()*4);
    if(dir===0)rx+=w*0.7+50;
    else if(dir===1)rx-=w*0.7+50;
    else if(dir===2)rz+=d*0.7+50;
    else {rz-=d*0.7+50;ry-=20;}// go deeper
  }
  // Spawn crystals
  const dc=DIFFS[diff];
  rooms.forEach(room=>{
    const numC=Math.floor((3+Math.random()*5)*dc.crystals*(room.type==='treasure'?3:1));
    for(let i=0;i<numC;i++){
      // Pick crystal type by rarity
      let r=Math.random();
      let cType=CRYSTAL_TYPES[0];
      let cumRarity=0;
      for(const ct of CRYSTAL_TYPES){
        cumRarity+=ct.rarity;
        if(r<=cumRarity){cType=ct;break;}
      }
      crystals.push({
        x:room.cx+(Math.random()-0.5)*(room.w-20),
        y:room.cy+(Math.random()-0.5)*(room.h-20),
        z:room.cz+(Math.random()-0.5)*(room.d-20),
        type:cType,alive:true,pulse:Math.random()*Math.PI*2,
        mineProgress:0,mineRequired:2+cType.value*0.05
      });
    }
    // Spawn enemies
    if(room.type!=='normal'||Math.random()<0.5*dc.enemies){
      const numE=room.type==='boss'?1:Math.floor(1+Math.random()*2*dc.enemies);
      for(let i=0;i<numE;i++){
        const eType=room.type==='boss'?ENEMY_TYPES[4]:ENEMY_TYPES[Math.floor(Math.random()*4)];
        enemies.push({
          x:room.cx+(Math.random()-0.5)*(room.w-40),
          y:room.cy,
          z:room.cz+(Math.random()-0.5)*(room.d-40),
          vx:0,vy:0,vz:0,
          type:eType,hp:eType.hp,alive:true,
          flashTimer:0,attackTimer:1+Math.random()*2
        });
      }
    }
  });
  // Place player in first room
  px=rooms[0].cx;py=rooms[0].cy;pz=rooms[0].cz;
}

// ===== 3D PROJECTION =====
const FOV=400;
function project3D(wx,wy,wz){
  // Transform to camera space
  const dx=wx-px,dy=wy-py,dz=wz-pz;
  const cosA=Math.cos(-pAngle),sinA=Math.sin(-pAngle);
  const cosP=Math.cos(-pPitch),sinP=Math.sin(-pPitch);
  // Rotate around Y (yaw)
  const rx=dx*cosA-dz*sinA;
  const rz2=dx*sinA+dz*cosA;
  // Rotate around X (pitch)
  const ry=dy*cosP-rz2*sinP;
  const rz=dy*sinP+rz2*cosP;
  if(rz<=1)return null;
  const scale=FOV/rz;
  return{sx:canvas.width/2+rx*scale,sy:canvas.height/2-ry*scale,scale,z:rz};
}

// ===== GAME FUNCTIONS =====
function startGame(){
  gSt=ST.PLAY;
  const dc=DIFFS[diff];
  score=0;crystalsFound=0;depth=0;level=1;combo=0;comboTimer=0;maxCombo=0;
  health=dc.hp;maxHealth=dc.hp;light=100;pickaxeDurability=100;
  shakeAmt=0;gameTime=0;totalMined=0;enemiesDefeated=0;
  pAngle=0;pPitch=0;pvx=0;pvy=0;pvz=0;grounded=true;
  particles=[];inventory={};
  generateCavern();
  document.getElementById('title').style.display='none';
  document.getElementById('go-s').style.display='none';
  document.getElementById('pause-s').style.display='none';
  document.getElementById('hud').style.display='block';
  document.getElementById('inv').style.display='block';
  document.getElementById('hint').style.display='block';
  document.getElementById('minimap').style.display='block';
  sfx.init();
  // Lock pointer on desktop
  canvas.requestPointerLock && canvas.requestPointerLock();
}

function endGame(ending){
  gSt=ST.OVER;
  document.exitPointerLock && document.exitPointerLock();
  const titles={complete:'EXPEDITION COMPLETE',death:'LOST IN THE DARK',boss:'GUARDIAN DEFEATED'};
  document.getElementById('go-t').textContent=titles[ending]||'GAME OVER';
  document.getElementById('go-t').style.color=ending==='death'?'#ff4444':'#cc66ff';
  document.getElementById('go-fs').textContent='Score: '+score.toLocaleString();
  document.getElementById('go-sg').innerHTML=`
    <span class="gl">Depth</span><span class="gv">${Math.abs(Math.floor(depth))}m</span>
    <span class="gl">Crystals</span><span class="gv">${crystalsFound}</span>
    <span class="gl">Level</span><span class="gv">${level}</span>
    <span class="gl">Max Combo</span><span class="gv">${maxCombo}x</span>
    <span class="gl">Enemies</span><span class="gv">${enemiesDefeated}</span>
    <span class="gl">Time</span><span class="gv">${Math.floor(gameTime)}s</span>
  `;
  document.getElementById('go-s').style.display='flex';
  saveScores();
}

// ===== SAVE/LOAD =====
let highScores=[];
function saveScores(){try{
  highScores.push({score,level,crystals:crystalsFound,date:new Date().toLocaleDateString()});
  highScores.sort((a,b)=>b.score-a.score);
  highScores=highScores.slice(0,10);
  localStorage.setItem('cc_scores',JSON.stringify(highScores));
}catch(e){}}
function loadScores(){try{const s=localStorage.getItem('cc_scores');if(s)highScores=JSON.parse(s);}catch(e){}}

// ===== UPDATE =====
let dripTimer=0;
function update(dt){
  if(gSt!==ST.PLAY)return;
  gameTime+=dt;
  // Player movement
  let ax=0,az=0;
  if(keys['KeyW']||keys['ArrowUp']||touchD.y<0)az=1;
  if(keys['KeyS']||keys['ArrowDown']||touchD.y>0)az=-1;
  if(keys['KeyA']||keys['ArrowLeft']||touchD.x<0)ax=-1;
  if(keys['KeyD']||keys['ArrowRight']||touchD.x>0)ax=1;
  const moveSpeed=120;
  const cosA=Math.cos(pAngle),sinA=Math.sin(pAngle);
  pvx+=(ax*cosA*Math.PI/2+az*sinA)*moveSpeed*dt*3;// simplified: ax goes sideways
  pvz+=(az*cosA-ax*sinA*Math.PI/2)*moveSpeed*dt*3;// simplified: az goes forward
  // Actually: proper FPS controls
  const forward_x=Math.sin(pAngle),forward_z=Math.cos(pAngle);
  const right_x=Math.cos(pAngle),right_z=-Math.sin(pAngle);
  pvx=(ax*right_x+az*forward_x)*moveSpeed;
  pvz=(ax*right_z+az*forward_z)*moveSpeed;
  // Gravity
  pvy-=300*dt;
  // Jump
  if((keys['Space']||keys['tp-jump'])&&grounded){
    pvy=150;grounded=false;sfx.jump();
  }
  // Apply velocity
  px+=pvx*dt;py+=pvy*dt;pz+=pvz*dt;
  // Simple floor collision
  let onFloor=false;
  rooms.forEach(room=>{
    if(px>room.cx-room.w/2&&px<room.cx+room.w/2&&
       pz>room.cz-room.d/2&&pz<room.cz+room.d/2){
      const floor=room.cy-room.h/2+10;
      const ceil=room.cy+room.h/2-10;
      if(py<floor){py=floor;pvy=0;grounded=true;onFloor=true;}
      if(py>ceil){py=ceil;pvy=0;}
      // Wall collision
      if(px<room.cx-room.w/2+5){px=room.cx-room.w/2+5;pvx=0;}
      if(px>room.cx+room.w/2-5){px=room.cx+room.w/2-5;pvx=0;}
      if(pz<room.cz-room.d/2+5){pz=room.cz-room.d/2+5;pvz=0;}
      if(pz>room.cz+room.d/2-5){pz=room.cz+room.d/2-5;pvz=0;}
      if(!room.explored){room.explored=true;score+=50;}
    }
  });
  if(!onFloor&&py<-200){py=-200;pvy=0;grounded=true;}
  depth=py;
  // Mining
  if(mouseDown&&pickaxeDurability>0){
    crystals.forEach(c=>{
      if(!c.alive)return;
      const dx=c.x-px,dy=c.y-py,dz=c.z-pz;
      const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
      if(dist<40){
        c.mineProgress+=dt;
        pickaxeDurability-=dt*5;
        if(c.mineProgress>=c.mineRequired){
          c.alive=false;
          crystalsFound++;totalMined++;
          const pts=c.type.value*(1+combo*0.3);
          score+=Math.floor(pts);
          combo++;comboTimer=3;
          if(combo>maxCombo)maxCombo=combo;
          if(combo>3)sfx.combo();
          sfx.collect();
          // Add to inventory
          inventory[c.type.name]=(inventory[c.type.name]||0)+1;
          // Particles
          for(let i=0;i<10;i++){
            particles.push({
              x:c.x+(Math.random()-0.5)*10,y:c.y+(Math.random()-0.5)*10,z:c.z+(Math.random()-0.5)*10,
              vx:(Math.random()-0.5)*100,vy:50+Math.random()*80,vz:(Math.random()-0.5)*100,
              color:c.type.color,life:0.8+Math.random()*0.5,maxLife:1,size:2+Math.random()*3
            });
          }
          shakeAmt=3;
          // Level up every 10 crystals
          if(crystalsFound%10===0){level++;sfx.levelUp();shakeAmt=5;}
        }else{
          if(Math.random()<0.3)sfx.mine();
        }
      }
    });
  }
  // Enemies
  enemies.forEach(e=>{
    if(!e.alive)return;
    e.flashTimer=Math.max(0,e.flashTimer-dt);
    const dx=px-e.x,dy=py-e.y,dz=pz-e.z;
    const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
    // Move toward player if close enough
    if(dist<200&&dist>e.type.radius+10){
      const spd=e.type.speed;
      e.vx=(dx/dist)*spd;e.vz=(dz/dist)*spd;
    }else{
      e.vx*=0.9;e.vz*=0.9;
    }
    e.x+=e.vx*dt;e.z+=e.vz*dt;
    // Attack
    if(dist<e.type.radius+15){
      e.attackTimer-=dt;
      if(e.attackTimer<=0){
        e.attackTimer=1;
        health-=e.type.damage;
        shakeAmt=8;sfx.hit();
        if(health<=0){endGame('death');return;}
      }
    }
    // Player attacks enemy by mining near it
    if(mouseDown&&dist<40){
      e.hp-=dt*3;
      e.flashTimer=0.1;
      if(e.hp<=0){
        e.alive=false;
        enemiesDefeated++;
        score+=e.type.hp*20;
        sfx.collect();
        for(let i=0;i<15;i++){
          particles.push({
            x:e.x+(Math.random()-0.5)*20,y:e.y+(Math.random()-0.5)*20,z:e.z+(Math.random()-0.5)*20,
            vx:(Math.random()-0.5)*150,vy:50+Math.random()*100,vz:(Math.random()-0.5)*150,
            color:e.type.color,life:0.6+Math.random()*0.4,maxLife:1,size:2+Math.random()*4
          });
        }
        shakeAmt=5;
        // Boss defeated = win
        if(e.type.name==='Ancient Guardian'){endGame('boss');return;}
      }
    }
  });
  // Particles
  particles.forEach(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.z+=p.vz*dt;p.vy-=100*dt;p.life-=dt;});
  particles=particles.filter(p=>p.life>0);
  // Light decay
  light-=dt*2;
  if(light<0)light=0;
  // Collecting crystals restores light
  // Combo timer
  if(comboTimer>0){comboTimer-=dt;if(comboTimer<=0)combo=0;}
  // Ambient drips
  dripTimer-=dt;
  if(dripTimer<=0){dripTimer=2+Math.random()*5;sfx.drip();}
  // Crystal ambient sounds
  if(Math.random()<0.01)sfx.crystal();
  // Shake
  shakeAmt*=0.9;if(shakeAmt<0.1)shakeAmt=0;
  // Cap
  if(particles.length>300)particles.splice(0,particles.length-300);
  // Pickaxe repair slowly
  pickaxeDurability=Math.min(100,pickaxeDurability+dt*0.5);
  // Health regen very slow
  health=Math.min(maxHealth,health+dt*0.3);
  // HUD
  updateHUD();
}

function updateHUD(){
  document.getElementById('h-sc').textContent=score.toLocaleString();
  document.getElementById('h-dep').textContent=Math.abs(Math.floor(depth))+'m';
  document.getElementById('h-cry').textContent=crystalsFound;
  document.getElementById('h-lvl').textContent=level;
  document.getElementById('h-cmb').textContent=combo>0?combo+'x':'0';
  document.getElementById('bar-hp').style.width=(health/maxHealth*100)+'%';
  document.getElementById('bar-lt').style.width=light+'%';
  document.getElementById('bar-pk').style.width=pickaxeDurability+'%';
  // Inventory
  const invEl=document.getElementById('inv-list');
  invEl.innerHTML=Object.entries(inventory).map(([name,count])=>{
    const ct=CRYSTAL_TYPES.find(c=>c.name===name);
    return `<div class="ie"><span><span class="ic" style="background:${ct?ct.color:'#fff'};display:inline-block"></span>${name}</span><span style="color:#fff;font-weight:bold">${count}</span></div>`;
  }).join('');
}

// ===== RENDER =====
function render(){
  ctx.save();
  if(shakeAmt>0)ctx.translate((Math.random()-0.5)*shakeAmt*2,(Math.random()-0.5)*shakeAmt*2);
  // Background - darkness with light radius
  ctx.fillStyle='#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  // Light circle
  const lightR=100+light*3;
  const lg=ctx.createRadialGradient(canvas.width/2,canvas.height/2,0,canvas.width/2,canvas.height/2,lightR);
  lg.addColorStop(0,'rgba(255,220,150,0.08)');
  lg.addColorStop(0.5,'rgba(255,200,100,0.03)');
  lg.addColorStop(1,'transparent');
  ctx.fillStyle=lg;
  ctx.fillRect(0,0,canvas.width,canvas.height);
  if(gSt===ST.PLAY||gSt===ST.PAUSE){
    // Render walls of nearby rooms
    rooms.forEach(room=>{
      const dx=room.cx-px,dz=room.cz-pz;
      const dist=Math.sqrt(dx*dx+dz*dz);
      if(dist>400)return;// cull distant rooms
      room.walls.forEach(wall=>{
        // Project wall corners
        const hw=wall.w/2||5,hh=wall.h/2,hd=wall.d/2||5;
        let corners;
        if(wall.normal.x!==0){// YZ plane
          corners=[
            {x:wall.x,y:wall.y-hh,z:wall.z-hd},
            {x:wall.x,y:wall.y-hh,z:wall.z+hd},
            {x:wall.x,y:wall.y+hh,z:wall.z+hd},
            {x:wall.x,y:wall.y+hh,z:wall.z-hd}
          ];
        }else if(wall.normal.z!==0){// XY plane
          corners=[
            {x:wall.x-hw,y:wall.y-hh,z:wall.z},
            {x:wall.x+hw,y:wall.y-hh,z:wall.z},
            {x:wall.x+hw,y:wall.y+hh,z:wall.z},
            {x:wall.x-hw,y:wall.y+hh,z:wall.z}
          ];
        }else{// XZ plane (floor/ceiling)
          corners=[
            {x:wall.x-hw,y:wall.y,z:wall.z-hd},
            {x:wall.x+hw,y:wall.y,z:wall.z-hd},
            {x:wall.x+hw,y:wall.y,z:wall.z+hd},
            {x:wall.x-hw,y:wall.y,z:wall.z+hd}
          ];
        }
        const projected=corners.map(c=>project3D(c.x,c.y,c.z)).filter(p=>p!==null);
        if(projected.length<3)return;
        // Check if facing camera
        const avgZ=projected.reduce((s,p)=>s+p.z,0)/projected.length;
        const distToWall=Math.sqrt((wall.x-px)**2+(wall.y-py)**2+(wall.z-pz)**2);
        const wallAlpha=Math.max(0.02,Math.min(0.3,1-distToWall/400))*(light/100);
        const isFloor=wall.normal.y>0;
        const isCeiling=wall.normal.y<0;
        const wallColor=isFloor?'rgba(60,40,30,':'rgba(40,25,50,';
        ctx.beginPath();
        ctx.moveTo(projected[0].sx,projected[0].sy);
        for(let i=1;i<projected.length;i++)ctx.lineTo(projected[i].sx,projected[i].sy);
        ctx.closePath();
        ctx.fillStyle=wallColor+wallAlpha+')';
        ctx.fill();
        ctx.strokeStyle='rgba(100,60,120,'+wallAlpha*0.5+')';
        ctx.lineWidth=1;ctx.stroke();
      });
    });
    // Render crystals
    crystals.forEach(c=>{
      if(!c.alive)return;
      const dx=c.x-px,dz=c.z-pz;
      if(Math.sqrt(dx*dx+dz*dz)>300)return;
      const p=project3D(c.x,c.y,c.z);
      if(!p||p.z<1)return;
      c.pulse+=0.02;
      const r=(5+c.type.value*0.05)*(1+Math.sin(c.pulse)*0.2)*p.scale;
      if(r<1)return;
      // Crystal glow
      const gg=ctx.createRadialGradient(p.sx,p.sy,0,p.sx,p.sy,r*3);
      gg.addColorStop(0,c.type.color+'60');
      gg.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(p.sx,p.sy,r*3,0,Math.PI*2);
      ctx.fillStyle=gg;ctx.fill();
      // Crystal shape (diamond)
      ctx.save();ctx.translate(p.sx,p.sy);
      ctx.beginPath();
      ctx.moveTo(0,-r);ctx.lineTo(r*0.7,0);ctx.lineTo(0,r);ctx.lineTo(-r*0.7,0);
      ctx.closePath();
      ctx.fillStyle=c.type.color;ctx.fill();
      ctx.strokeStyle='#fff';ctx.lineWidth=0.5;ctx.stroke();
      ctx.restore();
      // Mining progress bar
      if(c.mineProgress>0){
        const bw=r*4;
        ctx.fillStyle='rgba(0,0,0,0.5)';
        ctx.fillRect(p.sx-bw/2,p.sy+r+4,bw,3);
        ctx.fillStyle=c.type.color;
        ctx.fillRect(p.sx-bw/2,p.sy+r+4,bw*(c.mineProgress/c.mineRequired),3);
      }
    });
    // Render enemies
    enemies.forEach(e=>{
      if(!e.alive)return;
      const dx=e.x-px,dz=e.z-pz;
      if(Math.sqrt(dx*dx+dz*dz)>250)return;
      const p=project3D(e.x,e.y,e.z);
      if(!p||p.z<1)return;
      const r=e.type.radius*p.scale;
      if(r<1)return;
      const flash=e.flashTimer>0;
      // Enemy glow
      const gg=ctx.createRadialGradient(p.sx,p.sy,0,p.sx,p.sy,r*2);
      gg.addColorStop(0,(flash?'#fff':e.type.color)+'40');
      gg.addColorStop(1,'transparent');
      ctx.beginPath();ctx.arc(p.sx,p.sy,r*2,0,Math.PI*2);
      ctx.fillStyle=gg;ctx.fill();
      // Body
      ctx.beginPath();ctx.arc(p.sx,p.sy,r,0,Math.PI*2);
      ctx.fillStyle=flash?'#fff':e.type.color;ctx.fill();
      // Eyes
      ctx.fillStyle='#ff0';
      ctx.beginPath();ctx.arc(p.sx-r*0.3,p.sy-r*0.2,r*0.15,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(p.sx+r*0.3,p.sy-r*0.2,r*0.15,0,Math.PI*2);ctx.fill();
      // HP bar
      const bw=r*3;
      ctx.fillStyle='rgba(0,0,0,0.5)';
      ctx.fillRect(p.sx-bw/2,p.sy-r-8,bw,4);
      ctx.fillStyle=e.hp>e.type.hp*0.3?'#4f4':'#f44';
      ctx.fillRect(p.sx-bw/2,p.sy-r-8,bw*(e.hp/e.type.hp),4);
      // Name
      ctx.fillStyle='#fff';ctx.font=(8*p.scale)+'px sans-serif';ctx.textAlign='center';
      ctx.fillText(e.type.name,p.sx,p.sy-r-12);
    });
    // Particles
    particles.forEach(pt=>{
      const p=project3D(pt.x,pt.y,pt.z);
      if(!p||p.z<1)return;
      const alpha=pt.life/pt.maxLife;
      ctx.fillStyle=pt.color+Math.floor(alpha*200).toString(16).padStart(2,'0');
      ctx.beginPath();ctx.arc(p.sx,p.sy,pt.size*p.scale,0,Math.PI*2);ctx.fill();
    });
    // Crosshair
    ctx.strokeStyle='rgba(200,100,255,0.5)';ctx.lineWidth=1;
    const cx=canvas.width/2,cy=canvas.height/2;
    ctx.beginPath();ctx.moveTo(cx-10,cy);ctx.lineTo(cx-4,cy);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx+4,cy);ctx.lineTo(cx+10,cy);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx,cy-10);ctx.lineTo(cx,cy-4);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx,cy+4);ctx.lineTo(cx,cy+10);ctx.stroke();
    // Combo display
    if(combo>2){
      ctx.fillStyle=`rgba(200,100,255,${Math.min(1,combo*0.1)})`;
      ctx.font=`bold ${18+combo}px sans-serif`;ctx.textAlign='right';
      ctx.fillText(combo+'x COMBO',canvas.width-20,100);
    }
    // Darkness vignette
    const vg=ctx.createRadialGradient(canvas.width/2,canvas.height/2,canvas.width*0.2,canvas.width/2,canvas.height/2,canvas.width*0.6);
    vg.addColorStop(0,'transparent');
    vg.addColorStop(1,`rgba(0,0,0,${0.3+0.5*(1-light/100)})`);
    ctx.fillStyle=vg;ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  ctx.restore();
  // Minimap
  renderMinimap();
}

function renderMinimap(){
  mmCtx.fillStyle='rgba(0,0,0,0.8)';
  mmCtx.fillRect(0,0,120,120);
  const scale=0.08;
  const ox=60-px*scale,oz=60-pz*scale;
  // Draw rooms
  rooms.forEach(room=>{
    const rx=room.cx*scale+ox,rz=room.cz*scale+oz;
    const rw=room.w*scale,rd=room.d*scale;
    mmCtx.fillStyle=room.explored?'rgba(100,50,120,0.5)':'rgba(50,25,60,0.3)';
    mmCtx.fillRect(rx-rw/2,rz-rd/2,rw,rd);
    mmCtx.strokeStyle='rgba(200,100,255,0.3)';mmCtx.lineWidth=0.5;
    mmCtx.strokeRect(rx-rw/2,rz-rd/2,rw,rd);
  });
  // Draw crystals
  crystals.forEach(c=>{
    if(!c.alive)return;
    mmCtx.fillStyle=c.type.color;
    mmCtx.fillRect(c.x*scale+ox-1,c.z*scale+oz-1,2,2);
  });
  // Draw enemies
  enemies.forEach(e=>{
    if(!e.alive)return;
    mmCtx.fillStyle='#f44';
    mmCtx.fillRect(e.x*scale+ox-1.5,e.z*scale+oz-1.5,3,3);
  });
  // Draw player
  mmCtx.fillStyle='#0f0';
  mmCtx.beginPath();mmCtx.arc(60,60,3,0,Math.PI*2);mmCtx.fill();
  // Direction
  mmCtx.strokeStyle='#0f0';mmCtx.lineWidth=1;
  mmCtx.beginPath();mmCtx.moveTo(60,60);
  mmCtx.lineTo(60+Math.sin(pAngle)*8,60+Math.cos(pAngle)*8);
  mmCtx.stroke();
}

// ===== INPUT =====
document.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='Escape'){
    if(gSt===ST.PLAY){gSt=ST.PAUSE;document.getElementById('pause-s').style.display='flex';document.exitPointerLock&&document.exitPointerLock();}
    else if(gSt===ST.PAUSE){gSt=ST.PLAY;document.getElementById('pause-s').style.display='none';canvas.requestPointerLock&&canvas.requestPointerLock();}
  }
  if(e.code==='KeyR'&&(gSt===ST.OVER||gSt===ST.PLAY))startGame();
  if(e.code==='Space')e.preventDefault();
});
document.addEventListener('keyup',e=>{keys[e.code]=false;});
canvas.addEventListener('mousedown',e=>{mouseDown=true;sfx.init();});
canvas.addEventListener('mouseup',()=>{mouseDown=false;});
document.addEventListener('mousemove',e=>{
  if(document.pointerLockElement===canvas||locked){
    pAngle+=e.movementX*0.003;
    pPitch=Math.max(-Math.PI/3,Math.min(Math.PI/3,pPitch+e.movementY*0.003));
  }
});
document.addEventListener('pointerlockchange',()=>{locked=document.pointerLockElement===canvas;});
canvas.addEventListener('click',()=>{if(gSt===ST.PLAY)canvas.requestPointerLock&&canvas.requestPointerLock();});

// Touch
canvas.addEventListener('touchstart',e=>{e.preventDefault();sfx.init();mouseDown=true;},{passive:false});
canvas.addEventListener('touchend',()=>{mouseDown=false;});
canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(e.touches.length>0){
    const t=e.touches[0];
    pAngle+=(t.clientX-mouseX)*0.005;
    pPitch=Math.max(-Math.PI/3,Math.min(Math.PI/3,pPitch+(t.clientY-mouseY)*0.005));
    mouseX=t.clientX;mouseY=t.clientY;
  }
},{passive:false});
['tl','tr','tu','td','tj','tm'].forEach(id=>{
  const el=document.getElementById(id);if(!el)return;
  el.addEventListener('touchstart',e=>{
    e.preventDefault();sfx.init();
    if(id==='tl')touchD.x=-1;if(id==='tr')touchD.x=1;
    if(id==='tu')touchD.y=-1;if(id==='td')touchD.y=1;
    if(id==='tj')keys['Space']=true;
    if(id==='tm')mouseDown=true;
  },{passive:false});
  el.addEventListener('touchend',()=>{
    if(id==='tl'||id==='tr')touchD.x=0;
    if(id==='tu'||id==='td')touchD.y=0;
    if(id==='tj')keys['Space']=false;
    if(id==='tm')mouseDown=false;
  });
});

// Menu
document.querySelectorAll('.db').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.db').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');diff=b.dataset.d;sfx.init();sfx.click();
  });
});
document.getElementById('b-start').addEventListener('click',()=>{sfx.init();sfx.click();startGame();});
document.getElementById('b-tut').addEventListener('click',()=>{sfx.init();sfx.click();startGame();});
document.getElementById('b-res').addEventListener('click',()=>{gSt=ST.PLAY;document.getElementById('pause-s').style.display='none';canvas.requestPointerLock&&canvas.requestPointerLock();sfx.click();});
document.getElementById('b-quit').addEventListener('click',()=>{gSt=ST.TITLE;document.getElementById('pause-s').style.display='none';document.getElementById('title').style.display='flex';['hud','inv','hint','minimap'].forEach(id=>document.getElementById(id).style.display='none');sfx.click();});
document.getElementById('b-retry').addEventListener('click',()=>{sfx.click();startGame();});
document.getElementById('b-menu').addEventListener('click',()=>{gSt=ST.TITLE;document.getElementById('go-s').style.display='none';document.getElementById('title').style.display='flex';['hud','inv','hint','minimap'].forEach(id=>document.getElementById(id).style.display='none');sfx.click();});

// ===== LOOP =====
let lastT=0;
function loop(ts){
  const dt=Math.min((ts-lastT)/1000,0.05);
  lastT=ts;
  update(dt);
  render();
  requestAnimationFrame(loop);
}
loadScores();
lastT=performance.now();
requestAnimationFrame(loop);
</script>
</body>
</html>