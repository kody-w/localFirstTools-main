<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft Copilot - Storytelling Workflows</title>
    <style>
        :root {
            --copilot-primary: #0F6CBD;
            --copilot-primary-hover: #0E5AA7;
            --copilot-secondary: #742774;
            --copilot-secondary-light: #8A3D8A;
            --copilot-text: #242424;
            --copilot-bg: #F5F5F5;
            --copilot-surface: #FFFFFF;
            --copilot-border: #E1E1E1;
            --copilot-hover-bg: #F0F0F0;
            --copilot-card-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            --copilot-focus-shadow: 0 0 0 2px rgba(15, 108, 189, 0.5);
            --copilot-success: #107C10;
            --copilot-error: #D83B01;
            --copilot-warning: #FFB900;
            --copilot-connector: #0F6CBD;
            --copilot-connector-bg: rgba(15, 108, 189, 0.1);
            --copilot-stage-bg: #F8F8F8;
            --copilot-stage-grid: rgba(0, 0, 0, 0.05);
            --copilot-chat-bg: #F5F5F5;
            --copilot-user-bubble: #E3F2FD;
            --copilot-assistant-bubble: #FFFFFF;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--copilot-bg);
            color: var(--copilot-text);
            line-height: 1.5;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 16px 0;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--copilot-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo img {
            height: 28px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            margin-left: 40px;
            gap: 24px;
        }

        .nav-tab {
            padding: 8px 4px;
            font-size: 14px;
            font-weight: 500;
            color: var(--copilot-text);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tab.active {
            border-bottom-color: var(--copilot-primary);
            color: var(--copilot-primary);
        }

        .nav-tab:hover:not(.active) {
            border-bottom-color: var(--copilot-border);
        }

        .import-export {
            margin-left: auto;
            display: flex;
            gap: 12px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--copilot-text);
        }

        .subheading {
            font-size: 16px;
            color: #666;
            margin-bottom: 32px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            outline: none;
        }

        .btn:focus {
            box-shadow: var(--copilot-focus-shadow);
        }

        .btn-primary {
            background-color: var(--copilot-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--copilot-primary-hover);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--copilot-primary);
            border: 1px solid var(--copilot-primary);
        }

        .btn-secondary:hover {
            background-color: rgba(15, 108, 189, 0.05);
        }

        /* Main layout styling */
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            min-height: calc(100vh - 200px);
        }

        /* Left sidebar - Agent catalog */
        .agent-catalog {
            background-color: var(--copilot-surface);
            border-radius: 8px;
            box-shadow: var(--copilot-card-shadow);
            padding: 20px;
            border: 1px solid var(--copilot-border);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .catalog-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .search-box {
            margin-bottom: 16px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border-radius: 4px;
            border: 1px solid var(--copilot-border);
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .agent-category {
            margin-bottom: 20px;
        }

        .category-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #666;
            border-bottom: 1px solid var(--copilot-border);
            padding-bottom: 8px;
        }

        .agent-item {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: var(--copilot-bg);
            cursor: grab;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .agent-item:hover {
            border-color: var(--copilot-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .agent-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .agent-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .agent-name {
            font-size: 14px;
            font-weight: 600;
        }

        .agent-description {
            font-size: 12px;
            color: #666;
        }

        /* Right content - Storytelling stage */
        .stage-container {
            display: flex;
            flex-direction: column;
        }

        /* Tabs for different workflows */
        .workflow-tabs {
            display: flex;
            border-bottom: 1px solid var(--copilot-border);
            margin-bottom: 20px;
            gap: 4px;
        }

        .workflow-tab {
            padding: 10px 16px;
            font-size: 14px;
            border-radius: 4px 4px 0 0;
            border: 1px solid var(--copilot-border);
            border-bottom: none;
            background-color: var(--copilot-bg);
            cursor: pointer;
            position: relative;
            top: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .workflow-tab.active {
            background-color: var(--copilot-surface);
            border-bottom: 1px solid var(--copilot-surface);
        }

        .workflow-tab-name {
            max-width: 140px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .add-workflow-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--copilot-primary);
            color: white;
            font-size: 18px;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-workflow-btn:hover {
            background-color: var(--copilot-primary-hover);
        }

        .close-tab {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: #999;
            font-size: 14px;
            cursor: pointer;
        }

        .close-tab:hover {
            background-color: rgba(0, 0, 0, 0.1);
            color: #666;
        }

        /* Storytelling stage */
        .storytelling-stage {
            flex: 1;
            background-color: var(--copilot-stage-bg);
            border-radius: 8px;
            border: 1px solid var(--copilot-border);
            overflow: hidden;
            position: relative;
            min-height: 500px;
            background-image: 
                linear-gradient(to right, var(--copilot-stage-grid) 1px, transparent 1px),
                linear-gradient(to bottom, var(--copilot-stage-grid) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Stage controls */
        .stage-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
        }

        .stage-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--copilot-primary);
            transition: all 0.2s;
        }

        .stage-control-btn:hover {
            background-color: var(--copilot-primary);
            color: white;
        }

        /* Agent on stage */
        .stage-agent {
            position: absolute;
            width: 300px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 12px;
            cursor: move;
            user-select: none;
            transition: box-shadow 0.2s;
            border: 1px solid var(--copilot-border);
        }

        .stage-agent:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .stage-agent.selected {
            border-color: var(--copilot-primary);
            box-shadow: 0 0 0 2px rgba(15, 108, 189, 0.3);
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .agent-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .agent-title {
            font-size: 14px;
            font-weight: 600;
            flex: 1;
        }

        .agent-menu {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
        }

        .agent-menu:hover {
            background-color: var(--copilot-hover-bg);
        }

        .agent-content {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .agent-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-edit {
            font-size: 12px;
            color: var(--copilot-primary);
            cursor: pointer;
        }

        .agent-run {
            font-size: 12px;
            color: var(--copilot-success);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* New agent response section */
        .agent-response {
            background-color: var(--copilot-bg);
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.5;
            border: 1px solid var(--copilot-border);
            display: none;
        }

        .agent-response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 4px;
            margin-bottom: 4px;
            border-bottom: 1px solid var(--copilot-border);
            font-weight: 600;
            color: var(--copilot-primary);
        }

        .agent-response-close {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            color: #999;
        }

        .agent-response-close:hover {
            background-color: rgba(0, 0, 0, 0.1);
            color: #666;
        }

        .agent-response-content {
            word-break: break-word;
        }

        .agent-response-content pre {
            white-space: pre-wrap;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            background-color: #f5f5f5;
            padding: 4px;
            border-radius: 2px;
        }

        .agent-response-content code {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .agent-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .agent-status-idle {
            background-color: #ccc;
        }

        .agent-status-running {
            background-color: var(--copilot-warning);
            animation: pulse 1.5s infinite;
        }

        .agent-status-success {
            background-color: var(--copilot-success);
        }

        .agent-status-error {
            background-color: var(--copilot-error);
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .connector-points {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--copilot-primary);
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }

        .connector-point-right {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connector-point-left {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connector-point-top {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connector-point-bottom {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Connector lines */
        .connector-line {
            position: absolute;
            height: 2px;
            background-color: var(--copilot-primary);
            transform-origin: left center;
            z-index: 5;
        }

        .connector-line::after {
            content: "";
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 8px solid var(--copilot-primary);
        }

        /* Agent configuration panel */
        .agent-config-panel {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 320px;
            background-color: white;
            box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 50;
            overflow-y: auto;
        }

        .agent-config-panel.open {
            transform: translateX(0);
        }

        .config-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .config-panel-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-panel {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
        }

        .close-panel:hover {
            background-color: var(--copilot-hover-bg);
        }

        .config-section {
            margin-bottom: 24px;
        }

        .config-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #666;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--copilot-border);
            border-radius: 4px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--copilot-primary);
            box-shadow: var(--copilot-focus-shadow);
        }

        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--copilot-border);
            border-radius: 4px;
            font-size: 14px;
            min-height: 120px;
            resize: vertical;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--copilot-primary);
            box-shadow: var(--copilot-focus-shadow);
        }

        .panel-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--copilot-border);
        }

        /* Connections panel */
        .connection-form {
            background-color: var(--copilot-connector-bg);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .connection-info {
            font-size: 14px;
            margin-bottom: 16px;
        }

        .connection-agent {
            font-weight: 600;
            color: var(--copilot-primary);
        }

        /* Response section */
        .response-section {
            margin-top: 24px;
        }

        .response-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .response-title {
            font-size: 16px;
            font-weight: 600;
        }

        .response-actions {
            display: flex;
            gap: 12px;
        }

        .response-container {
            background-color: var(--copilot-surface);
            border-radius: 8px;
            box-shadow: var(--copilot-card-shadow);
            border: 1px solid var(--copilot-border);
            overflow: hidden;
        }

        .response-content {
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            padding: 16px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
        }

        .response-content code {
            background-color: #E8E8E8;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
        }

        .response-content strong {
            font-weight: 600;
        }

        /* Loading indicator */
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 16px 0;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(15, 108, 189, 0.3);
            border-radius: 50%;
            border-top-color: var(--copilot-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: #666;
        }

        /* Status message */
        .status-message {
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 16px;
            display: none;
        }

        .status-success {
            background-color: #ECFAED;
            color: var(--copilot-success);
            border-left: 4px solid var(--copilot-success);
        }

        .status-error {
            background-color: #FDEFE8;
            color: var(--copilot-error);
            border-left: 4px solid var(--copilot-error);
        }

        /* Various modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--copilot-surface);
            border-radius: 8px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--copilot-border);
        }

        /* Create workflow dialog */
        .workflow-name-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--copilot-border);
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            padding: 5px;
            border-radius: 3px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* File input styling */
        .file-input {
            display: none;
        }

        .file-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--copilot-primary);
            font-size: 14px;
        }

        .file-label:hover {
            text-decoration: underline;
        }

        /* Context menu */
        .context-menu {
            position: absolute;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            z-index: 100;
            min-width: 150px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: var(--copilot-hover-bg);
        }

        .context-menu-separator {
            height: 1px;
            background-color: var(--copilot-border);
            margin: 4px 0;
        }

        /* Workflow summary */
        .workflow-summary {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .workflow-info {
            max-width: 60%;
        }

        .workflow-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .workflow-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .workflow-meta {
            font-size: 12px;
            color: #999;
        }

        .workflow-controls {
            display: flex;
            gap: 12px;
        }

        .workflow-btn {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Agent palette items */
        .email-agent {
            --agent-color: #3B96D2;
        }

        .dynamics-agent {
            --agent-color: #8E44AD;
        }

        .memory-agent {
            --agent-color: #27AE60;
        }

        .custom-agent {
            --agent-color: #F39C12;
        }

        .agent-color-email {
            background-color: #3B96D2;
        }

        .agent-color-dynamics {
            background-color: #8E44AD;
        }

        .agent-color-memory {
            background-color: #27AE60;
        }

        .agent-color-custom {
            background-color: #F39C12;
        }

        .agent-icon-email, 
        .agent-icon-dynamics,
        .agent-icon-memory,
        .agent-icon-custom {
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .agent-icon-email {
            background-color: #3B96D2;
        }

        .agent-icon-dynamics {
            background-color: #8E44AD;
        }

        .agent-icon-memory {
            background-color: #27AE60;
        }

        .agent-icon-custom {
            background-color: #F39C12;
        }

        /* Empty stage */
        .empty-stage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #999;
            max-width: 300px;
            transition: opacity 0.3s;
        }

        .empty-stage-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-stage-text {
            font-size: 16px;
            margin-bottom: 24px;
        }

        /* Minimap */
        .stage-minimap {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 160px;
            height: 120px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid var(--copilot-border);
            display: none;
        }

        .minimap-content {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: var(--copilot-stage-bg);
        }

        .minimap-viewport {
            position: absolute;
            border: 2px solid var(--copilot-primary);
            background-color: rgba(15, 108, 189, 0.1);
            cursor: move;
        }

        .minimap-agent {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--copilot-border);
            border-radius: 2px;
        }

        /* Run mode overlay */
        .run-mode-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

        .run-status {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .run-progress {
            width: 300px;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .run-progress-bar {
            height: 100%;
            background-color: var(--copilot-primary);
            width: 0;
            transition: width 0.5s;
        }

        .run-action-btn {
            background-color: white;
            color: var(--copilot-primary);
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .run-action-btn:hover {
            background-color: var(--copilot-primary);
            color: white;
        }

        /* Chat interface styles */
        .chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px;
            height: 90vh;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--copilot-border);
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-title-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--copilot-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .chat-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #666;
        }

        .chat-close:hover {
            background-color: var(--copilot-hover-bg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: var(--copilot-chat-bg);
        }

        .chat-message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }

        .chat-message.user {
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-message.assistant {
            align-self: flex-start;
            margin-right: auto;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            max-width: 100%;
            word-wrap: break-word;
        }

        .user .message-bubble {
            background-color: var(--copilot-user-bubble);
            color: var(--copilot-text);
            border-bottom-right-radius: 4px;
        }

        .assistant .message-bubble {
            background-color: var(--copilot-assistant-bubble);
            color: var(--copilot-text);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message-sender {
            font-size: 12px;
            margin-bottom: 4px;
            color: #666;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            align-self: flex-end;
        }

        .chat-input-container {
            padding: 16px 20px;
            border-top: 1px solid var(--copilot-border);
            background-color: white;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            position: relative;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border-radius: 24px;
            border: 1px solid var(--copilot-border);
            font-size: 14px;
            resize: none;
            max-height: 150px;
            min-height: 48px;
            background-color: #F9F9F9;
            transition: all 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--copilot-primary);
            background-color: white;
            box-shadow: 0 0 0 2px rgba(15, 108, 189, 0.2);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--copilot-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
        }

        .chat-send-btn:disabled {
            background-color: #CCC;
            cursor: not-allowed;
        }

        .chat-send-btn svg {
            width: 20px;
            height: 20px;
        }

        .message-content {
            white-space: pre-wrap;
        }

        .message-content code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
        }

        .message-content pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 8px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-typing {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 8px 0;
            color: #666;
            font-size: 14px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #999;
            border-radius: 50%;
            margin: 0 1px;
            opacity: 0.6;
            animation: typingAnimation 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 100% { opacity: 0.6; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-4px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="14" cy="14" r="13" fill="#742774" />
                    <path d="M8 11L14 7L20 11V17L14 21L8 17V11Z" fill="white" stroke="#742774" stroke-width="0.5" />
                    <path d="M14 7V14M14 14V21M14 14L8 11M14 14L20 11" stroke="white" stroke-width="1.2" />
                    <circle cx="14" cy="14" r="2" fill="white" />
                </svg>
                <div class="logo-text">Microsoft Copilot</div>
            </div>
            <div class="nav-tabs">
                <div class="nav-tab active">Storytelling Workflows</div>
                <div class="nav-tab">My Actions</div>
                <div class="nav-tab">Settings</div>
            </div>
            <div class="import-export">
                <input type="file" id="fileInput" class="file-input" accept=".json">
                <label for="fileInput" class="file-label">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8.67969 1.83203C8.44401 1.59635 8.06234 1.59635 7.82666 1.83203L3.82666 5.83203C3.59098 6.06771 3.59098 6.44938 3.82666 6.68506C4.06234 6.92074 4.44401 6.92074 4.67969 6.68506L7.25 4.11474V11C7.25 11.3314 7.51865 11.6 7.85 11.6C8.18135 11.6 8.45 11.3314 8.45 11V4.11474L11.0203 6.68506C11.256 6.92074 11.6377 6.92074 11.8733 6.68506C12.109 6.44938 12.109 6.06771 11.8733 5.83203L8.67969 1.83203Z" fill="currentColor"/>
                        <path d="M2.5 9C2.5 8.66863 2.23137 8.4 1.9 8.4C1.56863 8.4 1.3 8.66863 1.3 9V12.1C1.3 13.041 2.05888 13.8 2.99998 13.8H13C13.9411 13.8 14.7 13.041 14.7 12.1V9C14.7 8.66863 14.4314 8.4 14.1 8.4C13.7686 8.4 13.5 8.66863 13.5 9V12.1C13.5 12.3761 13.2761 12.6 13 12.6H2.99998C2.72384 12.6 2.5 12.3761 2.5 12.1V9Z" fill="currentColor"/>
                    </svg>
                    Import
                </label>
                <button id="exportBtn" class="btn btn-secondary">Export</button>
            </div>
        </header>

        <h1>Storytelling Workflows</h1>
        <div class="subheading">Create powerful automations by connecting agents in an intuitive storytelling interface.</div>

        <div id="statusMessage" class="status-message"></div>

        <!-- Workflow Summary Section -->
        <div class="workflow-summary">
            <div class="workflow-info">
                <div class="workflow-title">
                    <span id="current-workflow-name">Opportunity Summary Email</span>
                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" id="editWorkflowDetailsBtn">Edit</button>
                </div>
                <div class="workflow-description" id="current-workflow-description">
                    This workflow retrieves your active sales opportunities from Dynamics 365 and sends a summary email to your team lead.
                </div>
                <div class="workflow-meta">Created: March 15, 2025 â€¢ Last run: March 17, 2025</div>
            </div>
            <div class="workflow-controls">
                <button class="btn btn-secondary workflow-btn" id="saveWorkflowBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V7L17 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M17 3V7H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 16.5V13.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M17 16.5V13.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 16.5V13.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Save
                </button>
                <button class="btn btn-primary workflow-btn" id="runWorkflowBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 3L19 12L5 21V3Z" fill="currentColor"/>
                    </svg>
                    Run Workflow
                </button>
            </div>
        </div>

        <!-- Main Grid Layout -->
        <div class="main-grid">
            <!-- Left Sidebar - Agent Catalog -->
            <div class="agent-catalog">
                <div class="catalog-title">
                    <span>Agent Catalog</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 12H16M12 8V16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="search-box">
                    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <input type="text" class="search-input" placeholder="Search agents...">
                </div>

                <!-- Email Agents -->
                <div class="agent-category">
                    <div class="category-header">Email Agents</div>
                    
                    <div class="agent-item" draggable="true" data-agent-type="email" data-agent-id="sendStatusEmail">
                        <div class="agent-item-header">
                            <div class="agent-icon agent-icon-email">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 5.25L12 13.5L3 5.25" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M3 5.25H21V18C21 18.1989 20.921 18.3897 20.7803 18.5303C20.6397 18.671 20.4489 18.75 20.25 18.75H3.75C3.55109 18.75 3.36032 18.671 3.21967 18.5303C3.07902 18.3897 3 18.1989 3 18V5.25Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="agent-name">Send Status Update</div>
                        </div>
                        <div class="agent-description">Send a status report email to your team lead with project progress and metrics.</div>
                    </div>

                    <div class="agent-item" draggable="true" data-agent-type="email" data-agent-id="scheduleClientMeeting">
                        <div class="agent-item-header">
                            <div class="agent-icon agent-icon-email">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 5.25L12 13.5L3 5.25" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M3 5.25H21V18C21 18.1989 20.921 18.3897 20.7803 18.5303C20.6397 18.671 20.4489 18.75 20.25 18.75H3.75C3.55109 18.75 3.36032 18.671 3.21967 18.5303C3.07902 18.3897 3 18.1989 3 18V5.25Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="agent-name">Schedule Client Meeting</div>
                        </div>
                        <div class="agent-description">Send a professional email to schedule a meeting with a client.</div>
                    </div>

                    <div class="agent-item" draggable="true" data-agent-type="email" data-agent-id="sendOpportunitySummary">
                        <div class="agent-item-header">
                            <div class="agent-icon agent-icon-email">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 5.25L12 13.5L3 5.25" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M3 5.25H21V18C21 18.1989 20.921 18.3897 20.7803 18.5303C20.6397 18.671 20.4489 18.75 20.25 18.75H3.75C3.55109 18.75 3.36032 18.671 3.21967 18.5303C3.07902 18.3897 3 18.1989 3 18V5.25Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="agent-name">Send Opportunity Summary</div>
                        </div>
                        <div class="agent-description">Send an email with a summary of your active sales opportunities.</div>
                    </div>
                </div>

                <!-- Dynamics 365 Agents -->
                <div class="agent-category">
                    <div class="category-header">Dynamics 365</div>
                    
                    <div class="agent-item" draggable="true" data-agent-type="dynamics" data-agent-id="getOpportunities">
                        <div class="agent-item-header">
                            <div class="agent-icon agent-icon-dynamics">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M9 7H7V17H9V7Z" fill="currentColor"/>
                                    <path d="M17 7H15V17H17V7Z" fill="currentColor"/>
                                    <path d="M13 7H11V17H13V7Z" fill="currentColor"/>
                                </svg>
                            </div>
                            <div class="agent-name">View My Opportunities</div>
                        </div>
                        <div class="agent-description">Retrieve all active sales opportunities assigned to you.</div>
                    </div>

                    <div class="agent-item" draggable="true" data-agent-type="dynamics" data-agent-id="createLead">
                        <div class="agent-item-header">
                            <div class="agent-icon agent-icon-dynamics">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M9 7H7V17H9V7Z" fill="currentColor"/>
                                    <path d="M17 7H15V17H17V7Z" fill="currentColor"/>
                                    <path d="M13 7H11V17H13V7Z" fill="currentColor"/>
                                </svg>
                            </div>
                            <div class="agent-name">Create Lead</div>
                        </div>
                        <div class="agent-description">Create a new lead in Dynamics 365 with contact information.</div>
                    </div>
                </div>

                <!-- Memory Agents -->
                <div class="agent-category">
                    <div class="category-header">Memory Agents</div>
                    
                    <div class="agent-item" draggable="true" data-agent-type="memory" data-agent-id="saveDailySummary">
                        <div class="agent-item-header">
                            <div class="agent-icon agent-icon-memory">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 11L12 14L16 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="agent-name">Save Daily Summary</div>
                        </div>
                        <div class="agent-description">Save a summary of today's activities to your personal memory.</div>
                    </div>

                    <div class="agent-item" draggable="true" data-agent-type="memory" data-agent-id="recallContext">
                        <div class="agent-item-header">
                            <div class="agent-icon agent-icon-memory">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 11L12 14L16 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="agent-name">Recall Previous Interactions</div>
                        </div>
                        <div class="agent-description">Retrieve context from your previous interactions with clients and projects.</div>
                    </div>
                </div>

                <!-- Custom Agents -->
                <div class="agent-category">
                    <div class="category-header">Custom Agents</div>
                    
                    <div class="agent-item" draggable="true" data-agent-type="custom" data-agent-id="processDocuments">
                        <div class="agent-item-header">
                            <div class="agent-icon agent-icon-custom">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M13 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V9L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M13 2V9H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="agent-name">Process Documents</div>
                        </div>
                        <div class="agent-description">Process document files for analysis.</div>
                    </div>

                    <div class="agent-item" draggable="true" data-agent-type="custom" data-agent-id="autoAnswerQuestions">
                        <div class="agent-item-header">
                            <div class="agent-icon agent-icon-custom">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M13 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V9L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M13 2V9H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="agent-name">Auto-Answer Questions</div>
                        </div>
                        <div class="agent-description">Automatically answer questions from processed documents.</div>
                    </div>
                </div>
            </div>

            <!-- Right Content Area - Storytelling Stage -->
            <div class="stage-container">
                <!-- Workflow Tabs -->
                <div class="workflow-tabs">
                    <div class="workflow-tab active" data-workflow-id="opportunity-email">
                        <span class="workflow-tab-name">Opportunity Summary Email</span>
                        <span class="close-tab">&times;</span>
                    </div>
                    <div class="workflow-tab" data-workflow-id="lead-followup">
                        <span class="workflow-tab-name">Lead Follow-up</span>
                        <span class="close-tab">&times;</span>
                    </div>
                    <div class="add-workflow-btn" id="addWorkflowBtn">+</div>
                </div>

                <!-- Storytelling Stage -->
                <div class="storytelling-stage" id="storyStage">
                    <!-- Empty stage message (shown when no agents are added) -->
                    <div class="empty-stage" id="emptyStage">
                        <div class="empty-stage-icon">ðŸŽ­</div>
                        <div class="empty-stage-text">Your storytelling stage is empty. Drag agents from the catalog to create your workflow.</div>
                        <button class="btn btn-primary">Add First Agent</button>
                    </div>

                    <!-- Example of agents on stage with response display -->
                    <div class="stage-agent" id="agent1" style="left: 100px; top: 120px;" data-agent-type="dynamics" data-agent-id="getOpportunities">
                        <div class="agent-header">
                            <div class="agent-color agent-color-dynamics"></div>
                            <div class="agent-title">View My Opportunities</div>
                            <div class="agent-menu">â‹®</div>
                        </div>
                        <div class="agent-content">
                            Retrieve all active sales opportunities assigned to you from Dynamics 365.
                        </div>
                        <div class="agent-actions">
                            <div class="agent-edit">Configure</div>
                            <div class="agent-run">
                                <span class="agent-status agent-status-idle"></span>
                                Run
                            </div>
                        </div>
                        <!-- Agent Response Section -->
                        <div class="agent-response" id="response-agent1">
                            <div class="agent-response-header">
                                <span>Response</span>
                                <div class="agent-response-close">&times;</div>
                            </div>
                            <div class="agent-response-content">
                                <!-- Response content will be populated here -->
                            </div>
                        </div>
                        <!-- Connector points -->
                        <div class="connector-points connector-point-right"></div>
                        <div class="connector-points connector-point-left"></div>
                        <div class="connector-points connector-point-top"></div>
                        <div class="connector-points connector-point-bottom"></div>
                    </div>

                    <div class="stage-agent" id="agent2" style="left: 400px; top: 120px;" data-agent-type="email" data-agent-id="sendOpportunitySummary">
                        <div class="agent-header">
                            <div class="agent-color agent-color-email"></div>
                            <div class="agent-title">Send Opportunity Summary</div>
                            <div class="agent-menu">â‹®</div>
                        </div>
                        <div class="agent-content">
                            Send an email with a summary of your active opportunities to your team.
                        </div>
                        <div class="agent-actions">
                            <div class="agent-edit">Configure</div>
                            <div class="agent-run">
                                <span class="agent-status agent-status-idle"></span>
                                Run
                            </div>
                        </div>
                        <!-- Agent Response Section -->
                        <div class="agent-response" id="response-agent2">
                            <div class="agent-response-header">
                                <span>Response</span>
                                <div class="agent-response-close">&times;</div>
                            </div>
                            <div class="agent-response-content">
                                <!-- Response content will be populated here -->
                            </div>
                        </div>
                        <!-- Connector points -->
                        <div class="connector-points connector-point-right"></div>
                        <div class="connector-points connector-point-left"></div>
                        <div class="connector-points connector-point-top"></div>
                        <div class="connector-points connector-point-bottom"></div>
                    </div>

                    <!-- Example connector line -->
                    <div class="connector-line" style="left: 200px; top: 140px; width: 200px;"></div>

                    <!-- Stage controls (zoom, pan, etc.) -->
                    <div class="stage-controls">
                        <div class="stage-control-btn tooltip" id="zoomInBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11 8V14M8 11H14M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="tooltiptext">Zoom In</span>
                        </div>
                        <div class="stage-control-btn tooltip" id="zoomOutBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 11H14M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="tooltiptext">Zoom Out</span>
                        </div>
                        <div class="stage-control-btn tooltip" id="resetViewBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 15L21 21M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="tooltiptext">Reset View</span>
                        </div>
                    </div>

                    <!-- Stage minimap -->
                    <div class="stage-minimap" id="stageMinimap">
                        <div class="minimap-content">
                            <div class="minimap-viewport"></div>
                            <div class="minimap-agent" style="left: 20%; top: 30%; width: 18%; height: 15%;"></div>
                            <div class="minimap-agent" style="left: 50%; top: 30%; width: 18%; height: 15%;"></div>
                        </div>
                    </div>

                    <!-- Run mode overlay -->
                    <div class="run-mode-overlay" id="runModeOverlay">
                        <div class="run-status">Running Workflow...</div>
                        <div class="run-progress">
                            <div class="run-progress-bar" style="width: 50%;"></div>
                        </div>
                        <button class="run-action-btn" id="stopWorkflowBtn">Stop Workflow</button>
                    </div>
                </div>

                <!-- Agent Configuration Panel -->
                <div class="agent-config-panel" id="agentConfigPanel">
                    <div class="config-panel-header">
                        <div class="config-panel-title">Agent Configuration</div>
                        <div class="close-panel" id="closeConfigPanel">&times;</div>
                    </div>

                    <!-- Agent details form -->
                    <div class="config-section">
                        <div class="config-section-title">Basic Information</div>
                        <div class="form-group">
                            <label class="form-label" for="agentName">Agent Name</label>
                            <input type="text" id="agentName" class="form-input" value="Send Opportunity Summary">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="agentDescription">Description</label>
                            <input type="text" id="agentDescription" class="form-input" value="Send an email with a summary of your active opportunities to your team.">
                        </div>
                    </div>

                    <!-- Agent command editor -->
                    <div class="config-section">
                        <div class="config-section-title">Command</div>
                        <div class="form-group">
                            <label class="form-label" for="agentCommand">Natural Language Command</label>
                            <textarea id="agentCommand" class="form-textarea">Draft an email to my team lead with a summary of my current sales opportunities. Include the total value of all opportunities and highlight the ones with the highest probability of closing. Make it concise but informative.</textarea>
                        </div>
                    </div>

                    <!-- Connection configuration -->
                    <div class="config-section" id="connectionSection">
                        <div class="config-section-title">Connections</div>
                        <div class="connection-form">
                            <div class="connection-info">
                                <p>This agent receives input from <span class="connection-agent">View My Opportunities</span>.</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="connectionPrompt">Connection Prompt</label>
                                <textarea id="connectionPrompt" class="form-textarea">Take the list of opportunities from the previous step and create a well-formatted email summarizing the key opportunities, their values, and status. Send this summary to my team lead with a professional tone.</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="panel-footer">
                        <button class="btn btn-secondary" id="cancelConfigBtn">Cancel</button>
                        <button class="btn btn-primary" id="saveConfigBtn">Save Changes</button>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <div class="loading-text">Processing your request...</div>
                </div>

                <!-- Response section -->
                <div class="response-section">
                    <div class="response-header">
                        <div class="response-title">Global Response</div>
                        <div class="response-actions">
                            <button class="btn btn-secondary" id="clearResponseBtn">Clear</button>
                            <button class="btn btn-primary" id="chatWithResponseBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 4px;">
                                    <path d="M21 12C21 16.9706 16.9706 21 12 21C10.8896 21 9.82175 20.8166 8.82761 20.4773C8.50129 20.3753 8.14522 20.3568 7.86453 20.5144L4.95686 22.2669C4.65689 22.4384 4.29985 22.2306 4.29985 21.8802V18.8488C4.29985 18.5691 4.15132 18.3112 3.91217 18.1572C2.11371 16.9073 1 14.5963 1 12C1 7.02944 5.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Chat with Assistant
                            </button>
                        </div>
                    </div>
                    <div class="response-container">
                        <div class="response-content" id="responseContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="stageContextMenu">
        <div class="context-menu-item" id="addAgentContext">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Add Agent
        </div>
        <div class="context-menu-item" id="pasteAgentContext">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 4H18C18.5304 4 19.0391 4.21071 19.4142 4.58579C19.7893 4.96086 20 5.46957 20 6V18C20 18.5304 19.7893 19.0391 19.4142 19.4142C19.0391 19.7893 18.5304 20 18 20H6C5.46957 20 4.96086 19.7893 4.58579 19.4142C4.21071 19.0391 4 18.5304 4 18V6C4 5.46957 4.21071 4.96086 4.58579 4.58579C4.96086 4.21071 5.46957 4 6 4H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M15 2H9C8.44772 2 8 2.44772 8 3V5C8 5.55228 8.44772 6 9 6H15C15.5523 6 16 5.55228 16 5V3C16 2.44772 15.5523 2 15 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Paste Agent
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="selectAllContext">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 5H11M3 12H16M3 19H11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M17 9L20 12L17 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Select All
        </div>
    </div>

    <div class="context-menu" id="agentContextMenu">
        <div class="context-menu-item" id="editAgentContext">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M18.5 2.5C18.8978 2.10217 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10217 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10218 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Edit
        </div>
        <div class="context-menu-item" id="copyAgentContext">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 9H11C9.89543 9 9 9.89543 9 11V20C9 21.1046 9.89543 22 11 22H20C21.1046 22 22 21.1046 22 20V11C22 9.89543 21.1046 9 20 9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 15H4C3.46957 15 2.96086 14.7893 2.58579 14.4142C2.21071 14.0391 2 13.5304 2 13V4C2 3.46957 2.21071 2.96086 2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H13C13.5304 2 14.0391 2.21071 14.4142 2.58579C14.7893 2.96086 15 3.46957 15 4V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Duplicate
        </div>
        <div class="context-menu-item" id="deleteAgentContext">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Delete
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="runAgentContext">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5 3L19 12L5 21V3Z" fill="currentColor"/>
            </svg>
            Run this Agent
        </div>
    </div>

    <!-- Create Workflow Modal -->
    <div class="modal" id="createWorkflowModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Workflow</div>
                <button class="modal-close" id="closeCreateWorkflowModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="newWorkflowName">Workflow Name</label>
                    <input type="text" id="newWorkflowName" class="workflow-name-input" placeholder="Enter workflow name...">
                </div>
                <div class="form-group">
                    <label class="form-label" for="newWorkflowDescription">Description (optional)</label>
                    <textarea id="newWorkflowDescription" class="form-textarea" placeholder="Describe what this workflow will do..." style="min-height: 100px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreateWorkflowBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmCreateWorkflowBtn">Create</button>
            </div>
        </div>
    </div>

    <!-- Edit Workflow Modal -->
    <div class="modal" id="editWorkflowModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Workflow Details</div>
                <button class="modal-close" id="closeEditWorkflowModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="editWorkflowName">Workflow Name</label>
                    <input type="text" id="editWorkflowName" class="workflow-name-input" value="Opportunity Summary Email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="editWorkflowDescription">Description</label>
                    <textarea id="editWorkflowDescription" class="form-textarea" style="min-height: 100px;">This workflow retrieves your active sales opportunities from Dynamics 365 and sends a summary email to your team lead.</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditWorkflowBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmEditWorkflowBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div class="modal" id="jsonModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="jsonModalTitle">Export Workflows</div>
                <button class="modal-close" id="closeJsonModal">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="jsonContent" style="width: 100%; height: 300px; font-family: monospace;" placeholder="Paste JSON here or view exported JSON"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelJsonBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmJsonBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">
                    <div class="chat-title-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 12H16M12 8V16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span>Chat with Microsoft Copilot</span>
                </div>
                <div class="chat-close" id="closeChatModal">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here dynamically -->
            </div>
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea id="chatInput" class="chat-input" placeholder="Type your message here..." rows="1"></textarea>
                    <button id="chatSendBtn" class="chat-send-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const userGuid = "7b8e8f63-4d1b-42f0-95c2-d24b12345678";
        const apiUrl = "http://localhost:7071/api/businessinsightbot_function";
        
        // Store all workflows
        const workflows = {
            "opportunity-email": {
                id: "opportunity-email",
                name: "Opportunity Summary Email",
                description: "This workflow retrieves your active sales opportunities from Dynamics 365 and sends a summary email to your team lead.",
                created: "2025-03-15T10:30:00",
                lastRun: "2025-03-17T14:45:00",
                agents: [
                    {
                        id: "agent1",
                        type: "dynamics",
                        agentId: "getOpportunities",
                        name: "View My Opportunities",
                        description: "Retrieve all active sales opportunities assigned to you from Dynamics 365.",
                        position: { x: 100, y: 120 },
                        command: "Show me all my active sales opportunities in Dynamics 365. I want to see the name, estimated value, and probability for each one. Also calculate the total potential value of all opportunities."
                    },
                    {
                        id: "agent2",
                        type: "email",
                        agentId: "sendOpportunitySummary",
                        name: "Send Opportunity Summary",
                        description: "Send an email with a summary of your active opportunities to your team.",
                        position: { x: 400, y: 120 },
                        command: "Draft an email to my team lead with a summary of my current sales opportunities. Include the total value of all opportunities and highlight the ones with the highest probability of closing. Make it concise but informative."
                    }
                ],
                connections: [
                    {
                        fromId: "agent1",
                        toId: "agent2",
                        connectionPrompt: "Take the list of opportunities from the previous step and create a well-formatted email summarizing the key opportunities, their values, and status. Send this summary to my team lead with a professional tone."
                    }
                ]
            },
            "lead-followup": {
                id: "lead-followup",
                name: "Lead Follow-up",
                description: "Create a lead in Dynamics 365 and schedule a follow-up meeting.",
                created: "2025-03-16T15:20:00",
                lastRun: "2025-03-16T16:30:00",
                agents: [],
                connections: []
            }
        };
        
        // Current workflow ID
        let currentWorkflowId = "opportunity-email";
        
        // Store agent command templates
        const agentCommands = {
            // Email actions
            sendStatusEmail: `Send a weekly status update email to my team lead with details on what I accomplished this week, current project progress metrics, and any blockers or risks I'm facing.`,
            
            scheduleClientMeeting: `Send a professional email to schedule a meeting with a potential client. Include proposed times, a clear agenda, and a brief summary of what we want to discuss. Make it personalized and friendly but professional.`,
            
            sendOpportunitySummary: `Draft an email to my team lead with a summary of my current sales opportunities. Include the total value of all opportunities and highlight the ones with the highest probability of closing. Make it concise but informative.`,
            
            // Dynamics 365 actions
            getOpportunities: `Show me all my active sales opportunities in Dynamics 365. I want to see the name, estimated value, and probability for each one. Also calculate the total potential value of all opportunities.`,
            
            createLead: `Create a new lead in Dynamics 365 for [CONTACT_NAME], who is the [JOB_TITLE] at [COMPANY_NAME]. I met them at the Tech Conference and they're interested in our cloud solutions package. Their contact is [EMAIL_ADDRESS] and [PHONE_NUMBER].`,
            
            // Memory actions
            saveDailySummary: `Save a summary of today's activities to my personal memory. Today I completed the product demo for Client ABC, prepared the quarterly report for the executive team, and resolved the integration issue with the payment gateway.`,
            
            recallContext: `Retrieve and summarize my previous interactions with clients and projects from my conversation history. Focus on recent client meetings and any important action items.`,
            
            // Custom actions
            processDocuments: `Process document files for analysis.`,
            
            autoAnswerQuestions: `Automatically answer questions from processed documents.`
        };
        
        // Chat related variables
        let chatHistory = [];
        let lastResponseContent = '';
        
        // DOM elements
        const storyStage = document.getElementById('storyStage');
        const emptyStage = document.getElementById('emptyStage');
        const agentConfigPanel = document.getElementById('agentConfigPanel');
        const closeConfigPanel = document.getElementById('closeConfigPanel');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const responseContent = document.getElementById('responseContent');
        const clearResponseBtn = document.getElementById('clearResponseBtn');
        const agentCatalogItems = document.querySelectorAll('.agent-item');
        const statusMessage = document.getElementById('statusMessage');
        const runWorkflowBtn = document.getElementById('runWorkflowBtn');
        const saveWorkflowBtn = document.getElementById('saveWorkflowBtn');
        const runModeOverlay = document.getElementById('runModeOverlay');
        const stopWorkflowBtn = document.getElementById('stopWorkflowBtn');
        const stageContextMenu = document.getElementById('stageContextMenu');
        const agentContextMenu = document.getElementById('agentContextMenu');
        const editWorkflowDetailsBtn = document.getElementById('editWorkflowDetailsBtn');
        const chatWithResponseBtn = document.getElementById('chatWithResponseBtn');
        
        // Modal elements
        const createWorkflowModal = document.getElementById('createWorkflowModal');
        const closeCreateWorkflowModal = document.getElementById('closeCreateWorkflowModal');
        const newWorkflowName = document.getElementById('newWorkflowName');
        const newWorkflowDescription = document.getElementById('newWorkflowDescription');
        const confirmCreateWorkflowBtn = document.getElementById('confirmCreateWorkflowBtn');
        const cancelCreateWorkflowBtn = document.getElementById('cancelCreateWorkflowBtn');
        const addWorkflowBtn = document.getElementById('addWorkflowBtn');
        
        const editWorkflowModal = document.getElementById('editWorkflowModal');
        const closeEditWorkflowModal = document.getElementById('closeEditWorkflowModal');
        const editWorkflowName = document.getElementById('editWorkflowName');
        const editWorkflowDescription = document.getElementById('editWorkflowDescription');
        const confirmEditWorkflowBtn = document.getElementById('confirmEditWorkflowBtn');
        const cancelEditWorkflowBtn = document.getElementById('cancelEditWorkflowBtn');

        const jsonModal = document.getElementById('jsonModal');
        const jsonModalTitle = document.getElementById('jsonModalTitle');
        const jsonContent = document.getElementById('jsonContent');
        const closeJsonModal = document.getElementById('closeJsonModal');
        const confirmJsonBtn = document.getElementById('confirmJsonBtn');
        const cancelJsonBtn = document.getElementById('cancelJsonBtn');
        const exportBtn = document.getElementById('exportBtn');
        
        // Chat modal elements
        const chatModal = document.getElementById('chatModal');
        const closeChatModal = document.getElementById('closeChatModal');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        
        let selectedAgentId = null;
        let draggedAgent = null;
        let isDragging = false;
        let isConnecting = false;
        let connectingFromAgent = null;
        let connectingFromPoint = null;
        let stage = {
            scale: 1,
            offsetX: 0,
            offsetY: 0,
            isDragging: false,
            lastX: 0,
            lastY: 0
        };
        
        // Initialize drag-and-drop functionality
        function initDragAndDrop() {
            // Make catalog items draggable
            agentCatalogItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    const agentType = item.getAttribute('data-agent-type');
                    const agentId = item.getAttribute('data-agent-id');
                    const data = JSON.stringify({ 
                        fromCatalog: true, 
                        agentType, 
                        agentId
                    });
                    e.dataTransfer.setData('text/plain', data);
                    e.dataTransfer.effectAllowed = 'copy';
                });
            });
            
            // Make stage a drop target
            storyStage.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });
            
            storyStage.addEventListener('drop', (e) => {
                e.preventDefault();
                const data = e.dataTransfer.getData('text/plain');
                
                try {
                    const agentData = JSON.parse(data);
                    
                    if (agentData.fromCatalog) {
                        // Create new agent on stage
                        const rect = storyStage.getBoundingClientRect();
                        const x = (e.clientX - rect.left - 100) / stage.scale;
                        const y = (e.clientY - rect.top - 50) / stage.scale;
                        
                        createAgentOnStage(agentData.agentType, agentData.agentId, x, y);
                    }
                } catch (error) {
                    console.error('Invalid drop data:', error);
                }
            });
        }
        
        // Show/hide empty stage message
        function toggleEmptyStage() {
            const agents = document.querySelectorAll('.stage-agent');
            emptyStage.style.display = agents.length > 0 ? 'none' : 'flex';
        }
        
        // Create new agent on stage
        function createAgentOnStage(agentType, agentId, x, y) {
            const agentCount = document.querySelectorAll('.stage-agent').length + 1;
            const newAgentId = `agent${agentCount}`;
            
            // Get agent name and description based on type and id
            let agentName = agentId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            let agentDescription = '';
            
            // Find the catalog item to get its description
            const catalogItem = document.querySelector(`.agent-item[data-agent-type="${agentType}"][data-agent-id="${agentId}"]`);
            if (catalogItem) {
                const descElem = catalogItem.querySelector('.agent-description');
                agentDescription = descElem ? descElem.textContent : '';
            }
            
            // Create agent element
            const agentElem = document.createElement('div');
            agentElem.className = 'stage-agent';
            agentElem.id = newAgentId;
            agentElem.setAttribute('data-agent-type', agentType);
            agentElem.setAttribute('data-agent-id', agentId);
            agentElem.style.left = `${x}px`;
            agentElem.style.top = `${y}px`;
            
            agentElem.innerHTML = `
                <div class="agent-header">
                    <div class="agent-color agent-color-${agentType}"></div>
                    <div class="agent-title">${agentName}</div>
                    <div class="agent-menu">â‹®</div>
                </div>
                <div class="agent-content">
                    ${agentDescription}
                </div>
                <div class="agent-actions">
                    <div class="agent-edit">Configure</div>
                    <div class="agent-run">
                        <span class="agent-status agent-status-idle"></span>
                        Run
                    </div>
                </div>
                <!-- Agent Response Section -->
                <div class="agent-response" id="response-${newAgentId}">
                    <div class="agent-response-header">
                        <span>Response</span>
                        <div class="agent-response-close">&times;</div>
                    </div>
                    <div class="agent-response-content">
                        <!-- Response content will be populated here -->
                    </div>
                </div>
                <!-- Connector points -->
                <div class="connector-points connector-point-right"></div>
                <div class="connector-points connector-point-left"></div>
                <div class="connector-points connector-point-top"></div>
                <div class="connector-points connector-point-bottom"></div>
            `;
            
            storyStage.appendChild(agentElem);
            
            // Update workflow data structure
            const currentWorkflow = workflows[currentWorkflowId];
            currentWorkflow.agents.push({
                id: newAgentId,
                type: agentType,
                agentId: agentId,
                name: agentName,
                description: agentDescription,
                position: { x, y },
                command: agentCommands[agentId] || `Default command for ${agentName}`
            });
            
            // Make agent draggable
            makeAgentDraggable(agentElem);
            
            // Add event listeners
            addAgentEventListeners(agentElem);
            
            // Hide empty stage message
            toggleEmptyStage();
            
            // Show success message
            showStatus(`${agentName} added to workflow`);
        }
        
        // Make an agent element draggable
        function makeAgentDraggable(agentElem) {
            let offsetX, offsetY;
            
            agentElem.addEventListener('mousedown', (e) => {
                // Only process if not clicking on a connector point
                if (!e.target.classList.contains('connector-points')) {
                    // Select this agent
                    selectAgent(agentElem.id);
                    
                    // Start dragging
                    isDragging = true;
                    draggedAgent = agentElem;
                    
                    const rect = agentElem.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;
                    
                    // Bring agent to front
                    agentElem.style.zIndex = '10';
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging && draggedAgent === agentElem) {
                    const stageRect = storyStage.getBoundingClientRect();
                    let newX = (e.clientX - stageRect.left - offsetX) / stage.scale;
                    let newY = (e.clientY - stageRect.top - offsetY) / stage.scale;
                    
                    // Keep agent within bounds
                    newX = Math.max(0, Math.min(newX, stageRect.width - 200));
                    newY = Math.max(0, Math.min(newY, stageRect.height - 100));
                    
                    agentElem.style.left = `${newX}px`;
                    agentElem.style.top = `${newY}px`;
                    
                    // Update connections
                    updateConnections();
                    
                    // Update workflow data
                    const agentId = agentElem.id;
                    const currentWorkflow = workflows[currentWorkflowId];
                    const agent = currentWorkflow.agents.find(a => a.id === agentId);
                    if (agent) {
                        agent.position = { x: newX, y: newY };
                    }
                }
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging && draggedAgent === agentElem) {
                    isDragging = false;
                    draggedAgent.style.zIndex = '5';
                    draggedAgent = null;
                }
            });
        }
        
        // Handle connector points
        function handleConnectors() {
            const connectorPoints = document.querySelectorAll('.connector-points');
            
            connectorPoints.forEach(point => {
                point.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    
                    // Start connecting
                    isConnecting = true;
                    const agentElem = point.closest('.stage-agent');
                    connectingFromAgent = agentElem.id;
                    connectingFromPoint = point.classList[1].replace('connector-point-', '');
                    
                    // Create temporary connection line
                    const tempLine = document.createElement('div');
                    tempLine.id = 'temp-connector';
                    tempLine.className = 'connector-line';
                    
                    // Position it at the start point
                    const rect = point.getBoundingClientRect();
                    const stageRect = storyStage.getBoundingClientRect();
                    const startX = (rect.left + rect.width/2 - stageRect.left) / stage.scale;
                    const startY = (rect.top + rect.height/2 - stageRect.top) / stage.scale;
                    
                    tempLine.style.left = `${startX}px`;
                    tempLine.style.top = `${startY}px`;
                    tempLine.style.width = '0';
                    tempLine.style.transform = 'rotate(0deg)';
                    
                    storyStage.appendChild(tempLine);
                });
            });
            
            storyStage.addEventListener('mousemove', (e) => {
                if (isConnecting) {
                    const tempLine = document.getElementById('temp-connector');
                    if (!tempLine) return;
                    
                    // Get starting point coordinates
                    const fromAgent = document.getElementById(connectingFromAgent);
                    const fromPoint = fromAgent.querySelector(`.connector-point-${connectingFromPoint}`);
                    const fromRect = fromPoint.getBoundingClientRect();
                    const stageRect = storyStage.getBoundingClientRect();
                    
                    const fromX = (fromRect.left + fromRect.width/2 - stageRect.left) / stage.scale;
                    const fromY = (fromRect.top + fromRect.height/2 - stageRect.top) / stage.scale;
                    
                    // Get current mouse position
                    const toX = (e.clientX - stageRect.left) / stage.scale;
                    const toY = (e.clientY - stageRect.top) / stage.scale;
                    
                    // Calculate line length and angle
                    const dx = toX - fromX;
                    const dy = toY - fromY;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    
                    // Update line
                    tempLine.style.width = `${length}px`;
                    tempLine.style.transform = `rotate(${angle}deg)`;
                }
            });
            
            document.addEventListener('mouseup', (e) => {
                if (isConnecting) {
                    // Check if we're over another agent
                    const tempLine = document.getElementById('temp-connector');
                    if (tempLine) {
                        const target = e.target.closest('.stage-agent');
                        
                        if (target && target.id !== connectingFromAgent) {
                            // Create permanent connection
                            createConnection(connectingFromAgent, target.id);
                        }
                        
                        // Remove temp line
                        tempLine.remove();
                    }
                    
                    // Reset connection state
                    isConnecting = false;
                    connectingFromAgent = null;
                    connectingFromPoint = null;
                }
            });
        }
        
        // Create a permanent connection between two agents
        function createConnection(fromAgentId, toAgentId) {
            // Update data model
            const currentWorkflow = workflows[currentWorkflowId];
            
            // Check if connection already exists
            const existingConnection = currentWorkflow.connections.find(
                c => c.fromId === fromAgentId && c.toId === toAgentId
            );
            
            if (existingConnection) {
                showStatus('Connection already exists', true);
                return;
            }
            
            // Get agent info for connection prompt
            const fromAgent = currentWorkflow.agents.find(a => a.id === fromAgentId);
            const toAgent = currentWorkflow.agents.find(a => a.id === toAgentId);
            
            if (!fromAgent || !toAgent) {
                showStatus('Error creating connection: Agent not found', true);
                return;
            }
            
            // Create default connection prompt
            const connectionPrompt = `Take the results from ${fromAgent.name} as input for ${toAgent.name}.`;
            
            // Add to connections array
            currentWorkflow.connections.push({
                fromId: fromAgentId,
                toId: toAgentId,
                connectionPrompt
            });
            
            // Update visual connections
            updateConnections();
            
            // Show success message
            showStatus(`Connected ${fromAgent.name} to ${toAgent.name}`);
            
            // Show configuration panel to edit connection
            openConnectionConfig(fromAgentId, toAgentId);
        }
        
        // Update all visual connections based on agent positions
        function updateConnections() {
            // Remove all existing connection lines
            document.querySelectorAll('.connector-line:not(#temp-connector)').forEach(line => {
                line.remove();
            });
            
            // Get current workflow
            const currentWorkflow = workflows[currentWorkflowId];
            
            // Recreate all connections
            currentWorkflow.connections.forEach(connection => {
                const fromAgent = document.getElementById(connection.fromId);
                const toAgent = document.getElementById(connection.toId);
                
                if (fromAgent && toAgent) {
                    // Get positions
                    const fromRect = fromAgent.getBoundingClientRect();
                    const toRect = toAgent.getBoundingClientRect();
                    const stageRect = storyStage.getBoundingClientRect();
                    
                    // Calculate center points
                    const fromX = (fromRect.left + fromRect.width - stageRect.left) / stage.scale;
                    const fromY = (fromRect.top + fromRect.height/2 - stageRect.top) / stage.scale;
                    const toX = (toRect.left - stageRect.left) / stage.scale;
                    const toY = (toRect.top + toRect.height/2 - stageRect.top) / stage.scale;
                    
                    // Calculate line length and angle
                    const dx = toX - fromX;
                    const dy = toY - fromY;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    
                    // Create line
                    const line = document.createElement('div');
                    line.className = 'connector-line';
                    line.setAttribute('data-from', connection.fromId);
                    line.setAttribute('data-to', connection.toId);
                    
                    line.style.left = `${fromX}px`;
                    line.style.top = `${fromY}px`;
                    line.style.width = `${length}px`;
                    line.style.transform = `rotate(${angle}deg)`;
                    
                    storyStage.appendChild(line);
                }
            });
        }
        
        // Select an agent
        function selectAgent(agentId) {
            // Clear previous selection
            document.querySelectorAll('.stage-agent').forEach(agent => {
                agent.classList.remove('selected');
            });
            
            // Select new agent
            const agentElem = document.getElementById(agentId);
            if (agentElem) {
                agentElem.classList.add('selected');
                selectedAgentId = agentId;
            }
        }
        
        // Show/hide the agent configuration panel
        function toggleConfigPanel(show) {
            agentConfigPanel.classList.toggle('open', show);
        }
        
        // Open configuration panel for an agent
        function openAgentConfig(agentId) {
            const currentWorkflow = workflows[currentWorkflowId];
            const agent = currentWorkflow.agents.find(a => a.id === agentId);
            
            if (!agent) {
                showStatus('Agent not found', true);
                return;
            }
            
            // Fill in form fields
            document.getElementById('agentName').value = agent.name;
            document.getElementById('agentDescription').value = agent.description;
            document.getElementById('agentCommand').value = agent.command;
            
            // Show/hide connection section
            const connectionSection = document.getElementById('connectionSection');
            
            // Check if this agent has incoming connections
            const incomingConnections = currentWorkflow.connections.filter(c => c.toId === agentId);
            
            if (incomingConnections.length > 0) {
                // This agent receives input from another agent
                const fromAgentId = incomingConnections[0].fromId;
                const fromAgent = currentWorkflow.agents.find(a => a.id === fromAgentId);
                
                if (fromAgent) {
                    connectionSection.style.display = 'block';
                    document.querySelector('.connection-agent').textContent = fromAgent.name;
                    document.getElementById('connectionPrompt').value = incomingConnections[0].connectionPrompt;
                }
            } else {
                connectionSection.style.display = 'none';
            }
            
            // Set the current agent being edited
            agentConfigPanel.setAttribute('data-editing-agent', agentId);
            
            // Show panel
            toggleConfigPanel(true);
        }
        
        // Open configuration panel for a connection
        function openConnectionConfig(fromAgentId, toAgentId) {
            const currentWorkflow = workflows[currentWorkflowId];
            const connection = currentWorkflow.connections.find(
                c => c.fromId === fromAgentId && c.toId === toAgentId
            );
            
            if (!connection) {
                showStatus('Connection not found', true);
                return;
            }
            
            const toAgent = currentWorkflow.agents.find(a => a.id === toAgentId);
            const fromAgent = currentWorkflow.agents.find(a => a.id === fromAgentId);
            
            if (!toAgent || !fromAgent) {
                showStatus('Agent not found', true);
                return;
            }
            
            // Set agent being edited to the target agent
            document.getElementById('agentName').value = toAgent.name;
            document.getElementById('agentDescription').value = toAgent.description;
            document.getElementById('agentCommand').value = toAgent.command;
            
            // Show connection section
            const connectionSection = document.getElementById('connectionSection');
            connectionSection.style.display = 'block';
            document.querySelector('.connection-agent').textContent = fromAgent.name;
            document.getElementById('connectionPrompt').value = connection.connectionPrompt;
            
            // Set the current agent being edited
            agentConfigPanel.setAttribute('data-editing-agent', toAgentId);
            
            // Show panel
            toggleConfigPanel(true);
        }
        
        // Save agent configuration changes
        function saveAgentConfig() {
            const agentId = agentConfigPanel.getAttribute('data-editing-agent');
            if (!agentId) return;
            
            const currentWorkflow = workflows[currentWorkflowId];
            const agent = currentWorkflow.agents.find(a => a.id === agentId);
            
            if (!agent) {
                showStatus('Agent not found', true);
                return;
            }
            
            // Update agent data
            agent.name = document.getElementById('agentName').value;
            agent.description = document.getElementById('agentDescription').value;
            agent.command = document.getElementById('agentCommand').value;
            
            // Update connection data if applicable
            const connectionSection = document.getElementById('connectionSection');
            if (connectionSection.style.display !== 'none') {
                const connectionPrompt = document.getElementById('connectionPrompt').value;
                
                // Find incoming connection
                const incomingConnection = currentWorkflow.connections.find(c => c.toId === agentId);
                if (incomingConnection) {
                    incomingConnection.connectionPrompt = connectionPrompt;
                }
            }
            
            // Update UI
            const agentElem = document.getElementById(agentId);
            if (agentElem) {
                agentElem.querySelector('.agent-title').textContent = agent.name;
                agentElem.querySelector('.agent-content').textContent = agent.description;
            }
            
            // Close panel
            toggleConfigPanel(false);
            
            // Show success message
            showStatus('Agent configuration saved');
        }
        
        // Add event listeners to agent elements
        function addAgentEventListeners(agentElem) {
            // Configure button
            const configBtn = agentElem.querySelector('.agent-edit');
            configBtn.addEventListener('click', () => {
                openAgentConfig(agentElem.id);
            });
            
            // Agent menu button
            const menuBtn = agentElem.querySelector('.agent-menu');
            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showAgentContextMenu(e, agentElem.id);
            });
            
            // Double-click to edit
            agentElem.addEventListener('dblclick', () => {
                openAgentConfig(agentElem.id);
            });
            
            // Run agent button
            const runBtn = agentElem.querySelector('.agent-run');
            runBtn.addEventListener('click', () => {
                runSingleAgent(agentElem.id);
            });
            
            // Response close button
            const responseCloseBtn = agentElem.querySelector('.agent-response-close');
            if (responseCloseBtn) {
                responseCloseBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const responseSection = agentElem.querySelector('.agent-response');
                    if (responseSection) {
                        responseSection.style.display = 'none';
                    }
                });
            }
        }
        
        // Show status message
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError 
                ? 'status-message status-error' 
                : 'status-message status-success';
            statusMessage.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // Format response
        function formatResponse(text) {
            if (!text) return '';
            
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }
        
        // Send request to API
        async function sendApiRequest(action, params) {
            let agentId = null;
            if (action === 'agent' && params && params.agentId) {
                agentId = params.agentId;
                // Update agent status to running
                updateAgentStatus(agentId, 'running');
            }
            
            showStatus(`Sending request to ${action === 'workflow' ? 'workflow' : 'agent'}`);
            loadingIndicator.style.display = 'flex';
            
            if (!agentId) {
                // Clear global response area only if not running a specific agent
                responseContent.innerHTML = '';
            }
            
            try {
                // Construct API request
                let userInput;
                
                if (action === 'workflow') {
                    // For workflows, we need to compose a request that chains the commands
                    const workflow = workflows[currentWorkflowId];
                    const steps = workflow.connections.map(conn => {
                        const fromAgent = workflow.agents.find(a => a.id === conn.fromId);
                        const toAgent = workflow.agents.find(a => a.id === conn.toId);
                        return `Step 1: ${fromAgent.command}\nStep 2: ${toAgent.command}\n\nConnection: ${conn.connectionPrompt}`;
                    });
                    
                    userInput = `Execute workflow "${workflow.name}":\n\n${steps.join('\n\n')}`;
                } else if (params && params.command) {
                    // Single agent with a specific command
                    userInput = params.command;
                } else {
                    throw new Error('Invalid action or missing parameters');
                }
                
                // Make the actual API call
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_input: userInput,
                        conversation_history: [],
                        user_guid: userGuid
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                const formattedResponse = formatResponse(data.assistant_response);
                
                // Store the raw response for chat
                lastResponseContent = data.assistant_response;
                
                if (agentId) {
                    // Display response in agent card
                    displayAgentResponse(agentId, formattedResponse);
                    // Update agent status to success
                    updateAgentStatus(agentId, 'success');
                } else {
                    // Display in global response area
                    responseContent.innerHTML = formattedResponse;
                }
                
                // Update last run time for workflows
                if (action === 'workflow') {
                    const workflow = workflows[currentWorkflowId];
                    workflow.lastRun = new Date().toISOString();
                    document.querySelector('.workflow-meta').textContent = 
                        `Created: ${new Date(workflow.created).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} â€¢ Last run: ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
                }
                
                showStatus(`${action === 'workflow' ? 'Workflow' : 'Agent'} executed successfully`);
            } catch (error) {
                console.error('API Error:', error);
                const errorMessage = `<div style="color: var(--copilot-error);">Error: ${error.message}</div>`;
                
                if (agentId) {
                    // Display error in agent card
                    displayAgentResponse(agentId, errorMessage);
                    // Update agent status to error
                    updateAgentStatus(agentId, 'error');
                } else {
                    // Display in global response area
                    responseContent.innerHTML = errorMessage;
                }
                
                showStatus(`Failed to execute: ${error.message}`, true);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // Display response in agent card
        function displayAgentResponse(agentId, responseHtml) {
            const agentElem = document.getElementById(agentId);
            if (!agentElem) return;
            
            const responseSection = agentElem.querySelector('.agent-response');
            const responseContent = agentElem.querySelector('.agent-response-content');
            
            if (responseSection && responseContent) {
                responseContent.innerHTML = responseHtml;
                responseSection.style.display = 'block';
            }
        }
        
        // Update agent status indicator
        function updateAgentStatus(agentId, status) {
            const agentElem = document.getElementById(agentId);
            if (!agentElem) return;
            
            const statusIndicator = agentElem.querySelector('.agent-status');
            if (statusIndicator) {
                // Remove all status classes
                statusIndicator.classList.remove('agent-status-idle', 'agent-status-running', 'agent-status-success', 'agent-status-error');
                // Add appropriate class
                statusIndicator.classList.add(`agent-status-${status}`);
            }
        }

        // Run the current workflow
        function runWorkflow() {
            const currentWorkflow = workflows[currentWorkflowId];
            
            // Check if workflow has agents
            if (!currentWorkflow.agents || currentWorkflow.agents.length === 0) {
                showStatus('Workflow has no agents to run', true);
                return;
            }
            
            // Check if workflow has connections
            if (!currentWorkflow.connections || currentWorkflow.connections.length === 0) {
                showStatus('Workflow has no connections between agents', true);
                return;
            }
            
            // Reset all agent statuses to idle
            currentWorkflow.agents.forEach(agent => {
                updateAgentStatus(agent.id, 'idle');
            });
            
            // Hide all agent responses
            document.querySelectorAll('.agent-response').forEach(response => {
                response.style.display = 'none';
            });
            
            // Show running overlay
            runModeOverlay.style.display = 'flex';
            
            // Reset progress bar
            const progressBar = document.querySelector('.run-progress-bar');
            progressBar.style.width = '0%';
            
            // Animate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                progressBar.style.width = `${progress}%`;
                
                // Update agent status progressively
                if (progress === 30) {
                    // Set first agent status to running
                    const firstAgentId = currentWorkflow.connections[0].fromId;
                    updateAgentStatus(firstAgentId, 'running');
                } else if (progress === 60) {
                    // Set first agent status to success and second to running
                    const firstAgentId = currentWorkflow.connections[0].fromId;
                    const secondAgentId = currentWorkflow.connections[0].toId;
                    updateAgentStatus(firstAgentId, 'success');
                    updateAgentStatus(secondAgentId, 'running');
                }
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    
                    // Wait a bit before showing results
                    setTimeout(() => {
                        // Set all agents to success
                        currentWorkflow.agents.forEach(agent => {
                            updateAgentStatus(agent.id, 'success');
                        });
                        
                        // Hide overlay
                        runModeOverlay.style.display = 'none';
                        
                        // Call the API
                        sendApiRequest('workflow');
                    }, 500);
                }
            }, 100);
        }
        
        // Run a single agent
        function runSingleAgent(agentId) {
            const currentWorkflow = workflows[currentWorkflowId];
            const agent = currentWorkflow.agents.find(a => a.id === agentId);
            
            if (!agent) {
                showStatus('Agent not found', true);
                return;
            }
            
            // Send API request with agent command
            sendApiRequest('agent', { 
                command: agent.command,
                agentId: agentId
            });
        }
        
        // Show stage context menu
        function showStageContextMenu(e) {
            e.preventDefault();
            
            // Position menu at cursor
            stageContextMenu.style.left = `${e.pageX}px`;
            stageContextMenu.style.top = `${e.pageY}px`;
            
            // Show menu
            stageContextMenu.style.display = 'block';
        }
        
        // Show agent context menu
        function showAgentContextMenu(e, agentId) {
            e.preventDefault();
            
            // Set current agent
            agentContextMenu.setAttribute('data-agent-id', agentId);
            
            // Position menu at cursor
            agentContextMenu.style.left = `${e.pageX}px`;
            agentContextMenu.style.top = `${e.pageY}px`;
            
            // Show menu
            agentContextMenu.style.display = 'block';
        }
        
        // Handle context menu item clicks
        function handleContextMenuAction(menuItem, contextMenu) {
            if (contextMenu === stageContextMenu) {
                // Stage context menu actions
                switch (menuItem) {
                    case 'addAgentContext':
                        // Show "Add Agent" dialog
                        break;
                    case 'pasteAgentContext':
                        // Paste copied agent
                        break;
                    case 'selectAllContext':
                        // Select all agents
                        break;
                }
            } else if (contextMenu === agentContextMenu) {
                // Agent context menu actions
                const agentId = agentContextMenu.getAttribute('data-agent-id');
                
                switch (menuItem) {
                    case 'editAgentContext':
                        openAgentConfig(agentId);
                        break;
                    case 'copyAgentContext':
                        duplicateAgent(agentId);
                        break;
                    case 'deleteAgentContext':
                        deleteAgent(agentId);
                        break;
                    case 'runAgentContext':
                        runSingleAgent(agentId);
                        break;
                }
            }
            
            // Hide menu
            contextMenu.style.display = 'none';
        }
        
        // Duplicate an agent
        function duplicateAgent(agentId) {
            const currentWorkflow = workflows[currentWorkflowId];
            const agent = currentWorkflow.agents.find(a => a.id === agentId);
            
            if (!agent) {
                showStatus('Agent not found', true);
                return;
            }
            
            // Create new agent with same properties but offset position
            const newAgentCount = document.querySelectorAll('.stage-agent').length + 1;
            const newAgentId = `agent${newAgentCount}`;
            
            const newAgent = {
                id: newAgentId,
                type: agent.type,
                agentId: agent.agentId,
                name: agent.name,
                description: agent.description,
                position: { 
                    x: agent.position.x + 50, 
                    y: agent.position.y + 50 
                },
                command: agent.command
            };
            
            // Add to workflow
            currentWorkflow.agents.push(newAgent);
            
            // Create element
            const agentElem = document.createElement('div');
            agentElem.className = 'stage-agent';
            agentElem.id = newAgentId;
            agentElem.setAttribute('data-agent-type', agent.type);
            agentElem.setAttribute('data-agent-id', agent.agentId);
            agentElem.style.left = `${newAgent.position.x}px`;
            agentElem.style.top = `${newAgent.position.y}px`;
            
            agentElem.innerHTML = `
                <div class="agent-header">
                    <div class="agent-color agent-color-${agent.type}"></div>
                    <div class="agent-title">${agent.name}</div>
                    <div class="agent-menu">â‹®</div>
                </div>
                <div class="agent-content">
                    ${agent.description}
                </div>
                <div class="agent-actions">
                    <div class="agent-edit">Configure</div>
                    <div class="agent-run">
                        <span class="agent-status agent-status-idle"></span>
                        Run
                    </div>
                </div>
                <!-- Agent Response Section -->
                <div class="agent-response" id="response-${newAgentId}">
                    <div class="agent-response-header">
                        <span>Response</span>
                        <div class="agent-response-close">&times;</div>
                    </div>
                    <div class="agent-response-content">
                        <!-- Response content will be populated here -->
                    </div>
                </div>
                <!-- Connector points -->
                <div class="connector-points connector-point-right"></div>
                <div class="connector-points connector-point-left"></div>
                <div class="connector-points connector-point-top"></div>
                <div class="connector-points connector-point-bottom"></div>
            `;
            
            storyStage.appendChild(agentElem);
            
            // Make agent draggable
            makeAgentDraggable(agentElem);
            
            // Add event listeners
            addAgentEventListeners(agentElem);
            
            // Show success message
            showStatus(`Duplicated agent "${agent.name}"`);
        }
        
        // Delete an agent
        function deleteAgent(agentId) {
            const currentWorkflow = workflows[currentWorkflowId];
            const agentIndex = currentWorkflow.agents.findIndex(a => a.id === agentId);
            
            if (agentIndex === -1) {
                showStatus('Agent not found', true);
                return;
            }
            
            // Get agent name for message
            const agentName = currentWorkflow.agents[agentIndex].name;
            
            // Remove agent from data
            currentWorkflow.agents.splice(agentIndex, 1);
            
            // Remove connections involving this agent
            currentWorkflow.connections = currentWorkflow.connections.filter(
                c => c.fromId !== agentId && c.toId !== agentId
            );
            
            // Remove from DOM
            const agentElem = document.getElementById(agentId);
            if (agentElem) {
                agentElem.remove();
            }
            
            // Update connections
            updateConnections();
            
            // Show empty stage if needed
            toggleEmptyStage();
            
            // Show success message
            showStatus(`Deleted agent "${agentName}"`);
        }
        
        // Create a new workflow
        function createNewWorkflow() {
            const name = newWorkflowName.value.trim();
            const description = newWorkflowDescription.value.trim();
            
            if (!name) {
                showStatus('Please enter a workflow name', true);
                return;
            }
            
            // Generate ID
            const id = `workflow-${Date.now()}`;
            
            // Create workflow
            workflows[id] = {
                id,
                name,
                description,
                created: new Date().toISOString(),
                lastRun: null,
                agents: [],
                connections: []
            };
            
            // Add new tab
            addWorkflowTab(id, name);
            
            // Select new workflow
            selectWorkflow(id);
            
            // Close modal
            createWorkflowModal.style.display = 'none';
            
            // Reset form
            newWorkflowName.value = '';
            newWorkflowDescription.value = '';
            
            // Show success message
            showStatus(`Created new workflow "${name}"`);
        }
        
        // Add a workflow tab
        function addWorkflowTab(id, name) {
            const workflowTabs = document.querySelector('.workflow-tabs');
            const addBtn = document.getElementById('addWorkflowBtn');
            
            // Create tab
            const tab = document.createElement('div');
            tab.className = 'workflow-tab';
            tab.setAttribute('data-workflow-id', id);
            tab.innerHTML = `
                <span class="workflow-tab-name">${name}</span>
                <span class="close-tab">&times;</span>
            `;
            
            // Add before add button
            workflowTabs.insertBefore(tab, addBtn);
            
            // Add event listeners
            tab.addEventListener('click', () => {
                selectWorkflow(id);
            });
            
            const closeBtn = tab.querySelector('.close-tab');
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeWorkflowTab(id);
            });
        }
        
        // Select a workflow
        function selectWorkflow(id) {
            // Update current workflow ID
            currentWorkflowId = id;
            
            // Update active tab
            const tabs = document.querySelectorAll('.workflow-tab');
            tabs.forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-workflow-id') === id);
            });
            
            // Load workflow data
            const workflow = workflows[id];
            
            // Update workflow info
            document.getElementById('current-workflow-name').textContent = workflow.name;
            document.getElementById('current-workflow-description').textContent = workflow.description || 'No description provided.';
            
            // Update metadata
            const created = new Date(workflow.created).toLocaleDateString('en-US', { 
                month: 'long', day: 'numeric', year: 'numeric' 
            });
            
            const lastRun = workflow.lastRun 
                ? new Date(workflow.lastRun).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
                : 'Never';
                
            document.querySelector('.workflow-meta').textContent = `Created: ${created} â€¢ Last run: ${lastRun}`;
            
            // Clear stage
            const stageAgents = document.querySelectorAll('.stage-agent');
            stageAgents.forEach(agent => {
                agent.remove();
            });
            
            // Add agents to stage
            workflow.agents.forEach(agent => {
                const agentElem = document.createElement('div');
                agentElem.className = 'stage-agent';
                agentElem.id = agent.id;
                agentElem.setAttribute('data-agent-type', agent.type);
                agentElem.setAttribute('data-agent-id', agent.agentId);
                agentElem.style.left = `${agent.position.x}px`;
                agentElem.style.top = `${agent.position.y}px`;
                
                agentElem.innerHTML = `
                    <div class="agent-header">
                        <div class="agent-color agent-color-${agent.type}"></div>
                        <div class="agent-title">${agent.name}</div>
                        <div class="agent-menu">â‹®</div>
                    </div>
                    <div class="agent-content">
                        ${agent.description}
                    </div>
                    <div class="agent-actions">
                        <div class="agent-edit">Configure</div>
                        <div class="agent-run">
                            <span class="agent-status agent-status-idle"></span>
                            Run
                        </div>
                    </div>
                    <!-- Agent Response Section -->
                    <div class="agent-response" id="response-${agent.id}">
                        <div class="agent-response-header">
                            <span>Response</span>
                            <div class="agent-response-close">&times;</div>
                        </div>
                        <div class="agent-response-content">
                            <!-- Response content will be populated here -->
                        </div>
                    </div>
                    <!-- Connector points -->
                    <div class="connector-points connector-point-right"></div>
                    <div class="connector-points connector-point-left"></div>
                    <div class="connector-points connector-point-top"></div>
                    <div class="connector-points connector-point-bottom"></div>
                `;
                
                storyStage.appendChild(agentElem);
                
                // Make agent draggable
                makeAgentDraggable(agentElem);
                
                // Add event listeners
                addAgentEventListeners(agentElem);
            });
            
            // Update connections
            updateConnections();
            
            // Show/hide empty stage
            toggleEmptyStage();
            
            // Clear response
            responseContent.innerHTML = '';
        }
        
        // Close workflow tab
        function closeWorkflowTab(id) {
            // Can't close if only one tab
            const tabs = document.querySelectorAll('.workflow-tab');
            if (tabs.length <= 1) {
                showStatus('Cannot close the only workflow tab', true);
                return;
            }
            
            // Remove tab
            const tab = document.querySelector(`.workflow-tab[data-workflow-id="${id}"]`);
            if (tab) {
                tab.remove();
            }
            
            // Select another workflow if closing current
            if (id === currentWorkflowId) {
                const firstTab = document.querySelector('.workflow-tab');
                if (firstTab) {
                    const firstId = firstTab.getAttribute('data-workflow-id');
                    selectWorkflow(firstId);
                }
            }
        }
        
        // Export workflows
        function exportWorkflows() {
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                workflows: { ...workflows }
            };
            
            jsonContent.value = JSON.stringify(exportData, null, 2);
            jsonModalTitle.textContent = 'Export Workflows';
            confirmJsonBtn.style.display = 'none';
            cancelJsonBtn.textContent = 'Close';
            
            jsonModal.style.display = 'flex';
        }
        
        // Edit workflow details
        function editWorkflowDetails() {
            const workflow = workflows[currentWorkflowId];
            
            // Fill form
            editWorkflowName.value = workflow.name;
            editWorkflowDescription.value = workflow.description || '';
            
            // Show modal
            editWorkflowModal.style.display = 'flex';
        }
        
        // Save workflow details
        function saveWorkflowDetails() {
            const name = editWorkflowName.value.trim();
            const description = editWorkflowDescription.value.trim();
            
            if (!name) {
                showStatus('Workflow name cannot be empty', true);
                return;
            }
            
            // Update workflow
            const workflow = workflows[currentWorkflowId];
            workflow.name = name;
            workflow.description = description;
            
            // Update UI
            document.getElementById('current-workflow-name').textContent = name;
            document.getElementById('current-workflow-description').textContent = description || 'No description provided.';
            
            // Update tab
            const tab = document.querySelector(`.workflow-tab[data-workflow-id="${currentWorkflowId}"]`);
            if (tab) {
                tab.querySelector('.workflow-tab-name').textContent = name;
            }
            
            // Close modal
            editWorkflowModal.style.display = 'none';
            
            // Show success message
            showStatus('Workflow details updated');
        }
        
        // Open chat with response
        function openChatWithResponse() {
            // Check if there's a response to chat about
            if (!lastResponseContent) {
                showStatus('No workflow response available for chat', true);
                return;
            }
            
            // Reset chat history
            chatHistory = [];
            
            // Add initial message from assistant
            addMessageToChat('assistant', lastResponseContent);
            
            // Show chat modal
            chatModal.style.display = 'flex';
            
            // Focus input
            chatInput.focus();
        }
        
        // Add message to chat
        function addMessageToChat(role, content) {
            // Add to chat history
            chatHistory.push({ role, content });
            
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-sender">${role === 'user' ? 'You' : 'Microsoft Copilot'}</div>
                <div class="message-bubble">
                    <div class="message-content">${formatResponse(content)}</div>
                </div>
                <div class="message-time">${time}</div>
            `;
            
            // Add to DOM
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message-typing';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Hide typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Send chat message
        async function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Clear input
            chatInput.value = '';
            
            // Add user message to chat
            addMessageToChat('user', message);
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Construct conversation history from chatHistory
                const conversationHistory = chatHistory.map(msg => ({
                    role: msg.role,
                    content: msg.content
                }));
                
                // Remove the last user message as we'll send it separately
                conversationHistory.pop();
                
                // Make API request
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_input: message,
                        conversation_history: conversationHistory,
                        user_guid: userGuid
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Add response to chat
                addMessageToChat('assistant', data.assistant_response);
                
            } catch (error) {
                console.error('Chat API Error:', error);
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Show error message
                addMessageToChat('assistant', `I'm sorry, there was an error: ${error.message}`);
            }
        }
        
        // Initialize the application
        function initialize() {
            // Initialize drag-and-drop functionality
            initDragAndDrop();
            
            // Initialize connector handling
            handleConnectors();
            
            // Set up context menus
            setupContextMenus();
            
            // Add event listeners
            addEventListeners();
            
            // Update connections
            updateConnections();
            
            // Show/hide empty stage
            toggleEmptyStage();
            
            // Set up chat features
            setupChatFeatures();
        }
        
        // Set up context menus
        function setupContextMenus() {
           // Close all context menus on any click
           document.addEventListener('click', () => {
                stageContextMenu.style.display = 'none';
                agentContextMenu.style.display = 'none';
            });
            
            // Set up context menu items for stage
            document.querySelectorAll('#stageContextMenu .context-menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    handleContextMenuAction(item.id, stageContextMenu);
                });
            });
            
            // Set up context menu items for agent
            document.querySelectorAll('#agentContextMenu .context-menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    handleContextMenuAction(item.id, agentContextMenu);
                });
            });
            
            // Show stage context menu on right-click
            storyStage.addEventListener('contextmenu', (e) => {
                // Only show menu if clicking on the stage itself, not an agent
                if (!e.target.closest('.stage-agent')) {
                    showStageContextMenu(e);
                }
            });
        }
        
        // Set up chat features
        function setupChatFeatures() {
            // Chat input auto-resize
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = (chatInput.scrollHeight < 150) ? `${chatInput.scrollHeight}px` : '150px';
            });
            
            // Chat send button
            chatSendBtn.addEventListener('click', sendChatMessage);
            
            // Chat input enter key
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            // Close chat modal
            closeChatModal.addEventListener('click', () => {
                chatModal.style.display = 'none';
            });
            
            // Open chat with response
            chatWithResponseBtn.addEventListener('click', openChatWithResponse);
        }
        
        // Add all event listeners for the app
        function addEventListeners() {
            // Close config panel
            closeConfigPanel.addEventListener('click', () => {
                toggleConfigPanel(false);
            });
            
            // Save config button
            document.getElementById('saveConfigBtn').addEventListener('click', saveAgentConfig);
            
            // Cancel config button
            document.getElementById('cancelConfigBtn').addEventListener('click', () => {
                toggleConfigPanel(false);
            });
            
            // Clear response button
            clearResponseBtn.addEventListener('click', () => {
                responseContent.innerHTML = '';
                lastResponseContent = '';
                
                // Also clear all agent responses
                document.querySelectorAll('.agent-response').forEach(response => {
                    response.style.display = 'none';
                });
            });
            
            // Run workflow button
            runWorkflowBtn.addEventListener('click', runWorkflow);
            
            // Save workflow button
            saveWorkflowBtn.addEventListener('click', () => {
                showStatus('Workflow saved successfully');
            });
            
            // Stop workflow button
            stopWorkflowBtn.addEventListener('click', () => {
                runModeOverlay.style.display = 'none';
                showStatus('Workflow execution stopped');
            });
            
            // Add workflow button
            addWorkflowBtn.addEventListener('click', () => {
                createWorkflowModal.style.display = 'flex';
            });
            
            // Create workflow modal
            closeCreateWorkflowModal.addEventListener('click', () => {
                createWorkflowModal.style.display = 'none';
            });
            
            confirmCreateWorkflowBtn.addEventListener('click', createNewWorkflow);
            
            cancelCreateWorkflowBtn.addEventListener('click', () => {
                createWorkflowModal.style.display = 'none';
            });
            
            // Edit workflow modal
            editWorkflowDetailsBtn.addEventListener('click', editWorkflowDetails);
            
            closeEditWorkflowModal.addEventListener('click', () => {
                editWorkflowModal.style.display = 'none';
            });
            
            confirmEditWorkflowBtn.addEventListener('click', saveWorkflowDetails);
            
            cancelEditWorkflowBtn.addEventListener('click', () => {
                editWorkflowModal.style.display = 'none';
            });
            
            // Export button
            exportBtn.addEventListener('click', exportWorkflows);
            
            // JSON modal
            closeJsonModal.addEventListener('click', () => {
                jsonModal.style.display = 'none';
            });
            
            cancelJsonBtn.addEventListener('click', () => {
                jsonModal.style.display = 'none';
            });
            
            // Stage controls
            document.getElementById('zoomInBtn').addEventListener('click', () => {
                stage.scale = Math.min(stage.scale * 1.2, 2);
                updateStageScale();
            });
            
            document.getElementById('zoomOutBtn').addEventListener('click', () => {
                stage.scale = Math.max(stage.scale / 1.2, 0.5);
                updateStageScale();
            });
            
            document.getElementById('resetViewBtn').addEventListener('click', () => {
                stage.scale = 1;
                stage.offsetX = 0;
                stage.offsetY = 0;
                updateStageScale();
            });
            
            // Stage panning
            storyStage.addEventListener('mousedown', (e) => {
                // Only start panning if not clicking on an agent or connector
                if (!e.target.closest('.stage-agent') && !e.target.classList.contains('connector-points')) {
                    stage.isDragging = true;
                    stage.lastX = e.clientX;
                    stage.lastY = e.clientY;
                    storyStage.style.cursor = 'grabbing';
                }
            });
            
            document.addEventListener('mousemove', (e) => {
                if (stage.isDragging) {
                    const dx = e.clientX - stage.lastX;
                    const dy = e.clientY - stage.lastY;
                    
                    stage.offsetX += dx;
                    stage.offsetY += dy;
                    
                    stage.lastX = e.clientX;
                    stage.lastY = e.clientY;
                    
                    updateStageScale();
                }
            });
            
            document.addEventListener('mouseup', () => {
                if (stage.isDragging) {
                    stage.isDragging = false;
                    storyStage.style.cursor = 'default';
                }
            });
            
            // Prevent context menu on agents
            document.addEventListener('contextmenu', (e) => {
                if (e.target.closest('.stage-agent') || 
                    e.target.closest('.context-menu') || 
                    e.target.classList.contains('connector-points')) {
                    e.preventDefault();
                }
            });
            
            // Set up initial workflow tabs
            document.querySelectorAll('.workflow-tab').forEach(tab => {
                const id = tab.getAttribute('data-workflow-id') || 'opportunity-email';
                
                tab.addEventListener('click', () => {
                    selectWorkflow(id);
                });
                
                const closeBtn = tab.querySelector('.close-tab');
                if (closeBtn) {
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        closeWorkflowTab(id);
                    });
                }
            });
            
            // Add response close buttons event listeners for existing agents
            document.querySelectorAll('.agent-response-close').forEach(closeBtn => {
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const responseSection = closeBtn.closest('.agent-response');
                    if (responseSection) {
                        responseSection.style.display = 'none';
                    }
                });
            });

            // Add run buttons event listeners for existing agents
            document.querySelectorAll('.agent-run').forEach(runBtn => {
                runBtn.addEventListener('click', () => {
                    const agentElem = runBtn.closest('.stage-agent');
                    if (agentElem) {
                        runSingleAgent(agentElem.id);
                    }
                });
            });
        }
        
        // Update stage scale and translation
        function updateStageScale() {
            const agents = document.querySelectorAll('.stage-agent');
            agents.forEach(agent => {
                agent.style.transform = `scale(${stage.scale})`;
            });
            
            // Update connections
            updateConnections();
        }
        
        // Document ready function
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize app
            initialize();
            
            // Select initial workflow
            selectWorkflow('opportunity-email');
            
            // Set first tab as active
            document.querySelector('.workflow-tab').classList.add('active');
        });
    </script>
</body>
</html>