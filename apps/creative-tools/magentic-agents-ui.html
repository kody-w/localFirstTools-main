<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magentic Copilot</title>
    <style>
        /* Inline icon system replacing Font Awesome CDN */
        .fas, .far, .fa { display: inline-block; font-style: normal; font-weight: normal; text-rendering: auto; -webkit-font-smoothing: antialiased; }
        .fas::before, .far::before { font-family: sans-serif; }
        .fa-moon::before { content: "\1F319"; }
        .fa-sun::before { content: "\2600\FE0F"; }
        .fa-sync-alt::before { content: "\27F3"; }
        .fa-envelope::before { content: "\2709"; }
        .fa-star::before { content: "\2605"; }
        .fa-star-half-alt::before { content: "\2BEA"; }
        .far .fa-star::before, .far.fa-star::before { content: "\2606"; }
        .fa-user-check::before { content: "\1F464"; }
        .fa-headset::before { content: "\1F3A7"; }
        .fa-calendar-alt::before { content: "\1F4C5"; }
        .fa-clipboard-list::before { content: "\1F4CB"; }
        .fa-receipt::before { content: "\1F9FE"; }
        .fa-edit::before { content: "\270F\FE0F"; }
        .fa-plus::before { content: "+"; }
        .fa-times::before { content: "\00D7"; }
        .fa-arrow-right::before { content: "\2192"; }
        .fa-comment::before { content: "\1F4AC"; }
        .fa-robot::before { content: "\1F916"; }
        .fa-paper-plane::before { content: "\2708"; }
        .fa-database::before { content: "\1F5C4"; }
        .fa-brain::before { content: "\1F9E0"; }
        .fa-cog::before { content: "\2699"; }
        :root {
            --primary-color: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary-color: #4f46e5;
            --secondary-light: #6366f1;
            --secondary-dark: #4338ca;
            --accent-color: #ec4899;
            --accent-light: #f472b6;
            --accent-dark: #db2777;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --ms-gray-10: #fafafa;
            --ms-gray-20: #f4f4f5;
            --ms-gray-30: #e4e4e7;
            --ms-gray-40: #d4d4d8;
            --ms-gray-100: #18181b;
            --ms-gray-130: #09090b;
            --space-xs: 4px;
            --space-s: 8px;
            --space-m: 16px;
            --space-l: 24px;
            --space-xl: 32px;
            --border-radius: 6px;
            --shadow-small: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.1);
            --header-height: 60px;
            --footer-height: 60px;
        }

        /* Use Inter if available locally, otherwise fall back to system fonts */

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Inter", -apple-system, BlinkMacSystemFont,
                "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--ms-gray-10);
            color: var(--ms-gray-100);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--footer-height);
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: var(--shadow-medium);
        }

        .header {
            background: linear-gradient(to right, var(--primary-dark), var(--secondary-dark));
            color: white;
            padding: 0 var(--space-m);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-small);
            z-index: 100;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--space-s);
        }

        .logo {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 5px 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 242, 254, 0.3);
            font-weight: 700;
            color: white;
            letter-spacing: 0.5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-s);
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 3fr 1fr;
            overflow: hidden;
        }

        .app-store-container {
            padding: var(--space-m);
            overflow-y: auto;
            border-right: 1px solid var(--ms-gray-30);
            height: calc(100vh - var(--header-height) - var(--footer-height));
        }

        .workflow-container {
            padding: var(--space-m);
            overflow-y: auto;
            border-right: 1px solid var(--ms-gray-30);
            height: calc(100vh - var(--header-height) - var(--footer-height));
        }

        .queue-container {
            padding: var(--space-m);
            overflow-y: auto;
            height: calc(100vh - var(--header-height) - var(--footer-height));
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--space-m);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .workflow-card {
            background-color: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--ms-gray-30);
            box-shadow: var(--shadow-small);
            padding: var(--space-m);
            margin-bottom: var(--space-m);
        }

        .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-m);
        }

        .workflow-name {
            font-size: 16px;
            font-weight: 600;
        }

        .workflow-description {
            color: var(--ms-gray-100);
            margin-bottom: var(--space-m);
            font-size: 14px;
        }

        .workflow-agents {
            margin-top: var(--space-m);
        }

        .agent-item {
            display: flex;
            align-items: center;
            padding: var(--space-s);
            margin-bottom: var(--space-s);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            background-color: var(--ms-gray-10);
            cursor: grab;
        }

        .agent-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: var(--space-s);
        }

        .dynamics-color {
            background-color: var(--primary-color);
        }

        .email-color {
            background-color: var(--secondary-color);
        }

        .memory-color {
            background-color: var(--accent-color);
        }

        .custom-color {
            background-color: var(--warning-color);
        }

        .agent-details {
            flex: 1;
        }

        .agent-name {
            font-weight: 600;
            font-size: 14px;
        }

        .agent-command {
            font-size: 12px;
            color: var(--ms-gray-100);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .agent-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .button {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: var(--space-xs) var(--space-s);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .button:hover {
            background: var(--primary-dark);
        }

        .button:active {
            transform: scale(0.98);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button.secondary {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .button.secondary:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .button.icon-only {
            width: 24px;
            height: 24px;
            padding: 0;
        }

        .workflow-connections {
            margin-top: var(--space-m);
        }

        .connection-item {
            display: flex;
            align-items: center;
            padding: var(--space-s);
            margin-bottom: var(--space-s);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            background-color: var(--ms-gray-10);
            font-size: 12px;
        }

        .connection-arrow {
            margin: 0 var(--space-s);
            color: var(--primary-color);
        }

        .workflow-actions {
            display: flex;
            gap: var(--space-s);
            margin-top: var(--space-m);
            justify-content: flex-end;
        }

        /* Command Queue Styles */
        .queue-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-s);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            padding: var(--space-s);
            margin-bottom: var(--space-m);
            min-height: 200px;
        }

        .queue-empty {
            color: var(--ms-gray-100);
            text-align: center;
            padding: var(--space-m);
            font-style: italic;
        }

        .queue-item {
            display: flex;
            align-items: center;
            padding: var(--space-s);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            background-color: white;
            position: relative;
        }

        .queue-item-number {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
            background: var(--primary-light);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .queue-item-content {
            flex: 1;
            padding-left: 28px;
        }

        .queue-item-command {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .queue-item-skill {
            font-size: 12px;
            color: var(--primary-color);
        }

        .queue-item-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .queue-item-remove {
            color: var(--error-color);
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .queue-item-remove:hover {
            opacity: 1;
        }

        .queue-form {
            margin-top: var(--space-m);
        }

        .form-group {
            margin-bottom: var(--space-m);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--ms-gray-40);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--ms-gray-40);
            border-radius: var(--border-radius);
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .queue-actions {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-m);
        }

        .queue-status {
            padding: var(--space-s);
            border-radius: var(--border-radius);
            font-size: 14px;
            margin-top: var(--space-m);
            display: none;
        }

        .queue-status.processing {
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
            display: block;
        }

        .queue-status.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            display: block;
        }

        .queue-status.error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            display: block;
        }

        .queue-item-completed {
            border-left: 4px solid var(--success-color);
        }

        .queue-item-failed {
            border-left: 4px solid var(--error-color);
        }

        .queue-item-processing {
            border-left: 4px solid var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
        }

        /* App Store Styles */
        .app-category {
            margin-bottom: var(--space-m);
        }

        .app-category-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--space-s);
            padding-bottom: var(--space-xs);
            border-bottom: 1px solid var(--ms-gray-30);
        }

        .app-item {
            display: flex;
            padding: var(--space-s);
            margin-bottom: var(--space-s);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .app-item:hover {
            box-shadow: var(--shadow-small);
            transform: translateY(-2px);
            border-color: var(--primary-light);
        }

        .app-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--space-s);
            color: white;
            border-radius: var(--border-radius);
        }

        .app-details {
            flex: 1;
        }

        .app-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .app-description {
            font-size: 12px;
            color: var(--ms-gray-100);
        }

        .app-rating {
            display: flex;
            align-items: center;
            margin-top: 4px;
            font-size: 12px;
            color: var(--warning-color);
        }

        /* Footer styles */
        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--ms-gray-10);
            border-top: 1px solid var(--ms-gray-30);
            padding: 0 var(--space-m);
        }

        .footer-actions {
            display: flex;
            gap: var(--space-m);
        }

        .footer-status {
            font-size: 12px;
            color: var(--ms-gray-100);
        }

        /* Chat Interface Styles */
        .chat-container {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 350px;
            height: 500px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            display: none;
        }

        .chat-header {
            padding: 12px 16px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background-color: var(--ms-gray-10);
        }

        .chat-message {
            margin-bottom: 12px;
            max-width: 80%;
        }

        .chat-message.user {
            margin-left: auto;
        }

        .chat-message.assistant {
            margin-right: auto;
        }

        .message-bubble {
            padding: 10px 12px;
            border-radius: 18px;
            display: inline-block;
            font-size: 14px;
        }

        .user .message-bubble {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .assistant .message-bubble {
            background-color: white;
            color: var(--ms-gray-100);
            border: 1px solid var(--ms-gray-30);
            border-bottom-left-radius: 4px;
        }

        .chat-input-area {
            padding: 12px;
            border-top: 1px solid var(--ms-gray-30);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--ms-gray-30);
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            height: 40px;
            min-height: 40px;
            max-height: 120px;
            overflow-y: auto;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .chat-send {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chat-send:hover {
            background-color: var(--primary-dark);
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            padding: var(--space-l);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-m);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--ms-gray-100);
            cursor: pointer;
        }

        .modal-body {
            margin-bottom: var(--space-m);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-s);
            margin-top: var(--space-m);
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: var(--space-xs);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Utility classes */
        .hidden {
            display: none;
        }

        /* Dark mode */
        body.dark-mode {
            background-color: var(--ms-gray-130);
            color: white;
        }

        body.dark-mode .app-container {
            background: var(--ms-gray-100);
        }

        body.dark-mode .workflow-card,
        body.dark-mode .queue-item,
        body.dark-mode .modal-content,
        body.dark-mode .app-item,
        body.dark-mode .chat-container {
            background-color: var(--ms-gray-100);
            border-color: var(--ms-gray-40);
        }

        body.dark-mode .agent-item,
        body.dark-mode .connection-item {
            background-color: var(--ms-gray-130);
            border-color: var(--ms-gray-40);
        }

        body.dark-mode .form-input,
        body.dark-mode .form-textarea,
        body.dark-mode .chat-input {
            background-color: var(--ms-gray-130);
            color: white;
            border-color: var(--ms-gray-40);
        }

        body.dark-mode .chat-messages {
            background-color: var(--ms-gray-130);
        }

        body.dark-mode .assistant .message-bubble {
            background-color: var(--ms-gray-100);
            color: white;
            border-color: var(--ms-gray-40);
        }

        body.dark-mode .footer {
            background-color: var(--ms-gray-100);
            border-color: var(--ms-gray-40);
        }

        body.dark-mode .queue-empty {
            color: white;
        }

        body.dark-mode .queue-list {
            border-color: var(--ms-gray-40);
        }

        /* Drag and drop styling */
        .drag-over {
            border: 2px dashed var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
        }

        /* Response viewer */
        .response-container {
            margin-top: var(--space-m);
            border: 1px solid var(--ms-gray-30);
            border-radius: var(--border-radius);
            padding: var(--space-m);
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--ms-gray-10);
            font-size: 14px;
        }

        body.dark-mode .response-container {
            background-color: var(--ms-gray-130);
            border-color: var(--ms-gray-40);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        /* Mobile responsiveness */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr 2fr;
            }

            .app-store-container {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }

            .workflow-container {
                border-right: none;
                border-bottom: 1px solid var(--ms-gray-30);
            }
            
            .button.secondary {
                padding: 4px 8px;
            }
            
            .agent-command {
                max-width: 150px;
            }

            .chat-container {
                width: 100%;
                height: 80vh;
                bottom: 10px;
                right: 0;
                border-radius: 0;
            }

            .chat-header {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo-container">
                <div class="logo">Magentic Copilot</div>
            </div>
            <div class="header-actions">
                <button id="theme-toggle" class="button icon-only" title="Toggle Theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <main class="main-container">
            <section class="app-store-container">
                <div class="section-title">
                    <span>App Store</span>
                    <button class="button" id="refresh-apps-btn" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <div class="app-category">
                    <div class="app-category-title">Featured Workflows</div>
                    <div class="app-item" data-workflow-id="opportunity-email">
                        <div class="app-icon" style="background-color: #3b82f6;">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Opportunity Summary Email</div>
                            <div class="app-description">Automatically send opportunity summaries to your team lead</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                                <span style="margin-left: 5px; color: #666;">4.5</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-item" data-workflow-id="lead-followup">
                        <div class="app-icon" style="background-color: #10b981;">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Lead Follow-up</div>
                            <div class="app-description">Create and follow up with new leads automatically</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="far fa-star"></i>
                                <span style="margin-left: 5px; color: #666;">4.0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="app-category">
                    <div class="app-category-title">New Releases</div>
                    <div class="app-item" data-workflow-id="customer-support">
                        <div class="app-icon" style="background-color: #ec4899;">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Customer Support Bot</div>
                            <div class="app-description">AI-powered customer support assistant</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <span style="margin-left: 5px; color: #666;">5.0</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-item" data-workflow-id="social-scheduler">
                        <div class="app-icon" style="background-color: #f59e0b;">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Social Media Scheduler</div>
                            <div class="app-description">Schedule and automate social media posts</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="far fa-star"></i>
                                <span style="margin-left: 5px; color: #666;">4.2</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="app-category">
                    <div class="app-category-title">Work Productivity</div>
                    <div class="app-item" data-workflow-id="meeting-summary">
                        <div class="app-icon" style="background-color: #6366f1;">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Meeting Summarizer</div>
                            <div class="app-description">Create and send meeting summaries automatically</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                                <span style="margin-left: 5px; color: #666;">4.6</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-item" data-workflow-id="expense-reporter">
                        <div class="app-icon" style="background-color: #ef4444;">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="app-details">
                            <div class="app-name">Expense Reporter</div>
                            <div class="app-description">Automatically process and submit expense reports</div>
                            <div class="app-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                                <i class="far fa-star"></i>
                                <span style="margin-left: 5px; color: #666;">3.7</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="workflow-container">
                <div class="section-title">
                    <span>Workflow Designer</span>
                    <button class="button" id="create-workflow-btn">Create New</button>
                </div>

                <div class="workflow-card">
                    <div class="workflow-header">
                        <div class="workflow-name" id="current-workflow-name">Opportunity Summary Email</div>
                        <button class="button secondary icon-only" id="edit-workflow-btn" title="Edit Workflow">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="workflow-description" id="current-workflow-description">
                        This workflow retrieves your active sales opportunities from Dynamics 365 and sends a summary email to your team lead.
                    </div>

                    <div class="workflow-agents">
                        <h3>Agents</h3>
                        <div class="agent-list" id="agent-list">
                            <!-- Agents will be populated here by JavaScript -->
                        </div>
                    </div>

                    <div class="workflow-connections">
                        <h3>Connections</h3>
                        <div class="connection-list" id="connection-list">
                            <!-- Connections will be populated here by JavaScript -->
                        </div>
                    </div>

                    <div class="workflow-actions">
                        <button class="button secondary" id="export-workflow-btn">Export</button>
                        <button class="button secondary" id="import-workflow-btn">Import</button>
                        <button class="button secondary" id="convert-to-queue-btn">Convert to Queue</button>
                        <button class="button" id="run-workflow-btn">Run Workflow</button>
                    </div>
                </div>

                <div class="response-container hidden" id="workflow-response">
                    <h3>Workflow Response</h3>
                    <div id="response-content"></div>
                    <div class="workflow-chat-actions" style="margin-top: 10px; text-align: right;">
                        <button class="button" id="open-chat-btn">
                            <i class="fas fa-comment"></i> Open Chat
                        </button>
                    </div>
                </div>
            </section>

            <section class="queue-container">
                <div class="section-title">
                    <span>Command Queue</span>
                    <button class="button" id="convert-to-workflow-btn">Convert to Workflow</button>
                </div>

                <div class="queue-list" id="queue-list">
                    <div class="queue-empty" id="queue-empty">No commands in queue</div>
                    <!-- Command queue items will be added here by JavaScript -->
                </div>

                <div class="queue-form">
                    <div class="form-group">
                        <label for="command-input" class="form-label">Command</label>
                        <textarea id="command-input" class="form-textarea" placeholder="Enter your command..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="skill-input" class="form-label">Expected Skill (optional)</label>
                        <select id="skill-input" class="form-input">
                            <option value="">-- Select Skill --</option>
                            <option value="dynamics">Dynamics 365</option>
                            <option value="email">Email</option>
                            <option value="memory">Memory</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="queue-actions">
                        <div>
                            <button class="button secondary" id="clear-queue-btn">Clear Queue</button>
                        </div>
                        <div>
                            <button class="button" id="add-command-btn">Add Command</button>
                            <button class="button" id="run-queue-btn">Run Queue</button>
                        </div>
                    </div>
                </div>

                <div class="queue-status" id="queue-status"></div>
                
                <div class="response-container hidden" id="queue-response">
                    <h3>Queue Response</h3>
                    <div id="queue-response-content"></div>
                    <div class="queue-chat-actions" style="margin-top: 10px; text-align: right;">
                        <button class="button" id="queue-open-chat-btn">
                            <i class="fas fa-comment"></i> Open Chat
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <div class="footer-status" id="footer-status">Ready</div>
            <div class="footer-actions">
                <button class="button secondary" id="export-json-btn">Export JSON</button>
                <button class="button secondary" id="import-json-btn">Import JSON</button>
            </div>
        </footer>

        <!-- Chat Interface -->
        <div class="chat-container" id="chat-container">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-robot"></i>
                    <span id="chat-title-text">Magentic Assistant</span>
                </div>
                <button class="chat-close" id="chat-close">&times;</button>
            </div>
            <div class="chat-messages" id="chat-messages">
                <!-- Chat messages will be added here by JavaScript -->
            </div>
            <div class="chat-input-area">
                <textarea class="chat-input" id="chat-input" placeholder="Type your message..." rows="1"></textarea>
                <button class="chat-send" id="chat-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Workflow Modal -->
    <div class="modal" id="edit-workflow-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Workflow</div>
                <button class="modal-close" id="close-edit-workflow">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="workflow-name" class="form-label">Workflow Name</label>
                    <input type="text" id="workflow-name" class="form-input" placeholder="Enter workflow name">
                </div>
                <div class="form-group">
                    <label for="workflow-description" class="form-label">Description</label>
                    <textarea id="workflow-description" class="form-textarea" placeholder="Describe your workflow"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button secondary" id="cancel-edit-workflow">Cancel</button>
                <button class="button" id="save-edit-workflow">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Agent Modal -->
    <div class="modal" id="edit-agent-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Agent</div>
                <button class="modal-close" id="close-edit-agent">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="agent-name" class="form-label">Agent Name</label>
                    <input type="text" id="agent-name" class="form-input" placeholder="Enter agent name">
                </div>
                <div class="form-group">
                    <label for="agent-description" class="form-label">Description</label>
                    <input type="text" id="agent-description" class="form-input" placeholder="Enter agent description">
                </div>
                <div class="form-group">
                    <label for="agent-command" class="form-label">Command</label>
                    <textarea id="agent-command" class="form-textarea" placeholder="Enter agent command"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button secondary" id="cancel-edit-agent">Cancel</button>
                <button class="button" id="save-edit-agent">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Import/Export JSON Modal -->
    <div class="modal" id="json-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="json-modal-title">Import/Export JSON</div>
                <button class="modal-close" id="close-json-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <textarea id="json-content" class="form-textarea" style="min-height: 300px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button secondary" id="cancel-json-modal">Cancel</button>
                <button class="button" id="confirm-json-modal">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Chat Context Modal -->
    <div class="modal" id="chat-context-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Join Chat at Specific Step</div>
                <button class="modal-close" id="close-chat-context-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select the step where you want to intervene:</label>
                    <div id="workflow-steps-list" style="margin-top: 10px;">
                        <!-- Steps will be added here dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button secondary" id="cancel-chat-context">Cancel</button>
                <button class="button" id="confirm-chat-context">Join Chat</button>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div class="modal" id="auth-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">API Authentication</div>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Please enter your API key to connect to the backend services.</p>
                <div class="form-group">
                    <label for="api-key" class="form-label">API Key</label>
                    <input type="password" id="api-key" class="form-input" placeholder="Enter your API key">
                </div>
            </div>
            <div class="modal-footer">
                <button class="button" id="save-api-key">Save and Connect</button>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Initial data
        const initialData = {
            "version": "1.0",
            "exportDate": "2025-03-21T20:05:53.439Z",
            "workflows": {
                "opportunity-email": {
                    "id": "opportunity-email",
                    "name": "Opportunity Summary Email",
                    "description": "This workflow retrieves your active sales opportunities from Dynamics 365 and sends a summary email to your team lead.",
                    "created": "2025-03-15T10:30:00",
                    "lastRun": "2025-03-17T14:45:00",
                    "agents": [
                        {
                            "id": "agent1",
                            "type": "dynamics",
                            "agentId": "getOpportunities",
                            "name": "View My Opportunities",
                            "description": "Retrieve all active sales opportunities assigned to you from Dynamics 365.",
                            "position": {
                                "x": 100,
                                "y": 120
                            },
                            "command": "Show me all my active sales opportunities in Dynamics 365. I want to see the name, estimated value, and probability for each one. Also calculate the total potential value of all opportunities."
                        },
                        {
                            "id": "agent2",
                            "type": "email",
                            "agentId": "sendOpportunitySummary",
                            "name": "Send Opportunity Summary",
                            "description": "Send an email with a summary of your active opportunities to your team.",
                            "position": {
                                "x": 400,
                                "y": 120
                            },
                            "command": "Draft an email to my team lead with a summary of my current sales opportunities. Include the total value of all opportunities and highlight the ones with the highest probability of closing. Make it concise but informative."
                        }
                    ],
                    "connections": [
                        {
                            "fromId": "agent1",
                            "toId": "agent2",
                            "connectionPrompt": "Take the list of opportunities from the previous step and create a well-formatted email summarizing the key opportunities, their values, and status. Send this summary to my team lead with a professional tone."
                        }
                    ]
                },
                "lead-followup": {
                    "id": "lead-followup",
                    "name": "Lead Follow-up",
                    "description": "Create a lead in Dynamics 365 and schedule a follow-up meeting.",
                    "created": "2025-03-16T15:20:00",
                    "lastRun": "2025-03-16T16:30:00",
                    "agents": [
                        {
                            "id": "agent1",
                            "type": "dynamics",
                            "agentId": "createLead",
                            "name": "Create New Lead",
                            "description": "Create a new lead in Dynamics 365.",
                            "position": {
                                "x": 100,
                                "y": 120
                            },
                            "command": "Create a new lead in Dynamics 365 for [CONTACT_NAME], who is the [JOB_TITLE] at [COMPANY_NAME]. I met them at the Tech Conference and they're interested in our cloud solutions package. Their contact is [EMAIL_ADDRESS] and [PHONE_NUMBER]."
                        },
                        {
                            "id": "agent2",
                            "type": "email",
                            "agentId": "scheduleFollowUp",
                            "name": "Schedule Follow-up",
                            "description": "Send a follow-up email to schedule a meeting.",
                            "position": {
                                "x": 400,
                                "y": 120
                            },
                            "command": "Send a follow-up email to [CONTACT_NAME] to schedule a meeting next week to discuss our cloud solutions package. Propose three different time slots and ask for their preference."
                        }
                    ],
                    "connections": [
                        {
                            "fromId": "agent1",
                            "toId": "agent2",
                            "connectionPrompt": "After creating the lead in Dynamics 365, use the contact information to send a follow-up email to schedule a meeting."
                        }
                    ]
                },
                "customer-support": {
                    "id": "customer-support",
                    "name": "Customer Support Bot",
                    "description": "AI-powered customer support assistant that can handle common inquiries and escalate complex issues.",
                    "created": "2025-03-18T09:15:00",
                    "lastRun": null,
                    "agents": [],
                    "connections": []
                },
                "social-scheduler": {
                    "id": "social-scheduler",
                    "name": "Social Media Scheduler",
                    "description": "Schedule and automate social media posts across multiple platforms.",
                    "created": "2025-03-17T14:22:00",
                    "lastRun": null,
                    "agents": [],
                    "connections": []
                },
                "meeting-summary": {
                    "id": "meeting-summary",
                    "name": "Meeting Summarizer",
                    "description": "Automatically transcribe, summarize, and distribute meeting notes.",
                    "created": "2025-03-15T16:30:00",
                    "lastRun": null,
                    "agents": [],
                    "connections": []
                },
                "expense-reporter": {
                    "id": "expense-reporter",
                    "name": "Expense Reporter",
                    "description": "Scan receipts, categorize expenses, and generate expense reports automatically.",
                    "created": "2025-03-14T11:45:00",
                    "lastRun": null,
                    "agents": [],
                    "connections": []
                }
            }
        };

        // Current state
        let appState = {
            currentWorkflowId: "opportunity-email",
            commandQueue: [],
            expectedSkills: {},
            darkMode: false,
            editingAgentId: null,
            isProcessing: false,
            chatContext: null,
            chatHistory: [],
            selectedStep: null,
            userId: generateUserId(),
            apiUrl: "http://localhost:7071/api/businessinsightbot_function", // Backend API endpoint
            apiKey: localStorage.getItem('apiKey') || ""
        };

        // DOM Elements
        const agentList = document.getElementById('agent-list');
        const connectionList = document.getElementById('connection-list');
        const queueList = document.getElementById('queue-list');
        const queueEmpty = document.getElementById('queue-empty');
        const commandInput = document.getElementById('command-input');
        const skillInput = document.getElementById('skill-input');
        const queueStatus = document.getElementById('queue-status');
        const toast = document.getElementById('toast');
        const footerStatus = document.getElementById('footer-status');
        const themeToggle = document.getElementById('theme-toggle');
        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const chatClose = document.getElementById('chat-close');
        const chatTitleText = document.getElementById('chat-title-text');
        const authModal = document.getElementById('auth-modal');
        const apiKeyInput = document.getElementById('api-key');
        const saveApiKeyBtn = document.getElementById('save-api-key');

        // Modals
        const editWorkflowModal = document.getElementById('edit-workflow-modal');
        const editAgentModal = document.getElementById('edit-agent-modal');
        const jsonModal = document.getElementById('json-modal');
        const chatContextModal = document.getElementById('chat-context-modal');

        // Generate a user ID if not already set
        function generateUserId() {
            const existingId = localStorage.getItem('userGuid');
            if (existingId) {
                return existingId;
            }
            
            const newId = 'user-' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('userGuid', newId);
            return newId;
        }

        // Function to convert workflow to command queue
        function workflowToCommandQueue(workflow) {
            const queue = [];
            const expectedSkills = {};
            
            if (!workflow.agents || workflow.agents.length === 0) {
                return { queue, expectedSkills };
            }
            
            // Create a map of agent IDs to their indices in the sorted order
            const agentOrder = {};
            const visited = new Set();
            let orderIndex = 0;
            
            // Helper function for topological sort
            function visit(agentId) {
                if (visited.has(agentId)) return;
                visited.add(agentId);
                
                // Find outgoing connections
                const outgoingConnections = workflow.connections.filter(c => c.fromId === agentId);
                for (const conn of outgoingConnections) {
                    visit(conn.toId);
                }
                
                agentOrder[agentId] = orderIndex++;
            }
            
            // Start with agents that have no incoming connections
            const hasIncoming = new Set(workflow.connections.map(c => c.toId));
            for (const agent of workflow.agents) {
                if (!hasIncoming.has(agent.id)) {
                    visit(agent.id);
                }
            }
            
            // If there are still unvisited agents, visit them
            for (const agent of workflow.agents) {
                visit(agent.id);
            }
            
            // Sort agents by their order
            const sortedAgents = [...workflow.agents].sort((a, b) => agentOrder[a.id] - agentOrder[b.id]);
            
            // Convert each agent to a command
            sortedAgents.forEach((agent, index) => {
                queue.push(agent.command);
                
                // Use agent type as expected skill
                expectedSkills[index] = agent.type;
            });
            
            return { queue, expectedSkills };
        }

        // Function to convert command queue to workflow
        function commandQueueToWorkflow(queue, expectedSkills, workflowTemplate) {
            // Start with a copy of the template
            const workflow = {
                id: workflowTemplate?.id || `workflow-${Date.now()}`,
                name: workflowTemplate?.name || "Generated Workflow",
                description: workflowTemplate?.description || "Created from command queue",
                created: workflowTemplate?.created || new Date().toISOString(),
                lastRun: null,
                agents: [],
                connections: []
            };
            
            // Generate agents from the command queue
            queue.forEach((command, index) => {
                const skill = expectedSkills[index] || "custom";
                
                // Create an agent ID
                const agentId = `agent${index + 1}`;
                
                // Determine agent type and ID based on the skill
                let agentType = skill;
                let agentSubId = "custom";
                
                // Map skill to agent properties based on a lookup
                const agentLookup = {
                    "dynamics": { type: "dynamics", id: "getOpportunities", name: "Dynamics Operation" },
                    "email": { type: "email", id: "sendEmail", name: "Email Operation" },
                    "memory": { type: "memory", id: "memorySave", name: "Memory Operation" },
                    "custom": { type: "custom", id: "customAgent", name: "Custom Operation" }
                };
                
                if (agentLookup[skill]) {
                    agentType = agentLookup[skill].type;
                    agentSubId = agentLookup[skill].id;
                }
                
                // Create agent
                const agent = {
                    id: agentId,
                    type: agentType,
                    agentId: agentSubId,
                    name: `Command ${index + 1}`,
                    description: `Executes: ${command.substring(0, 50)}...`,
                    position: {
                        x: 100 + index * 300,
                        y: 120
                    },
                    command: command
                };
                
                workflow.agents.push(agent);
                
                // Create connections (simple linear chain)
                if (index > 0) {
                    const prevAgentId = `agent${index}`;
                    workflow.connections.push({
                        fromId: prevAgentId,
                        toId: agentId,
                        connectionPrompt: `Pass the results from Command ${index} to Command ${index + 1}`
                    });
                }
            });
            
            return workflow;
        }

        // Function to show a toast notification
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Function to update footer status
        function updateFooterStatus(message) {
            footerStatus.textContent = message;
        }

        // Function to render agent list
        function renderAgentList() {
            const workflow = initialData.workflows[appState.currentWorkflowId];
            
            agentList.innerHTML = '';
            
            if (!workflow.agents || workflow.agents.length === 0) {
                agentList.innerHTML = '<div class="empty-message">No agents in this workflow</div>';
                return;
            }
            
            workflow.agents.forEach(agent => {
                const agentElement = document.createElement('div');
                agentElement.className = 'agent-item';
                agentElement.setAttribute('data-agent-id', agent.id);
                agentElement.setAttribute('draggable', 'true');
                
                agentElement.innerHTML = `
                    <div class="agent-icon ${agent.type}-color">
                        <i class="fas ${getIconForAgentType(agent.type)}"></i>
                    </div>
                    <div class="agent-details">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-command">${agent.command}</div>
                    </div>
                    <div class="agent-actions">
                        <button class="button secondary icon-only agent-edit-btn" title="Edit Agent">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="button icon-only agent-add-to-queue-btn" title="Add to Queue">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;
                
                // Add event listeners
                agentElement.querySelector('.agent-edit-btn').addEventListener('click', () => {
                    openEditAgentModal(agent.id);
                });
                
                agentElement.querySelector('.agent-add-to-queue-btn').addEventListener('click', () => {
                    addAgentToQueue(agent.id);
                });
                
                agentList.appendChild(agentElement);
            });
        }

        // Function to render connection list
        function renderConnectionList() {
            const workflow = initialData.workflows[appState.currentWorkflowId];
            
            connectionList.innerHTML = '';
            
            if (!workflow.connections || workflow.connections.length === 0) {
                connectionList.innerHTML = '<div class="empty-message">No connections in this workflow</div>';
                return;
            }
            
            workflow.connections.forEach(connection => {
                const fromAgent = workflow.agents.find(a => a.id === connection.fromId);
                const toAgent = workflow.agents.find(a => a.id === connection.toId);
                
                if (!fromAgent || !toAgent) return;
                
                const connectionElement = document.createElement('div');
                connectionElement.className = 'connection-item';
                
                connectionElement.innerHTML = `
                    <div class="connection-from">${fromAgent.name}</div>
                    <div class="connection-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    <div class="connection-to">${toAgent.name}</div>
                `;
                
                connectionList.appendChild(connectionElement);
            });
        }

        // Function to render command queue
        function renderCommandQueue() {
            queueList.innerHTML = '';
            
            if (appState.commandQueue.length === 0) {
                queueEmpty.style.display = 'block';
                return;
            }
            
            queueEmpty.style.display = 'none';
            
            appState.commandQueue.forEach((command, index) => {
                const queueItem = document.createElement('div');
                queueItem.className = 'queue-item';

                const skill = appState.expectedSkills[index] || '';

                queueItem.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <span><strong>#${index + 1}</strong> ${skill ? '<span class="badge">' + skill + '</span>' : ''}</span>
                        <button class="button icon-only queue-remove-btn" title="Remove"><i class="fas fa-times"></i></button>
                    </div>
                    <div style="font-size:13px;color:#555;">${command}</div>
                `;

                queueItem.querySelector('.queue-remove-btn').addEventListener('click', () => {
                    appState.commandQueue.splice(index, 1);
                    delete appState.expectedSkills[index];
                    renderCommandQueue();
                    showToast('Command removed from queue');
                });

                queueList.appendChild(queueItem);
            });

            queueStatus.textContent = appState.commandQueue.length + ' command(s) in queue';
        }

        function getIconForAgentType(type) {
            const icons = { dynamics: 'fa-database', email: 'fa-envelope', memory: 'fa-brain', custom: 'fa-cog' };
            return icons[type] || 'fa-cog';
        }

        function openEditAgentModal(agentId) {
            const workflow = initialData.workflows[appState.currentWorkflowId];
            const agent = workflow.agents.find(a => a.id === agentId);
            if (!agent) return;
            appState.editingAgentId = agentId;
            document.getElementById('agent-name').value = agent.name;
            document.getElementById('agent-description').value = agent.description;
            document.getElementById('agent-command').value = agent.command;
            editAgentModal.classList.add('active');
        }

        function addAgentToQueue(agentId) {
            const workflow = initialData.workflows[appState.currentWorkflowId];
            const agent = workflow.agents.find(a => a.id === agentId);
            if (!agent) return;
            const index = appState.commandQueue.length;
            appState.commandQueue.push(agent.command);
            appState.expectedSkills[index] = agent.type;
            renderCommandQueue();
            showToast('Added "' + agent.name + '" to queue');
        }

        function selectWorkflow(workflowId) {
            if (!initialData.workflows[workflowId]) return;
            appState.currentWorkflowId = workflowId;
            const workflow = initialData.workflows[workflowId];
            document.getElementById('current-workflow-name').textContent = workflow.name;
            document.getElementById('current-workflow-description').textContent = workflow.description;
            document.querySelectorAll('.app-item').forEach(item => {
                item.classList.toggle('active', item.dataset.workflowId === workflowId);
            });
            renderAgentList();
            renderConnectionList();
            updateFooterStatus('Loaded: ' + workflow.name);
        }

        function openModal(modal) { modal.classList.add('active'); }
        function closeModal(modal) { modal.classList.remove('active'); }

        function openChat(context) {
            appState.chatContext = context || 'general';
            chatContainer.classList.add('active');
            chatTitleText.textContent = context === 'queue' ? 'Queue Assistant' : 'Workflow Assistant';
            if (appState.chatHistory.length === 0) {
                addChatMessage('assistant', 'Hello! I can help you with your workflow. How can I assist you?');
            }
        }

        function addChatMessage(role, content) {
            const msg = document.createElement('div');
            msg.className = 'chat-message ' + role;
            msg.textContent = content;
            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            appState.chatHistory.push({ role: role, content: content });
        }

        function sendChatMessage() {
            const text = chatInput.value.trim();
            if (!text) return;
            addChatMessage('user', text);
            chatInput.value = '';
            setTimeout(() => {
                const responses = [
                    'I understand your request. Let me help with that workflow configuration.',
                    'Great idea! You can configure this by editing the agent command.',
                    'Try adding a connection between those agents to link them.',
                    'Consider adding a new agent step to your workflow.',
                    'You can modify the workflow settings using the edit button.'
                ];
                addChatMessage('assistant', responses[Math.floor(Math.random() * responses.length)]);
            }, 500);
        }

        function saveState() {
            const state = {
                workflows: initialData.workflows,
                currentWorkflowId: appState.currentWorkflowId,
                commandQueue: appState.commandQueue,
                expectedSkills: appState.expectedSkills,
                darkMode: appState.darkMode
            };
            localStorage.setItem('magentic-copilot-state', JSON.stringify(state));
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('magentic-copilot-state');
                if (saved) {
                    const state = JSON.parse(saved);
                    if (state.workflows) Object.assign(initialData.workflows, state.workflows);
                    if (state.currentWorkflowId) appState.currentWorkflowId = state.currentWorkflowId;
                    if (state.commandQueue) appState.commandQueue = state.commandQueue;
                    if (state.expectedSkills) appState.expectedSkills = state.expectedSkills;
                    if (state.darkMode) {
                        appState.darkMode = true;
                        document.body.classList.add('dark-mode');
                    }
                }
            } catch (e) {
                console.warn('Failed to load saved state:', e);
            }
        }

        function exportFullJson() {
            const data = { version: initialData.version, exportDate: new Date().toISOString(), workflows: initialData.workflows };
            document.getElementById('json-modal-title').textContent = 'Export JSON';
            document.getElementById('json-content').value = JSON.stringify(data, null, 2);
            document.getElementById('json-content').readOnly = true;
            document.getElementById('confirm-json-modal').style.display = 'none';
            openModal(jsonModal);
        }

        function importFullJson() {
            document.getElementById('json-modal-title').textContent = 'Import JSON';
            document.getElementById('json-content').value = '';
            document.getElementById('json-content').readOnly = false;
            document.getElementById('confirm-json-modal').style.display = '';
            openModal(jsonModal);
        }

        // --- Event Listeners ---

        document.querySelectorAll('.app-item[data-workflow-id]').forEach(item => {
            item.addEventListener('click', () => selectWorkflow(item.dataset.workflowId));
        });

        themeToggle.addEventListener('click', () => {
            appState.darkMode = !appState.darkMode;
            document.body.classList.toggle('dark-mode');
            themeToggle.querySelector('i').className = appState.darkMode ? 'fas fa-sun' : 'fas fa-moon';
            saveState();
        });

        document.getElementById('create-workflow-btn').addEventListener('click', () => {
            const id = 'workflow-' + Date.now();
            initialData.workflows[id] = { id: id, name: 'New Workflow', description: 'A new workflow', created: new Date().toISOString(), lastRun: null, agents: [], connections: [] };
            selectWorkflow(id);
            showToast('New workflow created');
            saveState();
        });

        document.getElementById('edit-workflow-btn').addEventListener('click', () => {
            const wf = initialData.workflows[appState.currentWorkflowId];
            document.getElementById('workflow-name').value = wf.name;
            document.getElementById('workflow-description').value = wf.description;
            openModal(editWorkflowModal);
        });

        document.getElementById('save-edit-workflow').addEventListener('click', () => {
            const wf = initialData.workflows[appState.currentWorkflowId];
            wf.name = document.getElementById('workflow-name').value;
            wf.description = document.getElementById('workflow-description').value;
            document.getElementById('current-workflow-name').textContent = wf.name;
            document.getElementById('current-workflow-description').textContent = wf.description;
            closeModal(editWorkflowModal);
            showToast('Workflow updated');
            saveState();
        });

        document.getElementById('close-edit-workflow').addEventListener('click', () => closeModal(editWorkflowModal));
        document.getElementById('cancel-edit-workflow').addEventListener('click', () => closeModal(editWorkflowModal));

        document.getElementById('save-edit-agent').addEventListener('click', () => {
            const wf = initialData.workflows[appState.currentWorkflowId];
            const agent = wf.agents.find(a => a.id === appState.editingAgentId);
            if (agent) {
                agent.name = document.getElementById('agent-name').value;
                agent.description = document.getElementById('agent-description').value;
                agent.command = document.getElementById('agent-command').value;
                renderAgentList();
                showToast('Agent updated');
                saveState();
            }
            closeModal(editAgentModal);
        });

        document.getElementById('close-edit-agent').addEventListener('click', () => closeModal(editAgentModal));
        document.getElementById('cancel-edit-agent').addEventListener('click', () => closeModal(editAgentModal));

        document.getElementById('export-workflow-btn').addEventListener('click', () => {
            const wf = initialData.workflows[appState.currentWorkflowId];
            document.getElementById('json-modal-title').textContent = 'Export Workflow';
            document.getElementById('json-content').value = JSON.stringify(wf, null, 2);
            document.getElementById('json-content').readOnly = true;
            document.getElementById('confirm-json-modal').style.display = 'none';
            openModal(jsonModal);
        });

        document.getElementById('import-workflow-btn').addEventListener('click', () => {
            document.getElementById('json-modal-title').textContent = 'Import Workflow';
            document.getElementById('json-content').value = '';
            document.getElementById('json-content').readOnly = false;
            document.getElementById('confirm-json-modal').style.display = '';
            appState._importMode = 'workflow';
            openModal(jsonModal);
        });

        document.getElementById('confirm-json-modal').addEventListener('click', () => {
            try {
                const data = JSON.parse(document.getElementById('json-content').value);
                if (appState._importMode === 'workflow') {
                    const id = data.id || 'workflow-' + Date.now();
                    data.id = id;
                    initialData.workflows[id] = data;
                    selectWorkflow(id);
                    showToast('Workflow imported');
                } else if (data.workflows) {
                    Object.assign(initialData.workflows, data.workflows);
                    selectWorkflow(appState.currentWorkflowId);
                    showToast('Data imported');
                }
                saveState();
            } catch (e) {
                showToast('Invalid JSON: ' + e.message);
            }
            closeModal(jsonModal);
        });

        document.getElementById('close-json-modal').addEventListener('click', () => closeModal(jsonModal));
        document.getElementById('cancel-json-modal').addEventListener('click', () => closeModal(jsonModal));

        document.getElementById('convert-to-queue-btn').addEventListener('click', () => {
            const wf = initialData.workflows[appState.currentWorkflowId];
            const result = workflowToCommandQueue(wf);
            appState.commandQueue = result.queue;
            appState.expectedSkills = result.expectedSkills;
            renderCommandQueue();
            showToast('Converted ' + result.queue.length + ' agent(s) to queue');
        });

        document.getElementById('convert-to-workflow-btn').addEventListener('click', () => {
            if (appState.commandQueue.length === 0) { showToast('Queue is empty'); return; }
            const template = initialData.workflows[appState.currentWorkflowId];
            const wf = commandQueueToWorkflow(appState.commandQueue, appState.expectedSkills, template);
            initialData.workflows[wf.id] = wf;
            selectWorkflow(wf.id);
            showToast('Queue converted to workflow');
            saveState();
        });

        document.getElementById('run-workflow-btn').addEventListener('click', () => {
            const wf = initialData.workflows[appState.currentWorkflowId];
            if (!wf.agents || wf.agents.length === 0) { showToast('No agents to run'); return; }
            appState.isProcessing = true;
            updateFooterStatus('Running workflow...');
            setTimeout(() => {
                wf.lastRun = new Date().toISOString();
                appState.isProcessing = false;
                document.getElementById('workflow-response').classList.remove('hidden');
                document.getElementById('response-content').innerHTML =
                    '<p><strong>Workflow completed!</strong></p><p>Executed ' + wf.agents.length +
                    ' agent(s) at ' + new Date().toLocaleTimeString() + '</p><ul>' +
                    wf.agents.map(a => '<li>' + a.name + ': \u2713 Complete</li>').join('') + '</ul>';
                updateFooterStatus('Workflow completed');
                showToast('Workflow run completed');
                saveState();
            }, 1500);
        });

        document.getElementById('add-command-btn').addEventListener('click', () => {
            const command = commandInput.value.trim();
            if (!command) { showToast('Please enter a command'); return; }
            const index = appState.commandQueue.length;
            appState.commandQueue.push(command);
            if (skillInput.value) appState.expectedSkills[index] = skillInput.value;
            commandInput.value = '';
            skillInput.value = '';
            renderCommandQueue();
            showToast('Command added to queue');
        });

        document.getElementById('clear-queue-btn').addEventListener('click', () => {
            appState.commandQueue = [];
            appState.expectedSkills = {};
            renderCommandQueue();
            showToast('Queue cleared');
        });

        document.getElementById('run-queue-btn').addEventListener('click', () => {
            if (appState.commandQueue.length === 0) { showToast('Queue is empty'); return; }
            appState.isProcessing = true;
            updateFooterStatus('Running queue...');
            setTimeout(() => {
                appState.isProcessing = false;
                document.getElementById('queue-response').classList.remove('hidden');
                document.getElementById('queue-response-content').innerHTML =
                    '<p><strong>Queue executed!</strong></p><p>Processed ' +
                    appState.commandQueue.length + ' command(s) at ' + new Date().toLocaleTimeString() + '</p>';
                updateFooterStatus('Queue completed');
                showToast('Queue run completed');
            }, 1000);
        });

        document.getElementById('open-chat-btn').addEventListener('click', () => openChat('workflow'));
        document.getElementById('queue-open-chat-btn').addEventListener('click', () => openChat('queue'));
        chatClose.addEventListener('click', () => { chatContainer.classList.remove('active'); });
        chatSend.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); }
        });

        document.getElementById('close-chat-context-modal').addEventListener('click', () => closeModal(chatContextModal));
        document.getElementById('cancel-chat-context').addEventListener('click', () => closeModal(chatContextModal));
        document.getElementById('confirm-chat-context').addEventListener('click', () => { closeModal(chatContextModal); openChat('workflow'); });

        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) { appState.apiKey = key; localStorage.setItem('apiKey', key); closeModal(authModal); showToast('API key saved'); }
        });

        document.getElementById('export-json-btn').addEventListener('click', exportFullJson);
        document.getElementById('import-json-btn').addEventListener('click', () => { appState._importMode = 'full'; importFullJson(); });
        document.getElementById('refresh-apps-btn').addEventListener('click', () => { selectWorkflow(appState.currentWorkflowId); showToast('Refreshed'); });

        // Initialize
        (function init() {
            loadState();
            selectWorkflow(appState.currentWorkflowId);
            renderCommandQueue();
            updateFooterStatus('Ready');
        })();
    </script>
</body>
</html>
