<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="rappterzoo:author" content="RappterZoo">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="creative_tools">
<meta name="rappterzoo:tags" content="crm,questionnaire,survey,data,viewer">
<meta name="rappterzoo:type" content="interface">
<meta name="rappterzoo:complexity" content="intermediate">
<meta name="rappterzoo:created" content="2025-01-01">
<meta name="rappterzoo:generation" content="2">
<title>CRM Questionnaire Progress Viewer</title>
<style>
:root{--bg:#0e1113;--bg2:#161a1e;--bg3:#1e2329;--bg4:#2a2f35;--text:#e0e0e0;--text2:#aaa;--text3:#666;
--accent:#2c6ecb;--accent2:#4d8ce0;--green:#4caf50;--orange:#f39c12;--red:#e74c3c;--cyan:#00d2d3;
--radius:8px;--shadow:0 2px 8px rgba(0,0,0,.3)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
.container{max-width:1200px;margin:0 auto;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--bg4);flex-wrap:wrap;gap:12px}
h1{font-size:1.5rem;color:var(--cyan)}
h2{color:var(--cyan);font-size:1.1rem;margin-bottom:12px}
h3{color:var(--text);font-size:1rem;margin-bottom:8px}
.header-actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--bg4);color:var(--text2);padding:8px 16px;border-radius:var(--radius);cursor:pointer;font-size:.85rem;transition:all .2s}
.btn:hover{background:var(--bg4);color:var(--text)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent2)}
.btn-export{background:#2d4a2d;border-color:#3d5a3d;color:#95d5b2}
.btn-export:hover{background:#3d5a3d}
.upload-area{background:var(--bg2);border:2px dashed var(--bg4);border-radius:var(--radius);padding:40px;text-align:center;cursor:pointer;transition:all .3s;margin-bottom:24px}
.upload-area:hover,.upload-area.active{border-color:var(--accent);background:var(--bg3)}
.upload-area p{color:var(--text2);margin-top:8px;font-size:.9rem}
.upload-area .icon{font-size:2rem;color:var(--text3);margin-bottom:8px}
#fileInput{display:none}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:24px}
.card{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:20px;transition:all .3s}
.card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.card-title{font-size:.85rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.card-value{font-size:2rem;font-weight:700;color:var(--cyan)}
.card-sub{font-size:.8rem;color:var(--text3);margin-top:4px}
.progress-container{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:24px;margin-bottom:24px}
.progress-bar{height:12px;background:var(--bg4);border-radius:6px;overflow:hidden;margin:12px 0 8px}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--cyan));border-radius:6px;transition:width .8s ease}
.progress-labels{display:flex;justify-content:space-between;font-size:.85rem;color:var(--text2)}
.section-tabs{display:flex;gap:4px;overflow-x:auto;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid var(--bg4);scrollbar-width:none}
.section-tabs::-webkit-scrollbar{display:none}
.section-tab{padding:8px 16px;background:var(--bg2);border:1px solid var(--bg4);border-radius:6px 6px 0 0;cursor:pointer;font-size:.85rem;color:var(--text2);white-space:nowrap;transition:all .2s;border-bottom:2px solid transparent}
.section-tab:hover{color:var(--text);background:var(--bg3)}
.section-tab.active{background:var(--bg3);color:var(--cyan);border-bottom-color:var(--cyan)}
.section-tab .badge{display:inline-block;background:var(--bg4);padding:1px 6px;border-radius:10px;font-size:.7rem;margin-left:4px}
.section-tab.active .badge{background:rgba(0,210,211,.2);color:var(--cyan)}
.search-box{position:relative;margin-bottom:16px}
.search-box input{width:100%;padding:10px 16px 10px 36px;background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);color:var(--text);font-size:.9rem}
.search-box input:focus{outline:none;border-color:var(--accent)}
.search-box svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text3)}
.question-item{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:20px;margin-bottom:12px;transition:all .2s}
.question-item:hover{border-color:var(--accent)}
.question-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:12px}
.question-id{font-size:.75rem;background:var(--bg3);padding:2px 8px;border-radius:4px;color:var(--text3);font-family:monospace;white-space:nowrap}
.question-title{font-weight:600;font-size:.95rem;flex:1}
.question-meta{display:flex;gap:16px;font-size:.8rem;color:var(--text3);margin-bottom:12px;flex-wrap:wrap}
.answer-area{background:var(--bg3);padding:16px;border-radius:6px;border-left:3px solid var(--bg4)}
.answer-area.answered{border-left-color:var(--green)}
.answer-area.unanswered{border-left-color:var(--orange)}
.answer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.answer-status{padding:3px 10px;border-radius:12px;font-size:.75rem;font-weight:600}
.status-answered{background:#2d6a4f44;color:#95d5b2}
.status-unanswered{background:#6a5a2d44;color:#d5c595}
.answer-content{white-space:pre-wrap;font-size:.9rem;line-height:1.6}
.confidence-bar{height:4px;background:var(--bg4);border-radius:2px;margin-top:12px;overflow:hidden}
.confidence-fill{height:100%;background:linear-gradient(90deg,var(--orange),var(--green));border-radius:2px;transition:width .5s}
.empty-state{text-align:center;padding:60px 20px;color:var(--text3)}
.empty-state h2{color:var(--text2);margin-bottom:8px}
.demo-notice{background:var(--bg3);border:1px solid var(--bg4);border-radius:var(--radius);padding:12px 16px;margin-bottom:16px;font-size:.85rem;color:var(--text2);display:flex;align-items:center;gap:8px}
.demo-notice .dot{width:8px;height:8px;background:var(--orange);border-radius:50%;flex-shrink:0}
.filter-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.filter-btn{background:var(--bg2);border:1px solid var(--bg4);color:var(--text3);padding:4px 12px;border-radius:16px;cursor:pointer;font-size:.8rem;transition:all .2s}
.filter-btn:hover{border-color:var(--text3)}
.filter-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
footer{text-align:center;padding:24px;font-size:.75rem;color:var(--text3);border-top:1px solid var(--bg4);margin-top:40px}
@media(max-width:768px){.summary-cards{grid-template-columns:1fr}.question-header{flex-direction:column}}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>CRM Questionnaire Viewer</h1>
    <div class="header-actions">
      <button class="btn" onclick="loadDemo()">Load Demo Data</button>
      <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Import JSON</button>
      <button class="btn btn-export" id="exportBtn" style="display:none" onclick="exportData()">Export Report</button>
      <input type="file" id="fileInput" accept=".json">
    </div>
  </header>

  <div id="upload-area" class="upload-area">
    <div class="icon">&#8681;</div>
    <p>Drag and drop a CRM questionnaire JSON file here, or click Import JSON above</p>
    <p style="font-size:.8rem;color:var(--text3);margin-top:4px">Or click "Load Demo Data" to explore the viewer</p>
  </div>

  <div id="dashboard" style="display:none">
    <div id="demo-notice" class="demo-notice" style="display:none">
      <div class="dot"></div>
      <span>Viewing demo data. Import your own JSON to replace.</span>
    </div>

    <div class="summary-cards" id="summaryCards"></div>

    <div class="progress-container">
      <h2>Overall Progress</h2>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-labels">
        <span id="progressPct">0%</span>
        <span id="progressCount">0/0 Answered</span>
      </div>
    </div>

    <div class="section-tabs" id="sectionTabs"></div>

    <div class="search-box">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="searchInput" placeholder="Search questions and answers...">
    </div>

    <div class="filter-bar" id="filterBar">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="answered">Answered</button>
      <button class="filter-btn" data-filter="unanswered">Unanswered</button>
      <button class="filter-btn" data-filter="low-confidence">Low Confidence (&lt;70%)</button>
    </div>

    <div id="content"></div>
  </div>

  <footer>CRM Questionnaire Progress Viewer | Data stored locally</footer>
</div>

<script>
let data = null;
let activeSection = null;
let searchTerm = '';
let filter = 'all';
let isDemo = false;

const DEMO_DATA = {
  question_bank: {
    general: [
      {id:'Q001',question:'What is your company name?',data_type:'text',section:'general',help_text:'Legal business name'},
      {id:'Q002',question:'How many employees does your organization have?',data_type:'number',section:'general',help_text:'Include full-time and part-time'},
      {id:'Q003',question:'What industry does your company operate in?',data_type:'select',section:'general',help_text:'Primary business sector'},
      {id:'Q004',question:'What is your current CRM solution?',data_type:'text',section:'general',help_text:'Name and version if applicable'},
      {id:'Q005',question:'How long have you been using your current system?',data_type:'text',section:'general',help_text:'Duration in years/months'}
    ],
    sales: [
      {id:'Q010',question:'How many active sales reps do you have?',data_type:'number',section:'sales',help_text:'Include inside and field reps'},
      {id:'Q011',question:'What is your average deal cycle length?',data_type:'text',section:'sales',help_text:'From lead to closed won'},
      {id:'Q012',question:'Do you use sales territories?',data_type:'boolean',section:'sales',help_text:'Geographic or account-based territories'},
      {id:'Q013',question:'What pipeline stages do you track?',data_type:'text',section:'sales',help_text:'List all pipeline stages'},
      {id:'Q014',question:'Do you need CPQ (Configure Price Quote)?',data_type:'boolean',section:'sales',help_text:'Complex pricing or product configurations'},
      {id:'Q015',question:'How do you currently forecast revenue?',data_type:'text',section:'sales',help_text:'Methods and tools used'}
    ],
    marketing: [
      {id:'Q020',question:'What marketing channels do you use?',data_type:'text',section:'marketing',help_text:'Email, social, paid ads, etc.'},
      {id:'Q021',question:'Do you use marketing automation?',data_type:'boolean',section:'marketing',help_text:'Drip campaigns, lead scoring, etc.'},
      {id:'Q022',question:'How do you track campaign ROI?',data_type:'text',section:'marketing',help_text:'Attribution models and reporting'},
      {id:'Q023',question:'What is your lead volume per month?',data_type:'number',section:'marketing',help_text:'Average monthly inbound leads'}
    ],
    support: [
      {id:'Q030',question:'How many support agents do you employ?',data_type:'number',section:'support',help_text:'Full-time equivalent'},
      {id:'Q031',question:'What channels do customers use for support?',data_type:'text',section:'support',help_text:'Phone, email, chat, portal, etc.'},
      {id:'Q032',question:'Do you use a ticketing system?',data_type:'boolean',section:'support',help_text:'Current ticketing solution'},
      {id:'Q033',question:'What is your target SLA for first response?',data_type:'text',section:'support',help_text:'Time to first response goal'},
      {id:'Q034',question:'Do you need a customer self-service portal?',data_type:'boolean',section:'support',help_text:'Knowledge base and community'}
    ],
    integration: [
      {id:'Q040',question:'What ERP system do you use?',data_type:'text',section:'integration',help_text:'Name and version'},
      {id:'Q041',question:'Do you need email integration (Outlook/Gmail)?',data_type:'boolean',section:'integration',help_text:'Email sync and tracking'},
      {id:'Q042',question:'What other systems need CRM integration?',data_type:'text',section:'integration',help_text:'List all systems'},
      {id:'Q043',question:'Do you have API requirements?',data_type:'boolean',section:'integration',help_text:'Custom integrations via REST/SOAP'}
    ]
  },
  question_answers: {
    Q001:{answer:'Acme Corporation',confidence:0.95},
    Q002:{answer:'450',confidence:0.85},
    Q003:{answer:'Manufacturing & Distribution',confidence:0.90},
    Q010:{answer:'35',confidence:0.80},
    Q011:{answer:'45-60 days average',confidence:0.70},
    Q012:{answer:'Yes, geographic territories across 4 regions',confidence:0.85},
    Q020:{answer:'Email, LinkedIn, Google Ads, Trade Shows',confidence:0.90},
    Q021:{answer:'Yes, using HubSpot for automation',confidence:0.95},
    Q030:{answer:'12',confidence:0.85},
    Q031:{answer:'Phone, email, and web portal',confidence:0.90},
    Q040:{answer:'SAP S/4HANA',confidence:0.95},
    Q041:{answer:'Yes, Outlook integration required',confidence:0.90}
  },
  requirement_bank: {
    functional: [
      {id:'R001',requirement:'System must support role-based access control',module:'security',help_text:'Different permission levels per role',category:'Security'},
      {id:'R002',requirement:'Must integrate with existing SSO solution',module:'security',help_text:'SAML/OAuth support',category:'Security'},
      {id:'R003',requirement:'Support for multi-currency transactions',module:'finance',help_text:'Automatic exchange rate updates',category:'Finance'},
      {id:'R004',requirement:'Real-time dashboard and reporting',module:'analytics',help_text:'Customizable KPI dashboards',category:'Analytics'},
      {id:'R005',requirement:'Mobile app for field sales team',module:'mobile',help_text:'iOS and Android native apps',category:'Mobile'}
    ],
    technical: [
      {id:'R010',requirement:'99.9% uptime SLA',module:'infrastructure',help_text:'Measured monthly',category:'Infrastructure'},
      {id:'R011',requirement:'Data encryption at rest and in transit',module:'security',help_text:'AES-256 minimum',category:'Security'},
      {id:'R012',requirement:'GDPR compliance',module:'compliance',help_text:'Data residency and right to delete',category:'Compliance'}
    ]
  },
  requirement_answers: {
    R001:{answer:'Role-based access is critical. We need Admin, Manager, Sales Rep, and View-Only roles.',confidence:0.90},
    R003:{answer:'We operate in USD, EUR, and GBP. Need daily exchange rate updates.',confidence:0.85},
    R010:{answer:'99.9% uptime is acceptable. We need a clear SLA with penalties.',confidence:0.95}
  }
};

function init(){
  const saved = localStorage.getItem('crm_questionnaire_data');
  if(saved){
    try{
      data = JSON.parse(saved);
      isDemo = !!localStorage.getItem('crm_questionnaire_demo');
      showDashboard();
    }catch(e){}
  }

  document.getElementById('fileInput').addEventListener('change',handleFile);
  document.getElementById('searchInput').addEventListener('input',e=>{searchTerm=e.target.value.toLowerCase();renderContent()});
  document.getElementById('upload-area').addEventListener('click',()=>document.getElementById('fileInput').click());

  const da=document.getElementById('upload-area');
  ['dragenter','dragover','dragleave','drop'].forEach(ev=>da.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation()}));
  ['dragenter','dragover'].forEach(ev=>da.addEventListener(ev,()=>da.classList.add('active')));
  ['dragleave','drop'].forEach(ev=>da.addEventListener(ev,()=>da.classList.remove('active')));
  da.addEventListener('drop',e=>{const f=e.dataTransfer.files;if(f.length){const inp=document.getElementById('fileInput');inp.files=f;handleFile()}});

  document.getElementById('filterBar').addEventListener('click',e=>{
    const btn=e.target.closest('.filter-btn');
    if(!btn)return;
    filter=btn.dataset.filter;
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    renderContent();
  });
}

function handleFile(){
  const file=document.getElementById('fileInput').files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      data=JSON.parse(e.target.result);
      isDemo=false;
      localStorage.setItem('crm_questionnaire_data',JSON.stringify(data));
      localStorage.removeItem('crm_questionnaire_demo');
      showDashboard();
    }catch(err){alert('Invalid JSON: '+err.message)}
  };
  reader.readAsText(file);
}

function loadDemo(){
  data=JSON.parse(JSON.stringify(DEMO_DATA));
  isDemo=true;
  localStorage.setItem('crm_questionnaire_data',JSON.stringify(data));
  localStorage.setItem('crm_questionnaire_demo','1');
  showDashboard();
}
window.loadDemo=loadDemo;

function showDashboard(){
  document.getElementById('upload-area').style.display='none';
  document.getElementById('dashboard').style.display='block';
  document.getElementById('exportBtn').style.display='';
  document.getElementById('demo-notice').style.display=isDemo?'flex':'none';
  renderSummary();
  renderTabs();
  renderContent();
}

function getStats(){
  const qb=data.question_bank||{};
  const qa=data.question_answers||{};
  const rb=data.requirement_bank||{};
  const ra=data.requirement_answers||{};
  let totalQ=0,totalR=0;
  Object.values(qb).forEach(arr=>totalQ+=arr.length);
  Object.values(rb).forEach(arr=>totalR+=arr.length);
  const answeredQ=Object.keys(qa).length;
  const answeredR=Object.keys(ra).length;
  const allAnswers={...qa,...ra};
  const confidences=Object.values(allAnswers).map(a=>a.confidence||0).filter(c=>c>0);
  const avgConf=confidences.length?confidences.reduce((s,c)=>s+c,0)/confidences.length:0;
  return {totalQ,answeredQ,totalR,answeredR,sections:Object.keys(qb),avgConf,
    reqSections:Object.keys(rb),pctQ:totalQ?Math.round(answeredQ/totalQ*100):0};
}

function renderSummary(){
  const s=getStats();
  document.getElementById('summaryCards').innerHTML=`
    <div class="card"><div class="card-title">Questions</div><div class="card-value">${s.answeredQ}/${s.totalQ}</div><div class="card-sub">Questions answered</div></div>
    <div class="card"><div class="card-title">Completion</div><div class="card-value">${s.pctQ}%</div><div class="card-sub">Question coverage</div></div>
    <div class="card"><div class="card-title">Requirements</div><div class="card-value">${s.answeredR}/${s.totalR}</div><div class="card-sub">Requirements addressed</div></div>
    <div class="card"><div class="card-title">Avg Confidence</div><div class="card-value">${(s.avgConf*100).toFixed(0)}%</div><div class="card-sub">Answer confidence level</div></div>
    <div class="card"><div class="card-title">Sections</div><div class="card-value">${s.sections.length}</div><div class="card-sub">Question categories</div></div>
  `;
  document.getElementById('progressFill').style.width=s.pctQ+'%';
  document.getElementById('progressPct').textContent=s.pctQ+'%';
  document.getElementById('progressCount').textContent=`${s.answeredQ}/${s.totalQ} Questions Answered`;
}

function renderTabs(){
  const s=getStats();
  const qa=data.question_answers||{};
  const qb=data.question_bank||{};
  let html='';
  s.sections.forEach((sec,i)=>{
    const questions=qb[sec]||[];
    const answered=questions.filter(q=>qa[q.id]).length;
    const label=sec.charAt(0).toUpperCase()+sec.slice(1);
    html+=`<div class="section-tab${i===0?' active':''}" data-section="${sec}">${label}<span class="badge">${answered}/${questions.length}</span></div>`;
  });
  if(s.reqSections.length){
    html+=`<div class="section-tab" data-section="requirements">Requirements<span class="badge">${s.answeredR}/${s.totalR}</span></div>`;
  }
  document.getElementById('sectionTabs').innerHTML=html;
  if(!activeSection)activeSection=s.sections[0];
  document.querySelectorAll('.section-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      document.querySelectorAll('.section-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      activeSection=tab.dataset.section;
      renderContent();
    });
  });
}

function renderContent(){
  const container=document.getElementById('content');
  if(activeSection==='requirements'){renderRequirements(container);return}
  const questions=(data.question_bank||{})[activeSection]||[];
  const qa=data.question_answers||{};
  const filtered=questions.filter(q=>{
    const answer=qa[q.id];
    const isAnswered=!!answer;
    if(filter==='answered'&&!isAnswered)return false;
    if(filter==='unanswered'&&isAnswered)return false;
    if(filter==='low-confidence'&&(!answer||answer.confidence>=0.7))return false;
    if(searchTerm){
      const hay=(q.question+' '+(q.help_text||'')+' '+(answer?answer.answer:'')).toLowerCase();
      if(!hay.includes(searchTerm))return false;
    }
    return true;
  });
  if(!filtered.length){container.innerHTML='<div class="empty-state"><h2>No matching questions</h2><p>Try adjusting your search or filters.</p></div>';return}
  container.innerHTML=filtered.map(q=>{
    const answer=qa[q.id];
    const isAnswered=!!answer;
    return `<div class="question-item">
      <div class="question-header">
        <div class="question-title">${esc(q.question)}</div>
        <div class="question-id">${esc(q.id)}</div>
      </div>
      <div class="question-meta">
        <span>Type: ${esc(q.data_type)}</span>
        <span>Section: ${esc(q.section)}</span>
        ${q.help_text?`<span>Help: ${esc(q.help_text)}</span>`:''}
      </div>
      <div class="answer-area ${isAnswered?'answered':'unanswered'}">
        <div class="answer-header">
          <span class="answer-status ${isAnswered?'status-answered':'status-unanswered'}">${isAnswered?'Answered':'Unanswered'}</span>
          ${isAnswered?`<span style="font-size:.8rem;color:var(--text3)">Confidence: ${Math.round(answer.confidence*100)}%</span>`:''}
        </div>
        <div class="answer-content">${isAnswered?esc(answer.answer):'No answer provided yet.'}</div>
        ${isAnswered?`<div class="confidence-bar"><div class="confidence-fill" style="width:${answer.confidence*100}%"></div></div>`:''}
      </div>
    </div>`;
  }).join('');
}

function renderRequirements(container){
  const rb=data.requirement_bank||{};
  const ra=data.requirement_answers||{};
  let html='';
  Object.entries(rb).forEach(([sec,reqs])=>{
    const label=sec.charAt(0).toUpperCase()+sec.slice(1);
    const filtered=reqs.filter(r=>{
      const answer=ra[r.id];
      const isAnswered=!!answer;
      if(filter==='answered'&&!isAnswered)return false;
      if(filter==='unanswered'&&isAnswered)return false;
      if(filter==='low-confidence'&&(!answer||answer.confidence>=0.7))return false;
      if(searchTerm){
        const hay=(r.requirement+' '+(r.help_text||'')+' '+(answer?answer.answer:'')).toLowerCase();
        if(!hay.includes(searchTerm))return false;
      }
      return true;
    });
    if(!filtered.length)return;
    html+=`<h3 style="margin:16px 0 8px;color:var(--cyan)">${label} Requirements</h3>`;
    html+=filtered.map(r=>{
      const answer=ra[r.id];
      const isAnswered=!!answer;
      return `<div class="question-item">
        <div class="question-header">
          <div class="question-title">${esc(r.requirement)}</div>
          <div class="question-id">${esc(r.id)}</div>
        </div>
        <div class="question-meta">
          <span>Module: ${esc(r.module||sec)}</span>
          ${r.category?`<span>Category: ${esc(r.category)}</span>`:''}
          ${r.help_text?`<span>Help: ${esc(r.help_text)}</span>`:''}
        </div>
        <div class="answer-area ${isAnswered?'answered':'unanswered'}">
          <div class="answer-header">
            <span class="answer-status ${isAnswered?'status-answered':'status-unanswered'}">${isAnswered?'Addressed':'Not Addressed'}</span>
            ${isAnswered&&answer.confidence?`<span style="font-size:.8rem;color:var(--text3)">Confidence: ${Math.round(answer.confidence*100)}%</span>`:''}
          </div>
          <div class="answer-content">${isAnswered?esc(answer.answer):'Not addressed yet.'}</div>
          ${isAnswered&&answer.confidence?`<div class="confidence-bar"><div class="confidence-fill" style="width:${answer.confidence*100}%"></div></div>`:''}
        </div>
      </div>`;
    }).join('');
  });
  container.innerHTML=html||'<div class="empty-state"><h2>No matching requirements</h2></div>';
}

function exportData(){
  if(!data)return;
  const s=getStats();
  const qa=data.question_answers||{};
  const qb=data.question_bank||{};
  let report=`CRM Questionnaire Progress Report\n${'='.repeat(40)}\n\n`;
  report+=`Completion: ${s.answeredQ}/${s.totalQ} questions (${s.pctQ}%)\n`;
  report+=`Requirements: ${s.answeredR}/${s.totalR} addressed\n`;
  report+=`Avg Confidence: ${(s.avgConf*100).toFixed(0)}%\n\n`;
  s.sections.forEach(sec=>{
    const questions=qb[sec]||[];
    report+=`\n--- ${sec.toUpperCase()} ---\n`;
    questions.forEach(q=>{
      const a=qa[q.id];
      report+=`\n[${q.id}] ${q.question}\n`;
      if(a){report+=`  Answer: ${a.answer}\n  Confidence: ${Math.round(a.confidence*100)}%\n`}
      else{report+=`  Status: Unanswered\n`}
    });
  });
  const blob=new Blob([report],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='crm-questionnaire-report.txt';a.click();
  URL.revokeObjectURL(url);
}
window.exportData=exportData;

function esc(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):''}

init();
</script>
</body>
</html>
