<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Content Architect</title>
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="creative_tools">
<meta name="rappterzoo:tags" content="canvas,writing,planning,productivity,creative,audio">
<meta name="rappterzoo:type" content="interactive">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="2">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0e1113;color:#e0e0e0;font-family:'Segoe UI',system-ui,sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column}

/* Header */
.header{background:#161a1e;border-bottom:1px solid #2a2f35;padding:6px 16px;display:flex;align-items:center;gap:12px;z-index:100;flex-shrink:0}
.header h1{font-size:1.1rem;color:#00d2d3;white-space:nowrap}
.header .tabs{display:flex;gap:4px;margin-left:12px}
.tab{background:#1e2329;border:1px solid #2a2f35;color:#888;padding:4px 14px;border-radius:6px;cursor:pointer;font-size:0.8rem;transition:all 0.2s}
.tab:hover{border-color:#00d2d3;color:#00d2d3}
.tab.active{background:#00d2d320;border-color:#00d2d3;color:#00d2d3}
.header-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.header-btn{background:#1e2329;border:1px solid #2a2f35;color:#aaa;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:0.75rem;transition:all 0.2s}
.header-btn:hover{border-color:#00d2d3;color:#00d2d3}
.header-btn.primary{background:#00d2d3;color:#0e1113;border-color:#00d2d3;font-weight:600}
.header-btn.primary:hover{opacity:0.9}
.header-btn.danger{border-color:#ef4444;color:#ef4444}
.header-btn.danger:hover{background:#ef444420}

/* Main layout */
.main{flex:1;display:flex;min-height:0}

/* Sidebar */
.sidebar{width:260px;background:#141820;border-right:1px solid #2a2f35;display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.sidebar-header{padding:10px 12px;border-bottom:1px solid #2a2f35;display:flex;align-items:center;gap:8px}
.sidebar-header h3{font-size:0.85rem;color:#00d2d3;flex:1}
.sidebar-header .add-btn{background:#00d2d3;color:#0e1113;border:none;width:24px;height:24px;border-radius:4px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;font-weight:700}
.sidebar-header .add-btn:hover{opacity:0.8}
.item-list{flex:1;overflow-y:auto;padding:6px}
.item-card{background:#1e2329;border:1px solid #2a2f35;border-radius:8px;padding:10px;margin-bottom:6px;cursor:pointer;transition:all 0.2s}
.item-card:hover{border-color:#00d2d340}
.item-card.active{border-color:#00d2d3;background:#00d2d310}
.item-card .title{font-size:0.85rem;font-weight:600;margin-bottom:3px;color:#e0e0e0}
.item-card .meta{font-size:0.7rem;color:#666;display:flex;gap:8px;align-items:center}
.item-card .tag{background:#2a2f35;color:#888;padding:1px 6px;border-radius:3px;font-size:0.65rem}
.item-card .tag.high{background:#ef444430;color:#ef4444}
.item-card .tag.medium{background:#f7c94830;color:#f7c948}
.item-card .tag.low{background:#22c55e30;color:#22c55e}
.item-card .status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.item-card .status-dot.draft{background:#888}
.item-card .status-dot.progress{background:#f7c948}
.item-card .status-dot.review{background:#a855f7}
.item-card .status-dot.done{background:#22c55e}

/* Canvas area */
.canvas-area{flex:1;position:relative;overflow:hidden;background:#0a0c0e}
#boardCanvas{display:block;cursor:grab}
#boardCanvas:active{cursor:grabbing}

/* Editor panel */
.editor{width:360px;background:#141820;border-left:1px solid #2a2f35;display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.editor.hidden{display:none}
.editor-header{padding:10px 14px;border-bottom:1px solid #2a2f35;display:flex;align-items:center;gap:8px}
.editor-header h3{font-size:0.85rem;color:#00d2d3;flex:1}
.editor-close{background:none;border:none;color:#888;cursor:pointer;font-size:1.2rem;padding:2px 6px}
.editor-close:hover{color:#ef4444}
.editor-body{flex:1;overflow-y:auto;padding:14px}
.field{margin-bottom:14px}
.field label{display:block;font-size:0.75rem;color:#888;margin-bottom:4px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.field input,.field select,.field textarea{width:100%;background:#0e1113;border:1px solid #2a2f35;color:#e0e0e0;padding:8px 10px;border-radius:6px;font-size:0.85rem;font-family:inherit}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:#00d2d3}
.field textarea{min-height:120px;resize:vertical;line-height:1.6}
.field-row{display:flex;gap:8px}
.field-row .field{flex:1}

.tag-input{display:flex;flex-wrap:wrap;gap:4px;background:#0e1113;border:1px solid #2a2f35;border-radius:6px;padding:6px;min-height:36px}
.tag-input:focus-within{border-color:#00d2d3}
.tag-chip{background:#00d2d320;color:#00d2d3;padding:2px 8px;border-radius:4px;font-size:0.75rem;display:flex;align-items:center;gap:4px}
.tag-chip .rm{cursor:pointer;font-size:0.8rem;opacity:0.6}
.tag-chip .rm:hover{opacity:1}
.tag-input input{background:none;border:none;color:#e0e0e0;font-size:0.8rem;flex:1;min-width:60px;outline:none}

/* Word counter */
.word-count{font-size:0.7rem;color:#555;text-align:right;margin-top:2px}

/* Status badges */
.status-select{display:flex;gap:4px;flex-wrap:wrap}
.status-opt{padding:4px 12px;border-radius:4px;cursor:pointer;font-size:0.75rem;border:1px solid #2a2f35;color:#888;transition:all 0.2s}
.status-opt:hover{border-color:#00d2d3}
.status-opt.active{font-weight:600}
.status-opt.draft.active{background:#88888830;color:#888;border-color:#888}
.status-opt.progress.active{background:#f7c94830;color:#f7c948;border-color:#f7c948}
.status-opt.review.active{background:#a855f730;color:#a855f7;border-color:#a855f7}
.status-opt.done.active{background:#22c55e30;color:#22c55e;border-color:#22c55e}

/* Priority */
.priority-select{display:flex;gap:4px}
.priority-opt{padding:4px 12px;border-radius:4px;cursor:pointer;font-size:0.75rem;border:1px solid #2a2f35;color:#888;transition:all 0.2s}
.priority-opt:hover{border-color:#00d2d3}
.priority-opt.active{font-weight:600}
.priority-opt.high.active{background:#ef444430;color:#ef4444;border-color:#ef4444}
.priority-opt.medium.active{background:#f7c94830;color:#f7c948;border-color:#f7c948}
.priority-opt.low.active{background:#22c55e30;color:#22c55e;border-color:#22c55e}

/* Kanban view */
.kanban{flex:1;display:flex;gap:12px;padding:12px;overflow-x:auto;min-height:0}
.kanban-col{flex:0 0 280px;background:#141820;border:1px solid #2a2f35;border-radius:10px;display:flex;flex-direction:column;max-height:100%;overflow:hidden}
.kanban-col-header{padding:10px 12px;border-bottom:1px solid #2a2f35;display:flex;align-items:center;gap:8px}
.kanban-col-header .col-dot{width:10px;height:10px;border-radius:50%}
.kanban-col-header h4{font-size:0.85rem;color:#e0e0e0;flex:1}
.kanban-col-header .col-count{font-size:0.75rem;color:#555;background:#2a2f35;padding:1px 6px;border-radius:10px}
.kanban-col-body{flex:1;overflow-y:auto;padding:8px}
.kanban-card{background:#1e2329;border:1px solid #2a2f35;border-radius:8px;padding:10px;margin-bottom:6px;cursor:pointer;transition:all 0.2s}
.kanban-card:hover{border-color:#00d2d340;transform:translateY(-1px)}
.kanban-card .k-title{font-size:0.85rem;font-weight:600;margin-bottom:4px}
.kanban-card .k-desc{font-size:0.75rem;color:#888;margin-bottom:6px;max-height:40px;overflow:hidden}
.kanban-card .k-meta{display:flex;gap:6px;align-items:center;font-size:0.7rem;color:#555}

/* Timeline view */
.timeline{flex:1;padding:20px;overflow-y:auto}
.tl-month{margin-bottom:24px}
.tl-month-header{font-size:1rem;color:#00d2d3;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #2a2f35}
.tl-entry{display:flex;gap:12px;padding:8px 0;border-bottom:1px solid #1e2329}
.tl-date{width:80px;font-size:0.8rem;color:#555;flex-shrink:0}
.tl-content{flex:1}
.tl-content .tl-title{font-size:0.85rem;font-weight:600}
.tl-content .tl-desc{font-size:0.75rem;color:#888;margin-top:2px}

/* Stats bar */
.stats-bar{background:#161a1e;border-top:1px solid #2a2f35;padding:6px 16px;display:flex;gap:20px;align-items:center;font-size:0.75rem;color:#666;flex-shrink:0}
.stats-bar .stat-val{color:#00d2d3;font-weight:600}

/* Overlay */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity 0.2s}
.modal-overlay.active{opacity:1;pointer-events:all}
.modal{background:#161a1e;border:2px solid #2a2f35;border-radius:16px;padding:32px;max-width:500px;width:90%;text-align:center;transform:scale(0.95);transition:transform 0.3s}
.modal-overlay.active .modal{transform:scale(1)}
.modal h2{color:#00d2d3;margin-bottom:12px}
.modal p{color:#888;margin-bottom:16px}
.modal .btn{display:inline-block;padding:8px 20px;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600;margin:4px;border:none}
.modal .btn-primary{background:#00d2d3;color:#0e1113}
.modal .btn-cancel{background:#2a2f35;color:#aaa}

/* Toast notification */
.toast{position:fixed;bottom:20px;right:20px;background:#22c55e;color:#0e1113;padding:10px 20px;border-radius:8px;font-size:0.85rem;font-weight:600;z-index:300;transform:translateY(100px);opacity:0;transition:all 0.3s}
.toast.show{transform:translateY(0);opacity:1}

@media(max-width:900px){
  .sidebar{width:200px}
  .editor{width:300px}
}
@media(max-width:700px){
  .sidebar{display:none}
  .editor{position:fixed;left:0;right:0;bottom:0;top:50px;width:100%;z-index:150;border-left:none;border-top:1px solid #2a2f35}
}
</style>
</head>
<body>

<div class="header">
  <h1>Content Architect</h1>
  <div class="tabs">
    <div class="tab active" data-view="board" onclick="switchView('board')">Board</div>
    <div class="tab" data-view="kanban" onclick="switchView('kanban')">Kanban</div>
    <div class="tab" data-view="timeline" onclick="switchView('timeline')">Timeline</div>
  </div>
  <div class="header-right">
    <button class="header-btn" onclick="exportData()">Export JSON</button>
    <button class="header-btn" onclick="importData()">Import</button>
    <button class="header-btn primary" onclick="addItem()">+ New Item</button>
  </div>
</div>

<div class="main">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Content Items</h3>
      <button class="add-btn" onclick="addItem()">+</button>
    </div>
    <div class="item-list" id="itemList"></div>
  </div>

  <!-- Canvas board view -->
  <div class="canvas-area" id="boardView">
    <canvas id="boardCanvas"></canvas>
  </div>

  <!-- Kanban view -->
  <div class="kanban" id="kanbanView" style="display:none"></div>

  <!-- Timeline view -->
  <div class="timeline" id="timelineView" style="display:none"></div>

  <!-- Editor -->
  <div class="editor hidden" id="editor">
    <div class="editor-header">
      <h3>Edit Item</h3>
      <button class="editor-close" onclick="closeEditor()">&times;</button>
    </div>
    <div class="editor-body">
      <div class="field">
        <label>Title</label>
        <input type="text" id="edTitle" placeholder="Content title..." oninput="saveField('title',this.value)">
      </div>
      <div class="field">
        <label>Status</label>
        <div class="status-select" id="edStatus">
          <div class="status-opt draft" data-status="draft" onclick="setStatus('draft')">Draft</div>
          <div class="status-opt progress" data-status="progress" onclick="setStatus('progress')">In Progress</div>
          <div class="status-opt review" data-status="review" onclick="setStatus('review')">Review</div>
          <div class="status-opt done" data-status="done" onclick="setStatus('done')">Done</div>
        </div>
      </div>
      <div class="field">
        <label>Priority</label>
        <div class="priority-select" id="edPriority">
          <div class="priority-opt high" data-priority="high" onclick="setPriority('high')">High</div>
          <div class="priority-opt medium" data-priority="medium" onclick="setPriority('medium')">Medium</div>
          <div class="priority-opt low" data-priority="low" onclick="setPriority('low')">Low</div>
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Type</label>
          <select id="edType" onchange="saveField('type',this.value)">
            <option value="article">Article</option>
            <option value="blog">Blog Post</option>
            <option value="guide">Guide</option>
            <option value="tutorial">Tutorial</option>
            <option value="review">Review</option>
            <option value="newsletter">Newsletter</option>
            <option value="social">Social Post</option>
            <option value="video">Video Script</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="field">
          <label>Due Date</label>
          <input type="date" id="edDue" onchange="saveField('due',this.value)">
        </div>
      </div>
      <div class="field">
        <label>Description</label>
        <textarea id="edDesc" placeholder="Brief description or outline..." oninput="saveField('description',this.value)"></textarea>
      </div>
      <div class="field">
        <label>Content</label>
        <textarea id="edContent" placeholder="Write your content here..." style="min-height:200px" oninput="saveField('content',this.value);updateWordCount()"></textarea>
        <div class="word-count" id="wordCount">0 words | 0 chars</div>
      </div>
      <div class="field">
        <label>Tags</label>
        <div class="tag-input" id="tagInput" onclick="document.getElementById('tagField').focus()">
          <input type="text" id="tagField" placeholder="Add tag..." onkeydown="handleTagKey(event)">
        </div>
      </div>
      <div class="field">
        <label>Notes</label>
        <textarea id="edNotes" placeholder="Internal notes, research links..." style="min-height:80px" oninput="saveField('notes',this.value)"></textarea>
      </div>
      <div style="margin-top:16px;padding-top:12px;border-top:1px solid #2a2f35">
        <button class="header-btn danger" onclick="confirmDelete()" style="width:100%;text-align:center;padding:8px">Delete Item</button>
      </div>
    </div>
  </div>
</div>

<div class="stats-bar" id="statsBar">
  <span>Items: <span class="stat-val" id="statTotal">0</span></span>
  <span>Draft: <span class="stat-val" id="statDraft">0</span></span>
  <span>In Progress: <span class="stat-val" id="statProgress">0</span></span>
  <span>Review: <span class="stat-val" id="statReview">0</span></span>
  <span>Done: <span class="stat-val" id="statDone">0</span></span>
  <span>Words: <span class="stat-val" id="statWords">0</span></span>
</div>

<div class="modal-overlay" id="deleteModal">
  <div class="modal">
    <h2>Delete Item?</h2>
    <p>This action cannot be undone.</p>
    <button class="btn btn-cancel" onclick="cancelDelete()">Cancel</button>
    <button class="btn btn-primary" style="background:#ef4444" onclick="deleteItem()">Delete</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">

<script>
// ===== AUDIO ENGINE =====
class Audio2 {
  constructor(){ this.ctx=null; }
  init(){
    if(this.ctx)return;
    this.ctx=new(window.AudioContext||window.webkitAudioContext)();
  }
  play(type,freq,dur,vol){
    if(!this.ctx)return;
    const o=this.ctx.createOscillator(),g=this.ctx.createGain();
    o.type=type;o.frequency.value=freq;
    g.gain.value=vol||0.15;
    g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+dur);
    o.connect(g);g.connect(this.ctx.destination);
    o.start();o.stop(this.ctx.currentTime+dur);
  }
  click(){ this.play('sine',800,0.04,0.1); }
  add(){ this.play('sine',523,0.08,0.15);setTimeout(()=>this.play('sine',659,0.1,0.15),70); }
  del(){ this.play('square',200,0.15,0.1); }
  save(){ this.play('sine',660,0.05,0.1);setTimeout(()=>this.play('sine',880,0.08,0.12),50); }
  done(){ [523,659,784].forEach((f,i)=>setTimeout(()=>this.play('sine',f,0.1,0.12),i*80)); }
}
const sfx=new Audio2();

// ===== DATA =====
let items=[];
let selectedId=null;
let currentView='board';
let boardCamera={x:0,y:0,zoom:1};
let dragState={dragging:false,item:null,offsetX:0,offsetY:0};
let panState={panning:false,startX:0,startY:0,startCamX:0,startCamY:0};
let nextId=1;

const STATUS_COLORS={draft:'#888',progress:'#f7c948',review:'#a855f7',done:'#22c55e'};
const PRIORITY_COLORS={high:'#ef4444',medium:'#f7c948',low:'#22c55e'};
const TYPE_ICONS={article:'A',blog:'B',guide:'G',tutorial:'T',review:'R',newsletter:'N',social:'S',video:'V',other:'?'};

function generateId(){ return nextId++; }

function createItem(overrides){
  const item={
    id:generateId(),
    title:'Untitled',
    description:'',
    content:'',
    notes:'',
    status:'draft',
    priority:'medium',
    type:'article',
    tags:[],
    due:'',
    created:new Date().toISOString().split('T')[0],
    boardX:400+Math.random()*200-100,
    boardY:300+Math.random()*200-100,
    ...overrides
  };
  items.push(item);
  return item;
}

// ===== PERSISTENCE =====
function saveAll(){
  localStorage.setItem('contentArchitect',JSON.stringify({items,nextId,boardCamera}));
}

function loadAll(){
  try{
    const d=JSON.parse(localStorage.getItem('contentArchitect'));
    if(d){
      items=d.items||[];
      nextId=d.nextId||1;
      boardCamera=d.boardCamera||{x:0,y:0,zoom:1};
    }
  }catch{}
  if(items.length===0){
    // Create sample items
    createItem({title:'Getting Started Guide',description:'Write an onboarding guide for new users',status:'progress',priority:'high',type:'guide',tags:['onboarding','docs'],boardX:200,boardY:150});
    createItem({title:'Product Launch Blog Post',description:'Announce new features',status:'draft',priority:'high',type:'blog',tags:['launch','marketing'],boardX:500,boardY:150});
    createItem({title:'Weekly Newsletter #12',description:'Curate this week\'s top stories',status:'review',priority:'medium',type:'newsletter',tags:['weekly','curation'],boardX:200,boardY:350});
    createItem({title:'Tutorial: Advanced Search',description:'Step-by-step advanced search techniques',status:'done',priority:'low',type:'tutorial',tags:['tutorial','search'],boardX:500,boardY:350});
    createItem({title:'Social Media Campaign',description:'Plan posts for the week',status:'draft',priority:'medium',type:'social',tags:['social','campaign'],boardX:350,boardY:250});
  }
}

function exportData(){
  sfx.init();sfx.save();
  const blob=new Blob([JSON.stringify({items,exportedAt:new Date().toISOString()},null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='content-architect-'+new Date().toISOString().split('T')[0]+'.json';
  a.click();
  showToast('Exported '+items.length+' items');
}

function importData(){
  document.getElementById('importFile').click();
}

function handleImport(e){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const d=JSON.parse(ev.target.result);
      if(d.items){
        items=d.items;
        nextId=Math.max(...items.map(i=>i.id),0)+1;
        saveAll();
        renderAll();
        showToast('Imported '+items.length+' items');
        sfx.init();sfx.add();
      }
    }catch{showToast('Invalid JSON file');}
  };
  reader.readAsText(file);
  e.target.value='';
}

// ===== VIEWS =====
function switchView(view){
  sfx.init();sfx.click();
  currentView=view;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.view===view));
  document.getElementById('boardView').style.display=view==='board'?'':'none';
  document.getElementById('kanbanView').style.display=view==='kanban'?'flex':'none';
  document.getElementById('timelineView').style.display=view==='timeline'?'':'none';
  if(view==='kanban')renderKanban();
  if(view==='timeline')renderTimeline();
  if(view==='board')drawBoard();
}

// ===== SIDEBAR =====
function renderSidebar(){
  const list=document.getElementById('itemList');
  const sorted=[...items].sort((a,b)=>{
    const pri={high:0,medium:1,low:2};
    const st={progress:0,draft:1,review:2,done:3};
    return (st[a.status]||0)-(st[b.status]||0) || (pri[a.priority]||1)-(pri[b.priority]||1);
  });
  list.innerHTML=sorted.map(item=>`
    <div class="item-card ${item.id===selectedId?'active':''}" onclick="selectItem(${item.id})" ondblclick="openEditor(${item.id})">
      <div style="display:flex;align-items:center;gap:6px">
        <div class="status-dot ${item.status}"></div>
        <div class="title">${escapeHtml(item.title)}</div>
      </div>
      <div class="meta">
        <span class="tag ${item.priority}">${item.priority}</span>
        <span class="tag">${item.type}</span>
        ${item.due?'<span style="color:#555">'+item.due+'</span>':''}
      </div>
    </div>
  `).join('');
}

// ===== BOARD CANVAS =====
const canvas=document.getElementById('boardCanvas');
const ctx=canvas.getContext('2d');
let W,H;

function resizeCanvas(){
  const area=document.getElementById('boardView');
  W=canvas.width=area.clientWidth;
  H=canvas.height=area.clientHeight;
  drawBoard();
}

function screenToBoard(sx,sy){
  return{
    x:(sx-W/2)/boardCamera.zoom+boardCamera.x,
    y:(sy-H/2)/boardCamera.zoom+boardCamera.y
  };
}

function boardToScreen(bx,by){
  return{
    x:(bx-boardCamera.x)*boardCamera.zoom+W/2,
    y:(by-boardCamera.y)*boardCamera.zoom+H/2
  };
}

function drawBoard(){
  if(currentView!=='board')return;
  ctx.clearRect(0,0,W,H);

  // Grid
  const gridSize=50*boardCamera.zoom;
  const offX=(W/2-boardCamera.x*boardCamera.zoom)%gridSize;
  const offY=(H/2-boardCamera.y*boardCamera.zoom)%gridSize;
  ctx.strokeStyle='#1a1d22';
  ctx.lineWidth=1;
  for(let x=offX;x<W;x+=gridSize){
    ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();
  }
  for(let y=offY;y<H;y+=gridSize){
    ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();
  }

  // Draw connections between items with same tags
  ctx.lineWidth=1;
  for(let i=0;i<items.length;i++){
    for(let j=i+1;j<items.length;j++){
      const shared=items[i].tags.filter(t=>items[j].tags.includes(t));
      if(shared.length>0){
        const a=boardToScreen(items[i].boardX+100,items[i].boardY+40);
        const b=boardToScreen(items[j].boardX+100,items[j].boardY+40);
        ctx.strokeStyle='#2a2f3540';
        ctx.setLineDash([4,4]);
        ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();
        ctx.setLineDash([]);
      }
    }
  }

  // Draw items
  items.forEach(item=>{
    const s=boardToScreen(item.boardX,item.boardY);
    const w=200*boardCamera.zoom;
    const h=80*boardCamera.zoom;

    // Card shadow
    ctx.fillStyle='rgba(0,0,0,0.3)';
    ctx.beginPath();
    roundRect(ctx,s.x+3,s.y+3,w,h,8*boardCamera.zoom);
    ctx.fill();

    // Card bg
    ctx.fillStyle=item.id===selectedId?'#1e2d35':'#1e2329';
    ctx.strokeStyle=item.id===selectedId?'#00d2d3':'#2a2f35';
    ctx.lineWidth=item.id===selectedId?2:1;
    ctx.beginPath();
    roundRect(ctx,s.x,s.y,w,h,8*boardCamera.zoom);
    ctx.fill();ctx.stroke();

    // Status bar
    ctx.fillStyle=STATUS_COLORS[item.status]||'#888';
    ctx.fillRect(s.x,s.y,4*boardCamera.zoom,h);

    // Type icon
    const iconSize=20*boardCamera.zoom;
    ctx.fillStyle='#2a2f35';
    ctx.fillRect(s.x+10*boardCamera.zoom,s.y+10*boardCamera.zoom,iconSize,iconSize);
    ctx.fillStyle='#00d2d3';
    ctx.font=`bold ${12*boardCamera.zoom}px system-ui`;
    ctx.textAlign='center';
    ctx.fillText(TYPE_ICONS[item.type]||'?',s.x+10*boardCamera.zoom+iconSize/2,s.y+10*boardCamera.zoom+iconSize*0.72);

    // Title
    ctx.fillStyle='#e0e0e0';
    ctx.font=`600 ${12*boardCamera.zoom}px system-ui`;
    ctx.textAlign='left';
    const titleText=item.title.length>22?item.title.substring(0,22)+'...':item.title;
    ctx.fillText(titleText,s.x+36*boardCamera.zoom,s.y+24*boardCamera.zoom);

    // Description preview
    ctx.fillStyle='#666';
    ctx.font=`${10*boardCamera.zoom}px system-ui`;
    const descText=item.description?item.description.substring(0,35)+(item.description.length>35?'...':''):'No description';
    ctx.fillText(descText,s.x+10*boardCamera.zoom,s.y+48*boardCamera.zoom);

    // Priority badge
    ctx.fillStyle=PRIORITY_COLORS[item.priority]||'#888';
    ctx.font=`bold ${9*boardCamera.zoom}px system-ui`;
    ctx.fillText(item.priority.toUpperCase(),s.x+10*boardCamera.zoom,s.y+68*boardCamera.zoom);

    // Due date
    if(item.due){
      ctx.fillStyle='#555';
      ctx.font=`${9*boardCamera.zoom}px system-ui`;
      ctx.textAlign='right';
      ctx.fillText(item.due,s.x+w-10*boardCamera.zoom,s.y+68*boardCamera.zoom);
    }
  });

  ctx.textAlign='left';
}

function roundRect(ctx,x,y,w,h,r){
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);
}

function hitTestBoard(mx,my){
  const bp=screenToBoard(mx,my);
  for(let i=items.length-1;i>=0;i--){
    const item=items[i];
    if(bp.x>=item.boardX && bp.x<=item.boardX+200 &&
       bp.y>=item.boardY && bp.y<=item.boardY+80){
      return item;
    }
  }
  return null;
}

// Board mouse/touch events
canvas.addEventListener('mousedown',e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  const hit=hitTestBoard(mx,my);

  if(hit){
    sfx.init();sfx.click();
    selectItem(hit.id);
    const bp=screenToBoard(mx,my);
    dragState={dragging:true,item:hit,offsetX:bp.x-hit.boardX,offsetY:bp.y-hit.boardY};
  } else {
    panState={panning:true,startX:e.clientX,startY:e.clientY,startCamX:boardCamera.x,startCamY:boardCamera.y};
  }
});

canvas.addEventListener('mousemove',e=>{
  if(dragState.dragging){
    const rect=canvas.getBoundingClientRect();
    const bp=screenToBoard(e.clientX-rect.left,e.clientY-rect.top);
    dragState.item.boardX=bp.x-dragState.offsetX;
    dragState.item.boardY=bp.y-dragState.offsetY;
    drawBoard();
  }
  if(panState.panning){
    const dx=(e.clientX-panState.startX)/boardCamera.zoom;
    const dy=(e.clientY-panState.startY)/boardCamera.zoom;
    boardCamera.x=panState.startCamX-dx;
    boardCamera.y=panState.startCamY-dy;
    drawBoard();
  }
});

canvas.addEventListener('mouseup',()=>{
  if(dragState.dragging){saveAll();}
  dragState={dragging:false,item:null,offsetX:0,offsetY:0};
  panState={panning:false,startX:0,startY:0,startCamX:0,startCamY:0};
});

canvas.addEventListener('dblclick',e=>{
  const rect=canvas.getBoundingClientRect();
  const hit=hitTestBoard(e.clientX-rect.left,e.clientY-rect.top);
  if(hit){openEditor(hit.id);}
});

canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  const delta=e.deltaY>0?0.9:1.1;
  boardCamera.zoom=Math.max(0.3,Math.min(3,boardCamera.zoom*delta));
  drawBoard();
  saveAll();
},{passive:false});

// Touch support for board
let touchStartDist=0;
canvas.addEventListener('touchstart',e=>{
  if(e.touches.length===1){
    const t=e.touches[0];
    const rect=canvas.getBoundingClientRect();
    const mx=t.clientX-rect.left,my=t.clientY-rect.top;
    const hit=hitTestBoard(mx,my);
    if(hit){
      sfx.init();sfx.click();
      selectItem(hit.id);
      const bp=screenToBoard(mx,my);
      dragState={dragging:true,item:hit,offsetX:bp.x-hit.boardX,offsetY:bp.y-hit.boardY};
    } else {
      panState={panning:true,startX:t.clientX,startY:t.clientY,startCamX:boardCamera.x,startCamY:boardCamera.y};
    }
  }
  if(e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    touchStartDist=Math.sqrt(dx*dx+dy*dy);
  }
  e.preventDefault();
},{passive:false});

canvas.addEventListener('touchmove',e=>{
  if(e.touches.length===1){
    const t=e.touches[0];
    if(dragState.dragging){
      const rect=canvas.getBoundingClientRect();
      const bp=screenToBoard(t.clientX-rect.left,t.clientY-rect.top);
      dragState.item.boardX=bp.x-dragState.offsetX;
      dragState.item.boardY=bp.y-dragState.offsetY;
      drawBoard();
    }
    if(panState.panning){
      const dx=(t.clientX-panState.startX)/boardCamera.zoom;
      const dy=(t.clientY-panState.startY)/boardCamera.zoom;
      boardCamera.x=panState.startCamX-dx;
      boardCamera.y=panState.startCamY-dy;
      drawBoard();
    }
  }
  if(e.touches.length===2&&touchStartDist>0){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const scale=dist/touchStartDist;
    boardCamera.zoom=Math.max(0.3,Math.min(3,boardCamera.zoom*scale));
    touchStartDist=dist;
    drawBoard();
  }
  e.preventDefault();
},{passive:false});

canvas.addEventListener('touchend',()=>{
  if(dragState.dragging)saveAll();
  dragState={dragging:false,item:null,offsetX:0,offsetY:0};
  panState={panning:false,startX:0,startY:0,startCamX:0,startCamY:0};
  touchStartDist=0;
});

// ===== KANBAN =====
function renderKanban(){
  const statuses=['draft','progress','review','done'];
  const labels={draft:'Draft',progress:'In Progress',review:'Review',done:'Done'};
  const kanban=document.getElementById('kanbanView');
  kanban.innerHTML=statuses.map(st=>{
    const colItems=items.filter(i=>i.status===st);
    return `<div class="kanban-col">
      <div class="kanban-col-header">
        <div class="col-dot" style="background:${STATUS_COLORS[st]}"></div>
        <h4>${labels[st]}</h4>
        <span class="col-count">${colItems.length}</span>
      </div>
      <div class="kanban-col-body">
        ${colItems.map(item=>`
          <div class="kanban-card" onclick="selectItem(${item.id});openEditor(${item.id})">
            <div class="k-title">${escapeHtml(item.title)}</div>
            <div class="k-desc">${escapeHtml(item.description||'')}</div>
            <div class="k-meta">
              <span class="tag ${item.priority}">${item.priority}</span>
              <span>${item.type}</span>
              ${item.due?'<span>'+item.due+'</span>':''}
            </div>
          </div>
        `).join('')}
      </div>
    </div>`;
  }).join('');
}

// ===== TIMELINE =====
function renderTimeline(){
  const tl=document.getElementById('timelineView');
  const sorted=[...items].sort((a,b)=>(a.due||a.created).localeCompare(b.due||b.created));

  // Group by month
  const months={};
  sorted.forEach(item=>{
    const date=item.due||item.created;
    const month=date.substring(0,7);
    if(!months[month])months[month]=[];
    months[month].push(item);
  });

  tl.innerHTML=Object.entries(months).map(([month,mitems])=>`
    <div class="tl-month">
      <div class="tl-month-header">${month}</div>
      ${mitems.map(item=>`
        <div class="tl-entry" onclick="selectItem(${item.id});openEditor(${item.id})" style="cursor:pointer">
          <div class="tl-date">${(item.due||item.created).substring(5)}</div>
          <div class="tl-content">
            <div class="tl-title" style="display:flex;align-items:center;gap:6px">
              <div class="status-dot ${item.status}" style="width:8px;height:8px;border-radius:50%;flex-shrink:0;background:${STATUS_COLORS[item.status]}"></div>
              ${escapeHtml(item.title)}
            </div>
            <div class="tl-desc">${escapeHtml(item.description||'')}</div>
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

// ===== EDITOR =====
function openEditor(id){
  sfx.init();sfx.click();
  selectedId=id;
  const item=items.find(i=>i.id===id);
  if(!item)return;

  document.getElementById('editor').classList.remove('hidden');
  document.getElementById('edTitle').value=item.title;
  document.getElementById('edDesc').value=item.description;
  document.getElementById('edContent').value=item.content||'';
  document.getElementById('edNotes').value=item.notes||'';
  document.getElementById('edType').value=item.type;
  document.getElementById('edDue').value=item.due||'';

  // Status
  document.querySelectorAll('#edStatus .status-opt').forEach(o=>o.classList.toggle('active',o.dataset.status===item.status));
  // Priority
  document.querySelectorAll('#edPriority .priority-opt').forEach(o=>o.classList.toggle('active',o.dataset.priority===item.priority));
  // Tags
  renderTags(item);
  updateWordCount();
  renderSidebar();
}

function closeEditor(){
  document.getElementById('editor').classList.add('hidden');
}

function saveField(field,value){
  if(!selectedId)return;
  const item=items.find(i=>i.id===selectedId);
  if(!item)return;
  item[field]=value;
  saveAll();
  renderSidebar();
  if(currentView==='board')drawBoard();
  if(currentView==='kanban')renderKanban();
  if(currentView==='timeline')renderTimeline();
}

function setStatus(st){
  sfx.init();
  if(st==='done')sfx.done();else sfx.click();
  saveField('status',st);
  document.querySelectorAll('#edStatus .status-opt').forEach(o=>o.classList.toggle('active',o.dataset.status===st));
  updateStats();
}

function setPriority(p){
  sfx.init();sfx.click();
  saveField('priority',p);
  document.querySelectorAll('#edPriority .priority-opt').forEach(o=>o.classList.toggle('active',o.dataset.priority===p));
}

function updateWordCount(){
  const content=document.getElementById('edContent').value;
  const words=content.trim()?content.trim().split(/\s+/).length:0;
  const chars=content.length;
  document.getElementById('wordCount').textContent=words+' words | '+chars+' chars';
}

// Tags
function renderTags(item){
  const container=document.getElementById('tagInput');
  const input=document.getElementById('tagField');
  container.innerHTML='';
  (item.tags||[]).forEach(tag=>{
    const chip=document.createElement('div');
    chip.className='tag-chip';
    chip.innerHTML=escapeHtml(tag)+'<span class="rm" onclick="removeTag(\''+escapeHtml(tag)+'\')">&times;</span>';
    container.appendChild(chip);
  });
  container.appendChild(input);
}

function handleTagKey(e){
  if(e.key==='Enter'||e.key===','){
    e.preventDefault();
    const val=e.target.value.trim().replace(',','');
    if(!val)return;
    const item=items.find(i=>i.id===selectedId);
    if(!item)return;
    if(!item.tags)item.tags=[];
    if(!item.tags.includes(val)){
      item.tags.push(val);
      saveAll();
      renderTags(item);
      sfx.init();sfx.click();
    }
    e.target.value='';
  }
}

function removeTag(tag){
  const item=items.find(i=>i.id===selectedId);
  if(!item||!item.tags)return;
  item.tags=item.tags.filter(t=>t!==tag);
  saveAll();
  renderTags(item);
}

// ===== ITEM OPERATIONS =====
function addItem(){
  sfx.init();sfx.add();
  const bp=screenToBoard(W/2,H/2);
  const item=createItem({
    boardX:bp.x-100+Math.random()*50,
    boardY:bp.y-40+Math.random()*50
  });
  saveAll();
  selectItem(item.id);
  openEditor(item.id);
  renderAll();
}

function selectItem(id){
  selectedId=id;
  renderSidebar();
  drawBoard();
}

function confirmDelete(){
  document.getElementById('deleteModal').classList.add('active');
}

function cancelDelete(){
  document.getElementById('deleteModal').classList.remove('active');
}

function deleteItem(){
  sfx.init();sfx.del();
  items=items.filter(i=>i.id!==selectedId);
  selectedId=null;
  closeEditor();
  document.getElementById('deleteModal').classList.remove('active');
  saveAll();
  renderAll();
  showToast('Item deleted');
}

// ===== STATS =====
function updateStats(){
  document.getElementById('statTotal').textContent=items.length;
  document.getElementById('statDraft').textContent=items.filter(i=>i.status==='draft').length;
  document.getElementById('statProgress').textContent=items.filter(i=>i.status==='progress').length;
  document.getElementById('statReview').textContent=items.filter(i=>i.status==='review').length;
  document.getElementById('statDone').textContent=items.filter(i=>i.status==='done').length;
  const totalWords=items.reduce((sum,i)=>{
    const c=(i.content||'').trim();
    return sum+(c?c.split(/\s+/).length:0);
  },0);
  document.getElementById('statWords').textContent=totalWords.toLocaleString();
}

// ===== UTILITIES =====
function escapeHtml(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2000);
}

function renderAll(){
  renderSidebar();
  updateStats();
  if(currentView==='board')drawBoard();
  if(currentView==='kanban')renderKanban();
  if(currentView==='timeline')renderTimeline();
}

// ===== KEYBOARD =====
window.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    if(!document.getElementById('editor').classList.contains('hidden')){
      closeEditor();
    }
  }
  if(e.key==='n'&&(e.ctrlKey||e.metaKey)){
    e.preventDefault();
    addItem();
  }
  if(e.key==='Delete'&&selectedId&&document.activeElement.tagName!=='INPUT'&&document.activeElement.tagName!=='TEXTAREA'){
    confirmDelete();
  }
});

// ===== INIT =====
loadAll();
window.addEventListener('resize',resizeCanvas);
resizeCanvas();
renderAll();
</script>
</body>
</html>
