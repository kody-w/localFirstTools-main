<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Palette Generator</title>
    <meta name="rappterzoo:author" content="Claude Sonnet 4.5">
    <meta name="rappterzoo:author-type" content="agent">
    <meta name="rappterzoo:category" content="creative-tools">
    <meta name="rappterzoo:tags" content="canvas,interactive,design,utility">
    <meta name="rappterzoo:type" content="interface">
    <meta name="rappterzoo:complexity" content="advanced">
    <meta name="rappterzoo:created" content="2026-02-07">
    <meta name="rappterzoo:generation" content="1">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #667eea;
        }

        .color-wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 24px;
        }

        #colorWheel {
            border-radius: 50%;
            cursor: crosshair;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        #colorWheel:hover {
            transform: scale(1.02);
        }

        .color-indicator {
            position: absolute;
            width: 24px;
            height: 24px;
            border: 3px solid white;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translate(-50%, -50%);
        }

        .harmony-selector {
            margin-bottom: 20px;
        }

        .harmony-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .harmony-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .harmony-selector select:hover {
            border-color: #667eea;
        }

        .harmony-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .palette-display {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .color-swatch {
            aspect-ratio: 1;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .color-swatch:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }

        .color-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 12px 8px;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
        }

        .color-swatch:hover .color-info {
            opacity: 1;
        }

        .lock-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .lock-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .lock-btn.locked {
            background: #667eea;
            color: white;
        }

        .contrast-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .contrast-card {
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            font-weight: 600;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .contrast-card:hover {
            transform: scale(1.02);
        }

        .wcag-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.9);
        }

        .wcag-aaa {
            color: #10b981;
        }

        .wcag-aa {
            color: #f59e0b;
        }

        .wcag-fail {
            color: #ef4444;
        }

        .contrast-ratio {
            font-size: 0.85rem;
            margin-top: 8px;
            opacity: 0.9;
        }

        .export-section {
            margin-top: 24px;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .export-btn {
            padding: 10px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .export-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .history-section {
            margin-top: 24px;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
        }

        .history-item {
            display: flex;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .history-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .history-color {
            flex: 1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
            font-weight: 600;
            color: #10b981;
        }

        .notification.show {
            transform: translateX(0);
        }

        .color-values {
            font-size: 0.75rem;
            line-height: 1.4;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .palette-display {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }

            h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 640px) {
            .export-buttons {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .palette-display {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar-custom::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .harmony-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #666;
            line-height: 1.6;
        }

        .mode-switcher {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 12px 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
        }

        .challenge-panel {
            display: none;
        }

        .challenge-panel.active {
            display: block;
        }

        .browse-panel.active {
            display: block;
        }

        .challenge-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .challenge-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .target-palette {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .target-palette h3 {
            margin-bottom: 16px;
            color: #667eea;
        }

        .difficulty-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .difficulty-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .difficulty-btn.easy {
            border-color: #10b981;
            color: #10b981;
        }

        .difficulty-btn.medium {
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .difficulty-btn.hard {
            border-color: #ef4444;
            color: #ef4444;
        }

        .difficulty-btn.active {
            color: white;
        }

        .difficulty-btn.easy.active {
            background: #10b981;
        }

        .difficulty-btn.medium.active {
            background: #f59e0b;
        }

        .difficulty-btn.hard.active {
            background: #ef4444;
        }

        .instructions-panel {
            background: #f0f7ff;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .instructions-panel h3 {
            color: #667eea;
            margin-bottom: 12px;
        }

        .instructions-panel ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .instructions-panel li {
            margin-bottom: 8px;
        }

        .keyboard-shortcuts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .shortcut {
            display: flex;
            justify-content: space-between;
            padding: 6px 12px;
            background: white;
            border-radius: 6px;
        }

        .key {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: 600;
        }

        .glow {
            filter: drop-shadow(0 0 10px rgba(102, 126, 234, 0.6));
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .streak-display {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .streak-display.active {
            animation: streak-pulse 0.5s ease-in-out;
        }

        @keyframes streak-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .results-panel {
            display: none;
            text-align: center;
        }

        .results-panel.active {
            display: block;
        }

        .results-title {
            font-size: 2.5rem;
            margin-bottom: 24px;
            color: #667eea;
        }

        .final-score {
            font-size: 4rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 16px;
        }

        .score-breakdown {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .score-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .score-breakdown-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Color Palette Generator</h1>
            <p class="subtitle">Create beautiful color harmonies with professional design tools</p>
            <div class="mode-switcher">
                <button class="mode-btn active" id="browseModeBtn" role="tab" aria-selected="true" tabindex="0">Browse Mode</button>
                <button class="mode-btn" id="challengeModeBtn" role="tab" aria-selected="false" tabindex="0">Challenge Mode</button>
            </div>
        </header>

        <!-- Browse Mode Panel -->
        <div class="main-grid browse-panel active" id="browsePanel" role="tabpanel">
            <!-- Left Panel: Color Wheel & Controls -->
            <div class="card">
                <h2>Color Wheel</h2>
                <div class="color-wheel-container">
                    <canvas id="colorWheel" width="300" height="300" aria-label="Interactive color wheel for selecting colors"></canvas>
                    <div class="color-indicator" id="indicator"></div>
                </div>

                <div class="harmony-selector">
                    <label for="harmonyMode">Harmony Mode</label>
                    <select id="harmonyMode" aria-label="Select color harmony mode">
                        <option value="complementary">Complementary</option>
                        <option value="analogous">Analogous</option>
                        <option value="triadic">Triadic</option>
                        <option value="split-complementary">Split-Complementary</option>
                        <option value="tetradic">Tetradic</option>
                        <option value="monochromatic">Monochromatic</option>
                    </select>
                    <div class="harmony-info" id="harmonyInfo"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="generateBtn" aria-label="Generate new palette">Generate Palette</button>
                    <button class="btn btn-secondary" id="randomBtn" aria-label="Generate random colors">Random Colors</button>
                </div>
            </div>

            <!-- Right Panel: Palette Display -->
            <div class="card">
                <h2>Current Palette</h2>
                <div class="palette-display" id="paletteDisplay" role="list" aria-label="Current color palette"></div>

                <h2 style="margin-top: 24px;">Contrast Preview</h2>
                <div class="contrast-preview" id="contrastPreview" role="list" aria-label="Contrast preview samples"></div>

                <div class="export-section">
                    <h2>Export Palette</h2>
                    <div class="export-buttons">
                        <button class="export-btn" id="exportCSS" aria-label="Export as CSS variables">CSS Variables</button>
                        <button class="export-btn" id="exportJSON" aria-label="Export as JSON">JSON</button>
                        <button class="export-btn" id="exportTailwind" aria-label="Export as Tailwind config">Tailwind Config</button>
                    </div>
                </div>

                <div class="history-section">
                    <h2>Palette History</h2>
                    <div class="history-grid scrollbar-custom" id="historyGrid" role="list" aria-label="Palette history"></div>
                </div>
            </div>
        </div>

        <!-- Challenge Mode Panel -->
        <div class="challenge-panel" id="challengePanel" role="tabpanel">
            <div class="card">
                <div class="instructions-panel" id="instructionsPanel">
                    <h3>How to Play</h3>
                    <p>Match the target palette by adjusting your colors to score points!</p>
                    <ul>
                        <li><strong>Easy:</strong> Match 3 colors within 20% tolerance</li>
                        <li><strong>Medium:</strong> Match 4 colors within 15% tolerance</li>
                        <li><strong>Hard:</strong> Match 5 colors within 10% tolerance</li>
                    </ul>
                    <p><strong>Streak Bonus:</strong> Get consecutive matches for combo points!</p>
                    <div class="keyboard-shortcuts">
                        <div class="shortcut"><span>Adjust Hue</span><span class="key">← →</span></div>
                        <div class="shortcut"><span>Adjust Saturation</span><span class="key">↑ ↓</span></div>
                        <div class="shortcut"><span>Submit Match</span><span class="key">Enter</span></div>
                        <div class="shortcut"><span>Reset</span><span class="key">Escape</span></div>
                    </div>
                </div>

                <div class="difficulty-selector">
                    <button class="difficulty-btn easy active" data-difficulty="easy" aria-label="Easy difficulty">Easy</button>
                    <button class="difficulty-btn medium" data-difficulty="medium" aria-label="Medium difficulty">Medium</button>
                    <button class="difficulty-btn hard" data-difficulty="hard" aria-label="Hard difficulty">Hard</button>
                </div>

                <div class="challenge-stats">
                    <div class="stat-box">
                        <div class="stat-label">Score</div>
                        <div class="stat-value" id="scoreDisplay">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Level</div>
                        <div class="stat-value" id="levelDisplay">1</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Streak</div>
                        <div class="stat-value" id="streakDisplay">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">High Score</div>
                        <div class="stat-value" id="highScoreDisplay">0</div>
                    </div>
                </div>

                <div class="target-palette">
                    <h3>Target Palette</h3>
                    <div class="palette-display" id="targetPaletteDisplay" role="list" aria-label="Target palette to match"></div>
                </div>

                <h3>Your Palette</h3>
                <div class="palette-display" id="challengePaletteDisplay" role="list" aria-label="Your current palette attempt"></div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="submitMatchBtn" aria-label="Submit your palette match">Submit Match</button>
                    <button class="btn btn-secondary" id="resetChallengeBtn" aria-label="Reset challenge">Reset</button>
                </div>

                <canvas id="animatedWheel" width="300" height="300" style="display: none;"></canvas>
            </div>

            <!-- Results Panel -->
            <div class="results-panel" id="resultsPanel">
                <div class="card">
                    <h2 class="results-title">Challenge Complete!</h2>
                    <div class="final-score" id="finalScore">0</div>
                    <p style="font-size: 1.2rem; margin-bottom: 24px;">points</p>

                    <div class="score-breakdown" id="scoreBreakdown"></div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" id="playAgainBtn" aria-label="Try again">Play Again</button>
                        <button class="btn btn-secondary" id="backToBrowseBtn" aria-label="Back to browse mode">Back to Browse</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">Copied to clipboard!</div>

    <script>
        // Color Palette Generator - Complete Implementation with Challenge Mode

        // Color Wheel Animation Class
        class ColorWheel {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.rotation = 0;
                this.animating = false;
            }

            draw(rotation = 0) {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const radius = this.canvas.width / 2;

                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw rotating color wheel
                for (let angle = 0; angle < 360; angle += 1) {
                    const adjustedAngle = (angle + rotation) % 360;
                    const startAngle = (angle - 90) * Math.PI / 180;
                    const endAngle = (angle + 1 - 90) * Math.PI / 180;

                    this.ctx.beginPath();
                    this.ctx.moveTo(centerX, centerY);
                    this.ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    this.ctx.closePath();

                    const gradient = this.ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                    gradient.addColorStop(0, `hsl(${adjustedAngle}, 0%, 100%)`);
                    gradient.addColorStop(0.5, `hsl(${adjustedAngle}, 100%, 50%)`);
                    gradient.addColorStop(1, `hsl(${adjustedAngle}, 100%, 25%)`);

                    this.ctx.fillStyle = gradient;
                    this.ctx.fill();
                }
            }

            startAnimation() {
                this.animating = true;
                this.animate();
            }

            stopAnimation() {
                this.animating = false;
            }

            animate() {
                if (!this.animating) return;
                this.rotation = (this.rotation + 0.5) % 360;
                this.draw(this.rotation);
                requestAnimationFrame(() => this.animate());
            }
        }

        // Audio Manager Class
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.enabled = true;
            }

            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn('AudioContext not supported');
                    this.enabled = false;
                }
            }

            playBeep(frequency, duration) {
                if (!this.enabled || !this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playCorrect() {
                this.playBeep(800, 0.15);
                setTimeout(() => this.playBeep(1000, 0.1), 100);
            }

            playIncorrect() {
                this.playBeep(200, 0.3);
            }

            playLevelUp() {
                this.playBeep(523, 0.1);
                setTimeout(() => this.playBeep(659, 0.1), 100);
                setTimeout(() => this.playBeep(784, 0.15), 200);
            }
        }

        // Game State Machine
        class GameState {
            constructor() {
                this.states = {
                    BROWSE: 'browse',
                    CHALLENGE: 'challenge',
                    RESULTS: 'results'
                };
                this.currentState = this.states.BROWSE;
            }

            setState(state) {
                this.currentState = state;
            }

            getState() {
                return this.currentState;
            }

            isBrowse() {
                return this.currentState === this.states.BROWSE;
            }

            isChallenge() {
                return this.currentState === this.states.CHALLENGE;
            }

            isResults() {
                return this.currentState === this.states.RESULTS;
            }
        }

        // Color Palette Class
        class ColorPalette {
            constructor(colors = []) {
                this.colors = colors;
            }

            getColor(index) {
                return this.colors[index];
            }

            setColor(index, color) {
                this.colors[index] = color;
            }

            getAllColors() {
                return this.colors;
            }

            size() {
                return this.colors.length;
            }

            clone() {
                return new ColorPalette([...this.colors.map(c => ({...c}))]);
            }
        }

        class ColorPaletteGenerator {
            constructor() {
                this.canvas = document.getElementById('colorWheel');
                this.ctx = this.canvas.getContext('2d');
                this.indicator = document.getElementById('indicator');
                this.harmonyMode = document.getElementById('harmonyMode');
                this.paletteDisplay = document.getElementById('paletteDisplay');
                this.contrastPreview = document.getElementById('contrastPreview');
                this.historyGrid = document.getElementById('historyGrid');
                this.notification = document.getElementById('notification');
                this.harmonyInfo = document.getElementById('harmonyInfo');

                this.baseHue = 200;
                this.baseSaturation = 70;
                this.baseLightness = 50;
                this.currentPalette = [];
                this.lockedColors = new Set();
                this.paletteHistory = this.loadHistory();

                // New features
                this.gameState = new GameState();
                this.audioManager = new AudioManager();
                this.colorWheel = new ColorWheel(this.canvas);
                this.animatedWheel = new ColorWheel(document.getElementById('animatedWheel'));

                // Challenge mode state
                this.score = 0;
                this.level = 1;
                this.streak = 0;
                this.highScore = this.loadHighScore();
                this.difficulty = 'easy';
                this.targetPalette = null;
                this.challengePalette = new ColorPalette([]);

                // Keyboard state
                this.keysPressed = {};
                this.selectedColorIndex = 0;

                // Smooth animation state
                this.lastTime = performance.now();
                this.deltaTime = 0;

                // Touch state
                this.touchStartPos = null;

                this.harmonyDescriptions = {
                    'complementary': 'Colors opposite on the wheel. High contrast, vibrant.',
                    'analogous': 'Adjacent colors. Harmonious, serene.',
                    'triadic': 'Three colors evenly spaced. Balanced, vibrant.',
                    'split-complementary': 'Base color plus two adjacent to complement. Softer than complementary.',
                    'tetradic': 'Two complementary pairs. Rich, diverse palette.',
                    'monochromatic': 'Variations of a single hue. Unified, elegant.'
                };

                this.init();
            }

            init() {
                this.audioManager.init();
                this.drawColorWheel();
                this.updateHarmonyInfo();
                this.generatePalette();
                this.renderHistory();
                this.attachEventListeners();
                this.updateHighScoreDisplay();
                this.startAnimationLoop();
            }

            startAnimationLoop() {
                const loop = (currentTime) => {
                    this.deltaTime = (currentTime - this.lastTime) / 1000;
                    this.lastTime = currentTime;

                    // Update animations with deltaTime for smooth transitions
                    if (this.gameState.isChallenge()) {
                        this.updateChallengeAnimations();
                    }

                    requestAnimationFrame(loop);
                };
                requestAnimationFrame(loop);
            }

            updateChallengeAnimations() {
                // Smooth color transitions using lerp
                // This creates smooth color blending effects
            }

            lerp(start, end, t) {
                return start + (end - start) * t;
            }

            attachEventListeners() {
                // Browse mode listeners
                this.canvas.addEventListener('click', (e) => this.handleWheelClick(e));

                // Touch support for color wheel
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.handleWheelTouch(e.touches[0]);
                }, { passive: false });

                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    this.handleWheelTouch(e.touches[0]);
                }, { passive: false });

                this.harmonyMode.addEventListener('change', () => {
                    this.updateHarmonyInfo();
                    this.generatePalette();
                });

                document.getElementById('generateBtn').addEventListener('click', () => {
                    this.generatePalette();
                });

                document.getElementById('randomBtn').addEventListener('click', () => {
                    this.baseHue = Math.random() * 360;
                    this.baseSaturation = 50 + Math.random() * 40;
                    this.baseLightness = 40 + Math.random() * 30;
                    this.updateIndicator();
                    this.generatePalette();
                });

                document.getElementById('exportCSS').addEventListener('click', () => {
                    this.exportAsCSS();
                });

                document.getElementById('exportJSON').addEventListener('click', () => {
                    this.exportAsJSON();
                });

                document.getElementById('exportTailwind').addEventListener('click', () => {
                    this.exportAsTailwind();
                });

                // Mode switcher
                document.getElementById('browseModeBtn').addEventListener('click', () => {
                    this.switchToMode('browse');
                });

                document.getElementById('challengeModeBtn').addEventListener('click', () => {
                    this.switchToMode('challenge');
                });

                // Challenge mode listeners
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.setDifficulty(e.target.dataset.difficulty);
                    });
                });

                document.getElementById('submitMatchBtn').addEventListener('click', () => {
                    this.submitMatch();
                });

                document.getElementById('resetChallengeBtn').addEventListener('click', () => {
                    this.resetChallenge();
                });

                document.getElementById('playAgainBtn').addEventListener('click', () => {
                    this.resetChallenge();
                });

                document.getElementById('backToBrowseBtn').addEventListener('click', () => {
                    this.switchToMode('browse');
                });

                // Keyboard controls
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                document.addEventListener('keyup', (e) => this.handleKeyUp(e));
            }

            handleKeyDown(e) {
                this.keysPressed[e.key] = true;

                if (this.gameState.isChallenge()) {
                    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight' ||
                        e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        this.handleChallengeKeyboard(e.key);
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        this.submitMatch();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        this.resetChallenge();
                    }
                }
            }

            handleKeyUp(e) {
                this.keysPressed[e.key] = false;
            }

            handleChallengeKeyboard(key) {
                if (this.challengePalette.size() === 0) return;

                const color = this.challengePalette.getColor(this.selectedColorIndex);
                if (!color) return;

                const step = 5;

                switch(key) {
                    case 'ArrowLeft':
                        color.h = (color.h - step + 360) % 360;
                        break;
                    case 'ArrowRight':
                        color.h = (color.h + step) % 360;
                        break;
                    case 'ArrowUp':
                        color.s = Math.min(100, color.s + step);
                        break;
                    case 'ArrowDown':
                        color.s = Math.max(0, color.s - step);
                        break;
                }

                this.renderChallengePalette();
            }

            handleWheelTouch(touch) {
                const rect = this.canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;

                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;

                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const radius = this.canvas.width / 2;

                if (distance <= radius) {
                    const angle = Math.atan2(dy, dx);
                    const hue = (angle * 180 / Math.PI + 90 + 360) % 360;
                    const saturation = Math.min(100, (distance / radius) * 100);
                    const lightness = 100 - (distance / radius) * 50;

                    this.baseHue = hue;
                    this.baseSaturation = saturation;
                    this.baseLightness = lightness;

                    this.updateIndicator();
                    if (this.gameState.isBrowse()) {
                        this.generatePalette();
                    }
                }
            }

            switchToMode(mode) {
                const browseBtn = document.getElementById('browseModeBtn');
                const challengeBtn = document.getElementById('challengeModeBtn');
                const browsePanel = document.getElementById('browsePanel');
                const challengePanel = document.getElementById('challengePanel');

                if (mode === 'browse') {
                    this.gameState.setState(this.gameState.states.BROWSE);
                    browseBtn.classList.add('active');
                    challengeBtn.classList.remove('active');
                    browseBtn.setAttribute('aria-selected', 'true');
                    challengeBtn.setAttribute('aria-selected', 'false');
                    browsePanel.classList.add('active');
                    challengePanel.classList.remove('active');
                } else if (mode === 'challenge') {
                    this.gameState.setState(this.gameState.states.CHALLENGE);
                    challengeBtn.classList.add('active');
                    browseBtn.classList.remove('active');
                    challengeBtn.setAttribute('aria-selected', 'true');
                    browseBtn.setAttribute('aria-selected', 'false');
                    browsePanel.classList.remove('active');
                    challengePanel.classList.add('active');
                    this.startChallenge();
                }
            }

            setDifficulty(difficulty) {
                this.difficulty = difficulty;
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.difficulty === difficulty);
                });
                this.resetChallenge();
            }

            startChallenge() {
                this.score = 0;
                this.level = 1;
                this.streak = 0;
                this.generateTargetPalette();
                this.generateChallengePalette();
                this.updateChallengeDisplay();
                this.animatedWheel.startAnimation();
            }

            resetChallenge() {
                document.getElementById('resultsPanel').classList.remove('active');
                this.generateTargetPalette();
                this.generateChallengePalette();
                this.updateChallengeDisplay();
            }

            generateTargetPalette() {
                const baseHue = Math.random() * 360;
                const baseSat = 50 + Math.random() * 40;
                const baseLight = 40 + Math.random() * 30;

                const numColors = this.difficulty === 'easy' ? 3 : this.difficulty === 'medium' ? 4 : 5;
                const colors = [];

                for (let i = 0; i < numColors; i++) {
                    colors.push({
                        h: (baseHue + i * (360 / numColors)) % 360,
                        s: baseSat + (Math.random() - 0.5) * 20,
                        l: baseLight + (Math.random() - 0.5) * 20
                    });
                }

                this.targetPalette = new ColorPalette(colors);
                this.renderTargetPalette();
            }

            generateChallengePalette() {
                const numColors = this.targetPalette.size();
                const colors = [];

                for (let i = 0; i < numColors; i++) {
                    colors.push({
                        h: Math.random() * 360,
                        s: 50,
                        l: 50
                    });
                }

                this.challengePalette = new ColorPalette(colors);
                this.renderChallengePalette();
            }

            renderTargetPalette() {
                const display = document.getElementById('targetPaletteDisplay');
                display.innerHTML = '';

                this.targetPalette.getAllColors().forEach((color, index) => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch glow';
                    swatch.style.background = this.hslToString(color);
                    swatch.setAttribute('role', 'listitem');
                    swatch.setAttribute('aria-label', `Target color ${index + 1}`);
                    display.appendChild(swatch);
                });
            }

            renderChallengePalette() {
                const display = document.getElementById('challengePaletteDisplay');
                display.innerHTML = '';

                this.challengePalette.getAllColors().forEach((color, index) => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.style.background = this.hslToString(color);
                    swatch.setAttribute('role', 'listitem');
                    swatch.setAttribute('aria-label', `Your color ${index + 1}`);
                    swatch.setAttribute('tabindex', '0');

                    if (index === this.selectedColorIndex) {
                        swatch.style.border = '4px solid #667eea';
                    }

                    swatch.addEventListener('click', () => {
                        this.selectedColorIndex = index;
                        this.renderChallengePalette();
                    });

                    display.appendChild(swatch);
                });
            }

            submitMatch() {
                const tolerance = this.difficulty === 'easy' ? 20 : this.difficulty === 'medium' ? 15 : 10;
                let matches = 0;
                let totalDiff = 0;

                for (let i = 0; i < this.targetPalette.size(); i++) {
                    const target = this.targetPalette.getColor(i);
                    const attempt = this.challengePalette.getColor(i);

                    const hueDiff = Math.min(Math.abs(target.h - attempt.h), 360 - Math.abs(target.h - attempt.h));
                    const satDiff = Math.abs(target.s - attempt.s);
                    const lightDiff = Math.abs(target.l - attempt.l);

                    const avgDiff = (hueDiff / 360 * 100 + satDiff + lightDiff) / 3;
                    totalDiff += avgDiff;

                    if (avgDiff <= tolerance) {
                        matches++;
                    }
                }

                const requiredMatches = this.targetPalette.size();

                if (matches === requiredMatches) {
                    // Success!
                    this.streak++;
                    const basePoints = 100;
                    const streakBonus = this.streak * 50;
                    const difficultyMultiplier = this.difficulty === 'easy' ? 1 : this.difficulty === 'medium' ? 1.5 : 2;
                    const points = Math.round((basePoints + streakBonus) * difficultyMultiplier);

                    this.score += points;
                    this.level++;

                    this.audioManager.playCorrect();
                    if (this.level % 5 === 0) {
                        this.audioManager.playLevelUp();
                    }

                    // Show streak display
                    const streakDisplay = document.getElementById('streakDisplay');
                    streakDisplay.parentElement.classList.add('pulse');
                    setTimeout(() => {
                        streakDisplay.parentElement.classList.remove('pulse');
                    }, 500);

                    // Generate next level
                    setTimeout(() => {
                        this.generateTargetPalette();
                        this.generateChallengePalette();
                    }, 1000);

                } else {
                    // Failed
                    this.streak = 0;
                    this.audioManager.playIncorrect();

                    // Show results
                    this.showResults(matches, requiredMatches);
                }

                this.updateChallengeDisplay();
                this.checkHighScore();
            }

            showResults(matches, required) {
                this.gameState.setState(this.gameState.states.RESULTS);

                document.getElementById('finalScore').textContent = this.score;

                const breakdown = document.getElementById('scoreBreakdown');
                breakdown.innerHTML = `
                    <div class="score-breakdown-item">
                        <span>Level Reached</span>
                        <span><strong>${this.level}</strong></span>
                    </div>
                    <div class="score-breakdown-item">
                        <span>Colors Matched</span>
                        <span><strong>${matches} / ${required}</strong></span>
                    </div>
                    <div class="score-breakdown-item">
                        <span>Best Streak</span>
                        <span><strong>${this.streak}</strong></span>
                    </div>
                    <div class="score-breakdown-item">
                        <span>Difficulty</span>
                        <span><strong>${this.difficulty.toUpperCase()}</strong></span>
                    </div>
                `;

                document.getElementById('resultsPanel').classList.add('active');
            }

            updateChallengeDisplay() {
                document.getElementById('scoreDisplay').textContent = this.score;
                document.getElementById('levelDisplay').textContent = this.level;
                document.getElementById('streakDisplay').textContent = this.streak;
            }

            checkHighScore() {
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    this.saveHighScore();
                    this.updateHighScoreDisplay();
                }
            }

            updateHighScoreDisplay() {
                document.getElementById('highScoreDisplay').textContent = this.highScore;
            }

            saveHighScore() {
                try {
                    localStorage.setItem('colorPaletteHighScore', this.highScore.toString());
                } catch(e) {
                    console.warn('Could not save high score');
                }
            }

            loadHighScore() {
                try {
                    const stored = localStorage.getItem('colorPaletteHighScore');
                    return stored ? parseInt(stored, 10) : 0;
                } catch(e) {
                    return 0;
                }
            }

            updateHarmonyInfo() {
                const mode = this.harmonyMode.value;
                this.harmonyInfo.textContent = this.harmonyDescriptions[mode];
            }

            drawColorWheel() {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const radius = this.canvas.width / 2;

                // Draw outer color wheel
                for (let angle = 0; angle < 360; angle += 1) {
                    const startAngle = (angle - 90) * Math.PI / 180;
                    const endAngle = (angle + 1 - 90) * Math.PI / 180;

                    this.ctx.beginPath();
                    this.ctx.moveTo(centerX, centerY);
                    this.ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    this.ctx.closePath();

                    const gradient = this.ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                    gradient.addColorStop(0, `hsl(${angle}, 0%, 100%)`);
                    gradient.addColorStop(0.5, `hsl(${angle}, 100%, 50%)`);
                    gradient.addColorStop(1, `hsl(${angle}, 100%, 25%)`);

                    this.ctx.fillStyle = gradient;
                    this.ctx.fill();
                }

                this.updateIndicator();
            }

            handleWheelClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;

                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const radius = this.canvas.width / 2;

                if (distance <= radius) {
                    const angle = Math.atan2(dy, dx);
                    const hue = (angle * 180 / Math.PI + 90 + 360) % 360;
                    const saturation = Math.min(100, (distance / radius) * 100);

                    // Lightness based on distance (center = white, edge = saturated)
                    const lightness = 100 - (distance / radius) * 50;

                    this.baseHue = hue;
                    this.baseSaturation = saturation;
                    this.baseLightness = lightness;

                    this.updateIndicator();
                    this.generatePalette();
                }
            }

            updateIndicator() {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const radius = this.canvas.width / 2;

                const angle = (this.baseHue - 90) * Math.PI / 180;
                const distance = (this.baseSaturation / 100) * radius * 0.8;

                const x = centerX + Math.cos(angle) * distance;
                const y = centerY + Math.sin(angle) * distance;

                this.indicator.style.left = x + 'px';
                this.indicator.style.top = y + 'px';
                this.indicator.style.background = `hsl(${this.baseHue}, ${this.baseSaturation}%, ${this.baseLightness}%)`;
            }

            generatePalette() {
                const mode = this.harmonyMode.value;
                let colors = [];

                switch(mode) {
                    case 'complementary':
                        colors = this.generateComplementary();
                        break;
                    case 'analogous':
                        colors = this.generateAnalogous();
                        break;
                    case 'triadic':
                        colors = this.generateTriadic();
                        break;
                    case 'split-complementary':
                        colors = this.generateSplitComplementary();
                        break;
                    case 'tetradic':
                        colors = this.generateTetradic();
                        break;
                    case 'monochromatic':
                        colors = this.generateMonochromatic();
                        break;
                }

                // Replace only unlocked colors
                for (let i = 0; i < colors.length; i++) {
                    if (!this.lockedColors.has(i)) {
                        this.currentPalette[i] = colors[i];
                    }
                }

                this.renderPalette();
                this.renderContrastPreview();
                this.addToHistory(this.currentPalette);
            }

            generateComplementary() {
                const complement = (this.baseHue + 180) % 360;
                return [
                    { h: this.baseHue, s: this.baseSaturation, l: this.baseLightness },
                    { h: this.baseHue, s: this.baseSaturation - 20, l: this.baseLightness + 20 },
                    { h: complement, s: this.baseSaturation, l: this.baseLightness },
                    { h: complement, s: this.baseSaturation - 20, l: this.baseLightness + 20 },
                    { h: (this.baseHue + 90) % 360, s: 30, l: 85 }
                ];
            }

            generateAnalogous() {
                return [
                    { h: (this.baseHue - 30 + 360) % 360, s: this.baseSaturation, l: this.baseLightness },
                    { h: (this.baseHue - 15 + 360) % 360, s: this.baseSaturation, l: this.baseLightness + 10 },
                    { h: this.baseHue, s: this.baseSaturation + 10, l: this.baseLightness },
                    { h: (this.baseHue + 15) % 360, s: this.baseSaturation, l: this.baseLightness + 10 },
                    { h: (this.baseHue + 30) % 360, s: this.baseSaturation, l: this.baseLightness }
                ];
            }

            generateTriadic() {
                return [
                    { h: this.baseHue, s: this.baseSaturation, l: this.baseLightness },
                    { h: (this.baseHue + 120) % 360, s: this.baseSaturation, l: this.baseLightness },
                    { h: (this.baseHue + 240) % 360, s: this.baseSaturation, l: this.baseLightness },
                    { h: this.baseHue, s: this.baseSaturation - 30, l: this.baseLightness + 25 },
                    { h: (this.baseHue + 120) % 360, s: this.baseSaturation - 30, l: this.baseLightness + 25 }
                ];
            }

            generateSplitComplementary() {
                const complement = (this.baseHue + 180) % 360;
                return [
                    { h: this.baseHue, s: this.baseSaturation, l: this.baseLightness },
                    { h: (complement - 30 + 360) % 360, s: this.baseSaturation, l: this.baseLightness },
                    { h: (complement + 30) % 360, s: this.baseSaturation, l: this.baseLightness },
                    { h: this.baseHue, s: this.baseSaturation - 25, l: this.baseLightness + 20 },
                    { h: complement, s: 20, l: 90 }
                ];
            }

            generateTetradic() {
                return [
                    { h: this.baseHue, s: this.baseSaturation, l: this.baseLightness },
                    { h: (this.baseHue + 90) % 360, s: this.baseSaturation, l: this.baseLightness },
                    { h: (this.baseHue + 180) % 360, s: this.baseSaturation, l: this.baseLightness },
                    { h: (this.baseHue + 270) % 360, s: this.baseSaturation, l: this.baseLightness },
                    { h: this.baseHue, s: 15, l: 92 }
                ];
            }

            generateMonochromatic() {
                return [
                    { h: this.baseHue, s: this.baseSaturation, l: 25 },
                    { h: this.baseHue, s: this.baseSaturation, l: 40 },
                    { h: this.baseHue, s: this.baseSaturation, l: this.baseLightness },
                    { h: this.baseHue, s: this.baseSaturation - 20, l: 70 },
                    { h: this.baseHue, s: this.baseSaturation - 30, l: 85 }
                ];
            }

            renderPalette() {
                this.paletteDisplay.innerHTML = '';

                this.currentPalette.forEach((color, index) => {
                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.style.background = this.hslToString(color);
                    swatch.setAttribute('role', 'listitem');
                    swatch.setAttribute('aria-label', `Color ${index + 1}: ${this.hslToHex(color)}`);
                    swatch.setAttribute('tabindex', '0');

                    const lockBtn = document.createElement('button');
                    lockBtn.className = 'lock-btn';
                    lockBtn.textContent = this.lockedColors.has(index) ? '🔒' : '🔓';
                    lockBtn.setAttribute('aria-label', this.lockedColors.has(index) ? 'Unlock color' : 'Lock color');
                    lockBtn.setAttribute('tabindex', '0');
                    if (this.lockedColors.has(index)) {
                        lockBtn.classList.add('locked');
                    }

                    lockBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (this.lockedColors.has(index)) {
                            this.lockedColors.delete(index);
                            lockBtn.textContent = '🔓';
                            lockBtn.setAttribute('aria-label', 'Lock color');
                            lockBtn.classList.remove('locked');
                        } else {
                            this.lockedColors.add(index);
                            lockBtn.textContent = '🔒';
                            lockBtn.setAttribute('aria-label', 'Unlock color');
                            lockBtn.classList.add('locked');
                        }
                    });

                    const info = document.createElement('div');
                    info.className = 'color-info';
                    info.innerHTML = `
                        <div class="color-values">
                            <div><strong>${this.hslToHex(color)}</strong></div>
                            <div>RGB: ${this.hslToRgb(color)}</div>
                            <div>HSL: ${Math.round(color.h)}, ${Math.round(color.s)}%, ${Math.round(color.l)}%</div>
                        </div>
                    `;

                    swatch.appendChild(lockBtn);
                    swatch.appendChild(info);

                    swatch.addEventListener('click', () => {
                        this.copyToClipboard(this.hslToHex(color));
                    });

                    this.paletteDisplay.appendChild(swatch);
                });
            }

            renderContrastPreview() {
                this.contrastPreview.innerHTML = '';

                // Show text on background for each color pair
                for (let i = 0; i < this.currentPalette.length; i++) {
                    const bg = this.currentPalette[i];
                    const textColor = this.getContrastColor(bg);
                    const ratio = this.getContrastRatio(bg, textColor);

                    const card = document.createElement('div');
                    card.className = 'contrast-card';
                    card.style.background = this.hslToString(bg);
                    card.style.color = textColor;
                    card.setAttribute('role', 'listitem');
                    card.setAttribute('aria-label', `Contrast preview for color ${i + 1}`);

                    const wcagLevel = this.getWCAGLevel(ratio);
                    const badge = document.createElement('div');
                    badge.className = `wcag-badge wcag-${wcagLevel}`;
                    badge.textContent = wcagLevel === 'fail' ? 'FAIL' : wcagLevel.toUpperCase();

                    card.innerHTML = `
                        Sample Text
                        <div class="contrast-ratio">Ratio: ${ratio.toFixed(2)}:1</div>
                    `;
                    card.appendChild(badge);

                    this.contrastPreview.appendChild(card);
                }
            }

            getContrastColor(hsl) {
                // Return white or black based on luminance
                return hsl.l > 50 ? '#000000' : '#FFFFFF';
            }

            getContrastRatio(hsl, hexColor) {
                const rgb1 = this.hslToRgbValues(hsl);
                const rgb2 = hexColor === '#FFFFFF' ? {r: 255, g: 255, b: 255} : {r: 0, g: 0, b: 0};

                const l1 = this.getRelativeLuminance(rgb1);
                const l2 = this.getRelativeLuminance(rgb2);

                const lighter = Math.max(l1, l2);
                const darker = Math.min(l1, l2);

                return (lighter + 0.05) / (darker + 0.05);
            }

            getRelativeLuminance(rgb) {
                const rsRGB = rgb.r / 255;
                const gsRGB = rgb.g / 255;
                const bsRGB = rgb.b / 255;

                const r = rsRGB <= 0.03928 ? rsRGB / 12.92 : Math.pow((rsRGB + 0.055) / 1.055, 2.4);
                const g = gsRGB <= 0.03928 ? gsRGB / 12.92 : Math.pow((gsRGB + 0.055) / 1.055, 2.4);
                const b = bsRGB <= 0.03928 ? bsRGB / 12.92 : Math.pow((bsRGB + 0.055) / 1.055, 2.4);

                return 0.2126 * r + 0.7152 * g + 0.0722 * b;
            }

            getWCAGLevel(ratio) {
                if (ratio >= 7) return 'aaa';
                if (ratio >= 4.5) return 'aa';
                return 'fail';
            }

            hslToString(hsl) {
                return `hsl(${hsl.h}, ${hsl.s}%, ${hsl.l}%)`;
            }

            hslToHex(hsl) {
                const rgb = this.hslToRgbValues(hsl);
                const r = rgb.r.toString(16).padStart(2, '0');
                const g = rgb.g.toString(16).padStart(2, '0');
                const b = rgb.b.toString(16).padStart(2, '0');
                return `#${r}${g}${b}`.toUpperCase();
            }

            hslToRgb(hsl) {
                const rgb = this.hslToRgbValues(hsl);
                return `${rgb.r}, ${rgb.g}, ${rgb.b}`;
            }

            hslToRgbValues(hsl) {
                const h = hsl.h / 360;
                const s = hsl.s / 100;
                const l = hsl.l / 100;

                let r, g, b;

                if (s === 0) {
                    r = g = b = l;
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    };

                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;

                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }

                return {
                    r: Math.round(r * 255),
                    g: Math.round(g * 255),
                    b: Math.round(b * 255)
                };
            }

            exportAsCSS() {
                let css = ':root {\n';
                this.currentPalette.forEach((color, index) => {
                    css += `  --color-${index + 1}: ${this.hslToHex(color)};\n`;
                });
                css += '}';
                this.copyToClipboard(css);
            }

            exportAsJSON() {
                const json = {
                    palette: this.currentPalette.map((color, index) => ({
                        name: `color-${index + 1}`,
                        hex: this.hslToHex(color),
                        rgb: this.hslToRgb(color),
                        hsl: `${Math.round(color.h)}, ${Math.round(color.s)}%, ${Math.round(color.l)}%`
                    })),
                    harmonyMode: this.harmonyMode.value,
                    created: new Date().toISOString()
                };
                this.copyToClipboard(JSON.stringify(json, null, 2));
            }

            exportAsTailwind() {
                let config = 'module.exports = {\n  theme: {\n    extend: {\n      colors: {\n        palette: {\n';
                this.currentPalette.forEach((color, index) => {
                    config += `          ${index + 1}: '${this.hslToHex(color)}',\n`;
                });
                config += '        }\n      }\n    }\n  }\n}';
                this.copyToClipboard(config);
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showNotification();
                });
            }

            showNotification() {
                this.notification.classList.add('show');
                setTimeout(() => {
                    this.notification.classList.remove('show');
                }, 2000);
            }

            addToHistory(palette) {
                const paletteStr = JSON.stringify(palette);

                // Remove duplicate if exists
                this.paletteHistory = this.paletteHistory.filter(p => JSON.stringify(p) !== paletteStr);

                // Add to beginning
                this.paletteHistory.unshift([...palette]);

                // Keep only last 10
                if (this.paletteHistory.length > 10) {
                    this.paletteHistory = this.paletteHistory.slice(0, 10);
                }

                this.saveHistory();
                this.renderHistory();
            }

            renderHistory() {
                this.historyGrid.innerHTML = '';

                this.paletteHistory.forEach((palette, index) => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.title = 'Click to load this palette';
                    item.setAttribute('role', 'listitem');
                    item.setAttribute('aria-label', `Palette history item ${index + 1}`);
                    item.setAttribute('tabindex', '0');

                    palette.forEach(color => {
                        const colorDiv = document.createElement('div');
                        colorDiv.className = 'history-color';
                        colorDiv.style.background = this.hslToString(color);
                        item.appendChild(colorDiv);
                    });

                    item.addEventListener('click', () => {
                        this.currentPalette = [...palette];
                        this.lockedColors.clear();
                        this.renderPalette();
                        this.renderContrastPreview();
                    });

                    // Keyboard support for history items
                    item.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            item.click();
                        }
                    });

                    this.historyGrid.appendChild(item);
                });
            }

            saveHistory() {
                try {
                    localStorage.setItem('colorPaletteHistory', JSON.stringify(this.paletteHistory));
                } catch(e) {
                    console.warn('Could not save history to localStorage');
                }
            }

            loadHistory() {
                try {
                    const stored = localStorage.getItem('colorPaletteHistory');
                    return stored ? JSON.parse(stored) : [];
                } catch(e) {
                    return [];
                }
            }
        }

        // Initialize the app
        const app = new ColorPaletteGenerator();
    </script>
</body>
</html>
