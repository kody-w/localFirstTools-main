<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="creative-tools">
<meta name="rappterzoo:tags" content="canvas,simulation,desktop,interactive,audio,particles">
<meta name="rappterzoo:type" content="interactive">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2024-01-15">
<meta name="rappterzoo:generation" content="2">
<title>Desktop Environment Simulator</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #1a1a2e;
  font-family: 'Courier New', monospace;
  overflow: hidden;
  height: 100vh;
  user-select: none;
}
#boot-screen {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: #000;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 1000;
  transition: opacity 0.5s;
}
#boot-screen .logo {
  font-size: 48px;
  background: linear-gradient(135deg, #00ff9d, #bd00ff);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  margin-bottom: 20px;
}
#boot-screen .progress-bar {
  width: 300px; height: 4px; background: #222;
  border-radius: 2px; overflow: hidden;
}
#boot-screen .progress-fill {
  height: 100%; width: 0%; background: linear-gradient(90deg, #00ff9d, #bd00ff);
  transition: width 0.3s;
}
#boot-screen .boot-text {
  color: #333; font-size: 12px; margin-top: 15px;
  min-height: 16px;
}
#desktop {
  position: relative; width: 100vw; height: 100vh;
  background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
  display: none;
}
#wallpaper-canvas {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  z-index: 0;
}
.desktop-icon {
  position: absolute; width: 80px; text-align: center;
  cursor: pointer; z-index: 5; padding: 8px;
  border-radius: 6px; transition: background 0.2s;
}
.desktop-icon:hover { background: rgba(255,255,255,0.1); }
.desktop-icon.selected { background: rgba(100,100,255,0.3); border: 1px solid rgba(100,100,255,0.5); }
.desktop-icon .icon-img {
  font-size: 36px; display: block; margin-bottom: 4px;
}
.desktop-icon .icon-label {
  font-size: 10px; color: #fff; text-shadow: 1px 1px 2px #000;
  word-wrap: break-word;
}
.window {
  position: absolute; min-width: 300px; min-height: 200px;
  background: #1e1e2e; border: 1px solid #333;
  border-radius: 8px; overflow: hidden; z-index: 10;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  display: none;
}
.window.active { z-index: 20; box-shadow: 0 12px 48px rgba(0,0,0,0.7); border-color: #555; }
.window-header {
  height: 32px; background: linear-gradient(to right, #2a2a3e, #1e1e2e);
  display: flex; align-items: center; padding: 0 10px;
  cursor: grab; border-bottom: 1px solid #333;
}
.window-header .dots { display: flex; gap: 6px; }
.window-header .dot {
  width: 12px; height: 12px; border-radius: 50%; cursor: pointer;
  transition: transform 0.2s;
}
.window-header .dot:hover { transform: scale(1.2); }
.dot-close { background: #ff5f56; }
.dot-min { background: #ffbd2e; }
.dot-max { background: #27c93f; }
.window-header .win-title {
  flex: 1; text-align: center; font-size: 12px; color: #888;
}
.window-body { padding: 10px; color: #ccc; font-size: 13px; overflow: auto; }
#taskbar {
  position: fixed; bottom: 0; left: 0; right: 0;
  height: 44px; background: rgba(15,15,25,0.95);
  border-top: 1px solid #333; display: flex;
  align-items: center; padding: 0 10px; z-index: 50;
  backdrop-filter: blur(10px);
}
#start-btn {
  background: linear-gradient(135deg, #00ff9d33, #bd00ff33);
  border: 1px solid #444; color: #aaa;
  font-family: 'Courier New', monospace; font-size: 12px;
  padding: 5px 14px; border-radius: 4px; cursor: pointer;
  transition: all 0.2s;
}
#start-btn:hover { background: linear-gradient(135deg, #00ff9d55, #bd00ff55); border-color: #666; }
#taskbar-apps { display: flex; gap: 4px; margin-left: 10px; flex: 1; }
.taskbar-item {
  background: #222; border: 1px solid #333; color: #888;
  font-size: 11px; padding: 4px 12px; border-radius: 3px;
  cursor: pointer; transition: all 0.2s; max-width: 140px;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.taskbar-item:hover { background: #2a2a3e; }
.taskbar-item.active { background: #2a2a4e; border-color: #555; color: #ccc; }
#clock {
  font-size: 12px; color: #888; margin-left: auto;
  padding: 0 10px;
}
#start-menu {
  position: fixed; bottom: 44px; left: 0;
  width: 280px; background: rgba(20,20,35,0.98);
  border: 1px solid #333; border-radius: 8px 8px 0 0;
  display: none; z-index: 60;
  box-shadow: 0 -8px 32px rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
}
#start-menu .menu-header {
  padding: 16px; border-bottom: 1px solid #333;
  font-size: 14px; color: #888;
  background: linear-gradient(135deg, #00ff9d11, #bd00ff11);
}
.menu-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 16px; color: #aaa; font-size: 13px;
  cursor: pointer; transition: background 0.15s;
}
.menu-item:hover { background: rgba(100,100,255,0.15); }
.menu-item .mi-icon { font-size: 18px; width: 24px; text-align: center; }
#notification-area {
  position: fixed; top: 10px; right: 10px; z-index: 100;
}
.notification {
  background: rgba(20,20,35,0.95); border: 1px solid #444;
  border-radius: 8px; padding: 12px 16px; margin-bottom: 6px;
  color: #ccc; font-size: 12px; min-width: 250px;
  transform: translateX(110%); transition: transform 0.3s;
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
}
.notification.show { transform: translateX(0); }
.notification .notif-title { color: #00ff9d; font-weight: bold; margin-bottom: 4px; }
#context-menu {
  position: fixed; background: rgba(20,20,35,0.98);
  border: 1px solid #444; border-radius: 6px;
  min-width: 180px; display: none; z-index: 200;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
}
.ctx-item {
  padding: 8px 16px; color: #aaa; font-size: 12px;
  cursor: pointer; transition: background 0.1s;
}
.ctx-item:hover { background: rgba(100,100,255,0.2); color: #fff; }
.ctx-sep { height: 1px; background: #333; margin: 4px 0; }
/* App-specific styles */
.terminal-body {
  background: #0a0a0a; color: #00ff9d; font-family: 'Courier New', monospace;
  font-size: 13px; padding: 10px; height: 300px; overflow-y: auto;
}
.terminal-body .prompt { color: #bd00ff; }
.terminal-body input {
  background: transparent; border: none; color: #00ff9d;
  font-family: inherit; font-size: inherit; outline: none;
  width: calc(100% - 80px);
}
.notepad-body textarea {
  width: 100%; height: 280px; background: #1a1a2e;
  border: none; color: #ccc; font-family: 'Courier New', monospace;
  font-size: 13px; padding: 10px; resize: none; outline: none;
}
.calc-display {
  background: #0a0a1a; color: #00ff9d; font-size: 28px;
  text-align: right; padding: 15px; margin-bottom: 8px;
  border-radius: 4px; min-height: 50px;
  font-family: 'Courier New', monospace;
}
.calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
.calc-btn {
  background: #2a2a3e; border: 1px solid #444; color: #ccc;
  font-family: 'Courier New', monospace; font-size: 16px;
  padding: 12px; border-radius: 4px; cursor: pointer;
  transition: all 0.15s;
}
.calc-btn:hover { background: #3a3a5e; }
.calc-btn.op { background: #1a3a2a; color: #00ff9d; }
.calc-btn.op:hover { background: #2a4a3a; }
.calc-btn.eq { background: #00ff9d; color: #000; }
.settings-body { padding: 15px; }
.settings-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 0; border-bottom: 1px solid #222;
}
.settings-row label { color: #aaa; font-size: 13px; }
.toggle {
  width: 40px; height: 20px; background: #333;
  border-radius: 10px; position: relative; cursor: pointer;
  transition: background 0.3s;
}
.toggle.on { background: #00ff9d; }
.toggle::after {
  content: ''; position: absolute; top: 2px; left: 2px;
  width: 16px; height: 16px; background: #fff;
  border-radius: 50%; transition: left 0.3s;
}
.toggle.on::after { left: 22px; }
.file-browser { font-size: 12px; }
.file-item {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 10px; cursor: pointer; border-radius: 4px;
  transition: background 0.1s;
}
.file-item:hover { background: rgba(100,100,255,0.15); }
.file-item .fi-icon { font-size: 16px; }
.file-item .fi-name { color: #ccc; }
.file-item .fi-size { color: #666; margin-left: auto; }
@media (max-width: 768px) {
  .desktop-icon { width: 60px; }
  .desktop-icon .icon-img { font-size: 28px; }
  .window { min-width: 280px; }
  #start-menu { width: 100%; }
}
</style>
</head>
<body>

<div id="boot-screen">
  <div class="logo">RapptrOS</div>
  <div class="progress-bar"><div class="progress-fill" id="boot-progress"></div></div>
  <div class="boot-text" id="boot-text"></div>
</div>

<div id="desktop">
  <canvas id="wallpaper-canvas"></canvas>

  <div class="desktop-icon" style="left:20px;top:20px" data-app="terminal">
    <span class="icon-img">&#9000;</span>
    <span class="icon-label">Terminal</span>
  </div>
  <div class="desktop-icon" style="left:20px;top:120px" data-app="notepad">
    <span class="icon-img">&#9998;</span>
    <span class="icon-label">Notes</span>
  </div>
  <div class="desktop-icon" style="left:20px;top:220px" data-app="calculator">
    <span class="icon-img">&#9874;</span>
    <span class="icon-label">Calculator</span>
  </div>
  <div class="desktop-icon" style="left:20px;top:320px" data-app="files">
    <span class="icon-img">&#9783;</span>
    <span class="icon-label">Files</span>
  </div>
  <div class="desktop-icon" style="left:20px;top:420px" data-app="settings">
    <span class="icon-img">&#9881;</span>
    <span class="icon-label">Settings</span>
  </div>
  <div class="desktop-icon" style="left:120px;top:20px" data-app="paint">
    <span class="icon-img">&#9986;</span>
    <span class="icon-label">Paint</span>
  </div>

  <!-- Terminal Window -->
  <div class="window" id="win-terminal" style="left:200px;top:50px;width:550px;height:380px;">
    <div class="window-header">
      <div class="dots"><div class="dot dot-close" data-win="terminal"></div><div class="dot dot-min" data-win="terminal"></div><div class="dot dot-max" data-win="terminal"></div></div>
      <span class="win-title">Terminal</span>
    </div>
    <div class="terminal-body" id="terminal-output">
      <div>RapptrOS Terminal v2.1</div>
      <div>Type 'help' for available commands.</div>
      <div style="margin-top:6px;"><span class="prompt">rapptr@zoo:~$ </span><input type="text" id="terminal-input" autofocus></div>
    </div>
  </div>

  <!-- Notepad Window -->
  <div class="window" id="win-notepad" style="left:250px;top:80px;width:500px;height:360px;">
    <div class="window-header">
      <div class="dots"><div class="dot dot-close" data-win="notepad"></div><div class="dot dot-min" data-win="notepad"></div><div class="dot dot-max" data-win="notepad"></div></div>
      <span class="win-title">Notes</span>
    </div>
    <div class="notepad-body"><textarea id="notepad-text" placeholder="Start typing..."></textarea></div>
  </div>

  <!-- Calculator Window -->
  <div class="window" id="win-calculator" style="left:300px;top:100px;width:280px;height:400px;">
    <div class="window-header">
      <div class="dots"><div class="dot dot-close" data-win="calculator"></div><div class="dot dot-min" data-win="calculator"></div><div class="dot dot-max" data-win="calculator"></div></div>
      <span class="win-title">Calculator</span>
    </div>
    <div class="window-body">
      <div class="calc-display" id="calc-display">0</div>
      <div class="calc-grid">
        <button class="calc-btn" data-val="C">C</button>
        <button class="calc-btn" data-val="del">DEL</button>
        <button class="calc-btn op" data-val="%">%</button>
        <button class="calc-btn op" data-val="/">/</button>
        <button class="calc-btn" data-val="7">7</button>
        <button class="calc-btn" data-val="8">8</button>
        <button class="calc-btn" data-val="9">9</button>
        <button class="calc-btn op" data-val="*">x</button>
        <button class="calc-btn" data-val="4">4</button>
        <button class="calc-btn" data-val="5">5</button>
        <button class="calc-btn" data-val="6">6</button>
        <button class="calc-btn op" data-val="-">-</button>
        <button class="calc-btn" data-val="1">1</button>
        <button class="calc-btn" data-val="2">2</button>
        <button class="calc-btn" data-val="3">3</button>
        <button class="calc-btn op" data-val="+">+</button>
        <button class="calc-btn" data-val="0" style="grid-column:span 2">0</button>
        <button class="calc-btn" data-val=".">.</button>
        <button class="calc-btn eq" data-val="=">=</button>
      </div>
    </div>
  </div>

  <!-- Files Window -->
  <div class="window" id="win-files" style="left:150px;top:60px;width:480px;height:350px;">
    <div class="window-header">
      <div class="dots"><div class="dot dot-close" data-win="files"></div><div class="dot dot-min" data-win="files"></div><div class="dot dot-max" data-win="files"></div></div>
      <span class="win-title">File Browser</span>
    </div>
    <div class="window-body file-browser" id="file-list"></div>
  </div>

  <!-- Settings Window -->
  <div class="window" id="win-settings" style="left:280px;top:90px;width:400px;height:380px;">
    <div class="window-header">
      <div class="dots"><div class="dot dot-close" data-win="settings"></div><div class="dot dot-min" data-win="settings"></div><div class="dot dot-max" data-win="settings"></div></div>
      <span class="win-title">Settings</span>
    </div>
    <div class="settings-body">
      <div class="settings-row"><label>Dark Mode</label><div class="toggle on" data-setting="darkMode"></div></div>
      <div class="settings-row"><label>Sound Effects</label><div class="toggle on" data-setting="sound"></div></div>
      <div class="settings-row"><label>Animated Wallpaper</label><div class="toggle on" data-setting="wallpaper"></div></div>
      <div class="settings-row"><label>Notifications</label><div class="toggle on" data-setting="notifications"></div></div>
      <div class="settings-row"><label>24-Hour Clock</label><div class="toggle" data-setting="clock24"></div></div>
      <div class="settings-row"><label>Show Seconds</label><div class="toggle on" data-setting="showSeconds"></div></div>
      <div class="settings-row">
        <label>Wallpaper Style</label>
        <select style="background:#2a2a3e;border:1px solid #444;color:#ccc;padding:4px 8px;border-radius:4px;font-family:inherit;" id="wallpaper-style">
          <option value="stars">Stars</option>
          <option value="matrix">Matrix</option>
          <option value="waves">Waves</option>
          <option value="particles">Particles</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Paint Window -->
  <div class="window" id="win-paint" style="left:180px;top:40px;width:520px;height:420px;">
    <div class="window-header">
      <div class="dots"><div class="dot dot-close" data-win="paint"></div><div class="dot dot-min" data-win="paint"></div><div class="dot dot-max" data-win="paint"></div></div>
      <span class="win-title">Paint</span>
    </div>
    <div class="window-body" style="padding:4px;display:flex;flex-direction:column;height:calc(100% - 32px);">
      <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
        <div style="width:24px;height:24px;background:#ff0000;border-radius:3px;cursor:pointer;border:2px solid transparent;" class="paint-color selected" data-color="#ff0000"></div>
        <div style="width:24px;height:24px;background:#ff8800;border-radius:3px;cursor:pointer;border:2px solid transparent;" class="paint-color" data-color="#ff8800"></div>
        <div style="width:24px;height:24px;background:#ffff00;border-radius:3px;cursor:pointer;border:2px solid transparent;" class="paint-color" data-color="#ffff00"></div>
        <div style="width:24px;height:24px;background:#00ff00;border-radius:3px;cursor:pointer;border:2px solid transparent;" class="paint-color" data-color="#00ff00"></div>
        <div style="width:24px;height:24px;background:#0088ff;border-radius:3px;cursor:pointer;border:2px solid transparent;" class="paint-color" data-color="#0088ff"></div>
        <div style="width:24px;height:24px;background:#8800ff;border-radius:3px;cursor:pointer;border:2px solid transparent;" class="paint-color" data-color="#8800ff"></div>
        <div style="width:24px;height:24px;background:#ffffff;border-radius:3px;cursor:pointer;border:2px solid transparent;" class="paint-color" data-color="#ffffff"></div>
        <div style="width:24px;height:24px;background:#000000;border-radius:3px;cursor:pointer;border:2px solid #444;" class="paint-color" data-color="#000000"></div>
        <button class="calc-btn" style="padding:4px 8px;font-size:10px;" id="paint-clear">CLR</button>
        <input type="range" min="1" max="20" value="3" id="paint-size" style="width:60px;accent-color:#00ff9d;">
      </div>
      <canvas id="paint-canvas" style="flex:1;background:#1a1a2e;border:1px solid #333;border-radius:4px;cursor:crosshair;"></canvas>
    </div>
  </div>

  <div id="taskbar">
    <button id="start-btn">RapptrOS</button>
    <div id="taskbar-apps"></div>
    <div id="clock"></div>
  </div>

  <div id="start-menu">
    <div class="menu-header">RapptrOS 2.1</div>
    <div class="menu-item" data-app="terminal"><span class="mi-icon">&#9000;</span> Terminal</div>
    <div class="menu-item" data-app="notepad"><span class="mi-icon">&#9998;</span> Notes</div>
    <div class="menu-item" data-app="calculator"><span class="mi-icon">&#9874;</span> Calculator</div>
    <div class="menu-item" data-app="files"><span class="mi-icon">&#9783;</span> Files</div>
    <div class="menu-item" data-app="paint"><span class="mi-icon">&#9986;</span> Paint</div>
    <div class="menu-item" data-app="settings"><span class="mi-icon">&#9881;</span> Settings</div>
  </div>

  <div id="context-menu">
    <div class="ctx-item" data-action="refresh">Refresh Desktop</div>
    <div class="ctx-item" data-action="terminal">Open Terminal</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item" data-action="wallpaper">Change Wallpaper</div>
    <div class="ctx-item" data-action="settings">Settings</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item" data-action="about">About RapptrOS</div>
  </div>

  <div id="notification-area"></div>
</div>

<script>
// ============================================================
// DESKTOP ENVIRONMENT SIMULATOR
// A fully interactive simulated desktop OS experience
// ============================================================

// Audio System
const Audio = {
  ctx: null, gain: null, enabled: true,
  init() {
    if (this.ctx) return;
    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      this.gain = this.ctx.createGain();
      this.gain.gain.value = 0.2;
      this.gain.connect(this.ctx.destination);
    } catch(e) {}
  },
  play(type) {
    if (!this.enabled || !this.ctx) return;
    const t = this.ctx.currentTime;
    const o = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    o.connect(g); g.connect(this.gain);
    switch(type) {
      case 'open':
        o.type='sine'; o.frequency.setValueAtTime(400,t);
        o.frequency.exponentialRampToValueAtTime(600,t+0.1);
        g.gain.setValueAtTime(0.2,t);
        g.gain.exponentialRampToValueAtTime(0.001,t+0.15);
        o.start(t); o.stop(t+0.15); break;
      case 'close':
        o.type='sine'; o.frequency.setValueAtTime(600,t);
        o.frequency.exponentialRampToValueAtTime(300,t+0.1);
        g.gain.setValueAtTime(0.15,t);
        g.gain.exponentialRampToValueAtTime(0.001,t+0.12);
        o.start(t); o.stop(t+0.12); break;
      case 'click':
        o.type='square'; o.frequency.setValueAtTime(800,t);
        g.gain.setValueAtTime(0.05,t);
        g.gain.exponentialRampToValueAtTime(0.001,t+0.03);
        o.start(t); o.stop(t+0.03); break;
      case 'error':
        o.type='sawtooth'; o.frequency.setValueAtTime(200,t);
        o.frequency.setValueAtTime(150,t+0.1);
        g.gain.setValueAtTime(0.15,t);
        g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
        o.start(t); o.stop(t+0.3); break;
      case 'notify':
        o.type='sine'; o.frequency.setValueAtTime(523,t);
        o.frequency.setValueAtTime(659,t+0.1);
        g.gain.setValueAtTime(0.1,t);
        g.gain.exponentialRampToValueAtTime(0.001,t+0.2);
        o.start(t); o.stop(t+0.2); break;
      case 'boot':
        o.type='sine'; o.frequency.setValueAtTime(262,t);
        o.frequency.setValueAtTime(330,t+0.15);
        o.frequency.setValueAtTime(392,t+0.3);
        o.frequency.setValueAtTime(523,t+0.45);
        g.gain.setValueAtTime(0.15,t);
        g.gain.exponentialRampToValueAtTime(0.001,t+0.6);
        o.start(t); o.stop(t+0.6); break;
      case 'key':
        o.type='sine'; o.frequency.setValueAtTime(600+Math.random()*200,t);
        g.gain.setValueAtTime(0.03,t);
        g.gain.exponentialRampToValueAtTime(0.001,t+0.02);
        o.start(t); o.stop(t+0.02); break;
    }
  }
};

// Settings
let settings = {
  darkMode: true, sound: true, wallpaper: true,
  notifications: true, clock24: false, showSeconds: true,
  wallpaperStyle: 'stars'
};

// Window management
const windows = {};
let activeWindow = null;
let dragWindow = null;
let dragOffsetX = 0, dragOffsetY = 0;
let openWindows = [];
let windowZIndex = 10;

// Boot sequence
const bootMessages = [
  'Loading kernel modules...', 'Initializing memory manager...',
  'Mounting file systems...', 'Starting display server...',
  'Loading user preferences...', 'Initializing audio subsystem...',
  'Starting window manager...', 'Loading desktop environment...',
  'RapptrOS 2.1 ready.'
];

function boot() {
  const progress = document.getElementById('boot-progress');
  const text = document.getElementById('boot-text');
  let step = 0;
  const interval = setInterval(() => {
    if (step < bootMessages.length) {
      text.textContent = bootMessages[step];
      progress.style.width = ((step + 1) / bootMessages.length * 100) + '%';
      step++;
    } else {
      clearInterval(interval);
      Audio.init();
      Audio.play('boot');
      setTimeout(() => {
        document.getElementById('boot-screen').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('boot-screen').style.display = 'none';
          document.getElementById('desktop').style.display = 'block';
          loadSettings();
          initWallpaper();
          updateClock();
          setInterval(updateClock, 1000);
          setTimeout(() => showNotification('Welcome', 'RapptrOS 2.1 is ready.'), 1000);
        }, 500);
      }, 400);
    }
  }, 250);
}

// Window operations
function openApp(name) {
  Audio.play('open');
  const win = document.getElementById('win-' + name);
  if (!win) return;
  win.style.display = 'block';
  bringToFront(name);
  if (!openWindows.includes(name)) openWindows.push(name);
  updateTaskbar();
  if (name === 'files') populateFiles();
  if (name === 'paint') initPaint();
}

function closeApp(name) {
  Audio.play('close');
  const win = document.getElementById('win-' + name);
  if (win) win.style.display = 'none';
  openWindows = openWindows.filter(w => w !== name);
  updateTaskbar();
}

function bringToFront(name) {
  windowZIndex++;
  const win = document.getElementById('win-' + name);
  if (win) {
    document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
    win.style.zIndex = windowZIndex;
    win.classList.add('active');
    activeWindow = name;
  }
  updateTaskbar();
}

function updateTaskbar() {
  const bar = document.getElementById('taskbar-apps');
  bar.innerHTML = '';
  openWindows.forEach(name => {
    const item = document.createElement('div');
    item.className = 'taskbar-item' + (name === activeWindow ? ' active' : '');
    item.textContent = name.charAt(0).toUpperCase() + name.slice(1);
    item.addEventListener('click', () => {
      const win = document.getElementById('win-' + name);
      if (win.style.display === 'none') {
        win.style.display = 'block';
      }
      bringToFront(name);
    });
    bar.appendChild(item);
  });
}

function updateClock() {
  const now = new Date();
  let h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
  let ampm = '';
  if (!settings.clock24) {
    ampm = h >= 12 ? ' PM' : ' AM';
    h = h % 12 || 12;
  }
  const time = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') +
    (settings.showSeconds ? ':' + String(s).padStart(2,'0') : '') + ampm;
  document.getElementById('clock').textContent = time;
}

// Notifications
function showNotification(title, body) {
  if (!settings.notifications) return;
  Audio.play('notify');
  const area = document.getElementById('notification-area');
  const notif = document.createElement('div');
  notif.className = 'notification';
  notif.innerHTML = `<div class="notif-title">${title}</div>${body}`;
  area.appendChild(notif);
  setTimeout(() => notif.classList.add('show'), 50);
  setTimeout(() => {
    notif.classList.remove('show');
    setTimeout(() => notif.remove(), 300);
  }, 4000);
}

// Window dragging
document.addEventListener('mousedown', e => {
  Audio.init();
  const header = e.target.closest('.window-header');
  if (header && !e.target.classList.contains('dot')) {
    const win = header.closest('.window');
    dragWindow = win;
    const rect = win.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    const name = win.id.replace('win-', '');
    bringToFront(name);
    e.preventDefault();
  }
});

document.addEventListener('mousemove', e => {
  if (dragWindow) {
    dragWindow.style.left = (e.clientX - dragOffsetX) + 'px';
    dragWindow.style.top = (e.clientY - dragOffsetY) + 'px';
  }
});

document.addEventListener('mouseup', () => { dragWindow = null; });

// Close/Min/Max dots
document.querySelectorAll('.dot-close').forEach(dot => {
  dot.addEventListener('click', () => closeApp(dot.dataset.win));
});
document.querySelectorAll('.dot-min').forEach(dot => {
  dot.addEventListener('click', () => {
    const win = document.getElementById('win-' + dot.dataset.win);
    win.style.display = 'none';
    Audio.play('click');
  });
});
document.querySelectorAll('.dot-max').forEach(dot => {
  dot.addEventListener('click', () => {
    const win = document.getElementById('win-' + dot.dataset.win);
    if (win.style.width === '100%') {
      win.style.width = ''; win.style.height = '';
      win.style.left = '200px'; win.style.top = '50px';
    } else {
      win.style.width = '100%'; win.style.height = 'calc(100vh - 44px)';
      win.style.left = '0'; win.style.top = '0';
    }
    Audio.play('click');
  });
});

// Desktop icons
document.querySelectorAll('.desktop-icon').forEach(icon => {
  icon.addEventListener('dblclick', () => openApp(icon.dataset.app));
  icon.addEventListener('click', () => {
    document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
    icon.classList.add('selected');
    Audio.play('click');
  });
});

// Start menu
document.getElementById('start-btn').addEventListener('click', e => {
  e.stopPropagation();
  const menu = document.getElementById('start-menu');
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  Audio.play('click');
});

document.querySelectorAll('#start-menu .menu-item').forEach(item => {
  item.addEventListener('click', () => {
    openApp(item.dataset.app);
    document.getElementById('start-menu').style.display = 'none';
  });
});

document.addEventListener('click', e => {
  if (!e.target.closest('#start-menu') && !e.target.closest('#start-btn')) {
    document.getElementById('start-menu').style.display = 'none';
  }
  document.getElementById('context-menu').style.display = 'none';
});

// Context menu
document.getElementById('desktop').addEventListener('contextmenu', e => {
  if (e.target.closest('.window') || e.target.closest('#taskbar')) return;
  e.preventDefault();
  const menu = document.getElementById('context-menu');
  menu.style.display = 'block';
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
});

document.querySelectorAll('.ctx-item').forEach(item => {
  item.addEventListener('click', () => {
    const action = item.dataset.action;
    if (action === 'terminal') openApp('terminal');
    if (action === 'settings') openApp('settings');
    if (action === 'wallpaper') {
      const styles = ['stars', 'matrix', 'waves', 'particles'];
      const idx = styles.indexOf(settings.wallpaperStyle);
      settings.wallpaperStyle = styles[(idx + 1) % styles.length];
      document.getElementById('wallpaper-style').value = settings.wallpaperStyle;
      saveSettings();
    }
    if (action === 'refresh') showNotification('Desktop', 'Refreshed.');
    if (action === 'about') showNotification('About', 'RapptrOS 2.1 - Desktop Environment Simulator');
    document.getElementById('context-menu').style.display = 'none';
  });
});

// ============ TERMINAL ============
const terminalOutput = document.getElementById('terminal-output');
const terminalInput = document.getElementById('terminal-input');
const termHistory = [];
let termHistIdx = -1;

const commands = {
  help: () => 'Commands: help, echo, date, clear, whoami, uname, ls, cat, uptime, neofetch, fortune, matrix, exit',
  echo: (args) => args.join(' '),
  date: () => new Date().toString(),
  clear: () => { terminalOutput.innerHTML = ''; return null; },
  whoami: () => 'rapptr@zoo',
  uname: () => 'RapptrOS 2.1 (x86_64)',
  uptime: () => {
    const s = Math.floor(performance.now() / 1000);
    const m = Math.floor(s / 60);
    return `up ${m} minutes, ${s % 60} seconds`;
  },
  ls: () => 'Documents/  Downloads/  Pictures/  Music/  Desktop/  .config/',
  cat: (args) => {
    if (args[0] === '/etc/motd') return 'Welcome to RapptrOS. All systems nominal.';
    if (args[0] === '.bashrc') return 'export PS1="rapptr@zoo:~$ "\nalias ll="ls -la"';
    return `cat: ${args[0] || '(no file)'}: No such file`;
  },
  neofetch: () => `
   ____            __       ____  ____
  / __ \\__ ____  / /______/ __ \\/ __/
 / /_/ / _  / _ \\/ __/ __/ / / /\\ \\
/ _, _/ /_/ /  __/ /_/ / / /_/ /___/
/_/ |_|\\__,_/\\___/\\__/_/  \\____/____/

OS: RapptrOS 2.1
Host: Browser Runtime
Kernel: JavaScript V8
Shell: RapptrSH 1.0
Resolution: ${window.innerWidth}x${window.innerHeight}
Theme: Dark Mode
Terminal: RapptrTerm`,
  fortune: () => {
    const fortunes = [
      'The best code is no code at all.',
      'There are only two hard things in CS: cache invalidation, naming things, and off-by-one errors.',
      'It works on my machine.',
      'Have you tried turning it off and on again?',
      'The cloud is just someone else\'s computer.',
      'There is no place like 127.0.0.1'
    ];
    return fortunes[Math.floor(Math.random() * fortunes.length)];
  },
  matrix: () => {
    settings.wallpaperStyle = 'matrix';
    document.getElementById('wallpaper-style').value = 'matrix';
    return 'Wallpaper set to Matrix mode.';
  },
  exit: () => { closeApp('terminal'); return null; }
};

terminalInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    const cmd = terminalInput.value.trim();
    if (!cmd) return;
    termHistory.push(cmd);
    termHistIdx = termHistory.length;

    const parts = cmd.split(/\s+/);
    const name = parts[0].toLowerCase();
    const args = parts.slice(1);

    // Echo the command
    const cmdLine = document.createElement('div');
    cmdLine.innerHTML = `<span class="prompt">rapptr@zoo:~$ </span>${cmd}`;
    terminalInput.parentElement.before(cmdLine);

    if (commands[name]) {
      const result = commands[name](args);
      if (result !== null && result !== undefined) {
        const out = document.createElement('div');
        out.style.whiteSpace = 'pre-wrap';
        out.textContent = result;
        terminalInput.parentElement.before(out);
      }
    } else {
      const out = document.createElement('div');
      out.style.color = '#ff5555';
      out.textContent = `${name}: command not found`;
      terminalInput.parentElement.before(out);
    }

    terminalInput.value = '';
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
    Audio.play('key');
  }
  if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (termHistIdx > 0) {
      termHistIdx--;
      terminalInput.value = termHistory[termHistIdx];
    }
  }
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (termHistIdx < termHistory.length - 1) {
      termHistIdx++;
      terminalInput.value = termHistory[termHistIdx];
    } else {
      termHistIdx = termHistory.length;
      terminalInput.value = '';
    }
  }
});

// ============ CALCULATOR ============
let calcDisplay = '0';
let calcOp = null;
let calcPrev = null;
let calcNew = true;

document.querySelectorAll('.calc-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const val = btn.dataset.val;
    Audio.play('click');

    if (val === 'C') {
      calcDisplay = '0'; calcOp = null; calcPrev = null; calcNew = true;
    } else if (val === 'del') {
      calcDisplay = calcDisplay.length > 1 ? calcDisplay.slice(0, -1) : '0';
    } else if ('+-*/%'.includes(val)) {
      calcPrev = parseFloat(calcDisplay);
      calcOp = val;
      calcNew = true;
    } else if (val === '=') {
      if (calcOp && calcPrev !== null) {
        const curr = parseFloat(calcDisplay);
        let result;
        switch(calcOp) {
          case '+': result = calcPrev + curr; break;
          case '-': result = calcPrev - curr; break;
          case '*': result = calcPrev * curr; break;
          case '/': result = curr !== 0 ? calcPrev / curr : 'ERR'; break;
          case '%': result = calcPrev % curr; break;
        }
        calcDisplay = String(result);
        calcOp = null; calcPrev = null; calcNew = true;
      }
    } else {
      if (calcNew) { calcDisplay = val; calcNew = false; }
      else calcDisplay += val;
    }
    document.getElementById('calc-display').textContent = calcDisplay;
  });
});

// ============ FILE BROWSER ============
const virtualFS = {
  'Documents': { type: 'dir', children: {
    'notes.txt': { type: 'file', size: '2.1 KB', content: 'My personal notes' },
    'todo.md': { type: 'file', size: '856 B', content: '# TODO\n- Build something\n- Ship it' },
    'ideas.txt': { type: 'file', size: '1.3 KB', content: 'Game ideas:\n1. Space shooter\n2. Puzzle game' }
  }},
  'Downloads': { type: 'dir', children: {
    'wallpaper.png': { type: 'file', size: '4.2 MB' },
    'update-2.1.pkg': { type: 'file', size: '12.8 MB' }
  }},
  'Pictures': { type: 'dir', children: {
    'screenshot.png': { type: 'file', size: '1.8 MB' },
    'avatar.jpg': { type: 'file', size: '245 KB' }
  }},
  'Music': { type: 'dir', children: {
    'ambient.wav': { type: 'file', size: '8.4 MB' }
  }},
  '.config': { type: 'dir', children: {
    'settings.json': { type: 'file', size: '512 B' },
    'theme.css': { type: 'file', size: '1.1 KB' }
  }}
};

let currentPath = [];

function populateFiles() {
  const list = document.getElementById('file-list');
  let dir = virtualFS;
  for (const p of currentPath) {
    if (dir[p] && dir[p].children) dir = dir[p].children;
  }

  let html = '';
  if (currentPath.length > 0) {
    html += `<div class="file-item" data-action="up"><span class="fi-icon">&#8592;</span><span class="fi-name">..</span></div>`;
  }
  html += `<div style="padding:4px 10px;color:#555;font-size:11px;">/${currentPath.join('/')}</div>`;

  for (const [name, item] of Object.entries(dir)) {
    const icon = item.type === 'dir' ? '&#128193;' : '&#128196;';
    const size = item.size || '';
    html += `<div class="file-item" data-name="${name}" data-type="${item.type}">
      <span class="fi-icon">${icon}</span>
      <span class="fi-name">${name}</span>
      <span class="fi-size">${size}</span>
    </div>`;
  }
  list.innerHTML = html;

  list.querySelectorAll('.file-item').forEach(item => {
    item.addEventListener('dblclick', () => {
      if (item.dataset.action === 'up') {
        currentPath.pop();
        populateFiles();
      } else if (item.dataset.type === 'dir') {
        currentPath.push(item.dataset.name);
        populateFiles();
      } else {
        showNotification('File', `Opened: ${item.dataset.name}`);
      }
      Audio.play('click');
    });
  });
}

// ============ PAINT ============
let paintCanvas, paintCtx, paintColor = '#ff0000', paintSize = 3, isPainting = false, paintLast = null;

function initPaint() {
  paintCanvas = document.getElementById('paint-canvas');
  paintCtx = paintCanvas.getContext('2d');
  const parent = paintCanvas.parentElement;
  paintCanvas.width = parent.clientWidth - 8;
  paintCanvas.height = parent.clientHeight - 40;
  paintCtx.fillStyle = '#1a1a2e';
  paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
}

document.querySelectorAll('.paint-color').forEach(c => {
  c.addEventListener('click', () => {
    document.querySelectorAll('.paint-color').forEach(x => x.style.borderColor = 'transparent');
    c.style.borderColor = '#fff';
    paintColor = c.dataset.color;
    Audio.play('click');
  });
});

document.getElementById('paint-size').addEventListener('input', e => { paintSize = parseInt(e.target.value); });
document.getElementById('paint-clear').addEventListener('click', () => {
  if (paintCtx) {
    paintCtx.fillStyle = '#1a1a2e';
    paintCtx.fillRect(0, 0, paintCanvas.width, paintCanvas.height);
  }
});

document.getElementById('paint-canvas').addEventListener('mousedown', e => {
  isPainting = true;
  const rect = paintCanvas.getBoundingClientRect();
  paintLast = { x: e.clientX - rect.left, y: e.clientY - rect.top };
  paintCtx.beginPath();
  paintCtx.arc(paintLast.x, paintLast.y, paintSize, 0, Math.PI * 2);
  paintCtx.fillStyle = paintColor;
  paintCtx.fill();
});

document.getElementById('paint-canvas').addEventListener('mousemove', e => {
  if (!isPainting) return;
  const rect = paintCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  paintCtx.beginPath();
  paintCtx.moveTo(paintLast.x, paintLast.y);
  paintCtx.lineTo(x, y);
  paintCtx.strokeStyle = paintColor;
  paintCtx.lineWidth = paintSize * 2;
  paintCtx.lineCap = 'round';
  paintCtx.stroke();
  paintLast = { x, y };
});

document.addEventListener('mouseup', () => { isPainting = false; });

// ============ SETTINGS ============
document.querySelectorAll('.toggle').forEach(toggle => {
  toggle.addEventListener('click', () => {
    toggle.classList.toggle('on');
    const key = toggle.dataset.setting;
    settings[key] = toggle.classList.contains('on');
    if (key === 'sound') Audio.enabled = settings.sound;
    saveSettings();
    Audio.play('click');
  });
});

document.getElementById('wallpaper-style').addEventListener('change', e => {
  settings.wallpaperStyle = e.target.value;
  saveSettings();
});

function saveSettings() {
  localStorage.setItem('rapptros-settings', JSON.stringify(settings));
}
function loadSettings() {
  const saved = localStorage.getItem('rapptros-settings');
  if (saved) {
    try {
      const s = JSON.parse(saved);
      Object.assign(settings, s);
      Audio.enabled = settings.sound;
      document.querySelectorAll('.toggle').forEach(t => {
        t.classList.toggle('on', settings[t.dataset.setting]);
      });
      document.getElementById('wallpaper-style').value = settings.wallpaperStyle;
    } catch(e) {}
  }
  // Load notepad
  const note = localStorage.getItem('rapptros-notepad');
  if (note) document.getElementById('notepad-text').value = note;
}

// Auto-save notepad
document.getElementById('notepad-text').addEventListener('input', () => {
  localStorage.setItem('rapptros-notepad', document.getElementById('notepad-text').value);
});

// ============ ANIMATED WALLPAPER ============
const wpCanvas = document.getElementById('wallpaper-canvas');
const wpCtx = wpCanvas.getContext('2d');
let wpStars = [], wpMatrix = [], wpParticles = [], wpWavePhase = 0;

function initWallpaper() {
  wpCanvas.width = window.innerWidth;
  wpCanvas.height = window.innerHeight;

  // Stars
  wpStars = [];
  for (let i = 0; i < 200; i++) {
    wpStars.push({
      x: Math.random() * wpCanvas.width,
      y: Math.random() * wpCanvas.height,
      size: Math.random() * 2,
      speed: 0.1 + Math.random() * 0.3,
      brightness: Math.random()
    });
  }

  // Matrix columns
  wpMatrix = [];
  const cols = Math.floor(wpCanvas.width / 14);
  for (let i = 0; i < cols; i++) {
    wpMatrix.push({
      x: i * 14,
      y: Math.random() * wpCanvas.height,
      speed: 2 + Math.random() * 6,
      chars: []
    });
  }

  // Particles
  wpParticles = [];
  for (let i = 0; i < 80; i++) {
    wpParticles.push({
      x: Math.random() * wpCanvas.width,
      y: Math.random() * wpCanvas.height,
      vx: (Math.random() - 0.5) * 0.5,
      vy: (Math.random() - 0.5) * 0.5,
      size: 1 + Math.random() * 2,
      hue: Math.random() * 360
    });
  }
}

function drawWallpaper() {
  if (!settings.wallpaper) {
    wpCtx.fillStyle = '#0f0c29';
    wpCtx.fillRect(0, 0, wpCanvas.width, wpCanvas.height);
    return;
  }

  const style = settings.wallpaperStyle;

  if (style === 'stars') {
    wpCtx.fillStyle = 'rgba(15,12,41,0.15)';
    wpCtx.fillRect(0, 0, wpCanvas.width, wpCanvas.height);
    for (const s of wpStars) {
      s.brightness += (Math.random() - 0.5) * 0.05;
      s.brightness = Math.max(0.2, Math.min(1, s.brightness));
      s.y += s.speed;
      if (s.y > wpCanvas.height) { s.y = 0; s.x = Math.random() * wpCanvas.width; }
      wpCtx.beginPath();
      wpCtx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
      wpCtx.fillStyle = `rgba(200,200,255,${s.brightness * 0.6})`;
      wpCtx.fill();
    }
  } else if (style === 'matrix') {
    wpCtx.fillStyle = 'rgba(0,0,0,0.05)';
    wpCtx.fillRect(0, 0, wpCanvas.width, wpCanvas.height);
    wpCtx.font = '12px monospace';
    for (const col of wpMatrix) {
      const char = String.fromCharCode(0x30A0 + Math.random() * 96);
      wpCtx.fillStyle = `rgba(0,255,100,${0.3 + Math.random() * 0.4})`;
      wpCtx.fillText(char, col.x, col.y);
      col.y += col.speed;
      if (col.y > wpCanvas.height && Math.random() > 0.98) col.y = 0;
    }
  } else if (style === 'waves') {
    wpCtx.fillStyle = 'rgba(15,12,41,0.03)';
    wpCtx.fillRect(0, 0, wpCanvas.width, wpCanvas.height);
    wpWavePhase += 0.02;
    for (let i = 0; i < 5; i++) {
      wpCtx.beginPath();
      wpCtx.moveTo(0, wpCanvas.height / 2);
      for (let x = 0; x < wpCanvas.width; x += 4) {
        const y = wpCanvas.height / 2 + Math.sin(x * 0.008 + wpWavePhase + i * 0.8) * (60 + i * 20) +
                  Math.sin(x * 0.003 + wpWavePhase * 0.7) * 30;
        wpCtx.lineTo(x, y);
      }
      const hue = (wpWavePhase * 20 + i * 50) % 360;
      wpCtx.strokeStyle = `hsla(${hue}, 60%, 50%, 0.15)`;
      wpCtx.lineWidth = 2;
      wpCtx.stroke();
    }
  } else if (style === 'particles') {
    wpCtx.fillStyle = 'rgba(15,12,41,0.05)';
    wpCtx.fillRect(0, 0, wpCanvas.width, wpCanvas.height);
    for (const p of wpParticles) {
      p.x += p.vx; p.y += p.vy;
      p.hue = (p.hue + 0.5) % 360;
      if (p.x < 0) p.x = wpCanvas.width;
      if (p.x > wpCanvas.width) p.x = 0;
      if (p.y < 0) p.y = wpCanvas.height;
      if (p.y > wpCanvas.height) p.y = 0;
      wpCtx.beginPath();
      wpCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      wpCtx.fillStyle = `hsla(${p.hue}, 70%, 60%, 0.4)`;
      wpCtx.fill();
      // Connect nearby
      for (const q of wpParticles) {
        const dx = p.x - q.x, dy = p.y - q.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 100 && dist > 0) {
          wpCtx.beginPath();
          wpCtx.moveTo(p.x, p.y);
          wpCtx.lineTo(q.x, q.y);
          wpCtx.strokeStyle = `hsla(${p.hue}, 60%, 50%, ${0.1 * (1 - dist/100)})`;
          wpCtx.lineWidth = 0.5;
          wpCtx.stroke();
        }
      }
    }
  }

  requestAnimationFrame(drawWallpaper);
}

window.addEventListener('resize', () => {
  wpCanvas.width = window.innerWidth;
  wpCanvas.height = window.innerHeight;
});

// Touch support for window dragging
document.addEventListener('touchstart', e => {
  Audio.init();
  const header = e.target.closest('.window-header');
  if (header && !e.target.classList.contains('dot')) {
    const win = header.closest('.window');
    dragWindow = win;
    const rect = win.getBoundingClientRect();
    const touch = e.touches[0];
    dragOffsetX = touch.clientX - rect.left;
    dragOffsetY = touch.clientY - rect.top;
    bringToFront(win.id.replace('win-', ''));
  }
}, { passive: true });

document.addEventListener('touchmove', e => {
  if (dragWindow) {
    const touch = e.touches[0];
    dragWindow.style.left = (touch.clientX - dragOffsetX) + 'px';
    dragWindow.style.top = (touch.clientY - dragOffsetY) + 'px';
  }
}, { passive: true });

document.addEventListener('touchend', () => { dragWindow = null; });

// Keyboard shortcuts
window.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('start-menu').style.display = 'none';
    document.getElementById('context-menu').style.display = 'none';
  }
});

// Start
boot();
requestAnimationFrame(drawWallpaper);
</script>
</body>
</html>