<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Advanced color picker with HSL wheel, palette generator (complementary, triadic, analogous), WCAG contrast checker, and format conversion (HEX, RGB, HSL, CMYK). Save and export color palettes.">
    <title>Color Picker & Palette Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --success-color: #28a745;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #404040;
            --accent-color: #4dabf7;
            --accent-hover: #339af0;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow);
        }

        h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--accent-color);
            color: white;
        }

        button:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        button.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        button.icon-btn {
            padding: 0.6rem;
            font-size: 1.2rem;
        }

        main {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        /* Color Picker */
        .picker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .color-wheel-container {
            position: relative;
            margin: 1rem 0;
        }

        #colorWheel {
            display: block;
            cursor: crosshair;
            border-radius: 8px;
        }

        .color-preview {
            width: 100%;
            height: 100px;
            border-radius: 12px;
            border: 3px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow);
            margin: 1.5rem 0;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-preview:hover {
            transform: scale(1.02);
        }

        /* Format Display */
        .formats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .format-box {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .format-box:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .format-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .format-value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 1rem;
            word-break: break-all;
        }

        .copy-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--success-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow);
            z-index: 1000;
            animation: fadeInOut 1.5s;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        /* Palette Generator */
        .palette-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .palette-type-btn {
            padding: 0.75rem;
            font-size: 0.9rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .palette-type-btn.active {
            background: var(--accent-color);
            color: white;
        }

        .palette-display {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .palette-color {
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .palette-color:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .palette-color-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.7rem;
            padding: 0.25rem;
            text-align: center;
            font-family: monospace;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .palette-color:hover .palette-color-label {
            opacity: 1;
        }

        /* Contrast Checker */
        .contrast-grid {
            display: grid;
            gap: 1rem;
        }

        .contrast-box {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contrast-info {
            flex: 1;
        }

        .contrast-ratio {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .contrast-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .contrast-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-pass {
            background: var(--success-color);
            color: white;
        }

        .badge-fail {
            background: #dc3545;
            color: white;
        }

        .contrast-preview {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
            border: 2px solid var(--border-color);
        }

        /* Recent Colors */
        .recent-colors {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .recent-color {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid var(--border-color);
        }

        .recent-color:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px var(--shadow);
        }

        /* Saved Palettes */
        .saved-palettes-list {
            display: grid;
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .saved-palette {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 12px;
        }

        .saved-palette-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .saved-palette-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .saved-palette-colors {
            display: flex;
            gap: 0.5rem;
        }

        .saved-palette-color {
            flex: 1;
            height: 50px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px var(--shadow);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        /* Responsive */
        @media (max-width: 968px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .formats-grid {
                grid-template-columns: 1fr;
            }

            .palette-display {
                grid-template-columns: repeat(3, 1fr);
            }

            header {
                padding: 1rem;
                flex-wrap: wrap;
            }

            main {
                padding: 1rem;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
    </style>
</head>
<body data-theme="light">
    <header>
        <h1>üé® Color Picker & Palette Generator</h1>
        <div class="header-actions">
            <button class="secondary icon-btn" id="themeBtn" title="Toggle Theme">üåô</button>
            <button class="secondary icon-btn" id="helpBtn" title="Help">‚ùì</button>
        </div>
    </header>

    <main>
        <!-- Top Row -->
        <div class="grid">
            <!-- Color Picker -->
            <div class="card">
                <div class="card-title">üé® Color Picker</div>
                <div class="picker-container">
                    <canvas id="colorWheel" width="300" height="300"></canvas>
                    <div class="color-preview" id="colorPreview" title="Click to use as base color"></div>

                    <div class="formats-grid">
                        <div class="format-box" data-format="hex" title="Click to copy">
                            <div class="format-label">HEX</div>
                            <div class="format-value" id="hexValue">#000000</div>
                        </div>
                        <div class="format-box" data-format="rgb" title="Click to copy">
                            <div class="format-label">RGB</div>
                            <div class="format-value" id="rgbValue">rgb(0, 0, 0)</div>
                        </div>
                        <div class="format-box" data-format="hsl" title="Click to copy">
                            <div class="format-label">HSL</div>
                            <div class="format-value" id="hslValue">hsl(0, 0%, 0%)</div>
                        </div>
                        <div class="format-box" data-format="cmyk" title="Click to copy">
                            <div class="format-label">CMYK</div>
                            <div class="format-value" id="cmykValue">cmyk(0%, 0%, 0%, 100%)</div>
                        </div>
                    </div>
                </div>

                <div class="card-title" style="margin-top: 2rem;">üïê Recent Colors</div>
                <div class="recent-colors" id="recentColors"></div>
            </div>

            <!-- Palette Generator -->
            <div class="card">
                <div class="card-title">üé≠ Palette Generator</div>

                <div class="palette-type-selector">
                    <button class="palette-type-btn active" data-type="complementary">Complementary</button>
                    <button class="palette-type-btn" data-type="triadic">Triadic</button>
                    <button class="palette-type-btn" data-type="analogous">Analogous</button>
                    <button class="palette-type-btn" data-type="monochromatic">Monochromatic</button>
                    <button class="palette-type-btn" data-type="split">Split-Comp</button>
                </div>

                <div class="palette-display" id="paletteDisplay"></div>

                <button id="savePaletteBtn" style="width: 100%; margin-top: 1rem;">üíæ Save Palette</button>

                <div class="card-title" style="margin-top: 2rem;">üìö Saved Palettes</div>
                <div class="saved-palettes-list" id="savedPalettesList"></div>
            </div>
        </div>

        <!-- Bottom Row -->
        <div class="grid">
            <!-- Contrast Checker -->
            <div class="card">
                <div class="card-title">‚ôø WCAG Contrast Checker</div>
                <div class="contrast-grid">
                    <div class="contrast-box">
                        <div class="contrast-info">
                            <div class="contrast-ratio" id="contrastRatioWhite">21:1</div>
                            <div class="contrast-badges" id="contrastBadgesWhite"></div>
                        </div>
                        <div class="contrast-preview" id="contrastPreviewWhite" style="background: white; color: black;">
                            Aa
                        </div>
                    </div>
                    <div class="contrast-box">
                        <div class="contrast-info">
                            <div class="contrast-ratio" id="contrastRatioBlack">1:1</div>
                            <div class="contrast-badges" id="contrastBadgesBlack"></div>
                        </div>
                        <div class="contrast-preview" id="contrastPreviewBlack" style="background: black; color: white;">
                            Aa
                        </div>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; font-size: 0.9rem; color: var(--text-secondary);">
                    <strong>WCAG Guidelines:</strong><br>
                    ‚Ä¢ AA Normal Text: 4.5:1<br>
                    ‚Ä¢ AA Large Text: 3:1<br>
                    ‚Ä¢ AAA Normal Text: 7:1<br>
                    ‚Ä¢ AAA Large Text: 4.5:1
                </div>
            </div>

            <!-- Export/Import -->
            <div class="card">
                <div class="card-title">üíæ Import / Export</div>
                <div style="display: grid; gap: 1rem;">
                    <button id="exportPalettesBtn">üì• Export All Palettes</button>
                    <button class="secondary" id="importPalettesBtn">üì§ Import Palettes</button>
                    <button class="secondary" id="clearDataBtn">üóëÔ∏è Clear All Data</button>
                </div>

                <div class="card-title" style="margin-top: 2rem;">‚ÑπÔ∏è Quick Guide</div>
                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; font-size: 0.9rem; line-height: 1.6;">
                    ‚Ä¢ Click on the color wheel to pick a color<br>
                    ‚Ä¢ Click any color format to copy to clipboard<br>
                    ‚Ä¢ Select a palette type to generate harmonies<br>
                    ‚Ä¢ Click palette colors to set as base color<br>
                    ‚Ä¢ Save palettes with custom names<br>
                    ‚Ä¢ Recent colors are automatically tracked
                </div>
            </div>
        </div>
    </main>

    <!-- Save Palette Modal -->
    <div class="modal" id="savePaletteModal">
        <div class="modal-content">
            <div class="modal-header">üíæ Save Palette</div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Palette Name:</label>
                <input type="text" id="paletteNameInput" placeholder="My Beautiful Palette" maxlength="50">
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('savePaletteModal')">Cancel</button>
                <button id="confirmSavePaletteBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">‚ùì Help</div>
            <div style="line-height: 1.8;">
                <h3 style="margin: 1rem 0 0.5rem;">Color Picker</h3>
                <p>Click anywhere on the color wheel to select a color. The outer ring controls hue, while the inner area adjusts saturation and lightness.</p>

                <h3 style="margin: 1rem 0 0.5rem;">Palette Types</h3>
                <ul style="margin-left: 1.5rem; color: var(--text-secondary);">
                    <li><strong>Complementary:</strong> Opposite on color wheel</li>
                    <li><strong>Triadic:</strong> Three evenly spaced colors</li>
                    <li><strong>Analogous:</strong> Adjacent colors</li>
                    <li><strong>Monochromatic:</strong> Same hue, different lightness</li>
                    <li><strong>Split-Complementary:</strong> Base + two adjacent to complement</li>
                </ul>

                <h3 style="margin: 1rem 0 0.5rem;">Contrast Ratios</h3>
                <p>Higher contrast ratios mean better readability. WCAG AA requires 4.5:1 for normal text, 3:1 for large text.</p>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('helpModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">üì§ Import Palettes</div>
            <div>
                <p style="margin-bottom: 1rem;">Select a JSON file to import palettes:</p>
                <input type="file" id="importFile" accept=".json" style="width: 100%;">
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('importModal')">Cancel</button>
                <button id="confirmImportBtn">Import</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const APP_STATE = {
            currentColor: { h: 0, s: 50, l: 50 },
            paletteType: 'complementary',
            recentColors: [],
            savedPalettes: []
        };

        // DOM Elements
        const canvas = document.getElementById('colorWheel');
        const ctx = canvas.getContext('2d');
        const colorPreview = document.getElementById('colorPreview');

        // Initialize
        function init() {
            loadFromStorage();
            drawColorWheel();
            updateColorDisplay();
            updatePalette();
            updateRecentColors();
            updateSavedPalettes();
            setupEventListeners();
        }

        // Storage
        function loadFromStorage() {
            const stored = localStorage.getItem('colorPickerData');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    APP_STATE.recentColors = data.recentColors || [];
                    APP_STATE.savedPalettes = data.savedPalettes || [];

                    const theme = data.theme || 'light';
                    document.body.setAttribute('data-theme', theme);
                    document.getElementById('themeBtn').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                } catch (e) {
                    console.error('Failed to load data:', e);
                }
            }
        }

        function saveToStorage() {
            try {
                const data = {
                    recentColors: APP_STATE.recentColors,
                    savedPalettes: APP_STATE.savedPalettes,
                    theme: document.body.getAttribute('data-theme')
                };
                localStorage.setItem('colorPickerData', JSON.stringify(data));
            } catch (e) {
                console.error('Failed to save data:', e);
            }
        }

        // Color Wheel Drawing
        function drawColorWheel() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = canvas.width / 2 - 10;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw hue circle
            for (let angle = 0; angle < 360; angle++) {
                const startAngle = (angle - 90) * Math.PI / 180;
                const endAngle = (angle - 89) * Math.PI / 180;

                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.arc(centerX, centerY, radius * 0.7, endAngle, startAngle, true);
                ctx.closePath();

                const color = hslToRgb(angle, 100, 50);
                ctx.fillStyle = `rgb(${color.r}, ${color.g}, ${color.b})`;
                ctx.fill();
            }

            // Draw saturation/lightness square
            const squareSize = radius * 1.2;
            const gradient = ctx.createLinearGradient(
                centerX - squareSize / 2,
                centerY,
                centerX + squareSize / 2,
                centerY
            );

            gradient.addColorStop(0, 'white');
            gradient.addColorStop(0.5, hslToHex(APP_STATE.currentColor.h, 100, 50));
            gradient.addColorStop(1, 'black');

            ctx.fillStyle = gradient;
            ctx.fillRect(
                centerX - squareSize / 2,
                centerY - squareSize / 2,
                squareSize,
                squareSize
            );

            // Draw lightness gradient overlay
            const lightnessGradient = ctx.createLinearGradient(
                centerX,
                centerY - squareSize / 2,
                centerX,
                centerY + squareSize / 2
            );

            lightnessGradient.addColorStop(0, 'rgba(255, 255, 255, 0.5)');
            lightnessGradient.addColorStop(0.5, 'rgba(255, 255, 255, 0)');
            lightnessGradient.addColorStop(0.5, 'rgba(0, 0, 0, 0)');
            lightnessGradient.addColorStop(1, 'rgba(0, 0, 0, 0.5)');

            ctx.fillStyle = lightnessGradient;
            ctx.fillRect(
                centerX - squareSize / 2,
                centerY - squareSize / 2,
                squareSize,
                squareSize
            );
        }

        // Color Conversions
        function hslToRgb(h, s, l) {
            s /= 100;
            l /= 100;

            const c = (1 - Math.abs(2 * l - 1)) * s;
            const x = c * (1 - Math.abs((h / 60) % 2 - 1));
            const m = l - c / 2;

            let r, g, b;

            if (h < 60) {
                [r, g, b] = [c, x, 0];
            } else if (h < 120) {
                [r, g, b] = [x, c, 0];
            } else if (h < 180) {
                [r, g, b] = [0, c, x];
            } else if (h < 240) {
                [r, g, b] = [0, x, c];
            } else if (h < 300) {
                [r, g, b] = [x, 0, c];
            } else {
                [r, g, b] = [c, 0, x];
            }

            return {
                r: Math.round((r + m) * 255),
                g: Math.round((g + m) * 255),
                b: Math.round((b + m) * 255)
            };
        }

        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;

            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const diff = max - min;

            let h = 0;
            let s = 0;
            const l = (max + min) / 2;

            if (diff !== 0) {
                s = l > 0.5 ? diff / (2 - max - min) : diff / (max + min);

                if (max === r) {
                    h = ((g - b) / diff + (g < b ? 6 : 0)) / 6;
                } else if (max === g) {
                    h = ((b - r) / diff + 2) / 6;
                } else {
                    h = ((r - g) / diff + 4) / 6;
                }
            }

            return {
                h: Math.round(h * 360),
                s: Math.round(s * 100),
                l: Math.round(l * 100)
            };
        }

        function hslToHex(h, s, l) {
            const rgb = hslToRgb(h, s, l);
            return '#' + [rgb.r, rgb.g, rgb.b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function rgbToCmyk(r, g, b) {
            if (r === 0 && g === 0 && b === 0) {
                return { c: 0, m: 0, y: 0, k: 100 };
            }

            const rNorm = r / 255;
            const gNorm = g / 255;
            const bNorm = b / 255;

            const k = 1 - Math.max(rNorm, gNorm, bNorm);
            const c = (1 - rNorm - k) / (1 - k);
            const m = (1 - gNorm - k) / (1 - k);
            const y = (1 - bNorm - k) / (1 - k);

            return {
                c: Math.round(c * 100),
                m: Math.round(m * 100),
                y: Math.round(y * 100),
                k: Math.round(k * 100)
            };
        }

        function getRelativeLuminance(r, g, b) {
            const [rs, gs, bs] = [r, g, b].map(c => {
                c /= 255;
                return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
            });
            return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
        }

        function getContrastRatio(color1, color2) {
            const l1 = getRelativeLuminance(color1.r, color1.g, color1.b);
            const l2 = getRelativeLuminance(color2.r, color2.g, color2.b);
            const lighter = Math.max(l1, l2);
            const darker = Math.min(l1, l2);
            return (lighter + 0.05) / (darker + 0.05);
        }

        // Color Display
        function updateColorDisplay() {
            const rgb = hslToRgb(APP_STATE.currentColor.h, APP_STATE.currentColor.s, APP_STATE.currentColor.l);
            const hex = hslToHex(APP_STATE.currentColor.h, APP_STATE.currentColor.s, APP_STATE.currentColor.l);
            const cmyk = rgbToCmyk(rgb.r, rgb.g, rgb.b);

            colorPreview.style.background = hex;

            document.getElementById('hexValue').textContent = hex;
            document.getElementById('rgbValue').textContent = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            document.getElementById('hslValue').textContent = `hsl(${APP_STATE.currentColor.h}, ${APP_STATE.currentColor.s}%, ${APP_STATE.currentColor.l}%)`;
            document.getElementById('cmykValue').textContent = `cmyk(${cmyk.c}%, ${cmyk.m}%, ${cmyk.y}%, ${cmyk.k}%)`;

            updateContrastChecker(rgb);
            addToRecentColors(hex);
        }

        function updateContrastChecker(currentRgb) {
            const white = { r: 255, g: 255, b: 255 };
            const black = { r: 0, g: 0, b: 0 };

            const ratioWhite = getContrastRatio(currentRgb, white);
            const ratioBlack = getContrastRatio(currentRgb, black);

            document.getElementById('contrastRatioWhite').textContent = ratioWhite.toFixed(2) + ':1';
            document.getElementById('contrastRatioBlack').textContent = ratioBlack.toFixed(2) + ':1';

            updateContrastBadges(ratioWhite, 'contrastBadgesWhite');
            updateContrastBadges(ratioBlack, 'contrastBadgesBlack');

            const currentHex = hslToHex(APP_STATE.currentColor.h, APP_STATE.currentColor.s, APP_STATE.currentColor.l);
            document.getElementById('contrastPreviewWhite').style.color = currentHex;
            document.getElementById('contrastPreviewBlack').style.color = currentHex;
        }

        function updateContrastBadges(ratio, elementId) {
            const badges = [];

            if (ratio >= 7) {
                badges.push('<span class="contrast-badge badge-pass">AAA Normal</span>');
            } else if (ratio >= 4.5) {
                badges.push('<span class="contrast-badge badge-pass">AA Normal</span>');
            } else {
                badges.push('<span class="contrast-badge badge-fail">Fail Normal</span>');
            }

            if (ratio >= 4.5) {
                badges.push('<span class="contrast-badge badge-pass">AAA Large</span>');
            } else if (ratio >= 3) {
                badges.push('<span class="contrast-badge badge-pass">AA Large</span>');
            } else {
                badges.push('<span class="contrast-badge badge-fail">Fail Large</span>');
            }

            document.getElementById(elementId).innerHTML = badges.join('');
        }

        // Palette Generation
        function generatePalette() {
            const baseHue = APP_STATE.currentColor.h;
            const colors = [APP_STATE.currentColor];

            switch(APP_STATE.paletteType) {
                case 'complementary':
                    colors.push({ h: (baseHue + 180) % 360, s: 50, l: 50 });
                    colors.push({ h: baseHue, s: 70, l: 60 });
                    colors.push({ h: (baseHue + 180) % 360, s: 70, l: 40 });
                    colors.push({ h: baseHue, s: 30, l: 70 });
                    break;

                case 'triadic':
                    colors.push({ h: (baseHue + 120) % 360, s: 50, l: 50 });
                    colors.push({ h: (baseHue + 240) % 360, s: 50, l: 50 });
                    colors.push({ h: baseHue, s: 70, l: 60 });
                    colors.push({ h: (baseHue + 120) % 360, s: 70, l: 40 });
                    break;

                case 'analogous':
                    colors.push({ h: (baseHue + 30) % 360, s: 50, l: 50 });
                    colors.push({ h: (baseHue - 30 + 360) % 360, s: 50, l: 50 });
                    colors.push({ h: (baseHue + 60) % 360, s: 50, l: 50 });
                    colors.push({ h: (baseHue - 60 + 360) % 360, s: 50, l: 50 });
                    break;

                case 'monochromatic':
                    colors.push({ h: baseHue, s: 50, l: 30 });
                    colors.push({ h: baseHue, s: 50, l: 40 });
                    colors.push({ h: baseHue, s: 50, l: 60 });
                    colors.push({ h: baseHue, s: 50, l: 70 });
                    break;

                case 'split':
                    colors.push({ h: (baseHue + 150) % 360, s: 50, l: 50 });
                    colors.push({ h: (baseHue + 210) % 360, s: 50, l: 50 });
                    colors.push({ h: baseHue, s: 70, l: 60 });
                    colors.push({ h: (baseHue + 180) % 360, s: 30, l: 40 });
                    break;
            }

            return colors;
        }

        function updatePalette() {
            const colors = generatePalette();
            const paletteDisplay = document.getElementById('paletteDisplay');

            paletteDisplay.innerHTML = colors.map(color => {
                const hex = hslToHex(color.h, color.s, color.l);
                return `
                    <div class="palette-color" style="background: ${hex};" data-hex="${hex}" data-h="${color.h}" data-s="${color.s}" data-l="${color.l}">
                        <div class="palette-color-label">${hex}</div>
                    </div>
                `;
            }).join('');

            // Add click listeners
            document.querySelectorAll('.palette-color').forEach(el => {
                el.addEventListener('click', () => {
                    APP_STATE.currentColor = {
                        h: parseInt(el.dataset.h),
                        s: parseInt(el.dataset.s),
                        l: parseInt(el.dataset.l)
                    };
                    drawColorWheel();
                    updateColorDisplay();
                    updatePalette();
                });
            });
        }

        // Recent Colors
        function addToRecentColors(hex) {
            if (APP_STATE.recentColors.includes(hex)) return;

            APP_STATE.recentColors.unshift(hex);
            if (APP_STATE.recentColors.length > 10) {
                APP_STATE.recentColors.pop();
            }

            updateRecentColors();
            saveToStorage();
        }

        function updateRecentColors() {
            const container = document.getElementById('recentColors');

            if (APP_STATE.recentColors.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.9rem;">No recent colors yet</div>';
                return;
            }

            container.innerHTML = APP_STATE.recentColors.map(hex => {
                const hsl = rgbToHsl(
                    parseInt(hex.slice(1, 3), 16),
                    parseInt(hex.slice(3, 5), 16),
                    parseInt(hex.slice(5, 7), 16)
                );

                return `<div class="recent-color" style="background: ${hex};" data-hex="${hex}" data-h="${hsl.h}" data-s="${hsl.s}" data-l="${hsl.l}" title="${hex}"></div>`;
            }).join('');

            document.querySelectorAll('.recent-color').forEach(el => {
                el.addEventListener('click', () => {
                    APP_STATE.currentColor = {
                        h: parseInt(el.dataset.h),
                        s: parseInt(el.dataset.s),
                        l: parseInt(el.dataset.l)
                    };
                    drawColorWheel();
                    updateColorDisplay();
                    updatePalette();
                });
            });
        }

        // Saved Palettes
        function savePalette() {
            const name = document.getElementById('paletteNameInput').value.trim();
            if (!name) {
                alert('Please enter a palette name');
                return;
            }

            const colors = generatePalette().map(c => hslToHex(c.h, c.s, c.l));

            APP_STATE.savedPalettes.unshift({
                id: Date.now(),
                name: name,
                colors: colors,
                created: new Date().toISOString()
            });

            saveToStorage();
            updateSavedPalettes();
            closeModal('savePaletteModal');
            document.getElementById('paletteNameInput').value = '';
        }

        function updateSavedPalettes() {
            const container = document.getElementById('savedPalettesList');

            if (APP_STATE.savedPalettes.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No saved palettes yet</div>';
                return;
            }

            container.innerHTML = APP_STATE.savedPalettes.map(palette => {
                return `
                    <div class="saved-palette">
                        <div class="saved-palette-header">
                            <span class="saved-palette-name">${palette.name}</span>
                            <button class="secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;" onclick="deletePalette(${palette.id})">üóëÔ∏è</button>
                        </div>
                        <div class="saved-palette-colors">
                            ${palette.colors.map(color => `<div class="saved-palette-color" style="background: ${color};" title="${color}"></div>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deletePalette(id) {
            if (!confirm('Delete this palette?')) return;

            APP_STATE.savedPalettes = APP_STATE.savedPalettes.filter(p => p.id !== id);
            saveToStorage();
            updateSavedPalettes();
        }

        // Copy to Clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showCopyFeedback();
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        function showCopyFeedback() {
            const feedback = document.createElement('div');
            feedback.className = 'copy-feedback';
            feedback.textContent = '‚úì Copied to clipboard!';
            document.body.appendChild(feedback);

            setTimeout(() => {
                feedback.remove();
            }, 1500);
        }

        // Event Listeners
        function setupEventListeners() {
            // Canvas click
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const angle = (Math.atan2(dy, dx) * 180 / Math.PI + 450) % 360;

                const radius = canvas.width / 2 - 10;

                if (distance > radius * 0.7 && distance < radius) {
                    // Clicked on hue ring
                    APP_STATE.currentColor.h = Math.round(angle);
                } else if (distance <= radius * 0.6) {
                    // Clicked in saturation/lightness area
                    const squareSize = radius * 1.2;
                    const relX = (x - (centerX - squareSize / 2)) / squareSize;
                    const relY = (y - (centerY - squareSize / 2)) / squareSize;

                    APP_STATE.currentColor.s = Math.round(Math.max(0, Math.min(100, relX * 100)));
                    APP_STATE.currentColor.l = Math.round(Math.max(0, Math.min(100, (1 - relY) * 100)));
                }

                drawColorWheel();
                updateColorDisplay();
                updatePalette();
            });

            // Format boxes click
            document.querySelectorAll('.format-box').forEach(box => {
                box.addEventListener('click', () => {
                    const value = box.querySelector('.format-value').textContent;
                    copyToClipboard(value);
                });
            });

            // Palette type selection
            document.querySelectorAll('.palette-type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.palette-type-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    APP_STATE.paletteType = btn.dataset.type;
                    updatePalette();
                });
            });

            // Buttons
            document.getElementById('savePaletteBtn').addEventListener('click', () => {
                openModal('savePaletteModal');
            });

            document.getElementById('confirmSavePaletteBtn').addEventListener('click', savePalette);

            document.getElementById('exportPalettesBtn').addEventListener('click', () => {
                const data = {
                    palettes: APP_STATE.savedPalettes,
                    recentColors: APP_STATE.recentColors,
                    exportDate: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `color-palettes-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });

            document.getElementById('importPalettesBtn').addEventListener('click', () => {
                openModal('importModal');
            });

            document.getElementById('confirmImportBtn').addEventListener('click', () => {
                const file = document.getElementById('importFile').files[0];
                if (!file) {
                    alert('Please select a file');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);

                        if (confirm('This will merge imported palettes. Continue?')) {
                            APP_STATE.savedPalettes.push(...data.palettes);
                            saveToStorage();
                            updateSavedPalettes();
                            alert('Palettes imported successfully!');
                        }

                        closeModal('importModal');
                    } catch (err) {
                        alert('Failed to import: ' + err.message);
                    }
                };
                reader.readAsText(file);
            });

            document.getElementById('clearDataBtn').addEventListener('click', () => {
                if (confirm('This will delete all saved palettes and recent colors. Continue?')) {
                    APP_STATE.savedPalettes = [];
                    APP_STATE.recentColors = [];
                    saveToStorage();
                    updateSavedPalettes();
                    updateRecentColors();
                    alert('All data cleared!');
                }
            });

            document.getElementById('themeBtn').addEventListener('click', () => {
                const current = document.body.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', newTheme);
                document.getElementById('themeBtn').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                saveToStorage();
            });

            document.getElementById('helpBtn').addEventListener('click', () => {
                openModal('helpModal');
            });

            // Modal close
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', saveToStorage);
    </script>
</body>
</html>