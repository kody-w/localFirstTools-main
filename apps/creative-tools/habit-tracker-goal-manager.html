<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Habit tracking and goal management app with streak tracking, heatmap visualization, and progress analytics">
    <title>Habit Tracker & Goal Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --bg-tertiary: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border: #d1d5db;
            --shadow: rgba(0, 0, 0, 0.1);
            --heatmap-0: #ebedf0;
            --heatmap-1: #c6e48b;
            --heatmap-2: #7bc96f;
            --heatmap-3: #239a3b;
            --heatmap-4: #196127;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --warning: #fbbf24;
            --danger: #f87171;
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #4b5563;
            --shadow: rgba(0, 0, 0, 0.3);
            --heatmap-0: #161b22;
            --heatmap-1: #0e4429;
            --heatmap-2: #006d32;
            --heatmap-3: #26a641;
            --heatmap-4: #39d353;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-header {
            background: var(--bg-primary);
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            opacity: 0.8;
        }

        .btn-icon {
            padding: 0.5rem;
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-icon:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: var(--text-primary);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .date-header {
            text-align: center;
            padding: 1.5rem;
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .today-date {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .motivational-quote {
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .habits-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .habit-card {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }

        .habit-card:hover {
            transform: translateY(-2px);
        }

        .habit-info {
            flex: 1;
        }

        .habit-name {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .habit-frequency {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .habit-streak {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .streak-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .check-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--border);
            background: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.2s;
        }

        .check-btn:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .check-btn.checked {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .heatmap-container {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .heatmap-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .heatmap {
            display: grid;
            grid-template-columns: repeat(53, 12px);
            gap: 3px;
            margin-bottom: 1rem;
        }

        .heatmap-cell {
            width: 12px;
            height: 12px;
            background: var(--heatmap-0);
            border-radius: 2px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .heatmap-cell:hover {
            transform: scale(1.2);
        }

        .heatmap-cell[data-level="1"] { background: var(--heatmap-1); }
        .heatmap-cell[data-level="2"] { background: var(--heatmap-2); }
        .heatmap-cell[data-level="3"] { background: var(--heatmap-3); }
        .heatmap-cell[data-level="4"] { background: var(--heatmap-4); }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .goal-card {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .goal-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .goal-category {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .goal-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .goal-progress {
            margin-bottom: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        .goal-deadline {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .milestones {
            margin-top: 1rem;
        }

        .milestone-item {
            padding: 0.5rem;
            border-left: 3px solid var(--border);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .milestone-item.completed {
            border-left-color: var(--success);
            color: var(--text-secondary);
            text-decoration: line-through;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            text-align: center;
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .badges-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }

        .badge-item {
            background: var(--bg-primary);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            text-align: center;
            transition: transform 0.2s;
        }

        .badge-item.unlocked {
            border: 2px solid var(--primary);
        }

        .badge-item:hover {
            transform: scale(1.05);
        }

        .badge-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .badge-item.unlocked .badge-icon {
            filter: none;
            opacity: 1;
        }

        .badge-name {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .badge-desc {
            font-size: 0.625rem;
            color: var(--text-secondary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            z-index: 99;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .goals-grid {
                grid-template-columns: 1fr;
            }

            .heatmap {
                grid-template-columns: repeat(53, 10px);
                gap: 2px;
            }

            .heatmap-cell {
                width: 10px;
                height: 10px;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1 class="app-title">Habit & Goal Tracker</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="exportData()">Export</button>
            <button class="btn btn-secondary" onclick="importData()">Import</button>
            <button class="btn btn-icon" onclick="toggleTheme()" title="Toggle theme">üåì</button>
        </div>
    </header>

    <div class="container">
        <div class="date-header">
            <div class="today-date" id="today-date"></div>
            <div class="motivational-quote" id="motivational-quote"></div>
        </div>

        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('today')">Today</button>
            <button class="nav-tab" onclick="switchTab('habits')">All Habits</button>
            <button class="nav-tab" onclick="switchTab('goals')">Goals</button>
            <button class="nav-tab" onclick="switchTab('analytics')">Analytics</button>
            <button class="nav-tab" onclick="switchTab('achievements')">Achievements</button>
        </nav>

        <!-- Today Tab -->
        <div id="today" class="tab-content active">
            <div class="habits-grid" id="today-habits">
                <!-- Today's habits will be rendered here -->
            </div>
        </div>

        <!-- All Habits Tab -->
        <div id="habits" class="tab-content">
            <div class="habits-grid" id="all-habits">
                <!-- All habits will be rendered here -->
            </div>
            <div id="habit-heatmaps"></div>
        </div>

        <!-- Goals Tab -->
        <div id="goals" class="tab-content">
            <div class="goals-grid" id="goals-container">
                <!-- Goals will be rendered here -->
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="stats-grid" id="stats-container">
                <!-- Statistics will be rendered here -->
            </div>
            <div class="heatmap-container">
                <h3 class="heatmap-title">Overall Activity Heatmap</h3>
                <canvas id="analytics-chart" width="800" height="300"></canvas>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div id="achievements" class="tab-content">
            <div class="badges-container" id="badges-container">
                <!-- Badges will be rendered here -->
            </div>
        </div>
    </div>

    <button class="fab" onclick="openAddMenu()" title="Add Habit or Goal">+</button>

    <!-- Habit Modal -->
    <div id="habit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="habit-modal-title">Add Habit</h2>
                <button class="close-btn" onclick="closeHabitModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Habit Name</label>
                <input type="text" class="form-input" id="habit-name" placeholder="e.g., Exercise, Read, Meditate">
            </div>
            <div class="form-group">
                <label class="form-label">Frequency</label>
                <select class="form-select" id="habit-frequency">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="custom">Custom Days</option>
                </select>
            </div>
            <div class="form-group" id="custom-days-group" style="display: none;">
                <label class="form-label">Select Days</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" value="0"> Sun
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="1"> Mon
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="2"> Tue
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="3"> Wed
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="4"> Thu
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="5"> Fri
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="6"> Sat
                    </label>
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveHabit()" style="width: 100%; margin-top: 1rem;">Save Habit</button>
        </div>
    </div>

    <!-- Goal Modal -->
    <div id="goal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="goal-modal-title">Add Goal</h2>
                <button class="close-btn" onclick="closeGoalModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Goal Title</label>
                <input type="text" class="form-input" id="goal-title" placeholder="What do you want to achieve?">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="goal-description" placeholder="Describe your goal..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="goal-category">
                    <option value="Health">Health</option>
                    <option value="Career">Career</option>
                    <option value="Learning">Learning</option>
                    <option value="Finance">Finance</option>
                    <option value="Personal">Personal</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Target Progress (%)</label>
                <input type="number" class="form-input" id="goal-target" value="100" min="0" max="100">
            </div>
            <div class="form-group">
                <label class="form-label">Deadline</label>
                <input type="date" class="form-input" id="goal-deadline">
            </div>
            <div class="form-group">
                <label class="form-label">Milestones (one per line)</label>
                <textarea class="form-textarea" id="goal-milestones" placeholder="Step 1&#10;Step 2&#10;Step 3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveGoal()" style="width: 100%; margin-top: 1rem;">Save Goal</button>
        </div>
    </div>

    <!-- Add Menu Modal -->
    <div id="add-menu" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">What would you like to add?</h2>
                <button class="close-btn" onclick="closeAddMenu()">&times;</button>
            </div>
            <button class="btn btn-primary" onclick="openHabitModal()" style="width: 100%; margin-bottom: 1rem;">Add Habit</button>
            <button class="btn btn-primary" onclick="openGoalModal()" style="width: 100%;">Add Goal</button>
        </div>
    </div>

    <script>
        const QUOTES = [
            "Success is the sum of small efforts repeated day in and day out.",
            "The secret of getting ahead is getting started.",
            "Don't watch the clock; do what it does. Keep going.",
            "You don't have to be great to start, but you have to start to be great.",
            "The only way to do great work is to love what you do.",
            "Believe you can and you're halfway there.",
            "Start where you are. Use what you have. Do what you can.",
            "The future depends on what you do today.",
            "Progress, not perfection.",
            "One day or day one. You decide."
        ];

        const BADGES = [
            { id: 'streak-7', name: '7-Day Streak', icon: 'üî•', desc: 'Complete a habit for 7 days', threshold: 7 },
            { id: 'streak-30', name: '30-Day Streak', icon: '‚ö°', desc: 'Complete a habit for 30 days', threshold: 30 },
            { id: 'streak-100', name: '100-Day Streak', icon: 'üíØ', desc: 'Complete a habit for 100 days', threshold: 100 },
            { id: 'goal-1', name: 'First Goal', icon: 'üéØ', desc: 'Complete your first goal', threshold: 1 },
            { id: 'goal-5', name: '5 Goals', icon: 'üèÜ', desc: 'Complete 5 goals', threshold: 5 },
            { id: 'habits-3', name: '3 Habits', icon: 'üìö', desc: 'Track 3 habits simultaneously', threshold: 3 },
            { id: 'consistent', name: 'Consistent', icon: '‚ú®', desc: 'Check in for 14 consecutive days', threshold: 14 },
            { id: 'dedicated', name: 'Dedicated', icon: 'üåü', desc: 'Check in for 50 consecutive days', threshold: 50 }
        ];

        let habits = [];
        let goals = [];
        let completions = {};
        let unlockedBadges = [];
        let editingHabitId = null;
        let editingGoalId = null;

        // Initialize
        function init() {
            loadData();
            updateDate();
            renderTodayHabits();
            renderAllHabits();
            renderGoals();
            renderAnalytics();
            renderBadges();
            checkBadges();
            setupFrequencyListener();
        }

        function loadData() {
            const saved = localStorage.getItem('habitTrackerData');
            if (saved) {
                const data = JSON.parse(saved);
                habits = data.habits || [];
                goals = data.goals || [];
                completions = data.completions || {};
                unlockedBadges = data.unlockedBadges || [];
            }
        }

        function saveData() {
            localStorage.setItem('habitTrackerData', JSON.stringify({
                habits, goals, completions, unlockedBadges
            }));
        }

        function setupFrequencyListener() {
            document.getElementById('habit-frequency').addEventListener('change', (e) => {
                const customDays = document.getElementById('custom-days-group');
                customDays.style.display = e.target.value === 'custom' ? 'block' : 'none';
            });
        }

        // Theme
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            html.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
            localStorage.setItem('habitTheme', html.getAttribute('data-theme'));
            renderAnalytics(); // Redraw charts
        }

        const savedTheme = localStorage.getItem('habitTheme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Date and Quote
        function updateDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('today-date').textContent = today.toLocaleDateString('en-US', options);

            const randomQuote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            document.getElementById('motivational-quote').textContent = `"${randomQuote}"`;
        }

        // Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'today') renderTodayHabits();
            if (tabName === 'habits') renderAllHabits();
            if (tabName === 'goals') renderGoals();
            if (tabName === 'analytics') renderAnalytics();
            if (tabName === 'achievements') renderBadges();
        }

        // Habits
        function openHabitModal() {
            closeAddMenu();
            editingHabitId = null;
            document.getElementById('habit-modal-title').textContent = 'Add Habit';
            document.getElementById('habit-name').value = '';
            document.getElementById('habit-frequency').value = 'daily';
            document.getElementById('custom-days-group').style.display = 'none';
            document.getElementById('habit-modal').classList.add('active');
        }

        function closeHabitModal() {
            document.getElementById('habit-modal').classList.remove('active');
        }

        function saveHabit() {
            const name = document.getElementById('habit-name').value.trim();
            const frequency = document.getElementById('habit-frequency').value;

            if (!name) {
                alert('Please enter a habit name');
                return;
            }

            let customDays = null;
            if (frequency === 'custom') {
                const checkboxes = document.querySelectorAll('#custom-days-group input:checked');
                customDays = Array.from(checkboxes).map(cb => parseInt(cb.value));
                if (customDays.length === 0) {
                    alert('Please select at least one day');
                    return;
                }
            }

            const habit = {
                id: editingHabitId || Date.now(),
                name,
                frequency,
                customDays,
                created: Date.now(),
                currentStreak: 0,
                longestStreak: 0
            };

            if (editingHabitId) {
                const index = habits.findIndex(h => h.id === editingHabitId);
                habits[index] = { ...habits[index], ...habit };
            } else {
                habits.push(habit);
            }

            saveData();
            closeHabitModal();
            renderTodayHabits();
            renderAllHabits();
            checkBadges();
        }

        function deleteHabit(id) {
            if (!confirm('Delete this habit? All completion history will be lost.')) return;
            habits = habits.filter(h => h.id !== id);

            // Clean up completions
            Object.keys(completions).forEach(key => {
                if (key.startsWith(`${id}-`)) {
                    delete completions[key];
                }
            });

            saveData();
            renderTodayHabits();
            renderAllHabits();
        }

        function isHabitDueToday(habit) {
            const today = new Date().getDay();

            if (habit.frequency === 'daily') return true;
            if (habit.frequency === 'weekly') return today === 0; // Sunday
            if (habit.frequency === 'custom') return habit.customDays.includes(today);

            return false;
        }

        function toggleHabit(habitId, date = null) {
            const dateStr = date || new Date().toISOString().split('T')[0];
            const key = `${habitId}-${dateStr}`;

            if (completions[key]) {
                delete completions[key];
            } else {
                completions[key] = true;
            }

            updateStreaks(habitId);
            saveData();
            renderTodayHabits();
            renderAllHabits();
            checkBadges();
        }

        function isHabitCompleted(habitId, date = null) {
            const dateStr = date || new Date().toISOString().split('T')[0];
            const key = `${habitId}-${dateStr}`;
            return !!completions[key];
        }

        function updateStreaks(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 0;

            const today = new Date();
            let checkDate = new Date(today);

            // Count backwards from today
            for (let i = 0; i < 365; i++) {
                const dateStr = checkDate.toISOString().split('T')[0];
                const key = `${habitId}-${dateStr}`;

                if (completions[key]) {
                    tempStreak++;
                    if (i === 0 || currentStreak > 0) {
                        currentStreak = tempStreak;
                    }
                } else {
                    if (tempStreak > longestStreak) {
                        longestStreak = tempStreak;
                    }
                    if (i === 0) {
                        currentStreak = 0;
                    }
                    tempStreak = 0;
                }

                checkDate.setDate(checkDate.getDate() - 1);
            }

            habit.currentStreak = currentStreak;
            habit.longestStreak = Math.max(longestStreak, currentStreak);
        }

        function renderTodayHabits() {
            const container = document.getElementById('today-habits');
            const todayHabits = habits.filter(h => isHabitDueToday(h));

            if (todayHabits.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No habits scheduled for today. Create one to get started!</div>';
                return;
            }

            container.innerHTML = '';

            todayHabits.forEach(habit => {
                updateStreaks(habit.id);
                const completed = isHabitCompleted(habit.id);

                const card = document.createElement('div');
                card.className = 'habit-card';
                card.innerHTML = `
                    <div class="habit-info">
                        <div class="habit-name">${habit.name}</div>
                        <div class="habit-frequency">${getFrequencyText(habit)}</div>
                        <div class="habit-streak">
                            <div class="streak-item">
                                <span>üî•</span>
                                <span>${habit.currentStreak} day streak</span>
                            </div>
                            <div class="streak-item">
                                <span>üèÜ</span>
                                <span>Best: ${habit.longestStreak}</span>
                            </div>
                        </div>
                    </div>
                    <button class="check-btn ${completed ? 'checked' : ''}" onclick="toggleHabit(${habit.id})">
                        ${completed ? '‚úì' : ''}
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function renderAllHabits() {
            const container = document.getElementById('all-habits');
            container.innerHTML = '';

            if (habits.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No habits yet. Create your first habit!</div>';
                return;
            }

            habits.forEach(habit => {
                updateStreaks(habit.id);
                const completed = isHabitCompleted(habit.id);

                const card = document.createElement('div');
                card.className = 'habit-card';
                card.innerHTML = `
                    <div class="habit-info">
                        <div class="habit-name">${habit.name}</div>
                        <div class="habit-frequency">${getFrequencyText(habit)}</div>
                        <div class="habit-streak">
                            <div class="streak-item">
                                <span>üî•</span>
                                <span>${habit.currentStreak} day streak</span>
                            </div>
                            <div class="streak-item">
                                <span>üèÜ</span>
                                <span>Best: ${habit.longestStreak}</span>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-secondary" onclick="deleteHabit(${habit.id})">Delete</button>
                        <button class="check-btn ${completed ? 'checked' : ''}" onclick="toggleHabit(${habit.id})">
                            ${completed ? '‚úì' : ''}
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });

            renderHeatmaps();
        }

        function getFrequencyText(habit) {
            if (habit.frequency === 'daily') return 'Daily';
            if (habit.frequency === 'weekly') return 'Weekly';
            if (habit.frequency === 'custom') {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return habit.customDays.map(d => days[d]).join(', ');
            }
            return '';
        }

        function renderHeatmaps() {
            const container = document.getElementById('habit-heatmaps');
            container.innerHTML = '';

            habits.forEach(habit => {
                const heatmapDiv = document.createElement('div');
                heatmapDiv.className = 'heatmap-container';

                const grid = document.createElement('div');
                grid.className = 'heatmap';

                // Generate last 371 days (53 weeks)
                const today = new Date();
                for (let i = 370; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];

                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    cell.title = dateStr;

                    if (isHabitCompleted(habit.id, dateStr)) {
                        cell.setAttribute('data-level', '4');
                    }

                    grid.appendChild(cell);
                }

                heatmapDiv.innerHTML = `<h3 class="heatmap-title">${habit.name} - Activity Heatmap</h3>`;
                heatmapDiv.appendChild(grid);

                const legend = document.createElement('div');
                legend.className = 'heatmap-legend';
                legend.innerHTML = `
                    <span>Less</span>
                    <div class="heatmap-cell" data-level="0"></div>
                    <div class="heatmap-cell" data-level="1"></div>
                    <div class="heatmap-cell" data-level="2"></div>
                    <div class="heatmap-cell" data-level="3"></div>
                    <div class="heatmap-cell" data-level="4"></div>
                    <span>More</span>
                `;
                heatmapDiv.appendChild(legend);

                container.appendChild(heatmapDiv);
            });
        }

        // Goals
        function openGoalModal() {
            closeAddMenu();
            editingGoalId = null;
            document.getElementById('goal-modal-title').textContent = 'Add Goal';
            document.getElementById('goal-title').value = '';
            document.getElementById('goal-description').value = '';
            document.getElementById('goal-category').value = 'Health';
            document.getElementById('goal-target').value = '100';
            document.getElementById('goal-deadline').value = '';
            document.getElementById('goal-milestones').value = '';
            document.getElementById('goal-modal').classList.add('active');
        }

        function closeGoalModal() {
            document.getElementById('goal-modal').classList.remove('active');
        }

        function saveGoal() {
            const title = document.getElementById('goal-title').value.trim();
            const description = document.getElementById('goal-description').value.trim();
            const category = document.getElementById('goal-category').value;
            const target = parseInt(document.getElementById('goal-target').value) || 100;
            const deadline = document.getElementById('goal-deadline').value;
            const milestonesText = document.getElementById('goal-milestones').value.trim();

            if (!title) {
                alert('Please enter a goal title');
                return;
            }

            const milestones = milestonesText.split('\n').filter(m => m.trim()).map((m, i) => ({
                id: Date.now() + i,
                text: m.trim(),
                completed: false
            }));

            const goal = {
                id: editingGoalId || Date.now(),
                title,
                description,
                category,
                target,
                progress: 0,
                deadline,
                milestones,
                completed: false,
                created: Date.now()
            };

            if (editingGoalId) {
                const index = goals.findIndex(g => g.id === editingGoalId);
                goals[index] = { ...goals[index], ...goal };
            } else {
                goals.push(goal);
            }

            saveData();
            closeGoalModal();
            renderGoals();
            checkBadges();
        }

        function updateGoalProgress(goalId, progress) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            goal.progress = Math.min(progress, goal.target);
            if (goal.progress >= goal.target) {
                goal.completed = true;
            }

            saveData();
            renderGoals();
            checkBadges();
        }

        function toggleMilestone(goalId, milestoneId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            const milestone = goal.milestones.find(m => m.id === milestoneId);
            if (milestone) {
                milestone.completed = !milestone.completed;

                // Update progress based on milestones
                const completedCount = goal.milestones.filter(m => m.completed).length;
                const percentage = (completedCount / goal.milestones.length) * 100;
                goal.progress = percentage;

                if (goal.progress >= goal.target) {
                    goal.completed = true;
                }

                saveData();
                renderGoals();
                checkBadges();
            }
        }

        function deleteGoal(id) {
            if (!confirm('Delete this goal?')) return;
            goals = goals.filter(g => g.id !== id);
            saveData();
            renderGoals();
        }

        function renderGoals() {
            const container = document.getElementById('goals-container');
            container.innerHTML = '';

            if (goals.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary); grid-column: 1 / -1;">No goals yet. Create your first goal!</div>';
                return;
            }

            goals.forEach(goal => {
                const daysLeft = goal.deadline ?
                    Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24)) : null;

                const card = document.createElement('div');
                card.className = 'goal-card';
                card.innerHTML = `
                    <div class="goal-header">
                        <div>
                            <div class="goal-title">${goal.title}</div>
                            <span class="goal-category">${goal.category}</span>
                        </div>
                        <button class="btn btn-secondary" onclick="deleteGoal(${goal.id})" style="padding: 0.25rem 0.5rem;">Delete</button>
                    </div>
                    ${goal.description ? `<div class="goal-description">${goal.description}</div>` : ''}
                    <div class="goal-progress">
                        <div class="progress-header">
                            <span>Progress</span>
                            <span>${goal.progress.toFixed(0)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${goal.progress}%"></div>
                        </div>
                        ${goal.deadline ? `<div class="goal-deadline">
                            ${daysLeft > 0 ? `${daysLeft} days left` : daysLeft === 0 ? 'Due today!' : 'Overdue'}
                        </div>` : ''}
                    </div>
                    ${goal.milestones.length > 0 ? `
                        <div class="milestones">
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Milestones</div>
                            ${goal.milestones.map(m => `
                                <div class="milestone-item ${m.completed ? 'completed' : ''}"
                                     onclick="toggleMilestone(${goal.id}, ${m.id})">
                                    ${m.completed ? '‚úì' : '‚óã'} ${m.text}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });
        }

        // Analytics
        function renderAnalytics() {
            const container = document.getElementById('stats-container');
            container.innerHTML = '';

            // Total completions
            const totalCompletions = Object.keys(completions).length;

            // Current streaks
            const activeStreaks = habits.filter(h => h.currentStreak > 0).length;

            // Longest streak
            const longestStreak = Math.max(...habits.map(h => h.longestStreak || 0), 0);

            // Active goals
            const activeGoals = goals.filter(g => !g.completed).length;

            // Completed goals
            const completedGoals = goals.filter(g => g.completed).length;

            // Last 7 days completion rate
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayHabits = habits.filter(h => isHabitDueToday(h));
                const completed = dayHabits.filter(h => isHabitCompleted(h.id, dateStr)).length;
                last7Days.push({ total: dayHabits.length, completed });
            }

            const weekTotal = last7Days.reduce((sum, d) => sum + d.total, 0);
            const weekCompleted = last7Days.reduce((sum, d) => sum + d.completed, 0);
            const completionRate = weekTotal > 0 ? ((weekCompleted / weekTotal) * 100).toFixed(0) : 0;

            const stats = [
                { icon: '‚úì', value: totalCompletions, label: 'Total Check-ins' },
                { icon: 'üî•', value: activeStreaks, label: 'Active Streaks' },
                { icon: 'üèÜ', value: longestStreak, label: 'Longest Streak' },
                { icon: 'üéØ', value: activeGoals, label: 'Active Goals' },
                { icon: '‚ú®', value: completedGoals, label: 'Completed Goals' },
                { icon: 'üìä', value: `${completionRate}%`, label: 'Week Completion' }
            ];

            stats.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-icon">${stat.icon}</div>
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                container.appendChild(card);
            });

            drawAnalyticsChart();
        }

        function drawAnalyticsChart() {
            const canvas = document.getElementById('analytics-chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            const last30Days = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayHabits = habits.filter(h => isHabitDueToday(h));
                const completed = dayHabits.filter(h => isHabitCompleted(h.id, dateStr)).length;
                last30Days.push({ date, total: dayHabits.length, completed });
            }

            const maxValue = Math.max(...last30Days.map(d => d.total), 1);
            const padding = 60;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;

            // Axes
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border');
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Bars
            const barWidth = graphWidth / 30;

            last30Days.forEach((day, index) => {
                const x = padding + (index * barWidth);
                const completedHeight = (day.completed / maxValue) * graphHeight;
                const totalHeight = (day.total / maxValue) * graphHeight;

                // Total (lighter)
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-tertiary');
                ctx.fillRect(x + 2, height - padding - totalHeight, barWidth - 4, totalHeight);

                // Completed (primary color)
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary');
                ctx.fillRect(x + 2, height - padding - completedHeight, barWidth - 4, completedHeight);
            });

            // Labels
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';

            // First day
            ctx.fillText(last30Days[0].date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                padding, height - padding + 20);

            // Last day
            ctx.fillText(last30Days[29].date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                width - padding, height - padding + 20);

            // Y-axis label
            ctx.textAlign = 'right';
            ctx.fillText(`${maxValue}`, padding - 10, padding + 5);
            ctx.fillText('0', padding - 10, height - padding + 5);

            // Legend
            ctx.textAlign = 'left';
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-tertiary');
            ctx.fillRect(width - 200, 20, 20, 20);
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
            ctx.fillText('Scheduled', width - 175, 35);

            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary');
            ctx.fillRect(width - 200, 45, 20, 20);
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
            ctx.fillText('Completed', width - 175, 60);
        }

        // Badges
        function checkBadges() {
            let newBadges = [];

            // Check streak badges
            habits.forEach(habit => {
                updateStreaks(habit.id);
                const streak = habit.currentStreak;

                if (streak >= 7 && !unlockedBadges.includes('streak-7')) {
                    newBadges.push('streak-7');
                }
                if (streak >= 30 && !unlockedBadges.includes('streak-30')) {
                    newBadges.push('streak-30');
                }
                if (streak >= 100 && !unlockedBadges.includes('streak-100')) {
                    newBadges.push('streak-100');
                }
            });

            // Check goal badges
            const completedGoalCount = goals.filter(g => g.completed).length;
            if (completedGoalCount >= 1 && !unlockedBadges.includes('goal-1')) {
                newBadges.push('goal-1');
            }
            if (completedGoalCount >= 5 && !unlockedBadges.includes('goal-5')) {
                newBadges.push('goal-5');
            }

            // Check habit count badge
            if (habits.length >= 3 && !unlockedBadges.includes('habits-3')) {
                newBadges.push('habits-3');
            }

            // Check consecutive days
            const consecutiveDays = getConsecutiveDays();
            if (consecutiveDays >= 14 && !unlockedBadges.includes('consistent')) {
                newBadges.push('consistent');
            }
            if (consecutiveDays >= 50 && !unlockedBadges.includes('dedicated')) {
                newBadges.push('dedicated');
            }

            // Add new badges
            newBadges.forEach(badge => {
                if (!unlockedBadges.includes(badge)) {
                    unlockedBadges.push(badge);
                }
            });

            if (newBadges.length > 0) {
                saveData();
                renderBadges();
            }
        }

        function getConsecutiveDays() {
            let consecutive = 0;
            const today = new Date();

            for (let i = 0; i < 365; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];

                let anyCompleted = false;
                habits.forEach(habit => {
                    if (isHabitCompleted(habit.id, dateStr)) {
                        anyCompleted = true;
                    }
                });

                if (anyCompleted) {
                    consecutive++;
                } else {
                    break;
                }
            }

            return consecutive;
        }

        function renderBadges() {
            const container = document.getElementById('badges-container');
            container.innerHTML = '';

            BADGES.forEach(badge => {
                const unlocked = unlockedBadges.includes(badge.id);

                const div = document.createElement('div');
                div.className = `badge-item ${unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="badge-icon">${badge.icon}</div>
                    <div class="badge-name">${badge.name}</div>
                    <div class="badge-desc">${badge.desc}</div>
                `;
                container.appendChild(div);
            });
        }

        // Modals
        function openAddMenu() {
            document.getElementById('add-menu').classList.add('active');
        }

        function closeAddMenu() {
            document.getElementById('add-menu').classList.remove('active');
        }

        // Export/Import
        function exportData() {
            const data = { habits, goals, completions, unlockedBadges };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habit-tracker-backup-${Date.now()}.json`;
            a.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (confirm('This will replace all current data. Continue?')) {
                            habits = data.habits || [];
                            goals = data.goals || [];
                            completions = data.completions || {};
                            unlockedBadges = data.unlockedBadges || [];
                            saveData();
                            init();
                            alert('Data imported successfully!');
                        }
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Initialize app
        init();
    </script>
</body>
</html>