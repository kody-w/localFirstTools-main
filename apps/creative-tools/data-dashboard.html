<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Dashboard Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --accent: #e94560;
            --accent-hover: #ff5773;
            --border: #2a2a4e;
            --widget-bg: #1e1e3f;
            --widget-border: #3a3a6e;
            --success: #4caf50;
            --warning: #ff9800;
            --info: #2196f3;
        }

        body.light-theme {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0e0e0;
            --text-primary: #333;
            --text-secondary: #666;
            --accent: #e94560;
            --accent-hover: #d63850;
            --border: #ddd;
            --widget-bg: #ffffff;
            --widget-border: #ccc;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .dashboard-tabs {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .dashboard-tab {
            padding: 8px 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-tab.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        .dashboard-tab .close-tab {
            opacity: 0.7;
            cursor: pointer;
            font-size: 14px;
        }

        .dashboard-tab .close-tab:hover {
            opacity: 1;
        }

        .widget-palette {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .palette-section {
            margin-bottom: 20px;
        }

        .palette-section h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .widget-button {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .widget-button:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: translateX(5px);
        }

        .widget-icon {
            font-size: 18px;
        }

        /* Main Canvas */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            gap: 10px;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .btn.primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        .btn.primary:hover {
            background: var(--accent-hover);
        }

        .canvas-wrapper {
            flex: 1;
            overflow: auto;
            position: relative;
            background: var(--bg-primary);
        }

        .canvas {
            position: relative;
            min-height: 100%;
            min-width: 100%;
            padding: 20px;
        }

        .canvas.grid {
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 19px, var(--border) 19px, var(--border) 20px),
                repeating-linear-gradient(90deg, transparent, transparent 19px, var(--border) 19px, var(--border) 20px);
            background-size: 20px 20px;
        }

        /* Widget */
        .widget {
            position: absolute;
            background: var(--widget-bg);
            border: 2px solid var(--widget-border);
            border-radius: 8px;
            padding: 15px;
            min-width: 200px;
            min-height: 150px;
            cursor: move;
            transition: box-shadow 0.2s;
        }

        .widget:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .widget.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .widget-title {
            font-size: 14px;
            font-weight: 600;
            flex: 1;
        }

        .widget-actions {
            display: flex;
            gap: 5px;
        }

        .widget-action {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 3px;
            opacity: 0.6;
            font-size: 12px;
        }

        .widget-action:hover {
            opacity: 1;
            background: var(--bg-tertiary);
        }

        .widget-content {
            height: calc(100% - 40px);
            overflow: hidden;
        }

        .resize-handle {
            position: absolute;
            background: var(--accent);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .widget:hover .resize-handle,
        .widget.selected .resize-handle {
            opacity: 0.7;
        }

        .resize-handle:hover {
            opacity: 1;
        }

        .resize-handle.corner {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .resize-handle.edge {
            background: transparent;
        }

        .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
        .resize-handle.n { top: -3px; left: 20px; right: 20px; height: 6px; cursor: n-resize; }
        .resize-handle.s { bottom: -3px; left: 20px; right: 20px; height: 6px; cursor: s-resize; }
        .resize-handle.w { left: -3px; top: 20px; bottom: 20px; width: 6px; cursor: w-resize; }
        .resize-handle.e { right: -3px; top: 20px; bottom: 20px; width: 6px; cursor: e-resize; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 25px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
        }

        .modal-close {
            cursor: pointer;
            font-size: 24px;
            opacity: 0.7;
            line-height: 1;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        .color-input-group {
            display: flex;
            gap: 10px;
        }

        .color-input-group input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            cursor: pointer;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-table th,
        .data-table td {
            padding: 8px;
            border: 1px solid var(--border);
            text-align: left;
        }

        .data-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 12px;
        }

        .data-table input {
            width: 100%;
            padding: 5px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 3px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .fullscreen-mode .sidebar,
        .fullscreen-mode .toolbar {
            display: none;
        }

        .fullscreen-mode .canvas {
            padding: 0;
        }

        .number-card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .number-card-value {
            font-size: 48px;
            font-weight: bold;
            line-height: 1;
        }

        .number-card-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .number-card-trend {
            font-size: 20px;
            margin-top: 5px;
        }

        .text-widget {
            height: 100%;
            overflow-y: auto;
            line-height: 1.6;
        }

        .widget-table {
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        .widget-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .widget-table th,
        .widget-table td {
            padding: 8px;
            border: 1px solid var(--border);
            text-align: left;
        }

        .widget-table th {
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }

        .widget-table th:hover {
            background: var(--accent);
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                z-index: 100;
                height: 100%;
            }

            .toolbar {
                padding: 10px;
            }

            .toolbar-group {
                gap: 5px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>Dashboard Builder</h1>
            </div>

            <div class="dashboard-tabs" id="dashboardTabs">
                <!-- Tabs rendered here -->
            </div>

            <div class="widget-palette">
                <div class="palette-section">
                    <h3>Charts</h3>
                    <button class="widget-button" data-widget-type="bar-chart">
                        <span class="widget-icon">üìä</span>
                        <span>Bar Chart</span>
                    </button>
                    <button class="widget-button" data-widget-type="line-chart">
                        <span class="widget-icon">üìà</span>
                        <span>Line Chart</span>
                    </button>
                    <button class="widget-button" data-widget-type="pie-chart">
                        <span class="widget-icon">ü•ß</span>
                        <span>Pie Chart</span>
                    </button>
                    <button class="widget-button" data-widget-type="gauge">
                        <span class="widget-icon">üéØ</span>
                        <span>Gauge</span>
                    </button>
                    <button class="widget-button" data-widget-type="sparkline">
                        <span class="widget-icon">‚ú®</span>
                        <span>Sparkline</span>
                    </button>
                </div>

                <div class="palette-section">
                    <h3>Data Widgets</h3>
                    <button class="widget-button" data-widget-type="number-card">
                        <span class="widget-icon">üî¢</span>
                        <span>Number Card</span>
                    </button>
                    <button class="widget-button" data-widget-type="table">
                        <span class="widget-icon">üìã</span>
                        <span>Data Table</span>
                    </button>
                    <button class="widget-button" data-widget-type="text">
                        <span class="widget-icon">üìù</span>
                        <span>Text/Notes</span>
                    </button>
                </div>

                <div class="palette-section">
                    <h3>Dashboard</h3>
                    <button class="btn" id="newDashboardBtn" style="width: 100%;">+ New Dashboard</button>
                    <button class="btn" id="exportBtn" style="width: 100%; margin-top: 8px;">Export JSON</button>
                    <button class="btn" id="importBtn" style="width: 100%; margin-top: 8px;">Import JSON</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="toolbar">
                <div class="toolbar-group">
                    <button class="btn" id="toggleSidebarBtn">‚ò∞</button>
                    <button class="btn" id="gridSnapBtn">Grid Snap: OFF</button>
                    <button class="btn" id="themeBtn">Theme</button>
                </div>
                <div class="toolbar-group">
                    <button class="btn" id="fullscreenBtn">Fullscreen</button>
                    <button class="btn" id="clearBtn">Clear All</button>
                    <button class="btn primary" id="saveBtn">Save</button>
                </div>
            </div>

            <div class="canvas-wrapper">
                <div class="canvas" id="canvas">
                    <!-- Widgets rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Widget Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Widget</h2>
                <span class="modal-close" id="closeEditModal">√ó</span>
            </div>
            <div id="editModalContent">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // State Management
        const state = {
            dashboards: [],
            currentDashboardIndex: 0,
            selectedWidget: null,
            draggedWidget: null,
            resizingWidget: null,
            resizeDirection: null,
            dragStartX: 0,
            dragStartY: 0,
            gridSnap: false,
            theme: 'dark'
        };

        // Initialize
        function init() {
            loadFromLocalStorage();
            if (state.dashboards.length === 0) {
                createNewDashboard('Dashboard 1');
            }
            renderDashboardTabs();
            renderCanvas();
            setupEventListeners();
            applyTheme();
        }

        // LocalStorage
        function saveToLocalStorage() {
            localStorage.setItem('dashboardBuilderData', JSON.stringify({
                dashboards: state.dashboards,
                currentDashboardIndex: state.currentDashboardIndex,
                theme: state.theme
            }));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('dashboardBuilderData');
            if (data) {
                const parsed = JSON.parse(data);
                state.dashboards = parsed.dashboards || [];
                state.currentDashboardIndex = parsed.currentDashboardIndex || 0;
                state.theme = parsed.theme || 'dark';
            }
        }

        // Dashboard Management
        function createNewDashboard(name) {
            const dashboard = {
                id: Date.now().toString(),
                name: name || `Dashboard ${state.dashboards.length + 1}`,
                widgets: []
            };
            state.dashboards.push(dashboard);
            state.currentDashboardIndex = state.dashboards.length - 1;
            saveToLocalStorage();
        }

        function getCurrentDashboard() {
            return state.dashboards[state.currentDashboardIndex];
        }

        function switchDashboard(index) {
            state.currentDashboardIndex = index;
            state.selectedWidget = null;
            renderCanvas();
            renderDashboardTabs();
        }

        function deleteDashboard(index) {
            if (state.dashboards.length <= 1) {
                alert('Cannot delete the last dashboard');
                return;
            }
            state.dashboards.splice(index, 1);
            if (state.currentDashboardIndex >= state.dashboards.length) {
                state.currentDashboardIndex = state.dashboards.length - 1;
            }
            saveToLocalStorage();
            renderDashboardTabs();
            renderCanvas();
        }

        // Widget Management
        function createWidget(type, x, y) {
            const widget = {
                id: Date.now().toString(),
                type: type,
                x: x,
                y: y,
                width: 300,
                height: 250,
                title: getDefaultTitle(type),
                data: getDefaultData(type),
                config: getDefaultConfig(type),
                zIndex: Date.now()
            };

            const dashboard = getCurrentDashboard();
            dashboard.widgets.push(widget);
            saveToLocalStorage();
            renderCanvas();
        }

        function getDefaultTitle(type) {
            const titles = {
                'bar-chart': 'Bar Chart',
                'line-chart': 'Line Chart',
                'pie-chart': 'Pie Chart',
                'gauge': 'Gauge',
                'sparkline': 'Sparkline',
                'number-card': 'Number Card',
                'table': 'Data Table',
                'text': 'Text Widget'
            };
            return titles[type] || 'Widget';
        }

        function getDefaultData(type) {
            switch(type) {
                case 'bar-chart':
                case 'line-chart':
                    return [
                        { label: 'Jan', value: 65 },
                        { label: 'Feb', value: 78 },
                        { label: 'Mar', value: 90 },
                        { label: 'Apr', value: 81 },
                        { label: 'May', value: 95 }
                    ];
                case 'pie-chart':
                    return [
                        { label: 'Category A', value: 30 },
                        { label: 'Category B', value: 25 },
                        { label: 'Category C', value: 20 },
                        { label: 'Category D', value: 25 }
                    ];
                case 'gauge':
                    return { min: 0, max: 100, value: 65 };
                case 'sparkline':
                    return [12, 15, 18, 20, 17, 22, 25, 23, 28, 30];
                case 'number-card':
                    return { value: 1234, label: 'Total Sales', trend: 'up' };
                case 'table':
                    return [
                        { name: 'Item A', value: 100, status: 'Active' },
                        { name: 'Item B', value: 200, status: 'Active' },
                        { name: 'Item C', value: 150, status: 'Pending' }
                    ];
                case 'text':
                    return 'Enter your text here...';
                default:
                    return [];
            }
        }

        function getDefaultConfig(type) {
            return {
                colors: ['#e94560', '#2196f3', '#4caf50', '#ff9800', '#9c27b0', '#00bcd4'],
                backgroundColor: 'transparent',
                showLabels: true,
                showLegend: true,
                orientation: 'vertical'
            };
        }

        function deleteWidget(widgetId) {
            const dashboard = getCurrentDashboard();
            dashboard.widgets = dashboard.widgets.filter(w => w.id !== widgetId);
            state.selectedWidget = null;
            saveToLocalStorage();
            renderCanvas();
        }

        function duplicateWidget(widgetId) {
            const dashboard = getCurrentDashboard();
            const widget = dashboard.widgets.find(w => w.id === widgetId);
            if (!widget) return;

            const newWidget = JSON.parse(JSON.stringify(widget));
            newWidget.id = Date.now().toString();
            newWidget.x += 20;
            newWidget.y += 20;
            newWidget.zIndex = Date.now();

            dashboard.widgets.push(newWidget);
            saveToLocalStorage();
            renderCanvas();
        }

        function bringToFront(widgetId) {
            const dashboard = getCurrentDashboard();
            const widget = dashboard.widgets.find(w => w.id === widgetId);
            if (!widget) return;

            widget.zIndex = Date.now();
            saveToLocalStorage();
            renderCanvas();
        }

        function sendToBack(widgetId) {
            const dashboard = getCurrentDashboard();
            const widget = dashboard.widgets.find(w => w.id === widgetId);
            if (!widget) return;

            const minZ = Math.min(...dashboard.widgets.map(w => w.zIndex));
            widget.zIndex = minZ - 1;
            saveToLocalStorage();
            renderCanvas();
        }

        // Rendering
        function renderDashboardTabs() {
            const container = document.getElementById('dashboardTabs');
            container.innerHTML = state.dashboards.map((dash, idx) => `
                <div class="dashboard-tab ${idx === state.currentDashboardIndex ? 'active' : ''}"
                     data-index="${idx}">
                    <span>${dash.name}</span>
                    ${state.dashboards.length > 1 ? `<span class="close-tab" data-index="${idx}">√ó</span>` : ''}
                </div>
            `).join('') + `
                <div class="dashboard-tab" id="addDashboardTab" style="background: var(--success);">+</div>
            `;

            container.querySelectorAll('.dashboard-tab[data-index]').forEach(tab => {
                const idx = parseInt(tab.dataset.index);
                tab.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('close-tab')) {
                        switchDashboard(idx);
                    }
                });

                const closeBtn = tab.querySelector('.close-tab');
                if (closeBtn) {
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm('Delete this dashboard?')) {
                            deleteDashboard(idx);
                        }
                    });
                }
            });

            document.getElementById('addDashboardTab').addEventListener('click', () => {
                const name = prompt('Dashboard name:', `Dashboard ${state.dashboards.length + 1}`);
                if (name) {
                    createNewDashboard(name);
                    renderDashboardTabs();
                    renderCanvas();
                }
            });
        }

        function renderCanvas() {
            const canvas = document.getElementById('canvas');
            const dashboard = getCurrentDashboard();

            canvas.innerHTML = '';

            if (!dashboard) return;

            // Sort by z-index
            const sortedWidgets = [...dashboard.widgets].sort((a, b) => a.zIndex - b.zIndex);

            sortedWidgets.forEach(widget => {
                const widgetEl = createWidgetElement(widget);
                canvas.appendChild(widgetEl);
                renderWidgetContent(widget);
            });
        }

        function createWidgetElement(widget) {
            const div = document.createElement('div');
            div.className = 'widget';
            if (state.selectedWidget === widget.id) {
                div.classList.add('selected');
            }
            div.dataset.widgetId = widget.id;
            div.style.left = widget.x + 'px';
            div.style.top = widget.y + 'px';
            div.style.width = widget.width + 'px';
            div.style.height = widget.height + 'px';
            div.style.zIndex = widget.zIndex;
            if (widget.config.backgroundColor && widget.config.backgroundColor !== 'transparent') {
                div.style.backgroundColor = widget.config.backgroundColor;
            }

            div.innerHTML = `
                <div class="widget-header">
                    <div class="widget-title">${widget.title}</div>
                    <div class="widget-actions">
                        <div class="widget-action" data-action="edit">‚öô</div>
                        <div class="widget-action" data-action="duplicate">‚éò</div>
                        <div class="widget-action" data-action="delete">√ó</div>
                    </div>
                </div>
                <div class="widget-content" id="widget-content-${widget.id}"></div>
                <div class="resize-handle corner nw"></div>
                <div class="resize-handle corner ne"></div>
                <div class="resize-handle corner sw"></div>
                <div class="resize-handle corner se"></div>
                <div class="resize-handle edge n"></div>
                <div class="resize-handle edge s"></div>
                <div class="resize-handle edge w"></div>
                <div class="resize-handle edge e"></div>
            `;

            // Widget actions
            div.querySelectorAll('.widget-action').forEach(action => {
                action.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const actionType = action.dataset.action;
                    if (actionType === 'edit') openEditModal(widget.id);
                    else if (actionType === 'duplicate') duplicateWidget(widget.id);
                    else if (actionType === 'delete') deleteWidget(widget.id);
                });
            });

            // Selection
            div.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle')) return;

                state.selectedWidget = widget.id;
                state.draggedWidget = widget.id;
                state.dragStartX = e.clientX - widget.x;
                state.dragStartY = e.clientY - widget.y;

                bringToFront(widget.id);
                renderCanvas();
            });

            // Resize handles
            div.querySelectorAll('.resize-handle').forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    state.resizingWidget = widget.id;
                    state.resizeDirection = handle.className.split(' ')[1];
                    state.dragStartX = e.clientX;
                    state.dragStartY = e.clientY;
                });
            });

            return div;
        }

        function renderWidgetContent(widget) {
            const container = document.getElementById(`widget-content-${widget.id}`);
            if (!container) return;

            switch(widget.type) {
                case 'bar-chart':
                    renderBarChart(container, widget);
                    break;
                case 'line-chart':
                    renderLineChart(container, widget);
                    break;
                case 'pie-chart':
                    renderPieChart(container, widget);
                    break;
                case 'gauge':
                    renderGauge(container, widget);
                    break;
                case 'sparkline':
                    renderSparkline(container, widget);
                    break;
                case 'number-card':
                    renderNumberCard(container, widget);
                    break;
                case 'table':
                    renderTable(container, widget);
                    break;
                case 'text':
                    renderText(container, widget);
                    break;
            }
        }

        // Chart Rendering Functions
        function renderBarChart(container, widget) {
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const width = container.clientWidth;
            const height = container.clientHeight;
            canvas.width = width;
            canvas.height = height;

            const data = widget.data;
            const config = widget.config;
            const padding = 40;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;

            // Find max value
            const maxValue = Math.max(...data.map(d => d.value));
            const barWidth = chartWidth / data.length * 0.8;
            const gap = chartWidth / data.length * 0.2;

            // Draw bars
            data.forEach((item, i) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = padding + (i * (barWidth + gap));
                const y = height - padding - barHeight;

                ctx.fillStyle = config.colors[i % config.colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);

                // Labels
                if (config.showLabels) {
                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary');
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(item.label, x + barWidth / 2, height - padding + 20);
                    ctx.fillText(item.value, x + barWidth / 2, y - 5);
                }
            });

            // Y-axis
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border');
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
        }

        function renderLineChart(container, widget) {
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const width = container.clientWidth;
            const height = container.clientHeight;
            canvas.width = width;
            canvas.height = height;

            const data = widget.data;
            const config = widget.config;
            const padding = 40;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;

            const maxValue = Math.max(...data.map(d => d.value));
            const minValue = Math.min(...data.map(d => d.value));
            const range = maxValue - minValue;

            // Draw line
            ctx.strokeStyle = config.colors[0];
            ctx.lineWidth = 2;
            ctx.beginPath();

            data.forEach((item, i) => {
                const x = padding + (i / (data.length - 1)) * chartWidth;
                const y = height - padding - ((item.value - minValue) / range) * chartHeight;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                // Draw point
                ctx.fillStyle = config.colors[0];
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();

                // Labels
                if (config.showLabels) {
                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary');
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(item.label, x, height - padding + 20);
                }
            });

            ctx.strokeStyle = config.colors[0];
            ctx.stroke();

            // Axes
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border');
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
        }

        function renderPieChart(container, widget) {
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const width = container.clientWidth;
            const height = container.clientHeight;
            canvas.width = width;
            canvas.height = height;

            const data = widget.data;
            const config = widget.config;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 - 40;

            const total = data.reduce((sum, item) => sum + item.value, 0);
            let currentAngle = -Math.PI / 2;

            data.forEach((item, i) => {
                const sliceAngle = (item.value / total) * Math.PI * 2;

                ctx.fillStyle = config.colors[i % config.colors.length];
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();

                // Labels
                if (config.showLabels) {
                    const labelAngle = currentAngle + sliceAngle / 2;
                    const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                    const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);

                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 12px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(Math.round((item.value / total) * 100) + '%', labelX, labelY);
                }

                currentAngle += sliceAngle;
            });

            // Legend
            if (config.showLegend) {
                const legendX = 10;
                let legendY = 10;

                data.forEach((item, i) => {
                    ctx.fillStyle = config.colors[i % config.colors.length];
                    ctx.fillRect(legendX, legendY, 15, 15);

                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary');
                    ctx.font = '12px sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText(item.label, legendX + 20, legendY + 12);

                    legendY += 20;
                });
            }
        }

        function renderGauge(container, widget) {
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const width = container.clientWidth;
            const height = container.clientHeight;
            canvas.width = width;
            canvas.height = height;

            const data = widget.data;
            const config = widget.config;
            const centerX = width / 2;
            const centerY = height - 30;
            const radius = Math.min(width, height) / 2 - 20;

            const percentage = (data.value - data.min) / (data.max - data.min);
            const startAngle = Math.PI;
            const endAngle = Math.PI * 2;
            const valueAngle = startAngle + (endAngle - startAngle) * percentage;

            // Background arc
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border');
            ctx.lineWidth = 20;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.stroke();

            // Value arc
            ctx.strokeStyle = config.colors[0];
            ctx.lineWidth = 20;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, valueAngle);
            ctx.stroke();

            // Value text
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary');
            ctx.font = 'bold 32px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(data.value, centerX, centerY - 10);

            ctx.font = '14px sans-serif';
            ctx.fillText(`${data.min} - ${data.max}`, centerX, centerY + 15);
        }

        function renderSparkline(container, widget) {
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const width = container.clientWidth;
            const height = container.clientHeight;
            canvas.width = width;
            canvas.height = height;

            const data = widget.data;
            const config = widget.config;
            const padding = 5;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;

            const maxValue = Math.max(...data);
            const minValue = Math.min(...data);
            const range = maxValue - minValue;

            ctx.strokeStyle = config.colors[0];
            ctx.lineWidth = 2;
            ctx.beginPath();

            data.forEach((value, i) => {
                const x = padding + (i / (data.length - 1)) * chartWidth;
                const y = height - padding - ((value - minValue) / range) * chartHeight;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // Fill area
            ctx.lineTo(width - padding, height - padding);
            ctx.lineTo(padding, height - padding);
            ctx.closePath();
            ctx.fillStyle = config.colors[0] + '30';
            ctx.fill();
        }

        function renderNumberCard(container, widget) {
            const data = widget.data;
            const trendIcon = data.trend === 'up' ? '‚Üë' : data.trend === 'down' ? '‚Üì' : '‚Üí';
            const trendColor = data.trend === 'up' ? '#4caf50' : data.trend === 'down' ? '#e94560' : '#666';

            container.innerHTML = `
                <div class="number-card">
                    <div class="number-card-value" style="color: ${widget.config.colors[0]}">${data.value}</div>
                    <div class="number-card-label">${data.label}</div>
                    <div class="number-card-trend" style="color: ${trendColor}">${trendIcon}</div>
                </div>
            `;
        }

        function renderTable(container, widget) {
            if (!widget.data || widget.data.length === 0) {
                container.innerHTML = '<p>No data</p>';
                return;
            }

            const keys = Object.keys(widget.data[0]);

            container.innerHTML = `
                <div class="widget-table">
                    <table>
                        <thead>
                            <tr>${keys.map(key => `<th data-key="${key}">${key}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${widget.data.map(row => `
                                <tr>${keys.map(key => `<td>${row[key]}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Sortable columns
            container.querySelectorAll('th').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.key;
                    widget.data.sort((a, b) => {
                        if (typeof a[key] === 'number') {
                            return a[key] - b[key];
                        }
                        return String(a[key]).localeCompare(String(b[key]));
                    });
                    saveToLocalStorage();
                    renderWidgetContent(widget);
                });
            });
        }

        function renderText(container, widget) {
            container.innerHTML = `<div class="text-widget">${widget.data}</div>`;
        }

        // Edit Modal
        function openEditModal(widgetId) {
            const dashboard = getCurrentDashboard();
            const widget = dashboard.widgets.find(w => w.id === widgetId);
            if (!widget) return;

            const modal = document.getElementById('editModal');
            const content = document.getElementById('editModalContent');

            let dataEditor = '';

            if (['bar-chart', 'line-chart', 'pie-chart'].includes(widget.type)) {
                dataEditor = `
                    <div class="form-group">
                        <label>Data (JSON)</label>
                        <textarea id="widgetData">${JSON.stringify(widget.data, null, 2)}</textarea>
                        <button class="btn" onclick="generateSampleData('${widget.type}')">Generate Sample Data</button>
                    </div>
                `;
            } else if (widget.type === 'gauge') {
                dataEditor = `
                    <div class="form-group">
                        <label>Minimum Value</label>
                        <input type="number" id="gaugeMin" value="${widget.data.min}">
                    </div>
                    <div class="form-group">
                        <label>Maximum Value</label>
                        <input type="number" id="gaugeMax" value="${widget.data.max}">
                    </div>
                    <div class="form-group">
                        <label>Current Value</label>
                        <input type="number" id="gaugeValue" value="${widget.data.value}">
                    </div>
                `;
            } else if (widget.type === 'sparkline') {
                dataEditor = `
                    <div class="form-group">
                        <label>Data (comma-separated numbers)</label>
                        <input type="text" id="sparklineData" value="${widget.data.join(', ')}">
                    </div>
                `;
            } else if (widget.type === 'number-card') {
                dataEditor = `
                    <div class="form-group">
                        <label>Value</label>
                        <input type="number" id="cardValue" value="${widget.data.value}">
                    </div>
                    <div class="form-group">
                        <label>Label</label>
                        <input type="text" id="cardLabel" value="${widget.data.label}">
                    </div>
                    <div class="form-group">
                        <label>Trend</label>
                        <select id="cardTrend">
                            <option value="up" ${widget.data.trend === 'up' ? 'selected' : ''}>Up</option>
                            <option value="down" ${widget.data.trend === 'down' ? 'selected' : ''}>Down</option>
                            <option value="neutral" ${widget.data.trend === 'neutral' ? 'selected' : ''}>Neutral</option>
                        </select>
                    </div>
                `;
            } else if (widget.type === 'table') {
                dataEditor = `
                    <div class="form-group">
                        <label>Data (JSON)</label>
                        <textarea id="widgetData">${JSON.stringify(widget.data, null, 2)}</textarea>
                    </div>
                `;
            } else if (widget.type === 'text') {
                dataEditor = `
                    <div class="form-group">
                        <label>Text Content</label>
                        <textarea id="textContent">${widget.data}</textarea>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="widgetTitle" value="${widget.title}">
                </div>

                ${dataEditor}

                <div class="form-group">
                    <label>Primary Color</label>
                    <div class="color-input-group">
                        <input type="color" id="widgetColor" value="${widget.config.colors[0]}">
                        <input type="text" value="${widget.config.colors[0]}" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label>Background Color</label>
                    <div class="color-input-group">
                        <input type="color" id="widgetBg" value="${widget.config.backgroundColor === 'transparent' ? '#1e1e3f' : widget.config.backgroundColor}">
                        <button class="btn" onclick="document.getElementById('widgetBg').value = '#1e1e3f'; document.querySelector('[readonly]').value = 'transparent'">Transparent</button>
                    </div>
                </div>

                ${['bar-chart', 'line-chart', 'pie-chart'].includes(widget.type) ? `
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="showLabels" ${widget.config.showLabels ? 'checked' : ''}>
                            Show Labels
                        </label>
                    </div>
                    ${widget.type === 'pie-chart' ? `
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="showLegend" ${widget.config.showLegend ? 'checked' : ''}>
                                Show Legend
                            </label>
                        </div>
                    ` : ''}
                ` : ''}

                <div class="btn-group">
                    <button class="btn primary" onclick="saveWidgetEdit('${widgetId}')">Save</button>
                    <button class="btn" onclick="closeModal()">Cancel</button>
                </div>
            `;

            modal.classList.add('active');
        }

        window.saveWidgetEdit = function(widgetId) {
            const dashboard = getCurrentDashboard();
            const widget = dashboard.widgets.find(w => w.id === widgetId);
            if (!widget) return;

            widget.title = document.getElementById('widgetTitle').value;

            // Update data based on widget type
            if (['bar-chart', 'line-chart', 'pie-chart', 'table'].includes(widget.type)) {
                try {
                    widget.data = JSON.parse(document.getElementById('widgetData').value);
                } catch(e) {
                    alert('Invalid JSON data');
                    return;
                }
            } else if (widget.type === 'gauge') {
                widget.data = {
                    min: parseFloat(document.getElementById('gaugeMin').value),
                    max: parseFloat(document.getElementById('gaugeMax').value),
                    value: parseFloat(document.getElementById('gaugeValue').value)
                };
            } else if (widget.type === 'sparkline') {
                widget.data = document.getElementById('sparklineData').value.split(',').map(v => parseFloat(v.trim()));
            } else if (widget.type === 'number-card') {
                widget.data = {
                    value: parseFloat(document.getElementById('cardValue').value),
                    label: document.getElementById('cardLabel').value,
                    trend: document.getElementById('cardTrend').value
                };
            } else if (widget.type === 'text') {
                widget.data = document.getElementById('textContent').value;
            }

            // Update config
            widget.config.colors[0] = document.getElementById('widgetColor').value;
            widget.config.backgroundColor = document.getElementById('widgetBg').value;

            if (document.getElementById('showLabels')) {
                widget.config.showLabels = document.getElementById('showLabels').checked;
            }
            if (document.getElementById('showLegend')) {
                widget.config.showLegend = document.getElementById('showLegend').checked;
            }

            saveToLocalStorage();
            renderCanvas();
            closeModal();
        };

        window.generateSampleData = function(type) {
            const data = getDefaultData(type);
            document.getElementById('widgetData').value = JSON.stringify(data, null, 2);
        };

        window.closeModal = function() {
            document.getElementById('editModal').classList.remove('active');
        };

        // Event Listeners
        function setupEventListeners() {
            // Widget palette
            document.querySelectorAll('.widget-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.widgetType;
                    createWidget(type, 100, 100);
                });
            });

            // Toolbar
            document.getElementById('toggleSidebarBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('hidden');
            });

            document.getElementById('gridSnapBtn').addEventListener('click', () => {
                state.gridSnap = !state.gridSnap;
                document.getElementById('gridSnapBtn').textContent = `Grid Snap: ${state.gridSnap ? 'ON' : 'OFF'}`;
                document.getElementById('canvas').classList.toggle('grid', state.gridSnap);
            });

            document.getElementById('themeBtn').addEventListener('click', () => {
                state.theme = state.theme === 'dark' ? 'light' : 'dark';
                applyTheme();
                saveToLocalStorage();
            });

            document.getElementById('fullscreenBtn').addEventListener('click', () => {
                document.querySelector('.app-container').classList.toggle('fullscreen-mode');
            });

            document.getElementById('clearBtn').addEventListener('click', () => {
                if (confirm('Clear all widgets from this dashboard?')) {
                    getCurrentDashboard().widgets = [];
                    saveToLocalStorage();
                    renderCanvas();
                }
            });

            document.getElementById('saveBtn').addEventListener('click', () => {
                saveToLocalStorage();
                alert('Dashboard saved!');
            });

            document.getElementById('newDashboardBtn').addEventListener('click', () => {
                const name = prompt('Dashboard name:', `Dashboard ${state.dashboards.length + 1}`);
                if (name) {
                    createNewDashboard(name);
                    renderDashboardTabs();
                    renderCanvas();
                }
            });

            document.getElementById('exportBtn').addEventListener('click', () => {
                const data = JSON.stringify(state.dashboards, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dashboards.json';
                a.click();
            });

            document.getElementById('importBtn').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const imported = JSON.parse(event.target.result);
                            if (confirm('Replace all dashboards with imported data?')) {
                                state.dashboards = imported;
                                state.currentDashboardIndex = 0;
                                saveToLocalStorage();
                                renderDashboardTabs();
                                renderCanvas();
                            }
                        } catch(err) {
                            alert('Invalid JSON file');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            });

            // Mouse events for drag and resize
            document.addEventListener('mousemove', (e) => {
                if (state.draggedWidget) {
                    const dashboard = getCurrentDashboard();
                    const widget = dashboard.widgets.find(w => w.id === state.draggedWidget);
                    if (!widget) return;

                    let newX = e.clientX - state.dragStartX;
                    let newY = e.clientY - state.dragStartY;

                    if (state.gridSnap) {
                        newX = Math.round(newX / 20) * 20;
                        newY = Math.round(newY / 20) * 20;
                    }

                    widget.x = Math.max(0, newX);
                    widget.y = Math.max(0, newY);

                    const widgetEl = document.querySelector(`[data-widget-id="${widget.id}"]`);
                    if (widgetEl) {
                        widgetEl.style.left = widget.x + 'px';
                        widgetEl.style.top = widget.y + 'px';
                    }
                }

                if (state.resizingWidget) {
                    const dashboard = getCurrentDashboard();
                    const widget = dashboard.widgets.find(w => w.id === state.resizingWidget);
                    if (!widget) return;

                    const deltaX = e.clientX - state.dragStartX;
                    const deltaY = e.clientY - state.dragStartY;

                    const dir = state.resizeDirection;

                    if (dir.includes('e')) {
                        widget.width = Math.max(200, widget.width + deltaX);
                    }
                    if (dir.includes('s')) {
                        widget.height = Math.max(150, widget.height + deltaY);
                    }
                    if (dir.includes('w')) {
                        const newWidth = Math.max(200, widget.width - deltaX);
                        if (newWidth >= 200) {
                            widget.x += deltaX;
                            widget.width = newWidth;
                        }
                    }
                    if (dir.includes('n')) {
                        const newHeight = Math.max(150, widget.height - deltaY);
                        if (newHeight >= 150) {
                            widget.y += deltaY;
                            widget.height = newHeight;
                        }
                    }

                    state.dragStartX = e.clientX;
                    state.dragStartY = e.clientY;

                    const widgetEl = document.querySelector(`[data-widget-id="${widget.id}"]`);
                    if (widgetEl) {
                        widgetEl.style.left = widget.x + 'px';
                        widgetEl.style.top = widget.y + 'px';
                        widgetEl.style.width = widget.width + 'px';
                        widgetEl.style.height = widget.height + 'px';
                        renderWidgetContent(widget);
                    }
                }
            });

            document.addEventListener('mouseup', () => {
                if (state.draggedWidget || state.resizingWidget) {
                    saveToLocalStorage();
                }
                state.draggedWidget = null;
                state.resizingWidget = null;
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Delete' && state.selectedWidget) {
                    deleteWidget(state.selectedWidget);
                }
                if (e.key === 'Escape') {
                    state.selectedWidget = null;
                    renderCanvas();
                    closeModal();
                }
            });

            // Click outside to deselect
            document.getElementById('canvas').addEventListener('click', (e) => {
                if (e.target.id === 'canvas') {
                    state.selectedWidget = null;
                    renderCanvas();
                }
            });

            // Modal close
            document.getElementById('closeEditModal').addEventListener('click', closeModal);
            document.getElementById('editModal').addEventListener('click', (e) => {
                if (e.target.id === 'editModal') {
                    closeModal();
                }
            });
        }

        function applyTheme() {
            if (state.theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
        }

        // Start
        init();
    </script>
</body>
</html>