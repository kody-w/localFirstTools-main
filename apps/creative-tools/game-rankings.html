<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>App Rankings - Live Leaderboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1a1a2e;
  --border: #2a2a3e;
  --text: #e0e0e8;
  --text-dim: #8888a0;
  --accent: #7c6df0;
  --s: #ffd700;
  --a: #ff6b6b;
  --b: #4ecdc4;
  --c: #45b7d1;
  --d: #96858f;
  --f: #555;
}
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  min-height: 100vh;
}
.header {
  background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
  padding: 24px 32px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}
.header h1 {
  font-size: 1.4em;
  background: linear-gradient(90deg, #7c6df0, #4ecdc4);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.header .meta {
  color: var(--text-dim);
  font-size: 0.8em;
}
.stats-bar {
  display: flex;
  gap: 12px;
  padding: 16px 32px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
}
.stat-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 20px;
  min-width: 120px;
  text-align: center;
}
.stat-card .value {
  font-size: 1.6em;
  font-weight: bold;
  color: var(--accent);
}
.stat-card .label {
  font-size: 0.7em;
  color: var(--text-dim);
  margin-top: 4px;
}
.controls {
  display: flex;
  gap: 12px;
  padding: 16px 32px;
  flex-wrap: wrap;
  align-items: center;
}
.search-box {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 16px;
  border-radius: 6px;
  font-family: inherit;
  font-size: 0.85em;
  width: 260px;
}
.search-box:focus { outline: none; border-color: var(--accent); }
.filter-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 6px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.75em;
  transition: all 0.2s;
}
.filter-btn:hover { border-color: var(--accent); color: var(--text); }
.filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.grade-pills {
  display: flex;
  gap: 6px;
}
.grade-pill {
  width: 30px;
  height: 26px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: bold;
  cursor: pointer;
  border: 1px solid transparent;
  transition: all 0.2s;
}
.grade-pill[data-grade="S"] { background: rgba(255,215,0,0.15); color: var(--s); }
.grade-pill[data-grade="A"] { background: rgba(255,107,107,0.15); color: var(--a); }
.grade-pill[data-grade="B"] { background: rgba(78,205,196,0.15); color: var(--b); }
.grade-pill[data-grade="C"] { background: rgba(69,183,209,0.15); color: var(--c); }
.grade-pill[data-grade="D"] { background: rgba(150,133,143,0.15); color: var(--d); }
.grade-pill[data-grade="F"] { background: rgba(85,85,85,0.15); color: var(--f); }
.grade-pill.active { border-color: currentColor; transform: scale(1.1); }
.grade-pill .count { font-size: 0.6em; opacity: 0.7; margin-left: 2px; }
.charts-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  padding: 16px 32px;
}
.chart-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}
.chart-card h3 {
  font-size: 0.8em;
  color: var(--text-dim);
  margin-bottom: 12px;
}
.histogram {
  display: flex;
  align-items: flex-end;
  gap: 3px;
  height: 80px;
}
.hist-bar {
  flex: 1;
  background: var(--accent);
  border-radius: 2px 2px 0 0;
  min-width: 8px;
  position: relative;
  transition: height 0.5s ease;
  cursor: pointer;
}
.hist-bar:hover { opacity: 0.8; }
.hist-bar .tip {
  display: none;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #000;
  color: #fff;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.65em;
  white-space: nowrap;
}
.hist-bar:hover .tip { display: block; }
.hist-labels {
  display: flex;
  gap: 3px;
  margin-top: 4px;
}
.hist-labels span {
  flex: 1;
  text-align: center;
  font-size: 0.55em;
  color: var(--text-dim);
}
.category-bars {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.cat-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.cat-label {
  font-size: 0.7em;
  color: var(--text-dim);
  width: 100px;
  text-align: right;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.cat-bar-bg {
  flex: 1;
  background: var(--surface2);
  height: 16px;
  border-radius: 3px;
  overflow: hidden;
}
.cat-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s ease;
  display: flex;
  align-items: center;
  padding-left: 6px;
  font-size: 0.6em;
  font-weight: bold;
}
.table-container {
  padding: 0 32px 32px;
}
.rank-table {
  width: 100%;
  border-collapse: collapse;
}
.rank-table th {
  text-align: left;
  padding: 10px 12px;
  font-size: 0.7em;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 2px solid var(--border);
  cursor: pointer;
  user-select: none;
}
.rank-table th:hover { color: var(--accent); }
.rank-table th.sorted::after { content: ' \u25BC'; font-size: 0.8em; }
.rank-table th.sorted.asc::after { content: ' \u25B2'; }
.rank-table td {
  padding: 8px 12px;
  font-size: 0.8em;
  border-bottom: 1px solid var(--border);
}
.rank-table tr { transition: background 0.15s; }
.rank-table tr:hover { background: var(--surface2); }
.rank-num {
  font-weight: bold;
  color: var(--text-dim);
  width: 40px;
}
.rank-num.top3 { color: var(--s); font-size: 1.1em; }
.grade-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 22px;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: bold;
}
.grade-badge.S { background: rgba(255,215,0,0.2); color: var(--s); }
.grade-badge.A { background: rgba(255,107,107,0.2); color: var(--a); }
.grade-badge.B { background: rgba(78,205,196,0.2); color: var(--b); }
.grade-badge.C { background: rgba(69,183,209,0.2); color: var(--c); }
.grade-badge.D { background: rgba(150,133,143,0.2); color: var(--d); }
.grade-badge.F { background: rgba(85,85,85,0.2); color: var(--f); }
.score-bar {
  display: flex;
  align-items: center;
  gap: 8px;
}
.score-bar-bg {
  width: 100px;
  height: 6px;
  background: var(--surface2);
  border-radius: 3px;
  overflow: hidden;
}
.score-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.3s;
}
.dim-dots {
  display: flex;
  gap: 3px;
}
.dim-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  opacity: 0.3;
}
.dim-dot.lit { opacity: 1; }
.dim-dot[data-dim="structural"] { background: #4ecdc4; }
.dim-dot[data-dim="scale"] { background: #ffd700; }
.dim-dot[data-dim="systems"] { background: #ff6b6b; }
.dim-dot[data-dim="completeness"] { background: #45b7d1; }
.dim-dot[data-dim="polish"] { background: #7c6df0; }
.app-link {
  color: var(--text);
  text-decoration: none;
}
.app-link:hover { color: var(--accent); text-decoration: underline; }
.cat-tag {
  font-size: 0.65em;
  padding: 2px 6px;
  background: var(--surface2);
  border-radius: 3px;
  color: var(--text-dim);
}
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 60vh;
  font-size: 1.2em;
  color: var(--text-dim);
}
.loading .spinner {
  width: 24px;
  height: 24px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.error { color: var(--a); text-align: center; padding: 40px; }
.refresh-btn {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 6px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.75em;
}
.refresh-btn:hover { opacity: 0.85; }
.dim-legend {
  display: flex;
  gap: 10px;
  font-size: 0.65em;
  color: var(--text-dim);
  padding: 0 32px 8px;
}
.dim-legend span::before {
  content: '';
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 4px;
  vertical-align: middle;
}
.dim-legend .str::before { background: #4ecdc4; }
.dim-legend .scl::before { background: #ffd700; }
.dim-legend .sys::before { background: #ff6b6b; }
.dim-legend .cmp::before { background: #45b7d1; }
.dim-legend .pol::before { background: #7c6df0; }
@media (max-width: 768px) {
  .charts-row { grid-template-columns: 1fr; }
  .header, .stats-bar, .controls, .table-container { padding-left: 16px; padding-right: 16px; }
  .search-box { width: 100%; }
  .rank-table td, .rank-table th { padding: 6px 8px; font-size: 0.7em; }
}
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>App Rankings</h1>
    <div class="meta" id="meta">Loading...</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="refresh-btn" onclick="loadRankings()">Refresh</button>
    <label style="font-size:0.7em;color:var(--text-dim)">
      <input type="checkbox" id="autoRefresh" checked> Auto (60s)
    </label>
  </div>
</div>

<div class="stats-bar" id="statsBar"></div>

<div class="charts-row">
  <div class="chart-card">
    <h3>Score Distribution</h3>
    <div class="histogram" id="histogram"></div>
    <div class="hist-labels" id="histLabels"></div>
  </div>
  <div class="chart-card">
    <h3>Category Averages</h3>
    <div class="category-bars" id="categoryBars"></div>
  </div>
</div>

<div class="controls">
  <input type="text" class="search-box" id="search" placeholder="Search apps..." />
  <div class="grade-pills" id="gradePills"></div>
  <select class="search-box" id="catFilter" style="width:160px">
    <option value="">All Categories</option>
  </select>
  <span style="font-size:0.7em;color:var(--text-dim)" id="resultCount"></span>
</div>

<div class="dim-legend">
  <span class="str">Structural</span>
  <span class="scl">Scale</span>
  <span class="sys">Systems</span>
  <span class="cmp">Complete</span>
  <span class="pol">Polish</span>
</div>

<div class="table-container">
  <table class="rank-table">
    <thead>
      <tr>
        <th data-sort="rank" class="sorted">#</th>
        <th data-sort="grade">Grade</th>
        <th data-sort="title">App</th>
        <th data-sort="score">Score</th>
        <th>Dimensions</th>
        <th data-sort="lines">Lines</th>
        <th data-sort="size_kb">Size</th>
        <th data-sort="category">Category</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="loading" id="loading">
  <div class="spinner"></div>
  Loading rankings...
</div>

<script>
const CDN_BASE = '';
const RANKINGS_URL = '../rankings.json';
const SITE_BASE = 'https://kody-w.github.io/localFirstTools-main/';

let data = null;
let filtered = [];
let sortKey = 'rank';
let sortAsc = true;
let gradeFilter = null;
let catFilter = '';
let searchQuery = '';
let refreshTimer = null;

async function loadRankings() {
  const el = document.getElementById('loading');
  try {
    el.style.display = 'flex';
    const urls = [
      RANKINGS_URL,
      SITE_BASE + 'apps/rankings.json',
      './rankings.json',
    ];
    let resp;
    for (const url of urls) {
      try {
        resp = await fetch(url + '?t=' + Date.now());
        if (resp.ok) break;
      } catch(e) { continue; }
    }
    if (!resp || !resp.ok) throw new Error('Could not load rankings.json');
    data = await resp.json();
    el.style.display = 'none';
    renderAll();
  } catch(err) {
    el.innerHTML = `<div class="error">Failed to load rankings: ${err.message}<br><button class="refresh-btn" onclick="loadRankings()" style="margin-top:12px">Retry</button></div>`;
  }
}

function renderAll() {
  renderMeta();
  renderStats();
  renderHistogram();
  renderCategoryBars();
  renderGradePills();
  renderCatFilter();
  applyFilters();
}

function renderMeta() {
  const d = new Date(data.generated);
  document.getElementById('meta').textContent =
    `${data.total_apps} apps ranked | Generated ${d.toLocaleDateString()} ${d.toLocaleTimeString()} | Avg ${data.summary.avg_score}`;
}

function renderStats() {
  const s = data.summary;
  const cards = [
    { value: data.total_apps, label: 'Total Apps' },
    { value: s.avg_score, label: 'Avg Score' },
    { value: s.median_score, label: 'Median' },
    { value: s.top_10_avg, label: 'Top 10 Avg' },
    { value: s.grade_distribution.S || 0, label: 'S-Tier' },
    { value: s.grade_distribution.A || 0, label: 'A-Tier' },
    { value: s.grade_distribution.B || 0, label: 'B-Tier' },
  ];
  document.getElementById('statsBar').innerHTML = cards.map(c =>
    `<div class="stat-card"><div class="value">${c.value}</div><div class="label">${c.label}</div></div>`
  ).join('');
}

function renderHistogram() {
  const hist = data.summary.score_histogram;
  const buckets = ['0-9','10-19','20-29','30-39','40-49','50-59','60-69','70-79','80-89','90-99'];
  const vals = buckets.map(b => hist[b] || 0);
  const max = Math.max(...vals, 1);
  const colors = ['#555','#555','#96858f','#96858f','#45b7d1','#45b7d1','#4ecdc4','#4ecdc4','#ff6b6b','#ffd700'];
  document.getElementById('histogram').innerHTML = vals.map((v, i) =>
    `<div class="hist-bar" style="height:${(v/max)*100}%;background:${colors[i]}"><span class="tip">${buckets[i]}: ${v}</span></div>`
  ).join('');
  document.getElementById('histLabels').innerHTML = buckets.map(b =>
    `<span>${b.split('-')[0]}</span>`
  ).join('');
}

function renderCategoryBars() {
  const cats = data.categories;
  const entries = Object.entries(cats).sort((a,b) => b[1].avg_score - a[1].avg_score);
  const max = Math.max(...entries.map(e => e[1].avg_score), 1);
  document.getElementById('categoryBars').innerHTML = entries.map(([key, cat]) => {
    const pct = (cat.avg_score / 100) * 100;
    const color = cat.avg_score >= 70 ? '#4ecdc4' : cat.avg_score >= 55 ? '#45b7d1' : '#96858f';
    return `<div class="cat-row">
      <span class="cat-label">${cat.title || key}</span>
      <div class="cat-bar-bg">
        <div class="cat-bar-fill" style="width:${pct}%;background:${color}">${cat.avg_score} (${cat.count})</div>
      </div>
    </div>`;
  }).join('');
}

function renderGradePills() {
  const dist = data.summary.grade_distribution;
  const grades = ['S','A','B','C','D','F'];
  document.getElementById('gradePills').innerHTML = grades.map(g =>
    `<div class="grade-pill ${gradeFilter === g ? 'active' : ''}" data-grade="${g}" onclick="toggleGrade('${g}')">${g}<span class="count">${dist[g]||0}</span></div>`
  ).join('');
}

function renderCatFilter() {
  const sel = document.getElementById('catFilter');
  const existing = sel.value;
  sel.innerHTML = '<option value="">All Categories</option>' +
    Object.entries(data.categories).map(([key, cat]) =>
      `<option value="${key}" ${key === existing ? 'selected' : ''}>${cat.title || key} (${cat.count})</option>`
    ).join('');
}

function toggleGrade(g) {
  gradeFilter = gradeFilter === g ? null : g;
  renderGradePills();
  applyFilters();
}

function applyFilters() {
  filtered = data.rankings.filter(app => {
    if (gradeFilter && app.grade !== gradeFilter) return false;
    if (catFilter && app.category !== catFilter) return false;
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      if (!app.title.toLowerCase().includes(q) && !app.file.toLowerCase().includes(q)) return false;
    }
    return true;
  });
  sortFiltered();
  renderTable();
  document.getElementById('resultCount').textContent = `${filtered.length} of ${data.total_apps}`;
}

function sortFiltered() {
  filtered.sort((a, b) => {
    let va = a[sortKey], vb = b[sortKey];
    if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });
}

function getScoreColor(score) {
  if (score >= 90) return 'var(--s)';
  if (score >= 80) return 'var(--a)';
  if (score >= 65) return 'var(--b)';
  if (score >= 50) return 'var(--c)';
  if (score >= 35) return 'var(--d)';
  return 'var(--f)';
}

function dimLit(dims, name, threshold) {
  const d = dims[name];
  return d && (d.score / d.max) >= threshold;
}

function renderTable() {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = filtered.map(app => {
    const dims = app.dimensions || {};
    const dimNames = ['structural','scale','systems','completeness','polish'];
    return `<tr>
      <td class="rank-num ${app.rank <= 3 ? 'top3' : ''}">${app.rank}</td>
      <td><span class="grade-badge ${app.grade}">${app.grade}</span></td>
      <td><a href="${SITE_BASE}${app.path}" target="_blank" class="app-link">${escHtml(app.title)}</a></td>
      <td>
        <div class="score-bar">
          <span>${app.score}</span>
          <div class="score-bar-bg">
            <div class="score-bar-fill" style="width:${app.score}%;background:${getScoreColor(app.score)}"></div>
          </div>
        </div>
      </td>
      <td>
        <div class="dim-dots">
          ${dimNames.map(d => `<div class="dim-dot ${dimLit(dims, d, 0.5) ? 'lit' : ''}" data-dim="${d}" title="${d}: ${dims[d]?.score || 0}/${dims[d]?.max || 0}"></div>`).join('')}
        </div>
      </td>
      <td>${app.lines.toLocaleString()}</td>
      <td>${app.size_kb}KB</td>
      <td><span class="cat-tag">${app.category_folder || app.category}</span></td>
    </tr>`;
  }).join('');
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Sort headers
document.querySelectorAll('.rank-table th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.sort;
    if (sortKey === key) {
      sortAsc = !sortAsc;
    } else {
      sortKey = key;
      sortAsc = key === 'rank' || key === 'title' || key === 'category';
    }
    document.querySelectorAll('.rank-table th').forEach(t => t.classList.remove('sorted','asc'));
    th.classList.add('sorted');
    if (sortAsc) th.classList.add('asc');
    applyFilters();
  });
});

// Search
document.getElementById('search').addEventListener('input', e => {
  searchQuery = e.target.value;
  applyFilters();
});

// Category filter
document.getElementById('catFilter').addEventListener('change', e => {
  catFilter = e.target.value;
  applyFilters();
});

// Auto-refresh
function startAutoRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);
  if (document.getElementById('autoRefresh').checked) {
    refreshTimer = setInterval(loadRankings, 60000);
  }
}
document.getElementById('autoRefresh').addEventListener('change', startAutoRefresh);

// Keyboard shortcut
document.addEventListener('keydown', e => {
  if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
    e.preventDefault();
    document.getElementById('search').focus();
  }
});

// Init
loadRankings();
startAutoRefresh();
</script>
</body>
</html>
