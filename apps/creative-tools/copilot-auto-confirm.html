<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Copilot Auto-Confirm Tool</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0d1117;--surface:#161b22;--surface2:#21262d;--border:#30363d;--text:#c9d1d9;--text-dim:#8b949e;--accent:#58a6ff;--accent2:#3fb950;--danger:#f85149;--warn:#d29922;--radius:8px;--mono:'SF Mono',Monaco,Consolas,'Liberation Mono',monospace}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}
.app{max-width:960px;margin:0 auto;padding:16px}
h1{font-size:1.5rem;margin-bottom:4px;display:flex;align-items:center;gap:8px}
h1 .icon{font-size:1.8rem}
.subtitle{color:var(--text-dim);font-size:.875rem;margin-bottom:20px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:700px){.grid{grid-template-columns:1fr}}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.card h2{font-size:1rem;margin-bottom:12px;color:var(--accent);display:flex;align-items:center;gap:6px}
.card.full{grid-column:1/-1}
/* Toggle */
.toggle-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.toggle-label{font-weight:600;font-size:.9rem}
.toggle{position:relative;width:52px;height:28px;cursor:pointer}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;inset:0;background:var(--surface2);border-radius:28px;border:1px solid var(--border);transition:.2s}
.toggle .slider::before{content:'';position:absolute;left:3px;top:3px;width:20px;height:20px;background:var(--text-dim);border-radius:50%;transition:.2s}
.toggle input:checked+.slider{background:var(--accent2);border-color:var(--accent2)}
.toggle input:checked+.slider::before{transform:translateX(24px);background:#fff}
/* Inputs */
input[type=text],input[type=number],textarea,select{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:8px 10px;width:100%;font-size:.85rem;font-family:var(--mono)}
textarea{resize:vertical;min-height:60px}
select{cursor:pointer}
label{display:block;font-size:.8rem;color:var(--text-dim);margin-bottom:4px}
.field{margin-bottom:10px}
/* Buttons */
.btn{padding:8px 16px;border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:500;transition:.15s;font-family:inherit}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn-primary:hover{opacity:.85}
.btn-success{background:var(--accent2);color:#fff;border-color:var(--accent2)}
.btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
.btn-ghost{background:transparent;color:var(--text-dim)}
.btn-ghost:hover{color:var(--text);background:var(--surface2)}
.btn-sm{padding:4px 10px;font-size:.78rem}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
/* Stats */
.stats{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
.stat{text-align:center}
.stat .num{font-size:1.8rem;font-weight:700;color:var(--accent);font-family:var(--mono);line-height:1.2}
.stat .lbl{font-size:.7rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px}
.stat.active .num{color:var(--accent2)}
.stat.danger .num{color:var(--danger)}
/* Status bar */
.status-bar{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.status-indicator{display:flex;align-items:center;gap:8px}
.dot{width:10px;height:10px;border-radius:50%;background:var(--text-dim)}
.dot.on{background:var(--accent2);box-shadow:0 0 8px var(--accent2)}
.dot.paused{background:var(--warn);box-shadow:0 0 8px var(--warn)}
.shortcut{font-size:.75rem;color:var(--text-dim);font-family:var(--mono)}
kbd{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:1px 6px;font-size:.75rem;font-family:var(--mono)}
/* Log */
.log-area{background:var(--bg);border:1px solid var(--border);border-radius:6px;height:200px;overflow-y:auto;padding:8px;font-family:var(--mono);font-size:.78rem}
.log-entry{padding:3px 0;border-bottom:1px solid var(--surface2);display:flex;gap:8px}
.log-entry .ts{color:var(--text-dim);white-space:nowrap}
.log-entry .msg{color:var(--accent2)}
.log-entry.blocked .msg{color:var(--danger)}
.log-entry.info .msg{color:var(--accent)}
/* Slider */
.slider-row{display:flex;align-items:center;gap:10px}
.slider-row input[type=range]{flex:1;accent-color:var(--accent)}
.slider-val{font-family:var(--mono);font-size:.8rem;min-width:50px;text-align:right}
/* Tag list */
.tag-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.tag{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:3px 10px;font-size:.78rem;display:flex;align-items:center;gap:4px;font-family:var(--mono)}
.tag .remove{cursor:pointer;color:var(--danger);font-weight:700;margin-left:2px}
.tag .remove:hover{opacity:.7}
.tag.block{border-color:var(--danger);color:var(--danger)}
/* Code block */
.code-block{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;font-family:var(--mono);font-size:.8rem;overflow-x:auto;position:relative;margin-bottom:8px;white-space:pre-wrap;word-break:break-all}
.code-block .copy-btn{position:absolute;top:6px;right:6px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);border-radius:4px;padding:2px 8px;font-size:.7rem;cursor:pointer}
.code-block .copy-btn:hover{color:var(--text)}
/* Tabs */
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:12px}
.tab{padding:8px 16px;font-size:.85rem;cursor:pointer;border-bottom:2px solid transparent;color:var(--text-dim);transition:.15s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-content{display:none}
.tab-content.active{display:block}
/* Time window */
.time-row{display:flex;align-items:center;gap:8px;margin-top:8px}
.time-row input[type=time]{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:6px 8px;font-family:var(--mono)}
/* Generator */
.gen-output{margin-top:10px}
.tip{background:var(--surface2);border-left:3px solid var(--warn);padding:8px 12px;border-radius:0 6px 6px 0;font-size:.8rem;color:var(--text-dim);margin-bottom:12px}
.section-title{font-size:.85rem;font-weight:600;margin:12px 0 6px;color:var(--text)}
</style>
</head>
<body>
<div class="app">
<h1><span class="icon">‚ö°</span> Copilot Auto-Confirm Tool</h1>
<p class="subtitle">Auto-respond to terminal confirmation prompts &middot; Command wrapper generator &middot; <kbd>Ctrl+Shift+Y</kbd> to toggle</p>

<div class="status-bar">
  <div class="status-indicator">
    <div class="dot" id="statusDot"></div>
    <span id="statusText">Inactive</span>
  </div>
  <div class="stats">
    <div class="stat active"><div class="num" id="confirmCount">0</div><div class="lbl">Confirmed</div></div>
    <div class="stat danger"><div class="num" id="blockCount">0</div><div class="lbl">Blocked</div></div>
    <div class="stat"><div class="num" id="sessionTime">0:00</div><div class="lbl">Session</div></div>
  </div>
  <div class="shortcut"><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Y</kbd></div>
</div>

<div class="tabs" id="mainTabs">
  <div class="tab active" data-tab="monitor">Monitor</div>
  <div class="tab" data-tab="terminal">Terminal Setup</div>
  <div class="tab" data-tab="settings">Settings</div>
</div>

<!-- Monitor Tab -->
<div class="tab-content active" id="tab-monitor">
<div class="grid">
  <div class="card">
    <h2>üîÑ Auto-Confirm Control</h2>
    <div class="toggle-row">
      <span class="toggle-label">Auto-Confirm Active</span>
      <label class="toggle"><input type="checkbox" id="mainToggle"><span class="slider"></span></label>
    </div>
    <div class="toggle-row">
      <span class="toggle-label">Sound Notifications</span>
      <label class="toggle"><input type="checkbox" id="soundToggle"><span class="slider"></span></label>
    </div>
    <div class="toggle-row">
      <span class="toggle-label">Safety Mode (Time Window)</span>
      <label class="toggle"><input type="checkbox" id="safetyToggle"><span class="slider"></span></label>
    </div>
    <div id="timeWindow" style="display:none">
      <div class="time-row">
        <label>From</label><input type="time" id="timeFrom" value="09:00">
        <label>To</label><input type="time" id="timeTo" value="17:00">
      </div>
    </div>
    <div class="field" style="margin-top:12px">
      <label>Response Delay</label>
      <div class="slider-row">
        <input type="range" id="delaySlider" min="50" max="2000" value="200" step="50">
        <span class="slider-val" id="delayVal">200ms</span>
      </div>
    </div>
    <div class="field">
      <label>Default Response</label>
      <select id="defaultResponse">
        <option value="y">y</option>
        <option value="yes">yes</option>
        <option value="\n">Enter (empty)</option>
        <option value="custom">Custom...</option>
      </select>
    </div>
    <div class="field" id="customResponseField" style="display:none">
      <label>Custom Response</label>
      <input type="text" id="customResponse" placeholder="Type custom response...">
    </div>
    <div class="btn-row">
      <button class="btn btn-primary btn-sm" id="pauseBtn" disabled>‚è∏ Pause</button>
      <button class="btn btn-ghost btn-sm" id="resetBtn">‚Ü∫ Reset Counters</button>
    </div>
  </div>

  <div class="card">
    <h2>üìã Clipboard Monitor</h2>
    <div class="tip">üí° This tool monitors your clipboard for confirmation prompts. Copy terminal output to trigger auto-responses copied back to clipboard.</div>
    <div class="field">
      <label>Last Clipboard Content</label>
      <div class="code-block" id="clipboardPreview" style="min-height:40px;max-height:100px;overflow-y:auto">No clipboard data yet</div>
    </div>
    <div class="field">
      <label>Match Status</label>
      <div id="matchStatus" style="font-size:.85rem;color:var(--text-dim)">Waiting for clipboard content...</div>
    </div>
    <button class="btn btn-ghost btn-sm" id="testClipBtn">üìé Test with Sample Prompt</button>
  </div>

  <div class="card full">
    <h2>üìú Activity Log</h2>
    <div class="log-area" id="logArea"></div>
    <div class="btn-row">
      <button class="btn btn-ghost btn-sm" id="exportLogBtn">üì§ Export Log (JSON)</button>
      <button class="btn btn-ghost btn-sm" id="clearLogBtn">üóë Clear Log</button>
    </div>
  </div>
</div>
</div>

<!-- Terminal Setup Tab -->
<div class="tab-content" id="tab-terminal">
<div class="grid">
  <div class="card full">
    <h2>üñ• Terminal Setup Guide</h2>
    <div class="tip">Since browsers can't directly interact with terminals, use these proven methods to auto-confirm CLI prompts. The command wrapper below generates ready-to-use commands.</div>

    <p class="section-title">Quick Methods</p>
    <div class="code-block">yes | gh copilot suggest "explain this code"<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
    <div class="code-block">echo "y" | gh copilot explain<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
    <div class="code-block">printf 'y\ny\ny\n' | some-interactive-command<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>

    <p class="section-title">Using <code>expect</code> (Complex Interactions)</p>
    <div class="code-block">#!/usr/bin/expect -f
spawn gh copilot suggest "build a web server"
expect {
  "? " { send "y\r"; exp_continue }
  "(Y/n)" { send "Y\r"; exp_continue }
  eof
}<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>

    <p class="section-title">macOS <code>osascript</code> (GUI Automation)</p>
    <div class="code-block">osascript -e 'tell application "Terminal"
  do script "yes | gh copilot suggest \"your query\""
end tell'<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
  </div>

  <div class="card">
    <h2>üîß Command Wrapper Generator</h2>
    <div class="field">
      <label>Your Command</label>
      <input type="text" id="genCommand" placeholder="gh copilot suggest &quot;explain this code&quot;">
    </div>
    <div class="field">
      <label>Auto-Confirm Method</label>
      <select id="genMethod">
        <option value="yes-pipe">yes | command (always y)</option>
        <option value="echo-pipe">echo "y" | command (single y)</option>
        <option value="printf-pipe">printf multi-response</option>
        <option value="expect">expect script</option>
        <option value="osascript">macOS osascript</option>
      </select>
    </div>
    <div class="field" id="printfField" style="display:none">
      <label>Responses (one per line)</label>
      <textarea id="printfResponses" rows="3" placeholder="y&#10;yes&#10;1"></textarea>
    </div>
    <button class="btn btn-primary btn-sm" id="generateBtn">Generate Command</button>
    <div class="gen-output" id="genOutput"></div>
  </div>

  <div class="card">
    <h2>üìù Expect Script Generator</h2>
    <div class="field">
      <label>Command to Run</label>
      <input type="text" id="expectCmd" placeholder="gh copilot suggest &quot;my query&quot;">
    </div>
    <div class="field">
      <label>Prompt‚ÜíResponse Pairs (one per line, prompt=response)</label>
      <textarea id="expectPairs" rows="4" placeholder="(Y/n)=Y&#10;Continue?=yes&#10;? =y"></textarea>
    </div>
    <button class="btn btn-primary btn-sm" id="expectGenBtn">Generate Expect Script</button>
    <div class="gen-output" id="expectOutput"></div>
  </div>
</div>
</div>

<!-- Settings Tab -->
<div class="tab-content" id="tab-settings">
<div class="grid">
  <div class="card">
    <h2>üéØ Watch Patterns</h2>
    <p style="font-size:.8rem;color:var(--text-dim);margin-bottom:8px">Regex patterns that trigger auto-confirm when found in clipboard.</p>
    <div class="tag-list" id="patternList"></div>
    <div style="display:flex;gap:6px;margin-top:10px">
      <input type="text" id="newPattern" placeholder="New regex pattern..." style="flex:1">
      <button class="btn btn-primary btn-sm" id="addPatternBtn">Add</button>
    </div>
    <button class="btn btn-ghost btn-sm" style="margin-top:8px" id="resetPatternsBtn">Reset to Defaults</button>
  </div>

  <div class="card">
    <h2>üö´ Blocklist</h2>
    <p style="font-size:.8rem;color:var(--text-dim);margin-bottom:8px">Never auto-confirm when these strings appear in the prompt.</p>
    <div class="tag-list" id="blockList"></div>
    <div style="display:flex;gap:6px;margin-top:10px">
      <input type="text" id="newBlock" placeholder="Blocked string..." style="flex:1">
      <button class="btn btn-danger btn-sm" id="addBlockBtn">Add</button>
    </div>
    <button class="btn btn-ghost btn-sm" style="margin-top:8px" id="resetBlocksBtn">Reset to Defaults</button>
  </div>

  <div class="card">
    <h2>üîÄ Per-Pattern Responses</h2>
    <p style="font-size:.8rem;color:var(--text-dim);margin-bottom:8px">Override the default response for specific patterns.</p>
    <div id="overrideList"></div>
    <div style="display:flex;gap:6px;margin-top:10px">
      <input type="text" id="overridePattern" placeholder="Pattern" style="flex:1">
      <input type="text" id="overrideResponse" placeholder="Response" style="width:80px">
      <button class="btn btn-primary btn-sm" id="addOverrideBtn">Add</button>
    </div>
  </div>

  <div class="card">
    <h2>üíæ Data</h2>
    <div class="btn-row">
      <button class="btn btn-ghost btn-sm" id="exportSettingsBtn">üì§ Export Settings</button>
      <button class="btn btn-ghost btn-sm" id="importSettingsBtn">üì• Import Settings</button>
      <button class="btn btn-danger btn-sm" id="clearAllBtn">üóë Reset All</button>
    </div>
    <input type="file" id="importFile" accept=".json" style="display:none">
  </div>
</div>
</div>

</div>

<script>
const STORAGE_KEY = 'copilot-auto-confirm';
const DEFAULT_PATTERNS = ['\\(y/n\\)', '\\(Y/n\\)', '\\(yes/no\\)', 'continue\\?', 'proceed\\?', 'confirm\\?', 'Do you want to', 'Are you sure', '\\? $', '\\[y/N\\]', '\\[Y/n\\]'];
const DEFAULT_BLOCKS = ['delete', 'remove', 'destroy', 'drop', 'erase', 'format', 'purge'];

let state = loadState();
let logs = JSON.parse(localStorage.getItem(STORAGE_KEY + '-logs') || '[]');
let sessionStart = null;
let sessionTimer = null;
let clipboardInterval = null;
let lastClipboard = '';
let paused = false;

function defaultState() {
  return {
    active: false,
    sound: false,
    safety: false,
    timeFrom: '09:00',
    timeTo: '17:00',
    delay: 200,
    defaultResponse: 'y',
    customResponse: '',
    patterns: [...DEFAULT_PATTERNS],
    blocks: [...DEFAULT_BLOCKS],
    overrides: {},
    confirmCount: 0,
    blockCount: 0
  };
}

function loadState() {
  try { return { ...defaultState(), ...JSON.parse(localStorage.getItem(STORAGE_KEY)) }; }
  catch { return defaultState(); }
}

function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function saveLogs() { localStorage.setItem(STORAGE_KEY + '-logs', JSON.stringify(logs.slice(-500))); }

// DOM refs
const $ = id => document.getElementById(id);
const mainToggle = $('mainToggle');
const soundToggle = $('soundToggle');
const safetyToggle = $('safetyToggle');
const delaySlider = $('delaySlider');
const delayVal = $('delayVal');
const statusDot = $('statusDot');
const statusText = $('statusText');
const confirmCount = $('confirmCount');
const blockCount = $('blockCount');
const sessionTime = $('sessionTime');
const logArea = $('logArea');
const pauseBtn = $('pauseBtn');
const defaultResp = $('defaultResponse');
const clipboardPreview = $('clipboardPreview');
const matchStatus = $('matchStatus');

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    $('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// Init UI from state
function initUI() {
  mainToggle.checked = state.active;
  soundToggle.checked = state.sound;
  safetyToggle.checked = state.safety;
  $('timeFrom').value = state.timeFrom;
  $('timeTo').value = state.timeTo;
  delaySlider.value = state.delay;
  delayVal.textContent = state.delay + 'ms';
  defaultResp.value = state.defaultResponse;
  $('customResponse').value = state.customResponse;
  $('customResponseField').style.display = state.defaultResponse === 'custom' ? '' : 'none';
  $('timeWindow').style.display = state.safety ? '' : 'none';
  confirmCount.textContent = state.confirmCount;
  blockCount.textContent = state.blockCount;
  renderPatterns();
  renderBlocks();
  renderOverrides();
  renderLogs();
  updateStatus();
  if (state.active) startMonitoring();
}

function updateStatus() {
  const on = state.active && !paused;
  statusDot.className = 'dot' + (on ? ' on' : paused ? ' paused' : '');
  statusText.textContent = state.active ? (paused ? 'Paused' : 'Active') : 'Inactive';
  pauseBtn.disabled = !state.active;
  pauseBtn.textContent = paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
}

// Sound
function beep() {
  if (!state.sound) return;
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = 880; o.type = 'sine';
    g.gain.value = 0.1;
    o.start(); o.stop(ctx.currentTime + 0.08);
  } catch {}
}

// Logging
function addLog(msg, type = '') {
  const ts = new Date().toLocaleTimeString();
  logs.push({ ts, msg, type, date: new Date().toISOString() });
  saveLogs();
  const el = document.createElement('div');
  el.className = 'log-entry' + (type ? ' ' + type : '');
  el.innerHTML = `<span class="ts">${ts}</span><span class="msg">${esc(msg)}</span>`;
  logArea.appendChild(el);
  logArea.scrollTop = logArea.scrollHeight;
}

function renderLogs() {
  logArea.innerHTML = '';
  logs.slice(-100).forEach(l => {
    const el = document.createElement('div');
    el.className = 'log-entry' + (l.type ? ' ' + l.type : '');
    el.innerHTML = `<span class="ts">${l.ts}</span><span class="msg">${esc(l.msg)}</span>`;
    logArea.appendChild(el);
  });
  logArea.scrollTop = logArea.scrollHeight;
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// Pattern/Block management
function renderPatterns() {
  const el = $('patternList');
  el.innerHTML = state.patterns.map((p, i) =>
    `<span class="tag"><code>${esc(p)}</code><span class="remove" data-idx="${i}" data-type="pattern">√ó</span></span>`
  ).join('');
  el.querySelectorAll('.remove').forEach(b => b.onclick = () => {
    state.patterns.splice(+b.dataset.idx, 1); saveState(); renderPatterns();
  });
}

function renderBlocks() {
  const el = $('blockList');
  el.innerHTML = state.blocks.map((b, i) =>
    `<span class="tag block"><code>${esc(b)}</code><span class="remove" data-idx="${i}" data-type="block">√ó</span></span>`
  ).join('');
  el.querySelectorAll('.remove').forEach(b => b.onclick = () => {
    state.blocks.splice(+b.dataset.idx, 1); saveState(); renderBlocks();
  });
}

function renderOverrides() {
  const el = $('overrideList');
  const entries = Object.entries(state.overrides);
  el.innerHTML = entries.length ? entries.map(([p, r]) =>
    `<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
      <code class="tag" style="flex:1">${esc(p)}</code>
      <span style="color:var(--text-dim)">‚Üí</span>
      <code style="color:var(--accent2)">${esc(r)}</code>
      <span class="remove" style="color:var(--danger);cursor:pointer;font-weight:700" data-key="${esc(p)}">√ó</span>
    </div>`
  ).join('') : '<p style="font-size:.8rem;color:var(--text-dim)">No overrides set</p>';
  el.querySelectorAll('.remove').forEach(b => b.onclick = () => {
    delete state.overrides[b.dataset.key]; saveState(); renderOverrides();
  });
}

// Clipboard monitoring
function startMonitoring() {
  stopMonitoring();
  sessionStart = Date.now();
  sessionTimer = setInterval(() => {
    const s = Math.floor((Date.now() - sessionStart) / 1000);
    sessionTime.textContent = Math.floor(s / 60) + ':' + String(s % 60).padStart(2, '0');
  }, 1000);
  clipboardInterval = setInterval(checkClipboard, 500);
  addLog('Monitoring started', 'info');
}

function stopMonitoring() {
  if (clipboardInterval) clearInterval(clipboardInterval);
  if (sessionTimer) clearInterval(sessionTimer);
  clipboardInterval = null;
  sessionTimer = null;
}

async function checkClipboard() {
  if (paused || !state.active) return;
  if (state.safety && !inTimeWindow()) return;
  try {
    const text = await navigator.clipboard.readText();
    if (!text || text === lastClipboard) return;
    lastClipboard = text;
    clipboardPreview.textContent = text.slice(0, 300);
    processClipboard(text);
  } catch {
    // Clipboard API requires focus/permission
  }
}

function inTimeWindow() {
  const now = new Date();
  const mins = now.getHours() * 60 + now.getMinutes();
  const [fh, fm] = state.timeFrom.split(':').map(Number);
  const [th, tm] = state.timeTo.split(':').map(Number);
  const from = fh * 60 + fm, to = th * 60 + tm;
  return from <= to ? (mins >= from && mins <= to) : (mins >= from || mins <= to);
}

function processClipboard(text) {
  // Check blocklist first
  for (const b of state.blocks) {
    if (text.toLowerCase().includes(b.toLowerCase())) {
      state.blockCount++;
      blockCount.textContent = state.blockCount;
      matchStatus.innerHTML = `<span style="color:var(--danger)">‚õî Blocked: contains "${esc(b)}"</span>`;
      addLog(`Blocked: matched blocklist "${b}" in "${text.slice(0, 60)}..."`, 'blocked');
      beep();
      saveState();
      return;
    }
  }

  // Check patterns
  for (const p of state.patterns) {
    try {
      if (new RegExp(p, 'i').test(text)) {
        const response = state.overrides[p] || getDefaultResponse();
        matchStatus.innerHTML = `<span style="color:var(--accent2)">‚úÖ Matched: /${esc(p)}/ ‚Üí responding "${esc(response)}"</span>`;
        state.confirmCount++;
        confirmCount.textContent = state.confirmCount;
        addLog(`Auto-confirmed: /${p}/ ‚Üí "${response}" for "${text.slice(0, 60)}..."`);
        beep();

        // Write response to clipboard
        const resp = response === '\\n' ? '\n' : response;
        navigator.clipboard.writeText(resp).then(() => {
          lastClipboard = resp;
        });
        saveState();
        return;
      }
    } catch {}
  }
  matchStatus.innerHTML = `<span style="color:var(--text-dim)">No pattern matched</span>`;
}

function getDefaultResponse() {
  if (state.defaultResponse === 'custom') return state.customResponse || 'y';
  if (state.defaultResponse === '\\n') return '\\n';
  return state.defaultResponse;
}

// Event handlers
mainToggle.addEventListener('change', () => {
  state.active = mainToggle.checked;
  paused = false;
  saveState();
  updateStatus();
  if (state.active) startMonitoring(); else { stopMonitoring(); addLog('Monitoring stopped', 'info'); }
});

soundToggle.addEventListener('change', () => { state.sound = soundToggle.checked; saveState(); });
safetyToggle.addEventListener('change', () => {
  state.safety = safetyToggle.checked;
  $('timeWindow').style.display = state.safety ? '' : 'none';
  saveState();
});
$('timeFrom').addEventListener('change', () => { state.timeFrom = $('timeFrom').value; saveState(); });
$('timeTo').addEventListener('change', () => { state.timeTo = $('timeTo').value; saveState(); });

delaySlider.addEventListener('input', () => {
  state.delay = +delaySlider.value;
  delayVal.textContent = state.delay + 'ms';
  saveState();
});

defaultResp.addEventListener('change', () => {
  state.defaultResponse = defaultResp.value;
  $('customResponseField').style.display = state.defaultResponse === 'custom' ? '' : 'none';
  saveState();
});
$('customResponse').addEventListener('input', () => { state.customResponse = $('customResponse').value; saveState(); });

pauseBtn.addEventListener('click', () => {
  paused = !paused;
  updateStatus();
  addLog(paused ? 'Paused' : 'Resumed', 'info');
});

$('resetBtn').addEventListener('click', () => {
  state.confirmCount = 0; state.blockCount = 0;
  confirmCount.textContent = '0'; blockCount.textContent = '0';
  saveState();
});

$('addPatternBtn').addEventListener('click', () => {
  const v = $('newPattern').value.trim();
  if (v && !state.patterns.includes(v)) {
    try { new RegExp(v); } catch { addLog('Invalid regex: ' + v, 'blocked'); return; }
    state.patterns.push(v); saveState(); renderPatterns();
    $('newPattern').value = '';
  }
});
$('newPattern').addEventListener('keydown', e => { if (e.key === 'Enter') $('addPatternBtn').click(); });

$('addBlockBtn').addEventListener('click', () => {
  const v = $('newBlock').value.trim();
  if (v && !state.blocks.includes(v)) { state.blocks.push(v); saveState(); renderBlocks(); $('newBlock').value = ''; }
});
$('newBlock').addEventListener('keydown', e => { if (e.key === 'Enter') $('addBlockBtn').click(); });

$('addOverrideBtn').addEventListener('click', () => {
  const p = $('overridePattern').value.trim();
  const r = $('overrideResponse').value.trim();
  if (p && r) { state.overrides[p] = r; saveState(); renderOverrides(); $('overridePattern').value = ''; $('overrideResponse').value = ''; }
});

$('resetPatternsBtn').addEventListener('click', () => { state.patterns = [...DEFAULT_PATTERNS]; saveState(); renderPatterns(); });
$('resetBlocksBtn').addEventListener('click', () => { state.blocks = [...DEFAULT_BLOCKS]; saveState(); renderBlocks(); });

$('exportLogBtn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'auto-confirm-log-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click(); URL.revokeObjectURL(a.href);
});
$('clearLogBtn').addEventListener('click', () => { logs = []; saveLogs(); logArea.innerHTML = ''; });

$('testClipBtn').addEventListener('click', () => {
  const sample = 'Do you want to continue? (Y/n)';
  clipboardPreview.textContent = sample;
  lastClipboard = '';
  processClipboard(sample);
});

// Command generator
const genMethod = $('genMethod');
genMethod.addEventListener('change', () => {
  $('printfField').style.display = genMethod.value === 'printf-pipe' ? '' : 'none';
});

$('generateBtn').addEventListener('click', () => {
  const cmd = $('genCommand').value.trim();
  if (!cmd) { $('genOutput').innerHTML = '<p style="color:var(--danger);font-size:.85rem">Enter a command first</p>'; return; }
  const m = genMethod.value;
  let result = '';
  if (m === 'yes-pipe') result = `yes | ${cmd}`;
  else if (m === 'echo-pipe') result = `echo "y" | ${cmd}`;
  else if (m === 'printf-pipe') {
    const lines = ($('printfResponses').value || 'y').split('\n').filter(Boolean);
    result = `printf '${lines.join('\\n')}\\n' | ${cmd}`;
  } else if (m === 'expect') {
    result = `#!/usr/bin/expect -f\nspawn ${cmd}\nexpect {\n  "? " { send "y\\r"; exp_continue }\n  "(Y/n)" { send "Y\\r"; exp_continue }\n  "(y/n)" { send "y\\r"; exp_continue }\n  eof\n}`;
  } else if (m === 'osascript') {
    const escaped = cmd.replace(/"/g, '\\"');
    result = `osascript -e 'tell application "Terminal"\n  do script "yes | ${escaped}"\nend tell'`;
  }
  $('genOutput').innerHTML = `<div class="code-block">${esc(result)}<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>`;
});

// Expect generator
$('expectGenBtn').addEventListener('click', () => {
  const cmd = $('expectCmd').value.trim();
  if (!cmd) { $('expectOutput').innerHTML = '<p style="color:var(--danger);font-size:.85rem">Enter a command</p>'; return; }
  const pairs = $('expectPairs').value.split('\n').filter(Boolean).map(l => {
    const [prompt, ...rest] = l.split('=');
    return { prompt: prompt.trim(), response: rest.join('=').trim() || 'y' };
  });
  let script = `#!/usr/bin/expect -f\nset timeout 30\nspawn ${cmd}\n\nexpect {\n`;
  pairs.forEach(p => { script += `  "${p.prompt}" { send "${p.response}\\r"; exp_continue }\n`; });
  script += `  eof\n}\n\nwait`;
  $('expectOutput').innerHTML = `<div class="code-block">${esc(script)}<button class="copy-btn" onclick="copyCode(this)">Copy</button></div>`;
});

// Settings import/export
$('exportSettingsBtn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'auto-confirm-settings.json';
  a.click(); URL.revokeObjectURL(a.href);
});
$('importSettingsBtn').addEventListener('click', () => $('importFile').click());
$('importFile').addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = () => {
    try {
      const d = JSON.parse(r.result);
      state = { ...defaultState(), ...d };
      saveState(); initUI();
      addLog('Settings imported', 'info');
    } catch { addLog('Invalid settings file', 'blocked'); }
  };
  r.readAsText(f);
});
$('clearAllBtn').addEventListener('click', () => {
  if (confirm('Reset all settings and logs?')) {
    state = defaultState(); logs = [];
    saveState(); saveLogs(); paused = false;
    stopMonitoring(); initUI();
    addLog('All data reset', 'info');
  }
});

// Keyboard shortcut
document.addEventListener('keydown', e => {
  if (e.ctrlKey && e.shiftKey && e.key === 'Y') {
    e.preventDefault();
    mainToggle.checked = !mainToggle.checked;
    mainToggle.dispatchEvent(new Event('change'));
  }
});

// Copy helper
function copyCode(btn) {
  const code = btn.parentElement.textContent.replace('Copy', '').trim();
  navigator.clipboard.writeText(code).then(() => {
    btn.textContent = '‚úì';
    setTimeout(() => btn.textContent = 'Copy', 1200);
  });
}
window.copyCode = copyCode;

// Init
initUI();
</script>
</body>
</html>
