<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slipspace Business Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Primary colors */
            --primary: #3a7bd5;
            --primary-dark: #2c5aa0;
            --primary-light: #6ca1e9;
            --secondary: #00d2ff;
            --secondary-dark: #00a4c7;
            --secondary-light: #64e1ff;
            
            /* Neutral colors */
            --background: #f5f7fa;
            --surface: #ffffff;
            --surface-hover: #f0f4f8;
            --border: #e1e5eb;
            --divider: #eaedf0;
            
            /* Text colors */
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-tertiary: #718096;
            --text-disabled: #a0aec0;
            
            /* Status colors */
            --success: #38b2ac;
            --warning: #ed8936;
            --error: #e53e3e;
            --info: #4299e1;
            
            /* Other colors */
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-color-darker: rgba(0, 0, 0, 0.2);
            
            /* Spacing */
            --spacing-1: 4px;
            --spacing-2: 8px;
            --spacing-3: 12px;
            --spacing-4: 16px;
            --spacing-5: 24px;
            --spacing-6: 32px;
            --spacing-7: 48px;
            --spacing-8: 64px;
            
            /* Border radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            /* Transition */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.4s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-4) var(--spacing-5);
            background-color: var(--surface);
            box-shadow: 0 1px 2px var(--shadow-color);
            z-index: 10;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--primary);
        }
        
        .logo-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
        }
        
        .universe-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-3);
            background-color: var(--primary-light);
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }
        
        .universe-selector:hover {
            background-color: var(--primary);
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 600;
        }
        
        /* Main layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--surface);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            transition: width var(--transition-fast);
        }
        
        .sidebar-collapsed {
            width: 64px;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--divider);
        }
        
        .sidebar-title {
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .collapse-button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-1);
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast);
        }
        
        .collapse-button:hover {
            background-color: var(--surface-hover);
        }
        
        .nav-list {
            list-style-type: none;
            padding: var(--spacing-2) 0;
        }
        
        .nav-item {
            padding: 0 var(--spacing-2);
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-3) var(--spacing-2);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            transition: background-color var(--transition-fast);
            cursor: pointer;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: var(--surface-hover);
            color: var(--primary);
        }
        
        .nav-link.active {
            background-color: rgba(58, 123, 213, 0.1);
            font-weight: 500;
        }
        
        .nav-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .nav-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Content area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-5);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-5);
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-4);
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .page-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        /* Card components */
        .card {
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 1px 3px var(--shadow-color);
            overflow: hidden;
        }
        
        .card-header {
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .card-subtitle {
            color: var(--text-tertiary);
            font-size: 0.875rem;
            margin-top: var(--spacing-1);
        }
        
        .card-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        .card-content {
            padding: var(--spacing-4);
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-4);
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background-color: var(--surface-hover);
        }
        
        .btn-sm {
            padding: var(--spacing-1) var(--spacing-3);
            font-size: 0.75rem;
        }
        
        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-2);
            border-radius: var(--radius-md);
            cursor: pointer;
            border: none;
            transition: all var(--transition-fast);
        }
        
        .btn-icon-primary {
            background-color: var(--primary-light);
            color: white;
        }
        
        .btn-icon-primary:hover {
            background-color: var(--primary);
        }
        
        .btn-icon-secondary {
            background-color: var(--surface);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .btn-icon-secondary:hover {
            background-color: var(--surface-hover);
        }
        
        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-blue {
            background-color: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }
        
        .badge-green {
            background-color: rgba(56, 178, 172, 0.1);
            color: var(--success);
        }
        
        .badge-orange {
            background-color: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }
        
        .badge-red {
            background-color: rgba(229, 62, 62, 0.1);
            color: var(--error);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: var(--spacing-4);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--spacing-2);
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .form-control {
            width: 100%;
            padding: var(--spacing-3);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background-color: var(--surface);
            color: var(--text-primary);
            transition: border-color var(--transition-fast);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(58, 123, 213, 0.2);
        }
        
        .form-control:disabled {
            background-color: var(--background);
            color: var(--text-disabled);
            cursor: not-allowed;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%234a5568' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--spacing-3) center;
            background-size: 16px;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            padding: var(--spacing-3) var(--spacing-4);
            text-align: left;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 1px solid var(--divider);
        }
        
        .table td {
            padding: var(--spacing-3) var(--spacing-4);
            border-bottom: 1px solid var(--divider);
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tbody tr {
            transition: background-color var(--transition-fast);
        }
        
        .table tbody tr:hover {
            background-color: var(--surface-hover);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--divider);
            margin-bottom: var(--spacing-4);
        }
        
        .tab {
            padding: var(--spacing-3) var(--spacing-4);
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all var(--transition-fast);
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-normal);
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal-dialog {
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 15px var(--shadow-color-darker);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform var(--transition-normal);
        }
        
        .modal-overlay.active .modal-dialog {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-1);
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast);
        }
        
        .modal-close:hover {
            background-color: var(--surface-hover);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: var(--spacing-4);
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: var(--spacing-4);
            border-top: 1px solid var(--divider);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-2);
        }
        
        /* Loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(58, 123, 213, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loader-text {
            margin-top: var(--spacing-3);
            color: var(--primary);
            font-weight: 500;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
        }
        
        .tooltip-text {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-primary);
            color: white;
            text-align: center;
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-fast);
            z-index: 10;
        }
        
        .tooltip:hover .tooltip-text {
            opacity: 1;
            visibility: visible;
        }
        
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: var(--text-primary) transparent transparent transparent;
        }
        
        /* Universe cards */
        .universe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-4);
        }
        
        .universe-card {
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 1px 3px var(--shadow-color);
            overflow: hidden;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            cursor: pointer;
        }
        
        .universe-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px var(--shadow-color);
        }
        
        .universe-card-current {
            border: 2px solid var(--primary);
        }
        
        .universe-card-header {
            padding: var(--spacing-4);
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
            color: white;
        }
        
        .universe-card-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: var(--spacing-1);
        }
        
        .universe-card-subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        .universe-card-content {
            padding: var(--spacing-4);
        }
        
        .universe-card-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-3);
        }
        
        .universe-card-stat {
            display: flex;
            flex-direction: column;
        }
        
        .universe-card-stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        
        .universe-card-stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .universe-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-3) var(--spacing-4);
            border-top: 1px solid var(--divider);
            font-size: 0.875rem;
        }
        
        .universe-card-footer-text {
            color: var(--text-tertiary);
        }
        
        .universe-card-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        /* Agent styles */
        .agent-section {
            display: none;
        }
        
        .agent-section.active {
            display: block;
        }
        
        .agent-form {
            max-width: 800px;
        }
        
        .agent-execution {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-4);
        }
        
        .agent-execution-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
        }
        
        .agent-execution-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }
        
        .agent-execution-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .agent-execution-status.ready {
            background-color: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }
        
        .agent-execution-status.ready .agent-execution-status-indicator {
            background-color: var(--info);
        }
        
        .agent-execution-status.running {
            background-color: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }
        
        .agent-execution-status.running .agent-execution-status-indicator {
            background-color: var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        .agent-execution-status.success {
            background-color: rgba(56, 178, 172, 0.1);
            color: var(--success);
        }
        
        .agent-execution-status.success .agent-execution-status-indicator {
            background-color: var(--success);
        }
        
        .agent-execution-status.error {
            background-color: rgba(229, 62, 62, 0.1);
            color: var(--error);
        }
        
        .agent-execution-status.error .agent-execution-status-indicator {
            background-color: var(--error);
        }
        
        .agent-logs {
            font-family: monospace;
            background-color: #1a202c;
            color: #cbd5e0;
            padding: var(--spacing-3);
            border-radius: var(--radius-md);
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .agent-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-4);
        }
        
        .agent-result-card {
            background-color: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: 0 1px 3px var(--shadow-color);
            overflow: hidden;
        }
        
        .agent-result-header {
            padding: var(--spacing-3);
            background-color: var(--background);
            border-bottom: 1px solid var(--divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .agent-result-title {
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .agent-result-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        .agent-result-content {
            padding: var(--spacing-3);
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Opportunity dashboard specific styles */
        .stats-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-5);
        }
        
        .stat-card {
            background-color: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: 0 1px 3px var(--shadow-color);
            padding: var(--spacing-4);
            display: flex;
            flex-direction: column;
        }
        
        .stat-card-title {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            margin-bottom: var(--spacing-2);
        }
        
        .stat-card-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stat-card-footer {
            margin-top: var(--spacing-2);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-1);
        }
        
        .stat-card-trend-up {
            color: var(--success);
        }
        
        .stat-card-trend-down {
            color: var(--error);
        }
        
        .opportunity-filters {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }
        
        .opportunity-filter {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .opportunity-filter-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .opportunity-filter-select {
            padding: var(--spacing-2) var(--spacing-3);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background-color: var(--surface);
            font-size: 0.875rem;
        }
        
        .opportunity-action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-3);
            margin-top: var(--spacing-4);
        }
        
        .priority-high {
            color: var(--error);
            font-weight: 500;
        }
        
        .priority-medium {
            color: var(--warning);
            font-weight: 500;
        }
        
        .priority-low {
            color: var(--info);
            font-weight: 500;
        }
        
        .stage-badge {
            display: inline-flex;
            align-items: center;
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .stage-prospecting {
            background-color: rgba(66, 153, 225, 0.1);
            color: var(--info);
        }
        
        .stage-qualification {
            background-color: rgba(79, 209, 197, 0.1);
            color: #4fd1c5;
        }
        
        .stage-proposal {
            background-color: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }
        
        .stage-negotiation {
            background-color: rgba(183, 148, 244, 0.1);
            color: #b794f4;
        }
        
        .stage-closed {
            background-color: rgba(56, 178, 172, 0.1);
            color: var(--success);
        }
        
        .value-amount {
            font-weight: 500;
        }
        
        .email-preview {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--spacing-4);
            margin-top: var(--spacing-4);
        }
        
        .email-header {
            border-bottom: 1px solid var(--divider);
            padding-bottom: var(--spacing-3);
            margin-bottom: var(--spacing-3);
        }
        
        .email-field {
            display: flex;
            margin-bottom: var(--spacing-2);
        }
        
        .email-field-label {
            width: 80px;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }
        
        .email-field-value {
            color: var(--text-primary);
        }
        
        .email-body {
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform var(--transition-normal);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 90;
                opacity: 0;
                pointer-events: none;
                transition: opacity var(--transition-normal);
            }
            
            .sidebar-overlay.active {
                opacity: 1;
                pointer-events: auto;
            }
            
            .header {
                padding: var(--spacing-3);
            }
            
            .mobile-menu-button {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                background-color: transparent;
                border: none;
                cursor: pointer;
                margin-right: var(--spacing-2);
            }
            
            .universe-selector {
                display: none;
            }
            
            .stats-card-grid,
            .universe-grid,
            .agent-results-grid,
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .opportunity-filters {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .opportunity-filter {
                width: 100%;
            }
            
            .opportunity-filter-select {
                width: 100%;
            }
            
            .table-container {
                margin: 0 -20px;
                width: calc(100% + 40px);
            }
            
            .agent-execution-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-menu-button {
                display: none;
            }
        }
        
        /* Light/Dark mode toggle */
        .theme-switch {
            position: relative;
            width: 60px;
            height: 30px;
            cursor: pointer;
        }
        
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--background);
            border: 1px solid var(--border);
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 2px;
            background-color: var(--primary);
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider:before {
            transform: translateX(29px);
        }
        
        /* Animations */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
        <div class="loader-text">Loading Slipspace</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="mobile-menu-button" id="mobile-menu-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="logo">
                <div class="logo-icon">S</div>
                <span>Slipspace</span>
            </div>
        </div>
        <div class="header-right">
            <div class="universe-selector" id="universe-dropdown-trigger">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <ellipse cx="12" cy="12" rx="4" ry="10"></ellipse>
                    <line x1="12" y1="2" x2="12" y2="22"></line>
                </svg>
                <span id="current-universe-name">Home Universe</span>
            </div>
            <div class="user-menu">
                <div class="user-avatar">U</div>
            </div>
        </div>
    </header>

    <!-- Main container -->
    <div class="main-container">
        <!-- Sidebar overlay for mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Navigation</div>
                <button class="collapse-button" id="collapse-sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
            </div>
            <nav>
                <ul class="nav-list">
                    <li class="nav-item">
                        <a class="nav-link active" data-page="dashboard">
                            <div class="nav-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="7" height="9"></rect>
                                    <rect x="14" y="3" width="7" height="5"></rect>
                                    <rect x="14" y="12" width="7" height="9"></rect>
                                    <rect x="3" y="16" width="7" height="5"></rect>
                                </svg>
                            </div>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-page="opportunities">
                            <div class="nav-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                </svg>
                            </div>
                            <span class="nav-text">Opportunities</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-page="agents">
                            <div class="nav-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 2a9 9 0 0 1 9 9c0 3.03-1.35 5.4-3.25 7.13l-.15.12-.13.11-.13.1-.13.1-.12.08-.13.08-.12.08-.12.06-.12.07-.11.05-.12.05-.1.05-.11.04-.1.04-.1.03-.09.03-.09.02-.09.02-.08.02-.05.01-.1.01-.04.01a3 3 0 0 1-1.11 0l-.04-.01-.1-.01-.05-.01-.08-.02-.09-.02-.09-.02-.09-.03-.1-.03-.1-.04-.11-.04-.1-.05-.12-.05-.11-.05-.12-.07-.12-.06-.12-.08-.13-.08-.12-.08-.13-.1-.13-.1-.13-.11-.15-.12A15.01 15.01 0 0 1 3 11a9 9 0 0 1 9-9zm0 15c-1.5 0-3.5-2.5-3.5-6.5 0-4.5 2-5.5 3.5-5.5s3.5 1 3.5 5.5c0 4-2 6.5-3.5 6.5z"></path>
                                </svg>
                            </div>
                            <span class="nav-text">Agents</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-page="universes">
                            <div class="nav-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <ellipse cx="12" cy="12" rx="4" ry="10"></ellipse>
                                    <line x1="12" y1="2" x2="12" y2="22"></line>
                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                </svg>
                            </div>
                            <span class="nav-text">Universes</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-page="settings">
                            <div class="nav-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                </svg>
                            </div>
                            <span class="nav-text">Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Content area -->
        <main class="content" id="content">
            <!-- Dashboard (Active by default) -->
            <div class="page fade-in" id="dashboard-page">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary" id="generate-daily-report">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span>Generate Daily Report</span>
                        </button>
                    </div>
                </div>
                
                <!-- Stats Overview -->
                <div class="stats-card-grid">
                    <div class="stat-card">
                        <div class="stat-card-title">Total Opportunities</div>
                        <div class="stat-card-value">24</div>
                        <div class="stat-card-footer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="stat-card-trend-up">
                                <polyline points="18 15 12 9 6 15"></polyline>
                            </svg>
                            <span class="stat-card-trend-up">4 new this week</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">Pipeline Value</div>
                        <div class="stat-card-value">$1.24M</div>
                        <div class="stat-card-footer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="stat-card-trend-up">
                                <polyline points="18 15 12 9 6 15"></polyline>
                            </svg>
                            <span class="stat-card-trend-up">12% increase</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">Closing This Month</div>
                        <div class="stat-card-value">8</div>
                        <div class="stat-card-footer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="stat-card-trend-down">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            <span class="stat-card-trend-down">2 less than last month</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">Win Rate</div>
                        <div class="stat-card-value">68%</div>
                        <div class="stat-card-footer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="stat-card-trend-up">
                                <polyline points="18 15 12 9 6 15"></polyline>
                            </svg>
                            <span class="stat-card-trend-up">5% increase</span>
                        </div>
                    </div>
                </div>
                
                <!-- Recent opportunities -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">Recent Opportunities</h2>
                            <div class="card-subtitle">Opportunities updated in the last 7 days</div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-secondary btn-sm">
                                <span>View All</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Company</th>
                                        <th>Stage</th>
                                        <th>Value</th>
                                        <th>Close Date</th>
                                        <th>Priority</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Enterprise Solution Upgrade</td>
                                        <td>Sample Corp</td>
                                        <td><span class="stage-badge stage-proposal">Proposal</span></td>
                                        <td class="value-amount">$125,000</td>
                                        <td>Apr 28, 2025</td>
                                        <td class="priority-high">High</td>
                                    </tr>
                                    <tr>
                                        <td>Data Integration Platform</td>
                                        <td>TechNova Inc</td>
                                        <td><span class="stage-badge stage-negotiation">Negotiation</span></td>
                                        <td class="value-amount">$85,000</td>
                                        <td>May 15, 2025</td>
                                        <td class="priority-medium">Medium</td>
                                    </tr>
                                    <tr>
                                        <td>Security Assessment</td>
                                        <td>Global Finance</td>
                                        <td><span class="stage-badge stage-qualification">Qualification</span></td>
                                        <td class="value-amount">$45,000</td>
                                        <td>Jun 10, 2025</td>
                                        <td class="priority-low">Low</td>
                                    </tr>
                                    <tr>
                                        <td>Cloud Migration Project</td>
                                        <td>Stellar Systems</td>
                                        <td><span class="stage-badge stage-proposal">Proposal</span></td>
                                        <td class="value-amount">$210,000</td>
                                        <td>May 5, 2025</td>
                                        <td class="priority-high">High</td>
                                    </tr>
                                    <tr>
                                        <td>Annual Maintenance Renewal</td>
                                        <td>InnoTech Solutions</td>
                                        <td><span class="stage-badge stage-closed">Closed Won</span></td>
                                        <td class="value-amount">$75,000</td>
                                        <td>Mar 31, 2025</td>
                                        <td class="priority-medium">Medium</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Latest agent insights -->
                <div class="card" style="margin-top: var(--spacing-5);">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">Latest Agent Insights</h2>
                            <div class="card-subtitle">Generated from your opportunity data</div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-secondary btn-sm">
                                <span>Refresh</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="email-preview">
                            <div class="email-header">
                                <div class="email-field">
                                    <div class="email-field-label">To:</div>
                                    <div class="email-field-value">Sales Team &lt;[SALES_EMAIL]&gt;</div>
                                </div>
                                <div class="email-field">
                                    <div class="email-field-label">Subject:</div>
                                    <div class="email-field-value">Daily Opportunity Report - March 24, 2025</div>
                                </div>
                            </div>
                            <div class="email-body">
                                <p><strong>Good morning team,</strong></p>
                                <p>Here's your daily opportunity report with key insights and recommendations:</p>
                                <br>
                                <p><strong>Priority Opportunities:</strong></p>
                                <ol>
                                    <li><strong>Enterprise Solution Upgrade (Sample Corp)</strong> - Proposal stage with projected value of $125,000. Close date is approaching in 35 days. Recommend scheduling a follow-up call this week to address remaining technical concerns.</li>
                                    <li><strong>Cloud Migration Project (Stellar Systems)</strong> - Proposal stage with high value ($210,000). Based on similar deals, consider offering phased implementation to reduce perceived risk.</li>
                                </ol>
                                <br>
                                <p><strong>Risk Alert:</strong></p>
                                <p>TechNova Inc deal has been in negotiation stage for 45 days (15 days longer than average). Consider escalation strategy or executive involvement.</p>
                                <br>
                                <p><strong>Sales Activities Needed:</strong></p>
                                <ul>
                                    <li>4 opportunities need proposal follow-up</li>
                                    <li>2 opportunities have no activity in the last 5 days</li>
                                    <li>3 new leads need qualification</li>
                                </ul>
                                <br>
                                <p><strong>Market Insight:</strong></p>
                                <p>Technology sector opportunities are showing higher close rates (75% vs. 68% overall). Consider focusing prospecting efforts in this vertical.</p>
                                <br>
                                <p>For detailed analysis and all current opportunities, please visit your Slipspace dashboard.</p>
                                <br>
                                <p>Best regards,<br>Sales Analysis Agent</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Opportunities Page -->
            <div class="page" id="opportunities-page" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">Opportunities</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            <span>New Opportunity</span>
                        </button>
                    </div>
                </div>
                
                <!-- Opportunity Filters -->
                <div class="opportunity-filters">
                    <div class="opportunity-filter">
                        <label class="opportunity-filter-label">Stage:</label>
                        <select class="opportunity-filter-select">
                            <option value="all">All Stages</option>
                            <option value="prospecting">Prospecting</option>
                            <option value="qualification">Qualification</option>
                            <option value="proposal">Proposal</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="closed-won">Closed Won</option>
                            <option value="closed-lost">Closed Lost</option>
                        </select>
                    </div>
                    <div class="opportunity-filter">
                        <label class="opportunity-filter-label">Priority:</label>
                        <select class="opportunity-filter-select">
                            <option value="all">All Priorities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="opportunity-filter">
                        <label class="opportunity-filter-label">Close Date:</label>
                        <select class="opportunity-filter-select">
                            <option value="all">All Dates</option>
                            <option value="this-month">This Month</option>
                            <option value="next-month">Next Month</option>
                            <option value="this-quarter">This Quarter</option>
                            <option value="next-quarter">Next Quarter</option>
                        </select>
                    </div>
                    <div class="opportunity-filter">
                        <label class="opportunity-filter-label">Value:</label>
                        <select class="opportunity-filter-select">
                            <option value="all">All Values</option>
                            <option value="0-50k">$0 - $50K</option>
                            <option value="50k-100k">$50K - $100K</option>
                            <option value="100k-250k">$100K - $250K</option>
                            <option value="250k+">$250K+</option>
                        </select>
                    </div>
                </div>
                
                <!-- Opportunities Table -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">All Opportunities</h2>
                            <div class="card-subtitle">Showing 24 opportunities</div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-secondary btn-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <polyline points="19 12 12 19 5 12"></polyline>
                                </svg>
                                <span>Export</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Company</th>
                                        <th>Stage</th>
                                        <th>Value</th>
                                        <th>Close Date</th>
                                        <th>Priority</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Enterprise Solution Upgrade</td>
                                        <td>Sample Corp</td>
                                        <td><span class="stage-badge stage-proposal">Proposal</span></td>
                                        <td class="value-amount">$125,000</td>
                                        <td>Apr 28, 2025</td>
                                        <td class="priority-high">High</td>
                                        <td>
                                            <button class="btn-icon btn-icon-secondary">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Data Integration Platform</td>
                                        <td>TechNova Inc</td>
                                        <td><span class="stage-badge stage-negotiation">Negotiation</span></td>
                                        <td class="value-amount">$85,000</td>
                                        <td>May 15, 2025</td>
                                        <td class="priority-medium">Medium</td>
                                        <td>
                                            <button class="btn-icon btn-icon-secondary">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Security Assessment</td>
                                        <td>Global Finance</td>
                                        <td><span class="stage-badge stage-qualification">Qualification</span></td>
                                        <td class="value-amount">$45,000</td>
                                        <td>Jun 10, 2025</td>
                                        <td class="priority-low">Low</td>
                                        <td>
                                            <button class="btn-icon btn-icon-secondary">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Cloud Migration Project</td>
                                        <td>Stellar Systems</td>
                                        <td><span class="stage-badge stage-proposal">Proposal</span></td>
                                        <td class="value-amount">$210,000</td>
                                        <td>May 5, 2025</td>
                                        <td class="priority-high">High</td>
                                        <td>
                                            <button class="btn-icon btn-icon-secondary">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Annual Maintenance Renewal</td>
                                        <td>InnoTech Solutions</td>
                                        <td><span class="stage-badge stage-closed">Closed Won</span></td>
                                        <td class="value-amount">$75,000</td>
                                        <td>Mar 31, 2025</td>
                                        <td class="priority-medium">Medium</td>
                                        <td>
                                            <button class="btn-icon btn-icon-secondary">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Software License Expansion</td>
                                        <td>Quantum Industries</td>
                                        <td><span class="stage-badge stage-prospecting">Prospecting</span></td>
                                        <td class="value-amount">$95,000</td>
                                        <td>Jul 15, 2025</td>
                                        <td class="priority-medium">Medium</td>
                                        <td>
                                            <button class="btn-icon btn-icon-secondary">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>IT Support Contract</td>
                                        <td>Meridian Healthcare</td>
                                        <td><span class="stage-badge stage-qualification">Qualification</span></td>
                                        <td class="value-amount">$120,000</td>
                                        <td>Jun 30, 2025</td>
                                        <td class="priority-high">High</td>
                                        <td>
                                            <button class="btn-icon btn-icon-secondary">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Run Agent Analysis Button -->
                <div class="opportunity-action-buttons">
                    <button class="btn btn-secondary" id="reset-filters">Reset Filters</button>
                    <button class="btn btn-primary" id="run-opportunity-analysis">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                        <span>Run Agent Analysis</span>
                    </button>
                </div>
            </div>
            
            <!-- Agents Page -->
            <div class="page" id="agents-page" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">Agent Management</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary" id="new-agent-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            <span>New Agent</span>
                        </button>
                    </div>
                </div>
                
                <!-- Agent Tabs -->
                <div class="tabs">
                    <div class="tab active" data-tab="agent-library">Agent Library</div>
                    <div class="tab" data-tab="agent-configuration">Configuration</div>
                    <div class="tab" data-tab="agent-execution">Execution</div>
                    <div class="tab" data-tab="agent-results">Results</div>
                </div>
                
                <!-- Agent Library Section -->
                <div class="agent-section active" id="agent-library-section">
                    <div class="card-grid">
                        <div class="card agent-card" data-agent-id="sales-analysis-agent">
                            <div class="card-header">
                                <div class="card-title">Sales Analysis Agent</div>
                                <div class="badge badge-blue">Analytics</div>
                            </div>
                            <div class="card-content">
                                <p>Analyzes sales pipeline data to identify opportunities, risks, and trends. Generates daily and weekly reports for sales teams.</p>
                                <div style="margin-top: var(--spacing-3);">
                                    <button class="btn btn-secondary btn-sm">Configure</button>
                                    <button class="btn btn-primary btn-sm">Run</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card agent-card" data-agent-id="opportunity-prioritization-agent">
                            <div class="card-header">
                                <div class="card-title">Opportunity Prioritization Agent</div>
                                <div class="badge badge-green">Decision Support</div>
                            </div>
                            <div class="card-content">
                                <p>Evaluates and ranks opportunities based on value, close probability, and resource requirements. Suggests optimal resource allocation.</p>
                                <div style="margin-top: var(--spacing-3);">
                                    <button class="btn btn-secondary btn-sm">Configure</button>
                                    <button class="btn btn-primary btn-sm">Run</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card agent-card" data-agent-id="email-summary-agent">
                            <div class="card-header">
                                <div class="card-title">Email Summary Agent</div>
                                <div class="badge badge-orange">Communication</div>
                            </div>
                            <div class="card-content">
                                <p>Creates concise, actionable email summaries of opportunity data and insights for delivery to sales teams and management.</p>
                                <div style="margin-top: var(--spacing-3);">
                                    <button class="btn btn-secondary btn-sm">Configure</button>
                                    <button class="btn btn-primary btn-sm">Run</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card agent-card" data-agent-id="forecasting-agent">
                            <div class="card-header">
                                <div class="card-title">Forecasting Agent</div>
                                <div class="badge badge-blue">Analytics</div>
                            </div>
                            <div class="card-content">
                                <p>Predicts sales pipeline outcomes and provides revenue forecasts based on historical data and current opportunity stages.</p>
                                <div style="margin-top: var(--spacing-3);">
                                    <button class="btn btn-secondary btn-sm">Configure</button>
                                    <button class="btn btn-primary btn-sm">Run</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Agent Configuration Section -->
                <div class="agent-section" id="agent-configuration-section">
                    <div class="agent-form">
                        <div class="form-group">
                            <label class="form-label">Agent Name</label>
                            <input type="text" class="form-control" id="agent-name" placeholder="Enter agent name" value="Sales Analysis Agent">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="agent-description" placeholder="Describe what this agent does">Analyzes sales pipeline data to identify opportunities, risks, and trends. Generates daily and weekly reports for sales teams.</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Agent Type</label>
                            <select class="form-control form-select" id="agent-type">
                                <option value="analytics">Analytics</option>
                                <option value="decision-support">Decision Support</option>
                                <option value="communication">Communication</option>
                                <option value="data-processing">Data Processing</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Agent Code</label>
                            <textarea class="form-control" id="agent-code" placeholder="Enter agent code" style="min-height: 300px; font-family: monospace;">function analyzeOpportunities(universe, params) {
    console.log('Sales Analysis Agent running in universe: ' + universe.id);
    
    // Access opportunities data from the universe
    const opportunities = universe.entities.filter(e => e.type === 'opportunity');
    
    // Filter out past opportunities - only look at present and future
    const activeOpportunities = opportunities.filter(opp => {
        const closeDate = new Date(opp.closeDate);
        const today = new Date();
        return closeDate >= today;
    });
    
    console.log(`Found ${activeOpportunities.length} active opportunities`);
    
    // Calculate key metrics
    const totalValue = activeOpportunities.reduce((sum, opp) => sum + opp.value, 0);
    const avgValue = totalValue / activeOpportunities.length;
    
    // Group by stage
    const byStage = {};
    activeOpportunities.forEach(opp => {
        if (!byStage[opp.stage]) {
            byStage[opp.stage] = [];
        }
        byStage[opp.stage].push(opp);
    });
    
    // Generate high-priority list
    const highPriority = activeOpportunities
        .filter(opp => opp.priority === 'high' || opp.value > avgValue * 1.5)
        .sort((a, b) => {
            // Sort by close date (ascending)
            return new Date(a.closeDate) - new Date(b.closeDate);
        })
        .slice(0, 5); // Top 5 high-priority opportunities
    
    // Find opportunities needing attention
    const needsAttention = activeOpportunities.filter(opp => {
        const lastActivityDate = new Date(opp.lastActivityDate);
        const today = new Date();
        const daysSinceActivity = Math.floor((today - lastActivityDate) / (1000 * 60 * 60 * 24));
        return daysSinceActivity > 5; // No activity in 5+ days
    });
    
    // Generate recommendations
    const recommendations = [];
    
    // For high-value opportunities approaching close date
    highPriority.forEach(opp => {
        const closeDate = new Date(opp.closeDate);
        const today = new Date();
        const daysToClose = Math.floor((closeDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysToClose < 30) {
            recommendations.push({
                opportunity: opp.name,
                company: opp.company,
                action: `Follow up within ${daysToClose < 7 ? '48 hours' : '1 week'}`,
                reason: `High-value opportunity ($${opp.value.toLocaleString()}) closing in ${daysToClose} days`
            });
        }
    });
    
    // For opportunities with no recent activity
    needsAttention.forEach(opp => {
        const lastActivityDate = new Date(opp.lastActivityDate);
        const today = new Date();
        const daysSinceActivity = Math.floor((today - lastActivityDate) / (1000 * 60 * 60 * 24));
        
        recommendations.push({
            opportunity: opp.name,
            company: opp.company,
            action: 'Schedule follow-up call or email',
            reason: `No activity for ${daysSinceActivity} days while in ${opp.stage} stage`
        });
    });
    
    // Generate summary text for email
    const summaryText = `
Good morning team,

Here's your daily opportunity report with key insights and recommendations:

Priority Opportunities:
${highPriority.map((opp, i) => `${i+1}. ${opp.name} (${opp.company}) - ${opp.stage} stage with projected value of $${opp.value.toLocaleString()}. Close date is ${new Date(opp.closeDate).toLocaleDateString()}.`).join('\n')}

Sales Activities Needed:
- ${byStage['proposal'] ? byStage['proposal'].length : 0} opportunities need proposal follow-up
- ${needsAttention.length} opportunities have no activity in the last 5 days
- ${byStage['prospecting'] ? byStage['prospecting'].length : 0} new leads need qualification

For detailed analysis and all current opportunities, please visit your Slipspace dashboard.

Best regards,
Sales Analysis Agent
`;
    
    // Return analysis results
    return {
        timestamp: new Date().toISOString(),
        metrics: {
            totalOpportunities: activeOpportunities.length,
            totalPipelineValue: totalValue,
            averageOpportunityValue: avgValue,
            opportunitiesByStage: Object.keys(byStage).reduce((result, stage) => {
                result[stage] = byStage[stage].length;
                return result;
            }, {})
        },
        highPriorityOpportunities: highPriority,
        needsAttention: needsAttention,
        recommendations: recommendations,
        emailSummary: summaryText
    };
}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Target Universes</label>
                            <select class="form-control form-select" id="target-universes" multiple size="3">
                                <option value="home-universe" selected>Home Universe</option>
                                <option value="optimistic-universe">Optimistic Universe</option>
                                <option value="conservative-universe">Conservative Universe</option>
                            </select>
                            <small style="display: block; margin-top: 5px; color: var(--text-tertiary);">Hold Ctrl/Cmd to select multiple universes</small>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-primary" id="save-agent-config">Save Configuration</button>
                            <button class="btn btn-secondary" id="reset-agent-config">Reset</button>
                        </div>
                    </div>
                </div>
                
                <!-- Agent Execution Section -->
                <div class="agent-section" id="agent-execution-section">
                    <div class="agent-execution">
                        <div class="agent-execution-header">
                            <div class="agent-execution-status ready" id="agent-status">
                                <div class="agent-execution-status-indicator"></div>
                                <span>Ready to run</span>
                            </div>
                            
                            <div>
                                <button class="btn btn-primary" id="run-agent">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    <span>Run Agent</span>
                                </button>
                                <button class="btn btn-secondary" id="stop-agent" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="6" y="6" width="12" height="12"></rect>
                                    </svg>
                                    <span>Stop</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Execution Parameters</div>
                            </div>
                            <div class="card-content">
                                <div class="form-group">
                                    <textarea class="form-control" id="execution-params" placeholder="Enter execution parameters as JSON">{
    "filter": {
        "minValue": 50000,
        "stages": ["qualification", "proposal", "negotiation"],
        "include_closed": false
    },
    "analysis": {
        "prioritize_by": ["value", "close_date"],
        "risk_threshold": 0.3,
        "generate_email": true
    }
}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Execution Logs</div>
                            </div>
                            <div class="card-content">
                                <div class="agent-logs" id="execution-logs">// Agent execution logs will appear here
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Agent Results Section -->
                <div class="agent-section" id="agent-results-section">
                    <div class="agent-results-grid" id="results-container">
                        <div class="agent-result-card">
                            <div class="agent-result-header">
                                <div class="agent-result-title">
                                    <span class="badge badge-green">Success</span>
                                    Home Universe
                                </div>
                                <div class="agent-result-actions">
                                    <button class="btn-icon btn-icon-secondary">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="7 10 12 15 17 10"></polyline>
                                            <line x1="12" y1="15" x2="12" y2="3"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="agent-result-content">
                                <h4>Analysis Results:</h4>
                                <div style="margin-top: 10px;">
                                    <strong>Total Opportunities:</strong> 24<br>
                                    <strong>Total Pipeline Value:</strong> $1,240,000<br>
                                    <strong>High Priority Opportunities:</strong> 5<br>
                                    <strong>Needs Attention:</strong> 3<br>
                                </div>
                                <div style="margin-top: 15px;">
                                    <strong>Top Recommendations:</strong>
                                    <ul style="margin-left: 20px; margin-top: 5px;">
                                        <li>Follow up with Sample Corp within 48 hours</li>
                                        <li>Schedule call with Stellar Systems to discuss proposal</li>
                                        <li>Assign executive sponsor to TechNova Inc deal</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="agent-result-card">
                            <div class="agent-result-header">
                                <div class="agent-result-title">
                                    <span class="badge badge-green">Success</span>
                                    Optimistic Universe
                                </div>
                                <div class="agent-result-actions">
                                    <button class="btn-icon btn-icon-secondary">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="7 10 12 15 17 10"></polyline>
                                            <line x1="12" y1="15" x2="12" y2="3"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="agent-result-content">
                                <h4>Analysis Results:</h4>
                                <div style="margin-top: 10px;">
                                    <strong>Total Opportunities:</strong> 24<br>
                                    <strong>Total Pipeline Value:</strong> $1,550,000<br>
                                    <strong>High Priority Opportunities:</strong> 7<br>
                                    <strong>Needs Attention:</strong> 2<br>
                                </div>
                                <div style="margin-top: 15px;">
                                    <strong>Top Recommendations:</strong>
                                    <ul style="margin-left: 20px; margin-top: 5px;">
                                        <li>Accelerate proposal for Quantum Industries</li>
                                        <li>Increase resource allocation to top 3 deals</li>
                                        <li>Prepare for early close on Sample Corp deal</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="agent-result-card">
                            <div class="agent-result-header">
                                <div class="agent-result-title">
                                    <span class="badge badge-green">Success</span>
                                    Conservative Universe
                                </div>
                                <div class="agent-result-actions">
                                    <button class="btn-icon btn-icon-secondary">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="7 10 12 15 17 10"></polyline>
                                            <line x1="12" y1="15" x2="12" y2="3"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="agent-result-content">
                                <h4>Analysis Results:</h4>
                                <div style="margin-top: 10px;">
                                    <strong>Total Opportunities:</strong> 24<br>
                                    <strong>Total Pipeline Value:</strong> $980,000<br>
                                    <strong>High Priority Opportunities:</strong> 4<br>
                                    <strong>Needs Attention:</strong> 5<br>
                                </div>
                                <div style="margin-top: 15px;">
                                    <strong>Top Recommendations:</strong>
                                    <ul style="margin-left: 20px; margin-top: 5px;">
                                        <li>Focus on smaller, more certain deals</li>
                                        <li>Increase qualification rigor for new opportunities</li>
                                        <li>Develop risk mitigation plans for top deals</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="grid-column: 1 / -1;">
                            <div class="card-header">
                                <div class="card-title">Email Summary Preview</div>
                                <div class="card-actions">
                                    <button class="btn btn-secondary btn-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                        </svg>
                                        <span>Copy</span>
                                    </button>
                                    <button class="btn btn-primary btn-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                            <polyline points="22,6 12,13 2,6"></polyline>
                                        </svg>
                                        <span>Send</span>
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="email-preview">
                                    <div class="email-header">
                                        <div class="email-field">
                                            <div class="email-field-label">To:</div>
                                            <div class="email-field-value">Sales Team &lt;[SALES_EMAIL]&gt;</div>
                                        </div>
                                        <div class="email-field">
                                            <div class="email-field-label">Subject:</div>
                                            <div class="email-field-value">Daily Opportunity Report - March 24, 2025</div>
                                        </div>
                                    </div>
                                    <div class="email-body">
                                        <p><strong>Good morning team,</strong></p>
                                        <p>Here's your daily opportunity report with key insights and recommendations:</p>
                                        <br>
                                        <p><strong>Priority Opportunities:</strong></p>
                                        <ol>
                                            <li><strong>Enterprise Solution Upgrade (Sample Corp)</strong> - Proposal stage with projected value of $125,000. Close date is approaching in 35 days. Recommend scheduling a follow-up call this week to address remaining technical concerns.</li>
                                            <li><strong>Cloud Migration Project (Stellar Systems)</strong> - Proposal stage with high value ($210,000). Based on similar deals, consider offering phased implementation to reduce perceived risk.</li>
                                        </ol>
                                        <br>
                                        <p><strong>Risk Alert:</strong></p>
                                        <p>TechNova Inc deal has been in negotiation stage for 45 days (15 days longer than average). Consider escalation strategy or executive involvement.</p>
                                        <br>
                                        <p><strong>Sales Activities Needed:</strong></p>
                                        <ul>
                                            <li>4 opportunities need proposal follow-up</li>
                                            <li>2 opportunities have no activity in the last 5 days</li>
                                            <li>3 new leads need qualification</li>
                                        </ul>
                                        <br>
                                        <p><strong>Market Insight:</strong></p>
                                        <p>Technology sector opportunities are showing higher close rates (75% vs. 68% overall). Consider focusing prospecting efforts in this vertical.</p>
                                        <br>
                                        <p>For detailed analysis and all current opportunities, please visit your Slipspace dashboard.</p>
                                        <br>
                                        <p>Best regards,<br>Sales Analysis Agent</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Universes Page -->
            <div class="page" id="universes-page" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">Universe Management</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary" id="new-universe-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            <span>New Universe</span>
                        </button>
                    </div>
                </div>
                
                <!-- Universe Grid -->
                <div class="universe-grid">
                    <div class="universe-card universe-card-current" data-universe-id="home-universe">
                        <div class="universe-card-header">
                            <div class="universe-card-title">Home Universe</div>
                            <div class="universe-card-subtitle">Default configuration</div>
                        </div>
                        <div class="universe-card-content">
                            <div class="universe-card-stats">
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Gravity</div>
                                    <div class="universe-card-stat-value">9.8</div>
                                </div>
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Time Dilation</div>
                                    <div class="universe-card-stat-value">1.0</div>
                                </div>
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Entities</div>
                                    <div class="universe-card-stat-value">135</div>
                                </div>
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Agents</div>
                                    <div class="universe-card-stat-value">4</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-tertiary);">Description</div>
                                <div>Standard universe with default parameters and real-world data.</div>
                            </div>
                        </div>
                        <div class="universe-card-footer">
                            <div class="universe-card-footer-text">Current Universe</div>
                            <div class="universe-card-actions">
                                <button class="btn-icon btn-icon-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="universe-card" data-universe-id="optimistic-universe">
                        <div class="universe-card-header">
                            <div class="universe-card-title">Optimistic Universe</div>
                            <div class="universe-card-subtitle">Higher success probabilities</div>
                        </div>
                        <div class="universe-card-content">
                            <div class="universe-card-stats">
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Gravity</div>
                                    <div class="universe-card-stat-value">8.2</div>
                                </div>
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Time Dilation</div>
                                    <div class="universe-card-stat-value">1.25</div>
                                </div>
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Entities</div>
                                    <div class="universe-card-stat-value">135</div>
                                </div>
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Agents</div>
                                    <div class="universe-card-stat-value">4</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-tertiary);">Description</div>
                                <div>Optimistic scenario planning with higher success rates and accelerated timelines.</div>
                            </div>
                        </div>
                        <div class="universe-card-footer">
                            <div class="universe-card-footer-text">Last updated: 2 days ago</div>
                            <div class="universe-card-actions">
                                <button class="btn-icon btn-icon-primary" title="Visit Universe">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </button>
                                <button class="btn-icon btn-icon-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="universe-card" data-universe-id="conservative-universe">
                        <div class="universe-card-header">
                            <div class="universe-card-title">Conservative Universe</div>
                            <div class="universe-card-subtitle">Lower success probabilities</div>
                        </div>
                        <div class="universe-card-content">
                            <div class="universe-card-stats">
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Gravity</div>
                                    <div class="universe-card-stat-value">11.3</div>
                                </div>
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Time Dilation</div>
                                    <div class="universe-card-stat-value">0.8</div>
                                </div>
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Entities</div>
                                    <div class="universe-card-stat-value">135</div>
                                </div>
                                <div class="universe-card-stat">
                                    <div class="universe-card-stat-label">Agents</div>
                                    <div class="universe-card-stat-value">4</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-tertiary);">Description</div>
                                <div>Conservative scenario planning with lower success rates and extended timelines.</div>
                            </div>
                        </div>
                        <div class="universe-card-footer">
                            <div class="universe-card-footer-text">Last updated: 3 days ago</div>
                            <div class="universe-card-actions">
                                <button class="btn-icon btn-icon-primary" title="Visit Universe">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </button>
                                <button class="btn-icon btn-icon-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Universe Form Card -->
                <div class="card" style="margin-top: var(--spacing-5);">
                    <div class="card-header">
                        <div class="card-title">Import Universe</div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label">Universe Configuration (JSON)</label>
                            <textarea class="form-control" id="universe-import-json" placeholder="Paste universe configuration JSON here" style="min-height: 150px;"></textarea>
                        </div>
                        <div class="form-group" style="text-align: right;">
                            <button class="btn btn-secondary" id="reset-universe-import">Reset</button>
                            <button class="btn btn-primary" id="import-universe">Import Universe</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Page -->
            <div class="page" id="settings-page" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">General Settings</div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label">Theme</label>
                            <div style="display: flex; align-items: center; gap: var(--spacing-3);">
                                <span>Light</span>
                                <label class="theme-switch">
                                    <input type="checkbox" id="theme-toggle">
                                    <span class="slider"></span>
                                </label>
                                <span>Dark</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Default Universe</label>
                            <select class="form-control form-select" id="default-universe">
                                <option value="home-universe">Home Universe</option>
                                <option value="optimistic-universe">Optimistic Universe</option>
                                <option value="conservative-universe">Conservative Universe</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Notification Settings</label>
                            <div style="display: flex; gap: var(--spacing-2); margin-top: var(--spacing-2);">
                                <label style="display: flex; align-items: center; gap: var(--spacing-2);">
                                    <input type="checkbox" checked> Daily Reports
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-2);">
                                    <input type="checkbox" checked> Agent Completion
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-2);">
                                    <input type="checkbox"> System Alerts
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: var(--spacing-5);">
                    <div class="card-header">
                        <div class="card-title">Agent Settings</div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label">Default Agent Parameters</label>
                            <textarea class="form-control" id="default-agent-params" style="min-height: 100px;">{
    "maxIterations": 1000,
    "timeout": 10000,
    "logLevel": "info"
}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Agent Execution Environment</label>
                            <select class="form-control form-select" id="agent-execution-env">
                                <option value="browser">Browser (JavaScript)</option>
                                <option value="nodejs">Node.js (Backend)</option>
                                <option value="python">Python (Backend)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Universe Edit Modal -->
    <div class="modal-overlay" id="universe-edit-modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Edit Universe</h3>
                <button class="modal-close" id="close-universe-modal"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Universe Name</label>
                    <input type="text" class="form-control" id="edit-universe-name" placeholder="Enter universe name">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="edit-universe-description" placeholder="Describe this universe"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Parameters</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-3);">
                        <div>
                            <label class="form-label" style="font-size: 0.875rem;">Gravity</label>
                            <input type="number" class="form-control" id="edit-universe-gravity" step="0.1" min="0">
                        </div>
                        <div>
                            <label class="form-label" style="font-size: 0.875rem;">Time Dilation</label>
                            <input type="number" class="form-control" id="edit-universe-time-dilation" step="0.05" min="0.1">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-universe-edit">Cancel</button>
                <button class="btn btn-primary" id="save-universe-edit">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- New Agent Modal -->
    <div class="modal-overlay" id="new-agent-modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Create New Agent</h3>
                <button class="modal-close" id="close-new-agent-modal"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Agent Name</label>
                    <input type="text" class="form-control" id="new-agent-name" placeholder="Enter agent name">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="new-agent-description" placeholder="Describe what this agent does"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Agent Type</label>
                    <select class="form-control form-select" id="new-agent-type">
                        <option value="analytics">Analytics</option>
                        <option value="decision-support">Decision Support</option>
                        <option value="communication">Communication</option>
                        <option value="data-processing">Data Processing</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Template</label>
                    <select class="form-control form-select" id="new-agent-template">
                        <option value="empty">Empty Agent</option>
                        <option value="analysis">Analysis Template</option>
                        <option value="reporting">Reporting Template</option>
                        <option value="decision">Decision Making Template</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-new-agent">Cancel</button>
                <button class="btn btn-primary" id="create-new-agent">Create Agent</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>

        // Slipspace Universe singleton to manage cross-universe data storage and agent operations
        const SlipspaceUniverse = (function() {
            // Private variables
            let instances = {};
            let currentUniverse = null;
            
            // Default universe configuration
            const DEFAULT_UNIVERSE = {
                id: 'home-universe',
                name: 'Home Universe',
                description: 'Standard universe with default parameters and real-world data.',
                parameters: {
                    gravity: 9.8,
                    time_dilation: 1.0
                },
                constants: {
                    MAX_ITERATIONS: 1000,
                    RESPONSE_TIMEOUT: 10000,
                    DECISION_THRESHOLD: 0.75
                },
                entities: [],
                agents: [],
                history: []
            };
            
            // Sample opportunity data to populate the universe
            const SAMPLE_OPPORTUNITIES = [
                {
                    id: 'opp1',
                    type: 'opportunity',
                    name: 'Enterprise Solution Upgrade',
                    company: 'Sample Corp',
                    stage: 'proposal',
                    value: 125000,
                    closeDate: '2025-04-28',
                    priority: 'high',
                    lastActivityDate: '2025-03-20'
                },
                {
                    id: 'opp2',
                    type: 'opportunity',
                    name: 'Data Integration Platform',
                    company: 'TechNova Inc',
                    stage: 'negotiation',
                    value: 85000,
                    closeDate: '2025-05-15',
                    priority: 'medium',
                    lastActivityDate: '2025-02-07'
                },
                {
                    id: 'opp3',
                    type: 'opportunity',
                    name: 'Security Assessment',
                    company: 'Global Finance',
                    stage: 'qualification',
                    value: 45000,
                    closeDate: '2025-06-10',
                    priority: 'low',
                    lastActivityDate: '2025-03-18'
                },
                {
                    id: 'opp4',
                    type: 'opportunity',
                    name: 'Cloud Migration Project',
                    company: 'Stellar Systems',
                    stage: 'proposal',
                    value: 210000,
                    closeDate: '2025-05-05',
                    priority: 'high',
                    lastActivityDate: '2025-03-15'
                },
                {
                    id: 'opp5',
                    type: 'opportunity',
                    name:'Annual Maintenance Renewal',
                    company: 'InnoTech Solutions',
                    stage: 'closed-won',
                    value: 75000,
                    closeDate: '2025-03-31',
                    priority: 'medium',
                    lastActivityDate: '2025-03-10'
                },
                {
                    id: 'opp6',
                    type: 'opportunity',
                    name: 'Software License Expansion',
                    company: 'Quantum Industries',
                    stage: 'prospecting',
                    value: 95000,
                    closeDate: '2025-07-15',
                    priority: 'medium',
                    lastActivityDate: '2025-03-22'
                },
                {
                    id: 'opp7',
                    type: 'opportunity',
                    name: 'IT Support Contract',
                    company: 'Meridian Healthcare',
                    stage: 'qualification',
                    value: 120000,
                    closeDate: '2025-06-30',
                    priority: 'high',
                    lastActivityDate: '2025-03-19'
                }
                // More opportunities can be added here
            ];
            
            // Sample agent data
            const SAMPLE_AGENTS = [
                {
                    id: 'sales-analysis-agent',
                    name: 'Sales Analysis Agent',
                    description: 'Analyzes sales pipeline data to identify opportunities, risks, and trends. Generates daily and weekly reports for sales teams.',
                    type: 'analytics',
                    code: `function analyzeOpportunities(universe, params) {
    console.log('Sales Analysis Agent running in universe: ' + universe.id);
    
    // Access opportunities data from the universe
    const opportunities = universe.entities.filter(e => e.type === 'opportunity');
    
    // Filter out past opportunities - only look at present and future
    const activeOpportunities = opportunities.filter(opp => {
        const closeDate = new Date(opp.closeDate);
        const today = new Date();
        return closeDate >= today;
    });
    
    console.log(\`Found \${activeOpportunities.length} active opportunities\`);
    
    // Calculate key metrics
    const totalValue = activeOpportunities.reduce((sum, opp) => sum + opp.value, 0);
    const avgValue = totalValue / activeOpportunities.length;
    
    // Group by stage
    const byStage = {};
    activeOpportunities.forEach(opp => {
        if (!byStage[opp.stage]) {
            byStage[opp.stage] = [];
        }
        byStage[opp.stage].push(opp);
    });
    
    // Generate high-priority list
    const highPriority = activeOpportunities
        .filter(opp => opp.priority === 'high' || opp.value > avgValue * 1.5)
        .sort((a, b) => {
            // Sort by close date (ascending)
            return new Date(a.closeDate) - new Date(b.closeDate);
        })
        .slice(0, 5); // Top 5 high-priority opportunities
    
    // Find opportunities needing attention
    const needsAttention = activeOpportunities.filter(opp => {
        const lastActivityDate = new Date(opp.lastActivityDate);
        const today = new Date();
        const daysSinceActivity = Math.floor((today - lastActivityDate) / (1000 * 60 * 60 * 24));
        return daysSinceActivity > 5; // No activity in 5+ days
    });
    
    // Generate recommendations
    const recommendations = [];
    
    // For high-value opportunities approaching close date
    highPriority.forEach(opp => {
        const closeDate = new Date(opp.closeDate);
        const today = new Date();
        const daysToClose = Math.floor((closeDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysToClose < 30) {
            recommendations.push({
                opportunity: opp.name,
                company: opp.company,
                action: \`Follow up within \${daysToClose < 7 ? '48 hours' : '1 week'}\`,
                reason: \`High-value opportunity ($\${opp.value.toLocaleString()}) closing in \${daysToClose} days\`
            });
        }
    });
    
    // For opportunities with no recent activity
    needsAttention.forEach(opp => {
        const lastActivityDate = new Date(opp.lastActivityDate);
        const today = new Date();
        const daysSinceActivity = Math.floor((today - lastActivityDate) / (1000 * 60 * 60 * 24));
        
        recommendations.push({
            opportunity: opp.name,
            company: opp.company,
            action: 'Schedule follow-up call or email',
            reason: \`No activity for \${daysSinceActivity} days while in \${opp.stage} stage\`
        });
    });
    
    // Generate summary text for email
    const summaryText = \`
Good morning team,

Here's your daily opportunity report with key insights and recommendations:

Priority Opportunities:
\${highPriority.map((opp, i) => \`\${i+1}. \${opp.name} (\${opp.company}) - \${opp.stage} stage with projected value of $\${opp.value.toLocaleString()}. Close date is \${new Date(opp.closeDate).toLocaleDateString()}.\`).join('\\n')}

Sales Activities Needed:
- \${byStage['proposal'] ? byStage['proposal'].length : 0} opportunities need proposal follow-up
- \${needsAttention.length} opportunities have no activity in the last 5 days
- \${byStage['prospecting'] ? byStage['prospecting'].length : 0} new leads need qualification

For detailed analysis and all current opportunities, please visit your Slipspace dashboard.

Best regards,
Sales Analysis Agent
\`;
    
    // Return analysis results
    return {
        timestamp: new Date().toISOString(),
        metrics: {
            totalOpportunities: activeOpportunities.length,
            totalPipelineValue: totalValue,
            averageOpportunityValue: avgValue,
            opportunitiesByStage: Object.keys(byStage).reduce((result, stage) => {
                result[stage] = byStage[stage].length;
                return result;
            }, {})
        },
        highPriorityOpportunities: highPriority,
        needsAttention: needsAttention,
        recommendations: recommendations,
        emailSummary: summaryText
    };
}`
                },
                {
                    id: 'opportunity-prioritization-agent',
                    name: 'Opportunity Prioritization Agent',
                    description: 'Evaluates and ranks opportunities based on value, close probability, and resource requirements. Suggests optimal resource allocation.',
                    type: 'decision-support',
                    code: `function prioritizeOpportunities(universe, params) {
    console.log('Opportunity Prioritization Agent running in universe: ' + universe.id);
    
    // Access opportunities data from the universe
    const opportunities = universe.entities.filter(e => e.type === 'opportunity');
    
    // Filter out past and closed opportunities
    const activeOpportunities = opportunities.filter(opp => {
        const closeDate = new Date(opp.closeDate);
        const today = new Date();
        return closeDate >= today && !opp.stage.includes('closed');
    });
    
    console.log(\`Found \${activeOpportunities.length} active opportunities to prioritize\`);
    
    // Define stage weights (later stages have higher probability)
    const stageWeights = {
        'prospecting': 0.2,
        'qualification': 0.4,
        'proposal': 0.6,
        'negotiation': 0.8
    };
    
    // Calculate opportunity scores based on multiple factors
    const scoredOpportunities = activeOpportunities.map(opp => {
        // Get stage weight or default to 0.1
        const stageWeight = stageWeights[opp.stage] || 0.1;
        
        // Get close date proximity score (closer dates get higher score)
        const closeDate = new Date(opp.closeDate);
        const today = new Date();
        const daysToClose = Math.max(1, Math.floor((closeDate - today) / (1000 * 60 * 60 * 24)));
        const timeScore = 1 / Math.log10(daysToClose + 10); // Logarithmic scaling
        
        // Priority weight
        const priorityWeight = opp.priority === 'high' ? 1.5 : 
                              opp.priority === 'medium' ? 1.0 : 0.7;
        
        // Calculate final score
        // Formula: (Value * Stage Weight * Priority Weight) / Time Factor
        // This gives higher scores to high-value opportunities in later stages with closer close dates
        const score = (opp.value * stageWeight * priorityWeight * timeScore) / 10000;
        
        return {
            ...opp,
            score: parseFloat(score.toFixed(2)),
            stageWeight,
            timeScore: parseFloat(timeScore.toFixed(2)),
            priorityWeight
        };
    });
    
    // Sort by score (descending)
    scoredOpportunities.sort((a, b) => b.score - a.score);
    
    // Simple resource allocation model
    // Assuming we have 100 total resource units to allocate
    const totalResources = 100;
    const resourceAllocation = scoredOpportunities.map((opp, i) => {
        // Calculate resource percentage based on normalized score
        const totalScore = scoredOpportunities.reduce((sum, o) => sum + o.score, 0);
        const resourcePercentage = (opp.score / totalScore) * 100;
        const resourceUnits = Math.round((resourcePercentage / 100) * totalResources);
        
        return {
            opportunity: opp.name,
            company: opp.company,
            score: opp.score,
            rank: i + 1,
            resourcePercentage: parseFloat(resourcePercentage.toFixed(1)),
            resourceUnits
        };
    });
    
    return {
        timestamp: new Date().toISOString(),
        universeFactors: {
            gravity: universe.parameters.gravity,
            timeDilation: universe.parameters.time_dilation
        },
        prioritizedOpportunities: scoredOpportunities.map(opp => ({
            id: opp.id,
            name: opp.name,
            company: opp.company,
            value: opp.value,
            stage: opp.stage,
            closeDate: opp.closeDate,
            score: opp.score
        })),
        resourceAllocation,
        summary: \`Prioritized \${scoredOpportunities.length} opportunities based on value, stage, and close date. Top opportunity: \${scoredOpportunities[0]?.name || 'None'} with score \${scoredOpportunities[0]?.score || 0}.\`
    };
}`
                },
                {
                    id: 'email-summary-agent',
                    name: 'Email Summary Agent',
                    description: 'Creates concise, actionable email summaries of opportunity data and insights for delivery to sales teams and management.',
                    type: 'communication',
                    code: `function generateEmailSummary(universe, params) {
    console.log('Email Summary Agent running in universe: ' + universe.id);
    
    // Default parameters with overrides from params
    const options = {
        recipients: params.recipients || '[SALES_EMAIL]',
        includeFullDetails: params.includeFullDetails === undefined ? false : params.includeFullDetails,
        focusAreas: params.focusAreas || ['high-priority', 'at-risk', 'closing-soon'],
        format: params.format || 'html'
    };
    
    // Access opportunities data from the universe
    const opportunities = universe.entities.filter(e => e.type === 'opportunity');
    
    // Filter out past opportunities - only look at present and future
    const activeOpportunities = opportunities.filter(opp => {
        const closeDate = new Date(opp.closeDate);
        const today = new Date();
        return closeDate >= today;
    });
    
    // Calculate key metrics
    const totalValue = activeOpportunities.reduce((sum, opp) => sum + opp.value, 0);
    const closingSoon = activeOpportunities.filter(opp => {
        const closeDate = new Date(opp.closeDate);
        const today = new Date();
        const daysToClose = Math.floor((closeDate - today) / (1000 * 60 * 60 * 24));
        return daysToClose <= 30; // Closing in next 30 days
    });
    
    const highPriority = activeOpportunities.filter(opp => opp.priority === 'high');
    
    // Find opportunities needing attention (no activity in 5+ days)
    const needsAttention = activeOpportunities.filter(opp => {
        const lastActivityDate = new Date(opp.lastActivityDate);
        const today = new Date();
        const daysSinceActivity = Math.floor((today - lastActivityDate) / (1000 * 60 * 60 * 24));
        return daysSinceActivity > 5;
    });
    
    // Group by stage
    const byStage = {};
    activeOpportunities.forEach(opp => {
        if (!byStage[opp.stage]) {
            byStage[opp.stage] = [];
        }
        byStage[opp.stage].push(opp);
    });
    
    // Generate today's date string
    const today = new Date();
    const dateString = today.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    // Build email content
    const subject = \`Daily Opportunity Report - \${dateString}\`;
    
    // Email body
    let body = \`<p><strong>Good morning team,</strong></p>
<p>Here's your daily opportunity report with key insights and recommendations:</p>
<br>
<p><strong>Pipeline Summary:</strong></p>
<ul>
    <li>Total Active Opportunities: \${activeOpportunities.length}</li>
    <li>Total Pipeline Value: $\${totalValue.toLocaleString()}</li>
    <li>Opportunities Closing in Next 30 Days: \${closingSoon.length} ($\${closingSoon.reduce((sum, opp) => sum + opp.value, 0).toLocaleString()})</li>
</ul>
<br>\`;

    // Add Priority Opportunities section if requested
    if (options.focusAreas.includes('high-priority')) {
        body += \`<p><strong>Priority Opportunities:</strong></p>
<ol>\`;
        
        // Add each high priority opportunity
        highPriority.slice(0, 5).forEach(opp => {
            const closeDate = new Date(opp.closeDate);
            const daysToClose = Math.floor((closeDate - today) / (1000 * 60 * 60 * 24));
            
            body += \`<li><strong>\${opp.name} (\${opp.company})</strong> - \${opp.stage} stage with projected value of $\${opp.value.toLocaleString()}. Close date is approaching in \${daysToClose} days.</li>\`;
        });
        
        body += \`</ol>
<br>\`;
    }
    
    // Add At-Risk section if requested
    if (options.focusAreas.includes('at-risk') && needsAttention.length > 0) {
        body += \`<p><strong>Risk Alert:</strong></p>\`;
        
        needsAttention.slice(0, 3).forEach(opp => {
            const lastActivityDate = new Date(opp.lastActivityDate);
            const daysSinceActivity = Math.floor((today - lastActivityDate) / (1000 * 60 * 60 * 24));
            
            body += \`<p>\${opp.name} (\${opp.company}) has been in \${opp.stage} stage for \${daysSinceActivity} days without activity. Consider follow-up action.</p>\`;
        });
        
        body += \`<br>\`;
    }
    
    // Add Sales Activities Needed section
    body += \`<p><strong>Sales Activities Needed:</strong></p>
<ul>
    <li>\${byStage['proposal'] ? byStage['proposal'].length : 0} opportunities need proposal follow-up</li>
    <li>\${needsAttention.length} opportunities have no activity in the last 5 days</li>
    <li>\${byStage['prospecting'] ? byStage['prospecting'].length : 0} new leads need qualification</li>
</ul>
<br>\`;

    // Add universe context based on parameters
    const gravityFactor = universe.parameters.gravity;
    const timeDilation = universe.parameters.time_dilation;
    
    let marketInsight = '';
    if (timeDilation > 1.1) {
        marketInsight = 'Market conditions are accelerating deal cycles. Consider focusing on quick wins and fast-tracking high-value opportunities.';
    } else if (timeDilation < 0.9) {
        marketInsight = 'Market conditions are extending sales cycles. Focus on relationship building and addressing objections thoroughly.';
    } else if (gravityFactor > 10) {
        marketInsight = 'Current conditions favor conservative approaches. Prioritize existing customer relationships and incremental growth.';
    } else if (gravityFactor < 9) {
        marketInsight = 'Conditions favor bold moves. Consider pursuing larger deals and exploring new markets.';
    } else {
        marketInsight = 'Technology sector opportunities are showing higher close rates (75% vs. 68% overall). Consider focusing prospecting efforts in this vertical.';
    }
    
    body += \`<p><strong>Market Insight:</strong></p>
<p>\${marketInsight}</p>
<br>
<p>For detailed analysis and all current opportunities, please visit your Slipspace dashboard.</p>
<br>
<p>Best regards,<br>Sales Analysis Agent</p>\`;

    return {
        subject,
        to: options.recipients,
        body,
        metrics: {
            totalOpportunities: activeOpportunities.length,
            totalValue,
            closingSoon: closingSoon.length,
            highPriority: highPriority.length,
            needsAttention: needsAttention.length
        },
        timestamp: new Date().toISOString(),
        universeContext: {
            gravity: gravityFactor,
            timeDilation,
            marketInsight
        }
    };
}`
                },
                {
                    id: 'forecasting-agent',
                    name: 'Forecasting Agent',
                    description: 'Predicts sales pipeline outcomes and provides revenue forecasts based on historical data and current opportunity stages.',
                    type: 'analytics',
                    code: `function forecastRevenue(universe, params) {
    console.log('Forecasting Agent running in universe: ' + universe.id);
    
    // Default parameters with overrides from params
    const options = {
        forecastPeriod: params.forecastPeriod || 'quarter', // 'month', 'quarter', 'year'
        confidenceLevel: params.confidenceLevel || 'medium', // 'conservative', 'medium', 'aggressive'
        includeHistorical: params.includeHistorical === undefined ? true : params.includeHistorical
    };
    
    // Access opportunities data from the universe
    const opportunities = universe.entities.filter(e => e.type === 'opportunity');
    
    // Use universe parameters to adjust forecast probabilities
    const gravityFactor = universe.parameters.gravity;
    const timeDilation = universe.parameters.time_dilation;
    
    // Adjust base probabilities based on universe parameters
    const probabilityAdjustment = (1 / gravityFactor) * timeDilation;
    
    // Define base stage probabilities
    let stageProbabilities = {
        'prospecting': 0.1,
        'qualification': 0.3,
        'proposal': 0.5,
        'negotiation': 0.7,
        'closed-won': 1.0,
        'closed-lost': 0
    };
    
    // Adjust stage probabilities based on universe
    Object.keys(stageProbabilities).forEach(stage => {
        if (stage !== 'closed-won' && stage !== 'closed-lost') {
            stageProbabilities[stage] = Math.min(
                0.95, 
                Math.max(0.05, stageProbabilities[stage] * probabilityAdjustment)
            );
        }
    });
    
    // Further adjust based on confidence level
    const confidenceMultiplier = 
        options.confidenceLevel === 'conservative' ? 0.8 :
        options.confidenceLevel === 'aggressive' ? 1.2 : 1.0;
    
    Object.keys(stageProbabilities).forEach(stage => {
        if (stage !== 'closed-won' && stage !== 'closed-lost') {
            stageProbabilities[stage] = Math.min(
                0.95, 
                Math.max(0.05, stageProbabilities[stage] * confidenceMultiplier)
            );
        }
    });
    
    // Calculate forecast periods based on current date
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    // Define forecast periods
    const forecastPeriods = [];
    
    if (options.forecastPeriod === 'month') {
        // Next 3 months
        for (let i = 0; i < 3; i++) {
            const monthDate = new Date(currentYear, currentMonth + i, 1);
            const endDate = new Date(currentYear, currentMonth + i + 1, 0);
            
            forecastPeriods.push({
                name: monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
                startDate: monthDate,
                endDate: endDate
            });
        }
    } else if (options.forecastPeriod === 'quarter') {
        // Current quarter and next 3 quarters
        const currentQuarter = Math.floor(currentMonth / 3);
        
        for (let i = 0; i < 4; i++) {
            const quarterNumber = (currentQuarter + i) % 4;
            const yearOffset = Math.floor((currentQuarter + i) / 4);
            const quarterYear = currentYear + yearOffset;
            
            const startMonth = quarterNumber * 3;
            const startDate = new Date(quarterYear, startMonth, 1);
            const endDate = new Date(quarterYear, startMonth + 3, 0);
            
            forecastPeriods.push({
                name: \`Q\${quarterNumber + 1} \${quarterYear}\`,
                startDate: startDate,
                endDate: endDate
            });
        }
    } else { // year
        // Current year and next year
        forecastPeriods.push({
            name: \`\${currentYear}\`,
            startDate: new Date(currentYear, 0, 1),
            endDate: new Date(currentYear, 11, 31)
        });
        
        forecastPeriods.push({
            name: \`\${currentYear + 1}\`,
            startDate: new Date(currentYear + 1, 0, 1),
            endDate: new Date(currentYear + 1, 11, 31)
        });
    }
    
    // Calculate forecast for each period
    const forecast = forecastPeriods.map(period => {
        // Find opportunities expected to close in this period
        const periodOpportunities = opportunities.filter(opp => {
            const closeDate = new Date(opp.closeDate);
            return closeDate >= period.startDate && closeDate <= period.endDate;
        });
        
        // Calculate weighted and unweighted values
        let weightedTotal = 0;
        const unweightedTotal = periodOpportunities.reduce((sum, opp) => sum + opp.value, 0);
        
        // Calculate forecast with probability weighting
        periodOpportunities.forEach(opp => {
            const probability = stageProbabilities[opp.stage] || 0;
            weightedTotal += opp.value * probability;
        });
        
        return {
            period: period.name,
            startDate: period.startDate.toISOString(),
            endDate: period.endDate.toISOString(),
            opportunityCount: periodOpportunities.length,
            weightedForecast: Math.round(weightedTotal),
            unweightedTotal: Math.round(unweightedTotal),
            byStage: Object.keys(stageProbabilities).reduce((result, stage) => {
                const stageOpps = periodOpportunities.filter(opp => opp.stage === stage);
                if (stageOpps.length > 0) {
                    result[stage] = {
                        count: stageOpps.length,
                        value: stageOpps.reduce((sum, opp) => sum + opp.value, 0),
                        weightedValue: Math.round(
                            stageOpps.reduce((sum, opp) => sum + (opp.value * stageProbabilities[stage]), 0)
                        )
                    };
                }
                return result;
            }, {})
        };
    });
    
    // Calculate aggregate stats
    const totalWeightedForecast = forecast.reduce((sum, period) => sum + period.weightedForecast, 0);
    const totalUnweightedForecast = forecast.reduce((sum, period) => sum + period.unweightedTotal, 0);
    
    // Generate forecast insights
    const insights = [];
    
    // Compare to previous periods (simulation)
    const previousPeriodValue = totalWeightedForecast * (0.8 + (Math.random() * 0.4)); // Random previous value
    const percentChange = ((totalWeightedForecast - previousPeriodValue) / previousPeriodValue) * 100;
    
    insights.push({
        type: 'trend',
        insight: \`Forecast is \${percentChange > 0 ? 'up' : 'down'} \${Math.abs(percentChange).toFixed(1)}% compared to previous period.\`
    });
    
    // Generate universe-specific insight
    if (timeDilation > 1.1) {
        insights.push({
            type: 'acceleration',
            insight: 'Sales cycles are accelerating. Consider allocating more resources to deals in later stages to capture this momentum.'
        });
    } else if (timeDilation < 0.9) {
        insights.push({
            type: 'deceleration',
            insight: 'Sales cycles are lengthening. Focus on maintaining engagement throughout extended cycles and set appropriate stakeholder expectations.'
        });
    }
    
    if (gravityFactor > 10) {
        insights.push({
            type: 'risk',
            insight: 'Higher risk factors detected. Consider more conservative forecasts and implement additional deal validation steps.'
        });
    } else if (gravityFactor < 9) {
        insights.push({
            type: 'opportunity',
            insight: 'Favorable conditions detected. Consider more aggressive expansion into new accounts and upsell opportunities.'
        });
    }
    
    return {
        timestamp: new Date().toISOString(),
        universeParameters: {
            gravity: gravityFactor,
            timeDilation,
            probabilityAdjustment: parseFloat(probabilityAdjustment.toFixed(2))
        },
        confidenceLevel: options.confidenceLevel,
        stageProbabilities,
        forecast,
        summary: {
            totalWeightedForecast,
            totalUnweightedForecast,
            forecastAttainment: parseFloat((totalWeightedForecast / totalUnweightedForecast * 100).toFixed(1))
        },
        insights
    };
}`
                }
            ];
            
            // Constructor for universe instances
            function Universe(config) {
                this.id = config.id || `universe-${Date.now()}`;
                this.name = config.name || `Universe ${this.id}`;
                this.description = config.description || 'No description provided';
                this.parameters = config.parameters || {};
                this.constants = config.constants || {};
                this.entities = config.entities || [];
                this.agents = config.agents || [];
                this.history = config.history || [];
                this.created = config.created || new Date().toISOString();
                this.lastVisited = new Date().toISOString();
                
                // Initialize with sample data if entities array is empty
                if (this.entities.length === 0) {
                    this.initializeSampleData();
                }
                
                // Initialize with sample agents if agents array is empty
                if (this.agents.length === 0) {
                    this.initializeSampleAgents();
                }
            }
            
            // Universe instance methods
            Universe.prototype = {
                initializeSampleData: function() {
                    // Simple deep clone of sample data
                    let sampleData = JSON.parse(JSON.stringify(SAMPLE_OPPORTUNITIES));
                    
                    // Apply universe parameters to data
                    const gravityFactor = this.parameters.gravity || 9.8;
                    const timeDilation = this.parameters.time_dilation || 1.0;
                    
                    // Example: Adjust opportunity values based on universe parameters
                    sampleData = sampleData.map(opp => {
                        // Gravity affects deal values (higher gravity = lower values)
                        const gravityMultiplier = 9.8 / gravityFactor;
                        
                        // Time dilation affects close dates (higher dilation = closer dates)
                        const closeDate = new Date(opp.closeDate);
                        const now = new Date();
                        const timeDiff = closeDate - now;
                        const adjustedTimeDiff = timeDiff / timeDilation;
                        const adjustedCloseDate = new Date(now.getTime() + adjustedTimeDiff);
                        
                        return {
                            ...opp,
                            value: Math.round(opp.value * gravityMultiplier),
                            closeDate: adjustedCloseDate.toISOString().split('T')[0]
                        };
                    });
                    
                    this.entities = sampleData;
                },
                
                initializeSampleAgents: function() {
                    // Simple deep clone of sample agents
                    this.agents = JSON.parse(JSON.stringify(SAMPLE_AGENTS));
                },
                
                addEntity: function(entity) {
                    this.entities.push(entity);
                    return entity;
                },
                
                removeEntity: function(entityId) {
                    const index = this.entities.findIndex(e => e.id === entityId);
                    if (index !== -1) {
                        const removed = this.entities.splice(index, 1);
                        return removed[0];
                    }
                    return null;
                },
                
                addAgent: function(agent) {
                    // Check if agent already exists
                    const existingIndex = this.agents.findIndex(a => a.id === agent.id);
                    if (existingIndex !== -1) {
                        this.agents[existingIndex] = agent;
                    } else {
                        this.agents.push(agent);
                    }
                    return agent;
                },
                
                removeAgent: function(agentId) {
                    const index = this.agents.findIndex(a => a.id === agentId);
                    if (index !== -1) {
                        const removed = this.agents.splice(index, 1);
                        return removed[0];
                    }
                    return null;
                },
                
                executeAgent: function(agentId, params = {}) {
                    const agent = this.agents.find(a => a.id === agentId);
                    if (!agent || !agent.code) {
                        return {
                            success: false,
                            error: 'Agent not found or has no executable code'
                        };
                    }
                    
                    try {
                        // Create a safe execution context
                        const universeContext = {
                            id: this.id,
                            name: this.name,
                            parameters: { ...this.parameters },
                            constants: { ...this.constants },
                            // Provide read-only access to entities
                            entities: [...this.entities]
                        };
                        
                        // Extract the function name from the code
                        let functionName = agent.code.match(/function\s+([a-zA-Z0-9_]+)\s*\(/);
                        functionName = functionName ? functionName[1] : 'agentFunction';
                        
                        // Execute the agent code
                        const fullCode = `
                            const ${functionName} = ${agent.code};
                            return ${functionName}(universe, params);
                        `;
                        
                        const agentFunction = new Function('universe', 'params', fullCode);
                        const result = agentFunction(universeContext, params);
                        
                        // Record execution in history
                        this.recordExecution(agentId, params, result);
                        
                        return {
                            success: true,
                            result: result
                        };
                    } catch (error) {
                        // Record failed execution
                        this.recordExecution(agentId, params, null, error.message);
                        
                        console.error('Agent execution error:', error);
                        
                        return {
                            success: false,
                            error: error.message
                        };
                    }
                },
                
                recordExecution: function(agentId, params, result, error = null) {
                    const record = {
                        timestamp: new Date().toISOString(),
                        agentId: agentId,
                        parameters: params,
                        success: error === null,
                        result: result,
                        error: error
                    };
                    
                    this.history.push(record);
                    
                    // Limit history size to avoid excessive memory usage
                    if (this.history.length > 100) {
                        this.history = this.history.slice(-100);
                    }
                    
                    return record;
                },
                
                toJSON: function() {
                    return {
                        id: this.id,
                        name: this.name,
                        description: this.description,
                        parameters: this.parameters,
                        constants: this.constants,
                        entities: this.entities,
                        agents: this.agents,
                        history: this.history,
                        created: this.created,
                        lastVisited: new Date().toISOString()
                    };
                }
            };
            
            // Public API
            return {
                // Initialize the Slipspace with the default universe
                init: function() {
                    // Create default universes
                    this.createUniverse(DEFAULT_UNIVERSE);
                    
                    // Create optimistic universe
                    this.createUniverse({
                        id: 'optimistic-universe',
                        name: 'Optimistic Universe',
                        description: 'Optimistic scenario planning with higher success rates and accelerated timelines.',
                        parameters: {
                            gravity: 8.2, // Lower gravity = less friction/resistance
                            time_dilation: 1.25 // Higher time dilation = faster progress
                        }
                    });
                    
                    // Create conservative universe
                    this.createUniverse({
                        id: 'conservative-universe',
                        name: 'Conservative Universe',
                        description: 'Conservative scenario planning with lower success rates and extended timelines.',
                        parameters: {
                            gravity: 11.3, // Higher gravity = more friction/resistance
                            time_dilation: 0.8 // Lower time dilation = slower progress
                        }
                    });
                    
                    // Load saved universes from localStorage if they exist
                    this.loadFromStorage();
                    
                    // Set the first universe as current if none is set
                    if (!currentUniverse) {
                        const firstUniverseId = Object.keys(instances)[0];
                        currentUniverse = instances[firstUniverseId];
                    }
                    
                    return this;
                },
                
                // Create a new universe
                createUniverse: function(config) {
                    const universe = new Universe(config);
                    instances[universe.id] = universe;
                    this.saveToStorage();
                    return universe;
                },
                
                // Get a specific universe by ID
                getUniverse: function(id) {
                    return instances[id] || null;
                },
                
                // Get all universes
                getAllUniverses: function() {
                    return Object.values(instances);
                },
                
                // Set current universe
                setCurrentUniverse: function(id) {
                    if (instances[id]) {
                        currentUniverse = instances[id];
                        currentUniverse.lastVisited = new Date().toISOString();
                        this.saveToStorage();
                        return currentUniverse;
                    }
                    return null;
                },
                
                // Get current universe
                getCurrentUniverse: function() {
                    return currentUniverse;
                },
                
                // Delete a universe
                deleteUniverse: function(id) {
                    // Can't delete the last universe
                    if (Object.keys(instances).length <= 1) {
                        return false;
                    }
                    
                    // If deleting current universe, switch to another one
                    if (currentUniverse && currentUniverse.id === id) {
                        const universeIds = Object.keys(instances).filter(uId => uId !== id);
                        if (universeIds.length > 0) {
                            currentUniverse = instances[universeIds[0]];
                        }
                    }
                    
                    const deleted = delete instances[id];
                    this.saveToStorage();
                    return deleted;
                },
                
                // Execute an agent in the current universe
                executeAgent: function(agentId, params = {}) {
                    if (!currentUniverse) return null;
                    return currentUniverse.executeAgent(agentId, params);
                },
                
                // Execute an agent across multiple universes
                executeAgentAcrossUniverses: function(agentId, universeIds = [], params = {}) {
                    const results = {};
                    
                    for (const id of universeIds) {
                        const universe = instances[id];
                        if (universe) {
                            results[id] = universe.executeAgent(agentId, params);
                        }
                    }
                    
                    return results;
                },
                
                // Save all universe data to localStorage
                saveToStorage: function() {
                    try {
                        const serialized = {};
                        
                        for (const [id, universe] of Object.entries(instances)) {
                            serialized[id] = universe.toJSON();
                        }
                        
                        localStorage.setItem('slipspace_universes', JSON.stringify(serialized));
                        localStorage.setItem('slipspace_current_universe', currentUniverse ? currentUniverse.id : null);
                        
                        return true;
                    } catch (error) {
                        console.error('Failed to save universes to storage:', error);
                        return false;
                    }
                },
                
                // Load universe data from localStorage
                loadFromStorage: function() {
                    try {
                        const serialized = localStorage.getItem('slipspace_universes');
                        const currentUniverseId = localStorage.getItem('slipspace_current_universe');
                        
                        if (serialized) {
                            const parsed = JSON.parse(serialized);
                            
                            // Recreate universes from saved data
                            for (const [id, data] of Object.entries(parsed)) {
                                instances[id] = new Universe(data);
                            }
                            
                            // Set current universe
                            if (currentUniverseId && instances[currentUniverseId]) {
                                currentUniverse = instances[currentUniverseId];
                            }
                            
                            return true;
                        }
                    } catch (error) {
                        console.error('Failed to load universes from storage:', error);
                    }
                    
                    return false;
                },
                
                // Import a universe from JSON
                importUniverse: function(json) {
                    try {
                        const data = typeof json === 'string' ? JSON.parse(json) : json;
                        
                        // Validate minimum required properties
                        if (!data.id) {
                            data.id = `universe-${Date.now()}`;
                        }
                        
                        // Create the universe
                        const universe = this.createUniverse(data);
                        
                        return universe;
                    } catch (error) {
                        console.error('Failed to import universe:', error);
                        return null;
                    }
                },
                
                // Export the current universe as JSON
                exportCurrentUniverse: function() {
                    if (!currentUniverse) return null;
                    return JSON.stringify(currentUniverse.toJSON(), null, 2);
                },
                
                // Export a specific universe as JSON
                exportUniverse: function(id) {
                    const universe = instances[id];
                    if (!universe) return null;
                    return JSON.stringify(universe.toJSON(), null, 2);
                }
            };
        })();

        // Initialize the SlipspaceUniverse singleton
        SlipspaceUniverse.init();

        // Main application initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loader after page loaded
            const loader = document.getElementById('loader');
            
            // Set up navigation
            setupNavigation();
            
            // Setup sidebar collapse
            setupSidebarCollapse();
            
            // Setup universe switching
            setupUniverseSwitching();
            
            // Setup agent management
            setupAgentManagement();
            
            // Setup universe management
            setupUniverseManagement();
            
            // Setup opportunity management
            setupOpportunityManagement();
            
            // Setup theme switching
            setupThemeSwitching();
            
            // Setup modal handling
            setupModals();
            
            // Initialize content based on current universe
            updateCurrentUniverseDisplay();
            
            // Hide loader
            setTimeout(() => {
                loader.style.display = 'none';
            }, 800);
        });

        // Setup navigation between pages
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const pageId = link.getAttribute('data-page');
                    
                    // Deactivate all links and hide all pages
                    navLinks.forEach(l => l.classList.remove('active'));
                    pages.forEach(p => p.style.display = 'none');
                    
                    // Activate clicked link and show corresponding page
                    link.classList.add('active');
                    document.getElementById(`${pageId}-page`).style.display = 'block';
                    
                    // Hide mobile sidebar if open
                    const sidebar = document.getElementById('sidebar');
                    const sidebarOverlay = document.getElementById('sidebar-overlay');
                    if (window.innerWidth < 768) {
                        sidebar.classList.remove('open');
                        sidebarOverlay.classList.remove('active');
                    }
                });
            });
            
            // Mobile sidebar toggle
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            mobileMenuButton.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('active');
            });
            
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
            });
        }

        // Setup sidebar collapse functionality
        function setupSidebarCollapse() {
            const collapseButton = document.getElementById('collapse-sidebar');
            const sidebar = document.getElementById('sidebar');
            
            collapseButton.addEventListener('click', () => {
                sidebar.classList.toggle('sidebar-collapsed');
                
                // Toggle button icon
                if (sidebar.classList.contains('sidebar-collapsed')) {
                    collapseButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    `;
                } else {
                    collapseButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    `;
                }
            });
        }

        // Setup universe switching
        function setupUniverseSwitching() {
            const universeTrigger = document.getElementById('universe-dropdown-trigger');
            
            // Update the current universe display
            updateCurrentUniverseDisplay();
            
            // Handle universe card clicks
            document.querySelectorAll('.universe-card').forEach(card => {
                card.addEventListener('click', () => {
                    const universeId = card.getAttribute('data-universe-id');
                    if (universeId) {
                        SlipspaceUniverse.setCurrentUniverse(universeId);
                        updateCurrentUniverseDisplay();
                    }
                });
            });
            
            // Handle universe visit button clicks
            document.addEventListener('click', event => {
                const visitBtn = event.target.closest('.btn-icon-primary[title="Visit Universe"]');
                if (visitBtn) {
                    const card = visitBtn.closest('.universe-card');
                    if (card) {
                        const universeId = card.getAttribute('data-universe-id');
                        if (universeId) {
                            SlipspaceUniverse.setCurrentUniverse(universeId);
                            updateCurrentUniverseDisplay();
                        }
                    }
                }
            });
        }

        // Update the current universe display
        function updateCurrentUniverseDisplay() {
            const currentUniverse = SlipspaceUniverse.getCurrentUniverse();
            
            if (currentUniverse) {
                // Update header display
                document.getElementById('current-universe-name').textContent = currentUniverse.name;
                
                // Update universe cards
                document.querySelectorAll('.universe-card').forEach(card => {
                    const universeId = card.getAttribute('data-universe-id');
                    
                    if (universeId === currentUniverse.id) {
                        card.classList.add('universe-card-current');
                    } else {
                        card.classList.remove('universe-card-current');
                    }
                });
            }
        }

        // Setup agent management
        function setupAgentManagement() {
            // Setup agent tabs
            const agentTabs = document.querySelectorAll('.tab[data-tab]');
            
            agentTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Deactivate all tabs
                    agentTabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.agent-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Activate selected tab
                    tab.classList.add('active');
                    document.getElementById(`${tabId}-section`).classList.add('active');
                });
            });
            
            // Setup agent card actions
            document.querySelectorAll('.agent-card').forEach(card => {
                const configureBtn = card.querySelector('.btn-secondary');
                const runBtn = card.querySelector('.btn-primary');
                
                if (configureBtn) {
                    configureBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const agentId = card.getAttribute('data-agent-id');
                        loadAgentForConfiguration(agentId);
                    });
                }
                
                if (runBtn) {
                    runBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const agentId = card.getAttribute('data-agent-id');
                        loadAgentForExecution(agentId);
                    });
                }
            });
            
            // Save agent configuration
            document.getElementById('save-agent-config').addEventListener('click', saveAgentConfiguration);
            
            // Reset agent configuration
            document.getElementById('reset-agent-config').addEventListener('click', resetAgentConfiguration);
            
            // Run agent
            document.getElementById('run-agent').addEventListener('click', runCurrentAgent);
            
            // Stop agent
            document.getElementById('stop-agent').addEventListener('click', stopCurrentAgent);
            
            // Create new agent button
            document.getElementById('new-agent-btn').addEventListener('click', () => {
                document.getElementById('new-agent-modal').classList.add('active');
            });
            
            // Create new agent form submission
            document.getElementById('create-new-agent').addEventListener('click', createNewAgent);
            
            // Cancel new agent creation
            document.getElementById('cancel-new-agent').addEventListener('click', () => {
                document.getElementById('new-agent-modal').classList.remove('active');
            });
            
            // Close new agent modal
            document.getElementById('close-new-agent-modal').addEventListener('click', () => {
                document.getElementById('new-agent-modal').classList.remove('active');
            });
        }

        // Global variable to track current agent
        let currentAgentId = null;

        // Load agent for configuration
        function loadAgentForConfiguration(agentId) {
            const currentUniverse = SlipspaceUniverse.getCurrentUniverse();
            if (!currentUniverse) return;
            
            const agent = currentUniverse.agents.find(a => a.id === agentId);
            if (!agent) return;
            
            // Set current agent
            currentAgentId = agentId;
            
            // Fill form fields
            document.getElementById('agent-name').value = agent.name || '';
            document.getElementById('agent-description').value = agent.description || '';
            document.getElementById('agent-code').value = agent.code || '';
            
            // Set agent type dropdown
            const typeSelect = document.getElementById('agent-type');
            if (typeSelect) {
                for (let i = 0; i < typeSelect.options.length; i++) {
                    if (typeSelect.options[i].value === agent.type) {
                        typeSelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            // Switch to configuration tab
            document.querySelector('.tab[data-tab="agent-configuration"]').click();
        }

        // Load agent for execution
        function loadAgentForExecution(agentId) {
            const currentUniverse = SlipspaceUniverse.getCurrentUniverse();
            if (!currentUniverse) return;
            
            const agent = currentUniverse.agents.find(a => a.id === agentId);
            if (!agent) return;
            
            // Set current agent
            currentAgentId = agentId;
            
            // Load agent configuration first (reuse the function)
            loadAgentForConfiguration(agentId);
            
            // Then switch to execution tab
            document.querySelector('.tab[data-tab="agent-execution"]').click();
            
            // Reset execution status
            const statusElement = document.getElementById('agent-status');
            statusElement.className = 'agent-execution-status ready';
            statusElement.innerHTML = `
                <div class="agent-execution-status-indicator"></div>
                <span>Ready to run</span>
            `;
            
            // Reset logs
            document.getElementById('execution-logs').textContent = '// Agent execution logs will appear here';
            
            // Reset buttons
            document.getElementById('run-agent').disabled = false;
            document.getElementById('stop-agent').disabled = true;
        }

        // Save agent configuration
        function saveAgentConfiguration() {
            if (!currentAgentId) return;
            
            const currentUniverse = SlipspaceUniverse.getCurrentUniverse();
            if (!currentUniverse) return;
            
            const name = document.getElementById('agent-name').value.trim();
            const description = document.getElementById('agent-description').value.trim();
            const code = document.getElementById('agent-code').value.trim();
            const type = document.getElementById('agent-type').value;
            
            if (!name) {
                alert('Please provide a name for the agent');
                return;
            }
            
            if (!code) {
                alert('Agent code cannot be empty');
                return;
            }
            
            // Find the agent in the current universe
            const agentIndex = currentUniverse.agents.findIndex(a => a.id === currentAgentId);
            
            if (agentIndex !== -1) {
                // Update the agent
                currentUniverse.agents[agentIndex] = {
                    ...currentUniverse.agents[agentIndex],
                    name,
                    description,
                    code,
                    type
                };
                
                // Save to storage
                SlipspaceUniverse.saveToStorage();
                
                alert('Agent configuration saved successfully');
            }
        }

        // Reset agent configuration
        function resetAgentConfiguration() {
            if (!currentAgentId) return;
            
            const currentUniverse = SlipspaceUniverse.getCurrentUniverse();
            if (!currentUniverse) return;
            
            const agent = currentUniverse.agents.find(a => a.id === currentAgentId);
            if (!agent) return;
            
            // Reset form fields to original values
            document.getElementById('agent-name').value = agent.name || '';
            document.getElementById('agent-description').value = agent.description || '';
            document.getElementById('agent-code').value = agent.code || '';
            
            // Reset agent type dropdown
            const typeSelect = document.getElementById('agent-type');
            if (typeSelect) {
                for (let i = 0; i < typeSelect.options.length; i++) {
                    if (typeSelect.options[i].value === agent.type) {
                        typeSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }

        // Run current agent
        function runCurrentAgent() {
            if (!currentAgentId) return;
            
            // Update status
            const statusElement = document.getElementById('agent-status');
            statusElement.className = 'agent-execution-status running';
            statusElement.innerHTML = `
                <div class="agent-execution-status-indicator"></div>
                <span>Running...</span>
            `;
            
            // Update buttons
            document.getElementById('run-agent').disabled = true;
            document.getElementById('stop-agent').disabled = false;
            
            // Clear previous logs
            const logsElement = document.getElementById('execution-logs');
            logsElement.textContent = '// Starting agent execution\n';
            
            // Get execution parameters
            const paramsText = document.getElementById('execution-params').value.trim();
            let params = {};
            
            try {
                if (paramsText) {
                    params = JSON.parse(paramsText);
                }
            } catch (error) {
                logsElement.textContent += `Error parsing parameters: ${error.message}\n`;
                updateAgentStatus('error', 'Failed to parse parameters');
                return;
            }
            
            // Get selected universes
            const targetUniversesSelect = document.getElementById('target-universes');
            const selectedUniverses = Array.from(targetUniversesSelect.selectedOptions).map(opt => opt.value);
            
            if (selectedUniverses.length === 0) {
                logsElement.textContent += 'Error: No universes selected for execution\n';
                updateAgentStatus('error', 'No universes selected');
                return;
            }
            
            // Add execution start to logs
            logsElement.textContent += `[${new Date().toLocaleTimeString()}] Starting execution across ${selectedUniverses.length} universes\n`;
            
            // Wait a bit to show the running status
            setTimeout(() => {
                // Execute the agent across all selected universes
                const results = SlipspaceUniverse.executeAgentAcrossUniverses(currentAgentId, selectedUniverses, params);
                
                // Process results
                for (const [universeId, result] of Object.entries(results)) {
                    const universe = SlipspaceUniverse.getUniverse(universeId);
                    const universeName = universe ? universe.name : universeId;
                    
                    if (result.success) {
                        logsElement.textContent += `[${new Date().toLocaleTimeString()}] Execution successful in universe "${universeName}"\n`;
                    } else {
                        logsElement.textContent += `[${new Date().toLocaleTimeString()}] ERROR in universe "${universeName}": ${result.error}\n`;
                    }
                }
                
                // Update status
                if (Object.values(results).every(r => r.success)) {
                    updateAgentStatus('success', 'Execution completed');
                } else if (Object.values(results).every(r => !r.success)) {
                    updateAgentStatus('error', 'Execution failed in all universes');
                } else {
                    updateAgentStatus('success', 'Execution completed with some errors');
                }
                
                // Display results
                displayAgentResults(results);
                
                // Add completion to logs
                logsElement.textContent += `[${new Date().toLocaleTimeString()}] Execution completed\n`;
                
                // Auto-switch to results tab
                document.querySelector('.tab[data-tab="agent-results"]').click();
            }, 1500);
        }

        // Update agent status UI
        function updateAgentStatus(status, text) {
            const statusElement = document.getElementById('agent-status');
            statusElement.className = `agent-execution-status ${status}`;
            statusElement.innerHTML = `
                <div class="agent-execution-status-indicator"></div>
                <span>${text}</span>
            `;
            
            // Update buttons
            document.getElementById('run-agent').disabled = false;
            document.getElementById('stop-agent').disabled = true;
        }

        // Stop current agent
        function stopCurrentAgent() {
            // Since we're simulating execution, this just updates the UI
            updateAgentStatus('ready', 'Execution stopped');
            
            // Add to logs
            const logsElement = document.getElementById('execution-logs');
            logsElement.textContent += `[${new Date().toLocaleTimeString()}] Execution stopped by user\n`;
        }

        // Display agent execution results
        function displayAgentResults(results) {
            const resultsContainer = document.getElementById('results-container');
            
            // Clear previous results (except the Email Summary Preview)
            const emailPreview = resultsContainer.querySelector('.card');
            resultsContainer.innerHTML = '';
            
            // Process each universe result
            for (const [universeId, result] of Object.entries(results)) {
                const universe = SlipspaceUniverse.getUniverse(universeId);
                const universeName = universe ? universe.name : universeId;
                
                const resultCard = document.createElement('div');
                resultCard.className = 'agent-result-card';
                
                // Card header with status
                const header = document.createElement('div');
                header.className = 'agent-result-header';
                
                const statusClass = result.success ? 'badge-green' : 'badge-red';
                const statusText = result.success ? 'Success' : 'Failed';
                
                header.innerHTML = `
                    <div class="agent-result-title">
                        <span class="badge ${statusClass}">${statusText}</span>
                        ${universeName}
                    </div>
                    <div class="agent-result-actions">
                        <button class="btn-icon btn-icon-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </button>
                    </div>
                `;
                
                // Card content with result data
                const content = document.createElement('div');
                content.className = 'agent-result-content';
                
                if (result.success) {
                    // Format result based on agent type and data
                    content.innerHTML = formatAgentResult(currentAgentId, result.result);
                } else {
                    content.innerHTML = `
                        <div style="color: var(--error);">Error: ${result.error}</div>
                    `;
                }
                
                resultCard.appendChild(header);
                resultCard.appendChild(content);
                resultsContainer.appendChild(resultCard);
            }
            
            // Add back email preview if exists
            if (emailPreview) {
                resultsContainer.appendChild(emailPreview);
            }
        }

        // Format agent result based on agent type and data
        function formatAgentResult(agentId, result) {
            if (!result) return '<div>No result data</div>';
            
            // Basic formatting by agent type
            switch (agentId) {
                case 'sales-analysis-agent':
                    return `
                        <h4>Analysis Results:</h4>
                        <div style="margin-top: 10px;">
                            <strong>Total Opportunities:</strong> ${result.metrics?.totalOpportunities || 0}<br>
                            PipelineValue?.toLocaleString() || 0}<br>
                            <strong>High Priority Opportunities:</strong> ${result.highPriorityOpportunities?.length || 0}<br>
                            <strong>Needs Attention:</strong> ${result.needsAttention?.length || 0}<br>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Top Recommendations:</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                ${result.recommendations?.slice(0, 3).map(rec => `<li>${rec.action} for ${rec.opportunity} (${rec.company})</li>`).join('') || '<li>No recommendations available</li>'}
                            </ul>
                        </div>
                    `;
                
                case 'opportunity-prioritization-agent':
                    return `
                        <h4>Prioritization Results:</h4>
                        <div style="margin-top: 10px;">
                            <strong>Top Opportunities:</strong><br>
                            <ol style="margin-left: 20px; margin-top: 5px;">
                                ${result.prioritizedOpportunities?.slice(0, 3).map(opp => `<li>${opp.name} (${opp.company}) - Score: ${opp.score}</li>`).join('') || '<li>No prioritized opportunities</li>'}
                            </ol>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Resource Allocation:</strong><br>
                            ${result.resourceAllocation?.slice(0, 3).map(res => `${res.opportunity}: ${res.resourcePercentage}% (${res.resourceUnits} units)<br>`).join('') || 'No resource allocation data'}
                        </div>
                    `;
                
                case 'email-summary-agent':
                    // Update the email preview card with the latest email content
                    updateEmailPreview(result);
                    
                    return `
                        <h4>Email Summary Generated:</h4>
                        <div style="margin-top: 10px;">
                            <strong>Subject:</strong> ${result.subject || 'No subject'}<br>
                            <strong>Recipients:</strong> ${result.to || 'No recipients'}<br>
                            <strong>Metrics:</strong><br>
                            - Total Opportunities: ${result.metrics?.totalOpportunities || 0}<br>
                            - Total Value: $${result.metrics?.totalValue?.toLocaleString() || 0}<br>
                            - Opportunities Closing Soon: ${result.metrics?.closingSoon || 0}<br>
                        </div>
                        <div style="margin-top: 10px;">
                            <em>Email content available in the preview panel below</em>
                        </div>
                    `;
                
                case 'forecasting-agent':
                    return `
                        <h4>Forecast Results:</h4>
                        <div style="margin-top: 10px;">
                            <strong>Total Weighted Forecast:</strong> $${result.summary?.totalWeightedForecast?.toLocaleString() || 0}<br>
                            <strong>Forecast Attainment:</strong> ${result.summary?.forecastAttainment || 0}%<br>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Period Forecasts:</strong><br>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                ${result.forecast?.slice(0, 3).map(period => `<li>${period.period}: $${period.weightedForecast?.toLocaleString() || 0}</li>`).join('') || '<li>No forecast periods</li>'}
                            </ul>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Insights:</strong><br>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                ${result.insights?.map(insight => `<li>${insight.insight}</li>`).join('') || '<li>No insights available</li>'}
                            </ul>
                        </div>
                    `;
                
                default:
                    // Generic result formatting for unknown agent types
                    return `
                        <h4>Agent Results:</h4>
                        <pre style="margin-top: 10px; padding: 10px; background-color: #f5f5f5; overflow: auto; border-radius: 4px; font-size: 12px;">${JSON.stringify(result, null, 2)}</pre>
                    `;
            }
        }

        // Update email preview with generated content
        function updateEmailPreview(result) {
            if (!result || !result.body) return;
            
            // Find or create email preview card
            let emailPreviewCard = document.querySelector('.card[style*="grid-column"]');
            
            if (!emailPreviewCard) {
                const resultsContainer = document.getElementById('results-container');
                
                emailPreviewCard = document.createElement('div');
                emailPreviewCard.className = 'card';
                emailPreviewCard.style.gridColumn = '1 / -1';
                
                emailPreviewCard.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">Email Summary Preview</div>
                        <div class="card-actions">
                            <button class="btn btn-secondary btn-sm copy-email-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <span>Copy</span>
                            </button>
                            <button class="btn btn-primary btn-sm send-email-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                    <polyline points="22,6 12,13 2,6"></polyline>
                                </svg>
                                <span>Send</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="email-preview">
                            <div class="email-header">
                                <div class="email-field">
                                    <div class="email-field-label">To:</div>
                                    <div class="email-field-value">${result.to || 'Sales Team &lt;[SALES_EMAIL]&gt;'}</div>
                                </div>
                                <div class="email-field">
                                    <div class="email-field-label">Subject:</div>
                                    <div class="email-field-value">${result.subject || 'Daily Opportunity Report'}</div>
                                </div>
                            </div>
                            <div class="email-body">
                                ${result.body}
                            </div>
                        </div>
                    </div>
                `;
                
                resultsContainer.appendChild(emailPreviewCard);
                
                // Add event listeners to buttons
                const copyBtn = emailPreviewCard.querySelector('.copy-email-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        const emailBody = emailPreviewCard.querySelector('.email-body').innerHTML;
                        // Create a temporary element to hold the HTML content
                        const tempElement = document.createElement('div');
                        tempElement.innerHTML = emailBody;
                        
                        // Use the newer Clipboard API if available
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(tempElement.innerText)
                                .then(() => alert('Email content copied to clipboard'))
                                .catch(err => console.error('Failed to copy:', err));
                        } else {
                            alert('Copy functionality not available in this browser');
                        }
                    });
                }
                
                const sendBtn = emailPreviewCard.querySelector('.send-email-btn');
                if (sendBtn) {
                    sendBtn.addEventListener('click', () => {
                        alert('Email would be sent in a production environment');
                    });
                }
            } else {
                // Update existing card
                const toField = emailPreviewCard.querySelector('.email-field-value:first-child');
                const subjectField = emailPreviewCard.querySelector('.email-field-value:last-child');
                const bodyField = emailPreviewCard.querySelector('.email-body');
                
                if (toField) toField.textContent = result.to || 'Sales Team <[SALES_EMAIL]>';
                if (subjectField) subjectField.textContent = result.subject || 'Daily Opportunity Report';
                if (bodyField) bodyField.innerHTML = result.body;
            }
        }

        // Create new agent
        function createNewAgent() {
            const name = document.getElementById('new-agent-name').value.trim();
            const description = document.getElementById('new-agent-description').value.trim();
            const type = document.getElementById('new-agent-type').value;
            const template = document.getElementById('new-agent-template').value;
            
            if (!name) {
                alert('Please provide a name for the agent');
                return;
            }
            
            // Generate ID from name
            const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '-' + Date.now().toString(36);
            
            // Get template code
            let code = '';
            
            switch (template) {
                case 'analysis':
                    code = `function analyzeData(universe, params) {
    console.log('Analysis Agent running in universe: ' + universe.id);
    
    // Access data from the universe
    const entities = universe.entities;
    
    // Filter entities based on parameters
    const filteredEntities = entities.filter(entity => {
        // Implement your filtering logic here
        return true; // Default: include all entities
    });
    
    console.log(\`Processing \${filteredEntities.length} entities\`);
    
    // Perform analysis
    const analysisResults = {
        count: filteredEntities.length,
        categories: {},
        metrics: {}
    };
    
    // Example: categorize entities
    filteredEntities.forEach(entity => {
        const category = entity.category || 'uncategorized';
        
        if (!analysisResults.categories[category]) {
            analysisResults.categories[category] = [];
        }
        
        analysisResults.categories[category].push(entity);
    });
    
    // Calculate metrics
    for (const [category, items] of Object.entries(analysisResults.categories)) {
        analysisResults.metrics[category] = {
            count: items.length,
            percentage: (items.length / filteredEntities.length) * 100
        };
    }
    
    return {
        timestamp: new Date().toISOString(),
        universeId: universe.id,
        parameters: universe.parameters,
        results: analysisResults,
        summary: \`Analyzed \${filteredEntities.length} entities across \${Object.keys(analysisResults.categories).length} categories.\`
    };
}`;
                    break;
                
                case 'reporting':
                    code = `function generateReport(universe, params) {
    console.log('Reporting Agent running in universe: ' + universe.id);
    
    // Default parameters with overrides from params
    const options = {
        reportType: params.reportType || 'summary',
        includeDetails: params.includeDetails === undefined ? true : params.includeDetails,
        format: params.format || 'html'
    };
    
    // Access data from the universe
    const entities = universe.entities;
    
    // Generate report data
    const reportData = {
        generated: new Date().toISOString(),
        universeId: universe.id,
        universeParameters: universe.parameters,
        entityCount: entities.length,
        categories: {}
    };
    
    // Process entities for the report
    entities.forEach(entity => {
        const category = entity.category || entity.type || 'uncategorized';
        
        if (!reportData.categories[category]) {
            reportData.categories[category] = {
                count: 0,
                items: []
            };
        }
        
        reportData.categories[category].count++;
        
        if (options.includeDetails) {
            reportData.categories[category].items.push({
                id: entity.id,
                name: entity.name,
                // Add other relevant entity properties
            });
        }
    });
    
    // Generate report content based on format
    let reportContent = '';
    
    if (options.format === 'html') {
        reportContent = \`
<h1>Universe Report: \${universe.name}</h1>
<p><strong>Generated:</strong> \${new Date().toLocaleString()}</p>
<p><strong>Total Entities:</strong> \${reportData.entityCount}</p>

<h2>Categories</h2>
<ul>
\${Object.entries(reportData.categories).map(([category, data]) => \`
    <li>
        <strong>\${category}:</strong> \${data.count} entities
        \${options.includeDetails && data.items.length > 0 ? \`
        <ul>
            \${data.items.map(item => \`<li>\${item.name || item.id}</li>\`).join('')}
        </ul>
        \` : ''}
    </li>
\`).join('')}
</ul>
\`;
    } else {
        // Plain text format
        reportContent = \`Universe Report: \${universe.name}
Generated: \${new Date().toLocaleString()}
Total Entities: \${reportData.entityCount}

Categories:
\${Object.entries(reportData.categories).map(([category, data]) => \`
- \${category}: \${data.count} entities
\${options.includeDetails && data.items.length > 0 ? data.items.map(item => \`  * \${item.name || item.id}\`).join('\\n') : ''}
\`).join('')}
\`;
    }
    
    return {
        reportType: options.reportType,
        format: options.format,
        timestamp: new Date().toISOString(),
        data: reportData,
        content: reportContent
    };
}`;
                    break;
                
                case 'decision':
                    code = `function makeDecision(universe, params) {
    console.log('Decision Making Agent running in universe: ' + universe.id);
    
    // Default parameters with overrides from params
    const options = {
        decisionType: params.decisionType || 'prioritization',
        criteria: params.criteria || ['value', 'effort', 'impact'],
        weights: params.weights || {value: 0.4, effort: 0.3, impact: 0.3}
    };
    
    // Access data from the universe
    const entities = universe.entities;
    
    // Filter entities if needed
    const candidateEntities = entities.filter(entity => {
        // Implement your filtering logic here
        return entity.type === 'opportunity' || entity.type === 'task';
    });
    
    console.log(\`Evaluating \${candidateEntities.length} candidates for decision\`);
    
    // Score each entity based on criteria and weights
    const scoredEntities = candidateEntities.map(entity => {
        // Calculate scores for each criterion
        const scores = {};
        let totalScore = 0;
        
        for (const criterion of options.criteria) {
            // Get the raw score (defaulting to a random value between 0-1 for this example)
            // In a real implementation, you would use entity properties or more complex calculations
            const rawScore = entity[criterion] !== undefined ? entity[criterion] : Math.random();
            
            // Apply weight
            const weight = options.weights[criterion] || 1 / options.criteria.length;
            const weightedScore = rawScore * weight;
            
            scores[criterion] = {
                raw: rawScore,
                weighted: weightedScore
            };
            
            totalScore += weightedScore;
        }
        
        return {
            entity,
            scores,
            totalScore
        };
    });
    
    // Sort by total score (descending)
    scoredEntities.sort((a, b) => b.totalScore - a.totalScore);
    
    // Make decision based on decision type
    let decision;
    
    switch (options.decisionType) {
        case 'selection':
            // Select the top-scoring entity
            decision = scoredEntities.length > 0 ? scoredEntities[0].entity : null;
            break;
            
        case 'threshold':
            // Select entities above a threshold (e.g., 0.6)
            const threshold = params.threshold || 0.6;
            decision = scoredEntities.filter(item => item.totalScore >= threshold).map(item => item.entity);
            break;
            
        case 'prioritization':
        default:
            // Return ordered list with scores
            decision = scoredEntities.map(item => ({
                id: item.entity.id,
                name: item.entity.name,
                score: item.totalScore,
                details: item.scores
            }));
            break;
    }
    
    // Adjust decision based on universe parameters
    const gravityFactor = universe.parameters.gravity || 9.8;
    const timeDilation = universe.parameters.time_dilation || 1.0;
    
    // Example adjustment: higher gravity makes decision more conservative
    // Lower time dilation makes decision more future-focused
    const universeContext = {
        riskTolerance: 1 - (gravityFactor / 15), // Range ~0.35-0.8
        timeFocus: timeDilation, // > 1 means present-focused, < 1 means future-focused
    };
    
    return {
        timestamp: new Date().toISOString(),
        decisionType: options.decisionType,
        criteria: options.criteria,
        weights: options.weights,
        universeContext,
        candidates: candidateEntities.length,
        decision,
        confidence: calculateConfidence(scoredEntities, universeContext)
    };
}

// Helper function to calculate confidence in the decision
function calculateConfidence(scoredEntities, universeContext) {
    if (scoredEntities.length === 0) return 0;
    
    // Simple confidence calculation based on:
    // 1. Score differential between top options (higher = more confident)
    // 2. Universe risk tolerance (higher = more confident)
    
    const topScore = scoredEntities[0].totalScore;
    const runnerUpScore = scoredEntities.length > 1 ? scoredEntities[1].totalScore : 0;
    const scoreDifferential = topScore - runnerUpScore;
    
    const baseConfidence = Math.min(1, scoreDifferential * 5); // Scale up the difference
    const adjustedConfidence = baseConfidence * (0.5 + universeContext.riskTolerance);
    
    return Math.min(1, Math.max(0, adjustedConfidence));
}`;
                    break;
                
                default: // empty template
                    code = `function agentFunction(universe, params) {
    console.log('Agent running in universe: ' + universe.id);
    
    // Access data from the universe
    const entities = universe.entities;
    
    // Process based on parameters
    const result = {
        timestamp: new Date().toISOString(),
        universeId: universe.id,
        entityCount: entities.length,
        parameters: params,
        // Add more results here
    };
    
    return result;
}`;
            }
            
            // Create the new agent
            const newAgent = {
                id,
                name,
                description,
                type,
                code
            };
            
            // Add to current universe
            const currentUniverse = SlipspaceUniverse.getCurrentUniverse();
            if (currentUniverse) {
                currentUniverse.addAgent(newAgent);
                
                // Save to storage
                SlipspaceUniverse.saveToStorage();
                
                // Close modal
                document.getElementById('new-agent-modal').classList.remove('active');
                
                // Reset form
                document.getElementById('new-agent-name').value = '';
                document.getElementById('new-agent-description').value = '';
                
                // Load the new agent for configuration
                loadAgentForConfiguration(id);
                
                // Switch to agents tab and refresh view
                document.querySelector('.nav-link[data-page="agents"]').click();
            }
        }

        // Setup universe management
        function setupUniverseManagement() {
            // Handle universe card clicks for selection
            document.addEventListener('click', event => {
                const universeCard = event.target.closest('.universe-card');
                if (universeCard && !event.target.closest('button')) {
                    const universeId = universeCard.getAttribute('data-universe-id');
                    if (universeId) {
                        SlipspaceUniverse.setCurrentUniverse(universeId);
                        updateCurrentUniverseDisplay();
                        
                        // Update universe cards to show current selection
                        document.querySelectorAll('.universe-card').forEach(card => {
                            if (card.getAttribute('data-universe-id') === universeId) {
                                card.classList.add('universe-card-current');
                            } else {
                                card.classList.remove('universe-card-current');
                            }
                        });
                    }
                }
            });
            
            // Handle universe edit button clicks
            document.addEventListener('click', event => {
                const editBtn = event.target.closest('.universe-card-actions .btn-icon-secondary');
                if (editBtn) {
                    const card = editBtn.closest('.universe-card');
                    if (card) {
                        const universeId = card.getAttribute('data-universe-id');
                        if (universeId) {
                            openUniverseEditModal(universeId);
                        }
                    }
                    event.stopPropagation(); // Prevent card click event
                }
            });
            
            // New universe button
            document.getElementById('new-universe-btn').addEventListener('click', createNewUniverse);
            
            // Import universe button
            document.getElementById('import-universe').addEventListener('click', importUniverse);
            
            // Reset universe import form
            document.getElementById('reset-universe-import').addEventListener('click', () => {
                document.getElementById('universe-import-json').value = '';
            });
            
            // Universe edit modal events
            document.getElementById('close-universe-modal').addEventListener('click', () => {
                document.getElementById('universe-edit-modal').classList.remove('active');
            });
            
            document.getElementById('cancel-universe-edit').addEventListener('click', () => {
                document.getElementById('universe-edit-modal').classList.remove('active');
            });
            
            document.getElementById('save-universe-edit').addEventListener('click', saveUniverseEdit);
        }

        // Global variable to track universe being edited
        let editingUniverseId = null;

        // Open universe edit modal
        function openUniverseEditModal(universeId) {
            const universe = SlipspaceUniverse.getUniverse(universeId);
            if (!universe) return;
            
            // Set editing universe
            editingUniverseId = universeId;
            
            // Fill form fields
            document.getElementById('edit-universe-name').value = universe.name || '';
            document.getElementById('edit-universe-description').value = universe.description || '';
            document.getElementById('edit-universe-gravity').value = universe.parameters?.gravity || 9.8;
            document.getElementById('edit-universe-time-dilation').value = universe.parameters?.time_dilation || 1.0;
            
            // Show modal
            document.getElementById('universe-edit-modal').classList.add('active');
        }

        // Save universe edit
        function saveUniverseEdit() {
            if (!editingUniverseId) return;
            
            const universe = SlipspaceUniverse.getUniverse(editingUniverseId);
            if (!universe) return;
            
            const name = document.getElementById('edit-universe-name').value.trim();
            const description = document.getElementById('edit-universe-description').value.trim();
            const gravity = parseFloat(document.getElementById('edit-universe-gravity').value);
            const timeDilation = parseFloat(document.getElementById('edit-universe-time-dilation').value);
            
            if (!name) {
                alert('Please provide a name for the universe');
                return;
            }
            
            // Update universe properties
            universe.name = name;
            universe.description = description;
            
            // Update parameters
            if (!universe.parameters) {
                universe.parameters = {};
            }
            
            universe.parameters.gravity = isNaN(gravity) ? 9.8 : gravity;
            universe.parameters.time_dilation = isNaN(timeDilation) ? 1.0 : timeDilation;
            
            // Save to storage
            SlipspaceUniverse.saveToStorage();
            
            // Update UI
            updateCurrentUniverseDisplay();
            
            // Close modal
            document.getElementById('universe-edit-modal').classList.remove('active');
            
            // Refresh universes view
            refreshUniverseCards();
        }

        // Create new universe
        function createNewUniverse() {
            // Generate unique ID
            const id = 'universe-' + Date.now().toString(36);
            
            // Create new universe with default values
            const newUniverse = {
                id,
                name: 'New Universe',
                description: 'A newly created universe',
                parameters: {
                    gravity: 9.8,
                    time_dilation: 1.0
                }
            };
            
            // Create the universe
            SlipspaceUniverse.createUniverse(newUniverse);
            
            // Refresh universes view
            refreshUniverseCards();
            
            // Open edit modal for the new universe
            openUniverseEditModal(id);
        }

        // Import universe from JSON
        function importUniverse() {
            const jsonText = document.getElementById('universe-import-json').value.trim();
            
            if (!jsonText) {
                alert('Please paste universe configuration JSON');
                return;
            }
            
            try {
                const universe = SlipspaceUniverse.importUniverse(jsonText);
                
                if (universe) {
                    // Refresh universes view
                    refreshUniverseCards();
                    
                    // Clear import field
                    document.getElementById('universe-import-json').value = '';
                    
                    alert(`Universe "${universe.name}" imported successfully`);
                } else {
                    alert('Failed to import universe');
                }
            } catch (error) {
                alert(`Error importing universe: ${error.message}`);
            }
        }

        // Refresh universe cards
        function refreshUniverseCards() {
            // Get all universes
            const universes = SlipspaceUniverse.getAllUniverses();
            
            // Get current universe
            const currentUniverse = SlipspaceUniverse.getCurrentUniverse();
            
            // Get container
            const container = document.querySelector('.universe-grid');
            if (!container) return;
            
            // Clear container
            container.innerHTML = '';
            
            // Add cards for each universe
            universes.forEach(universe => {
                const isCurrent = currentUniverse && currentUniverse.id === universe.id;
                
                const card = document.createElement('div');
                card.className = `universe-card${isCurrent ? ' universe-card-current' : ''}`;
                card.setAttribute('data-universe-id', universe.id);
                
                card.innerHTML = `
                    <div class="universe-card-header">
                        <div class="universe-card-title">${universe.name}</div>
                        <div class="universe-card-subtitle">${universe.description}</div>
                    </div>
                    <div class="universe-card-content">
                        <div class="universe-card-stats">
                            <div class="universe-card-stat">
                                <div class="universe-card-stat-label">Gravity</div>
                                <div class="universe-card-stat-value">${universe.parameters?.gravity?.toFixed(1) || '9.8'}</div>
                            </div>
                            <div class="universe-card-stat">
                                <div class="universe-card-stat-label">Time Dilation</div>
                                <div class="universe-card-stat-value">${universe.parameters?.time_dilation?.toFixed(2) || '1.00'}</div>
                            </div>
                            <div class="universe-card-stat">
                                <div class="universe-card-stat-label">Entities</div>
                                <div class="universe-card-stat-value">${universe.entities?.length || 0}</div>
                            </div>
                            <div class="universe-card-stat">
                                <div class="universe-card-stat-label">Agents</div>
                                <div class="universe-card-stat-value">${universe.agents?.length || 0}</div>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-tertiary);">Description</div>
                            <div>${universe.description}</div>
                        </div>
                    </div>
                    <div class="universe-card-footer">
                        <div class="universe-card-footer-text">${isCurrent ? 'Current Universe' : `Last updated: ${getRelativeTimeString(universe.lastVisited)}`}</div>
                        <div class="universe-card-actions">
                            ${!isCurrent ? `
                                <button class="btn-icon btn-icon-primary" title="Visit Universe">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </button>
                            ` : ''}
                            <button class="btn-icon btn-icon-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Get relative time string (e.g., "2 days ago")
        function getRelativeTimeString(datetimeStr) {
            if (!datetimeStr) return 'Unknown';
            
            try {
                const date = new Date(datetimeStr);
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                const diffHour = Math.floor(diffMin / 60);
                const diffDay = Math.floor(diffHour / 24);
                
                if (diffSec < 60) {
                    return 'Just now';
                } else if (diffMin < 60) {
                    return `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
                } else if (diffHour < 24) {
                    return `${diffHour} hour${diffHour !== 1 ? 's' : ''} ago`;
                } else if (diffDay < 30) {
                    return `${diffDay} day${diffDay !== 1 ? 's' : ''} ago`;
                } else {
                    // If over a month, return the date string
                    return date.toLocaleDateString();
                }
            } catch (error) {
                return 'Unknown';
            }
        }

        // Setup opportunity management
        function setupOpportunityManagement() {
            // Handle opportunity filtering
            document.querySelectorAll('.opportunity-filter-select').forEach(select => {
                select.addEventListener('change', filterOpportunities);
            });
            
            // Reset filters button
            const resetFiltersBtn = document.getElementById('reset-filters');
            if (resetFiltersBtn) {
                resetFiltersBtn.addEventListener('click', resetOpportunityFilters);
            }
            
            // Run opportunity analysis button
            const analysisBtn = document.getElementById('run-opportunity-analysis');
            if (analysisBtn) {
                analysisBtn.addEventListener('click', runOpportunityAnalysis);
            }
            
            // Generate daily report button
            const reportBtn = document.getElementById('generate-daily-report');
            if (reportBtn) {
                reportBtn.addEventListener('click', generateDailyReport);
            }
        }

        // Filter opportunities based on selected filters
        function filterOpportunities() {
            // In a real implementation, this would apply filters to the table
            // For this demo, we'll just show a message
            alert('Filters applied - in a real implementation, this would filter the opportunity table');
        }

        // Reset opportunity filters
        function resetOpportunityFilters() {
            // Reset all filter selects to first option
            document.querySelectorAll('.opportunity-filter-select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Apply filters (which would reset to show all)
            filterOpportunities();
        }

        // Run opportunity analysis
        function runOpportunityAnalysis() {
            // Show message
            alert('Running opportunity analysis...');
            
            // In a production implementation, this would:
            // 1. Run the analysis agent on the current universe
            // 2. Display the results
            // 3. Update the UI with insights
            
            // For this demo, we'll simulate success and navigate to the agents page
            setTimeout(() => {
                document.querySelector('.nav-link[data-page="agents"]').click();
                
                // Select the execution tab
                document.querySelector('.tab[data-tab="agent-results"]').click();
                
                alert('Analysis complete! Check the results tab for insights.');
            }, 1000);
        }

        // Generate daily report
        function generateDailyReport() {
            // Show message
            alert('Generating daily report...');
            
            // In a production implementation, this would:
            // 1. Run the email-summary-agent
            // 2. Generate the report
            // 3. Show the preview
            
            // For this demo, we'll just navigate to the agent results
            setTimeout(() => {
                document.querySelector('.nav-link[data-page="agents"]').click();
                
                // Select the results tab
                document.querySelector('.tab[data-tab="agent-results"]').click();
                
                alert('Report generated! Check the results tab to preview the email.');
            }, 1000);
        }

        // Setup theme switching
        function setupThemeSwitching() {
            const themeToggle = document.getElementById('theme-toggle');
            if (!themeToggle) return;
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('slipspace_theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggle.checked = true;
            }
            
            // Handle theme toggle
            themeToggle.addEventListener('change', () => {
                if (themeToggle.checked) {
                    document.body.classList.add('dark-theme');
                    localStorage.setItem('slipspace_theme', 'dark');
                } else {
                    document.body.classList.remove('dark-theme');
                    localStorage.setItem('slipspace_theme', 'light');
                }
            });
        }

        // Setup modal handling
        function setupModals() {
            // Close modal when clicking outside
            document.addEventListener('click', event => {
                const modals = document.querySelectorAll('.modal-overlay');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }
    </script>
</body>
</html>