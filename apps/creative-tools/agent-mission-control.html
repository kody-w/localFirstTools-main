<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Mission Control</title>
<meta name="rappterzoo:author" content="MoltEngine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="creative-tools">
<meta name="rappterzoo:tags" content="dashboard,agents,monitoring,timeline,charts,canvas">
<meta name="rappterzoo:type" content="interface">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="1">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0e0a;--panel:#0d1a0d;--border:#1a3a1a;--glow:#00ff4180;
  --text:#b0ffb0;--dim:#406040;--accent:#00ff41;--err:#ff4141;
  --warn:#ffa500;--blue:#41a0ff;--purple:#a041ff;--orange:#ff8c00;
  --red:#ff4141;--green:#00ff41;--white:#e0ffe0;
  --mono:'Courier New',Consolas,monospace;
}
html,body{height:100%;font-family:var(--mono);background:var(--bg);color:var(--text);overflow-x:hidden}
body{background-image:
  linear-gradient(rgba(0,255,65,.03) 1px,transparent 1px),
  linear-gradient(90deg,rgba(0,255,65,.03) 1px,transparent 1px);
  background-size:20px 20px;
}
h1,h2,h3{color:var(--accent);text-shadow:0 0 8px var(--glow)}
button{font-family:var(--mono);cursor:pointer;background:var(--panel);color:var(--accent);
  border:1px solid var(--border);padding:6px 14px;border-radius:4px;transition:all .2s}
button:hover{background:var(--border);box-shadow:0 0 10px var(--glow)}
input,select,textarea{font-family:var(--mono);background:var(--bg);color:var(--text);
  border:1px solid var(--border);padding:6px 10px;border-radius:4px;width:100%}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 6px var(--glow)}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;
  border-bottom:1px solid var(--border);background:var(--panel);flex-wrap:wrap;gap:8px}
.header h1{font-size:1.2rem;letter-spacing:2px;display:flex;align-items:center;gap:10px}
.header h1 .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);
  box-shadow:0 0 8px var(--accent);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.header-actions{display:flex;gap:6px;flex-wrap:wrap}
.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--panel);overflow-x:auto}
.tab{padding:10px 20px;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;
  color:var(--dim);transition:all .2s;font-size:.85rem}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);text-shadow:0 0 6px var(--glow)}
.content{padding:16px;max-width:1400px;margin:0 auto}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:16px;
  box-shadow:0 0 12px rgba(0,255,65,.05)}
.panel h2{font-size:1rem;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
.stat-card{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:14px;text-align:center}
.stat-card .value{font-size:1.8rem;color:var(--accent);font-weight:bold;text-shadow:0 0 10px var(--glow)}
.stat-card .label{font-size:.7rem;color:var(--dim);margin-top:4px;text-transform:uppercase;letter-spacing:1px}
.timeline-wrap{overflow-x:auto;padding:10px 0}
.timeline{position:relative;min-height:200px;min-width:800px}
.timeline-row{display:flex;align-items:center;margin-bottom:4px;position:relative}
.timeline-label{width:100px;font-size:.7rem;color:var(--dim);text-align:right;padding-right:10px;flex-shrink:0}
.timeline-track{flex:1;height:28px;position:relative;background:rgba(0,255,65,.02);border-radius:3px}
.timeline-block{position:absolute;height:24px;top:2px;border-radius:3px;cursor:pointer;
  transition:all .2s;font-size:.6rem;display:flex;align-items:center;padding:0 6px;
  overflow:hidden;white-space:nowrap;min-width:12px}
.timeline-block:hover{transform:scaleY(1.3);z-index:10;box-shadow:0 0 12px currentColor}
.timeline-block.selected{outline:2px solid var(--white);outline-offset:1px}
.tl-molter{background:rgba(0,255,65,.6);color:#000}
.tl-ranker{background:rgba(65,160,255,.6);color:#000}
.tl-community{background:rgba(160,65,255,.6);color:#fff}
.tl-broadcaster{background:rgba(255,140,0,.6);color:#000}
.tl-factory{background:rgba(255,65,65,.6);color:#fff}
.tl-recombiner{background:rgba(255,255,0,.6);color:#000}
.detail-panel{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:16px;
  margin-top:12px;display:none}
.detail-panel.open{display:block;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.detail-field{font-size:.8rem}
.detail-field .lbl{color:var(--dim);font-size:.65rem;text-transform:uppercase;letter-spacing:1px}
.detail-field .val{margin-top:2px}
.log-output{background:#000;border:1px solid var(--border);border-radius:4px;padding:10px;
  max-height:200px;overflow-y:auto;font-size:.75rem;color:var(--dim);white-space:pre-wrap;margin-top:8px}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
canvas{background:var(--bg);border:1px solid var(--border);border-radius:6px;width:100%;height:auto}
.filter-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
.filter-bar select,.filter-bar input{width:auto;min-width:140px}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.65rem;font-weight:bold}
.badge-success{background:rgba(0,255,65,.2);color:var(--green)}
.badge-fail{background:rgba(255,65,65,.2);color:var(--red)}
.badge-partial{background:rgba(255,165,0,.2);color:var(--warn)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-group label{font-size:.7rem;color:var(--dim);text-transform:uppercase;letter-spacing:1px}
.form-group.full{grid-column:1/-1}
.file-list{list-style:none;font-size:.8rem}
.file-list li{padding:3px 0;border-bottom:1px solid rgba(0,255,65,.05)}
.file-list li::before{content:'> ';color:var(--accent)}
.hidden{display:none!important}
.toast{position:fixed;bottom:20px;right:20px;background:var(--panel);border:1px solid var(--accent);
  padding:10px 18px;border-radius:6px;z-index:999;animation:slideIn .3s;font-size:.85rem;
  box-shadow:0 0 20px var(--glow)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.collapsible-header{cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.collapsible-header::after{content:'‚ñº';font-size:.6rem;transition:transform .2s}
.collapsible-header.collapsed::after{transform:rotate(-90deg)}
.import-section{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.import-section button{font-size:.75rem;padding:4px 10px}
@media(max-width:768px){
  .charts-grid,.detail-grid,.form-grid{grid-template-columns:1fr}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .header{flex-direction:column;text-align:center}
  .filter-bar{flex-direction:column}
  .filter-bar select,.filter-bar input{width:100%}
  .timeline{min-width:600px}
}
</style>
</head>
<body>
<div class="header">
  <h1><span class="dot"></span> AGENT MISSION CONTROL</h1>
  <div class="header-actions">
    <button onclick="exportAllData()" title="Export all data as JSON">‚¨á Export</button>
    <button onclick="document.getElementById('importFile').click()" title="Import JSON data">‚¨Ü Import</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importAllData(event)">
    <button onclick="resetData()" title="Reset to demo data">‚Üª Reset</button>
  </div>
</div>
<div class="tabs" id="tabBar">
  <div class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')">‚óâ Dashboard</div>
  <div class="tab" data-tab="timeline" onclick="switchTab('timeline')">‚ó´ Timeline</div>
  <div class="tab" data-tab="charts" onclick="switchTab('charts')">‚ó© Charts</div>
  <div class="tab" data-tab="log" onclick="switchTab('log')">‚úé Log Run</div>
  <div class="tab" data-tab="data" onclick="switchTab('data')">‚¨° Data</div>
</div>

<!-- DASHBOARD TAB -->
<div class="content tab-content" id="tab-dashboard">
  <div class="panel">
    <h2>‚ö° System Statistics</h2>
    <div class="stats-grid" id="statsGrid"></div>
  </div>
  <div class="panel">
    <h2>üìã Recent Agent Runs</h2>
    <div class="filter-bar">
      <select id="filterType" onchange="applyFilters()">
        <option value="">All Types</option>
        <option value="molter">Molter</option>
        <option value="ranker">Ranker</option>
        <option value="community">Community</option>
        <option value="broadcaster">Broadcaster</option>
        <option value="factory">Factory</option>
        <option value="recombiner">Recombiner</option>
      </select>
      <select id="filterStatus" onchange="applyFilters()">
        <option value="">All Status</option>
        <option value="success">Success</option>
        <option value="fail">Fail</option>
        <option value="partial">Partial</option>
      </select>
      <input type="date" id="filterFrom" onchange="applyFilters()" placeholder="From">
      <input type="date" id="filterTo" onchange="applyFilters()" placeholder="To">
      <input type="text" id="filterSearch" oninput="applyFilters()" placeholder="Search..." style="min-width:200px">
    </div>
    <div id="runsList"></div>
  </div>
  <div class="panel">
    <h2>üèÜ Most Active</h2>
    <div class="detail-grid">
      <div><h3 style="font-size:.85rem;margin-bottom:8px">Most Molted Apps</h3><ul class="file-list" id="mostMolted"></ul></div>
      <div><h3 style="font-size:.85rem;margin-bottom:8px">Most Active Categories</h3><ul class="file-list" id="mostActiveCategories"></ul></div>
    </div>
  </div>
</div>

<!-- TIMELINE TAB -->
<div class="content tab-content hidden" id="tab-timeline">
  <div class="panel">
    <h2>‚ó´ Agent Run Timeline</h2>
    <div class="filter-bar">
      <select id="tlFilterType" onchange="renderTimeline()">
        <option value="">All Types</option>
        <option value="molter">Molter</option>
        <option value="ranker">Ranker</option>
        <option value="community">Community</option>
        <option value="broadcaster">Broadcaster</option>
        <option value="factory">Factory</option>
        <option value="recombiner">Recombiner</option>
      </select>
      <button onclick="zoomTimeline(1)">Zoom +</button>
      <button onclick="zoomTimeline(-1)">Zoom ‚àí</button>
    </div>
    <div class="timeline-wrap">
      <div class="timeline" id="timelineContainer"></div>
    </div>
  </div>
  <div class="detail-panel" id="timelineDetail"></div>
</div>

<!-- CHARTS TAB -->
<div class="content tab-content hidden" id="tab-charts">
  <div class="charts-grid">
    <div class="panel">
      <h2>üìà Quality Scores Over Time</h2>
      <canvas id="chartLine" width="600" height="350"></canvas>
    </div>
    <div class="panel">
      <h2>üìä Apps Created Per Frame</h2>
      <canvas id="chartBar" width="600" height="350"></canvas>
    </div>
    <div class="panel">
      <h2>ü•ß Agent Type Distribution</h2>
      <canvas id="chartPie" width="600" height="350"></canvas>
    </div>
    <div class="panel">
      <h2>‚äï Molt Improvement (Before ‚Üí After)</h2>
      <canvas id="chartScatter" width="600" height="350"></canvas>
    </div>
  </div>
</div>

<!-- LOG RUN TAB -->
<div class="content tab-content hidden" id="tab-log">
  <div class="panel">
    <h2>‚úé Log Agent Run</h2>
    <form id="logForm" onsubmit="saveLogEntry(event)">
      <div class="form-grid">
        <div class="form-group">
          <label>Agent Type</label>
          <select id="logType" required>
            <option value="molter">Molter</option>
            <option value="ranker">Ranker</option>
            <option value="community">Community Gen</option>
            <option value="broadcaster">Broadcaster</option>
            <option value="factory">Factory</option>
            <option value="recombiner">Recombiner</option>
          </select>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="logStatus" required>
            <option value="success">Success</option>
            <option value="fail">Fail</option>
            <option value="partial">Partial</option>
          </select>
        </div>
        <div class="form-group full">
          <label>Description</label>
          <input type="text" id="logDesc" required placeholder="What did the agent do?">
        </div>
        <div class="form-group">
          <label>Files Created (comma-separated)</label>
          <input type="text" id="logCreated" placeholder="app1.html, app2.html">
        </div>
        <div class="form-group">
          <label>Files Modified (comma-separated)</label>
          <input type="text" id="logModified" placeholder="manifest.json, rankings.json">
        </div>
        <div class="form-group">
          <label>Files Deleted (comma-separated)</label>
          <input type="text" id="logDeleted" placeholder="old-app.html">
        </div>
        <div class="form-group">
          <label>Duration (seconds)</label>
          <input type="number" id="logDuration" min="1" value="120">
        </div>
        <div class="form-group full">
          <label>Molt Details (optional: app, before score, after score per line)</label>
          <textarea id="logMolts" rows="3" placeholder="space-game.html 42 67&#10;fractal-art.html 55 71"></textarea>
        </div>
        <div class="form-group full">
          <label>Log Output</label>
          <textarea id="logOutput" rows="4" placeholder="Paste agent log output here..."></textarea>
        </div>
        <div class="form-group full">
          <label>Errors/Warnings (one per line)</label>
          <textarea id="logErrors" rows="2" placeholder="Warning: file not found..."></textarea>
        </div>
      </div>
      <div style="margin-top:14px;display:flex;gap:8px">
        <button type="submit">üíæ Save Run</button>
        <button type="button" onclick="document.getElementById('logForm').reset()">Clear</button>
      </div>
    </form>
  </div>
</div>

<!-- DATA TAB -->
<div class="content tab-content hidden" id="tab-data">
  <div class="panel">
    <h2>‚¨° Import External Data</h2>
    <p style="font-size:.8rem;color:var(--dim);margin-bottom:12px">Load JSON data files from the RappterZoo ecosystem to enrich the dashboard.</p>
    <div class="import-section">
      <button onclick="document.getElementById('impMolter').click()">üì¶ molter-state.json</button>
      <input type="file" id="impMolter" accept=".json" class="hidden" onchange="importExternalData(event,'molter-state')">
      <button onclick="document.getElementById('impRankings').click()">üìä rankings.json</button>
      <input type="file" id="impRankings" accept=".json" class="hidden" onchange="importExternalData(event,'rankings')">
      <button onclick="document.getElementById('impCommunity').click()">üë• community.json</button>
      <input type="file" id="impCommunity" accept=".json" class="hidden" onchange="importExternalData(event,'community')">
      <button onclick="document.getElementById('impHistory').click()">üìú agent-history.json</button>
      <input type="file" id="impHistory" accept=".json" class="hidden" onchange="importExternalData(event,'agent-history')">
    </div>
  </div>
  <div class="panel">
    <h2>üíæ Stored Data Summary</h2>
    <div id="dataSummary"></div>
  </div>
  <div class="panel">
    <h2>üîç Raw Data Inspector</h2>
    <select id="rawDataSelect" onchange="showRawData()" style="margin-bottom:8px;width:auto">
      <option value="runs">Agent Runs</option>
      <option value="events">Events</option>
      <option value="external">External Data</option>
    </select>
    <div class="log-output" id="rawDataView" style="max-height:400px"></div>
  </div>
</div>

<script>
const STORAGE_KEY = 'amc_data';
const AGENT_TYPES = ['molter','ranker','community','broadcaster','factory','recombiner'];
const TYPE_COLORS = {molter:'#00ff41',ranker:'#41a0ff',community:'#a041ff',broadcaster:'#ff8c00',factory:'#ff4141',recombiner:'#ffff00'};
const TYPE_CLASS = {molter:'tl-molter',ranker:'tl-ranker',community:'tl-community',broadcaster:'tl-broadcaster',factory:'tl-factory',recombiner:'tl-recombiner'};
let state = {runs:[],events:[],external:{},timelineZoom:1};
let selectedRunId = null;

function generateDemoData(){
  const runs = [];
  const events = [];
  const cats = ['games-puzzles','visual-art','audio-music','generative-art','particle-physics','3d-immersive','creative-tools','educational','experimental-ai'];
  const apps = ['space-shooter','fractal-gen','beat-maker','particle-storm','wave-sim','color-mixer','code-editor','quiz-master',
    'pixel-art','synth-pad','galaxy-sim','chess-engine','drum-machine','mandelbrot','fluid-sim','note-app','terrain-gen',
    'maze-runner','light-show','orbit-calc','dna-helix','plant-sim','weather-viz','kaleidoscope','rhythm-game'];
  const outcomes = ['success','success','success','success','success','partial','partial','fail'];
  const now = Date.now();
  const day = 86400000;
  const hr = 3600000;
  for(let i = 0; i < 28; i++){
    const type = AGENT_TYPES[i % AGENT_TYPES.length];
    const frameNum = Math.floor(i / 3) + 1;
    const startTime = now - (28 - i) * day + Math.random() * hr * 4;
    const duration = 60 + Math.floor(Math.random() * 600);
    const endTime = startTime + duration * 1000;
    const status = outcomes[Math.floor(Math.random() * outcomes.length)];
    const filesCreated = [];
    const filesModified = ['apps/manifest.json'];
    const filesDeleted = [];
    const molts = [];
    if(type === 'molter'){
      const numMolts = 1 + Math.floor(Math.random() * 4);
      for(let m = 0; m < numMolts; m++){
        const app = apps[Math.floor(Math.random() * apps.length)];
        const before = 20 + Math.floor(Math.random() * 45);
        const after = before + 5 + Math.floor(Math.random() * 25);
        molts.push({app: app + '.html', before, after, category: cats[Math.floor(Math.random() * cats.length)]});
        filesModified.push('apps/' + cats[Math.floor(Math.random() * cats.length)] + '/' + app + '.html');
      }
    } else if(type === 'factory'){
      const numCreated = 1 + Math.floor(Math.random() * 5);
      for(let c = 0; c < numCreated; c++){
        const name = 'gen-' + frameNum + '-' + String.fromCharCode(97+c) + '.html';
        filesCreated.push('apps/' + cats[Math.floor(Math.random() * cats.length)] + '/' + name);
      }
    } else if(type === 'ranker'){
      filesModified.push('apps/rankings.json');
    } else if(type === 'community'){
      filesModified.push('apps/community.json');
    } else if(type === 'broadcaster'){
      filesCreated.push('apps/broadcasts/audio/ep-' + String(frameNum).padStart(3,'0') + '.wav');
      filesModified.push('apps/broadcasts/feed.json');
    }
    const warnings = [];
    const errors = [];
    if(status === 'fail') errors.push('Agent crashed: process exited with code 1');
    if(status === 'partial') warnings.push('Some operations skipped due to timeout');
    if(Math.random() > .7) warnings.push('File lock contention on manifest.json');
    const logLines = [
      '[' + new Date(startTime).toISOString() + '] Starting ' + type + ' agent (frame ' + frameNum + ')',
      '[' + new Date(startTime + 2000).toISOString() + '] Loading ecosystem state...',
      '[' + new Date(startTime + 5000).toISOString() + '] Found ' + (400 + Math.floor(Math.random()*150)) + ' apps in manifest',
    ];
    if(type === 'molter') logLines.push('[...] Selecting lowest-scored apps for improvement...');
    if(type === 'factory') logLines.push('[...] Generating ' + filesCreated.length + ' new apps...');
    logLines.push('[' + new Date(endTime).toISOString() + '] Agent completed with status: ' + status);
    if(errors.length) logLines.push('[ERROR] ' + errors[0]);
    const run = {
      id: 'run-' + String(i+1).padStart(3,'0'),
      type, frame: frameNum, status, startTime, endTime, duration,
      description: type.charAt(0).toUpperCase() + type.slice(1) + ' agent frame ' + frameNum + ' - ' +
        (type==='molter'? 'Improved ' + molts.length + ' apps':
         type==='factory'? 'Created ' + filesCreated.length + ' new apps':
         type==='ranker'? 'Re-scored all apps':
         type==='community'? 'Generated fresh community data':
         type==='broadcaster'? 'Produced podcast episode ' + frameNum:
         'Bred new apps from top performers'),
      filesCreated, filesModified, filesDeleted, molts, warnings, errors, logOutput: logLines.join('\n')
    };
    runs.push(run);
    events.push({time: startTime, type: 'run_start', runId: run.id, agent: type, frame: frameNum});
    events.push({time: endTime, type: 'run_end', runId: run.id, agent: type, status});
    if(molts.length){
      molts.forEach(m => events.push({
        time: startTime + Math.random() * duration * 1000,
        type: 'molt', runId: run.id, app: m.app, before: m.before, after: m.after
      }));
    }
    filesCreated.forEach(f => events.push({
      time: startTime + Math.random() * duration * 500,
      type: 'file_create', runId: run.id, file: f
    }));
  }
  events.sort((a,b) => a.time - b.time);
  return {runs, events, external: {}};
}

function load(){
  try{
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved){
      state = JSON.parse(saved);
      if(!state.runs || state.runs.length === 0) state = generateDemoData();
    } else {
      state = generateDemoData();
    }
  } catch(e){ state = generateDemoData(); }
  if(!state.timelineZoom) state.timelineZoom = 1;
  if(!state.external) state.external = {};
}

function save(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){}
}

function toast(msg){
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function switchTab(name){
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
  document.getElementById('tab-' + name).classList.remove('hidden');
  if(name === 'dashboard') renderDashboard();
  if(name === 'timeline') renderTimeline();
  if(name === 'charts') renderAllCharts();
  if(name === 'data') renderDataTab();
}

function badgeHTML(status){
  const cls = status === 'success' ? 'badge-success' : status === 'fail' ? 'badge-fail' : 'badge-partial';
  return '<span class="badge ' + cls + '">' + status.toUpperCase() + '</span>';
}

function fmtTime(ts){
  const d = new Date(ts);
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' ' + d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
}

function fmtDuration(s){
  if(s < 60) return s + 's';
  if(s < 3600) return Math.floor(s/60) + 'm ' + (s%60) + 's';
  return Math.floor(s/3600) + 'h ' + Math.floor((s%3600)/60) + 'm';
}

function getFilteredRuns(){
  let runs = [...state.runs];
  const type = document.getElementById('filterType')?.value;
  const status = document.getElementById('filterStatus')?.value;
  const from = document.getElementById('filterFrom')?.value;
  const to = document.getElementById('filterTo')?.value;
  const search = document.getElementById('filterSearch')?.value?.toLowerCase();
  if(type) runs = runs.filter(r => r.type === type);
  if(status) runs = runs.filter(r => r.status === status);
  if(from) runs = runs.filter(r => r.startTime >= new Date(from).getTime());
  if(to) runs = runs.filter(r => r.startTime <= new Date(to).getTime() + 86400000);
  if(search) runs = runs.filter(r => r.description.toLowerCase().includes(search) || r.type.includes(search) || r.id.includes(search));
  return runs.sort((a,b) => b.startTime - a.startTime);
}

function renderDashboard(){
  const runs = state.runs;
  const successCount = runs.filter(r => r.status === 'success').length;
  const totalMolts = runs.reduce((s,r) => s + (r.molts?.length || 0), 0);
  const avgImprovement = runs.reduce((s,r) => {
    if(!r.molts?.length) return s;
    return s + r.molts.reduce((ms,m) => ms + (m.after - m.before), 0) / r.molts.length;
  }, 0) / Math.max(1, runs.filter(r => r.molts?.length).length);
  const totalCreated = runs.reduce((s,r) => s + (r.filesCreated?.length || 0), 0);
  const totalDuration = runs.reduce((s,r) => s + (r.duration || 0), 0);
  const firstRun = runs.length ? Math.min(...runs.map(r => r.startTime)) : Date.now();
  const uptimeDays = Math.max(1, Math.floor((Date.now() - firstRun) / 86400000));

  document.getElementById('statsGrid').innerHTML = [
    {value: runs.length, label: 'Total Runs'},
    {value: (runs.length ? Math.round(successCount/runs.length*100) : 0) + '%', label: 'Success Rate'},
    {value: totalMolts, label: 'Total Molts'},
    {value: '+' + avgImprovement.toFixed(1), label: 'Avg Improvement'},
    {value: totalCreated, label: 'Apps Created'},
    {value: fmtDuration(totalDuration), label: 'Total Runtime'},
    {value: uptimeDays + 'd', label: 'Uptime'},
    {value: state.events?.length || 0, label: 'Events Logged'}
  ].map(s => '<div class="stat-card"><div class="value">' + s.value + '</div><div class="label">' + s.label + '</div></div>').join('');

  renderRunsList();
  renderMostActive();
}

function renderRunsList(){
  const runs = getFilteredRuns();
  const html = runs.slice(0, 50).map(r => {
    const typeColor = TYPE_COLORS[r.type] || '#888';
    return '<div style="padding:10px;border-bottom:1px solid var(--border);cursor:pointer" onclick="showRunDetail(\'' + r.id + '\')">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">' +
      '<div><span style="color:' + typeColor + ';font-weight:bold">[' + r.type.toUpperCase() + ']</span> ' + r.description + '</div>' +
      '<div style="display:flex;gap:8px;align-items:center">' + badgeHTML(r.status) +
      '<span style="color:var(--dim);font-size:.75rem">' + fmtTime(r.startTime) + '</span></div></div>' +
      (selectedRunId === r.id ? renderRunDetailInline(r) : '') + '</div>';
  }).join('');
  document.getElementById('runsList').innerHTML = html || '<div style="color:var(--dim);padding:20px;text-align:center">No runs match filters</div>';
}

function showRunDetail(id){
  selectedRunId = selectedRunId === id ? null : id;
  renderRunsList();
}

function renderRunDetailInline(r){
  let html = '<div style="margin-top:10px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;animation:fadeIn .3s">';
  html += '<div class="detail-grid">';
  html += '<div class="detail-field"><div class="lbl">Run ID</div><div class="val">' + r.id + '</div></div>';
  html += '<div class="detail-field"><div class="lbl">Agent Type</div><div class="val" style="color:' + (TYPE_COLORS[r.type]||'#888') + '">' + r.type + '</div></div>';
  html += '<div class="detail-field"><div class="lbl">Frame</div><div class="val">#' + (r.frame||'?') + '</div></div>';
  html += '<div class="detail-field"><div class="lbl">Duration</div><div class="val">' + fmtDuration(r.duration) + '</div></div>';
  html += '<div class="detail-field"><div class="lbl">Start</div><div class="val">' + fmtTime(r.startTime) + '</div></div>';
  html += '<div class="detail-field"><div class="lbl">End</div><div class="val">' + fmtTime(r.endTime) + '</div></div>';
  html += '</div>';
  if(r.filesCreated?.length){
    html += '<div style="margin-top:8px"><div class="lbl" style="color:var(--dim);font-size:.65rem">FILES CREATED</div><ul class="file-list">' +
      r.filesCreated.map(f => '<li style="color:var(--green)">' + f + '</li>').join('') + '</ul></div>';
  }
  if(r.filesModified?.length){
    html += '<div style="margin-top:8px"><div class="lbl" style="color:var(--dim);font-size:.65rem">FILES MODIFIED</div><ul class="file-list">' +
      r.filesModified.map(f => '<li>' + f + '</li>').join('') + '</ul></div>';
  }
  if(r.filesDeleted?.length){
    html += '<div style="margin-top:8px"><div class="lbl" style="color:var(--dim);font-size:.65rem">FILES DELETED</div><ul class="file-list">' +
      r.filesDeleted.map(f => '<li style="color:var(--err)">' + f + '</li>').join('') + '</ul></div>';
  }
  if(r.molts?.length){
    html += '<div style="margin-top:8px"><div class="lbl" style="color:var(--dim);font-size:.65rem">MOLT RESULTS</div><table style="width:100%;font-size:.8rem;margin-top:4px">';
    html += '<tr style="color:var(--dim)"><td>App</td><td>Before</td><td>After</td><td>Œî</td></tr>';
    r.molts.forEach(m => {
      const delta = m.after - m.before;
      const dColor = delta > 0 ? 'var(--green)' : 'var(--err)';
      html += '<tr><td>' + m.app + '</td><td>' + m.before + '</td><td>' + m.after + '</td><td style="color:' + dColor + '">' + (delta > 0 ? '+' : '') + delta + '</td></tr>';
    });
    html += '</table></div>';
  }
  if(r.warnings?.length){
    html += '<div style="margin-top:8px"><div class="lbl" style="color:var(--warn);font-size:.65rem">‚ö† WARNINGS</div>';
    r.warnings.forEach(w => html += '<div style="font-size:.8rem;color:var(--warn)">' + w + '</div>');
    html += '</div>';
  }
  if(r.errors?.length){
    html += '<div style="margin-top:8px"><div class="lbl" style="color:var(--err);font-size:.65rem">‚úñ ERRORS</div>';
    r.errors.forEach(e => html += '<div style="font-size:.8rem;color:var(--err)">' + e + '</div>');
    html += '</div>';
  }
  if(r.logOutput){
    html += '<div style="margin-top:8px" id="logCollapse-' + r.id + '">';
    html += '<div class="collapsible-header collapsed" onclick="toggleLog(\'' + r.id + '\')"><span class="lbl" style="color:var(--dim);font-size:.65rem">LOG OUTPUT</span></div>';
    html += '<div class="log-output hidden" id="logBody-' + r.id + '">' + escapeHtml(r.logOutput) + '</div></div>';
  }
  html += '</div>';
  return html;
}

function toggleLog(id){
  const body = document.getElementById('logBody-' + id);
  const header = body?.previousElementSibling;
  if(body) body.classList.toggle('hidden');
  if(header) header.classList.toggle('collapsed');
}

function escapeHtml(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderMostActive(){
  const appCounts = {};
  const catCounts = {};
  state.runs.forEach(r => {
    (r.molts || []).forEach(m => {
      appCounts[m.app] = (appCounts[m.app] || 0) + 1;
      if(m.category) catCounts[m.category] = (catCounts[m.category] || 0) + 1;
    });
    (r.filesCreated || []).forEach(f => {
      const parts = f.split('/');
      if(parts.length >= 3) catCounts[parts[1]] = (catCounts[parts[1]] || 0) + 1;
    });
  });
  const topApps = Object.entries(appCounts).sort((a,b) => b[1] - a[1]).slice(0, 8);
  const topCats = Object.entries(catCounts).sort((a,b) => b[1] - a[1]).slice(0, 8);
  document.getElementById('mostMolted').innerHTML = topApps.map(([a,c]) => '<li>' + a + ' <span style="color:var(--accent)">(' + c + ')</span></li>').join('') || '<li style="color:var(--dim)">No data</li>';
  document.getElementById('mostActiveCategories').innerHTML = topCats.map(([a,c]) => '<li>' + a + ' <span style="color:var(--accent)">(' + c + ')</span></li>').join('') || '<li style="color:var(--dim)">No data</li>';
}

function applyFilters(){ renderRunsList(); }

/* ===== TIMELINE ===== */
function zoomTimeline(dir){
  state.timelineZoom = Math.max(0.5, Math.min(4, state.timelineZoom + dir * 0.5));
  renderTimeline();
}

function renderTimeline(){
  const filterType = document.getElementById('tlFilterType')?.value;
  let runs = [...state.runs];
  if(filterType) runs = runs.filter(r => r.type === filterType);
  if(!runs.length){ document.getElementById('timelineContainer').innerHTML = '<div style="color:var(--dim);text-align:center;padding:40px">No runs to display</div>'; return; }
  runs.sort((a,b) => a.startTime - b.startTime);
  const minT = runs[0].startTime;
  const maxT = Math.max(...runs.map(r => r.endTime));
  const range = maxT - minT || 1;
  const trackWidth = Math.max(800, 800 * state.timelineZoom);
  const rows = {};
  AGENT_TYPES.forEach(t => { if(!filterType || filterType === t) rows[t] = []; });
  runs.forEach(r => { if(rows[r.type]) rows[r.type].push(r); });
  let html = '<div style="display:flex;margin-bottom:6px;padding-left:100px">';
  const numMarkers = 6;
  for(let i = 0; i <= numMarkers; i++){
    const t = minT + (range * i / numMarkers);
    const pct = (i / numMarkers * 100).toFixed(1);
    html += '<span style="position:absolute;left:calc(100px + ' + pct + '% * (' + trackWidth + 'px - 100px) / 100);font-size:.6rem;color:var(--dim);transform:translateX(-50%)">' + fmtTime(t) + '</span>';
  }
  html += '</div>';
  Object.entries(rows).forEach(([type, typeRuns]) => {
    html += '<div class="timeline-row">';
    html += '<div class="timeline-label" style="color:' + (TYPE_COLORS[type]||'#888') + '">' + type.toUpperCase() + '</div>';
    html += '<div class="timeline-track" style="width:' + trackWidth + 'px">';
    typeRuns.forEach(r => {
      const left = ((r.startTime - minT) / range * 100).toFixed(2);
      const width = Math.max(1, ((r.endTime - r.startTime) / range * 100));
      html += '<div class="timeline-block ' + (TYPE_CLASS[r.type]||'') + (selectedRunId === r.id ? ' selected' : '') + '" ' +
        'style="left:' + left + '%;width:' + width.toFixed(2) + '%" ' +
        'onclick="selectTimelineRun(\'' + r.id + '\')" title="' + r.id + ': ' + r.description + '">' +
        r.id.replace('run-','') + '</div>';
    });
    html += '</div></div>';
  });
  document.getElementById('timelineContainer').innerHTML = html;
}

function selectTimelineRun(id){
  selectedRunId = selectedRunId === id ? null : id;
  renderTimeline();
  const run = state.runs.find(r => r.id === id);
  const detailEl = document.getElementById('timelineDetail');
  if(run && selectedRunId){
    detailEl.innerHTML = renderRunDetailInline(run);
    detailEl.classList.add('open');
  } else {
    detailEl.classList.remove('open');
  }
}

/* ===== CHARTS ===== */
function renderAllCharts(){
  renderLineChart();
  renderBarChart();
  renderPieChart();
  renderScatterChart();
}

function setupCanvas(id){
  const canvas = document.getElementById(id);
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  return {ctx, w: rect.width, h: rect.height};
}

function drawChartBg(ctx, w, h, title){
  ctx.fillStyle = '#0a0e0a';
  ctx.fillRect(0, 0, w, h);
  for(let x = 0; x < w; x += 40){
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h);
    ctx.strokeStyle = 'rgba(0,255,65,0.04)'; ctx.stroke();
  }
  for(let y = 0; y < h; y += 40){
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y);
    ctx.strokeStyle = 'rgba(0,255,65,0.04)'; ctx.stroke();
  }
}

function renderLineChart(){
  const {ctx, w, h} = setupCanvas('chartLine');
  drawChartBg(ctx, w, h);
  const pad = {t:30, r:20, b:50, l:50};
  const cw = w - pad.l - pad.r;
  const ch = h - pad.t - pad.b;
  const molts = [];
  state.runs.forEach(r => (r.molts||[]).forEach(m => molts.push({time:r.startTime, score:m.after})));
  if(!molts.length){
    ctx.fillStyle = '#406040'; ctx.font = '14px monospace';
    ctx.fillText('No molt data available', w/2 - 80, h/2); return;
  }
  molts.sort((a,b) => a.time - b.time);
  const minT = molts[0].time;
  const maxT = molts[molts.length-1].time;
  const minS = 0;
  const maxS = 100;
  ctx.strokeStyle = '#1a3a1a'; ctx.lineWidth = 1;
  for(let i = 0; i <= 5; i++){
    const y = pad.t + ch - (i/5)*ch;
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+cw, y); ctx.stroke();
    ctx.fillStyle = '#406040'; ctx.font = '10px monospace';
    ctx.fillText(String(Math.round(minS + (maxS-minS)*i/5)), pad.l - 30, y + 4);
  }
  ctx.beginPath();
  ctx.strokeStyle = '#00ff41'; ctx.lineWidth = 2;
  ctx.shadowColor = '#00ff41'; ctx.shadowBlur = 6;
  molts.forEach((m, i) => {
    const x = pad.l + ((maxT === minT ? 0.5 : (m.time - minT)/(maxT - minT))) * cw;
    const y = pad.t + ch - ((m.score - minS)/(maxS - minS)) * ch;
    if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();
  ctx.shadowBlur = 0;
  molts.forEach(m => {
    const x = pad.l + ((maxT === minT ? 0.5 : (m.time - minT)/(maxT - minT))) * cw;
    const y = pad.t + ch - ((m.score - minS)/(maxS - minS)) * ch;
    ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2);
    ctx.fillStyle = '#00ff41'; ctx.fill();
  });
  ctx.fillStyle = '#406040'; ctx.font = '10px monospace'; ctx.textAlign = 'center';
  for(let i = 0; i <= 4; i++){
    const t = minT + (maxT - minT) * i / 4;
    const x = pad.l + (i/4) * cw;
    ctx.fillText(new Date(t).toLocaleDateString('en-US',{month:'short',day:'numeric'}), x, h - pad.b + 18);
  }
  ctx.textAlign = 'left';
  ctx.fillStyle = '#00ff41'; ctx.font = '12px monospace';
  ctx.fillText('Quality Scores Over Time', pad.l, 18);
}

function renderBarChart(){
  const {ctx, w, h} = setupCanvas('chartBar');
  drawChartBg(ctx, w, h);
  const pad = {t:30, r:20, b:50, l:50};
  const cw = w - pad.l - pad.r;
  const ch = h - pad.t - pad.b;
  const frameCounts = {};
  state.runs.forEach(r => {
    const f = r.frame || 0;
    frameCounts[f] = (frameCounts[f] || 0) + (r.filesCreated?.length || 0);
  });
  const frames = Object.keys(frameCounts).sort((a,b) => +a - +b);
  if(!frames.length){
    ctx.fillStyle = '#406040'; ctx.font = '14px monospace';
    ctx.fillText('No frame data available', w/2 - 90, h/2); return;
  }
  const maxVal = Math.max(1, ...Object.values(frameCounts));
  const barW = Math.min(40, cw / frames.length - 4);
  const gap = (cw - barW * frames.length) / (frames.length + 1);
  ctx.strokeStyle = '#1a3a1a'; ctx.lineWidth = 1;
  for(let i = 0; i <= 4; i++){
    const y = pad.t + ch - (i/4)*ch;
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+cw, y); ctx.stroke();
    ctx.fillStyle = '#406040'; ctx.font = '10px monospace';
    ctx.fillText(String(Math.round(maxVal*i/4)), pad.l - 25, y + 4);
  }
  frames.forEach((f, i) => {
    const x = pad.l + gap + i * (barW + gap);
    const barH = (frameCounts[f] / maxVal) * ch;
    const y = pad.t + ch - barH;
    const grad = ctx.createLinearGradient(x, y, x, pad.t + ch);
    grad.addColorStop(0, '#00ff41'); grad.addColorStop(1, '#004410');
    ctx.fillStyle = grad;
    ctx.shadowColor = '#00ff41'; ctx.shadowBlur = 4;
    ctx.fillRect(x, y, barW, barH);
    ctx.shadowBlur = 0;
    ctx.fillStyle = '#406040'; ctx.font = '10px monospace'; ctx.textAlign = 'center';
    ctx.fillText('F' + f, x + barW/2, h - pad.b + 16);
    if(frameCounts[f] > 0){
      ctx.fillStyle = '#00ff41'; ctx.fillText(String(frameCounts[f]), x + barW/2, y - 6);
    }
  });
  ctx.textAlign = 'left';
  ctx.fillStyle = '#41a0ff'; ctx.font = '12px monospace';
  ctx.fillText('Apps Created Per Frame', pad.l, 18);
}

function renderPieChart(){
  const {ctx, w, h} = setupCanvas('chartPie');
  drawChartBg(ctx, w, h);
  const typeCounts = {};
  state.runs.forEach(r => typeCounts[r.type] = (typeCounts[r.type]||0) + 1);
  const entries = Object.entries(typeCounts);
  if(!entries.length){
    ctx.fillStyle = '#406040'; ctx.font = '14px monospace';
    ctx.fillText('No data', w/2 - 30, h/2); return;
  }
  const total = entries.reduce((s,[,c]) => s + c, 0);
  const cx = w * 0.4;
  const cy = h / 2;
  const radius = Math.min(cx - 30, cy - 40);
  let startAngle = -Math.PI / 2;
  entries.forEach(([type, count]) => {
    const sliceAngle = (count / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radius, startAngle, startAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = TYPE_COLORS[type] || '#888';
    ctx.globalAlpha = 0.7;
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.strokeStyle = '#0a0e0a'; ctx.lineWidth = 2; ctx.stroke();
    const midAngle = startAngle + sliceAngle / 2;
    const labelR = radius * 0.65;
    const lx = cx + Math.cos(midAngle) * labelR;
    const ly = cy + Math.sin(midAngle) * labelR;
    const pct = Math.round(count/total*100);
    if(pct > 5){
      ctx.fillStyle = '#000'; ctx.font = 'bold 11px monospace'; ctx.textAlign = 'center';
      ctx.fillText(pct + '%', lx, ly + 4);
    }
    startAngle += sliceAngle;
  });
  ctx.textAlign = 'left';
  let ly = 30;
  entries.forEach(([type, count]) => {
    const lx = w * 0.72;
    ctx.fillStyle = TYPE_COLORS[type] || '#888';
    ctx.fillRect(lx, ly - 8, 12, 12);
    ctx.fillStyle = '#b0ffb0'; ctx.font = '11px monospace';
    ctx.fillText(type + ' (' + count + ')', lx + 18, ly + 2);
    ly += 22;
  });
  ctx.fillStyle = '#a041ff'; ctx.font = '12px monospace';
  ctx.fillText('Agent Type Distribution', 20, 18);
}

function renderScatterChart(){
  const {ctx, w, h} = setupCanvas('chartScatter');
  drawChartBg(ctx, w, h);
  const pad = {t:30, r:20, b:50, l:50};
  const cw = w - pad.l - pad.r;
  const ch = h - pad.t - pad.b;
  const points = [];
  state.runs.forEach(r => (r.molts||[]).forEach(m => points.push({before:m.before, after:m.after, app:m.app})));
  if(!points.length){
    ctx.fillStyle = '#406040'; ctx.font = '14px monospace';
    ctx.fillText('No molt data available', w/2 - 80, h/2); return;
  }
  ctx.strokeStyle = '#1a3a1a'; ctx.lineWidth = 1;
  for(let i = 0; i <= 5; i++){
    const v = i * 20;
    const x = pad.l + (v/100)*cw;
    const y = pad.t + ch - (v/100)*ch;
    ctx.beginPath(); ctx.moveTo(x, pad.t); ctx.lineTo(x, pad.t+ch); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+cw, y); ctx.stroke();
    ctx.fillStyle = '#406040'; ctx.font = '10px monospace';
    ctx.fillText(String(v), pad.l - 25, y + 4);
    ctx.fillText(String(v), x - 5, h - pad.b + 16);
  }
  ctx.beginPath();
  ctx.moveTo(pad.l, pad.t + ch); ctx.lineTo(pad.l + cw, pad.t);
  ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.setLineDash([4,4]); ctx.stroke(); ctx.setLineDash([]);
  points.forEach(p => {
    const x = pad.l + (p.before / 100) * cw;
    const y = pad.t + ch - (p.after / 100) * ch;
    ctx.beginPath(); ctx.arc(x, y, 5, 0, Math.PI*2);
    const improved = p.after > p.before;
    ctx.fillStyle = improved ? 'rgba(0,255,65,0.6)' : 'rgba(255,65,65,0.6)';
    ctx.shadowColor = improved ? '#00ff41' : '#ff4141'; ctx.shadowBlur = 6;
    ctx.fill(); ctx.shadowBlur = 0;
  });
  ctx.fillStyle = '#406040'; ctx.font = '10px monospace'; ctx.textAlign = 'center';
  ctx.fillText('Before Score ‚Üí', pad.l + cw/2, h - 8);
  ctx.save(); ctx.translate(12, pad.t + ch/2); ctx.rotate(-Math.PI/2);
  ctx.fillText('After Score ‚Üí', 0, 0); ctx.restore();
  ctx.textAlign = 'left';
  ctx.fillStyle = '#ff8c00'; ctx.font = '12px monospace';
  ctx.fillText('Molt Improvement (Before vs After)', pad.l, 18);
}

/* ===== LOG FORM ===== */
function saveLogEntry(e){
  e.preventDefault();
  const now = Date.now();
  const duration = parseInt(document.getElementById('logDuration').value) || 120;
  const parseList = v => v ? v.split(',').map(s=>s.trim()).filter(Boolean) : [];
  const parseMolts = v => {
    if(!v) return [];
    return v.split('\n').map(line => {
      const parts = line.trim().split(/\s+/);
      if(parts.length >= 3) return {app:parts[0], before:+parts[1], after:+parts[2], category:'unknown'};
      return null;
    }).filter(Boolean);
  };
  const parseErrors = v => v ? v.split('\n').map(s=>s.trim()).filter(Boolean) : [];
  const run = {
    id: 'run-m-' + Date.now().toString(36),
    type: document.getElementById('logType').value,
    frame: state.runs.length ? Math.max(...state.runs.map(r=>r.frame||0)) + 1 : 1,
    status: document.getElementById('logStatus').value,
    startTime: now - duration * 1000,
    endTime: now,
    duration,
    description: document.getElementById('logDesc').value,
    filesCreated: parseList(document.getElementById('logCreated').value),
    filesModified: parseList(document.getElementById('logModified').value),
    filesDeleted: parseList(document.getElementById('logDeleted').value),
    molts: parseMolts(document.getElementById('logMolts').value),
    warnings: [],
    errors: parseErrors(document.getElementById('logErrors').value),
    logOutput: document.getElementById('logOutput').value || ''
  };
  state.runs.push(run);
  state.events.push({time:run.startTime, type:'run_start', runId:run.id, agent:run.type, frame:run.frame});
  state.events.push({time:run.endTime, type:'run_end', runId:run.id, agent:run.type, status:run.status});
  run.molts.forEach(m => state.events.push({time:now - Math.random()*duration*1000, type:'molt', runId:run.id, app:m.app, before:m.before, after:m.after}));
  save();
  toast('Run logged: ' + run.id);
  document.getElementById('logForm').reset();
}

/* ===== DATA TAB ===== */
function renderDataTab(){
  const runsCount = state.runs?.length || 0;
  const eventsCount = state.events?.length || 0;
  const extKeys = Object.keys(state.external || {});
  let html = '<div style="font-size:.85rem">';
  html += '<div style="margin-bottom:8px">üìÅ <strong>' + runsCount + '</strong> agent runs stored</div>';
  html += '<div style="margin-bottom:8px">üìã <strong>' + eventsCount + '</strong> events logged</div>';
  html += '<div style="margin-bottom:8px">üíæ <strong>' + (JSON.stringify(state).length / 1024).toFixed(1) + ' KB</strong> total localStorage usage</div>';
  if(extKeys.length){
    html += '<div style="margin-top:8px;color:var(--accent)">External data loaded:</div>';
    extKeys.forEach(k => {
      const size = JSON.stringify(state.external[k]).length;
      html += '<div style="margin-left:12px">‚Ä¢ ' + k + ' (' + (size/1024).toFixed(1) + ' KB)</div>';
    });
  } else {
    html += '<div style="margin-top:8px;color:var(--dim)">No external data imported yet</div>';
  }
  html += '</div>';
  document.getElementById('dataSummary').innerHTML = html;
  showRawData();
}

function showRawData(){
  const sel = document.getElementById('rawDataSelect').value;
  let data;
  if(sel === 'runs') data = state.runs;
  else if(sel === 'events') data = state.events?.slice(-100);
  else data = state.external;
  document.getElementById('rawDataView').textContent = JSON.stringify(data, null, 2);
}

function importExternalData(event, key){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const data = JSON.parse(e.target.result);
      state.external[key] = data;
      if(key === 'molter-state' && data.history){
        data.history.forEach((h, i) => {
          if(!state.runs.find(r => r.id === 'ext-molter-' + i)){
            state.runs.push({
              id: 'ext-molter-' + i,
              type: 'molter',
              frame: h.frame || i + 1,
              status: h.status || 'success',
              startTime: h.timestamp ? new Date(h.timestamp).getTime() : Date.now() - (data.history.length - i) * 86400000,
              endTime: (h.timestamp ? new Date(h.timestamp).getTime() : Date.now() - (data.history.length - i) * 86400000) + 300000,
              duration: 300,
              description: 'Imported from molter-state: frame ' + (h.frame || i+1),
              filesCreated: h.created || [],
              filesModified: h.modified || [],
              filesDeleted: [],
              molts: h.molts || [],
              warnings: [], errors: [],
              logOutput: 'Imported from molter-state.json'
            });
          }
        });
      }
      if(key === 'rankings' && data.rankings){
        const entries = Array.isArray(data.rankings) ? data.rankings :
          Object.entries(data.rankings).flatMap(([cat, apps]) =>
            (Array.isArray(apps) ? apps : []).map(a => ({...a, category: cat}))
          );
        entries.forEach(app => {
          if(app.scores){
            state.events.push({
              time: Date.now(),
              type: 'ranking',
              app: app.file || app.name,
              scores: app.scores,
              total: app.total || Object.values(app.scores).reduce((s,v)=>s+v,0)
            });
          }
        });
      }
      save();
      toast('Imported ' + key + ' (' + (file.size/1024).toFixed(1) + ' KB)');
      renderDataTab();
    } catch(err){
      toast('Error parsing ' + file.name + ': ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

/* ===== IMPORT / EXPORT ===== */
function exportAllData(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'agent-mission-control-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  toast('Data exported');
}

function importAllData(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const data = JSON.parse(e.target.result);
      if(data.runs && Array.isArray(data.runs)){
        state = data;
        if(!state.timelineZoom) state.timelineZoom = 1;
        if(!state.external) state.external = {};
        save();
        toast('Imported ' + state.runs.length + ' runs');
        switchTab('dashboard');
      } else {
        toast('Invalid data format: expected {runs:[...]}');
      }
    } catch(err){
      toast('Import error: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function resetData(){
  if(!confirm('Reset all data to demo? This cannot be undone.')) return;
  state = generateDemoData();
  save();
  selectedRunId = null;
  switchTab('dashboard');
  toast('Data reset to demo');
}

/* ===== INIT ===== */
load();
switchTab('dashboard');

window.addEventListener('resize', function(){
  const activeTab = document.querySelector('.tab.active')?.dataset?.tab;
  if(activeTab === 'charts') renderAllCharts();
});
</script>
</body>
</html>
