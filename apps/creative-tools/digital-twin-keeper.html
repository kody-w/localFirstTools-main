<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Digital Twin">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <title>Digital Twin Keeper - Your Personal AI Knowledge Base</title>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%236366f1'/%3E%3Cstop offset='100%25' style='stop-color:%23a855f7'/%3E%3C/linearGradient%3E%3Crect width='180' height='180' fill='url(%23g)' rx='40'/%3E%3Cpath d='M90 50 C70 50 50 70 50 90 C50 110 70 130 90 130 C110 130 130 110 130 90 C130 70 110 50 90 50 M90 70 C100 70 110 80 110 90 C110 100 100 110 90 110 C80 110 70 100 70 90 C70 80 80 70 90 70' fill='white' opacity='0.9'/%3E%3Ccircle cx='90' cy='90' r='15' fill='white'/%3E%3C/svg%3E">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-quaternary: #0f3460;
            --text-primary: #ffffff;
            --text-secondary: #a8b2d1;
            --text-tertiary: #64748b;
            --accent-primary: #6366f1;
            --accent-secondary: #a855f7;
            --accent-tertiary: #3b82f6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --border: #2d3748;
            --shadow: rgba(0, 0, 0, 0.5);
            --gradient-1: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            --gradient-2: linear-gradient(135deg, #667eea, #764ba2);
            --gradient-3: linear-gradient(135deg, #f093fb, #f5576c);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Header */
        .header {
            background-color: var(--bg-secondary);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background-color: rgba(26, 26, 46, 0.9);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-tab {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            font-weight: 500;
        }

        .nav-tab:hover {
            background-color: var(--bg-tertiary);
            border-color: var(--border);
        }

        .nav-tab.active {
            background: var(--gradient-1);
            color: white;
            border-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: calc(100vh - 70px);
            max-width: 1600px;
            margin: 0 auto;
        }

        .sidebar {
            width: 320px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .right-panel {
            width: 350px;
            background-color: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Search Box */
        .search-box {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: var(--bg-quaternary);
            border-color: var(--accent-primary);
        }

        .btn-success {
            background-color: var(--accent-success);
            color: white;
        }

        .btn-danger {
            background-color: var(--accent-danger);
            color: white;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 6px;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        /* Cards */
        .card {
            background-color: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-subtitle {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95em;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background-color: var(--bg-quaternary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: 600;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px var(--shadow);
            z-index: 1001;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
            border: 1px solid var(--border);
        }

        .notification.success {
            border-color: var(--accent-success);
            background-color: rgba(16, 185, 129, 0.1);
        }

        .notification.error {
            border-color: var(--accent-danger);
            background-color: rgba(239, 68, 68, 0.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Note List Items */
        .note-item {
            padding: 15px;
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            margin-bottom: 10px;
        }

        .note-item:hover {
            background-color: var(--bg-quaternary);
            transform: translateX(5px);
            border-color: var(--accent-primary);
        }

        .note-item.active {
            background: var(--gradient-1);
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .note-item.active .note-item-title,
        .note-item.active .note-item-preview,
        .note-item.active .note-item-meta {
            color: white;
        }

        .note-item-title {
            font-weight: 600;
            font-size: 0.95em;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .note-item-preview {
            font-size: 0.85em;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 5px;
        }

        .note-item-meta {
            font-size: 0.75em;
            color: var(--text-tertiary);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Tags */
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-height: 45px;
            align-items: center;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background-color: rgba(99, 102, 241, 0.2);
            color: var(--accent-primary);
            border-radius: 6px;
            font-size: 0.85em;
        }

        .tag-remove {
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .tag-input {
            flex: 1;
            border: none;
            background: none;
            color: var(--text-primary);
            font-size: 0.9em;
            min-width: 100px;
            outline: none;
        }

        /* Profile Section */
        .profile-section {
            background-color: var(--bg-tertiary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: var(--gradient-1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .profile-info h2 {
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        .profile-info p {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background-color: var(--bg-quaternary);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Digital Twin Components */
        .trait-item {
            background-color: var(--bg-quaternary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .trait-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }

        .trait-category {
            font-size: 0.8em;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 5px;
        }

        .trait-value {
            font-size: 1em;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .trait-description {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gradient-1);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding-left: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 5px;
            width: 12px;
            height: 12px;
            background: var(--accent-primary);
            border-radius: 50%;
            box-shadow: 0 0 0 3px var(--bg-secondary);
        }

        .timeline-date {
            font-size: 0.85em;
            color: var(--accent-primary);
            margin-bottom: 5px;
        }

        .timeline-content {
            background-color: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        /* Persona Cards */
        .persona-card {
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }

        .persona-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .persona-card.active {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
        }

        .persona-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .persona-description {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        /* Knowledge Graph Visualization */
        .knowledge-graph {
            background-color: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            height: 400px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .graph-node {
            position: absolute;
            width: 60px;
            height: 60px;
            background: var(--gradient-1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px var(--shadow);
            cursor: pointer;
            transition: all 0.3s;
        }

        .graph-node:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Export Options */
        .export-options {
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .export-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
        }

        /* Memory Entry */
        .memory-entry {
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .memory-entry:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .memory-type {
            display: inline-block;
            padding: 4px 8px;
            background-color: rgba(99, 102, 241, 0.2);
            color: var(--accent-primary);
            border-radius: 4px;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .memory-content {
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .memory-meta {
            font-size: 0.85em;
            color: var(--text-secondary);
            display: flex;
            gap: 15px;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 300px;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            
            .right-panel {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-nav {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .content-area {
                padding: 20px;
            }
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            max-width: 70%;
            padding: 15px;
            border-radius: 10px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .chat-message.user {
            align-self: flex-end;
            background: var(--gradient-1);
            color: white;
            border: none;
        }

        .chat-message.assistant {
            align-self: flex-start;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95em;
            resize: none;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-1);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3em;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 0.95em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üß¨</div>
                <h1>Digital Twin Keeper</h1>
            </div>
            
            <nav class="header-nav">
                <button class="nav-tab active" onclick="switchTab('notes')">üìù Notes</button>
                <button class="nav-tab" onclick="switchTab('profile')">üë§ Profile</button>
                <button class="nav-tab" onclick="switchTab('memories')">üß† Memories</button>
                <button class="nav-tab" onclick="switchTab('traits')">‚ú® Traits</button>
                <button class="nav-tab" onclick="switchTab('knowledge')">üîó Knowledge</button>
                <button class="nav-tab" onclick="switchTab('chat')">üí¨ Chat</button>
            </nav>
            
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="showImportModal()">
                    <span>üì•</span> Import
                </button>
                <button class="btn btn-primary" onclick="showExportModal()">
                    <span>üì§</span> Export AI
                </button>
                <button class="btn btn-secondary btn-icon" onclick="showSettingsModal()">
                    <span>‚öôÔ∏è</span>
                </button>
            </div>
        </div>
    </header>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <input type="text" class="search-box" id="searchBox" placeholder="Search everything...">
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary btn-block" id="newItemBtn" onclick="createNewItem()">
                        <span>‚ûï</span> New Note
                    </button>
                </div>
            </div>
            
            <div class="sidebar-content" id="sidebarContent">
                <!-- Dynamic content loaded here -->
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="content-area">
                <!-- Notes Tab -->
                <div id="notes-tab" class="tab-content active">
                    <div class="note-editor">
                        <input type="text" class="form-input" id="noteTitle" placeholder="Note Title..." style="font-size: 1.5em; font-weight: 600; margin-bottom: 20px;">
                        
                        <div class="form-group">
                            <textarea class="form-textarea" id="noteContent" placeholder="Start writing..." style="min-height: 400px; font-size: 1em; line-height: 1.8;"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tags</label>
                            <div class="tag-container" id="noteTagsContainer">
                                <input type="text" class="tag-input" id="noteTagInput" placeholder="Add tags...">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Link to Memory</label>
                            <select class="form-select" id="linkedMemory">
                                <option value="">No linked memory</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="saveCurrentNote()">
                                <span>üíæ</span> Save Note
                            </button>
                            <button class="btn btn-secondary" onclick="duplicateNote()">
                                <span>üìã</span> Duplicate
                            </button>
                            <button class="btn btn-danger" onclick="deleteCurrentNote()">
                                <span>üóëÔ∏è</span> Delete
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div id="profile-tab" class="tab-content">
                    <div class="profile-section">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profileAvatar">JD</div>
                            <div class="profile-info">
                                <h2 id="profileName">John Doe</h2>
                                <p id="profileBio">Digital twin profile</p>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="totalNotes">0</div>
                                <div class="stat-label">Notes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalMemories">0</div>
                                <div class="stat-label">Memories</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalTraits">0</div>
                                <div class="stat-label">Traits</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalWords">0</div>
                                <div class="stat-label">Words</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Edit Profile</h3>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-input" id="editProfileName" placeholder="Your name">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Bio</label>
                            <textarea class="form-textarea" id="editProfileBio" placeholder="Tell us about yourself..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Core Values</label>
                            <textarea class="form-textarea" id="editProfileValues" placeholder="What are your core values?"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Goals & Aspirations</label>
                            <textarea class="form-textarea" id="editProfileGoals" placeholder="What are your goals?"></textarea>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveProfile()">
                            <span>üíæ</span> Save Profile
                        </button>
                    </div>
                </div>

                <!-- Memories Tab -->
                <div id="memories-tab" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">Memory Bank</h2>
                        <button class="btn btn-primary" onclick="showAddMemoryModal()">
                            <span>‚ûï</span> Add Memory
                        </button>
                    </div>
                    
                    <div id="memoriesList">
                        <!-- Memories loaded here -->
                    </div>
                </div>

                <!-- Traits Tab -->
                <div id="traits-tab" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">Personality Traits</h2>
                        <button class="btn btn-primary" onclick="showAddTraitModal()">
                            <span>‚ûï</span> Add Trait
                        </button>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Trait Categories</h3>
                        <div id="traitsList">
                            <!-- Traits loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Knowledge Tab -->
                <div id="knowledge-tab" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">Knowledge Graph</h2>
                    </div>
                    
                    <div class="knowledge-graph" id="knowledgeGraph">
                        <div class="empty-state">
                            <div class="empty-state-icon">üîó</div>
                            <h3>Knowledge Graph Visualization</h3>
                            <p>Your connected knowledge will appear here</p>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3 class="card-title">Knowledge Stats</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="knowledgeNodes">0</div>
                                <div class="stat-label">Nodes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="knowledgeConnections">0</div>
                                <div class="stat-label">Connections</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Tab -->
                <div id="chat-tab" class="tab-content">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="empty-state">
                                <div class="empty-state-icon">üí¨</div>
                                <h3>Digital Twin Chat</h3>
                                <p>Start a conversation with your digital twin</p>
                            </div>
                        </div>
                        
                        <div class="chat-input-container">
                            <textarea class="chat-input" id="chatInput" placeholder="Ask your digital twin..." rows="2"></textarea>
                            <button class="btn btn-primary" onclick="sendChatMessage()">
                                <span>üì§</span> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="right-panel">
            <div style="padding: 20px;">
                <h3 class="section-title">Writing Personas</h3>
                <button class="btn btn-secondary btn-block" onclick="showPersonaModal()" style="margin: 15px 0;">
                    <span>‚ûï</span> Add Persona
                </button>
                <div id="personasList">
                    <!-- Personas loaded here -->
                </div>
            </div>
            
            <div style="padding: 20px; border-top: 1px solid var(--border);">
                <h3 class="section-title">Recent Activity</h3>
                <div class="timeline" id="recentActivity">
                    <!-- Activity loaded here -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Export for AI</h2>
                <button class="close-modal" onclick="closeModal('exportModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Export Type</label>
                <select class="form-select" id="exportType" onchange="updateExportOptions()">
                    <option value="notes">Notes Only</option>
                    <option value="profile">Complete Profile</option>
                    <option value="memories">Memories & Experiences</option>
                    <option value="traits">Personality Traits</option>
                    <option value="full">Full Digital Twin</option>
                    <option value="custom">Custom Selection</option>
                </select>
            </div>
            
            <div id="customExportOptions" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Select Data to Export</label>
                    <div class="export-options">
                        <div class="export-option">
                            <input type="checkbox" id="exportNotes" checked>
                            <label for="exportNotes">Notes</label>
                        </div>
                        <div class="export-option">
                            <input type="checkbox" id="exportProfile" checked>
                            <label for="exportProfile">Profile Information</label>
                        </div>
                        <div class="export-option">
                            <input type="checkbox" id="exportMemories" checked>
                            <label for="exportMemories">Memories</label>
                        </div>
                        <div class="export-option">
                            <input type="checkbox" id="exportTraits" checked>
                            <label for="exportTraits">Personality Traits</label>
                        </div>
                        <div class="export-option">
                            <input type="checkbox" id="exportPersonas" checked>
                            <label for="exportPersonas">Writing Personas</label>
                        </div>
                        <div class="export-option">
                            <input type="checkbox" id="exportKnowledge" checked>
                            <label for="exportKnowledge">Knowledge Graph</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select Persona (Optional)</label>
                <select class="form-select" id="exportPersona">
                    <option value="">No persona</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">AI Instructions</label>
                <textarea class="form-textarea" id="aiInstructions" placeholder="Instructions for the AI..." rows="4">You are interacting with a digital twin. Use the provided information to understand the person's personality, experiences, knowledge, and writing style. Generate responses that authentically represent this individual based on their traits, memories, and notes.</textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Export Format</label>
                <select class="form-select" id="exportFormat">
                    <option value="json">JSON (Structured)</option>
                    <option value="markdown">Markdown (Human Readable)</option>
                    <option value="jsonl">JSONL (For Training)</option>
                </select>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="exportData()">
                <span>üì§</span> Export Data
            </button>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Import Data</h2>
                <button class="close-modal" onclick="closeModal('importModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Import Type</label>
                <select class="form-select" id="importType">
                    <option value="notes">Import Notes</option>
                    <option value="memories">Import Memories</option>
                    <option value="traits">Import Traits</option>
                    <option value="blog">Import Blog Post with Links</option>
                    <option value="full">Full Data Import</option>
                    <option value="merge">Merge with Existing Data</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select File</label>
                <input type="file" accept=".json,.jsonl,.md" id="importFile" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">Or Paste Data</label>
                <textarea class="form-textarea" id="importJson" placeholder="Paste JSON data here..." rows="8" style="font-family: monospace;"></textarea>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="importData()">
                <span>üì•</span> Import Data
            </button>
        </div>
    </div>

    <!-- Add Memory Modal -->
    <div id="addMemoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Memory</h2>
                <button class="close-modal" onclick="closeModal('addMemoryModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Memory Type</label>
                <select class="form-select" id="memoryType">
                    <option value="experience">Experience</option>
                    <option value="achievement">Achievement</option>
                    <option value="learning">Learning</option>
                    <option value="relationship">Relationship</option>
                    <option value="challenge">Challenge</option>
                    <option value="insight">Insight</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="form-input" id="memoryTitle" placeholder="Memory title...">
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="memoryDescription" placeholder="Describe this memory..." rows="4"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="memoryDate">
            </div>
            
            <div class="form-group">
                <label class="form-label">Emotional Impact</label>
                <select class="form-select" id="memoryImpact">
                    <option value="positive">Positive</option>
                    <option value="neutral">Neutral</option>
                    <option value="negative">Negative</option>
                    <option value="mixed">Mixed</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Tags</label>
                <div class="tag-container" id="memoryTagsContainer">
                    <input type="text" class="tag-input" id="memoryTagInput" placeholder="Add tags...">
                </div>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="saveMemory()">
                <span>üíæ</span> Save Memory
            </button>
        </div>
    </div>

    <!-- Add Trait Modal -->
    <div id="addTraitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Personality Trait</h2>
                <button class="close-modal" onclick="closeModal('addTraitModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Trait Category</label>
                <select class="form-select" id="traitCategory">
                    <option value="personality">Personality</option>
                    <option value="values">Values</option>
                    <option value="skills">Skills</option>
                    <option value="interests">Interests</option>
                    <option value="habits">Habits</option>
                    <option value="preferences">Preferences</option>
                    <option value="communication">Communication Style</option>
                    <option value="thinking">Thinking Patterns</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Trait Name</label>
                <input type="text" class="form-input" id="traitName" placeholder="e.g., Analytical, Creative, Empathetic...">
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="traitDescription" placeholder="Describe how this trait manifests..." rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Strength (1-10)</label>
                <input type="range" class="form-input" id="traitStrength" min="1" max="10" value="5">
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span style="font-size: 0.85em; color: var(--text-secondary);">Weak</span>
                    <span id="traitStrengthValue" style="font-weight: bold;">5</span>
                    <span style="font-size: 0.85em; color: var(--text-secondary);">Strong</span>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Examples</label>
                <textarea class="form-textarea" id="traitExamples" placeholder="Provide examples of this trait in action..." rows="3"></textarea>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="saveTrait()">
                <span>üíæ</span> Save Trait
            </button>
        </div>
    </div>

    <!-- Persona Modal -->
    <div id="personaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Writing Persona</h2>
                <button class="close-modal" onclick="closeModal('personaModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Persona Name</label>
                <input type="text" class="form-input" id="personaName" placeholder="e.g., Professional Tech Writer">
            </div>
            
            <div class="form-group">
                <label class="form-label">Writing Style</label>
                <textarea =class="form-textarea" id="personaStyle" placeholder="Describe the writing style... e.g., Clear, concise, technical but accessible. Uses analogies to explain complex concepts."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Voice & Tone</label>
                <textarea class="form-textarea" id="personaVoice" placeholder="Describe voice characteristics... e.g., Authoritative but friendly, uses 'we' to include reader, avoids jargon."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Background & Expertise</label>
                <textarea class="form-textarea" id="personaBackground" placeholder="Background that influences writing... e.g., 10 years in software development, focus on user experience."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Typical Topics</label>
                <input type="text" class="form-input" id="personaTopics" placeholder="e.g., Technology, AI, Software Development, UX Design">
            </div>
            
            <div class="form-group">
                <label class="form-label">Example Phrases</label>
                <textarea class="form-textarea" id="personaPhrases" placeholder="Characteristic phrases or expressions... e.g., 'Let's dive in', 'The key takeaway here is'"></textarea>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="savePersona()">
                <span>üíæ</span> Save Persona
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-modal" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="autoSave" checked> Auto-save changes
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="showWordCount" checked> Show word count
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="enableEncryption"> Enable local encryption (experimental)
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label">Export All Data</label>
                <button class="btn btn-secondary btn-block" onclick="exportFullBackup()">
                    <span>üíæ</span> Create Full Backup
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Clear All Data</label>
                <button class="btn btn-danger btn-block" onclick="clearAllData()">
                    <span>‚ö†Ô∏è</span> Delete Everything
                </button>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="saveSettings()">
                <span>‚úÖ</span> Save Settings
            </button>
        </div>
    </div>

    <script>
        // ==================== Application State ====================
        let appData = {
            profile: {
                name: '',
                bio: '',
                avatar: '',
                values: '',
                goals: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            },
            notes: [],
            memories: [],
            traits: [],
            personas: [],
            knowledge: {
                nodes: [],
                connections: []
            },
            blogPosts: [],
            chatHistory: [],
            settings: {
                autoSave: true,
                showWordCount: true,
                enableEncryption: false,
                theme: 'dark'
            },
            currentNoteId: null,
            activePersonaId: null,
            activeTab: 'notes'
        };

        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initializeApp();
            setupEventListeners();
            updateUI();
        });

        function initializeApp() {
            // Set initial tab
            switchTab('notes');
            
            // Load first note or create new
            if (appData.notes.length === 0) {
                createNewNote();
            } else {
                selectNote(appData.notes[0].id);
            }
            
            // Update all UI components
            updateStats();
            renderSidebar();
            renderPersonasList();
            updateRecentActivity();
        }

        // ==================== Data Management ====================
        function loadData() {
            const saved = localStorage.getItem('digitalTwinData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    appData = { ...appData, ...parsed };
                } catch (e) {
                    console.error('Error loading data:', e);
                    showNotification('Error loading saved data', 'error');
                }
            }
        }

        function saveData() {
            try {
                localStorage.setItem('digitalTwinData', JSON.stringify(appData));
                if (appData.settings.autoSave) {
                    showNotification('Auto-saved', 'success');
                }
            } catch (e) {
                console.error('Error saving data:', e);
                showNotification('Error saving data', 'error');
            }
        }

        // ==================== Tab Navigation ====================
        function switchTab(tabName) {
            // Update active tab in state
            appData.activeTab = tabName;
            
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Update sidebar content based on tab
            updateSidebarForTab(tabName);
            
            // Update new item button
            updateNewItemButton(tabName);
        }

        function updateNewItemButton(tabName) {
            const btn = document.getElementById('newItemBtn');
            switch(tabName) {
                case 'notes':
                    btn.innerHTML = '<span>‚ûï</span> New Note';
                    btn.onclick = createNewNote;
                    break;
                case 'memories':
                    btn.innerHTML = '<span>‚ûï</span> New Memory';
                    btn.onclick = () => showAddMemoryModal();
                    break;
                case 'traits':
                    btn.innerHTML = '<span>‚ûï</span> New Trait';
                    btn.onclick = () => showAddTraitModal();
                    break;
                default:
                    btn.style.display = 'none';
                    return;
            }
            btn.style.display = 'flex';
        }

        function updateSidebarForTab(tabName) {
            const content = document.getElementById('sidebarContent');
            content.innerHTML = '';
            
            switch(tabName) {
                case 'notes':
                    renderNotesList(content);
                    break;
                case 'memories':
                    renderMemoriesSidebar(content);
                    break;
                case 'traits':
                    renderTraitsSidebar(content);
                    break;
                case 'profile':
                case 'knowledge':
                case 'chat':
                    content.innerHTML = `
                        <div class="empty-state" style="padding: 40px 20px;">
                            <p style="text-align: center; color: var(--text-secondary);">
                                ${tabName === 'profile' ? 'Profile overview' : 
                                  tabName === 'knowledge' ? 'Knowledge connections' : 
                                  'Chat history'}
                            </p>
                        </div>
                    `;
                    break;
            }
        }

        // ==================== Note Management ====================
        function createNewNote() {
            const note = {
                id: generateId(),
                title: 'Untitled Note',
                content: '',
                tags: [],
                linkedMemories: [],
                linkedBlogPosts: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                wordCount: 0
            };
            
            appData.notes.unshift(note);
            saveData();
            selectNote(note.id);
            renderSidebar();
            updateStats();
            addActivity('note', 'Created new note');
        }

        function selectNote(noteId) {
            const note = appData.notes.find(n => n.id === noteId);
            if (!note) return;
            
            appData.currentNoteId = noteId;
            
            // Update editor
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            
            // Update tags
            renderNoteTags(note.tags);
            
            // Update linked memory dropdown
            updateLinkedMemoryDropdown(note.linkedMemories);
            
            // Update sidebar selection
            document.querySelectorAll('.note-item').forEach(item => {
                item.classList.toggle('active', item.dataset.id === noteId);
            });
            
            // Update word count if enabled
            if (appData.settings.showWordCount) {
                updateWordCount();
            }
        }

        function saveCurrentNote() {
            if (!appData.currentNoteId) return;
            
            const note = appData.notes.find(n => n.id === appData.currentNoteId);
            if (!note) return;
            
            note.title = document.getElementById('noteTitle').value || 'Untitled Note';
            note.content = document.getElementById('noteContent').value;
            note.updatedAt = new Date().toISOString();
            note.wordCount = note.content.split(/\s+/).filter(word => word.length > 0).length;
            note.tags = getCurrentNoteTags();
            
            saveData();
            renderSidebar();
            updateStats();
            showNotification('Note saved', 'success');
            addActivity('note', `Updated "${note.title}"`);
        }

        function deleteCurrentNote() {
            if (!appData.currentNoteId) return;
            
            if (confirm('Are you sure you want to delete this note?')) {
                const noteTitle = appData.notes.find(n => n.id === appData.currentNoteId)?.title;
                appData.notes = appData.notes.filter(n => n.id !== appData.currentNoteId);
                saveData();
                
                if (appData.notes.length > 0) {
                    selectNote(appData.notes[0].id);
                } else {
                    createNewNote();
                }
                
                renderSidebar();
                updateStats();
                showNotification('Note deleted', 'success');
                addActivity('note', `Deleted "${noteTitle}"`);
            }
        }

        function duplicateNote() {
            if (!appData.currentNoteId) return;
            
            const original = appData.notes.find(n => n.id === appData.currentNoteId);
            if (!original) return;
            
            const duplicate = {
                ...original,
                id: generateId(),
                title: original.title + ' (Copy)',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                linkedBlogPosts: []
            };
            
            appData.notes.unshift(duplicate);
            saveData();
            selectNote(duplicate.id);
            renderSidebar();
            showNotification('Note duplicated', 'success');
        }

        // ==================== Memory Management ====================
        function showAddMemoryModal() {
            document.getElementById('addMemoryModal').style.display = 'flex';
            document.getElementById('memoryDate').valueAsDate = new Date();
        }

        function saveMemory() {
            const memory = {
                id: generateId(),
                type: document.getElementById('memoryType').value,
                title: document.getElementById('memoryTitle').value,
                description: document.getElementById('memoryDescription').value,
                date: document.getElementById('memoryDate').value,
                impact: document.getElementById('memoryImpact').value,
                tags: getCurrentMemoryTags(),
                createdAt: new Date().toISOString()
            };
            
            if (!memory.title) {
                showNotification('Please enter a memory title', 'error');
                return;
            }
            
            appData.memories.push(memory);
            saveData();
            renderMemoriesList();
            updateStats();
            closeModal('addMemoryModal');
            clearMemoryForm();
            showNotification('Memory saved', 'success');
            addActivity('memory', `Added memory: "${memory.title}"`);
        }

        function renderMemoriesList() {
            const container = document.getElementById('memoriesList');
            if (!container) return;
            
            if (appData.memories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üß†</div>
                        <h3>No memories yet</h3>
                        <p>Start building your memory bank</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.memories
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(memory => `
                    <div class="memory-entry">
                        <div class="memory-type">${memory.type}</div>
                        <h3 style="margin-bottom: 10px;">${memory.title}</h3>
                        <div class="memory-content">${memory.description}</div>
                        <div class="memory-meta">
                            <span>${formatDate(memory.date)}</span>
                            <span>Impact: ${memory.impact}</span>
                            ${memory.tags.length > 0 ? `<span>${memory.tags.join(', ')}</span>` : ''}
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary btn-icon" onclick="editMemory('${memory.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-icon" onclick="deleteMemory('${memory.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
        }

        // ==================== Trait Management ====================
        function showAddTraitModal() {
            document.getElementById('addTraitModal').style.display = 'flex';
            
            // Setup strength slider
            const slider = document.getElementById('traitStrength');
            const value = document.getElementById('traitStrengthValue');
            slider.oninput = function() {
                value.textContent = this.value;
            };
        }

        function saveTrait() {
            const trait = {
                id: generateId(),
                category: document.getElementById('traitCategory').value,
                name: document.getElementById('traitName').value,
                description: document.getElementById('traitDescription').value,
                strength: parseInt(document.getElementById('traitStrength').value),
                examples: document.getElementById('traitExamples').value,
                createdAt: new Date().toISOString()
            };
            
            if (!trait.name) {
                showNotification('Please enter a trait name', 'error');
                return;
            }
            
            appData.traits.push(trait);
            saveData();
            renderTraitsList();
            updateStats();
            closeModal('addTraitModal');
            clearTraitForm();
            showNotification('Trait saved', 'success');
            addActivity('trait', `Added trait: "${trait.name}"`);
        }

        function renderTraitsList() {
            const container = document.getElementById('traitsList');
            if (!container) return;
            
            if (appData.traits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="text-align: center; color: var(--text-secondary);">No traits defined yet</p>
                    </div>
                `;
                return;
            }
            
            // Group traits by category
            const grouped = appData.traits.reduce((acc, trait) => {
                if (!acc[trait.category]) acc[trait.category] = [];
                acc[trait.category].push(trait);
                return acc;
            }, {});
            
            container.innerHTML = Object.entries(grouped)
                .map(([category, traits]) => `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--accent-primary); margin-bottom: 10px; text-transform: capitalize;">
                            ${category}
                        </h4>
                        ${traits.map(trait => `
                            <div class="trait-item">
                                <div class="trait-value">${trait.name}</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${trait.strength * 10}%"></div>
                                </div>
                                <div class="trait-description">${trait.description}</div>
                                ${trait.examples ? `<div style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);">Examples: ${trait.examples}</div>` : ''}
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-secondary btn-icon" onclick="editTrait('${trait.id}')">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-icon" onclick="deleteTrait('${trait.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
        }

        // ==================== Persona Management ====================
        function showPersonaModal() {
            document.getElementById('personaModal').style.display = 'flex';
        }

        function savePersona() {
            const persona = {
                id: generateId(),
                name: document.getElementById('personaName').value,
                style: document.getElementById('personaStyle').value,
                voice: document.getElementById('personaVoice').value,
                background: document.getElementById('personaBackground').value,
                topics: document.getElementById('personaTopics').value.split(',').map(t => t.trim()).filter(t => t),
                phrases: document.getElementById('personaPhrases').value,
                createdAt: new Date().toISOString()
            };
            
            if (!persona.name) {
                showNotification('Please enter a persona name', 'error');
                return;
            }
            
            appData.personas.push(persona);
            saveData();
            renderPersonasList();
            closeModal('personaModal');
            clearPersonaForm();
            showNotification('Persona created', 'success');
            addActivity('persona', `Created persona: "${persona.name}"`);
        }

        function renderPersonasList() {
            const container = document.getElementById('personasList');
            if (!container) return;
            
            if (appData.personas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <p style="text-align: center; color: var(--text-secondary);">No personas created yet</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.personas.map(persona => `
                <div class="persona-card ${appData.activePersonaId === persona.id ? 'active' : ''}" 
                     onclick="selectPersona('${persona.id}')">
                    <div class="persona-name">${persona.name}</div>
                    <div class="persona-description">${persona.style.substring(0, 80)}...</div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-secondary btn-icon" onclick="event.stopPropagation(); editPersona('${persona.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-icon" onclick="event.stopPropagation(); deletePersona('${persona.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function selectPersona(personaId) {
            appData.activePersonaId = personaId;
            renderPersonasList();
        }

        // ==================== Profile Management ====================
        function saveProfile() {
            appData.profile.name = document.getElementById('editProfileName').value || 'Anonymous';
            appData.profile.bio = document.getElementById('editProfileBio').value;
            appData.profile.values = document.getElementById('editProfileValues').value;
            appData.profile.goals = document.getElementById('editProfileGoals').value;
            appData.profile.updatedAt = new Date().toISOString();
            
            // Update avatar initials
            const initials = appData.profile.name.split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
            appData.profile.avatar = initials;
            
            saveData();
            updateProfileDisplay();
            showNotification('Profile updated', 'success');
            addActivity('profile', 'Updated profile information');
        }

        function updateProfileDisplay() {
            document.getElementById('profileName').textContent = appData.profile.name || 'Anonymous';
            document.getElementById('profileBio').textContent = appData.profile.bio || 'Digital twin profile';
            document.getElementById('profileAvatar').textContent = appData.profile.avatar || '??';
            
            // Update form fields
            document.getElementById('editProfileName').value = appData.profile.name;
            document.getElementById('editProfileBio').value = appData.profile.bio;
            document.getElementById('editProfileValues').value = appData.profile.values;
            document.getElementById('editProfileGoals').value = appData.profile.goals;
        }

        // ==================== Export/Import Functions ====================
        function showExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
            updateExportPersonaList();
        }

        function updateExportOptions() {
            const exportType = document.getElementById('exportType').value;
            const customOptions = document.getElementById('customExportOptions');
            customOptions.style.display = exportType === 'custom' ? 'block' : 'none';
        }

        function updateExportPersonaList() {
            const select = document.getElementById('exportPersona');
            select.innerHTML = '<option value="">No persona</option>';
            appData.personas.forEach(persona => {
                const option = document.createElement('option');
                option.value = persona.id;
                option.textContent = persona.name;
                if (persona.id === appData.activePersonaId) option.selected = true;
                select.appendChild(option);
            });
        }

        function exportData() {
            const exportType = document.getElementById('exportType').value;
            const exportFormat = document.getElementById('exportFormat').value;
            const personaId = document.getElementById('exportPersona').value;
            const instructions = document.getElementById('aiInstructions').value;
            
            let exportData = {
                exportDate: new Date().toISOString(),
                type: 'digital_twin_export',
                version: '2.0',
                format: exportFormat
            };
            
            // Add selected persona
            if (personaId) {
                const persona = appData.personas.find(p => p.id === personaId);
                if (persona) {
                    exportData.persona = persona;
                }
            }
            
            // Add AI instructions
            if (instructions) {
                exportData.aiInstructions = instructions;
            }
            
            // Add data based on export type
            switch(exportType) {
                case 'notes':
                    exportData.notes = appData.notes;
                    break;
                case 'profile':
                    exportData.profile = appData.profile;
                    exportData.traits = appData.traits;
                    exportData.values = appData.profile.values;
                    exportData.goals = appData.profile.goals;
                    break;
                case 'memories':
                    exportData.memories = appData.memories;
                    break;
                case 'traits':
                    exportData.traits = appData.traits;
                    break;
                case 'full':
                    exportData = { ...exportData, ...appData };
                    break;
                case 'custom':
                    if (document.getElementById('exportNotes').checked) exportData.notes = appData.notes;
                    if (document.getElementById('exportProfile').checked) exportData.profile = appData.profile;
                    if (document.getElementById('exportMemories').checked) exportData.memories = appData.memories;
                    if (document.getElementById('exportTraits').checked) exportData.traits = appData.traits;
                    if (document.getElementById('exportPersonas').checked) exportData.personas = appData.personas;
                    if (document.getElementById('exportKnowledge').checked) exportData.knowledge = appData.knowledge;
                    break;
            }
            
            // Format and download
            let content, filename, mimeType;
            
            switch(exportFormat) {
                case 'json':
                    content = JSON.stringify(exportData, null, 2);
                    filename = `digital-twin-${exportType}-${formatDateForFilename()}.json`;
                    mimeType = 'application/json';
                    break;
                case 'markdown':
                    content = convertToMarkdown(exportData);
                    filename = `digital-twin-${exportType}-${formatDateForFilename()}.md`;
                    mimeType = 'text/markdown';
                    break;
                case 'jsonl':
                    content = convertToJSONL(exportData);
                    filename = `digital-twin-${exportType}-${formatDateForFilename()}.jsonl`;
                    mimeType = 'application/x-jsonlines';
                    break;
            }
            
            downloadFile(content, filename, mimeType);
            closeModal('exportModal');
            showNotification('Export completed', 'success');
            addActivity('export', `Exported ${exportType} data`);
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'flex';
        }

        function importData() {
            const importType = document.getElementById('importType').value;
            const fileInput = document.getElementById('importFile');
            const jsonInput = document.getElementById('importJson').value;
            
            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        processImport(data, importType);
                    } catch (err) {
                        showNotification('Invalid file format', 'error');
                    }
                };
                reader.readAsText(fileInput.files[0]);
            } else if (jsonInput) {
                try {
                    const data = JSON.parse(jsonInput);
                    processImport(data, importType);
                } catch (err) {
                    showNotification('Invalid JSON format', 'error');
                }
            } else {
                showNotification('Please select a file or paste data', 'error');
            }
        }

        function processImport(data, importType) {
            try {
                switch(importType) {
                    case 'notes':
                        if (data.notes) {
                            data.notes.forEach(note => {
                                note.id = generateId();
                                note.importedAt = new Date().toISOString();
                                appData.notes.unshift(note);
                            });
                        }
                        break;
                    case 'memories':
                        if (data.memories) {
                            data.memories.forEach(memory => {
                                memory.id = generateId();
                                appData.memories.push(memory);
                            });
                        }
                        break;
                    case 'traits':
                        if (data.traits) {
                            data.traits.forEach(trait => {
                                trait.id = generateId();
                                appData.traits.push(trait);
                            });
                        }
                        break;
                    case 'blog':
                        if (data.blogPost) {
                            const blogPost = {
                                ...data.blogPost,
                                id: generateId(),
                                importedAt: new Date().toISOString()
                            };
                            appData.blogPosts.push(blogPost);
                            
                            // Link to source notes if provided
                            if (data.sourceNoteIds) {
                                data.sourceNoteIds.forEach(noteId => {
                                    const note = appData.notes.find(n => n.id === noteId);
                                    if (note) {
                                        note.linkedBlogPosts.push(blogPost.id);
                                    }
                                });
                            }
                        }
                        break;
                    case 'full':
                        if (confirm('This will replace all existing data. Continue?')) {
                            appData = { ...appData, ...data };
                        } else {
                            return;
                        }
                        break;
                    case 'merge':
                        // Merge data intelligently
                        if (data.notes) appData.notes.push(...data.notes);
                        if (data.memories) appData.memories.push(...data.memories);
                        if (data.traits) appData.traits.push(...data.traits);
                        if (data.personas) appData.personas.push(...data.personas);
                        if (data.profile) appData.profile = { ...appData.profile, ...data.profile };
                        break;
                }
                
                saveData();
                updateUI();
                closeModal('importModal');
                clearImportForm();
                showNotification('Import successful', 'success');
                addActivity('import', `Imported ${importType} data`);
                
            } catch (err) {
                showNotification('Error processing import: ' + err.message, 'error');
            }
        }

        // ==================== Chat Functions ====================
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage('user', message);
            input.value = '';
            
            // Simulate AI response (in real app, this would call an API)
            setTimeout(() => {
                const response = generateAIResponse(message);
                addChatMessage('assistant', response);
            }, 1000);
        }

        function addChatMessage(role, content) {
            const chatMessage = {
                id: generateId(),
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            };
            
            appData.chatHistory.push(chatMessage);
            saveData();
            
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            messageDiv.textContent = content;
            
            // Clear empty state if first message
            if (appData.chatHistory.length === 1) {
                messagesContainer.innerHTML = '';
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function generateAIResponse(userMessage) {
            // Simple response generation based on digital twin data
            const responses = [
                `Based on your profile, I understand that ${appData.profile.values ? 'your values include ' + appData.profile.values.substring(0, 50) + '...' : 'you haven\'t shared your values yet.'}`,
                `You have ${appData.notes.length} notes and ${appData.memories.length} memories stored. Would you like me to help you explore them?`,
                `Your most recent memory is about "${appData.memories[0]?.title || 'no memories yet'}".`,
                `I notice you have ${appData.traits.length} personality traits defined. These help me understand you better.`,
                `Your goals include: ${appData.profile.goals || 'You haven\'t set any goals yet.'}`,
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // ==================== Helper Functions ====================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
                if (diffHours === 0) {
                    const diffMinutes = Math.floor(diffTime / (1000 * 60));
                    return diffMinutes === 0 ? 'Just now' : `${diffMinutes}m ago`;
                }
                return `${diffHours}h ago`;
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function formatDateForFilename() {
            return new Date().toISOString().split('T')[0];
        }

        function updateWordCount() {
            const content = document.getElementById('noteContent').value;
            const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
            // Update word count display if you have one
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ==================== Tag Management ====================
        function renderNoteTags(tags) {
            const container = document.getElementById('noteTagsContainer');
            container.innerHTML = '';
            
            tags.forEach(tag => {
                const tagEl = document.createElement('div');
                tagEl.className = 'tag';
                tagEl.innerHTML = `
                    ${tag}
                    <span class="tag-remove" onclick="removeNoteTag('${tag}')">&times;</span>
                `;
                container.appendChild(tagEl);
            });
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'tag-input';
            input.id = 'noteTagInput';
            input.placeholder = 'Add tags...';
            input.addEventListener('keydown', handleNoteTagInput);
            container.appendChild(input);
        }

        function handleNoteTagInput(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const input = e.target;
                const tag = input.value.trim();
                
                if (tag && !getCurrentNoteTags().includes(tag)) {
                    const note = appData.notes.find(n => n.id === appData.currentNoteId);
                    if (note) {
                        note.tags.push(tag);
                        renderNoteTags(note.tags);
                        if (appData.settings.autoSave) saveCurrentNote();
                    }
                }
                input.value = '';
            }
        }

        function removeNoteTag(tag) {
            const note = appData.notes.find(n => n.id === appData.currentNoteId);
            if (note) {
                note.tags = note.tags.filter(t => t !== tag);
                renderNoteTags(note.tags);
                if (appData.settings.autoSave) saveCurrentNote();
            }
        }

        function getCurrentNoteTags() {
            const note = appData.notes.find(n => n.id === appData.currentNoteId);
            return note ? note.tags : [];
        }

        function getCurrentMemoryTags() {
            const tags = [];
            document.querySelectorAll('#memoryTagsContainer .tag').forEach(el => {
                const text = el.textContent.replace('√ó', '').trim();
                if (text) tags.push(text);
            });
            return tags;
        }

        // ==================== UI Update Functions ====================
        function updateUI() {
            updateStats();
            updateProfileDisplay();
            renderSidebar();
            renderPersonasList();
            renderMemoriesList();
            renderTraitsList();
            updateRecentActivity();
        }

        function updateStats() {
            // Calculate total words
            const totalWords = appData.notes.reduce((sum, note) => sum + note.wordCount, 0);
            
            // Update stat displays
            document.getElementById('totalNotes').textContent = appData.notes.length;
            document.getElementById('totalMemories').textContent = appData.memories.length;
            document.getElementById('totalTraits').textContent = appData.traits.length;
            document.getElementById('totalWords').textContent = totalWords.toLocaleString();
            
            // Update knowledge graph stats
            document.getElementById('knowledgeNodes').textContent = appData.knowledge.nodes.length;
            document.getElementById('knowledgeConnections').textContent = appData.knowledge.connections.length;
        }

        function renderSidebar() {
            switch(appData.activeTab) {
                case 'notes':
                    renderNotesList(document.getElementById('sidebarContent'));
                    break;
                case 'memories':
                    renderMemoriesSidebar(document.getElementById('sidebarContent'));
                    break;
                case 'traits':
                    renderTraitsSidebar(document.getElementById('sidebarContent'));
                    break;
            }
        }

        function renderNotesList(container) {
            if (!container) return;
            
            container.innerHTML = '';
            
            if (appData.notes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="text-align: center; color: var(--text-secondary);">No notes yet. Create your first note!</p>
                    </div>
                `;
                return;
            }
            
            // Group notes by date
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            const groups = {
                today: [],
                yesterday: [],
                older: []
            };
            
            appData.notes.forEach(note => {
                const noteDate = new Date(note.updatedAt).toDateString();
                if (noteDate === today) {
                    groups.today.push(note);
                } else if (noteDate === yesterday) {
                    groups.yesterday.push(note);
                } else {
                    groups.older.push(note);
                }
            });
            
            // Render groups
            if (groups.today.length > 0) {
                container.innerHTML += `<h4 style="color: var(--text-secondary); margin: 15px 0 10px; font-size: 0.85em;">Today</h4>`;
                groups.today.forEach(note => container.appendChild(createNoteElement(note)));
            }
            
            if (groups.yesterday.length > 0) {
                container.innerHTML += `<h4 style="color: var(--text-secondary); margin: 15px 0 10px; font-size: 0.85em;">Yesterday</h4>`;
                groups.yesterday.forEach(note => container.appendChild(createNoteElement(note)));
            }
            
            if (groups.older.length > 0) {
                container.innerHTML += `<h4 style="color: var(--text-secondary); margin: 15px 0 10px; font-size: 0.85em;">Older</h4>`;
                groups.older.forEach(note => container.appendChild(createNoteElement(note)));
            }
        }

        function createNoteElement(note) {
            const div = document.createElement('div');
            div.className = 'note-item';
            div.dataset.id = note.id;
            if (note.id === appData.currentNoteId) div.classList.add('active');
            div.onclick = () => selectNote(note.id);
            
            const preview = note.content.substring(0, 100).replace(/\n/g, ' ');
            
            div.innerHTML = `
                <div class="note-item-title">${note.title}</div>
                <div class="note-item-preview">${preview}${note.content.length > 100 ? '...' : ''}</div>
                <div class="note-item-meta">
                    <span>${formatDate(note.updatedAt)}</span>
                    <span>‚Ä¢</span>
                    <span>${note.wordCount} words</span>
                    ${note.linkedBlogPosts.length > 0 ? '<span>‚Ä¢</span><span>üìé Linked</span>' : ''}
                </div>
            `;
            
            return div;
        }

        function renderMemoriesSidebar(container) {
            if (!container) return;
            
            container.innerHTML = '<h4 style="color: var(--text-secondary); margin-bottom: 15px;">Memory Types</h4>';
            
            const types = ['experience', 'achievement', 'learning', 'relationship', 'challenge', 'insight'];
            const counts = types.reduce((acc, type) => {
                acc[type] = appData.memories.filter(m => m.type === type).length;
                return acc;
            }, {});
            
            types.forEach(type => {
                const count = counts[type];
                const div = document.createElement('div');
                div.className = 'note-item';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="text-transform: capitalize;">${type}</span>
                        <span style="background: var(--bg-quaternary); padding: 2px 8px; border-radius: 10px; font-size: 0.85em;">${count}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderTraitsSidebar(container) {
            if (!container) return;
            
            container.innerHTML = '<h4 style="color: var(--text-secondary); margin-bottom: 15px;">Trait Categories</h4>';
            
            const categories = ['personality', 'values', 'skills', 'interests', 'habits', 'preferences', 'communication', 'thinking'];
            const counts = categories.reduce((acc, cat) => {
                acc[cat] = appData.traits.filter(t => t.category === cat).length;
                return acc;
            }, {});
            
            categories.forEach(category => {
                const count = counts[category];
                const div = document.createElement('div');
                div.className = 'note-item';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="text-transform: capitalize;">${category}</span>
                        <span style="background: var(--bg-quaternary); padding: 2px 8px; border-radius: 10px; font-size: 0.85em;">${count}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            // Get recent activity from localStorage
            const activities = JSON.parse(localStorage.getItem('digitalTwinActivities') || '[]');
            const recent = activities.slice(-5).reverse();
            
            if (recent.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9em;">No recent activity</p>';
                return;
            }
            
            container.innerHTML = recent.map(activity => `
                <div class="timeline-item">
                    <div class="timeline-date">${formatDate(activity.timestamp)}</div>
                    <div class="timeline-content">
                        <strong>${activity.type}</strong>: ${activity.description}
                    </div>
                </div>
            `).join('');
        }

        function addActivity(type, description) {
            const activities = JSON.parse(localStorage.getItem('digitalTwinActivities') || '[]');
            activities.push({
                type,
                description,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 activities
            if (activities.length > 50) {
                activities.splice(0, activities.length - 50);
            }
            
            localStorage.setItem('digitalTwinActivities', JSON.stringify(activities));
            updateRecentActivity();
        }

        function updateLinkedMemoryDropdown(linkedMemories) {
            const select = document.getElementById('linkedMemory');
            select.innerHTML = '<option value="">No linked memory</option>';
            
            appData.memories.forEach(memory => {
                const option = document.createElement('option');
                option.value = memory.id;
                option.textContent = `${memory.title} (${memory.type})`;
                if (linkedMemories && linkedMemories.includes(memory.id)) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // ==================== Event Listeners ====================
        function setupEventListeners() {
            // Auto-save on content change
            let saveTimeout;
            const autoSaveElements = ['noteTitle', 'noteContent'];
            
            autoSaveElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', function() {
                        if (appData.settings.autoSave) {
                            clearTimeout(saveTimeout);
                            saveTimeout = setTimeout(saveCurrentNote, 2000);
                        }
                        if (id === 'noteContent') updateWordCount();
                    });
                }
            });
            
            // Search functionality
            document.getElementById('searchBox').addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                searchContent(query);
            });
            
            // Chat input enter key
            document.getElementById('chatInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            // Modal backdrop clicks
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.metaKey || e.ctrlKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            saveCurrentNote();
                            break;
                        case 'n':
                            e.preventDefault();
                            if (appData.activeTab === 'notes') createNewNote();
                            break;
                        case 'e':
                            e.preventDefault();
                            showExportModal();
                            break;
                        case '/':
                            e.preventDefault();
                            document.getElementById('searchBox').focus();
                            break;
                    }
                }
            });
        }

        function searchContent(query) {
            if (!query) {
                renderSidebar();
                return;
            }
            
            const results = [];
            
            // Search notes
            appData.notes.forEach(note => {
                if (note.title.toLowerCase().includes(query) || 
                    note.content.toLowerCase().includes(query) ||
                    note.tags.some(tag => tag.toLowerCase().includes(query))) {
                    results.push({ type: 'note', item: note });
                }
            });
            
            // Search memories
            appData.memories.forEach(memory => {
                if (memory.title.toLowerCase().includes(query) || 
                    memory.description.toLowerCase().includes(query) ||
                    memory.tags.some(tag => tag.toLowerCase().includes(query))) {
                    results.push({ type: 'memory', item: memory });
                }
            });
            
            // Search traits
            appData.traits.forEach(trait => {
                if (trait.name.toLowerCase().includes(query) || 
                    trait.description.toLowerCase().includes(query)) {
                    results.push({ type: 'trait', item: trait });
                }
            });
            
            // Display search results
            const container = document.getElementById('sidebarContent');
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="text-align: center; color: var(--text-secondary);">No results found for "${query}"</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<h4 style="color: var(--text-secondary); margin-bottom: 15px;">Search Results</h4>';
            
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = 'note-item';
                div.onclick = () => {
                    if (result.type === 'note') {
                        switchTab('notes');
                        selectNote(result.item.id);
                    }
                    // Add handlers for other types as needed
                };
                
                div.innerHTML = `
                    <div class="note-item-title">${result.item.title || result.item.name}</div>
                    <div class="note-item-preview">${result.type} - ${(result.item.content || result.item.description || '').substring(0, 50)}...</div>
                `;
                
                container.appendChild(div);
            });
        }

        // ==================== Delete Functions ====================
        function deleteMemory(memoryId) {
            if (confirm('Are you sure you want to delete this memory?')) {
                appData.memories = appData.memories.filter(m => m.id !== memoryId);
                saveData();
                renderMemoriesList();
                updateStats();
                showNotification('Memory deleted', 'success');
            }
        }

        function deleteTrait(traitId) {
            if (confirm('Are you sure you want to delete this trait?')) {
                appData.traits = appData.traits.filter(t => t.id !== traitId);
                saveData();
                renderTraitsList();
                updateStats();
                showNotification('Trait deleted', 'success');
            }
        }

        function deletePersona(personaId) {
            if (confirm('Are you sure you want to delete this persona?')) {
                appData.personas = appData.personas.filter(p => p.id !== personaId);
                if (appData.activePersonaId === personaId) {
                    appData.activePersonaId = null;
                }
                saveData();
                renderPersonasList();
                showNotification('Persona deleted', 'success');
            }
        }

        // ==================== Edit Functions ====================
        function editMemory(memoryId) {
            const memory = appData.memories.find(m => m.id === memoryId);
            if (!memory) return;
            
            // Populate form with memory data
            document.getElementById('memoryType').value = memory.type;
            document.getElementById('memoryTitle').value = memory.title;
            document.getElementById('memoryDescription').value = memory.description;
            document.getElementById('memoryDate').value = memory.date;
            document.getElementById('memoryImpact').value = memory.impact;
            
            // Show modal
            showAddMemoryModal();
            
            // Remove the memory being edited
            appData.memories = appData.memories.filter(m => m.id !== memoryId);
        }

        function editTrait(traitId) {
            const trait = appData.traits.find(t => t.id === traitId);
            if (!trait) return;
            
            // Populate form
            document.getElementById('traitCategory').value = trait.category;
            document.getElementById('traitName').value = trait.name;
            document.getElementById('traitDescription').value = trait.description;
            document.getElementById('traitStrength').value = trait.strength;
            document.getElementById('traitStrengthValue').textContent = trait.strength;
            document.getElementById('traitExamples').value = trait.examples;
            
            // Show modal
            showAddTraitModal();
            
            // Remove the trait being edited
            appData.traits = appData.traits.filter(t => t.id !== traitId);
        }

        function editPersona(personaId) {
            const persona = appData.personas.find(p => p.id === personaId);
            if (!persona) return;
            
            // Populate form
            document.getElementById('personaName').value = persona.name;
            document.getElementById('personaStyle').value = persona.style;
            document.getElementById('personaVoice').value = persona.voice;
            document.getElementById('personaBackground').value = persona.background;
            document.getElementById('personaTopics').value = persona.topics.join(', ');
            document.getElementById('personaPhrases').value = persona.phrases;
            
            // Show modal
            showPersonaModal();
            
            // Remove the persona being edited
            appData.personas = appData.personas.filter(p => p.id !== personaId);
        }

        // ==================== Clear Form Functions ====================
        function clearMemoryForm() {
            document.getElementById('memoryTitle').value = '';
            document.getElementById('memoryDescription').value = '';
            document.getElementById('memoryDate').value = '';
            document.getElementById('memoryType').value = 'experience';
            document.getElementById('memoryImpact').value = 'positive';
            document.getElementById('memoryTagsContainer').innerHTML = '<input type="text" class="tag-input" id="memoryTagInput" placeholder="Add tags...">';
        }

        function clearTraitForm() {
            document.getElementById('traitName').value = '';
            document.getElementById('traitDescription').value = '';
            document.getElementById('traitStrength').value = '5';
            document.getElementById('traitStrengthValue').textContent = '5';
            document.getElementById('traitExamples').value = '';
            document.getElementById('traitCategory').value = 'personality';
        }

        function clearPersonaForm() {
            document.getElementById('personaName').value = '';
            document.getElementById('personaStyle').value = '';
            document.getElementById('personaVoice').value = '';
            document.getElementById('personaBackground').value = '';
            document.getElementById('personaTopics').value = '';
            document.getElementById('personaPhrases').value = '';
        }

        function clearImportForm() {
            document.getElementById('importFile').value = '';
            document.getElementById('importJson').value = '';
        }

        // ==================== Settings Functions ====================
        function showSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
            
            // Load current settings
            document.getElementById('autoSave').checked = appData.settings.autoSave;
            document.getElementById('showWordCount').checked = appData.settings.showWordCount;
            document.getElementById('enableEncryption').checked = appData.settings.enableEncryption;
        }

        function saveSettings() {
            appData.settings.autoSave = document.getElementById('autoSave').checked;
            appData.settings.showWordCount = document.getElementById('showWordCount').checked;
            appData.settings.enableEncryption = document.getElementById('enableEncryption').checked;
            
            saveData();
            closeModal('settingsModal');
            showNotification('Settings saved', 'success');
        }

        function exportFullBackup() {
            const backup = {
                ...appData,
                exportDate: new Date().toISOString(),
                version: '2.0',
                type: 'full_backup'
            };
            
            const content = JSON.stringify(backup, null, 2);
            const filename = `digital-twin-backup-${formatDateForFilename()}.json`;
            downloadFile(content, filename, 'application/json');
            showNotification('Full backup created', 'success');
        }

        function clearAllData() {
            if (confirm('This will permanently delete all your data. Are you sure?')) {
                if (confirm('This action cannot be undone. Do you want to create a backup first?')) {
                    exportFullBackup();
                }
                
                if (confirm('Final confirmation: Delete all data?')) {
                    localStorage.removeItem('digitalTwinData');
                    localStorage.removeItem('digitalTwinActivities');
                    location.reload();
                }
            }
        }

        // ==================== Export Format Converters ====================
        function convertToMarkdown(data) {
            let md = `# Digital Twin Export\n\n`;
            md += `**Export Date:** ${new Date(data.exportDate).toLocaleString()}\n\n`;
            
            if (data.profile) {
                md += `## Profile\n\n`;
                md += `**Name:** ${data.profile.name}\n\n`;
                md += `**Bio:** ${data.profile.bio}\n\n`;
                md += `**Values:** ${data.profile.values}\n\n`;
                md += `**Goals:** ${data.profile.goals}\n\n`;
            }
            
            if (data.notes) {
                md += `## Notes (${data.notes.length})\n\n`;
                data.notes.forEach(note => {
                    md += `### ${note.title}\n\n`;
                    md += `${note.content}\n\n`;
                    md += `*Tags: ${note.tags.join(', ')}*\n\n`;
                    md += `---\n\n`;
                });
            }
            
            if (data.memories) {
                md += `## Memories (${data.memories.length})\n\n`;
                data.memories.forEach(memory => {
                    md += `### ${memory.title} (${memory.type})\n\n`;
                    md += `${memory.description}\n\n`;
                    md += `*Date: ${memory.date} | Impact: ${memory.impact}*\n\n`;
                    md += `---\n\n`;
                });
            }
            
            if (data.traits) {
                md += `## Traits (${data.traits.length})\n\n`;
                data.traits.forEach(trait => {
                    md += `### ${trait.name} (${trait.category})\n\n`;
                    md += `**Strength:** ${trait.strength}/10\n\n`;
                    md += `${trait.description}\n\n`;
                    if (trait.examples) md += `**Examples:** ${trait.examples}\n\n`;
                    md += `---\n\n`;
                });
            }
            
            return md;
        }

        function convertToJSONL(data) {
            const lines = [];
            
            // Create training examples from notes
            if (data.notes) {
                data.notes.forEach(note => {
                    lines.push(JSON.stringify({
                        prompt: `Write about: ${note.title}`,
                        completion: note.content,
                        metadata: {
                            type: 'note',
                            tags: note.tags,
                            persona: data.persona?.name
                        }
                    }));
                });
            }
            
            // Create training examples from memories
            if (data.memories) {
                data.memories.forEach(memory => {
                    lines.push(JSON.stringify({
                        prompt: `Tell me about: ${memory.title}`,
                        completion: memory.description,
                        metadata: {
                            type: 'memory',
                            category: memory.type,
                            impact: memory.impact
                        }
                    }));
                });
            }
            
            return lines.join('\n');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>