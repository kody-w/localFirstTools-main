<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteForge - Local Knowledge Base</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --bg-hover: #e5e7eb;
            
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            
            --border: #e5e7eb;
            --border-dark: #d1d5db;
            
            --sidebar-width: 280px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        body.dark-mode {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --bg-tertiary: #374151;
            --bg-hover: #4b5563;
            
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            
            --border: #374151;
            --border-dark: #4b5563;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .sidebar-actions {
            display: flex;
            gap: 4px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
            font-size: 16px;
        }

        .icon-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .sidebar-search {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .section-header {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-add-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .sidebar-section:hover .section-add-btn {
            opacity: 1;
        }

        .page-list {
            list-style: none;
        }

        .page-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
            transition: all 0.2s;
            color: var(--text-secondary);
            font-size: 14px;
            position: relative;
        }

        .page-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .page-item.active {
            background: var(--primary);
            color: white;
        }

        .page-item.active .page-actions {
            color: white;
        }

        .page-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .page-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .page-actions {
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .page-item:hover .page-actions {
            opacity: 1;
        }

        .page-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: inherit;
            font-size: 12px;
            transition: background 0.2s;
        }

        .page-action-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            overflow: hidden;
        }

        .topbar {
            height: 60px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 16px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .topbar-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px 24px;
        }

        .content-wrapper {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Page Editor */
        .page-header {
            margin-bottom: 32px;
        }

        .page-title-input {
            width: 100%;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 40px;
            font-weight: 700;
            padding: 8px 0;
            outline: none;
            resize: none;
            overflow: hidden;
        }

        .page-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .tags-container {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .tag {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .tag-input {
            border: none;
            background: transparent;
            outline: none;
            padding: 4px;
            font-size: 12px;
            min-width: 80px;
            color: var(--text-primary);
        }

        .page-type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .type-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .type-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .type-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .editor-container {
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border);
            min-height: 400px;
        }

        .editor-toolbar {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 16px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .toolbar-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 4px 8px;
        }

        .editor-content {
            padding: 24px;
            min-height: 300px;
            outline: none;
            font-size: 16px;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .editor-content:empty:before {
            content: 'Start writing...';
            color: var(--text-tertiary);
        }

        /* Task List View */
        .task-view {
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .task-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .task-list {
            padding: 12px;
        }

        .task-item {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: background 0.2s;
            cursor: pointer;
        }

        .task-item:hover {
            background: var(--bg-secondary);
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-dark);
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .task-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            font-weight: 700;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .task-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Table View */
        .table-view {
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
        }

        .data-table td {
            font-size: 14px;
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-secondary);
        }

        /* Kanban View */
        .kanban-view {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 16px;
        }

        .kanban-column {
            min-width: 300px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .kanban-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .kanban-count {
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .kanban-cards {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
        }

        .kanban-card {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .card-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .card-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 20px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-description {
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            border-left: 4px solid var(--success);
            max-width: 400px;
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Command Palette */
        .command-palette {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            padding: 100px 20px;
        }

        .command-palette.active {
            display: block;
        }

        .command-content {
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }

        .command-input {
            width: 100%;
            padding: 20px;
            border: none;
            background: transparent;
            font-size: 16px;
            color: var(--text-primary);
            outline: none;
        }

        .command-results {
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid var(--border);
        }

        .command-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .command-item:hover,
        .command-item.selected {
            background: var(--bg-secondary);
        }

        .command-icon {
            font-size: 18px;
        }

        .command-text {
            flex: 1;
        }

        .command-name {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .command-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .command-shortcut {
            font-size: 12px;
            color: var(--text-tertiary);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-dark);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 100;
                height: 100vh;
            }

            .topbar {
                padding: 0 12px;
            }

            .content-area {
                padding: 20px 12px;
            }

            .page-title-input {
                font-size: 28px;
            }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .gap-2 {
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="app-logo">
                    <div class="logo-icon">üìù</div>
                    <span>NoteForge</span>
                </div>
                <div class="sidebar-actions">
                    <button class="icon-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                        üåô
                    </button>
                    <button class="icon-btn" onclick="toggleSidebar()" title="Toggle Sidebar">
                        ‚ò∞
                    </button>
                </div>
            </div>

            <div class="sidebar-search">
                <input type="text" class="search-input" placeholder="Search pages..." 
                       id="searchInput" oninput="searchPages(this.value)">
            </div>

            <div class="sidebar-content">
                <div class="sidebar-section">
                    <div class="section-header">
                        <span>Quick Access</span>
                        <button class="icon-btn section-add-btn" onclick="createQuickPage()" title="New Page">
                            ‚ûï
                        </button>
                    </div>
                    <ul class="page-list" id="quickAccessList">
                        <!-- Quick access pages -->
                    </ul>
                </div>

                <div class="sidebar-section">
                    <div class="section-header">
                        <span>All Pages</span>
                        <button class="icon-btn section-add-btn" onclick="openNewPageModal()" title="New Page">
                            ‚ûï
                        </button>
                    </div>
                    <ul class="page-list" id="allPagesList">
                        <!-- All pages will be listed here -->
                    </ul>
                </div>

                <div class="sidebar-section">
                    <div class="section-header">
                        <span>Tags</span>
                    </div>
                    <ul class="page-list" id="tagsList">
                        <!-- Tags will be listed here -->
                    </ul>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="btn btn-secondary" style="flex: 1;" onclick="exportAllData()">
                    üì• Export
                </button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="document.getElementById('importFile').click()">
                    üì§ Import
                </button>
                <input type="file" id="importFile" accept=".json" onchange="importAllData(event)" style="display: none;">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="topbar">
                <div class="breadcrumb" id="breadcrumb">
                    <span>Home</span>
                </div>
                <div class="topbar-actions">
                    <button class="btn btn-ghost" onclick="openCommandPalette()" title="Command Palette (Ctrl+K)">
                        ‚åò Commands
                    </button>
                    <button class="btn btn-primary" onclick="openNewPageModal()">
                        ‚ûï New Page
                    </button>
                </div>
            </div>

            <div class="content-area">
                <div class="content-wrapper" id="contentWrapper">
                    <!-- Content will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <!-- New Page Modal -->
    <div class="modal" id="newPageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Page</h2>
                <button class="modal-close" onclick="closeModal('newPageModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Page Title</label>
                    <input type="text" class="form-input" id="newPageTitle" placeholder="Enter page title...">
                </div>
                <div class="form-group">
                    <label class="form-label">Page Type</label>
                    <select class="form-select" id="newPageType">
                        <option value="note">üìù Note</option>
                        <option value="task">‚úì Task List</option>
                        <option value="table">üìä Table</option>
                        <option value="kanban">üìã Kanban</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Icon (emoji)</label>
                    <input type="text" class="form-input" id="newPageIcon" placeholder="üìÑ" maxlength="2">
                </div>
                <div class="form-group">
                    <label class="form-label">Tags (comma separated)</label>
                    <input type="text" class="form-input" id="newPageTags" placeholder="work, project, important">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newPageModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewPage()">Create Page</button>
            </div>
        </div>
    </div>

    <!-- Command Palette -->
    <div class="command-palette" id="commandPalette">
        <div class="command-content">
            <input type="text" class="command-input" id="commandInput" 
                   placeholder="Type a command or search..." 
                   oninput="filterCommands(this.value)">
            <div class="command-results" id="commandResults">
                <!-- Command results will appear here -->
            </div>
        </div>
    </div>

    <script>
        // Application State
        let appState = {
            pages: {},
            currentPageId: null,
            darkMode: false,
            sidebarCollapsed: false,
            lastUpdated: new Date().toISOString()
        };

        // Initialize app
        function init() {
            loadFromStorage();
            setupKeyboardShortcuts();
            
            // Create initial welcome page if no pages exist
            if (Object.keys(appState.pages).length === 0) {
                createInitialPages();
            }
            
            renderSidebar();
            
            // Load first page or show empty state
            const firstPageId = Object.keys(appState.pages)[0];
            if (firstPageId) {
                loadPage(firstPageId);
            } else {
                showEmptyState();
            }
        }

        // Create initial sample pages
        function createInitialPages() {
            // Welcome page
            const welcomeId = generateId();
            appState.pages[welcomeId] = {
                id: welcomeId,
                title: 'Welcome to NoteForge',
                type: 'note',
                icon: 'üëã',
                tags: ['getting-started'],
                content: `<h2>Welcome to NoteForge!</h2>
<p>This is your local-first knowledge base. Everything is stored in your browser's localStorage and can be exported/imported as JSON.</p>

<h3>Features:</h3>
<ul>
    <li><strong>Multiple Page Types:</strong> Notes, Task Lists, Tables, Kanban boards</li>
    <li><strong>Rich Text Editor:</strong> Format your content with bold, italic, headings, lists, and more</li>
    <li><strong>Tags & Search:</strong> Organize and find your content easily</li>
    <li><strong>Import/Export:</strong> Full JSON backup and restore</li>
    <li><strong>Dark Mode:</strong> Easy on the eyes</li>
    <li><strong>Command Palette:</strong> Press Ctrl+K (or Cmd+K) for quick actions</li>
</ul>

<h3>Getting Started:</h3>
<ol>
    <li>Create a new page using the "+ New Page" button</li>
    <li>Choose your page type (Note, Task, Table, or Kanban)</li>
    <li>Start adding content!</li>
    <li>Use tags to organize</li>
    <li>Export your data regularly for backup</li>
</ol>

<p><em>Pro tip: Press Ctrl+K to open the command palette for quick navigation!</em></p>`,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                favorite: false
            };

            // Marty's Priorities Page
            const prioritiesId = generateId();
            appState.pages[prioritiesId] = {
                id: prioritiesId,
                title: "Marty's Core Priorities - Q2",
                type: 'task',
                icon: 'üéØ',
                tags: ['work', 'priorities', 'q2-2025'],
                tasks: [
                    {
                        id: generateId(),
                        title: 'AI First, AI Native',
                        description: 'Every discussion about AI. Weave into everything - replace line of business apps or standalone AI. Target: $140M in Copilot Studio',
                        completed: false,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: generateId(),
                        title: 'Innovate Quickly',
                        description: 'Move fast, test messages, adapt to market shifts daily. Fail fast or succeed fast. Break glass approach.',
                        completed: false,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: generateId(),
                        title: 'Accelerate Revenue',
                        description: 'Drive from 19% to 24% growth. Target $50-80M per program lead. Q2 Goal: $500M',
                        completed: false,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: generateId(),
                        title: 'Accelerate Time to Value',
                        description: 'ERP: 2yr‚Üí1yr, CRM: 9mo‚Üí3-6mo, Contact center agents: 30-90 days',
                        completed: false,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: generateId(),
                        title: 'Break Glass / Stay Creative',
                        description: 'Operate outside the box. Don\'t conform to standard processes. Keep accelerating and taking market share.',
                        completed: false,
                        createdAt: new Date().toISOString()
                    }
                ],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                favorite: true
            };

            saveToStorage();
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Save to localStorage
        function saveToStorage() {
            appState.lastUpdated = new Date().toISOString();
            try {
                localStorage.setItem('noteforge_data', JSON.stringify(appState));
            } catch (e) {
                showNotification('Error saving data: ' + e.message, 'error');
            }
        }

        // Load from localStorage
        function loadFromStorage() {
            try {
                const stored = localStorage.getItem('noteforge_data');
                if (stored) {
                    const data = JSON.parse(stored);
                    appState = { ...appState, ...data };
                    
                    // Apply dark mode if saved
                    if (appState.darkMode) {
                        document.body.classList.add('dark-mode');
                    }
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        // Render sidebar
        function renderSidebar() {
            const quickAccessList = document.getElementById('quickAccessList');
            const allPagesList = document.getElementById('allPagesList');
            const tagsList = document.getElementById('tagsList');

            // Quick access (favorites)
            const favorites = Object.values(appState.pages).filter(p => p.favorite);
            quickAccessList.innerHTML = favorites.map(page => createPageListItem(page)).join('');

            // All pages
            const allPages = Object.values(appState.pages).sort((a, b) => 
                new Date(b.updatedAt) - new Date(a.updatedAt)
            );
            allPagesList.innerHTML = allPages.map(page => createPageListItem(page)).join('');

            // Tags
            const tags = {};
            Object.values(appState.pages).forEach(page => {
                if (page.tags) {
                    page.tags.forEach(tag => {
                        tags[tag] = (tags[tag] || 0) + 1;
                    });
                }
            });
            
            tagsList.innerHTML = Object.entries(tags)
                .sort((a, b) => b[1] - a[1])
                .map(([tag, count]) => `
                    <li class="page-item" onclick="filterByTag('${tag}')">
                        <span class="page-icon">üè∑Ô∏è</span>
                        <span class="page-title">${tag}</span>
                        <span style="margin-left: auto; font-size: 12px; color: var(--text-tertiary);">${count}</span>
                    </li>
                `).join('');
        }

        // Create page list item HTML
        function createPageListItem(page) {
            const isActive = page.id === appState.currentPageId;
            return `
                <li class="page-item ${isActive ? 'active' : ''}" onclick="loadPage('${page.id}')">
                    <span class="page-icon">${page.icon || 'üìÑ'}</span>
                    <span class="page-title">${escapeHtml(page.title)}</span>
                    <div class="page-actions">
                        <button class="page-action-btn" onclick="event.stopPropagation(); toggleFavorite('${page.id}')" 
                                title="${page.favorite ? 'Unfavorite' : 'Favorite'}">
                            ${page.favorite ? '‚òÖ' : '‚òÜ'}
                        </button>
                        <button class="page-action-btn" onclick="event.stopPropagation(); deletePage('${page.id}')" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </li>
            `;
        }

        // Load and display a page
        function loadPage(pageId) {
            const page = appState.pages[pageId];
            if (!page) return;

            appState.currentPageId = pageId;
            
            // Update breadcrumb
            document.getElementById('breadcrumb').innerHTML = `
                <span class="breadcrumb-item">
                    <span>${page.icon || 'üìÑ'}</span>
                    <span>${escapeHtml(page.title)}</span>
                </span>
            `;

            // Render page content based on type
            const wrapper = document.getElementById('contentWrapper');
            
            switch (page.type) {
                case 'note':
                    renderNotePage(page, wrapper);
                    break;
                case 'task':
                    renderTaskPage(page, wrapper);
                    break;
                case 'table':
                    renderTablePage(page, wrapper);
                    break;
                case 'kanban':
                    renderKanbanPage(page, wrapper);
                    break;
            }

            renderSidebar();
        }

        // Render note page
        function renderNotePage(page, container) {
            container.innerHTML = `
                <div class="page-header">
                    <textarea class="page-title-input" 
                              placeholder="Untitled" 
                              oninput="updatePageTitle(this.value)">${escapeHtml(page.title)}</textarea>
                    
                    <div class="page-meta">
                        <div class="meta-item">
                            <span>üìÖ</span>
                            <span>${formatDate(page.updatedAt)}</span>
                        </div>
                        <div class="meta-item">
                            <span>üè∑Ô∏è</span>
                            <div class="tags-container">
                                ${(page.tags || []).map(tag => `
                                    <span class="tag">
                                        ${tag}
                                        <span class="tag-remove" onclick="removeTag('${tag}')">‚úï</span>
                                    </span>
                                `).join('')}
                                <input type="text" class="tag-input" placeholder="Add tag..." 
                                       onkeypress="handleTagInput(event)">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="editor-container">
                    <div class="editor-toolbar">
                        <button class="toolbar-btn" onclick="execCommand('bold')" title="Bold">
                            <strong>B</strong>
                        </button>
                        <button class="toolbar-btn" onclick="execCommand('italic')" title="Italic">
                            <em>I</em>
                        </button>
                        <button class="toolbar-btn" onclick="execCommand('underline')" title="Underline">
                            <u>U</u>
                        </button>
                        <div class="toolbar-divider"></div>
                        <button class="toolbar-btn" onclick="execCommand('formatBlock', '<h1>')" title="Heading 1">
                            H1
                        </button>
                        <button class="toolbar-btn" onclick="execCommand('formatBlock', '<h2>')" title="Heading 2">
                            H2
                        </button>
                        <button class="toolbar-btn" onclick="execCommand('formatBlock', '<h3>')" title="Heading 3">
                            H3
                        </button>
                        <div class="toolbar-divider"></div>
                        <button class="toolbar-btn" onclick="execCommand('insertUnorderedList')" title="Bullet List">
                            ‚Ä¢ List
                        </button>
                        <button class="toolbar-btn" onclick="execCommand('insertOrderedList')" title="Numbered List">
                            1. List
                        </button>
                        <div class="toolbar-divider"></div>
                        <button class="toolbar-btn" onclick="execCommand('removeFormat')" title="Clear Format">
                            ‚úï
                        </button>
                    </div>
                    <div class="editor-content" 
                         contenteditable="true" 
                         id="pageContent"
                         oninput="updatePageContent()">${page.content || ''}</div>
                </div>
            `;
        }

        // Render task page
        function renderTaskPage(page, container) {
            const tasks = page.tasks || [];
            const completedCount = tasks.filter(t => t.completed).length;
            
            container.innerHTML = `
                <div class="page-header">
                    <textarea class="page-title-input" 
                              placeholder="Untitled" 
                              oninput="updatePageTitle(this.value)">${escapeHtml(page.title)}</textarea>
                    
                    <div class="page-meta">
                        <div class="meta-item">
                            <span>‚úì</span>
                            <span>${completedCount} of ${tasks.length} completed</span>
                        </div>
                        <div class="meta-item">
                            <span>üìÖ</span>
                            <span>${formatDate(page.updatedAt)}</span>
                        </div>
                        <div class="meta-item">
                            <span>üè∑Ô∏è</span>
                            <div class="tags-container">
                                ${(page.tags || []).map(tag => `
                                    <span class="tag">
                                        ${tag}
                                        <span class="tag-remove" onclick="removeTag('${tag}')">‚úï</span>
                                    </span>
                                `).join('')}
                                <input type="text" class="tag-input" placeholder="Add tag..." 
                                       onkeypress="handleTagInput(event)">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="task-view">
                    <div class="task-header">
                        <h3>Tasks</h3>
                        <button class="btn btn-primary" onclick="addNewTask()">‚ûï Add Task</button>
                    </div>
                    <div class="task-list" id="taskList">
                        ${tasks.map((task, index) => `
                            <div class="task-item ${task.completed ? 'completed' : ''}">
                                <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                                     onclick="toggleTaskComplete(${index})"></div>
                                <div class="task-content">
                                    <div class="task-title">${escapeHtml(task.title)}</div>
                                    ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                                </div>
                                <button class="page-action-btn" onclick="deleteTask(${index})" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `).join('')}
                        ${tasks.length === 0 ? `
                            <div class="empty-state">
                                <div class="empty-icon">‚úì</div>
                                <div class="empty-title">No tasks yet</div>
                                <div class="empty-description">Click "Add Task" to create your first task</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Render table page
        function renderTablePage(page, container) {
            const rows = page.rows || [];
            const columns = page.columns || ['Column 1', 'Column 2', 'Column 3'];
            
            container.innerHTML = `
                <div class="page-header">
                    <textarea class="page-title-input" 
                              placeholder="Untitled" 
                              oninput="updatePageTitle(this.value)">${escapeHtml(page.title)}</textarea>
                    
                    <div class="page-meta">
                        <div class="meta-item">
                            <span>üìä</span>
                            <span>${rows.length} rows</span>
                        </div>
                        <div class="meta-item">
                            <span>üìÖ</span>
                            <span>${formatDate(page.updatedAt)}</span>
                        </div>
                        <div class="meta-item">
                            <span>üè∑Ô∏è</span>
                            <div class="tags-container">
                                ${(page.tags || []).map(tag => `
                                    <span class="tag">
                                        ${tag}
                                        <span class="tag-remove" onclick="removeTag('${tag}')">‚úï</span>
                                    </span>
                                `).join('')}
                                <input type="text" class="tag-input" placeholder="Add tag..." 
                                       onkeypress="handleTagInput(event)">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <button class="btn btn-primary" onclick="addTableRow()">‚ûï Add Row</button>
                    <button class="btn btn-secondary" onclick="addTableColumn()">‚ûï Add Column</button>
                </div>

                <div class="table-view">
                    <table class="data-table">
                        <thead>
                            <tr>
                                ${columns.map((col, i) => `
                                    <th contenteditable="true" oninput="updateColumnName(${i}, this.textContent)">
                                        ${escapeHtml(col)}
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map((row, rowIndex) => `
                                <tr>
                                    ${columns.map((col, colIndex) => `
                                        <td contenteditable="true" 
                                            oninput="updateTableCell(${rowIndex}, ${colIndex}, this.textContent)">
                                            ${escapeHtml(row[colIndex] || '')}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Render kanban page
        function renderKanbanPage(page, container) {
            const columns = page.kanbanColumns || [
                { id: 'todo', title: 'To Do', cards: [] },
                { id: 'inprogress', title: 'In Progress', cards: [] },
                { id: 'done', title: 'Done', cards: [] }
            ];
            
            container.innerHTML = `
                <div class="page-header">
                    <textarea class="page-title-input" 
                              placeholder="Untitled" 
                              oninput="updatePageTitle(this.value)">${escapeHtml(page.title)}</textarea>
                    
                    <div class="page-meta">
                        <div class="meta-item">
                            <span>üìÖ</span>
                            <span>${formatDate(page.updatedAt)}</span>
                        </div>
                        <div class="meta-item">
                            <span>üè∑Ô∏è</span>
                            <div class="tags-container">
                                ${(page.tags || []).map(tag => `
                                    <span class="tag">
                                        ${tag}
                                        <span class="tag-remove" onclick="removeTag('${tag}')">‚úï</span>
                                    </span>
                                `).join('')}
                                <input type="text" class="tag-input" placeholder="Add tag..." 
                                       onkeypress="handleTagInput(event)">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="kanban-view">
                    ${columns.map((column, colIndex) => `
                        <div class="kanban-column">
                            <div class="kanban-header">
                                <span>${column.title}</span>
                                <span class="kanban-count">${column.cards.length}</span>
                            </div>
                            <div class="kanban-cards">
                                ${column.cards.map((card, cardIndex) => `
                                    <div class="kanban-card">
                                        <div class="card-title">${escapeHtml(card.title)}</div>
                                        ${card.description ? `<div class="card-meta">${escapeHtml(card.description)}</div>` : ''}
                                    </div>
                                `).join('')}
                                ${column.cards.length === 0 ? `
                                    <div style="text-align: center; padding: 40px 20px; color: var(--text-tertiary); font-size: 14px;">
                                        No cards yet
                                    </div>
                                ` : ''}
                            </div>
                            <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" 
                                    onclick="addKanbanCard(${colIndex})">
                                ‚ûï Add Card
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Update page title
        function updatePageTitle(title) {
            if (appState.currentPageId) {
                appState.pages[appState.currentPageId].title = title;
                appState.pages[appState.currentPageId].updatedAt = new Date().toISOString();
                saveToStorage();
                renderSidebar();
            }
        }

        // Update page content (for notes)
        function updatePageContent() {
            if (appState.currentPageId) {
                const content = document.getElementById('pageContent').innerHTML;
                appState.pages[appState.currentPageId].content = content;
                appState.pages[appState.currentPageId].updatedAt = new Date().toISOString();
                saveToStorage();
            }
        }

        // Execute rich text command
        function execCommand(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('pageContent').focus();
        }

        // Handle tag input
        function handleTagInput(event) {
            if (event.key === 'Enter' && event.target.value.trim()) {
                const tag = event.target.value.trim().toLowerCase();
                const page = appState.pages[appState.currentPageId];
                
                if (!page.tags) page.tags = [];
                if (!page.tags.includes(tag)) {
                    page.tags.push(tag);
                    page.updatedAt = new Date().toISOString();
                    saveToStorage();
                    loadPage(appState.currentPageId);
                }
                
                event.target.value = '';
            }
        }

        // Remove tag
        function removeTag(tag) {
            const page = appState.pages[appState.currentPageId];
            if (page.tags) {
                page.tags = page.tags.filter(t => t !== tag);
                page.updatedAt = new Date().toISOString();
                saveToStorage();
                loadPage(appState.currentPageId);
            }
        }

        // Toggle favorite
        function toggleFavorite(pageId) {
            appState.pages[pageId].favorite = !appState.pages[pageId].favorite;
            saveToStorage();
            renderSidebar();
        }

        // Add new task
        function addNewTask() {
            const title = prompt('Task title:');
            if (title && title.trim()) {
                const page = appState.pages[appState.currentPageId];
                if (!page.tasks) page.tasks = [];
                
                page.tasks.push({
                    id: generateId(),
                    title: title.trim(),
                    description: '',
                    completed: false,
                    createdAt: new Date().toISOString()
                });
                
                page.updatedAt = new Date().toISOString();
                saveToStorage();
                loadPage(appState.currentPageId);
            }
        }

        // Toggle task complete
        function toggleTaskComplete(index) {
            const page = appState.pages[appState.currentPageId];
            page.tasks[index].completed = !page.tasks[index].completed;
            page.updatedAt = new Date().toISOString();
            saveToStorage();
            loadPage(appState.currentPageId);
        }

        // Delete task
        function deleteTask(index) {
            if (confirm('Delete this task?')) {
                const page = appState.pages[appState.currentPageId];
                page.tasks.splice(index, 1);
                page.updatedAt = new Date().toISOString();
                saveToStorage();
                loadPage(appState.currentPageId);
            }
        }

        // Add table row
        function addTableRow() {
            const page = appState.pages[appState.currentPageId];
            if (!page.rows) page.rows = [];
            if (!page.columns) page.columns = ['Column 1', 'Column 2', 'Column 3'];
            
            page.rows.push(new Array(page.columns.length).fill(''));
            page.updatedAt = new Date().toISOString();
            saveToStorage();
            loadPage(appState.currentPageId);
        }

        // Add table column
        function addTableColumn() {
            const page = appState.pages[appState.currentPageId];
            if (!page.columns) page.columns = [];
            if (!page.rows) page.rows = [];
            
            page.columns.push(`Column ${page.columns.length + 1}`);
            page.rows.forEach(row => row.push(''));
            page.updatedAt = new Date().toISOString();
            saveToStorage();
            loadPage(appState.currentPageId);
        }

        // Update column name
        function updateColumnName(index, name) {
            const page = appState.pages[appState.currentPageId];
            page.columns[index] = name;
            page.updatedAt = new Date().toISOString();
            saveToStorage();
        }

        // Update table cell
        function updateTableCell(rowIndex, colIndex, value) {
            const page = appState.pages[appState.currentPageId];
            page.rows[rowIndex][colIndex] = value;
            page.updatedAt = new Date().toISOString();
            saveToStorage();
        }

        // Add kanban card
        function addKanbanCard(columnIndex) {
            const title = prompt('Card title:');
            if (title && title.trim()) {
                const page = appState.pages[appState.currentPageId];
                if (!page.kanbanColumns) {
                    page.kanbanColumns = [
                        { id: 'todo', title: 'To Do', cards: [] },
                        { id: 'inprogress', title: 'In Progress', cards: [] },
                        { id: 'done', title: 'Done', cards: [] }
                    ];
                }
                
                page.kanbanColumns[columnIndex].cards.push({
                    id: generateId(),
                    title: title.trim(),
                    description: ''
                });
                
                page.updatedAt = new Date().toISOString();
                saveToStorage();
                loadPage(appState.currentPageId);
            }
        }

        // Open new page modal
        function openNewPageModal() {
            document.getElementById('newPageModal').classList.add('active');
            document.getElementById('newPageTitle').focus();
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Create new page
        function createNewPage() {
            const title = document.getElementById('newPageTitle').value.trim();
            const type = document.getElementById('newPageType').value;
            const icon = document.getElementById('newPageIcon').value.trim() || 'üìÑ';
            const tags = document.getElementById('newPageTags').value
                .split(',')
                .map(t => t.trim().toLowerCase())
                .filter(t => t);

            if (!title) {
                showNotification('Please enter a page title', 'error');
                return;
            }

            const pageId = generateId();
            const newPage = {
                id: pageId,
                title: title,
                type: type,
                icon: icon,
                tags: tags,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                favorite: false
            };

            // Initialize type-specific data
            switch (type) {
                case 'note':
                    newPage.content = '';
                    break;
                case 'task':
                    newPage.tasks = [];
                    break;
                case 'table':
                    newPage.columns = ['Column 1', 'Column 2', 'Column 3'];
                    newPage.rows = [];
                    break;
                case 'kanban':
                    newPage.kanbanColumns = [
                        { id: 'todo', title: 'To Do', cards: [] },
                        { id: 'inprogress', title: 'In Progress', cards: [] },
                        { id: 'done', title: 'Done', cards: [] }
                    ];
                    break;
            }

            appState.pages[pageId] = newPage;
            saveToStorage();
            closeModal('newPageModal');
            
            // Clear form
            document.getElementById('newPageTitle').value = '';
            document.getElementById('newPageIcon').value = '';
            document.getElementById('newPageTags').value = '';
            
            renderSidebar();
            loadPage(pageId);
            showNotification('Page created successfully!');
        }

        // Create quick page (default note)
        function createQuickPage() {
            const pageId = generateId();
            const newPage = {
                id: pageId,
                title: 'Untitled',
                type: 'note',
                icon: 'üìÑ',
                tags: [],
                content: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                favorite: false
            };

            appState.pages[pageId] = newPage;
            saveToStorage();
            renderSidebar();
            loadPage(pageId);
            
            // Focus on title
            setTimeout(() => {
                const titleInput = document.querySelector('.page-title-input');
                if (titleInput) {
                    titleInput.select();
                }
            }, 100);
        }

        // Delete page
        function deletePage(pageId) {
            if (confirm('Are you sure you want to delete this page?')) {
                delete appState.pages[pageId];
                
                if (appState.currentPageId === pageId) {
                    const firstPage = Object.keys(appState.pages)[0];
                    if (firstPage) {
                        loadPage(firstPage);
                    } else {
                        showEmptyState();
                    }
                }
                
                saveToStorage();
                renderSidebar();
                showNotification('Page deleted');
            }
        }

        // Search pages
        function searchPages(query) {
            if (!query.trim()) {
                renderSidebar();
                return;
            }

            const results = Object.values(appState.pages).filter(page => {
                const searchText = `${page.title} ${page.tags?.join(' ') || ''} ${page.content || ''}`.toLowerCase();
                return searchText.includes(query.toLowerCase());
            });

            const allPagesList = document.getElementById('allPagesList');
            allPagesList.innerHTML = results.map(page => createPageListItem(page)).join('');
        }

        // Filter by tag
        function filterByTag(tag) {
            const results = Object.values(appState.pages).filter(page => 
                page.tags && page.tags.includes(tag)
            );

            const allPagesList = document.getElementById('allPagesList');
            allPagesList.innerHTML = results.map(page => createPageListItem(page)).join('');
            
            document.getElementById('searchInput').value = `tag:${tag}`;
        }

        // Toggle dark mode
        function toggleDarkMode() {
            appState.darkMode = !appState.darkMode;
            document.body.classList.toggle('dark-mode');
            saveToStorage();
        }

        // Toggle sidebar
        function toggleSidebar() {
            appState.sidebarCollapsed = !appState.sidebarCollapsed;
            document.getElementById('sidebar').classList.toggle('collapsed');
            saveToStorage();
        }

        // Export all data
        function exportAllData() {
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `noteforge-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!');
        }

        // Export selected pages
        function exportSelectedPages(pageIds) {
            const exportData = {
                pages: {},
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            pageIds.forEach(id => {
                if (appState.pages[id]) {
                    exportData.pages[id] = appState.pages[id];
                }
            });
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `noteforge-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`Exported ${pageIds.length} page(s)!`);
        }

        // Smart merge import - merges changes without deleting existing data
        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Show import options modal
                    showImportOptionsModal(imported);
                } catch (error) {
                    showNotification('Error importing data: ' + error.message, 'error');
                }
                
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        // Show import options modal
        function showImportOptionsModal(importedData) {
            const importedPages = importedData.pages || {};
            const importedPagesList = Object.values(importedPages);
            
            const existingCount = importedPagesList.filter(p => appState.pages[p.id]).length;
            const newCount = importedPagesList.length - existingCount;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'importOptionsModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">Import Data</h2>
                        <button class="modal-close" onclick="closeImportModal()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">Import Summary:</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">
                                ‚Ä¢ ${importedPagesList.length} total page(s) in file<br>
                                ‚Ä¢ ${newCount} new page(s) will be added<br>
                                ‚Ä¢ ${existingCount} existing page(s) detected
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Import Mode:</label>
                            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 8px;">
                                <label style="display: flex; align-items: start; gap: 10px; cursor: pointer; padding: 12px; background: var(--bg-secondary); border-radius: 6px; border: 2px solid transparent;" 
                                       onmouseover="this.style.borderColor='var(--primary)'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='transparent'">
                                    <input type="radio" name="importMode" value="merge" checked onchange="updateImportModeLabel(this)">
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 4px;">üîÑ Smart Merge (Recommended)</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">
                                            Keeps all existing pages and adds/updates pages from import. 
                                            For existing pages, uses newer version based on updatedAt timestamp.
                                        </div>
                                    </div>
                                </label>
                                
                                <label style="display: flex; align-items: start; gap: 10px; cursor: pointer; padding: 12px; background: var(--bg-secondary); border-radius: 6px; border: 2px solid transparent;" 
                                       onmouseover="this.style.borderColor='var(--warning)'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='transparent'">
                                    <input type="radio" name="importMode" value="add-only" onchange="updateImportModeLabel(this)">
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 4px;">‚ûï Add New Only</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">
                                            Only adds new pages. Skips pages that already exist (by ID).
                                            Safest option - no existing data will be modified.
                                        </div>
                                    </div>
                                </label>
                                
                                <label style="display: flex; align-items: start; gap: 10px; cursor: pointer; padding: 12px; background: var(--bg-secondary); border-radius: 6px; border: 2px solid transparent;" 
                                       onmouseover="this.style.borderColor='var(--danger)'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='transparent'">
                                    <input type="radio" name="importMode" value="replace" onchange="updateImportModeLabel(this)">
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 4px;">‚ö†Ô∏è Replace All</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">
                                            Deletes all current data and replaces with imported data.
                                            Use only if you want a complete restore from backup.
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; font-size: 13px; color: var(--text-secondary);">
                            üí° <strong>Tip:</strong> Export your current data before importing if you want a backup!
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="executeImport()">Import</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store imported data temporarily
            window.pendingImport = importedData;
            
            // Update selected radio button styling
            updateImportModeLabel(document.querySelector('input[name="importMode"]:checked'));
        }

        // Update import mode label styling
        function updateImportModeLabel(radio) {
            document.querySelectorAll('input[name="importMode"]').forEach(r => {
                const label = r.closest('label');
                if (r.checked) {
                    label.style.borderColor = r.value === 'replace' ? 'var(--danger)' : 
                                             r.value === 'add-only' ? 'var(--warning)' : 
                                             'var(--primary)';
                    label.style.background = r.value === 'replace' ? 'rgba(239, 68, 68, 0.1)' : 
                                            r.value === 'add-only' ? 'rgba(245, 158, 11, 0.1)' : 
                                            'rgba(99, 102, 241, 0.1)';
                } else {
                    label.style.borderColor = 'transparent';
                    label.style.background = 'var(--bg-secondary)';
                }
            });
        }

        // Close import modal
        function closeImportModal() {
            const modal = document.getElementById('importOptionsModal');
            if (modal) {
                modal.remove();
            }
            window.pendingImport = null;
        }

        // Execute the import based on selected mode
        function executeImport() {
            const importMode = document.querySelector('input[name="importMode"]:checked')?.value || 'merge';
            const importedData = window.pendingImport;
            
            if (!importedData) {
                showNotification('No import data found', 'error');
                return;
            }
            
            try {
                let result = { added: 0, updated: 0, skipped: 0, deleted: 0 };
                
                switch (importMode) {
                    case 'merge':
                        result = smartMergeImport(importedData);
                        break;
                    case 'add-only':
                        result = addOnlyImport(importedData);
                        break;
                    case 'replace':
                        if (confirm('‚ö†Ô∏è This will DELETE all existing data. Are you absolutely sure?')) {
                            result = replaceAllImport(importedData);
                        } else {
                            closeImportModal();
                            return;
                        }
                        break;
                }
                
                saveToStorage();
                renderSidebar();
                
                const firstPage = Object.keys(appState.pages)[0];
                if (firstPage) {
                    loadPage(firstPage);
                }
                
                closeImportModal();
                
                // Show detailed result
                showImportResults(result, importMode);
                
            } catch (error) {
                showNotification('Error during import: ' + error.message, 'error');
            }
        }

        // Smart merge: Add new pages, update existing with newer version
        function smartMergeImport(importedData) {
            const result = { added: 0, updated: 0, skipped: 0, deleted: 0 };
            const importedPages = importedData.pages || {};
            
            Object.entries(importedPages).forEach(([id, page]) => {
                if (appState.pages[id]) {
                    // Page exists - compare timestamps and use newer version
                    const existingDate = new Date(appState.pages[id].updatedAt || 0);
                    const importedDate = new Date(page.updatedAt || 0);
                    
                    if (importedDate > existingDate) {
                        // Imported version is newer - update it
                        appState.pages[id] = { ...page };
                        result.updated++;
                    } else {
                        // Existing version is newer or same - skip
                        result.skipped++;
                    }
                } else {
                    // New page - add it
                    appState.pages[id] = { ...page };
                    result.added++;
                }
            });
            
            // Update appState metadata if present
            if (importedData.darkMode !== undefined) {
                appState.darkMode = importedData.darkMode;
            }
            
            return result;
        }

        // Add only: Only add pages that don't exist
        function addOnlyImport(importedData) {
            const result = { added: 0, updated: 0, skipped: 0, deleted: 0 };
            const importedPages = importedData.pages || {};
            
            Object.entries(importedPages).forEach(([id, page]) => {
                if (!appState.pages[id]) {
                    // New page - add it
                    appState.pages[id] = { ...page };
                    result.added++;
                } else {
                    // Page exists - skip it
                    result.skipped++;
                }
            });
            
            return result;
        }

        // Replace all: Delete everything and import
        function replaceAllImport(importedData) {
            const result = { added: 0, updated: 0, skipped: 0, deleted: Object.keys(appState.pages).length };
            
            // Replace entire state
            appState = {
                pages: {},
                currentPageId: null,
                darkMode: importedData.darkMode || false,
                sidebarCollapsed: importedData.sidebarCollapsed || false,
                lastUpdated: new Date().toISOString()
            };
            
            const importedPages = importedData.pages || {};
            Object.entries(importedPages).forEach(([id, page]) => {
                appState.pages[id] = { ...page };
                result.added++;
            });
            
            // Apply dark mode
            if (appState.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            return result;
        }

        // Show import results
        function showImportResults(result, mode) {
            const modeNames = {
                'merge': 'Smart Merge',
                'add-only': 'Add New Only',
                'replace': 'Replace All'
            };
            
            const messages = [];
            if (result.added > 0) messages.push(`${result.added} page(s) added`);
            if (result.updated > 0) messages.push(`${result.updated} page(s) updated`);
            if (result.skipped > 0) messages.push(`${result.skipped} page(s) skipped`);
            if (result.deleted > 0) messages.push(`${result.deleted} page(s) deleted`);
            
            const message = messages.length > 0 ? messages.join(', ') : 'No changes made';
            
            const notification = document.createElement('div');
            notification.className = 'notification success';
            notification.style.maxWidth = '500px';
            notification.innerHTML = `
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px;">‚úÖ Import Complete (${modeNames[mode]})</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Show empty state
        function showEmptyState() {
            document.getElementById('contentWrapper').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <div class="empty-title">No pages yet</div>
                    <div class="empty-description">Create your first page to get started</div>
                    <button class="btn btn-primary" onclick="openNewPageModal()" style="margin-top: 16px;">
                        ‚ûï Create Page
                    </button>
                </div>
            `;
        }

        // Open command palette
        function openCommandPalette() {
            const palette = document.getElementById('commandPalette');
            palette.classList.add('active');
            document.getElementById('commandInput').focus();
            filterCommands('');
        }

        // Close command palette
        function closeCommandPalette() {
            document.getElementById('commandPalette').classList.remove('active');
            document.getElementById('commandInput').value = '';
        }

        // Filter commands
        function filterCommands(query) {
            const commands = [
                { icon: 'üìÑ', name: 'New Note', desc: 'Create a new note page', action: () => { document.getElementById('newPageType').value = 'note'; openNewPageModal(); } },
                { icon: '‚úì', name: 'New Task List', desc: 'Create a new task list', action: () => { document.getElementById('newPageType').value = 'task'; openNewPageModal(); } },
                { icon: 'üìä', name: 'New Table', desc: 'Create a new table', action: () => { document.getElementById('newPageType').value = 'table'; openNewPageModal(); } },
                { icon: 'üìã', name: 'New Kanban', desc: 'Create a new kanban board', action: () => { document.getElementById('newPageType').value = 'kanban'; openNewPageModal(); } },
                { icon: 'üì•', name: 'Export Data', desc: 'Download all data as JSON', action: exportAllData },
                { icon: 'üì§', name: 'Import Data', desc: 'Import data from JSON', action: () => document.getElementById('importFile').click() },
                { icon: 'üåô', name: 'Toggle Dark Mode', desc: 'Switch between light and dark theme', action: toggleDarkMode },
                { icon: 'üóëÔ∏è', name: 'Delete Current Page', desc: 'Delete the current page', action: () => appState.currentPageId && deletePage(appState.currentPageId) }
            ];

            // Add all pages to commands
            Object.values(appState.pages).forEach(page => {
                commands.push({
                    icon: page.icon || 'üìÑ',
                    name: page.title,
                    desc: `Open ${page.type} page`,
                    action: () => loadPage(page.id)
                });
            });

            const filtered = commands.filter(cmd => 
                cmd.name.toLowerCase().includes(query.toLowerCase()) ||
                cmd.desc.toLowerCase().includes(query.toLowerCase())
            );

            const resultsDiv = document.getElementById('commandResults');
            resultsDiv.innerHTML = filtered.map((cmd, index) => `
                <div class="command-item ${index === 0 ? 'selected' : ''}" 
                     onclick="executeCommand(${commands.indexOf(cmd)})">
                    <span class="command-icon">${cmd.icon}</span>
                    <div class="command-text">
                        <div class="command-name">${cmd.name}</div>
                        <div class="command-desc">${cmd.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        // Execute command
        function executeCommand(index) {
            const commands = Array.from(document.querySelectorAll('.command-item'));
            const commandData = getAllCommands()[index];
            
            if (commandData && commandData.action) {
                commandData.action();
                closeCommandPalette();
            }
        }

        // Get all commands
        function getAllCommands() {
            const commands = [
                { icon: 'üìÑ', name: 'New Note', desc: 'Create a new note page', action: () => { document.getElementById('newPageType').value = 'note'; openNewPageModal(); } },
                { icon: '‚úì', name: 'New Task List', desc: 'Create a new task list', action: () => { document.getElementById('newPageType').value = 'task'; openNewPageModal(); } },
                { icon: 'üìä', name: 'New Table', desc: 'Create a new table', action: () => { document.getElementById('newPageType').value = 'table'; openNewPageModal(); } },
                { icon: 'üìã', name: 'New Kanban', desc: 'Create a new kanban board', action: () => { document.getElementById('newPageType').value = 'kanban'; openNewPageModal(); } },
                { icon: 'üì•', name: 'Export Data', desc: 'Download all data as JSON', action: exportAllData },
                { icon: 'üì§', name: 'Import Data', desc: 'Import data from JSON', action: () => document.getElementById('importFile').click() },
                { icon: 'üåô', name: 'Toggle Dark Mode', desc: 'Switch between light and dark theme', action: toggleDarkMode },
                { icon: 'üóëÔ∏è', name: 'Delete Current Page', desc: 'Delete the current page', action: () => appState.currentPageId && deletePage(appState.currentPageId) }
            ];

            Object.values(appState.pages).forEach(page => {
                commands.push({
                    icon: page.icon || 'üìÑ',
                    name: page.title,
                    desc: `Open ${page.type} page`,
                    action: () => loadPage(page.id)
                });
            });

            return commands;
        }

        // Setup keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K: Open command palette
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    if (document.getElementById('commandPalette').classList.contains('active')) {
                        closeCommandPalette();
                    } else {
                        openCommandPalette();
                    }
                }

                // Escape: Close modals and command palette
                if (e.key === 'Escape') {
                    closeCommandPalette();
                    closeModal('newPageModal');
                }

                // Ctrl/Cmd + N: New page
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    openNewPageModal();
                }

                // Ctrl/Cmd + S: Save (already auto-saves, but good UX)
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveToStorage();
                    showNotification('Saved!');
                }
            });

            // Click outside command palette to close
            document.getElementById('commandPalette').addEventListener('click', (e) => {
                if (e.target.id === 'commandPalette') {
                    closeCommandPalette();
                }
            });

            // Enter in command palette
            document.getElementById('commandInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const selected = document.querySelector('.command-item.selected');
                    if (selected) {
                        selected.click();
                    }
                }
            });
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Utility: Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        // Utility: Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-save every 30 seconds
        setInterval(() => {
            if (Object.keys(appState.pages).length > 0) {
                saveToStorage();
            }
        }, 30000);

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
