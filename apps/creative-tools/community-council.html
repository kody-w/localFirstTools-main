<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Council</title>
<meta name="rappterzoo:author" content="MoltEngine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="creative-tools">
<meta name="rappterzoo:tags" content="community,council,voting,npc,deliberation,molting">
<meta name="rappterzoo:type" content="interactive">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d1117;--panel:#161b22;--border:#30363d;--text:#c9d1d9;
  --accent:#58a6ff;--green:#3fb950;--red:#f85149;--yellow:#d29922;
  --purple:#bc8cff;--orange:#f0883e;--chat-bg:#1c2128;
}
html,body{height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text)}
  .btn {
    padding: 8px 16px; border: 1px solid var(--gold-dim); background: rgba(212,168,67,0.1);
    color: var(--gold); border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s;
    font-family: var(--font-sans); white-space: nowrap;
  }
  .btn:hover { background: rgba(212,168,67,0.25); box-shadow: 0 0 12px rgba(212,168,67,0.2); }
  .btn-primary { background: var(--gold-dim); color: #fff; border-color: var(--gold); }
  .btn-primary:hover { background: var(--gold); color: #1a1815; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  .btn-green { border-color: var(--green); color: var(--green); background: rgba(76,175,80,0.1); }
  .btn-green:hover { background: rgba(76,175,80,0.25); }
  .btn-red { border-color: var(--red); color: var(--red); background: rgba(239,83,80,0.1); }
  .btn-red:hover { background: rgba(239,83,80,0.25); }
  .btn-blue { border-color: var(--blue); color: var(--blue); background: rgba(66,165,245,0.1); }
  .btn-blue:hover { background: rgba(66,165,245,0.25); }
  .main { display: flex; height: calc(100vh - 76px); }
  .sidebar {
    width: 260px; min-width: 260px; background: var(--bg-panel);
    border-right: 1px solid rgba(212,168,67,0.15); display: flex; flex-direction: column; overflow-y: auto;
  }
  .sidebar-section { padding: 16px; border-bottom: 1px solid rgba(212,168,67,0.1); }
  .sidebar-title {
    font-family: var(--font-serif); font-size: 13px; color: var(--gold);
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;
  }
  .participant {
    display: flex; align-items: center; gap: 10px; padding: 8px 10px;
    border-radius: 6px; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; border: 1px solid transparent;
  }
  .participant:hover { background: rgba(212,168,67,0.08); }
  .participant.active { background: rgba(212,168,67,0.15); border-color: var(--gold-dim); }
  .p-color {
    width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-weight: bold; font-size: 13px; color: #fff; flex-shrink: 0;
  }
  .p-info { flex: 1; }
  .p-name { font-size: 13px; font-weight: 600; }
  .p-stats { font-size: 10px; color: var(--text-sec); }
  .add-participant-form { display: flex; gap: 6px; margin-top: 8px; }
  .add-participant-form input {
    flex: 1; padding: 6px 10px; background: var(--bg-input);
    border: 1px solid rgba(212,168,67,0.2); color: var(--text); border-radius: 4px; font-size: 12px; outline: none;
  }
  .add-participant-form input:focus { border-color: var(--gold); }
  .sf-item {
    display: flex; align-items: center; gap: 8px; padding: 6px 8px;
    border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.15s;
  }
  .sf-item:hover { background: rgba(212,168,67,0.08); }
  .sf-item.active { background: rgba(212,168,67,0.15); }
  .sf-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
  .sf-count { margin-left: auto; font-size: 11px; color: var(--text-dim); }
  .consensus-meter { background: rgba(255,255,255,0.05); border-radius: 20px; height: 16px; overflow: hidden; }
  .consensus-fill { height: 100%; border-radius: 20px; background: linear-gradient(90deg, var(--red), var(--amber), var(--green)); transition: width 0.5s ease; }
  .consensus-label { font-size: 11px; color: var(--text-sec); margin-top: 4px; text-align: center; }
  .content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .content-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
  .content-title { font-family: var(--font-serif); font-size: 20px; color: var(--gold); }
  .search-box {
    padding: 8px 14px; background: var(--bg-input); border: 1px solid rgba(212,168,67,0.2);
    color: var(--text); border-radius: 6px; font-size: 13px; outline: none; width: 240px;
  }
  .search-box:focus { border-color: var(--gold); }
  .proposal-card {
    background: var(--bg-card); border: 1px solid rgba(212,168,67,0.1); border-radius: 10px;
    padding: 18px; cursor: pointer; transition: all 0.25s;
  }
  .proposal-card:hover {
    border-color: rgba(212,168,67,0.3); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  .proposal-card-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
  .proposal-title { font-family: var(--font-serif); font-size: 17px; font-weight: 600; flex: 1; }
  .status-badge { font-size: 11px; padding: 3px 10px; border-radius: 12px; font-weight: 600; white-space: nowrap; }
  .status-discussion { background: rgba(66,165,245,0.2); color: var(--blue); }
  .status-voting { background: rgba(255,179,0,0.2); color: var(--amber); }
  .status-decided { background: rgba(76,175,80,0.2); color: var(--green); }
  .status-archived { background: rgba(158,158,158,0.2); color: var(--gray); }
  .proposal-desc { font-size: 13px; color: var(--text-sec); line-height: 1.5; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .proposal-meta { display: flex; align-items: center; gap: 14px; font-size: 12px; color: var(--text-dim); flex-wrap: wrap; }
  .author-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .vote-bar { height: 8px; border-radius: 4px; background: rgba(255,255,255,0.05); display: flex; overflow: hidden; margin-top: 10px; }
  .vote-bar-segment { height: 100%; transition: width 0.4s ease; }
  .vb-support { background: linear-gradient(90deg, var(--green-dark), var(--green)); }
  .vb-oppose { background: linear-gradient(90deg, var(--red-dark), var(--red)); }
  .vb-abstain { background: rgba(158,158,158,0.5); }
  .vote-counts { display: flex; justify-content: space-between; font-size: 11px; margin-top: 4px; color: var(--text-sec); }
  .detail-view { display: none; flex-direction: column; gap: 16px; }
  .detail-view.active { display: flex; }
  .list-view.hidden { display: none; }
  .detail-back { cursor: pointer; color: var(--gold); font-size: 13px; padding: 6px 0; }
  .detail-back:hover { opacity: 0.7; }
  .detail-header { background: var(--bg-card); border: 1px solid rgba(212,168,67,0.15); border-radius: 10px; padding: 24px; }
  .detail-title { font-family: var(--font-serif); font-size: 24px; margin-bottom: 8px; }
  .detail-full-desc { font-size: 14px; color: var(--text-sec); line-height: 1.7; white-space: pre-wrap; margin: 12px 0; }
  .detail-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
  .voting-section, .discussion-section { background: var(--bg-card); border: 1px solid rgba(212,168,67,0.15); border-radius: 10px; padding: 20px; }
  .section-title { font-family: var(--font-serif); font-size: 16px; color: var(--gold); margin-bottom: 14px; }
  .vote-buttons { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
  .vote-btn {
    padding: 10px 24px; border-radius: 8px; border: 2px solid transparent;
    cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;
    background: rgba(255,255,255,0.05); color: var(--text-sec);
  }
  .vote-btn:hover { transform: scale(1.05); }
  .vote-btn.vt-support { border-color: var(--green); color: var(--green); }
  .vote-btn.vt-support.voted { background: var(--green); color: #fff; }
  .vote-btn.vt-oppose { border-color: var(--red); color: var(--red); }
  .vote-btn.vt-oppose.voted { background: var(--red); color: #fff; }
  .vote-btn.vt-abstain { border-color: var(--gray); color: var(--gray); }
  .vote-btn.vt-abstain.voted { background: var(--gray); color: #fff; }
  .vote-detail-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 12px; color: var(--text-sec); }
  .comment { display: flex; gap: 10px; margin-bottom: 14px; }
  .comment-avatar {
    width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-weight: bold; font-size: 13px; color: #fff; flex-shrink: 0; margin-top: 4px;
  }
  .comment-bubble {
    background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06);
    border-radius: 8px; padding: 10px 14px; flex: 1; position: relative;
  }
  .comment-bubble::before {
    content: ''; position: absolute; left: -6px; top: 12px; width: 0; height: 0;
    border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-right: 6px solid rgba(255,255,255,0.06);
  }
  .comment-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
  .comment-author { font-size: 12px; font-weight: 600; }
  .comment-time { font-size: 10px; color: var(--text-dim); }
  .comment-text { font-size: 13px; line-height: 1.5; color: var(--text-sec); }
  .comment-input-area { display: flex; gap: 8px; margin-top: 14px; }
  .comment-input-area textarea {
    flex: 1; padding: 10px 12px; background: var(--bg-input); border: 1px solid rgba(212,168,67,0.2);
    color: var(--text); border-radius: 6px; font-family: var(--font-sans); font-size: 13px; resize: none; min-height: 48px; outline: none;
  }
  .comment-input-area textarea:focus { border-color: var(--gold); }
  .decision-box { border-radius: 8px; padding: 16px; margin-top: 8px; }
  .decision-box.passed { background: rgba(76,175,80,0.08); border: 1px solid rgba(76,175,80,0.3); }
  .decision-box.rejected { background: rgba(239,83,80,0.08); border: 1px solid rgba(239,83,80,0.3); }
  .decision-label { font-family: var(--font-serif); font-size: 14px; font-weight: 600; }
  .decision-label.passed { color: var(--green); }
  .decision-label.rejected { color: var(--red); }
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bg-panel); border: 1px solid var(--gold-dim); border-radius: 12px;
    padding: 24px; width: 90%; max-width: 520px; max-height: 90vh; overflow-y: auto;
    box-shadow: 0 8px 40px rgba(0,0,0,0.5);
  }
  .modal h2 { font-family: var(--font-serif); color: var(--gold); font-size: 18px; margin-bottom: 16px; }
  .form-group { margin-bottom: 14px; }
  .form-group label { display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sec); margin-bottom: 6px; }
  .form-group input, .form-group textarea {
    width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid rgba(212,168,67,0.2);
    color: var(--text); border-radius: 6px; font-family: var(--font-sans); font-size: 14px; outline: none;
  }
  .form-group input:focus, .form-group textarea:focus { border-color: var(--gold); }
  .form-group textarea { min-height: 100px; resize: vertical; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
  .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(212,168,67,0.2); border-radius: 3px; }
  @media (max-width: 768px) {
    .sidebar { display: none; }
    .header-stats { display: none; }
    .search-box { width: 100%; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <span class="header-icon">&#x1F3DB;&#xFE0F;</span>
    <div>
      <div class="header-title">Community Council</div>
      <div class="header-sub">Local-first deliberation &amp; voting</div>
    </div>
  </div>
  <div class="header-stats">
    <div class="h-stat"><div class="h-stat-val" id="statProposals">0</div><div class="h-stat-label">Proposals</div></div>
    <div class="h-stat"><div class="h-stat-val" id="statPassRate">--%</div><div class="h-stat-label">Pass Rate</div></div>
    <div class="h-stat"><div class="h-stat-val" id="statParticipation">--%</div><div class="h-stat-label">Participation</div></div>
  </div>
  <div class="header-actions">
    <select id="activeParticipantSelect" style="padding:6px 10px;background:var(--bg-input);border:1px solid var(--gold-dim);color:var(--gold);border-radius:6px;font-size:12px;outline:none;">
      <option value="">Select participant...</option>
    </select>
    <button class="btn btn-primary" onclick="openProposalModal()">+ New Proposal</button>
  </div>
</div>

<div class="main">
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">Participants</div>
      <div id="participantList"></div>
      <div class="add-participant-form">
        <input type="text" id="newParticipantName" placeholder="Add participant..." maxlength="20">
        <button class="btn btn-sm" onclick="addParticipant()">+</button>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Filter by Status</div>
      <div id="statusFilters"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Consensus Meter</div>
      <div class="consensus-meter"><div class="consensus-fill" id="consensusFill" style="width:50%"></div></div>
      <div class="consensus-label" id="consensusLabel">No active votes</div>
    </div>
  </div>

  <div class="content">
    <div class="list-view" id="listView">
      <div class="content-header">
        <div class="content-title" id="contentTitle">All Proposals</div>
        <input type="text" class="search-box" id="searchBox" placeholder="Search proposals..." oninput="renderProposals()">
      </div>
      <div id="proposalsGrid" style="display:flex;flex-direction:column;gap:12px;"></div>
    </div>
    <div class="detail-view" id="detailView">
      <div class="detail-back" onclick="showList()">&#8592; Back to proposals</div>
      <div class="detail-header" id="detailHeader"></div>
      <div class="voting-section" id="votingSection" style="display:none"></div>
      <div class="discussion-section" id="discussionSection"></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="proposalModal">
  <div class="modal">
    <h2 id="proposalModalTitle">New Proposal</h2>
    <input type="hidden" id="editProposalId">
    <div class="form-group"><label>Title</label><input type="text" id="propTitleInput" placeholder="What should we decide?" maxlength="100"></div>
    <div class="form-group"><label>Description</label><textarea id="propDescInput" placeholder="Provide context and details..."></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-red" onclick="closeProposalModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProposal()">Submit Proposal</button>
    </div>
  </div>
</div>

<script>
const KEYS = { proposals: 'council-proposals', participants: 'council-participants', active: 'council-active-participant' };
const COLORS = ['#e53935','#8e24aa','#1e88e5','#43a047','#fb8c00','#00acc1','#d81b60','#5e35b1','#039be5','#7cb342','#ff6f00','#3949ab','#00897b','#c0ca33','#6d4c41'];

let proposals = [], participants = [], activeParticipantId = '', currentFilter = '', viewingId = null;

function load() {
  try {
    const p = localStorage.getItem(KEYS.proposals);
    const pp = localStorage.getItem(KEYS.participants);
    const a = localStorage.getItem(KEYS.active);
    if (p) proposals = JSON.parse(p);
    if (pp) participants = JSON.parse(pp);
    if (a) activeParticipantId = a;
  } catch(e) {}
}
function save() {
  localStorage.setItem(KEYS.proposals, JSON.stringify(proposals));
  localStorage.setItem(KEYS.participants, JSON.stringify(participants));
  localStorage.setItem(KEYS.active, activeParticipantId);
}
function gid() { return 'cc_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8); }
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function fmtDate(iso) { return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
function fmtTime(iso) { return new Date(iso).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }); }
function getP(id) { return participants.find(p => p.id === id); }
function getActive() { return getP(activeParticipantId); }
function countVotes(pr) {
  const v = Object.values(pr.votes || {});
  return { support: v.filter(x => x === 'support').length, oppose: v.filter(x => x === 'oppose').length, abstain: v.filter(x => x === 'abstain').length, total: v.length };
}

/* === PARTICIPANTS === */
function addParticipant() {
  const inp = document.getElementById('newParticipantName');
  const name = inp.value.trim();
  if (!name) return;
  participants.push({ id: gid(), name, color: COLORS[participants.length % COLORS.length] });
  if (!activeParticipantId) activeParticipantId = participants[participants.length - 1].id;
  inp.value = '';
  save(); renderAll();
}
function setActive(id) { activeParticipantId = id; save(); renderAll(); }
function removeParticipant(id) {
  if (!confirm('Remove this participant?')) return;
  participants = participants.filter(p => p.id !== id);
  if (activeParticipantId === id) activeParticipantId = participants.length ? participants[0].id : '';
  save(); renderAll();
}
function renderParticipants() {
  const el = document.getElementById('participantList');
  if (!participants.length) { el.innerHTML = '<div style="font-size:12px;color:var(--text-dim);padding:8px;">Add participants to begin</div>'; }
  else {
    el.innerHTML = participants.map(p => {
      const votes = proposals.reduce((c, pr) => c + ((pr.votes && pr.votes[p.id]) ? 1 : 0), 0);
      return '<div class="participant ' + (p.id === activeParticipantId ? 'active' : '') + '" onclick="setActive(\'' + p.id + '\')" ondblclick="removeParticipant(\'' + p.id + '\')">' +
        '<div class="p-color" style="background:' + p.color + '">' + p.name[0].toUpperCase() + '</div>' +
        '<div class="p-info"><div class="p-name">' + esc(p.name) + '</div><div class="p-stats">' + votes + ' votes</div></div></div>';
    }).join('');
  }
  const sel = document.getElementById('activeParticipantSelect');
  sel.innerHTML = '<option value="">Select participant...</option>' + participants.map(p =>
    '<option value="' + p.id + '"' + (p.id === activeParticipantId ? ' selected' : '') + '>' + esc(p.name) + '</option>'
  ).join('');
}
document.getElementById('activeParticipantSelect').addEventListener('change', function() { activeParticipantId = this.value; save(); renderAll(); });
document.getElementById('newParticipantName').addEventListener('keydown', function(e) { if (e.key === 'Enter') addParticipant(); });

/* === PROPOSALS === */
function openProposalModal() {
  if (!getActive()) { alert('Please add and select a participant first.'); return; }
  document.getElementById('editProposalId').value = '';
  document.getElementById('propTitleInput').value = '';
  document.getElementById('propDescInput').value = '';
  document.getElementById('proposalModal').classList.add('open');
  document.getElementById('propTitleInput').focus();
}
function closeProposalModal() { document.getElementById('proposalModal').classList.remove('open'); }
function saveProposal() {
  const title = document.getElementById('propTitleInput').value.trim();
  if (!title) return;
  const active = getActive();
  if (!active) return;
  const editId = document.getElementById('editProposalId').value;
  if (editId) {
    const pr = proposals.find(p => p.id === editId);
    if (pr) { pr.title = title; pr.description = document.getElementById('propDescInput').value.trim(); }
  } else {
    proposals.unshift({ id: gid(), title, description: document.getElementById('propDescInput').value.trim(), authorId: active.id, status: 'discussion', createdAt: new Date().toISOString(), votes: {}, comments: [] });
  }
  save(); closeProposalModal(); renderAll();
}
function advanceToVoting(id) { const pr = proposals.find(p => p.id === id); if (pr) { pr.status = 'voting'; pr.votes = {}; save(); renderAll(); if (viewingId === id) showDetail(id); } }
function closeVoting(id) {
  const pr = proposals.find(p => p.id === id);
  if (!pr) return;
  const c = countVotes(pr);
  pr.status = 'decided'; pr.decidedAt = new Date().toISOString(); pr.outcome = c.support > c.oppose ? 'passed' : 'rejected';
  save(); renderAll(); if (viewingId === id) showDetail(id);
}
function archiveProposal(id) { const pr = proposals.find(p => p.id === id); if (pr) { pr.status = 'archived'; save(); showList(); renderAll(); } }
function deleteProposal(id) { if (!confirm('Delete this proposal?')) return; proposals = proposals.filter(p => p.id !== id); save(); showList(); renderAll(); }
function castVote(pid, vote) {
  const active = getActive();
  if (!active) { alert('Select a participant first.'); return; }
  const pr = proposals.find(p => p.id === pid);
  if (!pr || pr.status !== 'voting') return;
  if (pr.votes[active.id] === vote) delete pr.votes[active.id];
  else pr.votes[active.id] = vote;
  save(); renderAll(); if (viewingId === pid) showDetail(pid);
}
function addComment(pid) {
  const active = getActive();
  if (!active) return;
  const ta = document.getElementById('ci_' + pid);
  if (!ta) return;
  const text = ta.value.trim();
  if (!text) return;
  const pr = proposals.find(p => p.id === pid);
  if (!pr) return;
  if (!pr.comments) pr.comments = [];
  pr.comments.push({ id: gid(), authorId: active.id, text, createdAt: new Date().toISOString() });
  ta.value = '';
  save(); showDetail(pid);
}

/* === RENDERING === */
function renderFilters() {
  const counts = { all: proposals.length, discussion: 0, voting: 0, decided: 0, archived: 0 };
  proposals.forEach(p => counts[p.status]++);
  const items = [
    { key: '', label: 'All', color: '#d4a843', count: counts.all },
    { key: 'discussion', label: 'Discussion', color: '#42a5f5', count: counts.discussion },
    { key: 'voting', label: 'Voting', color: '#ffb300', count: counts.voting },
    { key: 'decided', label: 'Decided', color: '#4caf50', count: counts.decided },
    { key: 'archived', label: 'Archived', color: '#9e9e9e', count: counts.archived }
  ];
  document.getElementById('statusFilters').innerHTML = items.map(i =>
    '<div class="sf-item ' + (currentFilter === i.key ? 'active' : '') + '" onclick="setFilter(\'' + i.key + '\')">' +
    '<span class="sf-dot" style="background:' + i.color + '"></span><span>' + i.label + '</span><span class="sf-count">' + i.count + '</span></div>'
  ).join('');
}
function setFilter(f) { currentFilter = f; renderAll(); }

function renderProposals() {
  const search = (document.getElementById('searchBox').value || '').toLowerCase();
  const filtered = proposals.filter(p => {
    if (currentFilter && p.status !== currentFilter) return false;
    if (search && !p.title.toLowerCase().includes(search) && !(p.description || '').toLowerCase().includes(search)) return false;
    return true;
  });
  const labels = { '': 'All Proposals', discussion: 'In Discussion', voting: 'Open for Voting', decided: 'Decided', archived: 'Archived' };
  document.getElementById('contentTitle').textContent = labels[currentFilter] || 'All Proposals';
  const grid = document.getElementById('proposalsGrid');
  if (!filtered.length) {
    grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#x1F4DC;</div><div style="font-size:16px;">No proposals yet</div><div style="font-size:13px;margin-top:6px;">Create the first proposal to begin</div></div>';
    return;
  }
  grid.innerHTML = filtered.map(pr => {
    const author = getP(pr.authorId);
    const c = countVotes(pr);
    const total = c.total || 1;
    let voteBar = '';
    if ((pr.status === 'voting' || pr.status === 'decided') && c.total > 0) {
      voteBar = '<div class="vote-bar"><div class="vote-bar-segment vb-support" style="width:' + (c.support / total * 100) + '%"></div>' +
        '<div class="vote-bar-segment vb-oppose" style="width:' + (c.oppose / total * 100) + '%"></div>' +
        '<div class="vote-bar-segment vb-abstain" style="width:' + (c.abstain / total * 100) + '%"></div></div>' +
        '<div class="vote-counts"><span style="color:var(--green)">&#x1F44D; ' + c.support + '</span><span style="color:var(--red)">&#x1F44E; ' + c.oppose + '</span><span style="color:var(--gray)">&#x1F937; ' + c.abstain + '</span></div>';
    }
    return '<div class="proposal-card" onclick="showDetail(\'' + pr.id + '\')">' +
      '<div class="proposal-card-header"><div class="proposal-title">' + esc(pr.title) + '</div><span class="status-badge status-' + pr.status + '">' + pr.status + '</span></div>' +
      (pr.description ? '<div class="proposal-desc">' + esc(pr.description) + '</div>' : '') +
      '<div class="proposal-meta">' +
      (author ? '<span><span class="author-dot" style="background:' + author.color + '"></span> ' + esc(author.name) + '</span>' : '') +
      '<span>' + fmtDate(pr.createdAt) + '</span><span>&#x1F4AC; ' + (pr.comments || []).length + '</span>' +
      (c.total > 0 ? '<span>&#x1F5F3; ' + c.total + '</span>' : '') +
      '</div>' + voteBar + '</div>';
  }).join('');
}

function showDetail(id) {
  viewingId = id;
  const pr = proposals.find(p => p.id === id);
  if (!pr) return;
  const author = getP(pr.authorId);
  const c = countVotes(pr);
  const total = c.total || 1;
  const active = getActive();
  const myVote = active && pr.votes ? pr.votes[active.id] : null;
  document.getElementById('listView').classList.add('hidden');
  document.getElementById('detailView').classList.add('active');

  let decisionHtml = '';
  if (pr.status === 'decided') {
    decisionHtml = '<div class="decision-box ' + pr.outcome + '"><div class="decision-label ' + pr.outcome + '">' +
      (pr.outcome === 'passed' ? '&#x2705; Proposal PASSED' : '&#x274C; Proposal REJECTED') + '</div>' +
      '<div style="font-size:12px;color:var(--text-sec);">Decided ' + fmtDate(pr.decidedAt) + ' &#8212; ' + c.support + ' support, ' + c.oppose + ' oppose, ' + c.abstain + ' abstain</div></div>';
  }
  let actions = '<div class="detail-actions">';
  if (pr.status === 'discussion') actions += '<button class="btn btn-blue" onclick="advanceToVoting(\'' + pr.id + '\')">Open for Voting</button>';
  if (pr.status === 'voting') actions += '<button class="btn btn-primary" onclick="closeVoting(\'' + pr.id + '\')">Close Voting</button>';
  if (pr.status === 'decided') actions += '<button class="btn" onclick="archiveProposal(\'' + pr.id + '\')">Archive</button>';
  actions += '<button class="btn btn-red btn-sm" onclick="deleteProposal(\'' + pr.id + '\')">Delete</button></div>';

  document.getElementById('detailHeader').innerHTML =
    '<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">' +
    '<span class="status-badge status-' + pr.status + '">' + pr.status + '</span>' +
    (author ? '<span><span class="author-dot" style="background:' + author.color + '"></span> ' + esc(author.name) + '</span>' : '') +
    '<span style="font-size:12px;color:var(--text-dim);">' + fmtDate(pr.createdAt) + '</span></div>' +
    '<div class="detail-title">' + esc(pr.title) + '</div>' +
    '<div class="detail-full-desc">' + esc(pr.description) + '</div>' +
    decisionHtml + actions;

  // Voting section
  const vs = document.getElementById('votingSection');
  if (pr.status === 'voting' || (pr.status === 'decided' && c.total > 0)) {
    vs.style.display = '';
    let voteButtonsHtml = '';
    if (pr.status === 'voting' && active) {
      voteButtonsHtml = '<div class="vote-buttons">' +
        '<button class="vote-btn vt-support ' + (myVote === 'support' ? 'voted' : '') + '" onclick="castVote(\'' + pr.id + '\',\'support\')">&#x1F44D; Support</button>' +
        '<button class="vote-btn vt-oppose ' + (myVote === 'oppose' ? 'voted' : '') + '" onclick="castVote(\'' + pr.id + '\',\'oppose\')">&#x1F44E; Oppose</button>' +
        '<button class="vote-btn vt-abstain ' + (myVote === 'abstain' ? 'voted' : '') + '" onclick="castVote(\'' + pr.id + '\',\'abstain\')">&#x1F937; Abstain</button></div>';
    } else if (pr.status === 'voting') {
      voteButtonsHtml = '<div style="color:var(--text-dim);font-size:13px;margin-bottom:12px;">Select a participant to vote.</div>';
    }
    let voteList = Object.entries(pr.votes || {}).map(function(entry) {
      const p = getP(entry[0]);
      const icon = entry[1] === 'support' ? '&#x1F44D;' : entry[1] === 'oppose' ? '&#x1F44E;' : '&#x1F937;';
      return p ? '<div class="vote-detail-item"><span class="author-dot" style="background:' + p.color + '"></span> ' + esc(p.name) + ' &#8212; ' + icon + ' ' + entry[1] + '</div>' : '';
    }).join('');
    vs.innerHTML = '<div class="section-title">' + (pr.status === 'voting' ? 'Cast Your Vote' : 'Vote Results') + '</div>' +
      voteButtonsHtml +
      (c.total > 0 ? '<div class="vote-bar" style="height:12px;"><div class="vote-bar-segment vb-support" style="width:' + (c.support / total * 100) + '%"></div>' +
        '<div class="vote-bar-segment vb-oppose" style="width:' + (c.oppose / total * 100) + '%"></div>' +
        '<div class="vote-bar-segment vb-abstain" style="width:' + (c.abstain / total * 100) + '%"></div></div>' +
        '<div class="vote-counts"><span style="color:var(--green)">&#x1F44D; ' + c.support + '</span><span style="color:var(--red)">&#x1F44E; ' + c.oppose + '</span><span style="color:var(--gray)">&#x1F937; ' + c.abstain + '</span></div>' +
        '<div style="margin-top:10px">' + voteList + '</div>' : '<div style="color:var(--text-dim);font-size:12px;margin-top:8px;">No votes yet</div>');
  } else { vs.style.display = 'none'; }

  // Discussion
  const ds = document.getElementById('discussionSection');
  const comments = pr.comments || [];
  let commentsHtml = comments.map(function(cm) {
    const cp = getP(cm.authorId);
    return '<div class="comment"><div class="comment-avatar" style="background:' + (cp ? cp.color : '#555') + '">' + (cp ? cp.name[0].toUpperCase() : '?') + '</div>' +
      '<div class="comment-bubble"><div class="comment-header"><span class="comment-author" style="color:' + (cp ? cp.color : '#999') + '">' + (cp ? esc(cp.name) : 'Unknown') + '</span>' +
      '<span class="comment-time">' + fmtDate(cm.createdAt) + ' ' + fmtTime(cm.createdAt) + '</span></div>' +
      '<div class="comment-text">' + esc(cm.text) + '</div></div></div>';
  }).join('');
  ds.innerHTML = '<div class="section-title">Discussion (' + comments.length + ')</div>' + commentsHtml +
    '<div class="comment-input-area"><textarea id="ci_' + pr.id + '" placeholder="' + (active ? 'Comment as ' + esc(active.name) + '...' : 'Select participant to comment') + '"' + (!active ? ' disabled' : '') + '></textarea>' +
    '<button class="btn btn-sm" onclick="addComment(\'' + pr.id + '\')"' + (!active ? ' disabled' : '') + '>Send</button></div>';
}

function showList() {
  viewingId = null;
  document.getElementById('listView').classList.remove('hidden');
  document.getElementById('detailView').classList.remove('active');
  renderAll();
}

function updateStats() {
  const active = proposals.filter(p => p.status !== 'archived');
  const decided = proposals.filter(p => p.status === 'decided');
  const passed = decided.filter(p => p.outcome === 'passed').length;
  const passRate = decided.length > 0 ? Math.round(passed / decided.length * 100) : 0;
  const votingProps = proposals.filter(p => p.status === 'voting' || p.status === 'decided');
  let possible = 0, actual = 0;
  votingProps.forEach(function(p) { possible += participants.length; actual += Object.keys(p.votes || {}).length; });
  document.getElementById('statProposals').textContent = active.length;
  document.getElementById('statPassRate').textContent = decided.length > 0 ? passRate + '%' : '--%';
  document.getElementById('statParticipation').textContent = possible > 0 ? Math.round(actual / possible * 100) + '%' : '--%';
  const av = proposals.filter(p => p.status === 'voting');
  if (av.length > 0) {
    let r = 0;
    av.forEach(function(p) { const ct = countVotes(p); r += ct.total > 0 ? ct.support / ct.total : 0.5; });
    const avg = r / av.length;
    document.getElementById('consensusFill').style.width = (avg * 100) + '%';
    document.getElementById('consensusLabel').textContent = Math.round(avg * 100) + '% alignment across ' + av.length + ' active vote' + (av.length !== 1 ? 's' : '');
  } else {
    document.getElementById('consensusFill').style.width = '50%';
    document.getElementById('consensusLabel').textContent = 'No active votes';
  }
}

function renderAll() { renderParticipants(); renderFilters(); renderProposals(); updateStats(); }

document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.key === 'Escape') { closeProposalModal(); if (viewingId) showList(); }
  if (e.key === 'n' || e.key === 'N') { e.preventDefault(); openProposalModal(); }
});

/* === INIT === */
load();
if (!participants.length && !proposals.length) {
  participants = [
    { id: gid(), name: 'Alex', color: COLORS[0] },
    { id: gid(), name: 'Jordan', color: COLORS[1] },
    { id: gid(), name: 'Morgan', color: COLORS[2] },
    { id: gid(), name: 'Casey', color: COLORS[3] },
    { id: gid(), name: 'Riley', color: COLORS[4] }
  ];
  activeParticipantId = participants[0].id;
  var ago = function(d) { return new Date(Date.now() - d * 86400000).toISOString(); };
  proposals = [
    { id: gid(), title: 'Weekly community game night', description: 'Proposal to establish a recurring game night every Thursday at 7pm. We could rotate between board games, video games, and outdoor activities depending on the season.', authorId: participants[0].id, status: 'voting', createdAt: ago(3), votes: {}, comments: [
      { id: gid(), authorId: participants[1].id, text: 'Love this idea! Thursday works great for me.', createdAt: ago(2.5) },
      { id: gid(), authorId: participants[2].id, text: 'Could we also consider Fridays? Some of us have evening classes on Thursdays.', createdAt: ago(2) },
      { id: gid(), authorId: participants[0].id, text: 'Good point Morgan. Maybe we can vote on the day separately?', createdAt: ago(1.5) }
    ]},
    { id: gid(), title: 'Community garden expansion', description: 'The current garden plot is at capacity. Propose we request the adjacent lot from the city for expansion. This would allow 12 more individual plots and a shared herb garden.', authorId: participants[1].id, status: 'discussion', createdAt: ago(1), votes: {}, comments: [
      { id: gid(), authorId: participants[3].id, text: 'Great initiative! I can help with the city paperwork.', createdAt: ago(0.5) }
    ]},
    { id: gid(), title: 'Adopt shared tool library', description: 'Instead of everyone buying their own tools, create a shared lending library for power tools, gardening equipment, and kitchen appliances.', authorId: participants[2].id, status: 'decided', createdAt: ago(7), decidedAt: ago(2), outcome: 'passed',
      votes: {}, comments: [
      { id: gid(), authorId: participants[4].id, text: 'Practical idea. I have a drill press I barely use.', createdAt: ago(6) },
      { id: gid(), authorId: participants[0].id, text: 'We should figure out liability before launching.', createdAt: ago(5) }
    ]}
  ];
  proposals[0].votes[participants[0].id] = 'support';
  proposals[0].votes[participants[1].id] = 'support';
  proposals[0].votes[participants[3].id] = 'oppose';
  proposals[2].votes[participants[0].id] = 'support';
  proposals[2].votes[participants[1].id] = 'support';
  proposals[2].votes[participants[2].id] = 'support';
  proposals[2].votes[participants[3].id] = 'abstain';
  proposals[2].votes[participants[4].id] = 'support';
  save();
}
renderAll();
</script>
</body>
</html>