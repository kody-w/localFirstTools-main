<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor - Live Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #d0d0d0;
            --accent-color: #2563eb;
            --accent-hover: #1d4ed8;
            --sidebar-width: 240px;
            --toolbar-height: 48px;
            --code-bg: #f6f8fa;
            --code-border: #d1d5da;
        }

        body.dark-theme {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #404040;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --code-bg: #2d2d2d;
            --code-border: #404040;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 48px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .doc-name {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Buttons */
        .btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-icon {
            padding: 6px 8px;
            font-size: 16px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        /* Toolbar */
        .toolbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
            min-height: var(--toolbar-height);
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            padding-right: 8px;
            border-right: 1px solid var(--border-color);
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s;
        }

        .sidebar.collapsed {
            margin-left: calc(-1 * var(--sidebar-width));
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .doc-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .doc-item {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .doc-item:hover {
            background: var(--bg-tertiary);
        }

        .doc-item.active {
            background: var(--accent-color);
            color: white;
        }

        .doc-item-name {
            font-size: 14px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .doc-item-actions {
            display: none;
            gap: 4px;
        }

        .doc-item:hover .doc-item-actions {
            display: flex;
        }

        .doc-action-btn {
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .doc-action-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .doc-item.active .doc-action-btn {
            color: white;
        }

        .doc-item.active .doc-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Editor and Preview */
        .content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .editor-pane, .preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .pane-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-pane {
            border-right: 1px solid var(--border-color);
        }

        #editor {
            flex: 1;
            padding: 20px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            border: none;
            outline: none;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-y: auto;
        }

        #preview {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        /* Markdown Styles */
        #preview h1 {
            font-size: 2em;
            font-weight: 700;
            margin: 0.67em 0;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.3em;
        }

        #preview h2 {
            font-size: 1.5em;
            font-weight: 700;
            margin: 0.75em 0 0.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }

        #preview h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin: 0.83em 0 0.5em;
        }

        #preview h4 {
            font-size: 1em;
            font-weight: 600;
            margin: 1em 0 0.5em;
        }

        #preview h5 {
            font-size: 0.875em;
            font-weight: 600;
            margin: 1.2em 0 0.5em;
        }

        #preview h6 {
            font-size: 0.85em;
            font-weight: 600;
            margin: 1.2em 0 0.5em;
            color: var(--text-secondary);
        }

        #preview p {
            margin: 1em 0;
            line-height: 1.7;
        }

        #preview strong {
            font-weight: 600;
        }

        #preview em {
            font-style: italic;
        }

        #preview code {
            background: var(--code-bg);
            border: 1px solid var(--code-border);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        #preview pre {
            background: var(--code-bg);
            border: 1px solid var(--code-border);
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }

        #preview pre code {
            background: none;
            border: none;
            padding: 0;
            font-size: 0.875em;
            line-height: 1.5;
            display: block;
        }

        #preview blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 16px;
            margin: 1em 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        #preview ul, #preview ol {
            margin: 1em 0;
            padding-left: 2em;
        }

        #preview li {
            margin: 0.5em 0;
            line-height: 1.6;
        }

        #preview ul ul, #preview ol ol, #preview ul ol, #preview ol ul {
            margin: 0.5em 0;
        }

        #preview hr {
            border: none;
            border-top: 2px solid var(--border-color);
            margin: 2em 0;
        }

        #preview a {
            color: var(--accent-color);
            text-decoration: none;
        }

        #preview a:hover {
            text-decoration: underline;
        }

        #preview img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 1em 0;
        }

        #preview table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }

        #preview table th, #preview table td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }

        #preview table th {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        #preview table tr:nth-child(even) {
            background: var(--bg-secondary);
        }

        #preview .task-list {
            list-style: none;
            padding-left: 0;
        }

        #preview .task-list-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        #preview .task-list-item input[type="checkbox"] {
            margin-top: 4px;
        }

        /* Syntax Highlighting */
        .hljs-keyword { color: #d73a49; font-weight: 600; }
        .hljs-string { color: #032f62; }
        .hljs-number { color: #005cc5; }
        .hljs-comment { color: #6a737d; font-style: italic; }
        .hljs-function { color: #6f42c1; }
        .hljs-class { color: #22863a; }

        body.dark-theme .hljs-keyword { color: #ff7b72; }
        body.dark-theme .hljs-string { color: #a5d6ff; }
        body.dark-theme .hljs-number { color: #79c0ff; }
        body.dark-theme .hljs-comment { color: #8b949e; }
        body.dark-theme .hljs-function { color: #d2a8ff; }
        body.dark-theme .hljs-class { color: #7ee787; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 12px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Find/Replace */
        .find-replace-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            display: none;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .find-replace-bar.active {
            display: flex;
        }

        .find-input, .replace-input {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 13px;
            min-width: 200px;
        }

        /* Status Bar */
        .status-bar {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 6px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content-area {
                flex-direction: column;
            }

            .editor-pane {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar {
                position: absolute;
                height: calc(100vh - 96px);
                z-index: 100;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .header-left {
                flex: 1;
            }

            .app-title {
                font-size: 14px;
            }

            .toolbar {
                overflow-x: auto;
            }

            .btn {
                font-size: 12px;
                padding: 5px 10px;
            }
        }

        @media print {
            .header, .toolbar, .sidebar, .pane-header, .status-bar, .find-replace-bar {
                display: none !important;
            }

            .content-area {
                display: block;
            }

            .editor-pane {
                display: none;
            }

            .preview-pane {
                border: none;
            }

            #preview {
                padding: 0;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="btn btn-icon" id="toggleSidebar" title="Toggle Sidebar">â˜°</button>
                <span class="app-title">Markdown Editor</span>
                <span class="doc-name" id="currentDocName">Untitled</span>
            </div>
            <div class="header-right">
                <button class="btn" id="themeToggle" title="Toggle Theme">ðŸŒ™</button>
                <button class="btn" id="exportMd" title="Export as Markdown">â†“ .md</button>
                <button class="btn" id="exportHtml" title="Export as HTML">â†“ .html</button>
                <button class="btn" id="importMd" title="Import Markdown">â†‘ Import</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" id="btnBold" title="Bold (Ctrl+B)"><strong>B</strong></button>
                <button class="toolbar-btn" id="btnItalic" title="Italic (Ctrl+I)"><em>I</em></button>
                <button class="toolbar-btn" id="btnStrike" title="Strikethrough"><s>S</s></button>
            </div>
            <div class="toolbar-group">
                <button class="toolbar-btn" id="btnH1" title="Heading 1">H1</button>
                <button class="toolbar-btn" id="btnH2" title="Heading 2">H2</button>
                <button class="toolbar-btn" id="btnH3" title="Heading 3">H3</button>
            </div>
            <div class="toolbar-group">
                <button class="toolbar-btn" id="btnList" title="Unordered List">â€¢ List</button>
                <button class="toolbar-btn" id="btnOList" title="Ordered List">1. List</button>
                <button class="toolbar-btn" id="btnTask" title="Task List">â˜‘ Task</button>
            </div>
            <div class="toolbar-group">
                <button class="toolbar-btn" id="btnCode" title="Inline Code">&lt;/&gt;</button>
                <button class="toolbar-btn" id="btnCodeBlock" title="Code Block">{ }</button>
                <button class="toolbar-btn" id="btnQuote" title="Blockquote">"</button>
            </div>
            <div class="toolbar-group">
                <button class="toolbar-btn" id="btnLink" title="Link">ðŸ”—</button>
                <button class="toolbar-btn" id="btnImage" title="Image">ðŸ–¼</button>
                <button class="toolbar-btn" id="btnTable" title="Table">âŠž</button>
                <button class="toolbar-btn" id="btnHr" title="Horizontal Rule">â€”</button>
            </div>
        </div>

        <!-- Find/Replace Bar -->
        <div class="find-replace-bar" id="findReplaceBar">
            <input type="text" class="find-input" id="findInput" placeholder="Find...">
            <button class="btn" id="findPrev">â†‘</button>
            <button class="btn" id="findNext">â†“</button>
            <input type="text" class="replace-input" id="replaceInput" placeholder="Replace...">
            <button class="btn" id="replaceOne">Replace</button>
            <button class="btn" id="replaceAll">Replace All</button>
            <button class="btn" id="closeFindReplace">âœ•</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title">Documents</span>
                    <button class="btn btn-icon" id="newDoc" title="New Document">+</button>
                </div>
                <div class="doc-list" id="docList"></div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Editor -->
                <div class="editor-pane">
                    <div class="pane-header">
                        <span>Editor</span>
                    </div>
                    <textarea id="editor" placeholder="Start typing your markdown here..."></textarea>
                </div>

                <!-- Preview -->
                <div class="preview-pane">
                    <div class="pane-header">
                        <span>Preview</span>
                        <button class="btn btn-icon" id="printPreview" title="Print">ðŸ–¨</button>
                    </div>
                    <div id="preview"></div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div>
                <span id="wordCount">Words: 0</span>
                <span style="margin: 0 12px;">|</span>
                <span id="charCount">Characters: 0</span>
            </div>
            <div>
                <span id="lastSaved">Auto-save enabled</span>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-title" id="modalTitle">Modal Title</div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions">
                <button class="btn" id="modalCancel">Cancel</button>
                <button class="btn btn-primary" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".md,.txt" style="display: none;">

    <script>
        // State Management
        const state = {
            documents: [],
            currentDocId: null,
            autoSaveTimer: null,
            previewTimer: null,
            theme: 'light'
        };

        // DOM Elements
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const sidebar = document.getElementById('sidebar');
        const docList = document.getElementById('docList');
        const currentDocName = document.getElementById('currentDocName');
        const wordCount = document.getElementById('wordCount');
        const charCount = document.getElementById('charCount');
        const lastSaved = document.getElementById('lastSaved');
        const findReplaceBar = document.getElementById('findReplaceBar');
        const modalOverlay = document.getElementById('modalOverlay');
        const fileInput = document.getElementById('fileInput');

        // Initialize
        function init() {
            loadDocuments();
            loadTheme();
            setupEventListeners();

            if (state.documents.length === 0) {
                createNewDocument();
            } else {
                loadDocument(state.documents[0].id);
            }
        }

        // Load documents from localStorage
        function loadDocuments() {
            const saved = localStorage.getItem('markdown-docs');
            if (saved) {
                state.documents = JSON.parse(saved);
            }
        }

        // Save documents to localStorage
        function saveDocuments() {
            localStorage.setItem('markdown-docs', JSON.stringify(state.documents));
            lastSaved.textContent = 'Saved at ' + new Date().toLocaleTimeString();
        }

        // Load theme
        function loadTheme() {
            const saved = localStorage.getItem('markdown-theme');
            if (saved) {
                state.theme = saved;
                if (saved === 'dark') {
                    document.body.classList.add('dark-theme');
                    document.getElementById('themeToggle').textContent = 'â˜€ï¸';
                }
            }
        }

        // Save theme
        function saveTheme() {
            localStorage.setItem('markdown-theme', state.theme);
        }

        // Create new document
        function createNewDocument() {
            const doc = {
                id: Date.now().toString(),
                name: 'Untitled',
                content: '',
                created: Date.now(),
                modified: Date.now()
            };
            state.documents.unshift(doc);
            saveDocuments();
            renderDocumentList();
            loadDocument(doc.id);
        }

        // Load document
        function loadDocument(id) {
            const doc = state.documents.find(d => d.id === id);
            if (!doc) return;

            state.currentDocId = id;
            editor.value = doc.content;
            currentDocName.textContent = doc.name;
            updatePreview();
            updateStats();
            renderDocumentList();
        }

        // Save current document
        function saveCurrentDocument() {
            if (!state.currentDocId) return;

            const doc = state.documents.find(d => d.id === state.currentDocId);
            if (!doc) return;

            doc.content = editor.value;
            doc.modified = Date.now();
            saveDocuments();
        }

        // Render document list
        function renderDocumentList() {
            docList.innerHTML = '';
            state.documents.forEach(doc => {
                const item = document.createElement('div');
                item.className = 'doc-item' + (doc.id === state.currentDocId ? ' active' : '');
                item.innerHTML = `
                    <span class="doc-item-name">${doc.name}</span>
                    <div class="doc-item-actions">
                        <button class="doc-action-btn" onclick="renameDocument('${doc.id}')" title="Rename">âœŽ</button>
                        <button class="doc-action-btn" onclick="deleteDocument('${doc.id}')" title="Delete">âœ•</button>
                    </div>
                `;
                item.onclick = (e) => {
                    if (!e.target.classList.contains('doc-action-btn')) {
                        loadDocument(doc.id);
                    }
                };
                docList.appendChild(item);
            });
        }

        // Rename document
        function renameDocument(id) {
            const doc = state.documents.find(d => d.id === id);
            if (!doc) return;

            showModal('Rename Document', `
                <input type="text" class="modal-input" id="renameInput" value="${doc.name}">
            `, () => {
                const newName = document.getElementById('renameInput').value.trim();
                if (newName) {
                    doc.name = newName;
                    saveDocuments();
                    if (doc.id === state.currentDocId) {
                        currentDocName.textContent = newName;
                    }
                    renderDocumentList();
                }
            });
        }

        // Delete document
        function deleteDocument(id) {
            if (state.documents.length === 1) {
                alert('Cannot delete the last document');
                return;
            }

            const doc = state.documents.find(d => d.id === id);
            if (!doc) return;

            showModal('Delete Document', `
                <p>Are you sure you want to delete "${doc.name}"?</p>
            `, () => {
                state.documents = state.documents.filter(d => d.id !== id);
                saveDocuments();

                if (id === state.currentDocId) {
                    loadDocument(state.documents[0].id);
                }

                renderDocumentList();
            });
        }

        // Markdown Parser
        function parseMarkdown(text) {
            // Escape HTML
            let html = text.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;');

            // Code blocks (must be before inline code)
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const highlighted = highlightCode(code, lang);
                return `<pre><code>${highlighted}</code></pre>`;
            });

            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Headers
            html = html.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>');
            html = html.replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>');
            html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');

            // Bold and italic (must be careful with order)
            html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            html = html.replace(/_(.+?)_/g, '<em>$1</em>');

            // Strikethrough
            html = html.replace(/~~(.+?)~~/g, '<del>$1</del>');

            // Horizontal rule
            html = html.replace(/^(-{3,}|\*{3,}|_{3,})$/gm, '<hr>');

            // Task lists (before regular lists)
            html = html.replace(/^- \[([ x])\]\s+(.+)$/gm, (match, checked, text) => {
                const isChecked = checked === 'x' ? 'checked' : '';
                return `<li class="task-list-item"><input type="checkbox" ${isChecked} disabled> <span>${text}</span></li>`;
            });

            // Lists
            html = parseList(html);

            // Blockquotes
            html = html.replace(/^&gt;\s+(.+)$/gm, '<blockquote>$1</blockquote>');
            html = html.replace(/<\/blockquote>\n<blockquote>/g, '\n');

            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            // Images
            html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');

            // Tables
            html = parseTable(html);

            // Paragraphs
            html = html.split('\n\n').map(para => {
                para = para.trim();
                if (!para) return '';
                if (para.match(/^<(h[1-6]|ul|ol|pre|blockquote|hr|table)/)) {
                    return para;
                }
                return '<p>' + para.replace(/\n/g, '<br>') + '</p>';
            }).join('\n');

            // Clean up task lists
            html = html.replace(/<p><li class="task-list-item">/g, '<ul class="task-list"><li class="task-list-item">');
            html = html.replace(/<\/li><\/p>/g, '</li></ul>');

            return html;
        }

        // Parse lists
        function parseList(html) {
            const lines = html.split('\n');
            const result = [];
            let inList = false;
            let listType = null;
            let listDepth = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const unorderedMatch = line.match(/^(\s*)[-*+]\s+(.+)$/);
                const orderedMatch = line.match(/^(\s*)\d+\.\s+(.+)$/);

                if (unorderedMatch || orderedMatch) {
                    const match = unorderedMatch || orderedMatch;
                    const indent = match[1].length;
                    const content = match[2];
                    const type = unorderedMatch ? 'ul' : 'ol';

                    if (!inList) {
                        result.push(`<${type}>`);
                        inList = true;
                        listType = type;
                        listDepth = indent;
                    } else if (indent > listDepth) {
                        result.push(`<${type}>`);
                        listDepth = indent;
                    } else if (indent < listDepth) {
                        while (listDepth > indent) {
                            result.push(`</${listType}></li>`);
                            listDepth -= 2;
                        }
                    } else {
                        result.push('</li>');
                    }

                    result.push(`<li>${content}`);
                } else {
                    if (inList) {
                        while (listDepth >= 0) {
                            result.push(`</li></${listType}>`);
                            listDepth -= 2;
                        }
                        inList = false;
                    }
                    result.push(line);
                }
            }

            if (inList) {
                while (listDepth >= 0) {
                    result.push(`</li></${listType}>`);
                    listDepth -= 2;
                }
            }

            return result.join('\n');
        }

        // Parse tables
        function parseTable(html) {
            const lines = html.split('\n');
            const result = [];
            let inTable = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                if (line.includes('|')) {
                    const cells = line.split('|').map(c => c.trim()).filter(c => c);

                    if (i + 1 < lines.length && lines[i + 1].match(/^\|?[\s:-]+\|/)) {
                        // Header row
                        if (!inTable) {
                            result.push('<table>');
                            inTable = true;
                        }
                        result.push('<thead><tr>');
                        cells.forEach(cell => result.push(`<th>${cell}</th>`));
                        result.push('</tr></thead><tbody>');
                        i++; // Skip separator row
                    } else if (inTable) {
                        // Body row
                        result.push('<tr>');
                        cells.forEach(cell => result.push(`<td>${cell}</td>`));
                        result.push('</tr>');
                    } else {
                        result.push(line);
                    }
                } else {
                    if (inTable) {
                        result.push('</tbody></table>');
                        inTable = false;
                    }
                    result.push(line);
                }
            }

            if (inTable) {
                result.push('</tbody></table>');
            }

            return result.join('\n');
        }

        // Basic syntax highlighting
        function highlightCode(code, lang) {
            let highlighted = code;

            // Keywords
            const keywords = ['function', 'const', 'let', 'var', 'if', 'else', 'for', 'while', 'return', 'class', 'import', 'export', 'from', 'async', 'await', 'try', 'catch', 'throw', 'new', 'this', 'super', 'extends', 'static', 'public', 'private', 'protected'];
            keywords.forEach(kw => {
                highlighted = highlighted.replace(new RegExp(`\\b(${kw})\\b`, 'g'), '<span class="hljs-keyword">$1</span>');
            });

            // Strings
            highlighted = highlighted.replace(/(['"`])(.*?)\1/g, '<span class="hljs-string">$1$2$1</span>');

            // Numbers
            highlighted = highlighted.replace(/\b(\d+)\b/g, '<span class="hljs-number">$1</span>');

            // Comments
            highlighted = highlighted.replace(/(\/\/.*$)/gm, '<span class="hljs-comment">$1</span>');
            highlighted = highlighted.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="hljs-comment">$1</span>');

            // Function names
            highlighted = highlighted.replace(/\b([a-zA-Z_]\w*)\s*\(/g, '<span class="hljs-function">$1</span>(');

            return highlighted;
        }

        // Update preview
        function updatePreview() {
            const markdown = editor.value;
            const html = parseMarkdown(markdown);
            preview.innerHTML = html;
        }

        // Update stats
        function updateStats() {
            const text = editor.value;
            const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            const chars = text.length;

            wordCount.textContent = `Words: ${words}`;
            charCount.textContent = `Characters: ${chars}`;
        }

        // Show modal
        function showModal(title, body, onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;

            modalOverlay.classList.add('active');

            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');

            const cleanup = () => {
                modalOverlay.classList.remove('active');
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;
            };

            confirmBtn.onclick = () => {
                onConfirm();
                cleanup();
            };

            cancelBtn.onclick = cleanup;

            modalOverlay.onclick = (e) => {
                if (e.target === modalOverlay) cleanup();
            };
        }

        // Insert text at cursor
        function insertAtCursor(before, after = '', placeholder = '') {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            const text = selectedText || placeholder;
            const newText = before + text + after;

            editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);

            const newPos = start + before.length + text.length;
            editor.selectionStart = start + before.length;
            editor.selectionEnd = newPos;
            editor.focus();

            updatePreview();
            scheduleAutoSave();
        }

        // Insert line
        function insertLine(prefix) {
            const start = editor.selectionStart;
            const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;

            editor.value = editor.value.substring(0, lineStart) + prefix + editor.value.substring(lineStart);
            editor.selectionStart = editor.selectionEnd = lineStart + prefix.length;
            editor.focus();

            updatePreview();
            scheduleAutoSave();
        }

        // Schedule auto-save
        function scheduleAutoSave() {
            if (state.autoSaveTimer) {
                clearTimeout(state.autoSaveTimer);
            }
            state.autoSaveTimer = setTimeout(() => {
                saveCurrentDocument();
            }, 1000);
        }

        // Schedule preview update
        function schedulePreview() {
            if (state.previewTimer) {
                clearTimeout(state.previewTimer);
            }
            state.previewTimer = setTimeout(() => {
                updatePreview();
            }, 150);
        }

        // Export as Markdown
        function exportMarkdown() {
            const doc = state.documents.find(d => d.id === state.currentDocId);
            if (!doc) return;

            const blob = new Blob([doc.content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = doc.name + '.md';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Export as HTML
        function exportHTML() {
            const doc = state.documents.find(d => d.id === state.currentDocId);
            if (!doc) return;

            const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${doc.name}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
            color: #333;
        }
        img { max-width: 100%; }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        pre {
            background: #f4f4f4;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
        }
        pre code {
            background: none;
            padding: 0;
        }
        blockquote {
            border-left: 4px solid #2563eb;
            padding-left: 16px;
            color: #666;
            font-style: italic;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background: #f4f4f4;
            font-weight: 600;
        }
    </style>
</head>
<body>
${preview.innerHTML}
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = doc.name + '.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import Markdown
        function importMarkdown(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const name = file.name.replace(/\.(md|txt)$/, '');

                const doc = {
                    id: Date.now().toString(),
                    name: name,
                    content: content,
                    created: Date.now(),
                    modified: Date.now()
                };

                state.documents.unshift(doc);
                saveDocuments();
                renderDocumentList();
                loadDocument(doc.id);
            };
            reader.readAsText(file);
        }

        // Find/Replace
        function findText(direction = 1) {
            const searchTerm = document.getElementById('findInput').value;
            if (!searchTerm) return;

            const text = editor.value;
            const currentPos = editor.selectionStart;

            let foundPos = -1;
            if (direction > 0) {
                foundPos = text.indexOf(searchTerm, currentPos + 1);
                if (foundPos === -1) {
                    foundPos = text.indexOf(searchTerm, 0);
                }
            } else {
                foundPos = text.lastIndexOf(searchTerm, currentPos - 1);
                if (foundPos === -1) {
                    foundPos = text.lastIndexOf(searchTerm);
                }
            }

            if (foundPos !== -1) {
                editor.focus();
                editor.selectionStart = foundPos;
                editor.selectionEnd = foundPos + searchTerm.length;
            }
        }

        function replaceText() {
            const searchTerm = document.getElementById('findInput').value;
            const replaceTerm = document.getElementById('replaceInput').value;

            if (!searchTerm) return;

            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);

            if (selectedText === searchTerm) {
                editor.value = editor.value.substring(0, start) + replaceTerm + editor.value.substring(end);
                editor.selectionStart = start;
                editor.selectionEnd = start + replaceTerm.length;
                updatePreview();
                scheduleAutoSave();
                findText(1);
            } else {
                findText(1);
            }
        }

        function replaceAllText() {
            const searchTerm = document.getElementById('findInput').value;
            const replaceTerm = document.getElementById('replaceInput').value;

            if (!searchTerm) return;

            editor.value = editor.value.split(searchTerm).join(replaceTerm);
            updatePreview();
            scheduleAutoSave();
        }

        // Event Listeners
        function setupEventListeners() {
            // Editor
            editor.addEventListener('input', () => {
                schedulePreview();
                updateStats();
                scheduleAutoSave();
            });

            // Toolbar buttons
            document.getElementById('btnBold').onclick = () => insertAtCursor('**', '**', 'bold text');
            document.getElementById('btnItalic').onclick = () => insertAtCursor('*', '*', 'italic text');
            document.getElementById('btnStrike').onclick = () => insertAtCursor('~~', '~~', 'strikethrough');
            document.getElementById('btnH1').onclick = () => insertLine('# ');
            document.getElementById('btnH2').onclick = () => insertLine('## ');
            document.getElementById('btnH3').onclick = () => insertLine('### ');
            document.getElementById('btnList').onclick = () => insertLine('- ');
            document.getElementById('btnOList').onclick = () => insertLine('1. ');
            document.getElementById('btnTask').onclick = () => insertLine('- [ ] ');
            document.getElementById('btnCode').onclick = () => insertAtCursor('`', '`', 'code');
            document.getElementById('btnCodeBlock').onclick = () => insertAtCursor('\n```\n', '\n```\n', 'code block');
            document.getElementById('btnQuote').onclick = () => insertLine('> ');
            document.getElementById('btnLink').onclick = () => insertAtCursor('[', '](url)', 'link text');
            document.getElementById('btnImage').onclick = () => insertAtCursor('![', '](url)', 'alt text');
            document.getElementById('btnTable').onclick = () => insertAtCursor('\n| Header 1 | Header 2 |\n|----------|----------|\n| Cell 1   | Cell 2   |\n', '', '');
            document.getElementById('btnHr').onclick = () => insertLine('\n---\n');

            // Header buttons
            document.getElementById('toggleSidebar').onclick = () => sidebar.classList.toggle('collapsed');
            document.getElementById('newDoc').onclick = createNewDocument;
            document.getElementById('themeToggle').onclick = () => {
                state.theme = state.theme === 'light' ? 'dark' : 'light';
                document.body.classList.toggle('dark-theme');
                document.getElementById('themeToggle').textContent = state.theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
                saveTheme();
            };
            document.getElementById('exportMd').onclick = exportMarkdown;
            document.getElementById('exportHtml').onclick = exportHTML;
            document.getElementById('importMd').onclick = () => fileInput.click();
            document.getElementById('printPreview').onclick = () => window.print();

            // File input
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importMarkdown(e.target.files[0]);
                }
            });

            // Drag and drop
            editor.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            editor.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.name.endsWith('.md') || file.name.endsWith('.txt')) {
                        importMarkdown(file);
                    }
                }
            });

            // Find/Replace
            document.getElementById('findNext').onclick = () => findText(1);
            document.getElementById('findPrev').onclick = () => findText(-1);
            document.getElementById('replaceOne').onclick = replaceText;
            document.getElementById('replaceAll').onclick = replaceAllText;
            document.getElementById('closeFindReplace').onclick = () => findReplaceBar.classList.remove('active');

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'b':
                            e.preventDefault();
                            insertAtCursor('**', '**', 'bold text');
                            break;
                        case 'i':
                            e.preventDefault();
                            insertAtCursor('*', '*', 'italic text');
                            break;
                        case 'k':
                            e.preventDefault();
                            insertAtCursor('[', '](url)', 'link text');
                            break;
                        case 'f':
                            e.preventDefault();
                            findReplaceBar.classList.add('active');
                            document.getElementById('findInput').focus();
                            break;
                        case 's':
                            e.preventDefault();
                            saveCurrentDocument();
                            break;
                    }
                }

                if (e.key === 'Escape') {
                    findReplaceBar.classList.remove('active');
                    modalOverlay.classList.remove('active');
                }
            });

            // Search in find box
            document.getElementById('findInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    findText(e.shiftKey ? -1 : 1);
                }
            });
        }

        // Initialize app
        init();
    </script>
</body>
</html>
