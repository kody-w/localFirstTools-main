<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Focus Timer</title>
    <meta name="rappterzoo:author" content="Claude Opus 4.6">
    <meta name="rappterzoo:author-type" content="agent">
    <meta name="rappterzoo:category" content="creative-tools">
    <meta name="rappterzoo:tags" content="productivity, timer, audio, canvas">
    <meta name="rappterzoo:type" content="interactive">
    <meta name="rappterzoo:complexity" content="advanced">
    <meta name="rappterzoo:created" content="2026-02-07">
    <meta name="rappterzoo:generation" content="1">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, hsl(220, 30%, 15%) 0%, hsl(220, 30%, 8%) 100%);
            color: hsl(0, 0%, 95%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            align-items: start;
        }

        .panel {
            background: linear-gradient(135deg, hsl(220, 25%, 20%) 0%, hsl(220, 25%, 16%) 100%);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid hsl(220, 25%, 25%);
        }

        .timer-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        h1 {
            font-size: 28px;
            text-align: center;
            margin-bottom: 8px;
            background: linear-gradient(135deg, hsl(150, 60%, 60%), hsl(200, 60%, 60%));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: hsl(0, 0%, 60%);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .canvas-container {
            position: relative;
            width: 320px;
            height: 320px;
        }

        canvas {
            display: block;
        }

        .timer-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .time {
            font-size: 64px;
            font-weight: 700;
            letter-spacing: -2px;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);
        }

        .session-type {
            font-size: 16px;
            color: hsl(0, 0%, 70%);
            margin-top: 8px;
            font-weight: 500;
        }

        .current-task {
            font-size: 14px;
            color: hsl(150, 50%, 65%);
            margin-top: 12px;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, hsl(150, 60%, 50%), hsl(150, 60%, 40%));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, hsl(220, 20%, 35%), hsl(220, 20%, 30%));
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, hsl(220, 20%, 40%), hsl(220, 20%, 35%));
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, hsl(0, 60%, 55%), hsl(0, 60%, 45%));
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
        }

        h2 {
            font-size: 22px;
            margin-bottom: 16px;
            color: hsl(0, 0%, 90%);
        }

        .task-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid hsl(220, 25%, 30%);
            border-radius: 8px;
            background: hsl(220, 25%, 12%);
            color: white;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: hsl(150, 60%, 50%);
        }

        .task-list {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: hsl(220, 25%, 30%) transparent;
        }

        .task-list::-webkit-scrollbar {
            width: 8px;
        }

        .task-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .task-list::-webkit-scrollbar-thumb {
            background: hsl(220, 25%, 30%);
            border-radius: 4px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: hsl(220, 25%, 14%);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }

        .task-item:hover {
            background: hsl(220, 25%, 18%);
            border-color: hsl(150, 60%, 50%);
        }

        .task-item.selected {
            border-color: hsl(150, 60%, 50%);
            background: hsl(220, 25%, 18%);
        }

        .task-item.completed {
            opacity: 0.5;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid hsl(220, 25%, 40%);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .task-checkbox.checked {
            background: hsl(150, 60%, 50%);
            border-color: hsl(150, 60%, 50%);
        }

        .task-checkbox.checked::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .task-text {
            flex: 1;
            font-size: 14px;
        }

        .task-text.completed {
            text-decoration: line-through;
        }

        .task-delete {
            padding: 4px 8px;
            background: hsl(0, 60%, 50%);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task-item:hover .task-delete {
            opacity: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: hsl(220, 25%, 14%);
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid hsl(150, 60%, 50%);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: hsl(150, 60%, 60%);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: hsl(0, 0%, 60%);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: hsl(220, 25%, 30%) transparent;
        }

        .history-item {
            padding: 12px;
            background: hsl(220, 25%, 14%);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid hsl(150, 60%, 50%);
        }

        .history-item.break {
            border-left-color: hsl(200, 60%, 50%);
        }

        .history-item.long-break {
            border-left-color: hsl(45, 90%, 60%);
        }

        .history-time {
            font-size: 12px;
            color: hsl(0, 0%, 60%);
            margin-bottom: 4px;
        }

        .history-session {
            font-size: 14px;
            font-weight: 600;
        }

        .history-task {
            font-size: 12px;
            color: hsl(150, 60%, 60%);
            margin-top: 4px;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-label {
            display: block;
            font-size: 14px;
            color: hsl(0, 0%, 80%);
            margin-bottom: 8px;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid hsl(220, 25%, 30%);
            border-radius: 8px;
            background: hsl(220, 25%, 12%);
            color: white;
            font-size: 14px;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: hsl(150, 60%, 50%);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: hsl(220, 25%, 14%);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-group:hover {
            background: hsl(220, 25%, 18%);
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .export-btn {
            width: 100%;
            margin-top: 16px;
        }

        .shortcuts {
            background: hsl(220, 25%, 14%);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
            border-bottom: 1px solid hsl(220, 25%, 20%);
        }

        .shortcut-item:last-child {
            border-bottom: none;
        }

        .shortcut-key {
            background: hsl(220, 25%, 25%);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            .canvas-container {
                width: 280px;
                height: 280px;
            }

            .time {
                font-size: 52px;
            }

            h1 {
                font-size: 24px;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: hsl(0, 0%, 50%);
            font-size: 14px;
        }

        .session-counter {
            text-align: center;
            font-size: 14px;
            color: hsl(0, 0%, 60%);
            margin-top: 8px;
        }

        .session-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }

        .session-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: hsl(220, 25%, 30%);
            transition: all 0.3s;
        }

        .session-dot.completed {
            background: hsl(150, 60%, 50%);
            box-shadow: 0 0 8px hsl(150, 60%, 50%);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Timer Panel -->
        <div class="panel timer-panel">
            <div>
                <h1>Pomodoro Focus Timer</h1>
                <div class="subtitle">Stay focused, stay productive</div>
            </div>

            <div class="canvas-container">
                <canvas id="timerCanvas" width="320" height="320"></canvas>
                <div class="timer-display">
                    <div class="time" id="timeDisplay">25:00</div>
                    <div class="session-type" id="sessionType">Focus Time</div>
                    <div class="current-task" id="currentTask"></div>
                </div>
            </div>

            <div class="session-counter">
                <div id="sessionCountText">Session 1 of 4</div>
                <div class="session-dots" id="sessionDots"></div>
            </div>

            <div class="controls">
                <button class="btn-primary" id="startBtn">Start</button>
                <button class="btn-secondary" id="pauseBtn" style="display: none;">Pause</button>
                <button class="btn-secondary" id="resetBtn">Reset</button>
                <button class="btn-secondary" id="nextBtn">Next</button>
            </div>

            <div class="shortcuts">
                <div class="shortcut-item">
                    <span>Start / Pause</span>
                    <span class="shortcut-key">Space</span>
                </div>
                <div class="shortcut-item">
                    <span>Reset Timer</span>
                    <span class="shortcut-key">R</span>
                </div>
                <div class="shortcut-item">
                    <span>Next Session</span>
                    <span class="shortcut-key">N</span>
                </div>
            </div>
        </div>

        <!-- Tasks & Settings Panel -->
        <div class="panel">
            <h2>Tasks</h2>
            <div class="task-input-group">
                <input type="text" id="taskInput" placeholder="Add a new task...">
                <button class="btn-primary" id="addTaskBtn">Add</button>
            </div>
            <div class="task-list" id="taskList"></div>

            <h2 style="margin-top: 32px;">Settings</h2>
            <div class="settings-group">
                <label class="settings-label">Focus Duration (minutes)</label>
                <input type="number" id="focusDuration" value="25" min="1" max="60">
            </div>
            <div class="settings-group">
                <label class="settings-label">Short Break (minutes)</label>
                <input type="number" id="shortBreakDuration" value="5" min="1" max="30">
            </div>
            <div class="settings-group">
                <label class="settings-label">Long Break (minutes)</label>
                <input type="number" id="longBreakDuration" value="15" min="1" max="60">
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="autoStartNext">
                <label for="autoStartNext">Auto-start next session</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="tickSound">
                <label for="tickSound">Enable tick sound</label>
            </div>
        </div>

        <!-- Stats & History Panel -->
        <div class="panel">
            <h2>Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayMinutes">0</div>
                    <div class="stat-label">Minutes Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weekMinutes">0</div>
                    <div class="stat-label">Minutes This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSessions">0</div>
                    <div class="stat-label">Sessions Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>

            <h2>Session History</h2>
            <div class="history-list" id="historyList"></div>

            <button class="btn-secondary export-btn" id="exportBtn">Export History (JSON)</button>
        </div>
    </div>

    <script>
        // Audio Context
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let tickInterval = null;

        function playBell() {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.connect(gain);
            gain.connect(audioContext.destination);

            osc.frequency.setValueAtTime(800, audioContext.currentTime);
            osc.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.5);

            gain.gain.setValueAtTime(0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + 0.5);
        }

        function playTick() {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.connect(gain);
            gain.connect(audioContext.destination);

            osc.frequency.setValueAtTime(1000, audioContext.currentTime);
            gain.gain.setValueAtTime(0.05, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);

            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + 0.05);
        }

        // State
        const state = {
            sessionType: 'focus', // 'focus', 'short-break', 'long-break'
            sessionCount: 0,
            timeRemaining: 25 * 60,
            isRunning: false,
            selectedTaskId: null,
            tasks: [],
            history: [],
            stats: {
                todayMinutes: 0,
                weekMinutes: 0,
                totalSessions: 0,
                lastActivityDate: null,
                currentStreak: 0
            },
            settings: {
                focusDuration: 25,
                shortBreakDuration: 5,
                longBreakDuration: 15,
                autoStartNext: false,
                tickSound: false
            }
        };

        // Load state from localStorage
        function loadState() {
            const saved = localStorage.getItem('pomodoroState');
            if (saved) {
                const parsed = JSON.parse(saved);
                state.tasks = parsed.tasks || [];
                state.history = parsed.history || [];
                state.stats = parsed.stats || state.stats;
                state.settings = { ...state.settings, ...parsed.settings };
                state.sessionCount = parsed.sessionCount || 0;
            }
            updateStreaks();
        }

        function saveState() {
            localStorage.setItem('pomodoroState', JSON.stringify({
                tasks: state.tasks,
                history: state.history,
                stats: state.stats,
                settings: state.settings,
                sessionCount: state.sessionCount
            }));
        }

        // Update streaks
        function updateStreaks() {
            const today = new Date().toDateString();
            const lastDate = state.stats.lastActivityDate;

            if (!lastDate) {
                state.stats.currentStreak = 0;
            } else if (lastDate === today) {
                // Same day, keep streak
            } else {
                const lastDay = new Date(lastDate);
                const currentDay = new Date(today);
                const diffTime = currentDay - lastDay;
                const diffDays = diffTime / (1000 * 60 * 60 * 24);

                if (diffDays === 1) {
                    // Consecutive day - streak continues
                } else if (diffDays > 1) {
                    // Streak broken
                    state.stats.currentStreak = 0;
                }
            }
        }

        function recordActivity(duration) {
            const today = new Date().toDateString();
            const thisWeek = getWeekStart(new Date()).toDateString();

            if (state.stats.lastActivityDate !== today) {
                const lastDay = state.stats.lastActivityDate ? new Date(state.stats.lastActivityDate) : null;
                const currentDay = new Date(today);

                if (lastDay) {
                    const diffTime = currentDay - lastDay;
                    const diffDays = diffTime / (1000 * 60 * 60 * 24);

                    if (diffDays === 1) {
                        state.stats.currentStreak++;
                    } else if (diffDays > 1) {
                        state.stats.currentStreak = 1;
                    }
                } else {
                    state.stats.currentStreak = 1;
                }

                state.stats.lastActivityDate = today;
            }

            state.stats.todayMinutes += duration;
            state.stats.weekMinutes += duration;
            state.stats.totalSessions++;

            saveState();
            updateStats();
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        // Timer logic
        let lastTime = Date.now();
        let animationFrame = null;

        function startTimer() {
            if (state.isRunning) return;
            state.isRunning = true;
            lastTime = Date.now();
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';

            if (state.settings.tickSound) {
                tickInterval = setInterval(playTick, 1000);
            }

            tick();
        }

        function pauseTimer() {
            state.isRunning = false;
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';

            if (tickInterval) {
                clearInterval(tickInterval);
                tickInterval = null;
            }

            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
        }

        function resetTimer() {
            pauseTimer();
            setSessionDuration();
            updateDisplay();
        }

        function nextSession() {
            pauseTimer();

            if (state.sessionType === 'focus') {
                state.sessionCount++;
                if (state.sessionCount % 4 === 0) {
                    state.sessionType = 'long-break';
                } else {
                    state.sessionType = 'short-break';
                }
            } else {
                state.sessionType = 'focus';
            }

            setSessionDuration();
            updateDisplay();
            updateSessionDots();
            saveState();

            if (state.settings.autoStartNext) {
                setTimeout(startTimer, 1000);
            }
        }

        function setSessionDuration() {
            if (state.sessionType === 'focus') {
                state.timeRemaining = state.settings.focusDuration * 60;
            } else if (state.sessionType === 'short-break') {
                state.timeRemaining = state.settings.shortBreakDuration * 60;
            } else {
                state.timeRemaining = state.settings.longBreakDuration * 60;
            }
        }

        function tick() {
            if (!state.isRunning) return;

            const now = Date.now();
            const delta = (now - lastTime) / 1000;
            lastTime = now;

            state.timeRemaining -= delta;

            if (state.timeRemaining <= 0) {
                state.timeRemaining = 0;
                completeSession();
                return;
            }

            updateDisplay();
            animationFrame = requestAnimationFrame(tick);
        }

        function completeSession() {
            pauseTimer();
            playBell();

            const duration = state.sessionType === 'focus' ?
                state.settings.focusDuration :
                (state.sessionType === 'short-break' ? state.settings.shortBreakDuration : state.settings.longBreakDuration);

            const historyEntry = {
                timestamp: new Date().toISOString(),
                type: state.sessionType,
                duration: duration,
                task: state.selectedTaskId ? state.tasks.find(t => t.id === state.selectedTaskId)?.text : null
            };

            state.history.unshift(historyEntry);

            if (state.history.length > 100) {
                state.history = state.history.slice(0, 100);
            }

            if (state.sessionType === 'focus') {
                recordActivity(duration);
            }

            saveState();
            updateHistory();
            updateStats();

            nextSession();
        }

        // Display updates
        function updateDisplay() {
            const minutes = Math.floor(state.timeRemaining / 60);
            const seconds = Math.floor(state.timeRemaining % 60);
            const timeStr = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');

            document.getElementById('timeDisplay').textContent = timeStr;

            const typeMap = {
                'focus': 'Focus Time',
                'short-break': 'Short Break',
                'long-break': 'Long Break'
            };
            document.getElementById('sessionType').textContent = typeMap[state.sessionType];

            const selectedTask = state.tasks.find(t => t.id === state.selectedTaskId);
            const taskEl = document.getElementById('currentTask');
            if (selectedTask && !selectedTask.completed) {
                taskEl.textContent = selectedTask.text;
                taskEl.style.display = 'block';
            } else {
                taskEl.style.display = 'none';
            }

            drawTimer();
        }

        function drawTimer() {
            const canvas = document.getElementById('timerCanvas');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 140;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Background circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = 'hsl(220, 25%, 25%)';
            ctx.lineWidth = 20;
            ctx.stroke();

            // Progress arc
            const maxTime = state.sessionType === 'focus' ?
                state.settings.focusDuration * 60 :
                (state.sessionType === 'short-break' ? state.settings.shortBreakDuration * 60 : state.settings.longBreakDuration * 60);
            const progress = state.timeRemaining / maxTime;
            const endAngle = -0.5 * Math.PI + (2 * Math.PI * progress);

            const colorMap = {
                'focus': 'hsl(150, 60%, 50%)',
                'short-break': 'hsl(200, 60%, 55%)',
                'long-break': 'hsl(45, 90%, 60%)'
            };

            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, colorMap[state.sessionType]);
            gradient.addColorStop(1, adjustBrightness(colorMap[state.sessionType], -20));

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, -0.5 * Math.PI, endAngle, false);
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 20;
            ctx.lineCap = 'round';
            ctx.stroke();

            // Glow effect
            ctx.shadowBlur = 20;
            ctx.shadowColor = colorMap[state.sessionType];
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        function adjustBrightness(hsl, amount) {
            const match = hsl.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
            if (!match) return hsl;
            const h = match[1];
            const s = match[2];
            const l = Math.max(0, Math.min(100, parseInt(match[3]) + amount));
            return 'hsl(' + h + ', ' + s + '%, ' + l + '%)';
        }

        function updateSessionDots() {
            const dotsContainer = document.getElementById('sessionDots');
            dotsContainer.innerHTML = '';

            for (let i = 0; i < 4; i++) {
                const dot = document.createElement('div');
                dot.className = 'session-dot';
                if (i < state.sessionCount % 4) {
                    dot.classList.add('completed');
                }
                dotsContainer.appendChild(dot);
            }

            const sessionNum = (state.sessionCount % 4) + 1;
            document.getElementById('sessionCountText').textContent = 'Session ' + sessionNum + ' of 4';
        }

        // Tasks
        function addTask(text) {
            if (!text.trim()) return;

            const task = {
                id: Date.now(),
                text: text.trim(),
                completed: false,
                createdAt: new Date().toISOString()
            };

            state.tasks.push(task);
            saveState();
            renderTasks();
        }

        function deleteTask(id) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            if (state.selectedTaskId === id) {
                state.selectedTaskId = null;
            }
            saveState();
            renderTasks();
            updateDisplay();
        }

        function toggleTaskComplete(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                saveState();
                renderTasks();
            }
        }

        function selectTask(id) {
            state.selectedTaskId = state.selectedTaskId === id ? null : id;
            renderTasks();
            updateDisplay();
        }

        function renderTasks() {
            const container = document.getElementById('taskList');

            if (state.tasks.length === 0) {
                container.innerHTML = '<div class="empty-state">No tasks yet. Add one to get started!</div>';
                return;
            }

            container.innerHTML = '';

            state.tasks.forEach(task => {
                const item = document.createElement('div');
                item.className = 'task-item';
                if (task.completed) item.classList.add('completed');
                if (task.id === state.selectedTaskId) item.classList.add('selected');

                const checkbox = document.createElement('div');
                checkbox.className = 'task-checkbox';
                if (task.completed) checkbox.classList.add('checked');
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleTaskComplete(task.id);
                });

                const text = document.createElement('div');
                text.className = 'task-text';
                if (task.completed) text.classList.add('completed');
                text.textContent = task.text;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'task-delete';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTask(task.id);
                });

                item.addEventListener('click', () => selectTask(task.id));

                item.appendChild(checkbox);
                item.appendChild(text);
                item.appendChild(deleteBtn);
                container.appendChild(item);
            });
        }

        // History
        function updateHistory() {
            const container = document.getElementById('historyList');

            if (state.history.length === 0) {
                container.innerHTML = '<div class="empty-state">No sessions completed yet</div>';
                return;
            }

            container.innerHTML = '';

            const recent = state.history.slice(0, 20);

            recent.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'history-item';
                if (entry.type === 'short-break') item.classList.add('break');
                if (entry.type === 'long-break') item.classList.add('long-break');

                const time = document.createElement('div');
                time.className = 'history-time';
                time.textContent = new Date(entry.timestamp).toLocaleString();

                const session = document.createElement('div');
                session.className = 'history-session';
                const typeMap = {
                    'focus': 'Focus Session',
                    'short-break': 'Short Break',
                    'long-break': 'Long Break'
                };
                session.textContent = typeMap[entry.type] + ' (' + entry.duration + ' min)';

                item.appendChild(time);
                item.appendChild(session);

                if (entry.task) {
                    const task = document.createElement('div');
                    task.className = 'history-task';
                    task.textContent = entry.task;
                    item.appendChild(task);
                }

                container.appendChild(item);
            });
        }

        // Stats
        function updateStats() {
            const today = new Date().toDateString();
            const weekStart = getWeekStart(new Date()).toDateString();

            let todayMinutes = 0;
            let weekMinutes = 0;

            state.history.forEach(entry => {
                if (entry.type !== 'focus') return;

                const entryDate = new Date(entry.timestamp).toDateString();
                const entryWeek = getWeekStart(new Date(entry.timestamp)).toDateString();

                if (entryDate === today) {
                    todayMinutes += entry.duration;
                }

                if (entryWeek === weekStart) {
                    weekMinutes += entry.duration;
                }
            });

            document.getElementById('todayMinutes').textContent = todayMinutes;
            document.getElementById('weekMinutes').textContent = weekMinutes;
            document.getElementById('totalSessions').textContent = state.stats.totalSessions;
            document.getElementById('currentStreak').textContent = state.stats.currentStreak;
        }

        // Export
        function exportHistory() {
            const data = {
                exportDate: new Date().toISOString(),
                stats: state.stats,
                history: state.history,
                tasks: state.tasks
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pomodoro-export-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Settings
        function updateSettings() {
            state.settings.focusDuration = parseInt(document.getElementById('focusDuration').value);
            state.settings.shortBreakDuration = parseInt(document.getElementById('shortBreakDuration').value);
            state.settings.longBreakDuration = parseInt(document.getElementById('longBreakDuration').value);
            state.settings.autoStartNext = document.getElementById('autoStartNext').checked;
            state.settings.tickSound = document.getElementById('tickSound').checked;

            if (!state.isRunning) {
                setSessionDuration();
                updateDisplay();
            }

            saveState();
        }

        function loadSettings() {
            document.getElementById('focusDuration').value = state.settings.focusDuration;
            document.getElementById('shortBreakDuration').value = state.settings.shortBreakDuration;
            document.getElementById('longBreakDuration').value = state.settings.longBreakDuration;
            document.getElementById('autoStartNext').checked = state.settings.autoStartNext;
            document.getElementById('tickSound').checked = state.settings.tickSound;
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', startTimer);
        document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
        document.getElementById('resetBtn').addEventListener('click', resetTimer);
        document.getElementById('nextBtn').addEventListener('click', nextSession);

        document.getElementById('addTaskBtn').addEventListener('click', () => {
            const input = document.getElementById('taskInput');
            addTask(input.value);
            input.value = '';
        });

        document.getElementById('taskInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask(e.target.value);
                e.target.value = '';
            }
        });

        document.getElementById('exportBtn').addEventListener('click', exportHistory);

        document.getElementById('focusDuration').addEventListener('change', updateSettings);
        document.getElementById('shortBreakDuration').addEventListener('change', updateSettings);
        document.getElementById('longBreakDuration').addEventListener('change', updateSettings);
        document.getElementById('autoStartNext').addEventListener('change', updateSettings);
        document.getElementById('tickSound').addEventListener('change', updateSettings);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;

            if (e.code === 'Space') {
                e.preventDefault();
                if (state.isRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            } else if (e.key.toLowerCase() === 'r') {
                e.preventDefault();
                resetTimer();
            } else if (e.key.toLowerCase() === 'n') {
                e.preventDefault();
                nextSession();
            }
        });

        // Initialize
        loadState();
        loadSettings();
        setSessionDuration();
        renderTasks();
        updateHistory();
        updateStats();
        updateDisplay();
        updateSessionDots();

        // Start animation loop for smooth canvas updates
        function animate() {
            if (state.isRunning) {
                drawTimer();
            }
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
