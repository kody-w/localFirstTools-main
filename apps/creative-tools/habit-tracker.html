<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker with Streaks</title>
    <meta name="description" content="Build positive habits with streak tracking, visual progress calendars, and motivational statistics. Privacy-first habit building with local storage.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(245,158,11,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .date-display {
            text-align: center;
            margin-bottom: 25px;
        }

        .current-date {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .date-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .date-nav button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .date-nav button:hover {
            background: rgba(255,255,255,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-value.fire {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-value.green {
            color: #10b981;
        }

        .stat-label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.6);
            margin-top: 5px;
        }

        .habits-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }

        .habit-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px 20px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s;
        }

        .habit-card:hover {
            background: rgba(255,255,255,0.08);
        }

        .habit-checkbox {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
        }

        .habit-checkbox:hover {
            border-color: #10b981;
        }

        .habit-checkbox.checked {
            background: #10b981;
            border-color: #10b981;
        }

        .habit-icon {
            font-size: 1.5rem;
        }

        .habit-info {
            flex: 1;
        }

        .habit-name {
            font-weight: 500;
            font-size: 1.05rem;
            margin-bottom: 3px;
        }

        .habit-streak {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .streak-fire {
            color: #f59e0b;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .habit-actions {
            display: flex;
            gap: 8px;
        }

        .habit-action-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: rgba(255,255,255,0.6);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .habit-action-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .calendar-section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .calendar-nav button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 5px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
            padding: 8px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.85rem;
            position: relative;
        }

        .calendar-day.other-month {
            color: rgba(255,255,255,0.2);
        }

        .calendar-day.today {
            border: 2px solid #f59e0b;
        }

        .calendar-day.completed {
            background: rgba(16,185,129,0.3);
        }

        .calendar-day.partial {
            background: rgba(245,158,11,0.3);
        }

        .completion-dot {
            position: absolute;
            bottom: 3px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal h3 {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .icon-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .icon-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid transparent;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .icon-option:hover,
        .icon-option.selected {
            border-color: #f59e0b;
            background: rgba(245,158,11,0.2);
        }

        .color-picker {
            display: flex;
            gap: 8px;
        }

        .color-option {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover,
        .color-option.selected {
            border-color: white;
            transform: scale(1.1);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-delete {
            background: rgba(239,68,68,0.2);
            color: #ef4444;
            margin-right: auto;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: rgba(255,255,255,0.4);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .motivational-quote {
            text-align: center;
            font-style: italic;
            color: rgba(255,255,255,0.4);
            padding: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Habit Tracker</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openHabitModal()">+ New Habit</button>
                <button class="btn btn-secondary" onclick="exportData()">Export</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import</button>
                <input type="file" id="importFile" accept=".json" style="display: none" onchange="importData(event)">
            </div>
        </div>

        <div class="date-display">
            <div class="date-nav">
                <button onclick="changeDate(-1)">‚Äπ</button>
                <span class="current-date" id="currentDate"></span>
                <button onclick="changeDate(1)">‚Ä∫</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value fire" id="longestStreak">0</div>
                <div class="stat-label">Longest Streak</div>
            </div>
            <div class="stat-card">
                <div class="stat-value green" id="todayCompleted">0/0</div>
                <div class="stat-label">Completed Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCompletions" style="color: #3b82f6;">0</div>
                <div class="stat-label">Total Completions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completionRate" style="color: #8b5cf6;">0%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>

        <div class="habits-list" id="habitsList"></div>

        <div class="calendar-section">
            <div class="calendar-header">
                <span class="calendar-title" id="calendarTitle">December 2024</span>
                <div class="calendar-nav">
                    <button onclick="changeCalendarMonth(-1)">‚Äπ</button>
                    <button onclick="changeCalendarMonth(1)">‚Ä∫</button>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="motivational-quote" id="quote"></div>
    </div>

    <!-- Habit Modal -->
    <div class="modal-overlay" id="habitModal">
        <div class="modal">
            <h3 id="habitModalTitle">New Habit</h3>
            <form id="habitForm" onsubmit="saveHabit(event)">
                <input type="hidden" id="habitId">

                <div class="form-group">
                    <label>Habit Name *</label>
                    <input type="text" id="habitName" required placeholder="e.g., Exercise, Read, Meditate">
                </div>

                <div class="form-group">
                    <label>Icon</label>
                    <div class="icon-picker" id="iconPicker"></div>
                </div>

                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker" id="colorPicker"></div>
                </div>

                <div class="form-group">
                    <label>Frequency</label>
                    <select id="habitFrequency">
                        <option value="daily">Daily</option>
                        <option value="weekdays">Weekdays Only</option>
                        <option value="weekends">Weekends Only</option>
                        <option value="custom">Custom Days</option>
                    </select>
                </div>

                <div class="form-group" id="customDaysGroup" style="display: none;">
                    <label>Select Days</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" value="0" class="day-check"> Sun
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" value="1" class="day-check"> Mon
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" value="2" class="day-check"> Tue
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" value="3" class="day-check"> Wed
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" value="4" class="day-check"> Thu
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" value="5" class="day-check"> Fri
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" value="6" class="day-check"> Sat
                        </label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-delete" id="deleteHabitBtn" style="display: none;" onclick="deleteHabit()">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('habitModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const ICONS = ['üí™', 'üìö', 'üßò', 'üíß', 'üèÉ', '‚úçÔ∏è', 'üé∏', 'üí§', 'ü•ó', 'üíä', 'üßπ', 'üí∞', 'üì±', 'üéØ', 'üåÖ', 'üß†'];
        const COLORS = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'];
        const QUOTES = [
            "The secret of your future is hidden in your daily routine.",
            "We are what we repeatedly do. Excellence is not an act, but a habit.",
            "Small daily improvements are the key to staggering long-term results.",
            "Motivation is what gets you started. Habit is what keeps you going.",
            "Your habits shape your identity, and your identity shapes your habits.",
            "Success is the sum of small efforts repeated day in and day out.",
            "The chains of habit are too light to be felt until they are too heavy to be broken.",
            "First we make our habits, then our habits make us."
        ];

        let data = {
            habits: [],
            completions: {} // { "2024-01-01": { habitId: true } }
        };

        let selectedDate = new Date();
        let calendarDate = new Date();
        let selectedIcon = ICONS[0];
        let selectedColor = COLORS[0];

        function init() {
            loadData();
            setupUI();
            render();
            showRandomQuote();
        }

        function loadData() {
            const saved = localStorage.getItem('habitTracker');
            if (saved) {
                data = JSON.parse(saved);
            }
        }

        function saveData() {
            localStorage.setItem('habitTracker', JSON.stringify(data));
        }

        function setupUI() {
            // Icon picker
            const iconPicker = document.getElementById('iconPicker');
            iconPicker.innerHTML = ICONS.map(icon =>
                `<div class="icon-option ${icon === selectedIcon ? 'selected' : ''}" onclick="selectIcon('${icon}')">${icon}</div>`
            ).join('');

            // Color picker
            const colorPicker = document.getElementById('colorPicker');
            colorPicker.innerHTML = COLORS.map(color =>
                `<div class="color-option ${color === selectedColor ? 'selected' : ''}" style="background: ${color}" onclick="selectColor('${color}')"></div>`
            ).join('');

            // Frequency change handler
            document.getElementById('habitFrequency').addEventListener('change', (e) => {
                document.getElementById('customDaysGroup').style.display =
                    e.target.value === 'custom' ? 'block' : 'none';
            });

            // Modal close
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal.id);
                });
            });
        }

        function render() {
            updateDateDisplay();
            renderHabits();
            renderCalendar();
            updateStats();
        }

        function updateDateDisplay() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent =
                selectedDate.toLocaleDateString('en-US', options);
        }

        function changeDate(delta) {
            selectedDate.setDate(selectedDate.getDate() + delta);
            render();
        }

        function renderHabits() {
            const list = document.getElementById('habitsList');
            const dateKey = getDateKey(selectedDate);
            const dayOfWeek = selectedDate.getDay();

            const activeHabits = data.habits.filter(h => isHabitActiveOnDay(h, dayOfWeek));

            if (activeHabits.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <p>No habits for this day. Add a new habit to get started!</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = activeHabits.map(habit => {
                const completed = data.completions[dateKey]?.[habit.id] || false;
                const streak = calculateStreak(habit);

                return `
                    <div class="habit-card">
                        <div class="habit-checkbox ${completed ? 'checked' : ''}" onclick="toggleHabit('${habit.id}')">
                            ${completed ? '‚úì' : ''}
                        </div>
                        <span class="habit-icon">${habit.icon}</span>
                        <div class="habit-info">
                            <div class="habit-name">${escapeHtml(habit.name)}</div>
                            <div class="habit-streak">
                                ${streak > 0 ? `<span class="streak-fire">üî• ${streak} day${streak > 1 ? 's' : ''}</span>` : ''}
                                <span>Best: ${habit.bestStreak || 0}</span>
                            </div>
                        </div>
                        <div class="habit-actions">
                            <button class="habit-action-btn" onclick="editHabit('${habit.id}')">‚úèÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function isHabitActiveOnDay(habit, dayOfWeek) {
            switch (habit.frequency) {
                case 'daily':
                    return true;
                case 'weekdays':
                    return dayOfWeek >= 1 && dayOfWeek <= 5;
                case 'weekends':
                    return dayOfWeek === 0 || dayOfWeek === 6;
                case 'custom':
                    return habit.customDays?.includes(dayOfWeek);
                default:
                    return true;
            }
        }

        function toggleHabit(habitId) {
            const dateKey = getDateKey(selectedDate);
            if (!data.completions[dateKey]) {
                data.completions[dateKey] = {};
            }
            data.completions[dateKey][habitId] = !data.completions[dateKey][habitId];

            // Update best streak
            const habit = data.habits.find(h => h.id === habitId);
            if (habit) {
                const currentStreak = calculateStreak(habit);
                if (currentStreak > (habit.bestStreak || 0)) {
                    habit.bestStreak = currentStreak;
                }
            }

            saveData();
            render();
        }

        function calculateStreak(habit) {
            let streak = 0;
            let date = new Date();

            // Start from today and go backwards
            while (true) {
                const dayOfWeek = date.getDay();
                if (!isHabitActiveOnDay(habit, dayOfWeek)) {
                    date.setDate(date.getDate() - 1);
                    continue;
                }

                const dateKey = getDateKey(date);
                if (data.completions[dateKey]?.[habit.id]) {
                    streak++;
                    date.setDate(date.getDate() - 1);
                } else {
                    // If today and not completed, don't break (allow checking streak from yesterday)
                    if (streak === 0 && getDateKey(date) === getDateKey(new Date())) {
                        date.setDate(date.getDate() - 1);
                        continue;
                    }
                    break;
                }

                // Safety limit
                if (streak > 1000) break;
            }

            return streak;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');

            title.textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPadding = firstDay.getDay();

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = days.map(d => `<div class="calendar-day-header">${d}</div>`).join('');

            // Previous month padding
            const prevMonth = new Date(year, month, 0);
            for (let i = startPadding - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">${prevMonth.getDate() - i}</div>`;
            }

            // Current month days
            const today = new Date();
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const date = new Date(year, month, d);
                const dateKey = getDateKey(date);
                const isToday = date.toDateString() === today.toDateString();

                const dayOfWeek = date.getDay();
                const activeHabits = data.habits.filter(h => isHabitActiveOnDay(h, dayOfWeek));
                const completed = activeHabits.filter(h => data.completions[dateKey]?.[h.id]);

                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (activeHabits.length > 0) {
                    if (completed.length === activeHabits.length) {
                        dayClass += ' completed';
                    } else if (completed.length > 0) {
                        dayClass += ' partial';
                    }
                }

                html += `<div class="${dayClass}">${d}</div>`;
            }

            // Next month padding
            const totalCells = startPadding + lastDay.getDate();
            const remaining = (7 - (totalCells % 7)) % 7;
            for (let d = 1; d <= remaining; d++) {
                html += `<div class="calendar-day other-month">${d}</div>`;
            }

            grid.innerHTML = html;
        }

        function changeCalendarMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        }

        function updateStats() {
            const today = getDateKey(new Date());
            const todayHabits = data.habits.filter(h => isHabitActiveOnDay(h, new Date().getDay()));
            const todayCompleted = todayHabits.filter(h => data.completions[today]?.[h.id]).length;

            document.getElementById('todayCompleted').textContent = `${todayCompleted}/${todayHabits.length}`;

            // Longest streak
            const longestStreak = Math.max(0, ...data.habits.map(h => h.bestStreak || 0));
            document.getElementById('longestStreak').textContent = longestStreak;

            // Total completions
            let totalCompletions = 0;
            Object.values(data.completions).forEach(day => {
                totalCompletions += Object.values(day).filter(Boolean).length;
            });
            document.getElementById('totalCompletions').textContent = totalCompletions;

            // Completion rate (last 30 days)
            let possibleCompletions = 0;
            let actualCompletions = 0;
            for (let i = 0; i < 30; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateKey = getDateKey(date);
                const dayOfWeek = date.getDay();

                data.habits.forEach(h => {
                    if (isHabitActiveOnDay(h, dayOfWeek)) {
                        possibleCompletions++;
                        if (data.completions[dateKey]?.[h.id]) {
                            actualCompletions++;
                        }
                    }
                });
            }

            const rate = possibleCompletions > 0 ? Math.round(actualCompletions / possibleCompletions * 100) : 0;
            document.getElementById('completionRate').textContent = rate + '%';
        }

        // Habit Modal
        function openHabitModal(habit = null) {
            document.getElementById('habitModalTitle').textContent = habit ? 'Edit Habit' : 'New Habit';
            document.getElementById('habitForm').reset();
            document.getElementById('habitId').value = habit ? habit.id : '';
            document.getElementById('deleteHabitBtn').style.display = habit ? 'block' : 'none';
            document.getElementById('customDaysGroup').style.display = 'none';

            selectedIcon = habit ? habit.icon : ICONS[0];
            selectedColor = habit ? habit.color : COLORS[0];

            if (habit) {
                document.getElementById('habitName').value = habit.name;
                document.getElementById('habitFrequency').value = habit.frequency;

                if (habit.frequency === 'custom') {
                    document.getElementById('customDaysGroup').style.display = 'block';
                    document.querySelectorAll('.day-check').forEach(cb => {
                        cb.checked = habit.customDays?.includes(parseInt(cb.value));
                    });
                }
            }

            updateIconPicker();
            updateColorPicker();
            document.getElementById('habitModal').classList.add('active');
        }

        function editHabit(id) {
            const habit = data.habits.find(h => h.id === id);
            if (habit) openHabitModal(habit);
        }

        function selectIcon(icon) {
            selectedIcon = icon;
            updateIconPicker();
        }

        function selectColor(color) {
            selectedColor = color;
            updateColorPicker();
        }

        function updateIconPicker() {
            document.querySelectorAll('.icon-option').forEach(el => {
                el.classList.toggle('selected', el.textContent === selectedIcon);
            });
        }

        function updateColorPicker() {
            document.querySelectorAll('.color-option').forEach(el => {
                el.classList.toggle('selected', el.style.background === selectedColor);
            });
        }

        function saveHabit(e) {
            e.preventDefault();
            const id = document.getElementById('habitId').value;

            let customDays = [];
            if (document.getElementById('habitFrequency').value === 'custom') {
                document.querySelectorAll('.day-check:checked').forEach(cb => {
                    customDays.push(parseInt(cb.value));
                });
            }

            const habit = {
                id: id || generateId(),
                name: document.getElementById('habitName').value,
                icon: selectedIcon,
                color: selectedColor,
                frequency: document.getElementById('habitFrequency').value,
                customDays,
                bestStreak: id ? (data.habits.find(h => h.id === id)?.bestStreak || 0) : 0,
                createdAt: id ? data.habits.find(h => h.id === id)?.createdAt : new Date().toISOString()
            };

            if (id) {
                const idx = data.habits.findIndex(h => h.id === id);
                data.habits[idx] = habit;
            } else {
                data.habits.push(habit);
            }

            saveData();
            closeModal('habitModal');
            render();
        }

        function deleteHabit() {
            const id = document.getElementById('habitId').value;
            if (confirm('Delete this habit and all its history?')) {
                data.habits = data.habits.filter(h => h.id !== id);
                // Remove completions for this habit
                Object.keys(data.completions).forEach(dateKey => {
                    delete data.completions[dateKey][id];
                });
                saveData();
                closeModal('habitModal');
                render();
            }
        }

        function showRandomQuote() {
            const quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            document.getElementById('quote').textContent = `"${quote}"`;
        }

        // Export/Import
        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habits-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (imported.habits) {
                        if (confirm('Replace existing data?')) {
                            data = imported;
                            saveData();
                            render();
                            alert('Imported successfully!');
                        }
                    }
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        init();
    </script>
</body>
</html>
