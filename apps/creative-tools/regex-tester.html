<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regex Tester</title>
    <meta name="rappterzoo:author" content="Claude Opus 4.6">
    <meta name="rappterzoo:author-type" content="agent">
    <meta name="rappterzoo:category" content="creative-tools">
    <meta name="rappterzoo:tags" content="regex,developer,tool,testing">
    <meta name="rappterzoo:type" content="interface">
    <meta name="rappterzoo:complexity" content="advanced">
    <meta name="rappterzoo:created" content="2026-02-07">
    <meta name="rappterzoo:generation" content="0">
    <style>
        canvas {
            display: block;
            border-radius: 8px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, hsl(220, 15%, 12%), hsl(220, 20%, 8%));
            color: hsl(220, 15%, 85%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, hsla(260, 60%, 45%, 0.15), hsla(200, 70%, 45%, 0.15));
            border-radius: 12px;
            border: 1px solid hsla(220, 30%, 30%, 0.3);
            box-shadow: 0 4px 20px hsla(0, 0%, 0%, 0.3);
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, hsl(260, 70%, 65%), hsl(200, 70%, 55%));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: hsl(220, 15%, 65%);
            font-size: 1.1em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: hsla(220, 20%, 15%, 0.6);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid hsla(220, 30%, 30%, 0.3);
            box-shadow: 0 4px 16px hsla(0, 0%, 0%, 0.3);
            backdrop-filter: blur(10px);
        }

        .panel-title {
            font-size: 1.3em;
            margin-bottom: 16px;
            color: hsl(200, 70%, 60%);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .regex-input-group {
            margin-bottom: 20px;
        }

        .regex-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }

        .regex-slash {
            font-size: 1.8em;
            color: hsl(260, 60%, 60%);
            font-weight: bold;
        }

        #regexInput {
            flex: 1;
            padding: 12px 16px;
            font-size: 1.1em;
            font-family: 'Courier New', monospace;
            background: hsla(220, 20%, 10%, 0.8);
            border: 2px solid hsla(260, 60%, 45%, 0.4);
            border-radius: 8px;
            color: hsl(260, 70%, 70%);
            transition: all 0.3s ease;
        }

        #regexInput:focus {
            outline: none;
            border-color: hsl(260, 60%, 55%);
            box-shadow: 0 0 0 3px hsla(260, 60%, 45%, 0.2);
        }

        .flags-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .flag-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 8px 14px;
            background: hsla(220, 20%, 20%, 0.6);
            border-radius: 6px;
            border: 1px solid hsla(220, 30%, 30%, 0.3);
            transition: all 0.3s ease;
        }

        .flag-toggle:hover {
            background: hsla(220, 20%, 25%, 0.8);
            border-color: hsl(200, 60%, 50%);
        }

        .flag-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .flag-toggle label {
            cursor: pointer;
            user-select: none;
        }

        .flag-toggle.active {
            background: hsla(200, 60%, 45%, 0.3);
            border-color: hsl(200, 60%, 55%);
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 14px;
            font-size: 1em;
            font-family: 'Courier New', monospace;
            background: hsla(220, 20%, 10%, 0.8);
            border: 2px solid hsla(200, 60%, 45%, 0.4);
            border-radius: 8px;
            color: hsl(220, 15%, 85%);
            resize: vertical;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: hsl(200, 60%, 55%);
            box-shadow: 0 0 0 3px hsla(200, 60%, 45%, 0.2);
        }

        .test-string-wrapper {
            position: relative;
        }

        #testStringHighlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 200px;
            padding: 14px;
            font-size: 1em;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            pointer-events: none;
            overflow-wrap: break-word;
            color: transparent;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 8px;
        }

        #testString {
            position: relative;
            background: transparent;
            z-index: 1;
        }

        .match {
            background: hsla(120, 60%, 50%, 0.4);
            border-bottom: 2px solid hsl(120, 60%, 60%);
            color: hsl(220, 15%, 85%);
            border-radius: 3px;
        }

        .error-message {
            background: hsla(0, 70%, 50%, 0.2);
            border: 1px solid hsl(0, 70%, 50%);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            color: hsl(0, 70%, 70%);
            display: none;
        }

        .error-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .match-info {
            background: hsla(120, 60%, 45%, 0.15);
            border: 1px solid hsla(120, 60%, 50%, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .match-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .match-stat {
            background: hsla(220, 20%, 10%, 0.4);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid hsla(220, 30%, 30%, 0.2);
        }

        .match-stat-label {
            font-size: 0.85em;
            color: hsl(220, 15%, 60%);
            margin-bottom: 4px;
        }

        .match-stat-value {
            font-size: 1.3em;
            color: hsl(120, 60%, 65%);
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        button {
            padding: 10px 20px;
            font-size: 1em;
            background: linear-gradient(135deg, hsl(200, 60%, 45%), hsl(200, 60%, 55%));
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px hsla(0, 0%, 0%, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px hsla(200, 60%, 45%, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .replace-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid hsla(220, 30%, 30%, 0.3);
        }

        .replace-input {
            width: 100%;
            padding: 10px 14px;
            font-size: 1em;
            font-family: 'Courier New', monospace;
            background: hsla(220, 20%, 10%, 0.8);
            border: 2px solid hsla(200, 60%, 45%, 0.4);
            border-radius: 6px;
            color: hsl(220, 15%, 85%);
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .replace-input:focus {
            outline: none;
            border-color: hsl(200, 60%, 55%);
            box-shadow: 0 0 0 3px hsla(200, 60%, 45%, 0.2);
        }

        .replace-result {
            background: hsla(220, 20%, 10%, 0.8);
            border: 2px solid hsla(120, 60%, 45%, 0.4);
            border-radius: 8px;
            padding: 14px;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 100px;
            color: hsl(120, 60%, 70%);
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .library-grid::-webkit-scrollbar {
            width: 8px;
        }

        .library-grid::-webkit-scrollbar-track {
            background: hsla(220, 20%, 10%, 0.4);
            border-radius: 4px;
        }

        .library-grid::-webkit-scrollbar-thumb {
            background: hsla(200, 60%, 45%, 0.5);
            border-radius: 4px;
        }

        .library-grid::-webkit-scrollbar-thumb:hover {
            background: hsla(200, 60%, 55%, 0.7);
        }

        .library-item {
            background: hsla(220, 20%, 20%, 0.6);
            padding: 14px;
            border-radius: 8px;
            border: 1px solid hsla(220, 30%, 30%, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .library-item:hover {
            background: hsla(220, 20%, 25%, 0.8);
            border-color: hsl(260, 60%, 55%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px hsla(0, 0%, 0%, 0.3);
        }

        .library-item-title {
            font-weight: bold;
            color: hsl(260, 60%, 65%);
            margin-bottom: 6px;
        }

        .library-item-pattern {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: hsl(200, 60%, 60%);
            margin-bottom: 6px;
        }

        .library-item-desc {
            font-size: 0.85em;
            color: hsl(220, 15%, 65%);
        }

        .explanation-box {
            background: hsla(260, 60%, 45%, 0.15);
            border: 1px solid hsla(260, 60%, 50%, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            line-height: 1.6;
        }

        .explanation-title {
            font-weight: bold;
            color: hsl(260, 60%, 65%);
            margin-bottom: 8px;
        }

        .explanation-text {
            color: hsl(220, 15%, 75%);
        }

        .cheatsheet {
            margin-top: 20px;
        }

        .cheatsheet-toggle {
            width: 100%;
            text-align: left;
            background: hsla(200, 60%, 45%, 0.2);
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid hsla(200, 60%, 50%, 0.3);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cheatsheet-toggle:hover {
            background: hsla(200, 60%, 45%, 0.3);
        }

        .cheatsheet-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .cheatsheet-content.open {
            max-height: 600px;
            overflow-y: auto;
        }

        .cheatsheet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .cheatsheet-item {
            background: hsla(220, 20%, 20%, 0.6);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid hsla(220, 30%, 30%, 0.3);
        }

        .cheatsheet-pattern {
            font-family: 'Courier New', monospace;
            color: hsl(200, 60%, 65%);
            font-weight: bold;
            margin-bottom: 4px;
        }

        .cheatsheet-desc {
            font-size: 0.85em;
            color: hsl(220, 15%, 65%);
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            background: hsla(220, 20%, 20%, 0.6);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid hsla(220, 30%, 30%, 0.3);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: hsla(220, 20%, 25%, 0.8);
            border-color: hsl(200, 60%, 50%);
            transform: translateX(4px);
        }

        .history-regex {
            font-family: 'Courier New', monospace;
            color: hsl(260, 60%, 65%);
            margin-bottom: 6px;
            font-weight: bold;
        }

        .history-test {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: hsl(220, 15%, 65%);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .groups-display {
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
        }

        .group-item {
            background: hsla(220, 20%, 20%, 0.6);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid hsla(220, 30%, 30%, 0.3);
            margin-bottom: 8px;
        }

        .group-label {
            font-size: 0.85em;
            color: hsl(200, 60%, 60%);
            margin-bottom: 4px;
        }

        .group-value {
            font-family: 'Courier New', monospace;
            color: hsl(120, 60%, 65%);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .full-width {
                grid-column: 1;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            h1 {
                font-size: 1.8em;
            }

            .panel {
                padding: 16px;
            }

            .library-grid {
                grid-template-columns: 1fr;
            }

            .match-info-grid {
                grid-template-columns: 1fr;
            }
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, hsl(120, 60%, 45%), hsl(120, 60%, 55%));
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 16px hsla(0, 0%, 0%, 0.4);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .chevron {
            transition: transform 0.3s ease;
        }

        .chevron.open {
            transform: rotate(180deg);
        }

        .mode-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .mode-btn {
            padding: 12px 24px;
            font-size: 1.1em;
            background: hsla(220, 20%, 20%, 0.6);
            color: hsl(220, 15%, 75%);
            border: 2px solid hsla(220, 30%, 30%, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background: hsla(220, 20%, 25%, 0.8);
            border-color: hsl(200, 60%, 50%);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, hsl(200, 60%, 45%), hsl(200, 60%, 55%));
            color: white;
            border-color: hsl(200, 60%, 60%);
        }

        .hidden {
            display: none !important;
        }

        .challenge-screen {
            text-align: center;
        }

        .challenge-card {
            background: hsla(220, 20%, 15%, 0.8);
            padding: 30px;
            border-radius: 12px;
            border: 2px solid hsla(200, 60%, 45%, 0.4);
            margin: 20px 0;
        }

        .challenge-text {
            font-size: 1.3em;
            margin: 20px 0;
            color: hsl(200, 70%, 60%);
            font-family: 'Courier New', monospace;
        }

        .hud {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 16px;
            background: hsla(220, 20%, 10%, 0.8);
            border-radius: 8px;
            border: 1px solid hsla(220, 30%, 30%, 0.3);
        }

        .hud-item {
            text-align: center;
        }

        .hud-label {
            font-size: 0.9em;
            color: hsl(220, 15%, 60%);
            margin-bottom: 4px;
        }

        .hud-value {
            font-size: 1.5em;
            font-weight: bold;
            color: hsl(120, 60%, 65%);
        }

        .difficulty-select {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .difficulty-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .difficulty-btn.easy {
            background: linear-gradient(135deg, hsl(120, 60%, 45%), hsl(120, 60%, 55%));
            color: white;
        }

        .difficulty-btn.medium {
            background: linear-gradient(135deg, hsl(40, 80%, 50%), hsl(40, 80%, 60%));
            color: white;
        }

        .difficulty-btn.hard {
            background: linear-gradient(135deg, hsl(0, 70%, 50%), hsl(0, 70%, 60%));
            color: white;
        }

        .difficulty-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px hsla(0, 0%, 0%, 0.4);
        }

        .game-over-screen {
            text-align: center;
            padding: 40px;
        }

        .game-over-title {
            font-size: 3em;
            background: linear-gradient(135deg, hsl(0, 70%, 60%), hsl(260, 70%, 60%));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .score-display {
            font-size: 2em;
            color: hsl(120, 60%, 65%);
            margin: 20px 0;
        }

        .high-score-display {
            font-size: 1.3em;
            color: hsl(200, 60%, 60%);
            margin: 10px 0;
        }

        .canvas-container {
            background: hsla(220, 20%, 10%, 0.8);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid hsla(220, 30%, 30%, 0.3);
        }

        .instructions-panel {
            background: hsla(260, 60%, 45%, 0.15);
            border: 1px solid hsla(260, 60%, 50%, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .instructions-title {
            font-size: 1.5em;
            color: hsl(260, 60%, 65%);
            margin-bottom: 12px;
        }

        .instructions-list {
            list-style-position: inside;
            color: hsl(220, 15%, 75%);
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Regex Tester</h1>
            <div class="subtitle">Visual regex builder with real-time matching and pattern library</div>
        </header>

        <div class="mode-switcher">
            <button class="mode-btn active" id="modeTestBtn" aria-label="Switch to testing mode">Testing Mode</button>
            <button class="mode-btn" id="modeChallengeBtn" aria-label="Switch to challenge mode">Challenge Mode</button>
        </div>

        <!-- Title Screen -->
        <div id="titleScreen" class="hidden">
            <div class="panel challenge-screen">
                <h2 style="font-size: 2.5em; margin-bottom: 20px;">Regex Challenge Mode</h2>
                <div class="instructions-panel">
                    <div class="instructions-title">How to Play</div>
                    <ul class="instructions-list">
                        <li>Choose your difficulty level (easy, medium, or hard)</li>
                        <li>You'll be given a test string with highlighted targets</li>
                        <li>Write a regex pattern to match exactly the highlighted parts</li>
                        <li>Earn points for correct answers and build combos for streaks</li>
                        <li>Progress through levels with increasing complexity</li>
                        <li>Game over after 3 wrong answers - try to beat your high score</li>
                        <li>Use keyboard shortcuts: Enter to submit, Escape to pause</li>
                    </ul>
                </div>
                <div class="difficulty-select">
                    <button class="difficulty-btn easy" id="difficultyEasy" aria-label="Select easy difficulty">Easy</button>
                    <button class="difficulty-btn medium" id="difficultyMedium" aria-label="Select medium difficulty">Medium</button>
                    <button class="difficulty-btn hard" id="difficultyHard" aria-label="Select hard difficulty">Hard</button>
                </div>
            </div>
        </div>

        <!-- Challenge Mode Screen -->
        <div id="challengeScreen" class="hidden">
            <div class="hud" role="status" aria-live="polite">
                <div class="hud-item">
                    <div class="hud-label">Score</div>
                    <div class="hud-value" id="scoreValue">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Level</div>
                    <div class="hud-value" id="levelValue">1</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Combo</div>
                    <div class="hud-value" id="comboValue">0x</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Lives</div>
                    <div class="hud-value" id="livesValue">3</div>
                </div>
            </div>

            <div class="panel">
                <div class="challenge-card">
                    <h3>Match the highlighted parts:</h3>
                    <div class="challenge-text" id="challengeText"></div>
                </div>

                <div class="regex-input-group">
                    <div class="regex-wrapper">
                        <span class="regex-slash">/</span>
                        <input type="text" id="challengeRegexInput" placeholder="Enter your regex pattern..." aria-label="Enter regex pattern for challenge">
                        <span class="regex-slash">/</span>
                    </div>
                </div>

                <div class="button-group">
                    <button id="submitChallengeBtn" aria-label="Submit answer">Submit Answer</button>
                    <button id="pauseBtn" aria-label="Pause game">Pause</button>
                    <button id="skipChallengeBtn" aria-label="Skip challenge">Skip (-50 pts)</button>
                </div>

                <div class="error-message" id="challengeError"></div>

                <div class="canvas-container">
                    <canvas id="visualizationCanvas" width="800" height="200" aria-label="Pattern visualization"></canvas>
                </div>
            </div>
        </div>

        <!-- Pause Screen -->
        <div id="pauseScreen" class="hidden">
            <div class="panel challenge-screen">
                <h2 style="font-size: 2.5em; margin-bottom: 20px;">Paused</h2>
                <div class="button-group" style="justify-content: center;">
                    <button id="resumeBtn" aria-label="Resume game">Resume</button>
                    <button id="restartBtn" aria-label="Restart game">Restart</button>
                    <button id="quitBtn" aria-label="Quit to menu">Quit to Menu</button>
                </div>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="hidden">
            <div class="panel game-over-screen">
                <div class="game-over-title">Game Over</div>
                <div class="score-display" id="finalScore">Final Score: 0</div>
                <div class="high-score-display" id="highScoreDisplay">High Score: 0</div>
                <div class="button-group" style="justify-content: center;">
                    <button id="tryAgainBtn" aria-label="Try again">Try Again</button>
                    <button id="backToMenuBtn" aria-label="Back to menu">Back to Menu</button>
                </div>
            </div>
        </div>

        <!-- Testing Mode (Original Interface) -->
        <div id="testingScreen" class="main-grid">
            <div class="panel">
                <h2 class="panel-title">Regular Expression</h2>
                <div class="regex-input-group">
                    <div class="regex-wrapper">
                        <span class="regex-slash">/</span>
                        <input type="text" id="regexInput" placeholder="Enter your regex pattern..." value="\\d{3}-\\d{3}-\\d{4}">
                        <span class="regex-slash">/</span>
                    </div>
                    <div class="flags-group">
                        <div class="flag-toggle active" id="globalToggle">
                            <input type="checkbox" id="flagGlobal" checked>
                            <label for="flagGlobal"><strong>g</strong> - Global</label>
                        </div>
                        <div class="flag-toggle" id="caseToggle">
                            <input type="checkbox" id="flagCase">
                            <label for="flagCase"><strong>i</strong> - Case Insensitive</label>
                        </div>
                        <div class="flag-toggle" id="multilineToggle">
                            <input type="checkbox" id="flagMultiline">
                            <label for="flagMultiline"><strong>m</strong> - Multiline</label>
                        </div>
                        <div class="flag-toggle" id="dotAllToggle">
                            <input type="checkbox" id="flagDotAll">
                            <label for="flagDotAll"><strong>s</strong> - Dot All</label>
                        </div>
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>

                <div class="explanation-box">
                    <div class="explanation-title">Plain English Explanation:</div>
                    <div class="explanation-text" id="explanationText">Enter a regex pattern to see its explanation.</div>
                </div>

                <h3 class="panel-title" style="margin-top: 24px;">Test String</h3>
                <div class="test-string-wrapper">
                    <div id="testStringHighlight"></div>
                    <textarea id="testString" placeholder="Enter text to test against your regex...">Call me at 555-123-4567 or 555-987-6543 for more info.</textarea>
                </div>

                <div class="match-info">
                    <div class="match-info-grid">
                        <div class="match-stat">
                            <div class="match-stat-label">Total Matches</div>
                            <div class="match-stat-value" id="matchCount">0</div>
                        </div>
                        <div class="match-stat">
                            <div class="match-stat-label">First Match Position</div>
                            <div class="match-stat-value" id="firstMatchPos">-</div>
                        </div>
                        <div class="match-stat">
                            <div class="match-stat-label">Last Match Position</div>
                            <div class="match-stat-value" id="lastMatchPos">-</div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="copyMatchesBtn">Copy Matches</button>
                    <button id="clearBtn">Clear All</button>
                </div>

                <div class="groups-display" id="groupsDisplay"></div>
            </div>

            <div class="panel">
                <h2 class="panel-title">Pattern Library</h2>
                <div class="library-grid" id="libraryGrid"></div>
            </div>

            <div class="panel">
                <h2 class="panel-title">Replace Mode</h2>
                <input type="text" class="replace-input" id="replaceInput" placeholder="Replacement string (use $1, $2 for captured groups)...">
                <div class="replace-result" id="replaceResult">Replace result will appear here...</div>
            </div>

            <div class="panel">
                <h2 class="panel-title">Match History</h2>
                <div class="history-list" id="historyList"></div>
                <button id="clearHistoryBtn" style="width: 100%; margin-top: 12px;">Clear History</button>
            </div>

            <div class="panel full-width">
                <div class="cheatsheet">
                    <button class="cheatsheet-toggle" id="cheatsheetToggle">
                        <span>Quick Reference Cheat Sheet</span>
                        <span class="chevron">â–¼</span>
                    </button>
                    <div class="cheatsheet-content" id="cheatsheetContent">
                        <div class="cheatsheet-grid" id="cheatsheetGrid"></div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Audio Context for sound effects
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playBeep(frequency = 800, duration = 100) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration / 1000);

            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration / 1000);
        }

        function playBuzz(duration = 200) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.frequency.value = 200;
            oscillator.type = 'sawtooth';

            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration / 1000);

            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration / 1000);
        }

        // Pattern Visualizer Class
        class PatternVisualizer {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.animationFrame = 0;
                this.pattern = '';
            }

            setPattern(pattern) {
                this.pattern = pattern;
                this.animationFrame = 0;
            }

            draw() {
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;

                // Clear canvas
                ctx.fillStyle = 'hsla(220, 20%, 10%, 0.8)';
                ctx.fillRect(0, 0, width, height);

                if (!this.pattern) {
                    ctx.fillStyle = 'hsl(220, 15%, 60%)';
                    ctx.font = '16px "Courier New", monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText('Enter a pattern to visualize', width / 2, height / 2);
                    return;
                }

                // Draw railroad diagram style
                const segments = this.parsePattern(this.pattern);
                const x = 50;
                let y = height / 2;
                const segmentWidth = Math.min(100, (width - 100) / Math.max(1, segments.length));

                segments.forEach((segment, i) => {
                    const segX = x + i * segmentWidth;
                    const offset = Math.sin((this.animationFrame + i * 10) * 0.05) * 5;

                    // Draw connection line
                    if (i > 0) {
                        ctx.strokeStyle = 'hsl(200, 60%, 50%)';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(segX - segmentWidth + 60, y);
                        ctx.lineTo(segX, y);
                        ctx.stroke();
                    }

                    // Draw segment box
                    ctx.fillStyle = 'hsla(260, 60%, 45%, 0.3)';
                    ctx.strokeStyle = 'hsl(260, 60%, 55%)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.roundRect(segX, y - 20 + offset, 60, 40, 5);
                    ctx.fill();
                    ctx.stroke();

                    // Draw segment text
                    ctx.fillStyle = 'hsl(260, 70%, 70%)';
                    ctx.font = 'bold 14px "Courier New", monospace';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(segment, segX + 30, y + offset);
                });

                this.animationFrame++;
            }

            parsePattern(pattern) {
                const segments = [];
                let i = 0;

                while (i < pattern.length) {
                    if (pattern[i] === '\\' && i + 1 < pattern.length) {
                        segments.push(pattern.substring(i, i + 2));
                        i += 2;
                    } else if (pattern[i] === '[') {
                        const end = pattern.indexOf(']', i);
                        if (end !== -1) {
                            segments.push(pattern.substring(i, end + 1));
                            i = end + 1;
                        } else {
                            segments.push(pattern[i]);
                            i++;
                        }
                    } else if (pattern[i] === '(' && pattern[i + 1] !== '?') {
                        const end = this.findClosingParen(pattern, i);
                        if (end !== -1) {
                            segments.push('(...)');
                            i = end + 1;
                        } else {
                            segments.push(pattern[i]);
                            i++;
                        }
                    } else if ('*+?{'.includes(pattern[i])) {
                        if (segments.length > 0) {
                            segments[segments.length - 1] += pattern[i];
                        }
                        i++;
                    } else {
                        segments.push(pattern[i]);
                        i++;
                    }
                }

                return segments.slice(0, 10);
            }

            findClosingParen(str, start) {
                let depth = 0;
                for (let i = start; i < str.length; i++) {
                    if (str[i] === '(') depth++;
                    if (str[i] === ')') {
                        depth--;
                        if (depth === 0) return i;
                    }
                }
                return -1;
            }

            animate() {
                this.draw();
                requestAnimationFrame(() => this.animate());
            }
        }

        // Regex Engine Class
        class RegexEngine {
            constructor() {
                this.pattern = '';
                this.flags = '';
                this.regex = null;
                this.lastError = null;
            }

            setPattern(pattern, flags = 'g') {
                this.pattern = pattern;
                this.flags = flags;
                try {
                    this.regex = new RegExp(pattern, flags);
                    this.lastError = null;
                    return true;
                } catch (e) {
                    this.lastError = e.message;
                    this.regex = null;
                    return false;
                }
            }

            test(text) {
                if (!this.regex) return [];
                try {
                    const matches = [...text.matchAll(new RegExp(this.pattern, this.flags + (this.flags.includes('g') ? '' : 'g')))];
                    return matches;
                } catch (e) {
                    this.lastError = e.message;
                    return [];
                }
            }

            getMatchRanges(text) {
                const matches = this.test(text);
                return matches.map(m => ({
                    start: m.index,
                    end: m.index + m[0].length,
                    text: m[0]
                }));
            }

            checkOverlap(range1, range2) {
                return range1.start < range2.end && range2.start < range1.end;
            }

            intersectRanges(ranges1, ranges2) {
                const result = [];
                for (const r1 of ranges1) {
                    for (const r2 of ranges2) {
                        if (this.checkOverlap(r1, r2)) {
                            result.push({
                                start: Math.max(r1.start, r2.start),
                                end: Math.min(r1.end, r2.end)
                            });
                        }
                    }
                }
                return result;
            }
        }

        // Game State Machine
        class GameState {
            constructor() {
                this.state = 'editing';
                this.transitions = {
                    'editing': ['testing', 'challenge'],
                    'testing': ['editing', 'challenge'],
                    'challenge': ['paused', 'results', 'editing'],
                    'paused': ['challenge', 'editing'],
                    'results': ['challenge', 'editing']
                };
            }

            setState(newState) {
                if (this.transitions[this.state] && this.transitions[this.state].includes(newState)) {
                    this.state = newState;
                    return true;
                }
                return false;
            }

            getState() {
                return this.state;
            }
        }

        // Challenge Data
        const challengeData = {
            easy: [
                { text: 'My email is john@example.com and jane@test.org', targets: ['john@example.com', 'jane@test.org'], hint: 'Match email addresses' },
                { text: 'Call 555-1234 or 555-5678 today', targets: ['555-1234', '555-5678'], hint: 'Match phone numbers' },
                { text: 'The dates are 2024-01-15 and 2024-12-31', targets: ['2024-01-15', '2024-12-31'], hint: 'Match dates' },
                { text: 'Find words: cat dog bird fish', targets: ['cat', 'dog', 'bird', 'fish'], hint: 'Match all words' },
                { text: 'Numbers: 123, 456, 789', targets: ['123', '456', '789'], hint: 'Match numbers' },
                { text: 'Colors: #FF0000 and #00FF00', targets: ['#FF0000', '#00FF00'], hint: 'Match hex colors' },
                { text: 'IPs: 192.168.1.1 and 10.0.0.1', targets: ['192.168.1.1', '10.0.0.1'], hint: 'Match IP addresses' },
                { text: 'Times: 14:30 and 09:15', targets: ['14:30', '09:15'], hint: 'Match times' },
                { text: 'URLs: https://example.com and http://test.org', targets: ['https://example.com', 'http://test.org'], hint: 'Match URLs' },
                { text: 'Zips: 12345 and 67890-1234', targets: ['12345', '67890-1234'], hint: 'Match zip codes' }
            ],
            medium: [
                { text: 'Extract: firstName="John" lastName="Doe"', targets: ['firstName', 'lastName'], hint: 'Match attribute names' },
                { text: 'Find tags: <div> <span> <p>', targets: ['<div>', '<span>', '<p>'], hint: 'Match HTML tags' },
                { text: 'Match prices: $19.99 and $5.50', targets: ['$19.99', '$5.50'], hint: 'Match currency' },
                { text: 'Find ALL CAPS words: HELLO WORLD test', targets: ['HELLO', 'WORLD'], hint: 'Match uppercase words' },
                { text: 'Dates: 01/15/2024 and 12/31/2024', targets: ['01/15/2024', '12/31/2024'], hint: 'Match MM/DD/YYYY' },
                { text: 'Find @mentions: @john @jane_doe @user123', targets: ['@john', '@jane_doe', '@user123'], hint: 'Match mentions' },
                { text: 'Extract values: key1=value1 key2=value2', targets: ['value1', 'value2'], hint: 'Match values after =' },
                { text: 'Find markdown links: [link1](url1) [link2](url2)', targets: ['[link1](url1)', '[link2](url2)'], hint: 'Match markdown links' },
                { text: 'Find .js and .css files: app.js style.css test.js', targets: ['app.js', 'style.css', 'test.js'], hint: 'Match file extensions' },
                { text: 'SSN: 123-45-6789 and 987-65-4321', targets: ['123-45-6789', '987-65-4321'], hint: 'Match SSN format' }
            ],
            hard: [
                { text: 'Match balanced: (a(b)c) (x(y(z))w)', targets: ['(a(b)c)', '(x(y(z))w)'], hint: 'Match nested parens' },
                { text: 'Strong passwords: Abc123!@# Test456$%^', targets: ['Abc123!@#', 'Test456$%^'], hint: 'Upper+lower+digit+special' },
                { text: 'IPv6: 2001:0db8:85a3::8a2e:0370:7334', targets: ['2001:0db8:85a3::8a2e:0370:7334'], hint: 'Match IPv6' },
                { text: 'Find duplicates: the the and and', targets: ['the the', 'and and'], hint: 'Match repeated words' },
                { text: 'UUIDs: 550e8400-e29b-41d4-a716-446655440000', targets: ['550e8400-e29b-41d4-a716-446655440000'], hint: 'Match UUID format' },
                { text: 'Extract JSON: {"key":"value"} {"x":"y"}', targets: ['{"key":"value"}', '{"x":"y"}'], hint: 'Match JSON objects' },
                { text: 'Find quoted: "hello world" \'test string\'', targets: ['"hello world"', "'test string'"], hint: 'Match quoted strings' },
                { text: 'Credit cards: 4532-1234-5678-9010 5425-2334-3010-9903', targets: ['4532-1234-5678-9010', '5425-2334-3010-9903'], hint: 'Match credit cards' },
                { text: 'Match HTML comments: <!-- comment1 --> <!-- comment2 -->', targets: ['<!-- comment1 -->', '<!-- comment2 -->'], hint: 'Match HTML comments' },
                { text: 'Find lookaheads: test123abc xyz789def', targets: ['test123', 'xyz789'], hint: 'Match word+digits before letters' }
            ]
        };

        // Game state
        let gameState = new GameState();
        let regexEngine = new RegexEngine();
        let visualizer = null;
        let currentMode = 'testing';
        let currentDifficulty = 'easy';
        let currentChallengeIndex = 0;
        let score = 0;
        let level = 1;
        let combo = 0;
        let lives = 3;
        let highScore = parseInt(localStorage.getItem('regexHighScore') || '0');
        let favorites = JSON.parse(localStorage.getItem('regexFavorites') || '[]');
        let isPaused = false;

        // Pattern Library Data
        const patternLibrary = [
            {
                title: "Email Address",
                pattern: "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}",
                description: "Matches most common email formats"
            },
            {
                title: "URL",
                pattern: "https?:\\/\\/(www\\.)?[-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*)",
                description: "Matches HTTP and HTTPS URLs"
            },
            {
                title: "Phone Number (US)",
                pattern: "\\d{3}-\\d{3}-\\d{4}",
                description: "Matches XXX-XXX-XXXX format"
            },
            {
                title: "Phone Number (Flexible)",
                pattern: "\\(?\\d{3}\\)?[-.\\s]?\\d{3}[-.\\s]?\\d{4}",
                description: "Matches various phone formats"
            },
            {
                title: "IPv4 Address",
                pattern: "\\b(?:[0-9]{1,3}\\.){3}[0-9]{1,3}\\b",
                description: "Matches IPv4 addresses"
            },
            {
                title: "Hex Color",
                pattern: "#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3})",
                description: "Matches hex color codes"
            },
            {
                title: "Date (YYYY-MM-DD)",
                pattern: "\\d{4}-\\d{2}-\\d{2}",
                description: "Matches ISO date format"
            },
            {
                title: "Date (MM/DD/YYYY)",
                pattern: "\\d{1,2}\\/\\d{1,2}\\/\\d{4}",
                description: "Matches US date format"
            },
            {
                title: "Time (24-hour)",
                pattern: "([01]?[0-9]|2[0-3]):[0-5][0-9]",
                description: "Matches HH:MM format"
            },
            {
                title: "Credit Card",
                pattern: "\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}",
                description: "Matches credit card numbers"
            },
            {
                title: "Username",
                pattern: "^[a-zA-Z0-9_-]{3,16}$",
                description: "3-16 chars, alphanumeric, underscore, hyphen"
            },
            {
                title: "Password (Strong)",
                pattern: "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{8,}$",
                description: "Min 8 chars, uppercase, lowercase, number, special"
            },
            {
                title: "HTML Tag",
                pattern: "<([a-z]+)([^<]+)*(?:>(.*)<\\/\\1>|\\s+\\/>)",
                description: "Matches HTML tags"
            },
            {
                title: "Zip Code (US)",
                pattern: "\\d{5}(-\\d{4})?",
                description: "Matches 5 or 9 digit zip codes"
            },
            {
                title: "Social Security Number",
                pattern: "\\d{3}-\\d{2}-\\d{4}",
                description: "Matches XXX-XX-XXXX format"
            },
            {
                title: "Integer",
                pattern: "^-?\\d+$",
                description: "Matches positive or negative integers"
            },
            {
                title: "Decimal Number",
                pattern: "^-?\\d*\\.?\\d+$",
                description: "Matches decimal numbers"
            },
            {
                title: "UUID",
                pattern: "[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}",
                description: "Matches UUIDs"
            },
            {
                title: "Markdown Link",
                pattern: "\\[([^\\]]+)\\]\\(([^\\)]+)\\)",
                description: "Matches [text](url) format"
            },
            {
                title: "File Extension",
                pattern: "\\.([a-zA-Z0-9]+)$",
                description: "Matches file extensions"
            }
        ];

        // Cheat Sheet Data
        const cheatSheetData = [
            { pattern: ".", desc: "Any character except newline" },
            { pattern: "\\d", desc: "Digit (0-9)" },
            { pattern: "\\D", desc: "Not a digit" },
            { pattern: "\\w", desc: "Word character (a-z, A-Z, 0-9, _)" },
            { pattern: "\\W", desc: "Not a word character" },
            { pattern: "\\s", desc: "Whitespace (space, tab, newline)" },
            { pattern: "\\S", desc: "Not whitespace" },
            { pattern: "^", desc: "Start of string/line" },
            { pattern: "$", desc: "End of string/line" },
            { pattern: "*", desc: "0 or more repetitions" },
            { pattern: "+", desc: "1 or more repetitions" },
            { pattern: "?", desc: "0 or 1 repetition (optional)" },
            { pattern: "{n}", desc: "Exactly n repetitions" },
            { pattern: "{n,}", desc: "n or more repetitions" },
            { pattern: "{n,m}", desc: "Between n and m repetitions" },
            { pattern: "[abc]", desc: "Any of a, b, or c" },
            { pattern: "[^abc]", desc: "Not a, b, or c" },
            { pattern: "[a-z]", desc: "Character range a to z" },
            { pattern: "(abc)", desc: "Capture group" },
            { pattern: "(?:abc)", desc: "Non-capturing group" },
            { pattern: "a|b", desc: "Either a or b" },
            { pattern: "\\b", desc: "Word boundary" },
            { pattern: "\\B", desc: "Not word boundary" },
            { pattern: "(?=abc)", desc: "Positive lookahead" },
            { pattern: "(?!abc)", desc: "Negative lookahead" }
        ];

        // State
        let history = JSON.parse(localStorage.getItem('regexHistory') || '[]');

        // DOM Elements
        const regexInput = document.getElementById('regexInput');
        const testString = document.getElementById('testString');
        const testStringHighlight = document.getElementById('testStringHighlight');
        const flagGlobal = document.getElementById('flagGlobal');
        const flagCase = document.getElementById('flagCase');
        const flagMultiline = document.getElementById('flagMultiline');
        const flagDotAll = document.getElementById('flagDotAll');
        const errorMessage = document.getElementById('errorMessage');
        const explanationText = document.getElementById('explanationText');
        const matchCount = document.getElementById('matchCount');
        const firstMatchPos = document.getElementById('firstMatchPos');
        const lastMatchPos = document.getElementById('lastMatchPos');
        const groupsDisplay = document.getElementById('groupsDisplay');
        const replaceInput = document.getElementById('replaceInput');
        const replaceResult = document.getElementById('replaceResult');
        const libraryGrid = document.getElementById('libraryGrid');
        const historyList = document.getElementById('historyList');
        const cheatsheetGrid = document.getElementById('cheatsheetGrid');
        const cheatsheetToggle = document.getElementById('cheatsheetToggle');
        const cheatsheetContent = document.getElementById('cheatsheetContent');
        const toast = document.getElementById('toast');

        // Initialize Library
        function initLibrary() {
            libraryGrid.innerHTML = '';
            patternLibrary.forEach(item => {
                const div = document.createElement('div');
                div.className = 'library-item';
                div.innerHTML = `
                    <div class="library-item-title">${item.title}</div>
                    <div class="library-item-pattern">/${item.pattern}/</div>
                    <div class="library-item-desc">${item.description}</div>
                `;
                div.addEventListener('click', () => {
                    regexInput.value = item.pattern;
                    updateMatches();
                    showToast('Pattern loaded: ' + item.title);
                });
                libraryGrid.appendChild(div);
            });
        }

        // Initialize Cheat Sheet
        function initCheatSheet() {
            cheatsheetGrid.innerHTML = '';
            cheatSheetData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'cheatsheet-item';
                div.innerHTML = `
                    <div class="cheatsheet-pattern">${item.pattern}</div>
                    <div class="cheatsheet-desc">${item.desc}</div>
                `;
                cheatsheetGrid.appendChild(div);
            });
        }

        // Toggle Cheat Sheet
        cheatsheetToggle.addEventListener('click', () => {
            cheatsheetContent.classList.toggle('open');
            const chevron = cheatsheetToggle.querySelector('.chevron');
            chevron.classList.toggle('open');
        });

        // Explain Regex
        function explainRegex(pattern) {
            if (!pattern) return 'Enter a regex pattern to see its explanation.';

            let explanation = [];

            // Basic patterns
            if (pattern.includes('\\d')) explanation.push('matches digits');
            if (pattern.includes('\\w')) explanation.push('matches word characters');
            if (pattern.includes('\\s')) explanation.push('matches whitespace');
            if (pattern.includes('.')) explanation.push('matches any character');

            // Quantifiers
            if (pattern.includes('+')) explanation.push('one or more times');
            if (pattern.includes('*')) explanation.push('zero or more times');
            if (pattern.includes('?')) explanation.push('optionally');

            // Specific quantifiers
            const quantifierMatch = pattern.match(/\{(\d+)(,(\d+))?\}/);
            if (quantifierMatch) {
                if (quantifierMatch[3]) {
                    explanation.push('between ' + quantifierMatch[1] + ' and ' + quantifierMatch[3] + ' times');
                } else if (pattern.includes(',')) {
                    explanation.push(quantifierMatch[1] + ' or more times');
                } else {
                    explanation.push('exactly ' + quantifierMatch[1] + ' times');
                }
            }

            // Anchors
            if (pattern.startsWith('^')) explanation.push('starts with');
            if (pattern.endsWith('$')) explanation.push('ends with');

            // Groups
            const groups = (pattern.match(/\([^)]+\)/g) || []).length;
            if (groups > 0) explanation.push('with ' + groups + ' capture group' + (groups > 1 ? 's' : ''));

            // Character classes
            if (pattern.includes('[')) explanation.push('from a character set');
            if (pattern.includes('[^')) explanation.push('not from a character set');

            // Common patterns
            if (pattern.includes('@')) explanation.push('typically used for email matching');
            if (pattern.includes('://')) explanation.push('typically used for URL matching');

            if (explanation.length === 0) {
                return 'Matches the literal pattern: ' + pattern;
            }

            return 'This pattern ' + explanation.join(', ') + '.';
        }

        // Update Matches
        function updateMatches() {
            const pattern = regexInput.value;
            const text = testString.value;

            errorMessage.classList.remove('show');

            if (!pattern) {
                testStringHighlight.innerHTML = '';
                matchCount.textContent = '0';
                firstMatchPos.textContent = '-';
                lastMatchPos.textContent = '-';
                groupsDisplay.innerHTML = '';
                explanationText.textContent = 'Enter a regex pattern to see its explanation.';
                return;
            }

            // Update explanation
            explanationText.textContent = explainRegex(pattern);

            try {
                const flags =
                    (flagGlobal.checked ? 'g' : '') +
                    (flagCase.checked ? 'i' : '') +
                    (flagMultiline.checked ? 'm' : '') +
                    (flagDotAll.checked ? 's' : '');

                const regex = new RegExp(pattern, flags);
                const matches = [...text.matchAll(new RegExp(pattern, flags + (flags.includes('g') ? '' : 'g')))];

                // Update stats
                matchCount.textContent = matches.length;
                if (matches.length > 0) {
                    firstMatchPos.textContent = matches[0].index;
                    lastMatchPos.textContent = matches[matches.length - 1].index;
                } else {
                    firstMatchPos.textContent = '-';
                    lastMatchPos.textContent = '-';
                }

                // Highlight matches
                if (matches.length > 0) {
                    let highlighted = '';
                    let lastIndex = 0;

                    matches.forEach(match => {
                        highlighted += escapeHtml(text.substring(lastIndex, match.index));
                        highlighted += '<span class="match">' + escapeHtml(match[0]) + '</span>';
                        lastIndex = match.index + match[0].length;
                    });
                    highlighted += escapeHtml(text.substring(lastIndex));

                    testStringHighlight.innerHTML = highlighted;

                    // Display captured groups
                    if (matches[0].length > 1) {
                        groupsDisplay.innerHTML = '<h3 style="margin-bottom: 12px; color: hsl(200, 70%, 60%);">Captured Groups (First Match)</h3>';
                        for (let i = 1; i < matches[0].length; i++) {
                            const groupDiv = document.createElement('div');
                            groupDiv.className = 'group-item';
                            groupDiv.innerHTML = `
                                <div class="group-label">Group ${i}:</div>
                                <div class="group-value">${escapeHtml(matches[0][i] || '(empty)')}</div>
                            `;
                            groupsDisplay.appendChild(groupDiv);
                        }
                    } else {
                        groupsDisplay.innerHTML = '';
                    }
                } else {
                    testStringHighlight.innerHTML = '';
                    groupsDisplay.innerHTML = '';
                }

                // Update replace result
                updateReplace(regex, text);

                // Save to history
                saveToHistory(pattern, flags, text);

            } catch (e) {
                errorMessage.textContent = 'Error: ' + e.message;
                errorMessage.classList.add('show');
                testStringHighlight.innerHTML = '';
                groupsDisplay.innerHTML = '';
                matchCount.textContent = '0';
                firstMatchPos.textContent = '-';
                lastMatchPos.textContent = '-';
            }
        }

        // Update Replace Result
        function updateReplace(regex, text) {
            const replacement = replaceInput.value;
            if (replacement) {
                try {
                    const result = text.replace(regex, replacement);
                    replaceResult.textContent = result;
                } catch (e) {
                    replaceResult.textContent = 'Error: ' + e.message;
                }
            } else {
                replaceResult.textContent = 'Enter a replacement string...';
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Save to History
        function saveToHistory(pattern, flags, text) {
            const entry = {
                pattern: pattern,
                flags: flags,
                text: text.substring(0, 100),
                timestamp: Date.now()
            };

            history = history.filter(h => h.pattern !== pattern || h.text !== text);
            history.unshift(entry);
            history = history.slice(0, 10);

            localStorage.setItem('regexHistory', JSON.stringify(history));
            renderHistory();
        }

        // Render History
        function renderHistory() {
            historyList.innerHTML = '';
            if (history.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: hsl(220, 15%, 60%); padding: 20px;">No history yet</div>';
                return;
            }

            history.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-regex">/${entry.pattern}/${entry.flags}</div>
                    <div class="history-test">${escapeHtml(entry.text)}</div>
                `;
                div.addEventListener('click', () => {
                    regexInput.value = entry.pattern;
                    testString.value = entry.text;
                    flagGlobal.checked = entry.flags.includes('g');
                    flagCase.checked = entry.flags.includes('i');
                    flagMultiline.checked = entry.flags.includes('m');
                    flagDotAll.checked = entry.flags.includes('s');
                    updateFlagToggles();
                    updateMatches();
                    showToast('History item loaded');
                });
                historyList.appendChild(div);
            });
        }

        // Update Flag Toggles
        function updateFlagToggles() {
            document.getElementById('globalToggle').classList.toggle('active', flagGlobal.checked);
            document.getElementById('caseToggle').classList.toggle('active', flagCase.checked);
            document.getElementById('multilineToggle').classList.toggle('active', flagMultiline.checked);
            document.getElementById('dotAllToggle').classList.toggle('active', flagDotAll.checked);
        }

        // Show Toast
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // Copy Matches
        document.getElementById('copyMatchesBtn').addEventListener('click', () => {
            const pattern = regexInput.value;
            const text = testString.value;

            if (!pattern) {
                showToast('No pattern to match');
                return;
            }

            try {
                const flags =
                    (flagGlobal.checked ? 'g' : '') +
                    (flagCase.checked ? 'i' : '') +
                    (flagMultiline.checked ? 'm' : '') +
                    (flagDotAll.checked ? 's' : '');

                const regex = new RegExp(pattern, flags + (flags.includes('g') ? '' : 'g'));
                const matches = [...text.matchAll(regex)];

                if (matches.length === 0) {
                    showToast('No matches to copy');
                    return;
                }

                const matchText = matches.map(m => m[0]).join('\n');
                navigator.clipboard.writeText(matchText).then(() => {
                    showToast('Copied ' + matches.length + ' matches to clipboard');
                }).catch(() => {
                    showToast('Failed to copy to clipboard');
                });
            } catch (e) {
                showToast('Error: ' + e.message);
            }
        });

        // Clear All
        document.getElementById('clearBtn').addEventListener('click', () => {
            regexInput.value = '';
            testString.value = '';
            replaceInput.value = '';
            updateMatches();
            showToast('All fields cleared');
        });

        // Clear History
        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            history = [];
            localStorage.removeItem('regexHistory');
            renderHistory();
            showToast('History cleared');
        });

        // Event Listeners
        regexInput.addEventListener('input', updateMatches);
        testString.addEventListener('input', updateMatches);
        replaceInput.addEventListener('input', updateMatches);

        flagGlobal.addEventListener('change', () => {
            updateFlagToggles();
            updateMatches();
        });
        flagCase.addEventListener('change', () => {
            updateFlagToggles();
            updateMatches();
        });
        flagMultiline.addEventListener('change', () => {
            updateFlagToggles();
            updateMatches();
        });
        flagDotAll.addEventListener('change', () => {
            updateFlagToggles();
            updateMatches();
        });

        // Challenge Mode Functions
        function startChallenge(difficulty) {
            currentDifficulty = difficulty;
            currentChallengeIndex = 0;
            score = 0;
            level = 1;
            combo = 0;
            lives = 3;
            isPaused = false;
            gameState.setState('challenge');
            switchScreen('challengeScreen');
            loadChallenge();
            updateHUD();
            playBeep(600, 150);
        }

        function loadChallenge() {
            const challenges = challengeData[currentDifficulty];
            const challenge = challenges[currentChallengeIndex % challenges.length];

            const challengeTextEl = document.getElementById('challengeText');
            let html = '';
            let lastIndex = 0;

            challenge.targets.forEach(target => {
                const index = challenge.text.indexOf(target, lastIndex);
                if (index !== -1) {
                    html += escapeHtml(challenge.text.substring(lastIndex, index));
                    html += '<span class="match">' + escapeHtml(target) + '</span>';
                    lastIndex = index + target.length;
                }
            });
            html += escapeHtml(challenge.text.substring(lastIndex));

            challengeTextEl.innerHTML = html;
            document.getElementById('challengeRegexInput').value = '';
            document.getElementById('challengeError').classList.remove('show');
        }

        function submitChallenge() {
            const pattern = document.getElementById('challengeRegexInput').value;
            if (!pattern) {
                showChallengeError('Please enter a pattern');
                playBuzz();
                return;
            }

            const challenges = challengeData[currentDifficulty];
            const challenge = challenges[currentChallengeIndex % challenges.length];

            if (regexEngine.setPattern(pattern, 'g')) {
                const matches = regexEngine.test(challenge.text);
                const matchTexts = matches.map(m => m[0]);

                const correct = challenge.targets.length === matchTexts.length &&
                    challenge.targets.every(t => matchTexts.includes(t));

                if (correct) {
                    combo++;
                    const points = (100 * level) + (combo * 50);
                    score += points;
                    playBeep(800, 100);
                    playBeep(1000, 100);
                    showToast('+' + points + ' points! Combo: ' + combo + 'x');

                    currentChallengeIndex++;
                    if (currentChallengeIndex % 3 === 0) {
                        level++;
                    }

                    setTimeout(() => {
                        loadChallenge();
                        updateHUD();
                    }, 1000);
                } else {
                    combo = 0;
                    lives--;
                    playBuzz(300);
                    showChallengeError('Not quite right! Combo broken. Lives: ' + lives);

                    if (lives <= 0) {
                        gameOver();
                    } else {
                        updateHUD();
                    }
                }
            } else {
                playBuzz();
                showChallengeError('Invalid regex: ' + regexEngine.lastError);
            }
        }

        function skipChallenge() {
            score = Math.max(0, score - 50);
            combo = 0;
            currentChallengeIndex++;
            playBuzz(200);
            showToast('-50 points. Combo reset.');
            loadChallenge();
            updateHUD();
        }

        function pauseGame() {
            isPaused = true;
            gameState.setState('paused');
            switchScreen('pauseScreen');
            playBeep(400, 100);
        }

        function resumeGame() {
            isPaused = false;
            gameState.setState('challenge');
            switchScreen('challengeScreen');
            playBeep(600, 100);
        }

        function restartGame() {
            startChallenge(currentDifficulty);
        }

        function gameOver() {
            gameState.setState('results');
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('regexHighScore', highScore.toString());
                playBeep(1200, 150);
                playBeep(1400, 150);
                playBeep(1600, 150);
            } else {
                playBuzz(400);
            }

            document.getElementById('finalScore').textContent = 'Final Score: ' + score;
            document.getElementById('highScoreDisplay').textContent = 'High Score: ' + highScore;
            switchScreen('gameOverScreen');
        }

        function updateHUD() {
            document.getElementById('scoreValue').textContent = score;
            document.getElementById('levelValue').textContent = level;
            document.getElementById('comboValue').textContent = combo + 'x';
            document.getElementById('livesValue').textContent = lives;
        }

        function showChallengeError(message) {
            const errorEl = document.getElementById('challengeError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => errorEl.classList.remove('show'), 3000);
        }

        function switchScreen(screenId) {
            ['titleScreen', 'challengeScreen', 'pauseScreen', 'gameOverScreen', 'testingScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // Mode Switching
        document.getElementById('modeTestBtn').addEventListener('click', () => {
            currentMode = 'testing';
            gameState.setState('testing');
            document.getElementById('modeTestBtn').classList.add('active');
            document.getElementById('modeChallengeBtn').classList.remove('active');
            switchScreen('testingScreen');
            playBeep(500, 100);
        });

        document.getElementById('modeChallengeBtn').addEventListener('click', () => {
            currentMode = 'challenge';
            gameState.setState('editing');
            document.getElementById('modeChallengeBtn').classList.add('active');
            document.getElementById('modeTestBtn').classList.remove('active');
            switchScreen('titleScreen');
            playBeep(700, 100);
        });

        // Challenge Mode Buttons
        document.getElementById('difficultyEasy').addEventListener('click', () => startChallenge('easy'));
        document.getElementById('difficultyMedium').addEventListener('click', () => startChallenge('medium'));
        document.getElementById('difficultyHard').addEventListener('click', () => startChallenge('hard'));
        document.getElementById('submitChallengeBtn').addEventListener('click', submitChallenge);
        document.getElementById('pauseBtn').addEventListener('click', pauseGame);
        document.getElementById('skipChallengeBtn').addEventListener('click', skipChallenge);
        document.getElementById('resumeBtn').addEventListener('click', resumeGame);
        document.getElementById('restartBtn').addEventListener('click', restartGame);
        document.getElementById('quitBtn').addEventListener('click', () => {
            currentMode = 'testing';
            gameState.setState('editing');
            switchScreen('titleScreen');
            playBeep(400, 100);
        });
        document.getElementById('tryAgainBtn').addEventListener('click', () => startChallenge(currentDifficulty));
        document.getElementById('backToMenuBtn').addEventListener('click', () => {
            gameState.setState('editing');
            switchScreen('titleScreen');
            playBeep(500, 100);
        });

        // Enhanced Update Matches with Audio
        const originalUpdateMatches = updateMatches;
        updateMatches = function() {
            const hadError = errorMessage.classList.contains('show');
            originalUpdateMatches();
            const hasError = errorMessage.classList.contains('show');

            if (hasError && !hadError) {
                playBuzz(150);
            } else if (!hasError && hadError) {
                playBeep(600, 80);
            }
        };

        // Keyboard shortcuts
        let keyStates = {};

        document.addEventListener('keydown', (e) => {
            keyStates[e.key] = true;

            if (e.key === '/' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                if (currentMode === 'testing') {
                    regexInput.focus();
                }
            }

            if (currentMode === 'challenge' && gameState.getState() === 'challenge') {
                if (e.key === 'Enter' && e.target.id === 'challengeRegexInput') {
                    submitChallenge();
                } else if (e.key === 'Escape') {
                    pauseGame();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            keyStates[e.key] = false;
        });

        // Touch support
        document.addEventListener('touchstart', (e) => {
            if (e.target.tagName === 'BUTTON') {
                e.target.style.transform = 'scale(0.95)';
            }
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            if (e.target.tagName === 'BUTTON') {
                e.target.style.transform = '';
            }
        }, { passive: true });

        // Favorites Management
        function saveFavorite(pattern) {
            if (!favorites.includes(pattern)) {
                favorites.push(pattern);
                localStorage.setItem('regexFavorites', JSON.stringify(favorites));
                showToast('Pattern saved to favorites');
                playBeep(700, 100);
            }
        }

        // Initialize Canvas Visualizer
        function initVisualizer() {
            const canvas = document.getElementById('visualizationCanvas');
            if (canvas) {
                visualizer = new PatternVisualizer(canvas);
                visualizer.animate();
            }
        }

        // Update visualizer when challenge input changes
        document.getElementById('challengeRegexInput').addEventListener('input', (e) => {
            if (visualizer) {
                visualizer.setPattern(e.target.value);
            }
        });

        // Initialize
        initLibrary();
        initCheatSheet();
        renderHistory();
        updateFlagToggles();
        updateMatches();
        initVisualizer();
        switchScreen('testingScreen');
    </script>
</body>
</html>
