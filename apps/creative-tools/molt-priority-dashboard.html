<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="rappterzoo:author" content="copilot-agent">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="creative-tools">
<meta name="rappterzoo:tags" content="dashboard,analytics,molt,data-viz">
<meta name="rappterzoo:type" content="interface">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2025-07-25">
<meta name="rappterzoo:generation" content="0">
<title>Molt Priority Dashboard ‚Äî RappterZoo</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:14px}
body{background:#0e1113;color:#d7dadc;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;overflow-x:hidden}
a{color:#58a6ff;text-decoration:none}
a:hover{text-decoration:underline}

/* Header */
.header{background:#161a1e;border-bottom:1px solid #30363d;padding:10px 20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;position:sticky;top:0;z-index:100}
.header h1{font-size:1.1rem;white-space:nowrap;color:#e6edf3}
.header h1 span{color:#ff6b9d}
.stat-pills{display:flex;gap:8px;flex-wrap:wrap;flex:1}
.stat-pill{background:#1a1d21;border:1px solid #30363d;border-radius:6px;padding:5px 10px;font-size:.78rem;display:flex;align-items:center;gap:6px;white-space:nowrap}
.stat-pill .label{color:#8b949e}
.stat-pill .value{color:#e6edf3;font-weight:600}
.stat-pill .value.red{color:#ff4444}
.stat-pill .value.green{color:#4caf50}
.stat-pill .value.blue{color:#58a6ff}
.progress-bar-wrap{width:80px;height:6px;background:#21262d;border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:4px}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,#ff4444,#4caf50);border-radius:3px;transition:width .5s}
.live-counter{font-size:.72rem;color:#8b949e;margin-left:auto;white-space:nowrap}
.live-counter span{color:#58a6ff;font-weight:700;font-variant-numeric:tabular-nums}

/* Layout */
.main{display:flex;gap:16px;padding:16px;min-height:calc(100vh - 52px)}
.queue-panel{flex:0 0 65%;min-width:0;display:flex;flex-direction:column}
.sidebar{flex:1;min-width:280px;display:flex;flex-direction:column;gap:16px}

/* Panels */
.panel{background:#1a1d21;border:1px solid #30363d;border-radius:8px;overflow:hidden}
.panel-head{padding:10px 14px;border-bottom:1px solid #30363d;font-size:.82rem;font-weight:600;color:#e6edf3;display:flex;align-items:center;justify-content:space-between}

/* Queue controls */
.queue-controls{display:flex;gap:8px;padding:10px 14px;border-bottom:1px solid #21262d;background:#161a1e}
.queue-controls input{flex:1;background:#0e1113;border:1px solid #30363d;border-radius:6px;padding:6px 10px;color:#d7dadc;font-size:.82rem;outline:none}
.queue-controls input:focus{border-color:#58a6ff}
.queue-controls select{background:#0e1113;border:1px solid #30363d;border-radius:6px;padding:6px 8px;color:#d7dadc;font-size:.82rem;outline:none;cursor:pointer}

/* Queue list */
.queue-list{flex:1;overflow-y:auto;position:relative}
.queue-list::-webkit-scrollbar{width:6px}
.queue-list::-webkit-scrollbar-track{background:#0e1113}
.queue-list::-webkit-scrollbar-thumb{background:#30363d;border-radius:3px}
.queue-row{display:grid;grid-template-columns:36px 14px 1fr 110px 130px 70px 60px 70px;align-items:center;gap:8px;padding:7px 14px;border-bottom:1px solid #161a1e;cursor:default;transition:background .15s}
.queue-row:hover{background:#21262d}
.queue-rank{font-size:.78rem;color:#8b949e;text-align:right;font-weight:500}
.cat-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.queue-title{font-size:.82rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.queue-title a{color:#e6edf3}
.queue-title a:hover{color:#58a6ff}
.queue-cat{font-size:.72rem;color:#8b949e;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gen-badge{font-size:.68rem;font-weight:700;padding:2px 7px;border-radius:10px;text-align:center;white-space:nowrap}
.gen-0{background:rgba(255,68,68,.15);color:#ff4444;animation:pulse-red 2s infinite}
.gen-1{background:rgba(255,152,0,.15);color:#ff9800}
.gen-2{background:rgba(255,193,7,.15);color:#ffc107}
.gen-3{background:rgba(139,195,74,.15);color:#8bc34a}
.gen-4{background:rgba(76,175,80,.15);color:#4caf50}
.gen-5{background:rgba(33,150,243,.15);color:#2196f3}
@keyframes pulse-red{0%,100%{opacity:1}50%{opacity:.55}}
.queue-quality{font-size:.78rem;text-align:center}
.queue-days{font-size:.72rem;color:#8b949e;text-align:center}
.queue-urgency{font-size:.82rem;font-weight:700;text-align:center}
.urgency-high{color:#ff4444}
.urgency-mid{color:#ff9800}
.urgency-low{color:#4caf50}

/* Charts */
.chart-wrap{padding:10px;position:relative}
.chart-wrap canvas{width:100%;display:block}
.chart-tooltip{position:absolute;background:#0e1113;border:1px solid #30363d;border-radius:6px;padding:6px 10px;font-size:.72rem;pointer-events:none;opacity:0;transition:opacity .15s;z-index:10;white-space:nowrap}

/* Loading / Error */
.loading{display:flex;align-items:center;justify-content:center;height:200px;color:#8b949e;font-size:.9rem}
.loading::after{content:'';width:20px;height:20px;border:2px solid #30363d;border-top-color:#58a6ff;border-radius:50%;animation:spin .6s linear infinite;margin-left:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.error-msg{padding:20px;text-align:center;color:#ff4444;font-size:.85rem}

/* Responsive */
@media(max-width:900px){
  .main{flex-direction:column}
  .queue-panel{flex:none;max-height:60vh}
  .sidebar{flex-direction:row;flex-wrap:wrap}
  .sidebar .panel{flex:1;min-width:260px}
  .queue-row{grid-template-columns:30px 10px 1fr 80px 56px 56px;font-size:.75rem}
  .queue-cat,.queue-days{display:none}
}
@media(max-width:500px){
  .header{padding:8px 10px;gap:8px}
  .stat-pills{gap:4px}
  .stat-pill{padding:3px 6px;font-size:.7rem}
  .sidebar{flex-direction:column}
}
</style>
</head>
<body>

<div class="header">
  <h1>üß¨ <span>Molt</span> Priority</h1>
  <div class="stat-pills" id="statPills">
    <div class="stat-pill"><span class="label">Apps</span><span class="value" id="sTotalApps">‚Äî</span></div>
    <div class="stat-pill"><span class="label">Molted</span><span class="value green" id="sMolted">‚Äî</span><span class="label">/</span><span class="value red" id="sUnmolted">‚Äî</span><div class="progress-bar-wrap"><div class="progress-bar-fill" id="sMoltBar" style="width:0%"></div></div></div>
    <div class="stat-pill"><span class="label">Avg Quality</span><span class="value" id="sAvgQ">‚Äî</span></div>
    <div class="stat-pill"><span class="label">Avg Gen</span><span class="value blue" id="sAvgGen">‚Äî</span></div>
    <div class="stat-pill"><span class="label">Most Urgent</span><span class="value red" id="sMostUrgent">‚Äî</span></div>
  </div>
  <div class="live-counter">‚è± Saved ~<span id="liveCounter">0</span> min</div>
</div>

<div class="main">
  <div class="queue-panel panel">
    <div class="panel-head">Priority Queue <span id="queueCount" style="font-weight:400;color:#8b949e;font-size:.75rem"></span></div>
    <div class="queue-controls">
      <input type="text" id="searchInput" placeholder="Search apps‚Ä¶" autocomplete="off">
      <select id="sortSelect">
        <option value="urgency">Urgency ‚Üì</option>
        <option value="quality">Quality ‚Üë</option>
        <option value="generation">Generation ‚Üë</option>
        <option value="age">Oldest first</option>
        <option value="name">Name A‚ÄìZ</option>
      </select>
    </div>
    <div class="queue-list" id="queueList"><div class="loading">Loading apps</div></div>
  </div>

  <div class="sidebar">
    <div class="panel">
      <div class="panel-head">Category Molt Coverage</div>
      <div class="chart-wrap" id="donutWrap"><canvas id="donutChart" height="220"></canvas><div class="chart-tooltip" id="donutTip"></div></div>
    </div>
    <div class="panel">
      <div class="panel-head">Generation Distribution</div>
      <div class="chart-wrap" id="barWrap"><canvas id="barChart" height="160"></canvas><div class="chart-tooltip" id="barTip"></div></div>
    </div>
    <div class="panel">
      <div class="panel-head">Quality vs Generation</div>
      <div class="chart-wrap" id="scatterWrap"><canvas id="scatterChart" height="200"></canvas><div class="chart-tooltip" id="scatterTip"></div></div>
    </div>
  </div>
</div>

<script>
(function(){
'use strict';

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let allApps = [];
let categoryMeta = {};
let filtered = [];
let sortKey = localStorage.getItem('molt-dash-sort') || 'urgency';

/* ‚îÄ‚îÄ Fetch helpers ‚îÄ‚îÄ */
function fetchJSON(url){ return fetch(url).then(r=>{if(!r.ok)throw new Error(r.status);return r.json()}) }

async function loadData(){
  const [manifest, rankings, community, archive] = await Promise.allSettled([
    fetchJSON('../manifest.json'),
    fetchJSON('../rankings.json'),
    fetchJSON('../community.json'),
    fetchJSON('../archive/manifest.json')
  ]);

  const mData = manifest.status === 'fulfilled' ? manifest.value : null;
  const rData = rankings.status === 'fulfilled' ? rankings.value : null;
  const cData = community.status === 'fulfilled' ? community.value : null;
  const aData = archive.status === 'fulfilled' ? archive.value : null;

  if(!mData){
    document.getElementById('queueList').innerHTML = '<div class="error-msg">Failed to load manifest.json</div>';
    return;
  }

  // Build score lookup from rankings
  const scoreLookup = {};
  if(rData){
    // rankings array (top-level "rankings" key has full data, fallback to top_playable or categories)
    const rList = rData.rankings || rData.top_playable || (Array.isArray(rData.categories) ? rData.categories : []);
    rList.forEach(r => {
      if(r.file) scoreLookup[r.file] = { score: r.score || r.algo_score || 0, grade: r.grade || '?' };
    });
  }

  // Build rating count lookup from community
  const ratingLookup = {};
  if(cData && cData.ratings){
    Object.keys(cData.ratings).forEach(stem => {
      const arr = cData.ratings[stem];
      ratingLookup[stem] = Array.isArray(arr) ? arr.length : 0;
    });
  }

  // Build archive lookup
  const archiveLookup = {};
  if(aData){
    Object.keys(aData).forEach(stem => {
      archiveLookup[stem] = aData[stem];
    });
  }

  // Process all apps
  const now = Date.now();
  const cats = mData.categories || {};
  Object.keys(cats).forEach(catKey => {
    const cat = cats[catKey];
    const folder = cat.folder || catKey.replace(/_/g, '-');
    const color = cat.color || '#8b949e';
    const title = cat.title || catKey;
    categoryMeta[catKey] = { folder, color, title, total: 0, molted: 0 };

    (cat.apps || []).forEach(app => {
      const gen = typeof app.generation === 'number' ? app.generation : 0;
      const stem = (app.file || '').replace(/\.html$/i, '');
      const scoreInfo = scoreLookup[app.file] || { score: 50, grade: '?' };
      const ratingCount = ratingLookup[stem] || 0;

      // Days since last change
      let lastChangeDate = app.lastMolted || app.created || '';
      if(archiveLookup[stem] && archiveLookup[stem].lastMolted){
        const aDate = archiveLookup[stem].lastMolted;
        if(!lastChangeDate || aDate > lastChangeDate) lastChangeDate = aDate;
      }
      const daysSince = lastChangeDate ? Math.max(0, Math.floor((now - new Date(lastChangeDate).getTime()) / 86400000)) : 365;

      // Priority algorithm
      const generationBonus = (5 - gen) * 20;
      const stalenessBonus = daysSince * 0.5;
      const qualityDeficit = (100 - scoreInfo.score) * 0.3;
      const engagementWeight = Math.min(ratingCount * 0.5, 10);
      const urgency = generationBonus + stalenessBonus + qualityDeficit + engagementWeight;

      categoryMeta[catKey].total++;
      if(gen > 0) categoryMeta[catKey].molted++;

      allApps.push({
        title: app.title || stem,
        file: app.file || '',
        folder,
        catKey,
        catTitle: title,
        catColor: color,
        generation: gen,
        score: scoreInfo.score,
        grade: scoreInfo.grade,
        daysSince,
        urgency: Math.round(urgency * 10) / 10,
        ratingCount,
        created: app.created || ''
      });
    });
  });

  // Restore sort
  document.getElementById('sortSelect').value = sortKey;
  applySort();
  renderStats();
  drawDonut();
  drawBarChart();
  drawScatter();
  startCounter();
}

/* ‚îÄ‚îÄ Sorting ‚îÄ‚îÄ */
const sorters = {
  urgency: (a,b) => b.urgency - a.urgency,
  quality: (a,b) => a.score - b.score,
  generation: (a,b) => a.generation - b.generation || b.urgency - a.urgency,
  age: (a,b) => {
    const dA = a.created || '2000-01-01', dB = b.created || '2000-01-01';
    return dA < dB ? -1 : dA > dB ? 1 : 0;
  },
  name: (a,b) => a.title.localeCompare(b.title)
};

function applySort(){
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  filtered = q ? allApps.filter(a => a.title.toLowerCase().includes(q) || a.catTitle.toLowerCase().includes(q)) : allApps.slice();
  filtered.sort(sorters[sortKey] || sorters.urgency);
  renderQueue();
}

/* ‚îÄ‚îÄ Queue rendering with chunked DOM for 555 apps ‚îÄ‚îÄ */
function renderQueue(){
  const list = document.getElementById('queueList');
  const count = document.getElementById('queueCount');
  count.textContent = `(${filtered.length} apps)`;

  // Use DocumentFragment for fast initial render
  const frag = document.createDocumentFragment();
  const len = filtered.length;
  for(let i = 0; i < len; i++){
    frag.appendChild(makeRow(filtered[i], i + 1));
  }
  list.innerHTML = '';
  list.appendChild(frag);
}

function makeRow(app, rank){
  const row = document.createElement('div');
  row.className = 'queue-row';

  const genLabel = app.generation === 0 ? 'NEVER MOLTED' : app.generation === 5 ? 'Gen 5 MAX' : `Gen ${app.generation}`;
  const genClass = `gen-${app.generation}`;
  const urgClass = app.urgency > 100 ? 'urgency-high' : app.urgency >= 50 ? 'urgency-mid' : 'urgency-low';
  const gradeColor = app.grade === 'S' ? '#e040fb' : app.grade === 'A' ? '#4caf50' : app.grade === 'B' ? '#8bc34a' : app.grade === 'C' ? '#ffc107' : app.grade === 'D' ? '#ff9800' : '#ff4444';

  row.innerHTML = `<div class="queue-rank">#${rank}</div><div class="cat-dot" style="background:${app.catColor}"></div><div class="queue-title"><a href="../${app.folder}/${app.file}" target="_blank" title="${esc(app.title)}">${esc(app.title)}</a></div><div class="queue-cat">${esc(app.catTitle)}</div><div><span class="gen-badge ${genClass}">${genLabel}</span></div><div class="queue-quality" style="color:${gradeColor}">${app.score} <small>${app.grade}</small></div><div class="queue-days">${app.daysSince}d</div><div class="queue-urgency ${urgClass}">${app.urgency}</div>`;
  return row;
}

function esc(s){ const d=document.createElement('div');d.textContent=s;return d.innerHTML; }

/* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
function renderStats(){
  const total = allApps.length;
  const molted = allApps.filter(a => a.generation > 0).length;
  const unmolted = total - molted;
  const avgQ = total ? (allApps.reduce((s,a) => s + a.score, 0) / total).toFixed(1) : 0;
  const avgG = total ? (allApps.reduce((s,a) => s + a.generation, 0) / total).toFixed(2) : 0;
  const most = filtered.length ? filtered[0] : null;

  document.getElementById('sTotalApps').textContent = total;
  document.getElementById('sMolted').textContent = molted;
  document.getElementById('sUnmolted').textContent = unmolted;
  document.getElementById('sMoltBar').style.width = (total ? (molted/total*100) : 0) + '%';
  document.getElementById('sAvgQ').textContent = avgQ;
  document.getElementById('sAvgGen').textContent = avgG;

  if(most){
    const el = document.getElementById('sMostUrgent');
    el.textContent = most.title.length > 22 ? most.title.slice(0,20) + '‚Ä¶' : most.title;
    el.title = most.title;
  }
}

/* ‚îÄ‚îÄ Live counter ‚îÄ‚îÄ */
function startCounter(){
  const genSum = allApps.reduce((s,a) => s + a.generation, 0);
  const target = genSum * 12;
  let current = 0;
  const el = document.getElementById('liveCounter');
  function tick(){
    if(current < target){
      current += Math.max(1, Math.floor((target - current) * 0.03));
      if(current > target) current = target;
      el.textContent = current.toLocaleString();
      requestAnimationFrame(tick);
    } else {
      el.textContent = target.toLocaleString();
    }
  }
  requestAnimationFrame(tick);
}

/* ‚îÄ‚îÄ Donut Chart ‚îÄ‚îÄ */
function drawDonut(){
  const canvas = document.getElementById('donutChart');
  const wrap = document.getElementById('donutWrap');
  const tip = document.getElementById('donutTip');
  const dpr = window.devicePixelRatio || 1;
  const w = wrap.clientWidth - 20;
  const h = 220;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const cats = Object.keys(categoryMeta).filter(k => categoryMeta[k].total > 0);
  const totalApps = cats.reduce((s,k) => s + categoryMeta[k].total, 0);
  if(!totalApps) return;

  const cx = w / 2, cy = h / 2, outerR = Math.min(cx, cy) - 16, innerR = outerR * 0.55;
  let angle = -Math.PI / 2;
  const segments = [];

  cats.forEach(k => {
    const c = categoryMeta[k];
    const sweep = (c.total / totalApps) * Math.PI * 2;
    const pct = c.total ? Math.round(c.molted / c.total * 100) : 0;

    // Outer arc (full category)
    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(angle) * innerR, cy + Math.sin(angle) * innerR);
    ctx.arc(cx, cy, outerR, angle, angle + sweep);
    ctx.arc(cx, cy, innerR, angle + sweep, angle, true);
    ctx.closePath();
    ctx.fillStyle = c.color + '55';
    ctx.fill();

    // Molted portion
    if(c.molted > 0){
      const moltSweep = (c.molted / c.total) * sweep;
      ctx.beginPath();
      ctx.moveTo(cx + Math.cos(angle) * innerR, cy + Math.sin(angle) * innerR);
      ctx.arc(cx, cy, outerR, angle, angle + moltSweep);
      ctx.arc(cx, cy, innerR, angle + moltSweep, angle, true);
      ctx.closePath();
      ctx.fillStyle = c.color;
      ctx.fill();
    }

    // Segment edge
    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(angle) * innerR, cy + Math.sin(angle) * innerR);
    ctx.lineTo(cx + Math.cos(angle) * outerR, cy + Math.sin(angle) * outerR);
    ctx.strokeStyle = '#0e1113';
    ctx.lineWidth = 1.5;
    ctx.stroke();

    segments.push({ k, startAngle: angle, endAngle: angle + sweep, color: c.color, title: c.title, total: c.total, molted: c.molted, pct });
    angle += sweep;
  });

  // Center text
  ctx.fillStyle = '#e6edf3';
  ctx.font = 'bold 18px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  const totalMolted = Object.values(categoryMeta).reduce((s,c) => s + c.molted, 0);
  const overallPct = totalApps ? Math.round(totalMolted / totalApps * 100) : 0;
  ctx.fillText(overallPct + '%', cx, cy - 6);
  ctx.font = '11px sans-serif';
  ctx.fillStyle = '#8b949e';
  ctx.fillText('molted', cx, cy + 12);

  // Hover
  canvas.onmousemove = function(e){
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const dx = mx - cx, dy = my - cy;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if(dist < innerR || dist > outerR){ tip.style.opacity = 0; return; }
    let a = Math.atan2(dy, dx);
    if(a < -Math.PI/2) a += Math.PI * 2;
    const seg = segments.find(s => {
      let sa = s.startAngle, ea = s.endAngle;
      if(sa < -Math.PI/2){ sa += Math.PI*2; ea += Math.PI*2; }
      return a >= sa && a < ea;
    });
    if(seg){
      tip.innerHTML = `<b style="color:${seg.color}">${seg.title}</b><br>${seg.molted}/${seg.total} molted (${seg.pct}%)`;
      tip.style.opacity = 1;
      tip.style.left = Math.min(mx + 12, w - 130) + 'px';
      tip.style.top = (my - 30) + 'px';
    } else { tip.style.opacity = 0; }
  };
  canvas.onmouseleave = () => { tip.style.opacity = 0; };
}

/* ‚îÄ‚îÄ Bar Chart: Generation Distribution ‚îÄ‚îÄ */
function drawBarChart(){
  const canvas = document.getElementById('barChart');
  const wrap = document.getElementById('barWrap');
  const tip = document.getElementById('barTip');
  const dpr = window.devicePixelRatio || 1;
  const w = wrap.clientWidth - 20;
  const h = 160;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const genCounts = [0,0,0,0,0,0];
  allApps.forEach(a => { if(a.generation >= 0 && a.generation <= 5) genCounts[a.generation]++; });
  const maxCount = Math.max(...genCounts, 1);
  const genColors = ['#ff4444','#ff9800','#ffc107','#8bc34a','#4caf50','#2196f3'];
  const genLabels = ['Gen 0','Gen 1','Gen 2','Gen 3','Gen 4','Gen 5'];

  const padL = 48, padR = 14, padT = 10, padB = 6;
  const barH = (h - padT - padB) / 6 - 4;
  const barArea = w - padL - padR;
  const bars = [];

  genCounts.forEach((count, i) => {
    const y = padT + i * (barH + 4);
    const bw = Math.max(2, (count / maxCount) * barArea);

    ctx.fillStyle = genColors[i];
    ctx.beginPath();
    ctx.roundRect(padL, y, bw, barH, 3);
    ctx.fill();

    // Label
    ctx.fillStyle = '#8b949e';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    ctx.fillText(genLabels[i], padL - 6, y + barH / 2);

    // Count
    ctx.fillStyle = '#e6edf3';
    ctx.font = 'bold 11px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText(count.toString(), padL + bw + 6, y + barH / 2);

    bars.push({ y, h: barH, bw, count, i });
  });

  canvas.onmousemove = function(e){
    const rect = canvas.getBoundingClientRect();
    const my = e.clientY - rect.top, mx = e.clientX - rect.left;
    const bar = bars.find(b => my >= b.y && my <= b.y + b.h);
    if(bar){
      const pct = allApps.length ? (bar.count / allApps.length * 100).toFixed(1) : 0;
      tip.innerHTML = `<b style="color:${genColors[bar.i]}">${genLabels[bar.i]}</b>: ${bar.count} apps (${pct}%)`;
      tip.style.opacity = 1;
      tip.style.left = Math.min(mx + 12, w - 140) + 'px';
      tip.style.top = (my - 24) + 'px';
    } else { tip.style.opacity = 0; }
  };
  canvas.onmouseleave = () => { tip.style.opacity = 0; };
}

/* ‚îÄ‚îÄ Scatter: Quality vs Generation ‚îÄ‚îÄ */
function drawScatter(){
  const canvas = document.getElementById('scatterChart');
  const wrap = document.getElementById('scatterWrap');
  const tip = document.getElementById('scatterTip');
  const dpr = window.devicePixelRatio || 1;
  const w = wrap.clientWidth - 20;
  const h = 200;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const padL = 32, padR = 10, padT = 10, padB = 24;
  const plotW = w - padL - padR;
  const plotH = h - padT - padB;

  // Grid
  ctx.strokeStyle = '#21262d';
  ctx.lineWidth = 0.5;
  for(let g = 0; g <= 5; g++){
    const y = padT + plotH - (g / 5) * plotH;
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL + plotW, y); ctx.stroke();
    ctx.fillStyle = '#8b949e'; ctx.font = '9px sans-serif'; ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
    ctx.fillText(g.toString(), padL - 4, y);
  }
  for(let q = 0; q <= 100; q += 25){
    const x = padL + (q / 100) * plotW;
    ctx.beginPath(); ctx.moveTo(x, padT); ctx.lineTo(x, padT + plotH); ctx.stroke();
    ctx.fillStyle = '#8b949e'; ctx.font = '9px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'top';
    ctx.fillText(q.toString(), x, padT + plotH + 4);
  }

  // Axis labels
  ctx.fillStyle = '#8b949e'; ctx.font = '10px sans-serif';
  ctx.textAlign = 'center'; ctx.fillText('Quality Score', padL + plotW / 2, h - 2);
  ctx.save(); ctx.translate(8, padT + plotH / 2); ctx.rotate(-Math.PI/2);
  ctx.fillText('Gen', 0, 0); ctx.restore();

  // Points with jitter for overlapping
  const points = [];
  allApps.forEach(app => {
    const jx = (Math.random() - 0.5) * 6;
    const jy = (Math.random() - 0.5) * 4;
    const x = padL + (app.score / 100) * plotW + jx;
    const y = padT + plotH - (app.generation / 5) * plotH + jy;
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI * 2);
    ctx.fillStyle = app.catColor + 'aa';
    ctx.fill();
    points.push({ x, y, app });
  });

  canvas.onmousemove = function(e){
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    let closest = null, minDist = 12;
    points.forEach(p => {
      const d = Math.sqrt((mx-p.x)**2 + (my-p.y)**2);
      if(d < minDist){ minDist = d; closest = p; }
    });
    if(closest){
      const a = closest.app;
      tip.innerHTML = `<b>${esc(a.title)}</b><br>Quality: ${a.score} (${a.grade}) ¬∑ Gen ${a.generation}`;
      tip.style.opacity = 1;
      tip.style.left = Math.min(mx + 12, w - 160) + 'px';
      tip.style.top = (my - 36) + 'px';
    } else { tip.style.opacity = 0; }
  };
  canvas.onmouseleave = () => { tip.style.opacity = 0; };
}

/* ‚îÄ‚îÄ Events ‚îÄ‚îÄ */
document.getElementById('searchInput').addEventListener('input', applySort);
document.getElementById('sortSelect').addEventListener('change', function(){
  sortKey = this.value;
  localStorage.setItem('molt-dash-sort', sortKey);
  applySort();
});

window.addEventListener('resize', function(){
  if(!allApps.length) return;
  drawDonut(); drawBarChart(); drawScatter();
});

// Keyboard shortcut: / to focus search
document.addEventListener('keydown', function(e){
  if(e.key === '/' && document.activeElement.tagName !== 'INPUT'){
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
});

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
loadData().catch(err => {
  console.error('Molt Dashboard load error:', err);
  document.getElementById('queueList').innerHTML = '<div class="error-msg">Failed to load data: ' + esc(err.message) + '</div>';
});

})();
</script>
</body>
</html>
