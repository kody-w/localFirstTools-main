<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="description" content="Enhanced Multi-User Chat Application with Voice Support" />
  <meta name="theme-color" content="#742774" />
  <title>Chat Application</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/github-dark.min.css" rel="stylesheet" />

  <style>
    :root {
      --primary: #742774;
      --primary-light: #9168b6;
      --primary-dark: #4f1c4f;
      --primary-rgb: 116, 39, 116;
      --secondary: #00bcd4;
      --secondary-light: #4dd0e1;
      --accent: #ff4081;
      --success: #4caf50;
      --error: #f44336;
      --warning: #ff9800;
      --info: #2196f3;

      --gray-10: #faf9f8;
      --gray-20: #f3f2f1;
      --gray-30: #edebe9;
      --gray-40: #e1dfdd;
      --gray-50: #d2d0ce;
      --gray-60: #c8c6c4;
      --gray-80: #605e5c;
      --gray-100: #323130;
      --gray-130: #242424;

      --space-xs: 4px;
      --space-s: 8px;
      --space-m: 16px;
      --space-l: 24px;
      --space-xl: 32px;
      --space-xxl: 48px;

      --radius: 8px;
      --radius-small: 4px;
      --radius-large: 16px;
      --radius-full: 9999px;

      --shadow-small: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.12);
      --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.16);

      --header-height: 56px;
      --input-container-height: 80px;
      --safe-area-top: env(safe-area-inset-top);
      --safe-area-bottom: env(safe-area-inset-bottom);

      --transition: all 0.2s ease;
    }

    /* Dark mode variables */
    body.dark {
      --gray-10: #1a1a1a;
      --gray-20: #242424;
      --gray-30: #2d2d2d;
      --gray-40: #373737;
      --gray-50: #424242;
      --gray-60: #4d4d4d;
      --gray-80: #8a8a8a;
      --gray-100: #e0e0e0;
      --gray-130: #f5f5f5;
      --primary-light: #a47cc9;
      --shadow-small: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.4);
      --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    /* Allow text selection globally */
    body,
    div,
    span,
    p,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    code,
    pre {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    /* Only disable selection for interactive elements */
    button,
    .button,
    .fab,
    label,
    .clickable {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
      position: fixed;
      width: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        sans-serif;
      background: var(--gray-10);
      color: var(--gray-100);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* Mention Autocomplete Dropdown */
    .mention-dropdown {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--gray-30);
      border-radius: var(--radius);
      margin-bottom: var(--space-s);
      max-height: 200px;
      overflow-y: auto;
      display: none;
      box-shadow: var(--shadow-medium);
      z-index: 100;
    }

    body.dark .mention-dropdown {
      background: var(--gray-30);
    }

    .mention-dropdown.active {
      display: block;
      animation: slideUp 0.2s ease-out;
    }

    .mention-item {
      padding: var(--space-m);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: var(--space-m);
      border-bottom: 1px solid var(--gray-20);
    }

    body.dark .mention-item {
      border-bottom-color: var(--gray-40);
    }

    .mention-item:last-child {
      border-bottom: none;
    }

    .mention-item:hover,
    .mention-item.selected {
      background: rgba(var(--primary-rgb), 0.08);
    }

    .mention-item-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    .mention-item-info {
      flex: 1;
    }

    .mention-item-name {
      font-weight: 600;
      color: var(--gray-100);
      font-size: 14px;
    }

    .mention-item-url {
      font-size: 12px;
      color: var(--gray-60);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Mention Tag in Messages */
    .mention-tag {
      background: rgba(var(--primary-rgb), 0.15);
      color: var(--primary);
      padding: 2px 8px;
      border-radius: var(--radius-small);
      font-weight: 600;
      display: inline-block;
      margin: 0 2px;
    }

    body.dark .mention-tag {
      background: rgba(var(--primary-rgb), 0.25);
      color: var(--primary-light);
    }

    /* Endpoint Badge */
    .endpoint-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: rgba(var(--primary-rgb), 0.1);
      border-radius: var(--radius-full);
      font-size: 12px;
      font-weight: 600;
      color: var(--primary);
      margin-left: var(--space-s);
    }

    .endpoint-badge i {
      font-size: 10px;
    }

    /* Agent Output Styles */
    .agent-output-wrapper {
      margin: var(--space-m) 0;
      background: rgba(var(--primary-rgb), 0.05);
      border: 1px solid rgba(var(--primary-rgb), 0.15);
      border-radius: var(--radius);
      overflow: hidden;
      transition: var(--transition);
    }

    body.dark .agent-output-wrapper {
      background: rgba(var(--primary-rgb), 0.1);
      border-color: rgba(var(--primary-rgb), 0.2);
    }

    .agent-output-header {
      padding: var(--space-m);
      background: rgba(var(--primary-rgb), 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
    }

    body.dark .agent-output-header {
      background: rgba(var(--primary-rgb), 0.15);
    }

    .agent-output-header:hover {
      background: rgba(var(--primary-rgb), 0.12);
    }

    body.dark .agent-output-header:hover {
      background: rgba(var(--primary-rgb), 0.2);
    }

    .agent-output-title {
      display: flex;
      align-items: center;
      gap: var(--space-s);
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
    }

    .agent-output-title i {
      font-size: 16px;
    }

    .agent-output-toggle {
      background: none;
      border: none;
      color: var(--gray-60);
      cursor: pointer;
      transition: var(--transition);
      padding: 4px;
    }

    .agent-output-toggle:hover {
      color: var(--primary);
    }

    .agent-output-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .agent-output-content.expanded {
      max-height: 1000px;
      overflow-y: auto;
    }

    .agent-output-text {
      padding: var(--space-m);
      font-family: monospace;
      font-size: 13px;
      color: var(--gray-80);
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.5;
    }

    body.dark .agent-output-text {
      color: var(--gray-100);
    }

    /* Simple Link Styles */
    .link-wrapper {
      display: inline;
      margin: 0 2px;
    }

    .link-wrapper a {
      color: var(--primary);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .link-wrapper a:hover {
      text-decoration: underline;
      color: var(--primary-light);
    }

    .link-wrapper i {
      font-size: 12px;
    }

    /* Endpoint Management Styles */
    .endpoint-list {
      margin-top: var(--space-m);
    }

    .endpoint-item {
      padding: var(--space-m);
      background: var(--gray-20);
      border-radius: var(--radius);
      margin-bottom: var(--space-s);
      display: flex;
      align-items: center;
      gap: var(--space-m);
      transition: var(--transition);
    }

    body.dark .endpoint-item {
      background: var(--gray-30);
    }

    .endpoint-item:hover {
      background: var(--gray-30);
    }

    body.dark .endpoint-item:hover {
      background: var(--gray-40);
    }

    .endpoint-item-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .endpoint-item-info {
      flex: 1;
      min-width: 0;
    }

    .endpoint-item-name {
      font-weight: 600;
      color: var(--gray-100);
      margin-bottom: 2px;
    }

    .endpoint-item-url {
      font-size: 12px;
      color: var(--gray-60);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .endpoint-item-actions {
      display: flex;
      gap: var(--space-s);
    }

    .endpoint-item-action {
      background: var(--gray-30);
      border: none;
      color: var(--gray-80);
      width: 32px;
      height: 32px;
      border-radius: var(--radius-small);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    body.dark .endpoint-item-action {
      background: var(--gray-40);
    }

    .endpoint-item-action:hover {
      background: var(--primary);
      color: white;
    }

    .endpoint-item-action.active {
      background: var(--success);
      color: white;
    }

    /* Settings Import/Export Buttons */
    .settings-import-export {
      display: flex;
      gap: var(--space-m);
      margin-bottom: var(--space-xl);
      padding-bottom: var(--space-xl);
      border-bottom: 1px solid var(--gray-30);
    }

    .settings-import-export button {
      flex: 1;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.9;
      }

      50% {
        opacity: 0.6;
      }
    }

    /* Login Page */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%);
      padding: var(--space-m);
      animation: fadeIn 0.5s ease-out;
    }

    .login-box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: var(--space-xl);
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-large);
      width: 100%;
      max-width: 420px;
      animation: scaleIn 0.5s ease-out;
    }

    body.dark .login-box {
      background: rgba(36, 36, 36, 0.95);
    }

    .login-header {
      text-align: center;
      margin-bottom: var(--space-xl);
    }

    .login-header h1 {
      color: var(--primary);
      font-size: 32px;
      font-weight: 700;
      margin-bottom: var(--space-s);
    }

    .login-header p {
      color: var(--gray-80);
      opacity: 0.8;
      font-size: 16px;
    }

    .form-group {
      margin-bottom: var(--space-l);
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-80);
      margin-bottom: var(--space-s);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--gray-30);
      border-radius: var(--radius);
      font-size: 16px;
      transition: var(--transition);
      background: var(--gray-20);
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }

    body.dark .form-group input:focus,
    body.dark .form-group select:focus {
      background: var(--gray-30);
    }

    .login-button {
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      margin-top: var(--space-m);
    }

    .login-button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .user-list {
      margin-top: var(--space-xl);
      padding-top: var(--space-xl);
      border-top: 1px solid var(--gray-30);
    }

    .user-list h3 {
      font-size: 16px;
      color: var(--gray-80);
      margin-bottom: var(--space-m);
      font-weight: 600;
    }

    .user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-m);
      background: var(--gray-20);
      border-radius: var(--radius);
      margin-bottom: var(--space-s);
      cursor: pointer;
      transition: var(--transition);
    }

    .user-item:hover {
      background: var(--gray-30);
      transform: translateX(4px);
    }

    /* Main App Container */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--gray-10);
      overflow: hidden;
    }

    /* Header */
    .header {
      background: white;
      color: var(--gray-100);
      padding: 0 var(--space-m);
      padding-top: var(--safe-area-top);
      height: calc(var(--header-height) + var(--safe-area-top));
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-small);
      z-index: 100;
      flex-shrink: 0;
    }

    body.dark .header {
      background: var(--gray-20);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-m);
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-s);
    }

    .header-button {
      background: transparent;
      border: none;
      color: var(--gray-80);
      width: 40px;
      height: 40px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      font-size: 18px;
    }

    .header-button:hover {
      background: var(--gray-20);
      color: var(--primary);
    }

    /* Voice indicator in header */
    .voice-indicator {
      display: none;
      align-items: center;
      gap: var(--space-s);
      padding: 6px 12px;
      background: var(--primary);
      color: white;
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 500;
      animation: fadeIn 0.3s ease-out;
    }

    .voice-indicator.active {
      display: flex;
    }

    .voice-indicator i {
      font-size: 14px;
      animation: pulse 1.5s infinite;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 85%;
      max-width: 340px;
      background: white;
      box-shadow: var(--shadow-large);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 200;
      overflow-y: auto;
    }

    body.dark .sidebar {
      background: var(--gray-20);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
      z-index: 190;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .sidebar-header {
      padding: var(--space-l);
      padding-top: calc(var(--space-l) + var(--safe-area-top));
      border-bottom: 1px solid var(--gray-30);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--primary);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .sidebar-header h2 {
      font-size: 20px;
      font-weight: 600;
    }

    .sidebar-tabs {
      display: flex;
      background: var(--gray-10);
      position: sticky;
      top: calc(80px + var(--safe-area-top));
      z-index: 9;
    }

    body.dark .sidebar-tabs {
      background: var(--gray-30);
    }

    .sidebar-tab {
      flex: 1;
      padding: var(--space-m);
      background: none;
      border: none;
      color: var(--gray-60);
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 3px solid transparent;
      font-size: 15px;
      font-weight: 500;
    }

    .sidebar-tab:hover {
      color: var(--gray-100);
    }

    .sidebar-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .chat-list {
      padding: var(--space-m);
      min-height: 300px;
    }

    .chat-list-empty {
      padding: var(--space-xl);
      text-align: center;
      color: var(--gray-60);
    }

    .chat-item {
      padding: var(--space-m);
      border-radius: var(--radius);
      margin-bottom: var(--space-s);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      background: var(--gray-10);
    }

    body.dark .chat-item {
      background: var(--gray-30);
    }

    .chat-item:hover {
      background: var(--gray-20);
      transform: translateX(4px);
    }

    body.dark .chat-item:hover {
      background: var(--gray-40);
    }

    .chat-item.active {
      background: rgba(var(--primary-rgb), 0.08);
      border-left: 3px solid var(--primary);
    }

    .chat-item-title {
      font-weight: 600;
      color: var(--gray-100);
      margin-bottom: var(--space-xs);
      padding-right: 60px;
    }

    .chat-item-preview {
      font-size: 14px;
      color: var(--gray-60);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-item-date {
      font-size: 12px;
      color: var(--gray-60);
      margin-top: var(--space-xs);
    }

    .chat-item-actions {
      position: absolute;
      top: var(--space-m);
      right: var(--space-m);
      display: flex;
      gap: var(--space-xs);
      opacity: 0;
      transition: var(--transition);
    }

    .chat-item:hover .chat-item-actions {
      opacity: 1;
    }

    .chat-item-action {
      background: var(--gray-30);
      border: none;
      color: var(--gray-80);
      width: 32px;
      height: 32px;
      border-radius: var(--radius-small);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .chat-item-action:hover {
      background: var(--primary);
      color: white;
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--gray-10);
    }

    body.dark .chat-container {
      background: var(--gray-10);
    }

    .chat-messages-wrapper {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: var(--space-l);
      padding-bottom: calc(var(--input-container-height) + var(--safe-area-bottom) + var(--space-l));
      scroll-behavior: smooth;
    }

    /* Messages - Allow text selection */
    .message-wrapper {
      margin: var(--space-m) 0;
      animation: slideUp 0.3s ease-out;
      max-width: 85%;
    }

    .message-wrapper.user {
      margin-left: auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .message-wrapper.assistant {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .message-label {
      font-size: 13px;
      color: var(--gray-60);
      margin-bottom: var(--space-xs);
      font-weight: 500;
      padding: 0 var(--space-m);
      display: flex;
      align-items: center;
      gap: var(--space-s);
    }

    .message-content {
      padding: 14px 20px;
      border-radius: var(--radius-large);
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-size: 15px;
      line-height: 1.6;
      box-shadow: var(--shadow-small);
      transition: var(--transition);
      /* Enable text selection */
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
      cursor: text;
    }

    .user .message-content {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: var(--space-xs);
    }

    .assistant .message-content {
      background: white;
      color: var(--gray-100);
      border-bottom-left-radius: var(--space-xs);
    }

    body.dark .assistant .message-content {
      background: var(--gray-30);
    }

    /* Style links in user messages (white background) */
    .user .message-content a {
      color: white !important;
      text-decoration: underline;
    }

    .user .message-content a:hover {
      opacity: 0.8;
    }

    .system-message {
      background: rgba(var(--primary-rgb), 0.05);
      padding: var(--space-m);
      border-radius: var(--radius);
      margin: var(--space-l) auto;
      width: 90%;
      font-family: monospace;
      font-size: 13px;
      border: 1px solid rgba(var(--primary-rgb), 0.1);
      color: var(--gray-80);
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
      /* Enable text selection */
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
      cursor: text;
    }

    body.dark .system-message {
      background: rgba(var(--primary-rgb), 0.1);
      color: var(--gray-100);
    }

    /* Voice message indicator */
    .voice-message {
      display: none;
      align-items: center;
      gap: var(--space-s);
      margin-top: var(--space-s);
      padding: 8px 12px;
      background: rgba(var(--primary-rgb), 0.1);
      border-radius: var(--radius);
      font-size: 13px;
      color: var(--primary);
    }

    .voice-message.active {
      display: flex;
    }

    .voice-message i {
      font-size: 14px;
    }

    .message-content pre {
      background: var(--gray-20);
      padding: var(--space-m);
      border-radius: var(--radius);
      overflow-x: auto;
      margin: var(--space-s) 0;
      font-size: 13px;
      /* Enable text selection */
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    body.dark .message-content pre {
      background: var(--gray-10);
    }

    .message-content code {
      background: rgba(var(--primary-rgb), 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
      /* Enable text selection */
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    .user .message-content pre,
    .user .message-content code {
      background: rgba(255, 255, 255, 0.15);
    }

    /* Loading Animation - Matching Copilot for Sales Voice */
    .loading {
      display: none !important;
      margin: var(--space-m) 0;
      margin-right: auto;
      max-width: 80px;
      background: var(--gray-20);
      padding: 14px 20px;
      border-radius: var(--radius-large);
      border-bottom-left-radius: var(--space-xs);
      box-shadow: var(--shadow-small);
    }

    body.dark .loading {
      background: var(--gray-30);
    }

    .loading.active {
      display: flex !important;
      align-items: center;
      justify-content: center;
      gap: var(--space-s);
      animation: slideUp 0.3s ease-out;
    }

    .loading span {
      width: 8px;
      height: 8px;
      background: var(--gray-60);
      border-radius: 50%;
      display: inline-block;
      animation: bounce 0.8s infinite;
    }

    body.dark .loading span {
      background: var(--gray-80);
    }

    .loading span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .loading span:nth-child(3) {
      animation-delay: 0.4s;
    }

    /* Ensure only one loading indicator at a time */
    .chat-messages .loading+.loading {
      display: none !important;
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-6px);
      }
    }

    /* Input Container */
    .input-container {
      background: white;
      border-top: 1px solid var(--gray-30);
      padding: var(--space-m);
      padding-bottom: calc(var(--space-m) + var(--safe-area-bottom));
      display: flex;
      gap: var(--space-s);
      align-items: flex-end;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      min-height: var(--input-container-height);
    }

    body.dark .input-container {
      background: var(--gray-20);
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .input-field {
      width: 100%;
      padding: 12px 18px;
      border: 2px solid var(--gray-30);
      border-radius: var(--radius-full);
      font-size: 16px;
      resize: none;
      outline: none;
      transition: var(--transition);
      background: var(--gray-10);
      min-height: 44px;
      max-height: 120px;
      font-family: inherit;
    }

    body.dark .input-field {
      background: var(--gray-30);
      color: var(--gray-100);
    }

    .input-field:focus {
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }

    body.dark .input-field:focus {
      background: var(--gray-40);
    }

    .input-button {
      background: var(--primary);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      font-size: 18px;
    }

    .input-button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .input-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .input-button.secondary {
      background: var(--gray-30);
      color: var(--gray-80);
    }

    body.dark .input-button.secondary {
      background: var(--gray-40);
      color: var(--gray-100);
    }

    /* Voice button */
    .voice-button {
      background: var(--accent);
      color: white;
    }

    .voice-button:hover {
      background: var(--accent);
      transform: scale(1.1);
    }

    .voice-button.active {
      background: var(--error);
      animation: pulse 1.5s infinite;
    }

    /* Image Preview */
    .image-preview-container {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      padding: var(--space-m);
      background: white;
      border: 2px solid var(--gray-30);
      border-radius: var(--radius);
      margin-bottom: var(--space-s);
      display: none;
      box-shadow: var(--shadow-medium);
    }

    body.dark .image-preview-container {
      background: var(--gray-30);
    }

    .image-preview-container.active {
      display: block;
      animation: slideUp 0.3s ease-out;
    }

    .image-preview {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: var(--radius);
      overflow: hidden;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    /* Float buttons */
    .float-buttons {
      position: fixed;
      bottom: calc(var(--input-container-height) + var(--safe-area-bottom) + 20px);
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 80;
    }

    .fab {
      background: var(--primary);
      color: white;
      border: none;
      width: 56px;
      height: 56px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-medium);
      font-size: 22px;
    }

    .fab:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-large);
    }

    .fab.secondary {
      background: var(--error);
    }

    .fab.menu {
      background: var(--accent);
    }

    .fab.menu.active {
      transform: rotate(45deg);
    }

    /* Menu Items */
    .menu-items {
      position: fixed;
      bottom: calc(var(--input-container-height) + var(--safe-area-bottom) + 140px);
      right: 20px;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow-large);
      padding: var(--space-s);
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px) scale(0.9);
      transition: var(--transition);
      z-index: 80;
      min-width: 220px;
    }

    body.dark .menu-items {
      background: var(--gray-30);
    }

    .menu-items.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: var(--space-m);
      padding: 12px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      color: var(--gray-100);
      font-size: 15px;
      font-weight: 500;
    }

    .menu-item:hover {
      background: rgba(var(--primary-rgb), 0.08);
    }

    .menu-item i {
      width: 24px;
      text-align: center;
      color: var(--primary);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: var(--space-m);
    }

    .modal.active {
      display: flex;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-large);
      max-width: 600px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      animation: scaleIn 0.3s ease-out;
      position: relative;
    }

    body.dark .modal-content {
      background: var(--gray-20);
    }

    .modal-header {
      padding: var(--space-l);
      border-bottom: 1px solid var(--gray-30);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }

    body.dark .modal-header {
      background: var(--gray-20);
    }

    .modal-header h2 {
      font-size: 20px;
      color: var(--gray-100);
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--gray-60);
      cursor: pointer;
      transition: var(--transition);
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
    }

    .modal-close:hover {
      background: var(--gray-20);
      color: var(--gray-100);
    }

    .modal-body {
      padding: var(--space-l);
    }

    .modal-footer {
      padding: var(--space-l);
      border-top: 1px solid var(--gray-30);
      display: flex;
      justify-content: flex-end;
      gap: var(--space-m);
      position: sticky;
      bottom: 0;
      background: white;
      z-index: 10;
    }

    body.dark .modal-footer {
      background: var(--gray-20);
    }

    .button {
      padding: 10px 20px;
      border-radius: var(--radius);
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: var(--space-s);
    }

    .button-primary {
      background: var(--primary);
      color: white;
    }

    .button-primary:hover {
      background: var(--primary-dark);
    }

    .button-secondary {
      background: var(--gray-20);
      color: var(--gray-100);
    }

    body.dark .button-secondary {
      background: var(--gray-40);
    }

    .button-success {
      background: var(--success);
      color: white;
    }

    .button-success:hover {
      background: #45a049;
    }

    /* Settings */
    .settings-section {
      margin-bottom: var(--space-xl);
      padding-bottom: var(--space-xl);
      border-bottom: 1px solid var(--gray-30);
    }

    .settings-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .settings-section h3 {
      font-size: 18px;
      margin-bottom: var(--space-l);
      color: var(--gray-100);
      font-weight: 600;
    }

    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-m) 0;
    }

    .settings-item label {
      font-size: 15px;
      color: var(--gray-80);
      font-weight: 500;
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 28px;
      background: var(--gray-30);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition);
    }

    .toggle-switch.active {
      background: var(--success);
    }

    .toggle-switch::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: var(--radius-full);
      transition: var(--transition);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    /* Drop Zone */
    .drop-zone {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(var(--primary-rgb), 0.95);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .drop-zone.active {
      display: flex;
      animation: fadeIn 0.2s ease-out;
    }

    .drop-zone-content {
      text-align: center;
      color: white;
    }

    .drop-zone-content i {
      font-size: 72px;
      margin-bottom: var(--space-l);
    }

    .drop-zone-content p {
      font-size: 24px;
      font-weight: 600;
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .message-wrapper {
        max-width: 90%;
      }

      .modal-content {
        margin: 20px;
      }
    }

    /* iOS specific fixes */
    @supports (-webkit-touch-callout: none) {
      .app-container {
        height: -webkit-fill-available;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--gray-20);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-50);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-60);
    }

    /* Focus styles */
    *:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Hidden file inputs */
    input[type="file"] {
      display: none;
    }
  </style>
</head>

<body>
  <!-- Login Page -->
  <div id="login-page" class="login-container">
    <div class="login-box">
      <div class="login-header">
        <h1>Welcome Back</h1>
        <p>Sign in to continue your conversations</p>
      </div>

      <form id="login-form">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" placeholder="Enter your username" required autocomplete="username"
            autocapitalize="off" />
        </div>

        <button type="submit" class="login-button">Sign In</button>
      </form>

      <div class="user-list">
        <h3>Recent Users</h3>
        <div id="recent-users"></div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="app-container hidden">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <button class="header-button" id="sidebar-toggle">
          <i class="fas fa-bars"></i>
        </button>
        <h1 class="header-title">
          <span id="current-username">Chat</span>
        </h1>
        <div class="voice-indicator" id="voice-indicator">
          <i class="fas fa-volume-up"></i>
          <span>Speaking...</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-button" id="archive-chat">
          <i class="fas fa-archive"></i>
        </button>
        <button class="header-button" id="theme-toggle">
          <i class="fas fa-moon"></i>
        </button>
        <button class="header-button" id="logout">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Chat Library</h2>
        <button class="input-button" id="new-chat">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="active">Active</button>
        <button class="sidebar-tab" data-tab="archived">Archived</button>
      </div>
      <div class="chat-list" id="chat-list-active"></div>
      <div class="chat-list hidden" id="chat-list-archived"></div>
    </aside>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Chat Container -->
    <main class="chat-container">
      <div class="chat-messages-wrapper">
        <div class="chat-messages" id="chat-messages">
          <!-- Loading Indicator will be appended here dynamically -->
        </div>
      </div>
    </main>

    <!-- Input Container -->
    <div class="input-container" id="input-container">
      <button class="input-button secondary" id="upload-image">
        <i class="fas fa-image"></i>
      </button>
      <button class="input-button voice-button" id="voice-toggle">
        <i class="fas fa-microphone"></i>
      </button>
      <div class="input-wrapper">
        <div class="mention-dropdown" id="mention-dropdown"></div>
        <div class="image-preview-container" id="image-preview-container"></div>
        <textarea class="input-field" id="user-input" placeholder="Type a message or @mention an endpoint..." rows="1"></textarea>
      </div>
      <button class="input-button" id="send-button">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>

    <!-- Float Buttons -->
    <div class="float-buttons">
      <button class="fab secondary" id="clear-chat">
        <i class="fas fa-trash"></i>
      </button>
      <button class="fab menu" id="menu-toggle">
        <i class="fas fa-plus"></i>
      </button>
    </div>

    <!-- Menu Items -->
    <div class="menu-items" id="menu-items">
      <div class="menu-item" id="export-chat">
        <i class="fas fa-download"></i>
        <span>Export Chat</span>
      </div>
      <div class="menu-item" id="import-chat">
        <i class="fas fa-upload"></i>
        <span>Import Chat</span>
      </div>
      <div class="menu-item" id="export-all">
        <i class="fas fa-file-archive"></i>
        <span>Export All Data</span>
      </div>
      <div class="menu-item" id="import-all">
        <i class="fas fa-file-import"></i>
        <span>Import Data</span>
      </div>
      <div class="menu-item" id="time-machine">
        <i class="fas fa-history"></i>
        <span>Time Machine</span>
      </div>
      <div class="menu-item" id="settings">
        <i class="fas fa-cog"></i>
        <span>Settings</span>
      </div>
    </div>

    <!-- Drop Zone -->
    <div class="drop-zone" id="drop-zone">
      <div class="drop-zone-content">
        <i class="fas fa-cloud-upload-alt"></i>
        <p>Drop files here to import</p>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="modal-close" id="settings-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- Settings Import/Export -->
        <div class="settings-import-export">
          <button class="button button-secondary" id="export-settings">
            <i class="fas fa-download"></i>
            Export Settings
          </button>
          <button class="button button-secondary" id="import-settings">
            <i class="fas fa-upload"></i>
            Import Settings
          </button>
        </div>
        
        <div class="settings-section">
          <h3>Appearance</h3>
          <div class="settings-item">
            <label for="dark-mode-toggle">Dark Mode</label>
            <div class="toggle-switch" id="dark-mode-toggle"></div>
          </div>
        </div>
        <div class="settings-section">
          <h3>Sound & Voice</h3>
          <div class="settings-item">
            <label for="sound-toggle">Enable Sound Effects</label>
            <div class="toggle-switch" id="sound-toggle"></div>
          </div>
          <div class="settings-item">
            <label for="voice-enabled-toggle">Enable Voice Response</label>
            <div class="toggle-switch" id="voice-enabled-toggle"></div>
          </div>
          <div class="settings-item">
            <label for="auto-speak-toggle">Auto-speak Responses</label>
            <div class="toggle-switch" id="auto-speak-toggle"></div>
          </div>
          <div class="form-group" style="margin-top: 16px">
            <label for="azure-tts-key">Azure TTS API Key</label>
            <input type="password" id="azure-tts-key" placeholder="Enter your Azure TTS API key" />
          </div>
          <div class="form-group">
            <label for="tts-voice-select">TTS Voice</label>
            <select id="tts-voice-select" style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid var(--gray-40);
                  border-radius: 4px;
                ">
              <option value="en-US-JennyNeural">Jenny (Female)</option>
              <option value="en-US-GuyNeural">Guy (Male)</option>
              <option value="en-US-AriaNeural">Aria (Female)</option>
              <option value="en-US-DavisNeural">Davis (Male)</option>
              <option value="en-US-AmberNeural">Amber (Female)</option>
              <option value="en-US-JasonNeural">Jason (Male)</option>
              <option value="en-GB-SoniaNeural">
                Sonia (British Female)
              </option>
              <option value="en-GB-RyanNeural">Ryan (British Male)</option>
            </select>
          </div>
        </div>
        <div class="settings-section">
          <h3>API Endpoints</h3>
          <div class="endpoint-list" id="endpoint-list"></div>
          <button class="button button-primary" id="add-endpoint" style="width: 100%; margin-top: 16px;">
            <i class="fas fa-plus"></i>
            Add Endpoint
          </button>
        </div>
        <div class="settings-section">
          <h3>Data Management</h3>
          <button class="button button-secondary" id="clear-all-data">
            <i class="fas fa-trash-alt"></i>
            Clear All Data
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="button button-secondary" id="cancel-settings">
          Cancel
        </button>
        <button class="button button-success" id="save-all-settings">
          <i class="fas fa-save"></i>
          Save Settings
        </button>
      </div>
    </div>
  </div>

  <!-- Endpoint Modal -->
  <div class="modal" id="endpoint-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="endpoint-modal-title">Add Endpoint</h2>
        <button class="modal-close" id="endpoint-modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="endpoint-name">Endpoint Name</label>
          <input type="text" id="endpoint-name" placeholder="e.g., Production Bot" />
        </div>
        <div class="form-group">
          <label for="endpoint-url">Azure Function URL</label>
          <input type="text" id="endpoint-url" placeholder="https://your-function.azurewebsites.net/api/..." />
        </div>
        <div class="form-group">
          <label for="endpoint-key">Function Key</label>
          <input type="text" id="endpoint-key" placeholder="Your function key" />
        </div>
        <div class="form-group">
          <label for="endpoint-guid">User GUID</label>
          <input type="text" id="endpoint-guid" placeholder="c0p110t0-aaaa-bbbb-cccc-123456789abc" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="button button-secondary" id="cancel-endpoint">
          Cancel
        </button>
        <button class="button button-success" id="save-endpoint">
          <i class="fas fa-save"></i>
          Save Endpoint
        </button>
      </div>
    </div>
  </div>

  <!-- Time Machine Modal -->
  <div class="modal" id="time-machine-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Time Machine</h2>
        <button class="modal-close" id="time-machine-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <p>Replay the current conversation</p>
        </div>
        <div class="text-center">
          <button class="button button-primary" id="time-machine-start">
            <i class="fas fa-play"></i> Start Replay
          </button>
        </div>
        <div class="hidden" id="time-machine-controls">
          <div class="text-center">
            <span id="time-machine-progress">0 / 0</span>
          </div>
          <div class="text-center" style="margin-top: 20px;">
            <button class="button button-secondary" id="time-machine-prev">
              <i class="fas fa-step-backward"></i>
            </button>
            <button class="button button-primary" id="time-machine-play">
              <i class="fas fa-play"></i>
            </button>
            <button class="button button-secondary" id="time-machine-next">
              <i class="fas fa-step-forward"></i>
            </button>
            <button class="button button-secondary" id="time-machine-stop">
              <i class="fas fa-stop"></i>
            </button>
          </div>
          <div class="text-center" style="margin-top: 20px;">
            <button class="button button-success" id="time-machine-branch">
              <i class="fas fa-code-branch"></i> Continue from Here
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden file inputs -->
  <input type="file" id="image-upload-input" accept="image/*" />
  <input type="file" id="chat-import-input" accept=".json" />
  <input type="file" id="data-import-input" accept=".json" />
  <input type="file" id="settings-import-input" accept=".json" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>

  <script>
    // Global state management
    class AppState {
      constructor() {
        this.currentUser = null;
        this.currentChatId = null;
        this.users = this.loadUsers();
        this.chats = this.loadChats();
        this.settings = this.loadSettings();
        this.endpoints = this.loadEndpoints();
        this.activeEndpointId = null;
      }

      loadUsers() {
        const users = localStorage.getItem("chatAppUsers");
        return users ? JSON.parse(users) : {};
      }

      loadChats() {
        const chats = localStorage.getItem("chatAppChats");
        return chats ? JSON.parse(chats) : {};
      }

      loadSettings() {
        const settings = localStorage.getItem("chatAppSettings");
        return settings
          ? JSON.parse(settings)
          : {
            theme: "light",
            soundEnabled: false,
            voiceEnabled: true,
            autoSpeak: false,
            azureTTSKey: "",
            ttsVoiceName: "en-US-JennyNeural",
          };
      }

      loadEndpoints() {
        const endpoints = localStorage.getItem("chatAppEndpoints");
        const defaultEndpoints = {
          'default': {
            id: 'default',
            name: 'Default Bot',
            url: "https://effective-bassoon-wvrjj9qrxvcg6vr-7071.app.github.dev/api/businessinsightbot_function",
            key: "",
            guid: "c0p110t0-aaaa-bbbb-cccc-123456789abc",
            active: true
          }
        };
        return endpoints ? JSON.parse(endpoints) : defaultEndpoints;
      }

      saveUsers() {
        localStorage.setItem("chatAppUsers", JSON.stringify(this.users));
      }

      saveChats() {
        localStorage.setItem("chatAppChats", JSON.stringify(this.chats));
      }

      saveSettings() {
        localStorage.setItem(
          "chatAppSettings",
          JSON.stringify(this.settings)
        );
      }

      saveEndpoints() {
        localStorage.setItem("chatAppEndpoints", JSON.stringify(this.endpoints));
      }

      createUser(username) {
        const userId = this.generateGuid();
        const user = {
          id: userId,
          username: username,
          createdAt: new Date().toISOString(),
          lastActive: new Date().toISOString(),
          chats: [],
        };
        this.users[userId] = user;
        this.saveUsers();
        return user;
      }

      createChat(userId, title = "New Chat") {
        const chatId = this.generateGuid();
        const chat = {
          id: chatId,
          userId: userId,
          title: title,
          messages: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          archived: false,
        };

        if (!this.chats[userId]) {
          this.chats[userId] = {};
        }

        this.chats[userId][chatId] = chat;
        this.users[userId].chats.push(chatId);
        this.users[userId].lastActive = new Date().toISOString();

        this.saveChats();
        this.saveUsers();

        return chat;
      }

      createBranchChat(userId, sourceChat, upToIndex) {
        const branchTitle = `${sourceChat.title} (Branch from message ${upToIndex + 1})`;
        const branchChat = this.createChat(userId, branchTitle);
        
        branchChat.messages = sourceChat.messages.slice(0, upToIndex + 1).map(msg => ({...msg}));
        branchChat.updatedAt = new Date().toISOString();
        
        this.saveChats();
        return branchChat;
      }

      updateChat(userId, chatId, updates) {
        if (this.chats[userId] && this.chats[userId][chatId]) {
          Object.assign(this.chats[userId][chatId], updates);
          this.chats[userId][chatId].updatedAt = new Date().toISOString();
          this.saveChats();
        }
      }

      getActiveChats(userId) {
        if (!this.chats[userId]) return [];
        return Object.values(this.chats[userId])
          .filter((chat) => !chat.archived)
          .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      }

      getArchivedChats(userId) {
        if (!this.chats[userId]) return [];
        return Object.values(this.chats[userId])
          .filter((chat) => chat.archived)
          .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      }

      archiveChat(userId, chatId) {
        if (this.chats[userId] && this.chats[userId][chatId]) {
          this.chats[userId][chatId].archived = true;
          this.chats[userId][chatId].updatedAt = new Date().toISOString();
          this.saveChats();
        }
      }

      unarchiveChat(userId, chatId) {
        if (this.chats[userId] && this.chats[userId][chatId]) {
          this.chats[userId][chatId].archived = false;
          this.chats[userId][chatId].updatedAt = new Date().toISOString();
          this.saveChats();
        }
      }

      deleteChat(userId, chatId) {
        if (this.chats[userId] && this.chats[userId][chatId]) {
          delete this.chats[userId][chatId];
          const userChatIndex = this.users[userId].chats.indexOf(chatId);
          if (userChatIndex > -1) {
            this.users[userId].chats.splice(userChatIndex, 1);
          }
          this.saveChats();
          this.saveUsers();
        }
      }

      addEndpoint(name, url, key, guid) {
        const id = this.generateGuid();
        this.endpoints[id] = {
          id: id,
          name: name,
          url: url,
          key: key,
          guid: guid || "c0p110t0-aaaa-bbbb-cccc-123456789abc",
          active: Object.keys(this.endpoints).length === 0
        };
        this.saveEndpoints();
        return this.endpoints[id];
      }

      updateEndpoint(id, updates) {
        if (this.endpoints[id]) {
          Object.assign(this.endpoints[id], updates);
          this.saveEndpoints();
        }
      }

      deleteEndpoint(id) {
        if (this.endpoints[id]) {
          delete this.endpoints[id];
          this.saveEndpoints();
        }
      }

      setActiveEndpoint(id) {
        Object.values(this.endpoints).forEach(endpoint => {
          endpoint.active = endpoint.id === id;
        });
        this.activeEndpointId = id;
        this.saveEndpoints();
      }

      getActiveEndpoint() {
        return Object.values(this.endpoints).find(e => e.active) || Object.values(this.endpoints)[0];
      }

      getEndpointById(id) {
        return this.endpoints[id];
      }

      exportAllData() {
        return {
          users: this.users,
          chats: this.chats,
          settings: this.settings,
          endpoints: this.endpoints,
          exportDate: new Date().toISOString(),
          version: "1.0",
        };
      }

      importAllData(data) {
        if (data.users) this.users = data.users;
        if (data.chats) this.chats = data.chats;
        if (data.settings) this.settings = data.settings;
        if (data.endpoints) this.endpoints = data.endpoints;

        this.saveUsers();
        this.saveChats();
        this.saveSettings();
        this.saveEndpoints();
      }

      exportSettings() {
        return {
          endpoints: this.endpoints,
          azureTTSKey: this.settings.azureTTSKey,
          ttsVoiceName: this.settings.ttsVoiceName,
          exportDate: new Date().toISOString(),
          version: "1.0"
        };
      }

      importSettings(settingsData) {
        if (settingsData.azureTTSKey !== undefined) {
          this.settings.azureTTSKey = settingsData.azureTTSKey;
        }
        if (settingsData.ttsVoiceName !== undefined) {
          this.settings.ttsVoiceName = settingsData.ttsVoiceName;
        }
        if (settingsData.endpoints !== undefined) {
          this.endpoints = settingsData.endpoints;
          this.saveEndpoints();
        }
        
        this.saveSettings();
      }

      clearAllData() {
        localStorage.removeItem("chatAppUsers");
        localStorage.removeItem("chatAppChats");
        localStorage.removeItem("chatAppSettings");
        localStorage.removeItem("chatAppEndpoints");
        localStorage.removeItem("lastUserId");

        this.users = {};
        this.chats = {};
        this.settings = {
          theme: "light",
          soundEnabled: false,
          voiceEnabled: true,
          autoSpeak: false,
          azureTTSKey: "",
          ttsVoiceName: "en-US-JennyNeural",
        };
        this.endpoints = {
          'default': {
            id: 'default',
            name: 'Default Bot',
            url: "",
            key: "",
            guid: "c0p110t0-aaaa-bbbb-cccc-123456789abc",
            active: true
          }
        };
      }

      generateGuid() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }
    }

    // Sound Manager
    class SoundManager {
      constructor() {
        this.audioContext = null;
        this.enabled = false;
      }

      init() {
        if (!this.audioContext) {
          this.audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
        }
      }

      setEnabled(enabled) {
        this.enabled = enabled;
        if (enabled) this.init();
      }

      async playSound(frequency = 440, duration = 0.1, type = "sine") {
        if (!this.enabled || !this.audioContext) return;

        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);

        oscillator.frequency.value = frequency;
        oscillator.type = type;

        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          this.audioContext.currentTime + duration
        );

        oscillator.start(this.audioContext.currentTime);
        oscillator.stop(this.audioContext.currentTime + duration);
      }

      playSendSound() {
        this.playSound(523.25, 0.1);
      }

      playReceiveSound() {
        this.playSound(659.25, 0.15);
      }

      playNotificationSound() {
        this.playSound(880, 0.2);
      }
    }

    // Voice Manager
    class VoiceManager {
      constructor() {
        this.synthesis = window.speechSynthesis;
        this.recognition = null;
        this.enabled = true;
        this.autoSpeak = false;
        this.isListening = false;
        this.isSpeaking = false;
        this.azureKey = "";
        this.azureRegion = "eastus2";
        this.voiceName = "en-US-JennyNeural";
        this.isSdkLoaded = false;
        this.speechSynthesizer = null;
        this.maxCharacters = 5000;

        this.initSpeechRecognition();
        this.loadSpeechSdk();
      }

      loadSpeechSdk() {
        if (window.SpeechSDK) {
          this.isSdkLoaded = true;
          return;
        }

        const script = document.createElement("script");
        script.src = "https://aka.ms/csspeech/jsbrowserpackageraw";
        script.async = true;
        script.onload = () => {
          console.log("Microsoft Speech SDK loaded");
          this.isSdkLoaded = true;
        };
        script.onerror = () => {
          console.error("Failed to load Microsoft Speech SDK");
        };

        document.body.appendChild(script);
      }

      initSpeechRecognition() {
        if (
          "webkitSpeechRecognition" in window ||
          "SpeechRecognition" in window
        ) {
          const SpeechRecognition =
            window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognition = new SpeechRecognition();
          this.recognition.continuous = false;
          this.recognition.interimResults = true;
          this.recognition.lang = "en-US";

          this.recognition.onstart = () => {
            this.isListening = true;
            document.getElementById("voice-toggle").classList.add("active");
          };

          this.recognition.onend = () => {
            this.isListening = false;
            document
              .getElementById("voice-toggle")
              .classList.remove("active");
          };

          this.recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            this.isListening = false;
            document
              .getElementById("voice-toggle")
              .classList.remove("active");
          };
        }
      }

      setEnabled(enabled) {
        this.enabled = enabled;
      }

      setAutoSpeak(autoSpeak) {
        this.autoSpeak = autoSpeak;
      }

      setAzureKey(key) {
        this.azureKey = key;
      }

      setVoiceName(voiceName) {
        this.voiceName = voiceName;
      }

      async speak(text) {
        if (!this.enabled || !text || this.isSpeaking) return;

        this.stopSpeaking();

        const cleanText = this.cleanTextForSpeech(text);

        if (this.azureKey && this.isSdkLoaded && window.SpeechSDK) {
          await this.speakWithAzure(cleanText);
        } else {
          await this.speakWithBrowser(cleanText);
        }
      }

      async speakWithAzure(text) {
        try {
          const truncatedText =
            text.length > this.maxCharacters
              ? text.substring(0, this.maxCharacters) +
              "... (text truncated for speech)"
              : text;

          const speechConfig = window.SpeechSDK.SpeechConfig.fromSubscription(
            this.azureKey,
            this.azureRegion
          );
          speechConfig.speechSynthesisVoiceName = this.voiceName;

          const audioConfig =
            window.SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
          this.speechSynthesizer = new window.SpeechSDK.SpeechSynthesizer(
            speechConfig,
            audioConfig
          );

          this.isSpeaking = true;
          document.getElementById("voice-indicator").classList.add("active");

          await new Promise((resolve, reject) => {
            this.speechSynthesizer.speakTextAsync(
              truncatedText,
              (result) => {
                if (
                  result.reason ===
                  window.SpeechSDK.ResultReason.SynthesizingAudioCompleted
                ) {
                  console.log("Azure TTS synthesis completed");
                  this.isSpeaking = false;
                  document
                    .getElementById("voice-indicator")
                    .classList.remove("active");

                  if (this.speechSynthesizer) {
                    this.speechSynthesizer.close();
                    this.speechSynthesizer = null;
                  }
                  resolve();
                } else {
                  console.error(
                    `Speech synthesis canceled, reason: ${result.reason}`
                  );
                  let errorDetails = "";

                  if (
                    result.reason === window.SpeechSDK.ResultReason.Canceled
                  ) {
                    const cancellationDetails =
                      window.SpeechSDK.CancellationDetails.fromResult(result);
                    errorDetails = `Cancellation reason: ${cancellationDetails.reason}`;

                    if (
                      cancellationDetails.reason ===
                      window.SpeechSDK.CancellationReason.Error
                    ) {
                      errorDetails += `, Error details: ${cancellationDetails.errorDetails}`;
                    }
                  }

                  if (this.speechSynthesizer) {
                    this.speechSynthesizer.close();
                    this.speechSynthesizer = null;
                  }

                  this.isSpeaking = false;
                  document
                    .getElementById("voice-indicator")
                    .classList.remove("active");
                  reject(
                    new Error(`Speech synthesis failed. ${errorDetails}`)
                  );
                }
              },
              (error) => {
                console.error("Azure TTS error:", error);

                if (this.speechSynthesizer) {
                  this.speechSynthesizer.close();
                  this.speechSynthesizer = null;
                }

                this.isSpeaking = false;
                document
                  .getElementById("voice-indicator")
                  .classList.remove("active");
                reject(error);
              }
            );
          });
        } catch (error) {
          console.error("Azure TTS error:", error);
          this.isSpeaking = false;
          document
            .getElementById("voice-indicator")
            .classList.remove("active");
          await this.speakWithBrowser(text);
        }
      }

      async speakWithBrowser(text) {
        return new Promise((resolve, reject) => {
          try {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;

            const voices = this.synthesis.getVoices();
            const preferredVoice =
              voices.find(
                (voice) =>
                  voice.name.includes("Microsoft") ||
                  voice.name.includes("Google") ||
                  voice.name.includes("Natural")
              ) || voices[0];

            if (preferredVoice) {
              utterance.voice = preferredVoice;
            }

            utterance.onstart = () => {
              this.isSpeaking = true;
              document
                .getElementById("voice-indicator")
                .classList.add("active");
            };

            utterance.onend = () => {
              this.isSpeaking = false;
              document
                .getElementById("voice-indicator")
                .classList.remove("active");
              resolve();
            };

            utterance.onerror = (error) => {
              this.isSpeaking = false;
              document
                .getElementById("voice-indicator")
                .classList.remove("active");
              reject(error);
            };

            this.synthesis.speak(utterance);
          } catch (error) {
            this.isSpeaking = false;
            document
              .getElementById("voice-indicator")
              .classList.remove("active");
            reject(error);
          }
        });
      }

      stopSpeaking() {
        if (this.speechSynthesizer) {
          try {
            this.speechSynthesizer.close();
          } catch (e) {
            console.warn("Error closing speech synthesizer:", e);
          }
          this.speechSynthesizer = null;
        }

        if (window.speechSynthesis) {
          try {
            window.speechSynthesis.cancel();
          } catch (e) {
            console.warn("Error canceling speech synthesis:", e);
          }
        }

        this.isSpeaking = false;
        document.getElementById("voice-indicator").classList.remove("active");
      }

      cleanTextForSpeech(text) {
        let cleanText = text.replace(/<[^>]*>/g, " ");

        cleanText = cleanText
          .replace(/\*\*([^*]+)\*\*/g, "$1")
          .replace(/\*([^*]+)\*/g, "$1")
          .replace(/`([^`]+)`/g, "$1")
          .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
          .replace(/#{1,6}\s+([^\n]+)/g, "$1")
          .replace(/```[\s\S]*?```/g, "")
          .replace(/\n/g, " ")
          .replace(/\s+/g, " ")
          .trim();

        return cleanText;
      }

      startListening(callback) {
        if (!this.recognition || this.isListening) return;

        this.recognition.onresult = (event) => {
          const last = event.results.length - 1;
          const transcript = event.results[last][0].transcript;

          if (event.results[last].isFinal) {
            callback(transcript);
          }
        };

        this.recognition.start();
      }

      stopListening() {
        if (this.recognition && this.isListening) {
          this.recognition.stop();
        }
      }

      toggleListening(callback) {
        if (this.isListening) {
          this.stopListening();
        } else {
          this.startListening(callback);
        }
      }
    }

    // Time Machine
    class TimeMachine {
      constructor() {
        this.messages = [];
        this.currentIndex = 0;
        this.isPlaying = false;
        this.playInterval = null;
        this.sourceChat = null;
      }

      init(messages, sourceChat) {
        this.messages = messages;
        this.currentIndex = 0;
        this.isPlaying = false;
        this.sourceChat = sourceChat;
        this.updateProgress();
      }

      play() {
        if (this.isPlaying) return;
        this.isPlaying = true;

        this.playInterval = setInterval(() => {
          if (this.currentIndex >= this.messages.length - 1) {
            this.pause();
            return;
          }
          this.next();
        }, 1500);

        this.updatePlayButton();
      }

      pause() {
        this.isPlaying = false;
        if (this.playInterval) {
          clearInterval(this.playInterval);
          this.playInterval = null;
        }
        this.updatePlayButton();
      }

      next() {
        if (this.currentIndex < this.messages.length - 1) {
          this.currentIndex++;
          this.displayUpToIndex();
          this.updateProgress();
        }
      }

      prev() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.displayUpToIndex();
          this.updateProgress();
        }
      }

      stop() {
        this.pause();
        this.currentIndex = this.messages.length - 1;
        this.displayUpToIndex();
        this.updateProgress();
        document
          .getElementById("time-machine-modal")
          .classList.remove("active");
      }

      branchFromCurrentPoint() {
        if (!this.sourceChat) return null;
        
        const branchChat = appState.createBranchChat(
          appState.currentUser.id, 
          this.sourceChat, 
          this.currentIndex
        );
        
        return branchChat;
      }

      displayUpToIndex() {
        const chatMessages = document.getElementById("chat-messages");
        chatMessages.innerHTML = "";

        for (let i = 0; i <= this.currentIndex; i++) {
          const msg = this.messages[i];
          ui.addMessageToUI(msg.role, msg.content, false);
        }

        ui.scrollToBottom();
      }

      updateProgress() {
        const progress = document.getElementById("time-machine-progress");
        progress.textContent = `${this.currentIndex + 1} / ${this.messages.length}`;
      }

      updatePlayButton() {
        const playButton = document.getElementById("time-machine-play");
        const icon = playButton.querySelector("i");
        if (this.isPlaying) {
          icon.className = "fas fa-pause";
        } else {
          icon.className = "fas fa-play";
        }
      }
    }

    // Initialize global instances
    const appState = new AppState();
    const soundManager = new SoundManager();
    const voiceManager = new VoiceManager();
    const timeMachine = new TimeMachine();

    // UI Controller
    class UIController {
      constructor() {
        this.loginPage = document.getElementById("login-page");
        this.appPage = document.getElementById("app");
        this.sidebar = document.getElementById("sidebar");
        this.sidebarOverlay = document.getElementById("sidebar-overlay");
        this.chatMessages = document.getElementById("chat-messages");
        this.userInput = document.getElementById("user-input");
        this.sendButton = document.getElementById("send-button");
        this.imagePreviewContainer = document.getElementById(
          "image-preview-container"
        );
        this.mentionDropdown = document.getElementById("mention-dropdown");
        this.pendingImage = null;
        this.mentionActive = false;
        this.mentionStartPos = -1;
        this.selectedMentionIndex = 0;
        this.currentEndpointId = null;
        this.editingEndpointId = null;

        this.initializeEventListeners();
        this.checkExistingSession();
      }

      initializeEventListeners() {
        // Login form
        document
          .getElementById("login-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            this.handleLogin();
          });

        // Header buttons
        document
          .getElementById("sidebar-toggle")
          .addEventListener("click", () => {
            this.toggleSidebar();
          });

        document
          .getElementById("archive-chat")
          .addEventListener("click", () => {
            this.archiveCurrentChat();
          });

        document
          .getElementById("theme-toggle")
          .addEventListener("click", () => {
            this.toggleTheme();
          });

        document.getElementById("logout").addEventListener("click", () => {
          this.logout();
        });

        // Clear chat button (floating)
        document
          .getElementById("clear-chat")
          .addEventListener("click", () => {
            this.clearCurrentChat();
          });

        // Voice toggle button
        document
          .getElementById("voice-toggle")
          .addEventListener("click", () => {
            if (!voiceManager.recognition) {
              this.showNotification(
                "Voice input is not supported in your browser. Please use Chrome or text input.",
                "warning"
              );
              return;
            }

            if (!appState.settings.voiceEnabled) {
              this.showNotification(
                "Voice features are disabled. Enable them in settings.",
                "info"
              );
              this.openSettings();
              return;
            }

            voiceManager.toggleListening((transcript) => {
              this.userInput.value = transcript;
              this.sendMessage();
            });
          });

        // Sidebar
        this.sidebarOverlay.addEventListener("click", () => {
          this.toggleSidebar();
        });

        // Sidebar tabs
        document.querySelectorAll(".sidebar-tab").forEach((tab) => {
          tab.addEventListener("click", (e) => {
            this.switchSidebarTab(e.target.dataset.tab);
          });
        });

        // Chat controls
        document.getElementById("new-chat").addEventListener("click", () => {
          this.createNewChat();
          this.toggleSidebar();
        });

        document
          .getElementById("send-button")
          .addEventListener("click", () => {
            this.sendMessage();
          });

        this.userInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });

        // Mention autocomplete
        this.userInput.addEventListener("input", (e) => {
          this.handleMentionInput(e);
          
          // Auto-resize textarea
          this.userInput.style.height = "auto";
          this.userInput.style.height =
            Math.min(this.userInput.scrollHeight, 120) + "px";
        });

        this.userInput.addEventListener("keydown", (e) => {
          if (this.mentionActive) {
            this.handleMentionNavigation(e);
          }
        });

        // Image upload
        document
          .getElementById("upload-image")
          .addEventListener("click", () => {
            document.getElementById("image-upload-input").click();
          });

        document
          .getElementById("image-upload-input")
          .addEventListener("change", (e) => {
            if (e.target.files[0]) {
              this.handleImageUpload(e.target.files[0]);
            }
          });

        // Paste event for images
        this.userInput.addEventListener("paste", (e) => {
          const items = e.clipboardData.items;
          for (let item of items) {
            if (item.type.indexOf("image") !== -1) {
              const file = item.getAsFile();
              this.handleImageUpload(file);
              e.preventDefault();
            }
          }
        });

        // Menu
        const menuToggle = document.getElementById("menu-toggle");
        const menuItems = document.getElementById("menu-items");

        menuToggle.addEventListener("click", () => {
          const isOpen = menuToggle.classList.toggle("active");
          menuItems.classList.toggle("open");
        });

        // Close menu when clicking outside
        document.addEventListener("click", (e) => {
          if (
            !menuToggle.contains(e.target) &&
            !menuItems.contains(e.target)
          ) {
            menuToggle.classList.remove("active");
            menuItems.classList.remove("open");
          }
        });

        // Menu items
        document
          .getElementById("export-chat")
          .addEventListener("click", () => {
            this.exportCurrentChat();
            this.closeMenu();
          });

        document
          .getElementById("import-chat")
          .addEventListener("click", () => {
            document.getElementById("chat-import-input").click();
            this.closeMenu();
          });

        document
          .getElementById("export-all")
          .addEventListener("click", () => {
            this.exportAllData();
            this.closeMenu();
          });

        document
          .getElementById("import-all")
          .addEventListener("click", () => {
            document.getElementById("data-import-input").click();
            this.closeMenu();
          });

        document
          .getElementById("time-machine")
          .addEventListener("click", () => {
            this.openTimeMachine();
            this.closeMenu();
          });

        document.getElementById("settings").addEventListener("click", () => {
          this.openSettings();
          this.closeMenu();
        });

        // File inputs
        document
          .getElementById("chat-import-input")
          .addEventListener("change", (e) => {
            if (e.target.files[0]) {
              this.importChat(e.target.files[0]);
            }
          });

        document
          .getElementById("data-import-input")
          .addEventListener("change", (e) => {
            if (e.target.files[0]) {
              this.importAllData(e.target.files[0]);
            }
          });

        // Settings import/export
        document
          .getElementById("export-settings")
          .addEventListener("click", () => {
            this.exportSettings();
          });

        document
          .getElementById("import-settings")
          .addEventListener("click", () => {
            document.getElementById("settings-import-input").click();
          });

        document
          .getElementById("settings-import-input")
          .addEventListener("change", (e) => {
            if (e.target.files[0]) {
              this.importSettings(e.target.files[0]);
            }
          });

        // Drag and drop
        this.initializeDragAndDrop();

        // Settings modal
        document
          .getElementById("settings-close")
          .addEventListener("click", () => {
            document
              .getElementById("settings-modal")
              .classList.remove("active");
          });

        document
          .getElementById("cancel-settings")
          .addEventListener("click", () => {
            document
              .getElementById("settings-modal")
              .classList.remove("active");
          });

        document
          .getElementById("save-all-settings")
          .addEventListener("click", () => {
            this.saveAllSettings();
          });

        document
          .getElementById("dark-mode-toggle")
          .addEventListener("click", (e) => {
            e.target.classList.toggle("active");
          });

        document
          .getElementById("sound-toggle")
          .addEventListener("click", (e) => {
            e.target.classList.toggle("active");
          });

        document
          .getElementById("voice-enabled-toggle")
          .addEventListener("click", (e) => {
            e.target.classList.toggle("active");
          });

        document
          .getElementById("auto-speak-toggle")
          .addEventListener("click", (e) => {
            e.target.classList.toggle("active");
          });

        document
          .getElementById("clear-all-data")
          .addEventListener("click", () => {
            if (
              confirm(
                "Are you sure you want to clear all data? This cannot be undone."
              )
            ) {
              appState.clearAllData();
              location.reload();
            }
          });

        // Endpoint management
        document
          .getElementById("add-endpoint")
          .addEventListener("click", () => {
            this.openEndpointModal();
          });

        document
          .getElementById("endpoint-modal-close")
          .addEventListener("click", () => {
            this.closeEndpointModal();
          });

        document
          .getElementById("cancel-endpoint")
          .addEventListener("click", () => {
            this.closeEndpointModal();
          });

        document
          .getElementById("save-endpoint")
          .addEventListener("click", () => {
            this.saveEndpoint();
          });

        // Time Machine modal
        document
          .getElementById("time-machine-close")
          .addEventListener("click", () => {
            timeMachine.stop();
          });

        document
          .getElementById("time-machine-start")
          .addEventListener("click", () => {
            const chat =
              appState.chats[appState.currentUser.id][appState.currentChatId];
            if (chat && chat.messages.length > 0) {
              timeMachine.init(chat.messages, chat);
              document
                .getElementById("time-machine-controls")
                .classList.remove("hidden");
              timeMachine.displayUpToIndex();
            }
          });

        document
          .getElementById("time-machine-prev")
          .addEventListener("click", () => {
            timeMachine.prev();
          });

        document
          .getElementById("time-machine-play")
          .addEventListener("click", () => {
            if (timeMachine.isPlaying) {
              timeMachine.pause();
            } else {
              timeMachine.play();
            }
          });

        document
          .getElementById("time-machine-next")
          .addEventListener("click", () => {
            timeMachine.next();
          });

        document
          .getElementById("time-machine-stop")
          .addEventListener("click", () => {
            timeMachine.stop();
          });

        document
          .getElementById("time-machine-branch")
          .addEventListener("click", () => {
            const branchChat = timeMachine.branchFromCurrentPoint();
            if (branchChat) {
              document
                .getElementById("time-machine-modal")
                .classList.remove("active");
              
              this.loadChat(branchChat.id);
              this.loadUserChats("active");
              
              this.showNotification(
                `Created branch from message ${timeMachine.currentIndex + 1}. You can now continue the conversation from this point.`,
                "success"
              );
            }
          });
      }

      handleMentionInput(e) {
        const value = this.userInput.value;
        const cursorPos = this.userInput.selectionStart;
        
        // Check for @ symbol
        const lastAtPos = value.lastIndexOf('@', cursorPos - 1);
        
        if (lastAtPos >= 0 && (lastAtPos === 0 || value[lastAtPos - 1] === ' ')) {
          const searchTerm = value.substring(lastAtPos + 1, cursorPos).toLowerCase();
          
          // Don't show dropdown if there's a space after @
          if (searchTerm.includes(' ')) {
            this.closeMentionDropdown();
            return;
          }
          
          this.mentionActive = true;
          this.mentionStartPos = lastAtPos;
          this.showMentionDropdown(searchTerm);
        } else {
          this.closeMentionDropdown();
        }
      }

      showMentionDropdown(searchTerm) {
        const endpoints = Object.values(appState.endpoints).filter(endpoint => 
          endpoint.name.toLowerCase().includes(searchTerm)
        );

        if (endpoints.length === 0) {
          this.closeMentionDropdown();
          return;
        }

        this.mentionDropdown.innerHTML = '';
        this.selectedMentionIndex = 0;

        endpoints.forEach((endpoint, index) => {
          const item = document.createElement('div');
          item.className = 'mention-item' + (index === 0 ? ' selected' : '');
          item.innerHTML = `
            <div class="mention-item-icon">${endpoint.name.charAt(0).toUpperCase()}</div>
            <div class="mention-item-info">
              <div class="mention-item-name">${endpoint.name}</div>
              <div class="mention-item-url">${endpoint.url}</div>
            </div>
          `;
          
          item.addEventListener('click', () => {
            this.selectMention(endpoint);
          });
          
          this.mentionDropdown.appendChild(item);
        });

        this.mentionDropdown.classList.add('active');
      }

      handleMentionNavigation(e) {
        const items = this.mentionDropdown.querySelectorAll('.mention-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          this.selectedMentionIndex = Math.min(this.selectedMentionIndex + 1, items.length - 1);
          this.updateMentionSelection();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          this.selectedMentionIndex = Math.max(this.selectedMentionIndex - 1, 0);
          this.updateMentionSelection();
        } else if (e.key === 'Enter' || e.key === 'Tab') {
          e.preventDefault();
          const endpoints = Object.values(appState.endpoints);
          const visibleEndpoints = Array.from(items).map(item => {
            const name = item.querySelector('.mention-item-name').textContent;
            return endpoints.find(ep => ep.name === name);
          });
          
          if (visibleEndpoints[this.selectedMentionIndex]) {
            this.selectMention(visibleEndpoints[this.selectedMentionIndex]);
          }
        } else if (e.key === 'Escape') {
          this.closeMentionDropdown();
        }
      }

      updateMentionSelection() {
        const items = this.mentionDropdown.querySelectorAll('.mention-item');
        items.forEach((item, index) => {
          item.classList.toggle('selected', index === this.selectedMentionIndex);
        });
      }

      selectMention(endpoint) {
        const value = this.userInput.value;
        const beforeMention = value.substring(0, this.mentionStartPos);
        const afterMention = value.substring(this.userInput.selectionStart);
        
        this.userInput.value = `${beforeMention}@${endpoint.name} ${afterMention}`;
        this.currentEndpointId = endpoint.id;
        
        const newCursorPos = beforeMention.length + endpoint.name.length + 2;
        this.userInput.setSelectionRange(newCursorPos, newCursorPos);
        
        this.closeMentionDropdown();
        this.userInput.focus();
      }

      closeMentionDropdown() {
        this.mentionActive = false;
        this.mentionStartPos = -1;
        this.selectedMentionIndex = 0;
        this.mentionDropdown.classList.remove('active');
        this.mentionDropdown.innerHTML = '';
      }

      openEndpointModal(endpointId = null) {
        this.editingEndpointId = endpointId;
        const modal = document.getElementById('endpoint-modal');
        const title = document.getElementById('endpoint-modal-title');
        
        if (endpointId) {
          title.textContent = 'Edit Endpoint';
          const endpoint = appState.getEndpointById(endpointId);
          document.getElementById('endpoint-name').value = endpoint.name;
          document.getElementById('endpoint-url').value = endpoint.url;
          document.getElementById('endpoint-key').value = endpoint.key;
          document.getElementById('endpoint-guid').value = endpoint.guid;
        } else {
          title.textContent = 'Add Endpoint';
          document.getElementById('endpoint-name').value = '';
          document.getElementById('endpoint-url').value = '';
          document.getElementById('endpoint-key').value = '';
          document.getElementById('endpoint-guid').value = 'c0p110t0-aaaa-bbbb-cccc-123456789abc';
        }
        
        modal.classList.add('active');
      }

      closeEndpointModal() {
        document.getElementById('endpoint-modal').classList.remove('active');
        this.editingEndpointId = null;
      }

      saveEndpoint() {
        const name = document.getElementById('endpoint-name').value.trim();
        const url = document.getElementById('endpoint-url').value.trim();
        const key = document.getElementById('endpoint-key').value.trim();
        const guid = document.getElementById('endpoint-guid').value.trim() || 'c0p110t0-aaaa-bbbb-cccc-123456789abc';

        if (!name || !url) {
          this.showNotification('Please fill in name and URL', 'warning');
          return;
        }

        if (this.editingEndpointId) {
          appState.updateEndpoint(this.editingEndpointId, { name, url, key, guid });
        } else {
          appState.addEndpoint(name, url, key, guid);
        }

        this.loadEndpointList();
        this.closeEndpointModal();
        this.showNotification('Endpoint saved successfully!', 'success');
      }

      loadEndpointList() {
        const endpointList = document.getElementById('endpoint-list');
        endpointList.innerHTML = '';

        const endpoints = Object.values(appState.endpoints);
        
        if (endpoints.length === 0) {
          endpointList.innerHTML = '<p style="color: var(--gray-60); text-align: center; padding: 20px;">No endpoints configured</p>';
          return;
        }

        endpoints.forEach(endpoint => {
          const item = document.createElement('div');
          item.className = 'endpoint-item';
          item.innerHTML = `
            <div class="endpoint-item-icon">${endpoint.name.charAt(0).toUpperCase()}</div>
            <div class="endpoint-item-info">
              <div class="endpoint-item-name">${endpoint.name}</div>
              <div class="endpoint-item-url">${endpoint.url}</div>
            </div>
            <div class="endpoint-item-actions">
              <button class="endpoint-item-action ${endpoint.active ? 'active' : ''}" title="${endpoint.active ? 'Active' : 'Set as default'}">
                <i class="fas fa-check"></i>
              </button>
              <button class="endpoint-item-action" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="endpoint-item-action" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;

          const actions = item.querySelectorAll('.endpoint-item-action');
          
          // Set active
          actions[0].addEventListener('click', () => {
            appState.setActiveEndpoint(endpoint.id);
            this.loadEndpointList();
          });

          // Edit
          actions[1].addEventListener('click', () => {
            this.openEndpointModal(endpoint.id);
          });

          // Delete
          actions[2].addEventListener('click', () => {
            if (confirm(`Delete endpoint "${endpoint.name}"?`)) {
              appState.deleteEndpoint(endpoint.id);
              this.loadEndpointList();
            }
          });

          endpointList.appendChild(item);
        });
      }

      initializeDragAndDrop() {
        const dropZone = document.getElementById("drop-zone");
        let dragCounter = 0;

        document.addEventListener("dragenter", (e) => {
          e.preventDefault();
          dragCounter++;
          dropZone.classList.add("active");
        });

        document.addEventListener("dragleave", (e) => {
          e.preventDefault();
          dragCounter--;
          if (dragCounter === 0) {
            dropZone.classList.remove("active");
          }
        });

        document.addEventListener("dragover", (e) => {
          e.preventDefault();
        });

        document.addEventListener("drop", (e) => {
          e.preventDefault();
          dragCounter = 0;
          dropZone.classList.remove("active");

          const files = Array.from(e.dataTransfer.files);
          files.forEach((file) => {
            if (file.type.startsWith("image/")) {
              this.handleImageUpload(file);
            } else if (file.type === "application/json") {
              this.handleJsonImport(file);
            }
          });
        });
      }

      checkExistingSession() {
        const lastUserId = localStorage.getItem("lastUserId");
        if (lastUserId && appState.users[lastUserId]) {
          appState.currentUser = appState.users[lastUserId];
          this.showApp();
        } else {
          this.showLogin();
        }
      }

      showLogin() {
        this.loginPage.classList.remove("hidden");
        this.appPage.classList.add("hidden");
        this.loadRecentUsers();
      }

      showApp() {
        this.loginPage.classList.add("hidden");
        this.appPage.classList.remove("hidden");

        document.getElementById("current-username").textContent =
          appState.currentUser.username;

        this.loadUserChats();
        this.applyTheme();
        this.applySettings();

        const activeChats = appState.getActiveChats(appState.currentUser.id);
        if (activeChats.length > 0) {
          this.loadChat(activeChats[0].id);
        } else {
          this.createNewChat();
        }
      }

      loadRecentUsers() {
        const recentUsersContainer = document.getElementById("recent-users");
        recentUsersContainer.innerHTML = "";

        const users = Object.values(appState.users)
          .sort((a, b) => new Date(b.lastActive) - new Date(a.lastActive))
          .slice(0, 5);

        users.forEach((user) => {
          const userElement = document.createElement("div");
          userElement.className = "user-item";
          userElement.innerHTML = `
            <div class="user-info">
              <div class="user-name">${user.username}</div>
              <div class="user-last-active">Last active: ${this.formatDate(
            user.lastActive
          )}</div>
            </div>
            <i class="fas fa-chevron-right"></i>
          `;
          userElement.addEventListener("click", () => {
            document.getElementById("username").value = user.username;
            this.handleLogin();
          });
          recentUsersContainer.appendChild(userElement);
        });
      }

      handleLogin() {
        const username = document.getElementById("username").value.trim();
        if (!username) return;

        let user = Object.values(appState.users).find(
          (u) => u.username === username
        );
        if (!user) {
          user = appState.createUser(username);
        }

        appState.currentUser = user;
        localStorage.setItem("lastUserId", user.id);

        this.showApp();
      }

      logout() {
        appState.currentUser = null;
        localStorage.removeItem("lastUserId");
        this.showLogin();
      }

      toggleSidebar() {
        this.sidebar.classList.toggle("open");
        this.sidebarOverlay.classList.toggle("active");
      }

      switchSidebarTab(tab) {
        document.querySelectorAll(".sidebar-tab").forEach((t) => {
          t.classList.toggle("active", t.dataset.tab === tab);
        });

        document
          .getElementById("chat-list-active")
          .classList.toggle("hidden", tab !== "active");
        document
          .getElementById("chat-list-archived")
          .classList.toggle("hidden", tab !== "archived");

        this.loadUserChats(tab);
      }

      loadUserChats(tab = "active") {
        const containerId =
          tab === "active" ? "chat-list-active" : "chat-list-archived";
        const chatList = document.getElementById(containerId);
        chatList.innerHTML = "";

        const chats =
          tab === "active"
            ? appState.getActiveChats(appState.currentUser.id)
            : appState.getArchivedChats(appState.currentUser.id);

        if (chats.length === 0) {
          chatList.innerHTML = `<div class="chat-list-empty">No ${tab} chats</div>`;
          return;
        }

        chats.forEach((chat) => {
          const chatElement = document.createElement("div");
          chatElement.className = "chat-item";
          if (chat.id === appState.currentChatId) {
            chatElement.classList.add("active");
          }

          const lastMessage = chat.messages[chat.messages.length - 1];
          const preview = lastMessage
            ? this.truncateText(lastMessage.content, 50)
            : "New conversation";

          chatElement.innerHTML = `
            <div class="chat-item-title">${chat.title}</div>
            <div class="chat-item-preview">${preview}</div>
            <div class="chat-item-date">${this.formatDate(
            chat.updatedAt
          )}</div>
            <div class="chat-item-actions">
              ${tab === "active"
              ? '<button class="chat-item-action" title="Archive"><i class="fas fa-archive"></i></button>'
              : '<button class="chat-item-action" title="Restore"><i class="fas fa-undo"></i></button>'
            }
              <button class="chat-item-action" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
          `;

          chatElement.addEventListener("click", (e) => {
            if (!e.target.closest(".chat-item-action")) {
              this.loadChat(chat.id);
              this.toggleSidebar();
            }
          });

          const archiveBtn = chatElement.querySelector(
            ".chat-item-action:first-child"
          );
          archiveBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (tab === "active") {
              appState.archiveChat(appState.currentUser.id, chat.id);
              if (chat.id === appState.currentChatId) {
                this.createNewChat();
              }
            } else {
              appState.unarchiveChat(appState.currentUser.id, chat.id);
            }
            this.loadUserChats(tab);
          });

          const deleteBtn = chatElement.querySelector(
            ".chat-item-action:last-child"
          );
          deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (
              confirm(
                "Are you sure you want to permanently delete this chat?"
              )
            ) {
              appState.deleteChat(appState.currentUser.id, chat.id);
              if (chat.id === appState.currentChatId) {
                this.createNewChat();
              }
              this.loadUserChats(tab);
            }
          });

          chatList.appendChild(chatElement);
        });
      }

      createNewChat() {
        const chat = appState.createChat(appState.currentUser.id);
        appState.currentChatId = chat.id;
        this.currentEndpointId = null;
        this.loadUserChats("active");
        this.clearChatMessages();
      }

      loadChat(chatId) {
        const chat = appState.chats[appState.currentUser.id][chatId];
        if (!chat) return;

        appState.currentChatId = chatId;
        this.currentEndpointId = null;
        this.loadUserChats(chat.archived ? "archived" : "active");
        this.displayChatMessages(chat.messages);
      }

      clearCurrentChat() {
        if (!appState.currentChatId) return;

        const chat =
          appState.chats[appState.currentUser.id][appState.currentChatId];
        if (!chat || chat.messages.length === 0) {
          this.createNewChat();
          return;
        }

        if (chat.archived) {
          appState.unarchiveChat(
            appState.currentUser.id,
            appState.currentChatId
          );
        }

        this.createNewChat();
      }

      archiveCurrentChat() {
        if (!appState.currentChatId) return;

        const chat =
          appState.chats[appState.currentUser.id][appState.currentChatId];
        if (!chat || chat.messages.length === 0) return;

        if (
          confirm(
            "Archive this chat? You can restore it later from the archived tab."
          )
        ) {
          appState.archiveChat(
            appState.currentUser.id,
            appState.currentChatId
          );
          this.createNewChat();
        }
      }

      displayChatMessages(messages) {
        this.chatMessages.innerHTML = "";
        messages.forEach((message) => {
          this.addMessageToUI(
            message.role,
            message.content,
            false,
            message.voiceResponse,
            message.endpointName
          );
        });
        this.scrollToBottom();
      }

      clearChatMessages() {
        this.chatMessages.innerHTML = "";
      }

      createMessageElement(role, content, endpointName = null) {
        const messageWrapper = document.createElement("div");
        messageWrapper.className = `message-wrapper ${role}`;

        if (role === "system") {
          const systemMessage = document.createElement("div");
          systemMessage.className = "system-message";

          const agentMatch = content.match(/Agent: ([^\n]+)/);
          if (agentMatch) {
            const agentName = agentMatch[1];
            const uniqueId =
              "agent-output-" + Math.random().toString(36).substr(2, 9);

            const agentWrapper = document.createElement("div");
            agentWrapper.className = "agent-output-wrapper";
            agentWrapper.id = uniqueId;

            agentWrapper.innerHTML = `
              <div class="agent-output-header" onclick="ui.toggleAgentOutput('${uniqueId}')">
                <div class="agent-output-title">
                  <i class="fas fa-robot"></i>
                  <span>Agent: ${agentName}</span>
                </div>
                <button class="agent-output-toggle">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
              <div class="agent-output-content" id="${uniqueId}-content">
                <div class="agent-output-text">${content}</div>
              </div>
            `;

            messageWrapper.appendChild(agentWrapper);
          } else {
            systemMessage.textContent = content;
            messageWrapper.appendChild(systemMessage);
          }
        } else {
          const label = document.createElement("div");
          label.className = "message-label";
          label.innerHTML = role === "user"
            ? "You"
            : `${appState.currentUser.username}'s Assistant${endpointName ? `<span class="endpoint-badge"><i class="fas fa-server"></i>${endpointName}</span>` : ''}`;

          const messageContent = document.createElement("div");
          messageContent.className = "message-content";

          if (role === "user" && content.startsWith("data:image")) {
            messageContent.innerHTML = `<img src="../../${content}" alt="Uploaded image" style="max-width: 100%; border-radius: 8px;">`;
          } else {
            messageContent.innerHTML = this.formatMessage(content);
          }

          messageWrapper.appendChild(label);
          messageWrapper.appendChild(messageContent);
        }

        return messageWrapper;
      }

      toggleAgentOutput(id) {
        const content = document.getElementById(id + "-content");
        const header = document.querySelector(`#${id} .agent-output-header`);
        const toggleIcon = header.querySelector(".agent-output-toggle i");

        if (content.classList.contains("expanded")) {
          content.classList.remove("expanded");
          toggleIcon.className = "fas fa-chevron-down";
        } else {
          content.classList.add("expanded");
          toggleIcon.className = "fas fa-chevron-up";
        }
      }

      addMessageToUI(role, content, animate = true, voiceResponse = null, endpointName = null) {
        const messageWrapper = this.createMessageElement(role, content, endpointName);

        if (role === "assistant" && voiceResponse) {
          const voiceMessage = document.createElement("div");
          voiceMessage.className = "voice-message active";
          voiceMessage.innerHTML = `
            <i class="fas fa-volume-up"></i>
            <span>Voice: "${voiceResponse}"</span>
          `;
          messageWrapper.appendChild(voiceMessage);
        }

        this.chatMessages.appendChild(messageWrapper);

        if (role === "assistant" || role === "system") {
          messageWrapper.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightBlock(block);
          });
        }

        if (animate) {
          this.scrollToBottom();
        }
      }

      formatMessage(text) {
        let formattedText = text;

        // Handle @mentions
        formattedText = formattedText.replace(/@(\w+)/g, (match, name) => {
          return `<span class="mention-tag">@${name}</span>`;
        });

        formattedText = formattedText.replace(
          /```(\w+)?\n([\s\S]+?)```/g,
          (match, lang, code) => {
            const language = lang || "plaintext";
            const escapedCode = this.escapeHtml(code.trim());
            return `<pre><code class="${language}">${escapedCode}</code></pre>`;
          }
        );

        formattedText = formattedText.replace(/`([^`]+)`/g, (match, code) => {
          return `<code>${this.escapeHtml(code)}</code>`;
        });

        formattedText = formattedText.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        formattedText = formattedText.replace(/\*([^*]+)\*/g, "<em>$1</em>");

        formattedText = formattedText.replace(
          /\[([^\]]+)\]\(([^)]+)\)/g,
          (match, linkText, url) => {
            return `<span class="link-wrapper"><a href="../../${url}" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> ${linkText}</a></span>`;
          }
        );

        formattedText = formattedText.replace(
          /!\[([^\]]*)\]\(([^)]+)\)/g,
          (match, altText, url) => {
            const displayText = altText || "Image";
            const imageExtensions = ["jpg", "jpeg", "png", "gif", "svg", "webp", "bmp"];
            const urlLower = url.toLowerCase();
            const isImage = imageExtensions.some(
              (ext) =>
                urlLower.includes(`.${ext}`) ||
                urlLower.includes(`/${ext}?`) ||
                urlLower.includes("generated_images")
            );

            if (isImage) {
              return `
                <div style="margin: 10px 0;">
                  <div style="margin-bottom: 5px;">
                    <a href="../../${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none;">
                      <i class="fas fa-external-link-alt" style="font-size: 12px;"></i> ${displayText}
                    </a>
                  </div>
                  <img src="../../${url}"
                       alt="${displayText}"
                       style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: var(--shadow-small); cursor: pointer;"
                       onclick="window.open('${url.replace(/'/g, "\\'")}', '_blank')"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                  <div style="display: none; padding: 20px; background: var(--gray-20); border-radius: 8px; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--warning); font-size: 24px;"></i>
                    <p style="margin: 10px 0 5px 0; color: var(--gray-80);">Unable to load image</p>
                    <a href="../../${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">
                      Click here to view image
                    </a>
                  </div>
                </div>
              `;
            } else {
              return `<span class="link-wrapper"><a href="../../${url}" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> ${displayText}</a></span>`;
            }
          }
        );

        formattedText = formattedText.replace(
          /(https?:\/\/[^\s<]+)(?![^<]*>|[^<>]*<\/)/g,
          (match, url) => {
            const imageExtensions = ["jpg", "jpeg", "png", "gif", "svg", "webp", "bmp"];
            const urlLower = url.toLowerCase();
            const isImage = imageExtensions.some(
              (ext) =>
                urlLower.includes(`.${ext}`) ||
                urlLower.includes(`/${ext}?`) ||
                urlLower.includes("generated_images")
            );

            if (isImage) {
              return `
                <div style="margin: 10px 0;">
                  <div style="margin-bottom: 5px;">
                    <a href="../../${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none; font-size: 13px; word-break: break-all;">
                      <i class="fas fa-external-link-alt" style="font-size: 12px;"></i> ${url}
                    </a>
                  </div>
                  <img src="../../${url}"
                       alt="Image"
                       style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: var(--shadow-small); cursor: pointer;"
                       onclick="window.open('${url.replace(/'/g, "\\'")}', '_blank')"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                  <div style="display: none; padding: 20px; background: var(--gray-20); border-radius: 8px; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--warning); font-size: 24px;"></i>
                    <p style="margin: 10px 0 5px 0; color: var(--gray-80);">Unable to load image</p>
                    <a href="../../${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">
                      Click here to view image
                    </a>
                  </div>
                </div>
              `;
            } else {
              return `<span class="link-wrapper"><a href="../../${url}" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> ${url}</a></span>`;
            }
          }
        );

        formattedText = formattedText.replace(/\n/g, "<br>");

        return formattedText;
      }

      escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      async sendMessage() {
        const message = this.userInput.value.trim();
        if (!message && !this.pendingImage) return;

        // Check for @mentions in message
        const mentionRegex = /@(\w+)/g;
        let targetEndpoint = null;
        const mentions = [];
        let match;

        while ((match = mentionRegex.exec(message)) !== null) {
          mentions.push(match[1]);
        }

        // Find endpoint by mention
        if (mentions.length > 0) {
          const endpoints = Object.values(appState.endpoints);
          targetEndpoint = endpoints.find(ep => 
            mentions.some(mention => ep.name.toLowerCase() === mention.toLowerCase())
          );
        }

        // Use mentioned endpoint, or current endpoint, or active endpoint
        const endpoint = targetEndpoint || 
          (this.currentEndpointId ? appState.getEndpointById(this.currentEndpointId) : null) ||
          appState.getActiveEndpoint();

        if (!endpoint || !endpoint.url) {
          this.openSettings();
          this.showNotification(
            "Please configure at least one endpoint",
            "warning"
          );
          return;
        }

        this.sendButton.disabled = true;

        const chat =
          appState.chats[appState.currentUser.id][appState.currentChatId];
        const userMessage = {
          role: "user",
          content: this.pendingImage || message,
          timestamp: new Date().toISOString(),
        };

        chat.messages.push(userMessage);
        this.addMessageToUI("user", userMessage.content);

        this.userInput.value = "";
        this.userInput.style.height = "auto";
        this.clearImagePreview();

        soundManager.playSendSound();

        this.showLoadingIndicator();

        try {
          const response = await fetch(endpoint.url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-functions-key": endpoint.key,
            },
            body: JSON.stringify({
              user_input: message || "Please analyze this image",
              conversation_history: chat.messages,
              user_guid: endpoint.guid,
            }),
          });

          if (!response.ok) {
            if (response.status === 401) {
              throw new Error(
                `Invalid function key for ${endpoint.name}. Please check your settings.`
              );
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          this.hideLoadingIndicator();

          const assistantMessage = {
            role: "assistant",
            content:
              data.assistant_response ||
              data.text ||
              "Sorry, I received an empty response.",
            voiceResponse: data.voice_response || null,
            endpointName: endpoint.name,
            timestamp: new Date().toISOString(),
          };

          chat.messages.push(assistantMessage);
          this.addMessageToUI(
            "assistant",
            assistantMessage.content,
            true,
            assistantMessage.voiceResponse,
            assistantMessage.endpointName
          );

          soundManager.playReceiveSound();

          if (appState.settings.autoSpeak && assistantMessage.voiceResponse) {
            await voiceManager.speak(assistantMessage.voiceResponse);
          }

          if (data.agent_logs) {
            const systemMessage = {
              role: "system",
              content: data.agent_logs,
              timestamp: new Date().toISOString(),
            };
            chat.messages.push(systemMessage);
            this.addMessageToUI("system", systemMessage.content);
          }

          chat.updatedAt = new Date().toISOString();
          if (chat.messages.length === 2) {
            chat.title = this.generateChatTitle(message || "Image analysis");
          }

          appState.saveChats();
          this.loadUserChats("active");
        } catch (error) {
          console.error("Error:", error);
          this.hideLoadingIndicator();
          this.addMessageToUI("system", `Error: ${error.message}`);
          soundManager.playNotificationSound();
        } finally {
          this.sendButton.disabled = false;
          this.userInput.focus();
        }
      }

      showLoadingIndicator() {
        const existingLoading = document.getElementById("loading-indicator");
        if (existingLoading) {
          existingLoading.remove();
        }

        const loadingDiv = document.createElement("div");
        loadingDiv.className = "loading active";
        loadingDiv.id = "loading-indicator";
        loadingDiv.innerHTML = `
          <span></span>
          <span></span>
          <span></span>
        `;
        this.chatMessages.appendChild(loadingDiv);
        this.scrollToBottom();
      }

      hideLoadingIndicator() {
        const loadingIndicators = document.querySelectorAll(".loading");
        loadingIndicators.forEach((indicator) => {
          indicator.remove();
        });
      }

      handleImageUpload(file) {
        if (!file || !file.type.startsWith("image/")) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          this.pendingImage = e.target.result;
          this.showImagePreview(e.target.result);
        };
        reader.readAsDataURL(file);
      }

      showImagePreview(imageSrc) {
        this.imagePreviewContainer.innerHTML = `
          <div class="image-preview">
            <img src="../../${imageSrc}" alt="Preview">
            <button class="image-preview-remove" onclick="ui.clearImagePreview()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        this.imagePreviewContainer.classList.add("active");
      }

      clearImagePreview() {
        this.pendingImage = null;
        this.imagePreviewContainer.innerHTML = "";
        this.imagePreviewContainer.classList.remove("active");
      }

      exportCurrentChat() {
        if (!appState.currentChatId) return;

        const chat =
          appState.chats[appState.currentUser.id][appState.currentChatId];

        const conversation = chat.messages.map((msg) => ({
          role: msg.role,
          content: msg.content,
        }));

        const endpoint = appState.getActiveEndpoint();

        const exportData = {
          conversation: conversation,
          guid: endpoint.guid,
          timestamp: new Date().toISOString(),
          appName: "_",
        };

        const filename = `conversation-${new Date()
          .toISOString()
          .replace(/:/g, "_")}.json`;
        this.downloadJson(exportData, filename);
      }

      exportAllData() {
        const exportData = appState.exportAllData();
        this.downloadJson(exportData, `chat-app-backup-${Date.now()}.json`);
      }

      exportSettings() {
        const settingsData = appState.exportSettings();
        const filename = `chat-settings-${new Date()
          .toISOString()
          .replace(/:/g, "_")}.json`;
        this.downloadJson(settingsData, filename);
      }

      importSettings(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const settingsData = JSON.parse(e.target.result);
            
            if (!settingsData.version || (!settingsData.endpoints && !settingsData.azureTTSKey)) {
              throw new Error("Invalid settings file format");
            }
            
            appState.importSettings(settingsData);
            
            this.applySettings();
            
            if (settingsData.azureTTSKey) {
              voiceManager.setAzureKey(settingsData.azureTTSKey);
            }
            if (settingsData.ttsVoiceName) {
              voiceManager.setVoiceName(settingsData.ttsVoiceName);
            }
            
            this.showNotification("Settings imported successfully!", "success");
            
            document.getElementById("settings-modal").classList.remove("active");
            
            this.openSettings();
          } catch (error) {
            this.showNotification(
              "Error importing settings: " + error.message,
              "error"
            );
          }
        };
        reader.readAsText(file);
      }

      downloadJson(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      importChat(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);

            if (data.conversation && Array.isArray(data.conversation)) {
              const newChat = appState.createChat(appState.currentUser.id,
                "Imported Chat"
              );

              newChat.messages = data.conversation.map((msg) => ({
                role: msg.role,
                content: msg.content,
                timestamp: new Date().toISOString(),
              }));

              newChat.updatedAt = data.timestamp || new Date().toISOString();

              if (newChat.messages.length > 0) {
                const firstUserMessage = newChat.messages.find(
                  (m) => m.role === "user"
                );
                if (firstUserMessage) {
                  newChat.title = this.generateChatTitle(
                    firstUserMessage.content
                  );
                }
              }

              appState.saveChats();
              this.loadChat(newChat.id);
              this.loadUserChats("active");
              this.showNotification("Chat imported successfully!", "success");
            } else if (data.chat && data.chat.messages) {
              const newChat = appState.createChat(
                appState.currentUser.id,
                data.chat.title || "Imported Chat"
              );
              newChat.messages = data.chat.messages;
              newChat.updatedAt = new Date().toISOString();

              appState.saveChats();
              this.loadChat(newChat.id);
              this.loadUserChats("active");
              this.showNotification("Chat imported successfully!", "success");
            } else {
              throw new Error("Invalid chat format");
            }
          } catch (error) {
            this.showNotification(
              "Error importing chat: " + error.message,
              "error"
            );
          }
        };
        reader.readAsText(file);
      }

      importAllData(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (!data.version || !data.users || !data.chats) {
              throw new Error("Invalid backup format");
            }

            if (
              confirm(
                "This will merge the imported data with your existing data. Continue?"
              )
            ) {
              appState.importAllData(data);
              this.showNotification(
                "Data imported successfully! Please login again.",
                "success"
              );
              this.logout();
            }
          } catch (error) {
            this.showNotification(
              "Error importing data: " + error.message,
              "error"
            );
          }
        };
        reader.readAsText(file);
      }

      handleJsonImport(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (data.conversation || (data.chat && data.user)) {
              this.importChat(file);
            } else if (data.users && data.chats) {
              this.importAllData(file);
            } else {
              this.showNotification("Unknown file format", "error");
            }
          } catch (error) {
            this.showNotification(
              "Error reading file: " + error.message,
              "error"
            );
          }
        };
        reader.readAsText(file);
      }

      generateChatTitle(firstMessage) {
        const cleanMessage = firstMessage
          .replace(/[^\w\s]/g, "")
          .toLowerCase();
        const words = cleanMessage.split(" ").filter((w) => w.length > 3);

        if (words.length > 3) {
          return words.slice(0, 3).join(" ");
        } else if (firstMessage.length > 30) {
          return firstMessage.substring(0, 30) + "...";
        } else {
          return firstMessage;
        }
      }

      toggleTheme() {
        const isDark = document.body.classList.toggle("dark");
        appState.settings.theme = isDark ? "dark" : "light";
        appState.saveSettings();

        const themeIcon = document.querySelector("#theme-toggle i");
        themeIcon.className = isDark ? "fas fa-sun" : "fas fa-moon";

        const darkModeToggle = document.getElementById("dark-mode-toggle");
        if (darkModeToggle) {
          darkModeToggle.classList.toggle("active", isDark);
        }
      }

      applyTheme() {
        if (appState.settings.theme === "dark") {
          document.body.classList.add("dark");
          document.querySelector("#theme-toggle i").className = "fas fa-sun";
        }
      }

      saveAllSettings() {
        const isDarkMode = document
          .getElementById("dark-mode-toggle")
          .classList.contains("active");
        appState.settings.theme = isDarkMode ? "dark" : "light";

        if (isDarkMode && !document.body.classList.contains("dark")) {
          document.body.classList.add("dark");
          document.querySelector("#theme-toggle i").className = "fas fa-sun";
        } else if (!isDarkMode && document.body.classList.contains("dark")) {
          document.body.classList.remove("dark");
          document.querySelector("#theme-toggle i").className = "fas fa-moon";
        }

        appState.settings.soundEnabled = document
          .getElementById("sound-toggle")
          .classList.contains("active");
        soundManager.setEnabled(appState.settings.soundEnabled);

        appState.settings.voiceEnabled = document
          .getElementById("voice-enabled-toggle")
          .classList.contains("active");
        appState.settings.autoSpeak = document
          .getElementById("auto-speak-toggle")
          .classList.contains("active");

        voiceManager.setEnabled(appState.settings.voiceEnabled);
        voiceManager.setAutoSpeak(appState.settings.autoSpeak);

        const azureTTSKey = document
          .getElementById("azure-tts-key")
          .value.trim();
        appState.settings.azureTTSKey = azureTTSKey;
        voiceManager.setAzureKey(azureTTSKey);

        const ttsVoice = document.getElementById("tts-voice-select").value;
        appState.settings.ttsVoiceName = ttsVoice;
        voiceManager.setVoiceName(ttsVoice);

        appState.saveSettings();

        this.showNotification("Settings saved successfully!", "success");
        document.getElementById("settings-modal").classList.remove("active");
      }

      applySettings() {
        this.applyTheme();

        soundManager.setEnabled(appState.settings.soundEnabled);

        voiceManager.setEnabled(appState.settings.voiceEnabled);
        voiceManager.setAutoSpeak(appState.settings.autoSpeak);
        voiceManager.setAzureKey(appState.settings.azureTTSKey);
        voiceManager.setVoiceName(appState.settings.ttsVoiceName);

        const darkModeToggle = document.getElementById("dark-mode-toggle");
        if (darkModeToggle) {
          darkModeToggle.classList.toggle(
            "active",
            appState.settings.theme === "dark"
          );
        }

        const soundToggle = document.getElementById("sound-toggle");
        if (soundToggle) {
          soundToggle.classList.toggle(
            "active",
            appState.settings.soundEnabled
          );
        }

        const voiceEnabledToggle = document.getElementById(
          "voice-enabled-toggle"
        );
        if (voiceEnabledToggle) {
          voiceEnabledToggle.classList.toggle(
            "active",
            appState.settings.voiceEnabled
          );
        }

        const autoSpeakToggle = document.getElementById("auto-speak-toggle");
        if (autoSpeakToggle) {
          autoSpeakToggle.classList.toggle(
            "active",
            appState.settings.autoSpeak
          );
        }

        const azureTTSKeyInput = document.getElementById("azure-tts-key");
        if (azureTTSKeyInput && appState.settings.azureTTSKey) {
          azureTTSKeyInput.value = appState.settings.azureTTSKey;
        }

        const ttsVoiceSelect = document.getElementById("tts-voice-select");
        if (ttsVoiceSelect) {
          ttsVoiceSelect.value = appState.settings.ttsVoiceName;
        }

        this.loadEndpointList();
      }

      openSettings() {
        this.applySettings();
        document.getElementById("settings-modal").classList.add("active");
      }

      openTimeMachine() {
        const chat =
          appState.chats[appState.currentUser.id][appState.currentChatId];
        if (!chat || chat.messages.length === 0) {
          this.showNotification(
            "No messages to replay in the current chat.",
            "info"
          );
          return;
        }

        document.getElementById("time-machine-modal").classList.add("active");
        document
          .getElementById("time-machine-controls")
          .classList.add("hidden");
      }

      closeMenu() {
        document.getElementById("menu-toggle").classList.remove("active");
        document.getElementById("menu-items").classList.remove("open");
      }

      scrollToBottom() {
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
      }

      truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + "...";
      }

      formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return "Just now";
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

        return date.toLocaleDateString();
      }

      showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === "success"
            ? "var(--success)"
            : type === "error"
              ? "var(--error)"
              : type === "warning"
                ? "var(--warning)"
                : "var(--info)"
          };
          color: white;
          padding: 16px 24px;
          border-radius: var(--radius);
          box-shadow: var(--shadow-large);
          z-index: 2000;
          animation: slideUp 0.3s ease-out;
          max-width: 320px;
        `;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "fadeOut 0.3s ease-out";
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }
    }

    // Initialize UI Controller
    const ui = new UIController();

    // Make UI instance globally accessible for inline event handlers
    window.ui = ui;

    // Initialize sound manager with saved settings
    soundManager.setEnabled(appState.settings.soundEnabled);

    // Initialize voice manager with saved settings
    voiceManager.setEnabled(appState.settings.voiceEnabled);
    voiceManager.setAutoSpeak(appState.settings.autoSpeak);
    voiceManager.setAzureKey(appState.settings.azureTTSKey);
    voiceManager.setVoiceName(appState.settings.ttsVoiceName);

    // Add keyboard navigation support
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const modals = document.querySelectorAll(".modal.active");
        modals.forEach((modal) => {
          modal.classList.remove("active");
        });

        if (
          document.getElementById("menu-items").classList.contains("open")
        ) {
          ui.closeMenu();
        }

        if (document.getElementById("sidebar").classList.contains("open")) {
          ui.toggleSidebar();
        }
      }

      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        document.getElementById("user-input").focus();
      }

      if ((e.metaKey || e.ctrlKey) && e.key === "n") {
        e.preventDefault();
        ui.createNewChat();
      }
    });

    // Add fade out animation
    const style = document.createElement("style");
    style.textContent = `
      @keyframes fadeOut {
        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }
    `;
    document.head.appendChild(style);

    // Force load voices for speech synthesis
    if ("speechSynthesis" in window) {
      speechSynthesis.getVoices();
      window.speechSynthesis.onvoiceschanged = () => {
        speechSynthesis.getVoices();
      };
    }
  </script>
</body>

</html>