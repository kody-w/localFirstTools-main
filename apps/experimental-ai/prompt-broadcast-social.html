<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Broadcast Social</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: white;
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .mode-btn.active {
            background: #764ba2;
            color: white;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #qrcode {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 15px;
            margin: 20px 0;
        }

        .broadcast-info {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .broadcast-info h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .broadcast-info p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .broadcast-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .broadcast-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .broadcast-item.live {
            border-color: #22c55e;
            background: linear-gradient(to right, white, #f0fdf4);
        }

        .broadcast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .broadcast-title {
            font-weight: 600;
            color: #333;
            font-size: 18px;
        }

        .broadcast-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .broadcast-status.live {
            background: #22c55e;
            color: white;
            animation: pulse 2s infinite;
        }

        .broadcast-status.past {
            background: #94a3b8;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .broadcast-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .rating-display {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .star {
            color: #fbbf24;
            font-size: 16px;
        }

        .viewer-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .prompt-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            min-height: 200px;
        }

        .prompt-display h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        .prompt-display p {
            line-height: 1.8;
            font-size: 18px;
        }

        .interaction-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .rating-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
        }

        .rating-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .star-rating {
            display: flex;
            gap: 10px;
            font-size: 32px;
            margin-bottom: 15px;
        }

        .star-rating span {
            cursor: pointer;
            transition: all 0.2s ease;
            color: #d1d5db;
        }

        .star-rating span:hover,
        .star-rating span.active {
            color: #fbbf24;
            transform: scale(1.2);
        }

        .comments-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .comment {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .comment-author {
            font-weight: 600;
            color: #667eea;
        }

        .comment-time {
            font-size: 12px;
            color: #999;
        }

        .comment-text {
            color: #333;
            line-height: 1.6;
        }

        .reactions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .reaction-btn {
            padding: 5px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .reaction-btn:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }

        .reaction-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .imessage-panel {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .imessage-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .imessage-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #34c759, #30d158);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message-bubble.received {
            background: #e5e5ea;
            color: #000;
            margin-right: auto;
        }

        .message-bubble.sent {
            background: #007aff;
            color: white;
            margin-left: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .timeline {
            margin-top: 30px;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .timeline-time {
            font-weight: 600;
            color: #667eea;
            min-width: 80px;
        }

        .timeline-content {
            flex: 1;
        }

        .participant-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .participant {
            padding: 8px 15px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 20px;
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
        }

        .scanner-container {
            text-align: center;
            padding: 40px;
        }

        .scanner-container video {
            width: 100%;
            max-width: 500px;
            border-radius: 15px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .interaction-panel {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .mode-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Prompt Broadcast Social</h1>
            <p>Share prompts, connect with others, and collaborate on experiences</p>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('host')">üì° Host Broadcast</button>
            <button class="mode-btn" onclick="switchMode('join')">üîó Join Broadcast</button>
            <button class="mode-btn" onclick="switchMode('browse')">üåç Browse & Replay</button>
            <button class="mode-btn" onclick="switchMode('viewer')">üëÅÔ∏è Viewer Mode</button>
        </div>

        <!-- HOST MODE -->
        <div id="host-section" class="content-section active">
            <div class="card">
                <h2 style="margin-bottom: 20px;">üéôÔ∏è Create Your Broadcast</h2>
                
                <div class="input-group">
                    <label>Broadcast Title</label>
                    <input type="text" id="broadcast-title" placeholder="e.g., X-Wing Mission Challenge">
                </div>

                <div class="input-group">
                    <label>Your Prompt</label>
                    <textarea id="broadcast-prompt" placeholder="Describe your prompt, game level, challenge, or experience..."></textarea>
                </div>

                <div class="input-group">
                    <label>Category</label>
                    <select id="broadcast-category">
                        <option value="game">üéÆ Gaming Challenge</option>
                        <option value="creative">üé® Creative Prompt</option>
                        <option value="learning">üìö Learning Experience</option>
                        <option value="social">üë• Social Activity</option>
                        <option value="other">üåü Other</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Broadcast Mode</label>
                    <select id="broadcast-mode">
                        <option value="live">üî¥ Live (Real-time)</option>
                        <option value="async">üìº Asynchronous (Record & Share)</option>
                    </select>
                </div>

                <button class="btn" onclick="startBroadcast()">üöÄ Start Broadcast & Generate QR Code</button>

                <div id="broadcast-active" style="display: none;">
                    <div class="broadcast-info">
                        <h3>‚úÖ Broadcast Active!</h3>
                        <div id="qrcode"></div>
                        <p style="text-align: center; margin: 15px 0;">
                            <strong>Broadcast ID:</strong> <span id="broadcast-id-display"></span>
                        </p>
                        <p style="text-align: center;">Share this QR code or the link below for people to join!</p>
                        <input type="text" id="share-link" readonly style="text-align: center; font-weight: 600;">
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="viewer-count">0</div>
                            <div class="stat-label">Active Viewers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="comment-count">0</div>
                            <div class="stat-label">Comments</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avg-rating">0.0</div>
                            <div class="stat-label">Avg Rating</div>
                        </div>
                    </div>

                    <div class="participant-list" id="participants"></div>

                    <button class="btn" onclick="endBroadcast()" style="background: #ef4444; margin-top: 20px;">‚èπÔ∏è End Broadcast</button>
                </div>
            </div>

            <!-- iMessage Integration Panel -->
            <div class="imessage-panel" id="imessage-host" style="display: none;">
                <div class="imessage-header">
                    <div class="imessage-icon">üí¨</div>
                    <div>
                        <h3 style="margin: 0;">iMessage Group Chat</h3>
                        <p style="margin: 0; font-size: 14px; color: #666;">Broadcast notifications & updates</p>
                    </div>
                </div>
                <div id="imessage-messages-host"></div>
            </div>
        </div>

        <!-- JOIN MODE -->
        <div id="join-section" class="content-section">
            <div class="card">
                <h2 style="margin-bottom: 20px;">üîó Join a Broadcast</h2>
                
                <div class="scanner-container">
                    <h3>Scan QR Code or Enter Broadcast ID</h3>
                    <p style="color: #666; margin: 10px 0;">Use your device camera to scan a QR code</p>
                    <button class="btn" onclick="startQRScanner()">üì∑ Start Camera Scanner</button>
                    <video id="qr-video" style="display: none;"></video>
                    <canvas id="qr-canvas" style="display: none;"></canvas>
                </div>

                <div style="text-align: center; margin: 30px 0;">- OR -</div>

                <div class="input-group">
                    <label>Enter Broadcast ID</label>
                    <input type="text" id="join-id" placeholder="Enter broadcast ID...">
                </div>

                <div class="input-group">
                    <label>Your Display Name</label>
                    <input type="text" id="user-name" placeholder="Enter your name...">
                </div>

                <button class="btn" onclick="joinBroadcast()">üéØ Join Broadcast</button>
            </div>
        </div>

        <!-- BROWSE MODE -->
        <div id="browse-section" class="content-section">
            <div class="card">
                <h2 style="margin-bottom: 20px;">üåç Browse Broadcasts</h2>
                
                <div class="input-group">
                    <input type="text" id="search-broadcasts" placeholder="üîç Search broadcasts..." onkeyup="filterBroadcasts()">
                </div>

                <div id="broadcasts-list"></div>
            </div>
        </div>

        <!-- VIEWER MODE -->
        <div id="viewer-section" class="content-section">
            <div class="viewer-section">
                <div class="prompt-display">
                    <h2 id="viewer-title">Loading...</h2>
                    <p id="viewer-prompt">Waiting for broadcast data...</p>
                    <div style="margin-top: 20px; font-size: 14px;">
                        <span>üë• <span id="viewer-participants">0</span> participants</span>
                        <span style="margin-left: 20px;">‚è±Ô∏è <span id="viewer-time">--:--</span></span>
                    </div>
                </div>

                <div class="interaction-panel">
                    <div class="rating-section">
                        <h3>‚≠ê Rate This Prompt</h3>
                        <div class="star-rating" id="user-rating">
                            <span onclick="setRating(1)">‚òÖ</span>
                            <span onclick="setRating(2)">‚òÖ</span>
                            <span onclick="setRating(3)">‚òÖ</span>
                            <span onclick="setRating(4)">‚òÖ</span>
                            <span onclick="setRating(5)">‚òÖ</span>
                        </div>
                        <p style="color: #666; font-size: 14px;">Your rating: <strong id="your-rating">Not rated</strong></p>
                    </div>

                    <div class="rating-section">
                        <h3>üí¨ Quick Comment</h3>
                        <div class="input-group" style="margin-bottom: 10px;">
                            <textarea id="comment-input" placeholder="Share your thoughts..." style="min-height: 80px;"></textarea>
                        </div>
                        <button class="btn" onclick="postComment()">Send Comment</button>
                    </div>
                </div>

                <div class="comments-section">
                    <h3 style="margin-bottom: 15px;">üí¨ Comments & Reactions</h3>
                    <div id="comments-list"></div>
                </div>

                <!-- Timeline for Async/Replay -->
                <div class="timeline" id="broadcast-timeline" style="display: none;">
                    <h3 style="margin-bottom: 15px;">üìä Broadcast Timeline</h3>
                    <div id="timeline-content"></div>
                </div>

                <!-- iMessage for Viewer -->
                <div class="imessage-panel">
                    <div class="imessage-header">
                        <div class="imessage-icon">üí¨</div>
                        <div>
                            <h3 style="margin: 0;">iMessage Updates</h3>
                            <p style="margin: 0; font-size: 14px; color: #666;">Broadcast notifications</p>
                        </div>
                    </div>
                    <div id="imessage-messages-viewer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentMode = 'host';
        let currentBroadcast = null;
        let broadcasts = [];
        let currentUser = null;
        let ratings = {};
        let comments = [];
        let participants = new Set();
        let broadcastStartTime = null;

        // Initialize with some demo broadcasts
        function initDemoBroadcasts() {
            const demos = [
                {
                    id: 'demo-001',
                    title: 'X-Wing Mission: Trench Run',
                    prompt: 'Fly through the Death Star trench and destroy the reactor core. Timing and precision matter - sync with other pilots for maximum score!',
                    category: 'game',
                    mode: 'live',
                    status: 'live',
                    host: 'RedLeader',
                    participants: 8,
                    avgRating: 4.7,
                    commentCount: 23,
                    timestamp: Date.now()
                },
                {
                    id: 'demo-002',
                    title: 'AI Story Collaboration',
                    prompt: 'Continue this story: "In a world where dreams become reality..." - Each participant adds a paragraph!',
                    category: 'creative',
                    mode: 'async',
                    status: 'past',
                    host: 'StoryWeaver',
                    participants: 15,
                    avgRating: 4.9,
                    commentCount: 47,
                    timestamp: Date.now() - 3600000
                },
                {
                    id: 'demo-003',
                    title: 'Code Review Challenge',
                    prompt: 'Review this React component and suggest improvements. Share your insights and learn from others!',
                    category: 'learning',
                    mode: 'async',
                    status: 'past',
                    host: 'DevMaster',
                    participants: 12,
                    avgRating: 4.5,
                    commentCount: 31,
                    timestamp: Date.now() - 7200000
                }
            ];
            
            broadcasts = [...demos];
            renderBroadcasts();
        }

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;
            
            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update sections
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${mode}-section`).classList.add('active');
            
            // Load appropriate content
            if (mode === 'browse') {
                renderBroadcasts();
            } else if (mode === 'viewer' && currentBroadcast) {
                loadViewerMode();
            }
        }

        // Host: Start Broadcast
        function startBroadcast() {
            const title = document.getElementById('broadcast-title').value;
            const prompt = document.getElementById('broadcast-prompt').value;
            const category = document.getElementById('broadcast-category').value;
            const mode = document.getElementById('broadcast-mode').value;
            
            if (!title || !prompt) {
                alert('Please fill in all fields!');
                return;
            }
            
            const broadcastId = 'BC-' + Date.now().toString(36).toUpperCase();
            
            currentBroadcast = {
                id: broadcastId,
                title,
                prompt,
                category,
                mode,
                status: 'live',
                host: 'You',
                participants: 1,
                avgRating: 0,
                commentCount: 0,
                timestamp: Date.now()
            };
            
            broadcasts.unshift(currentBroadcast);
            broadcastStartTime = Date.now();
            
            // Generate QR Code
            document.getElementById('qrcode').innerHTML = '';
            const shareUrl = `${window.location.href}?join=${broadcastId}`;
            new QRCode(document.getElementById('qrcode'), {
                text: shareUrl,
                width: 256,
                height: 256
            });
            
            document.getElementById('broadcast-id-display').textContent = broadcastId;
            document.getElementById('share-link').value = shareUrl;
            document.getElementById('broadcast-active').style.display = 'block';
            document.getElementById('imessage-host').style.display = 'block';
            
            // Send iMessage notification
            sendIMessage('host', `üéØ Broadcast started: "${title}". Join now!`);
            
            // Simulate viewers joining
            simulateActivity();
        }

        // End Broadcast
        function endBroadcast() {
            if (currentBroadcast) {
                currentBroadcast.status = 'past';
                sendIMessage('host', `üìä Broadcast ended. ${participants.size} participants joined. Avg rating: ${currentBroadcast.avgRating.toFixed(1)}‚≠ê`);
            }
            document.getElementById('broadcast-active').style.display = 'none';
            document.getElementById('imessage-host').style.display = 'none';
            currentBroadcast = null;
        }

        // QR Scanner (simplified - in production use library like jsQR)
        function startQRScanner() {
            const video = document.getElementById('qr-video');
            video.style.display = 'block';
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(stream => {
                        video.srcObject = stream;
                        video.play();
                        alert('QR Scanner active! In production, this would scan QR codes. For now, enter a Broadcast ID manually.');
                    })
                    .catch(err => {
                        alert('Camera access denied. Please enter Broadcast ID manually.');
                    });
            }
        }

        // Join Broadcast
        function joinBroadcast() {
            const joinId = document.getElementById('join-id').value.trim();
            const userName = document.getElementById('user-name').value.trim();
            
            if (!joinId || !userName) {
                alert('Please enter both Broadcast ID and your name!');
                return;
            }
            
            const broadcast = broadcasts.find(b => b.id === joinId);
            
            if (!broadcast) {
                alert('Broadcast not found! Try one of the demo IDs: demo-001, demo-002, or demo-003');
                return;
            }
            
            currentBroadcast = broadcast;
            currentUser = userName;
            participants.add(userName);
            
            // Switch to viewer mode
            switchMode('viewer');
            loadViewerMode();
            
            sendIMessage('viewer', `üëã ${userName} joined the broadcast!`);
        }

        // Load Viewer Mode
        function loadViewerMode() {
            if (!currentBroadcast) {
                document.getElementById('viewer-title').textContent = 'No broadcast loaded';
                document.getElementById('viewer-prompt').textContent = 'Please join a broadcast first!';
                return;
            }
            
            document.getElementById('viewer-title').textContent = currentBroadcast.title;
            document.getElementById('viewer-prompt').textContent = currentBroadcast.prompt;
            document.getElementById('viewer-participants').textContent = currentBroadcast.participants;
            
            // Update time
            updateViewerTime();
            setInterval(updateViewerTime, 1000);
            
            // Load comments
            renderComments();
            
            // Show timeline for past broadcasts
            if (currentBroadcast.status === 'past') {
                document.getElementById('broadcast-timeline').style.display = 'block';
                renderTimeline();
            }
        }

        // Update viewer time
        function updateViewerTime() {
            if (broadcastStartTime) {
                const elapsed = Math.floor((Date.now() - broadcastStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('viewer-time').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Rating
        function setRating(stars) {
            const ratingDiv = document.getElementById('user-rating');
            const allStars = ratingDiv.querySelectorAll('span');
            
            allStars.forEach((star, index) => {
                if (index < stars) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            
            if (currentBroadcast && currentUser) {
                ratings[currentUser] = stars;
                updateAverageRating();
                document.getElementById('your-rating').textContent = `${stars} stars`;
                sendIMessage('viewer', `‚≠ê Rated ${stars} stars`);
            }
        }

        // Update average rating
        function updateAverageRating() {
            const ratingValues = Object.values(ratings);
            if (ratingValues.length > 0) {
                const avg = ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length;
                currentBroadcast.avgRating = avg;
                document.getElementById('avg-rating').textContent = avg.toFixed(1);
            }
        }

        // Post Comment
        function postComment() {
            const commentText = document.getElementById('comment-input').value.trim();
            
            if (!commentText || !currentUser) {
                alert('Please enter a comment!');
                return;
            }
            
            const comment = {
                id: Date.now(),
                author: currentUser,
                text: commentText,
                timestamp: Date.now(),
                reactions: {}
            };
            
            comments.unshift(comment);
            currentBroadcast.commentCount = comments.length;
            document.getElementById('comment-count').textContent = comments.length;
            document.getElementById('comment-input').value = '';
            
            renderComments();
            sendIMessage('viewer', `üí¨ "${commentText.substring(0, 50)}${commentText.length > 50 ? '...' : ''}"`);
        }

        // Render Comments
        function renderComments() {
            const container = document.getElementById('comments-list');
            
            if (comments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No comments yet. Be the first to share your thoughts!</p>';
                return;
            }
            
            container.innerHTML = comments.map(comment => {
                const timeAgo = getTimeAgo(comment.timestamp);
                return `
                    <div class="comment">
                        <div class="comment-header">
                            <span class="comment-author">${comment.author}</span>
                            <span class="comment-time">${timeAgo}</span>
                        </div>
                        <div class="comment-text">${comment.text}</div>
                        <div class="reactions">
                            <button class="reaction-btn" onclick="reactToComment(${comment.id}, 'like')">
                                üëç ${comment.reactions.like || 0}
                            </button>
                            <button class="reaction-btn" onclick="reactToComment(${comment.id}, 'love')">
                                ‚ù§Ô∏è ${comment.reactions.love || 0}
                            </button>
                            <button class="reaction-btn" onclick="reactToComment(${comment.id}, 'fire')">
                                üî• ${comment.reactions.fire || 0}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // React to Comment
        function reactToComment(commentId, reactionType) {
            const comment = comments.find(c => c.id === commentId);
            if (comment) {
                comment.reactions[reactionType] = (comment.reactions[reactionType] || 0) + 1;
                renderComments();
            }
        }

        // Render Broadcasts List
        function renderBroadcasts() {
            const container = document.getElementById('broadcasts-list');
            
            container.innerHTML = broadcasts.map(broadcast => `
                <div class="broadcast-item ${broadcast.status}" onclick="selectBroadcast('${broadcast.id}')">
                    <div class="broadcast-header">
                        <span class="broadcast-title">${broadcast.title}</span>
                        <span class="broadcast-status ${broadcast.status}">
                            ${broadcast.status === 'live' ? 'üî¥ LIVE' : 'üìº REPLAY'}
                        </span>
                    </div>
                    <p style="color: #666; margin: 10px 0;">${broadcast.prompt.substring(0, 120)}...</p>
                    <div class="broadcast-meta">
                        <span>üë• ${broadcast.participants} participants</span>
                        <span>‚≠ê ${broadcast.avgRating.toFixed(1)}</span>
                        <span>üí¨ ${broadcast.commentCount} comments</span>
                        <span>üè∑Ô∏è ${getCategoryEmoji(broadcast.category)} ${broadcast.category}</span>
                    </div>
                </div>
            `).join('');
        }

        // Select Broadcast
        function selectBroadcast(id) {
            currentBroadcast = broadcasts.find(b => b.id === id);
            currentUser = currentUser || prompt('Enter your display name:') || 'Guest';
            switchMode('viewer');
            loadViewerMode();
        }

        // Filter Broadcasts
        function filterBroadcasts() {
            const search = document.getElementById('search-broadcasts').value.toLowerCase();
            const filtered = broadcasts.filter(b => 
                b.title.toLowerCase().includes(search) || 
                b.prompt.toLowerCase().includes(search)
            );
            
            const container = document.getElementById('broadcasts-list');
            container.innerHTML = filtered.map(broadcast => `
                <div class="broadcast-item ${broadcast.status}" onclick="selectBroadcast('${broadcast.id}')">
                    <div class="broadcast-header">
                        <span class="broadcast-title">${broadcast.title}</span>
                        <span class="broadcast-status ${broadcast.status}">
                            ${broadcast.status === 'live' ? 'üî¥ LIVE' : 'üìº REPLAY'}
                        </span>
                    </div>
                    <p style="color: #666; margin: 10px 0;">${broadcast.prompt.substring(0, 120)}...</p>
                    <div class="broadcast-meta">
                        <span>üë• ${broadcast.participants} participants</span>
                        <span>‚≠ê ${broadcast.avgRating.toFixed(1)}</span>
                        <span>üí¨ ${broadcast.commentCount} comments</span>
                    </div>
                </div>
            `).join('');
        }

        // Render Timeline
        function renderTimeline() {
            const timeline = document.getElementById('timeline-content');
            const events = [
                { time: '00:00', event: 'Broadcast started' },
                { time: '00:45', event: 'First viewer joined' },
                { time: '02:15', event: 'Peak viewers reached (15)' },
                { time: '05:30', event: 'Most comments received' },
                { time: '08:00', event: 'Broadcast ended' }
            ];
            
            timeline.innerHTML = events.map(e => `
                <div class="timeline-item">
                    <div class="timeline-time">${e.time}</div>
                    <div class="timeline-content">${e.event}</div>
                </div>
            `).join('');
        }

        // iMessage Integration
        function sendIMessage(mode, message) {
            const container = mode === 'host' ? 
                document.getElementById('imessage-messages-host') : 
                document.getElementById('imessage-messages-viewer');
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${mode === 'host' ? 'sent' : 'received'}`;
            bubble.textContent = message;
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        // Simulate Activity
        function simulateActivity() {
            const names = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Henry'];
            
            setInterval(() => {
                if (currentBroadcast && currentBroadcast.status === 'live') {
                    // Add random viewer
                    if (Math.random() > 0.7) {
                        const name = names[Math.floor(Math.random() * names.length)];
                        participants.add(name);
                        currentBroadcast.participants = participants.size;
                        document.getElementById('viewer-count').textContent = participants.size;
                        
                        // Update participants display
                        const participantsList = document.getElementById('participants');
                        participantsList.innerHTML = '<h3 style="width: 100%; margin: 20px 0 10px 0;">Active Participants:</h3>' +
                            Array.from(participants).map(p => `<div class="participant">${p}</div>`).join('');
                    }
                }
            }, 5000);
        }

        // Utility Functions
        function getCategoryEmoji(category) {
            const emojis = {
                game: 'üéÆ',
                creative: 'üé®',
                learning: 'üìö',
                social: 'üë•',
                other: 'üåü'
            };
            return emojis[category] || 'üåü';
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        }

        // Check for join parameter in URL
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const joinId = urlParams.get('join');
            
            if (joinId) {
                document.getElementById('join-id').value = joinId;
                switchMode('join');
            }
            
            initDemoBroadcasts();
        });
    </script>
</body>
</html>