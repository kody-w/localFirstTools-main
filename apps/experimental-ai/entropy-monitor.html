<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entropy Monitor â€” Ecosystem Heat Death Watch</title>
    <meta name="description" content="Real-time Shannon entropy, Gini coefficient, and technique diversity tracking for the RappterZoo ecosystem. Predicts frames until creative heat death.">
    <meta name="rappterzoo:author" content="RappterZoo">
    <meta name="rappterzoo:author-type" content="agent">
    <meta name="rappterzoo:category" content="experimental-ai">
    <meta name="rappterzoo:tags" content="entropy,information-theory,diversity,monitoring,meta,ecosystem,statistics,heat-death">
    <meta name="rappterzoo:type" content="interactive">
    <meta name="rappterzoo:complexity" content="advanced">
    <meta name="rappterzoo:created" content="2026-02-08">
    <meta name="rappterzoo:generation" content="1">
    <style>
:root {
    --bg: #0a0a0f;
    --panel: rgba(14,14,22,0.88);
    --border: rgba(255,255,255,0.05);
    --text: #8a8fa0;
    --bright: #c4c9d8;
    --red: #ff1744;
    --amber: #ff9100;
    --green: #00e676;
    --cyan: #18ffff;
    --purple: #7c4dff;
    --dim: #3a3d4a;
    --glow-red: rgba(255,23,68,0.15);
    --glow-green: rgba(0,230,118,0.1);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    background: var(--bg);
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'Courier New', monospace;
    height: 100vh;
    overflow-y: auto;
    overflow-x: hidden;
}
/* Scanline overlay */
body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.03) 2px,
        rgba(0,0,0,0.03) 4px
    );
    pointer-events: none;
    z-index: 100;
}

.header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 50;
    backdrop-filter: blur(16px);
}
.header h1 {
    font-size: 0.85rem;
    font-weight: 400;
    letter-spacing: 3px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 10px;
}
.header h1 .skull { font-size: 1.2rem; }
.header h1 .title-text {
    background: linear-gradient(90deg, var(--red), var(--amber));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.pulse-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
    animation: pulse-live 2s infinite;
}
.pulse-dot.warning { background: var(--amber); box-shadow: 0 0 6px var(--amber); }
.pulse-dot.critical { background: var(--red); box-shadow: 0 0 8px var(--red); animation: pulse-crit 0.5s infinite; }
@keyframes pulse-live { 0%,100%{ opacity: 0.4; } 50%{ opacity: 1; } }
@keyframes pulse-crit { 0%,100%{ opacity: 0.3; } 50%{ opacity: 1; } }

.header-right {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 0.65rem;
    color: var(--dim);
}
#refresh-timer { font-variant-numeric: tabular-nums; }

/* Alarm banner */
#alarm-banner {
    display: none;
    padding: 10px 20px;
    background: linear-gradient(90deg, rgba(255,23,68,0.12), rgba(255,23,68,0.04));
    border-bottom: 1px solid rgba(255,23,68,0.2);
    font-size: 0.75rem;
    color: var(--red);
    text-align: center;
    letter-spacing: 1px;
    animation: alarm-flash 1.5s infinite;
}
#alarm-banner.active { display: block; }
@keyframes alarm-flash {
    0%,100% { background: linear-gradient(90deg, rgba(255,23,68,0.12), rgba(255,23,68,0.04)); }
    50% { background: linear-gradient(90deg, rgba(255,23,68,0.25), rgba(255,23,68,0.08)); }
}

/* Main grid */
.dashboard {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1px;
    padding: 1px;
    background: var(--border);
}
.panel {
    background: var(--bg);
    padding: 16px;
    min-height: 180px;
    position: relative;
}
.panel-wide { grid-column: span 2; }
.panel-full { grid-column: span 3; }
.panel h2 {
    font-size: 0.6rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--dim);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.panel h2 .badge {
    font-size: 0.55rem;
    padding: 1px 6px;
    border-radius: 3px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
}

/* Big metric */
.big-metric {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 10px 0;
}
.big-metric .value {
    font-size: 2.8rem;
    font-weight: 200;
    font-variant-numeric: tabular-nums;
    line-height: 1;
    margin-bottom: 4px;
}
.big-metric .unit {
    font-size: 0.6rem;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 1px;
}
.big-metric .subtitle {
    font-size: 0.65rem;
    color: var(--dim);
    margin-top: 6px;
}
.big-metric .delta {
    font-size: 0.7rem;
    margin-top: 4px;
    font-variant-numeric: tabular-nums;
}
.delta-up { color: var(--green); }
.delta-down { color: var(--red); }
.delta-flat { color: var(--dim); }

/* Status color coding */
.healthy .value { color: var(--green); text-shadow: 0 0 20px var(--glow-green); }
.warning .value { color: var(--amber); }
.critical .value { color: var(--red); text-shadow: 0 0 20px var(--glow-red); }

/* Chart canvases */
.chart-container {
    width: 100%;
    height: 120px;
    position: relative;
}
.chart-container canvas {
    width: 100%;
    height: 100%;
}
.chart-container.tall { height: 160px; }

/* Distribution bars */
.dist-bars {
    display: flex;
    align-items: flex-end;
    gap: 3px;
    height: 90px;
    padding-top: 10px;
}
.dist-bar {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
}
.dist-bar .bar {
    width: 100%;
    border-radius: 2px 2px 0 0;
    transition: height 0.5s ease;
    min-height: 1px;
}
.dist-bar .bar-label {
    font-size: 0.5rem;
    color: var(--dim);
    text-align: center;
    font-variant-numeric: tabular-nums;
}
.dist-bar .bar-count {
    font-size: 0.5rem;
    color: var(--text);
    font-variant-numeric: tabular-nums;
}

/* Category Gini bars */
.gini-bars {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.gini-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.6rem;
}
.gini-row .cat-name {
    min-width: 60px;
    color: var(--dim);
    text-align: right;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.gini-row .gini-track {
    flex: 1;
    height: 8px;
    background: rgba(255,255,255,0.03);
    border-radius: 4px;
    overflow: hidden;
}
.gini-row .gini-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s;
}
.gini-row .gini-count {
    min-width: 24px;
    text-align: right;
    font-variant-numeric: tabular-nums;
    color: var(--text);
}

/* Technique cloud */
.tech-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    max-height: 130px;
    overflow: hidden;
}
.tech-tag {
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.55rem;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    color: var(--text);
    transition: all 0.3s;
}

/* Doomsday clock */
.doomsday {
    text-align: center;
    padding: 20px 0;
}
.doomsday .clock-face {
    position: relative;
    width: 160px;
    height: 160px;
    margin: 0 auto 12px;
}
.doomsday .clock-face canvas {
    width: 100%;
    height: 100%;
}
.doomsday .frames-left {
    font-size: 3rem;
    font-weight: 200;
    font-variant-numeric: tabular-nums;
    line-height: 1;
}
.doomsday .frames-label {
    font-size: 0.6rem;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
}
.doomsday .prophecy {
    font-size: 0.68rem;
    color: var(--dim);
    font-style: italic;
    margin-top: 12px;
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.5;
}

/* Threshold controls */
.threshold-ctrl {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.6rem;
    margin-top: 10px;
    justify-content: center;
}
.threshold-ctrl label { color: var(--dim); }
.threshold-ctrl input[type=range] {
    -webkit-appearance: none;
    width: 100px; height: 3px;
    background: rgba(255,255,255,0.08);
    border-radius: 2px;
    outline: none;
}
.threshold-ctrl input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--red);
    cursor: pointer;
}
.threshold-ctrl .thresh-val {
    font-variant-numeric: tabular-nums;
    color: var(--red);
    min-width: 32px;
}

/* Log feed */
.log-feed {
    font-size: 0.6rem;
    max-height: 140px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 3px;
}
.log-entry {
    display: flex;
    gap: 8px;
    padding: 2px 0;
    border-bottom: 1px solid rgba(255,255,255,0.02);
}
.log-entry .log-time { color: var(--dim); min-width: 50px; font-variant-numeric: tabular-nums; }
.log-entry .log-msg { color: var(--text); }
.log-entry.log-warn .log-msg { color: var(--amber); }
.log-entry.log-crit .log-msg { color: var(--red); }
.log-entry.log-ok .log-msg { color: var(--green); }

/* Responsive */
@media (max-width: 900px) {
    .dashboard { grid-template-columns: 1fr 1fr; }
    .panel-wide { grid-column: span 2; }
    .panel-full { grid-column: span 2; }
}
@media (max-width: 600px) {
    .dashboard { grid-template-columns: 1fr; }
    .panel-wide, .panel-full { grid-column: span 1; }
    .big-metric .value { font-size: 2rem; }
}
    </style>
</head>
<body>

<div class="header">
    <h1>
        <span class="skull">ðŸ’€</span>
        <span class="title-text">Entropy Monitor</span>
        <div class="pulse-dot" id="status-dot"></div>
    </h1>
    <div class="header-right">
        <span id="refresh-timer">Next scan: 5s</span>
        <span id="last-update">â€”</span>
    </div>
</div>

<div id="alarm-banner">âš  ENTROPY BELOW THRESHOLD â€” CREATIVE HEAT DEATH APPROACHING âš </div>

<div class="dashboard">
    <!-- Row 1: Big three metrics -->
    <div class="panel" id="p-shannon">
        <h2>Shannon Entropy <span class="badge">score distribution</span></h2>
        <div class="big-metric healthy" id="m-shannon">
            <div class="value" id="v-shannon">â€”</div>
            <div class="unit">bits</div>
            <div class="subtitle" id="s-shannon">of <span id="max-shannon">â€”</span> max</div>
            <div class="delta" id="d-shannon"></div>
        </div>
    </div>

    <div class="panel" id="p-gini">
        <h2>Gini Coefficient <span class="badge">category balance</span></h2>
        <div class="big-metric healthy" id="m-gini">
            <div class="value" id="v-gini">â€”</div>
            <div class="unit">inequality index</div>
            <div class="subtitle">0 = perfect equality, 1 = total domination</div>
            <div class="delta" id="d-gini"></div>
        </div>
    </div>

    <div class="panel" id="p-simpson">
        <h2>Technique Diversity <span class="badge">simpson's index</span></h2>
        <div class="big-metric healthy" id="m-simpson">
            <div class="value" id="v-simpson">â€”</div>
            <div class="unit">diversity index</div>
            <div class="subtitle" id="s-simpson"><span id="tech-count">â€”</span> unique techniques</div>
            <div class="delta" id="d-simpson"></div>
        </div>
    </div>

    <!-- Row 2: Score distribution + Category balance -->
    <div class="panel panel-wide">
        <h2>Score Distribution <span class="badge" id="uniformity-badge">â€”</span></h2>
        <div class="dist-bars" id="score-dist"></div>
        <div class="chart-container" style="height:80px;margin-top:8px">
            <canvas id="entropy-timeline"></canvas>
        </div>
    </div>

    <div class="panel">
        <h2>Category Balance</h2>
        <div class="gini-bars" id="cat-balance"></div>
    </div>

    <!-- Row 3: Doomsday + Technique cloud + Log -->
    <div class="panel">
        <h2>Doomsday Clock <span class="badge">heat death ETA</span></h2>
        <div class="doomsday">
            <div class="clock-face"><canvas id="clock-canvas" width="160" height="160"></canvas></div>
            <div class="frames-left" id="frames-left">âˆž</div>
            <div class="frames-label">frames until homogeneity</div>
            <div class="prophecy" id="prophecy">Awaiting data...</div>
            <div class="threshold-ctrl">
                <label>Alarm threshold:</label>
                <input type="range" id="thresh-slider" min="0" max="300" value="200" step="10">
                <span class="thresh-val" id="thresh-val">2.00</span>
                <label>bits</label>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>Technique Genome <span class="badge" id="tech-badge">â€”</span></h2>
        <div class="tech-cloud" id="tech-cloud"></div>
    </div>

    <div class="panel">
        <h2>Event Log</h2>
        <div class="log-feed" id="log-feed"></div>
    </div>

    <!-- Row 4: Historical entropy chart -->
    <div class="panel panel-full">
        <h2>Entropy History Across Frames <span class="badge">trend analysis</span></h2>
        <div class="chart-container tall">
            <canvas id="history-chart"></canvas>
        </div>
    </div>

    <!-- Row 5: Grade entropy + Ecosystem vitals -->
    <div class="panel">
        <h2>Grade Distribution Entropy</h2>
        <div class="big-metric" id="m-grade">
            <div class="value" id="v-grade">â€”</div>
            <div class="unit">bits</div>
            <div class="subtitle">S/A/B/C/D/F distribution</div>
        </div>
        <div class="dist-bars" id="grade-dist" style="height:60px"></div>
    </div>

    <div class="panel">
        <h2>Ecosystem Vitals</h2>
        <div style="display:flex;flex-direction:column;gap:6px;font-size:0.68rem">
            <div style="display:flex;justify-content:space-between"><span class="k">Total Apps</span><span id="vital-apps" style="color:var(--bright)">â€”</span></div>
            <div style="display:flex;justify-content:space-between"><span class="k">Avg Score</span><span id="vital-avg" style="color:var(--bright)">â€”</span></div>
            <div style="display:flex;justify-content:space-between"><span class="k">Identified (ðŸ§¬)</span><span id="vital-ident" style="color:var(--bright)">â€”</span></div>
            <div style="display:flex;justify-content:space-between"><span class="k">Categories</span><span id="vital-cats" style="color:var(--bright)">â€”</span></div>
            <div style="display:flex;justify-content:space-between"><span class="k">Molter Frame</span><span id="vital-frame" style="color:var(--bright)">â€”</span></div>
            <div style="display:flex;justify-content:space-between"><span class="k">Total Molts</span><span id="vital-molts" style="color:var(--bright)">â€”</span></div>
            <div style="display:flex;justify-content:space-between"><span class="k">Score Std Dev</span><span id="vital-stddev" style="color:var(--bright)">â€”</span></div>
            <div style="display:flex;justify-content:space-between"><span class="k">Entropy Rate</span><span id="vital-erate" style="color:var(--bright)">â€”</span></div>
        </div>
    </div>

    <div class="panel">
        <h2>Entropy Breakdown</h2>
        <div style="display:flex;flex-direction:column;gap:6px;font-size:0.68rem" id="entropy-breakdown"></div>
    </div>
</div>

<script>
(function(){
"use strict";

const $ = id => document.getElementById(id);

const CAT_COLORS = {
    '3d_immersive':'#e91e63','audio_music':'#ff9800','creative_tools':'#4caf50',
    'educational_tools':'#2196f3','experimental_ai':'#9c27b0','games_puzzles':'#f44336',
    'generative_art':'#00bcd4','particle_physics':'#ff5722','visual_art':'#e040fb',
    'data_tools':'#8bc34a','productivity':'#607d8b'
};
const GRADE_COLORS = {S:'#ffd700',A:'#00e676',B:'#2196f3',C:'#ff9800',D:'#f44336',F:'#666'};

let prevEntropy = null;
let prevGini = null;
let prevSimpson = null;
let alarmThreshold = 2.0;
let logEntries = [];
let historyData = []; // entropy values across frames
let refreshCountdown = 5;
let dataLoadCount = 0;

// â”€â”€ Math utilities â”€â”€
function shannonEntropy(counts) {
    const total = counts.reduce((s, c) => s + c, 0);
    if (total === 0) return 0;
    let H = 0;
    for (const c of counts) {
        if (c === 0) continue;
        const p = c / total;
        H -= p * Math.log2(p);
    }
    return H;
}

function giniCoefficient(values) {
    const n = values.length;
    if (n === 0) return 0;
    const sorted = [...values].sort((a, b) => a - b);
    const mean = sorted.reduce((s, v) => s + v, 0) / n;
    if (mean === 0) return 0;
    let sumDiff = 0;
    for (let i = 0; i < n; i++) {
        for (let j = 0; j < n; j++) {
            sumDiff += Math.abs(sorted[i] - sorted[j]);
        }
    }
    return sumDiff / (2 * n * n * mean);
}

function simpsonDiversity(counts) {
    const N = counts.reduce((s, c) => s + c, 0);
    if (N <= 1) return 0;
    let sum = 0;
    for (const n of counts) sum += n * (n - 1);
    return 1 - sum / (N * (N - 1));
}

function stdDev(values) {
    const n = values.length;
    if (n === 0) return 0;
    const mean = values.reduce((s, v) => s + v, 0) / n;
    const variance = values.reduce((s, v) => s + (v - mean) ** 2, 0) / n;
    return Math.sqrt(variance);
}

function linearRegression(xs, ys) {
    const n = xs.length;
    if (n < 2) return { slope: 0, intercept: ys[0] || 0 };
    const mx = xs.reduce((s, x) => s + x, 0) / n;
    const my = ys.reduce((s, y) => s + y, 0) / n;
    let num = 0, den = 0;
    for (let i = 0; i < n; i++) {
        num += (xs[i] - mx) * (ys[i] - my);
        den += (xs[i] - mx) ** 2;
    }
    const slope = den === 0 ? 0 : num / den;
    return { slope, intercept: my - slope * mx };
}

// â”€â”€ Data Loading â”€â”€
async function loadJSON(path) {
    const r = await fetch(path, { cache: 'no-cache' });
    if (!r.ok) throw new Error(path);
    return r.json();
}

async function scan() {
    try {
        const [rankings, molterState, identities, manifest] = await Promise.all([
            loadJSON('../rankings.json'),
            loadJSON('../molter-state.json'),
            loadJSON('../content-identities.json'),
            loadJSON('../manifest.json')
        ]);
        dataLoadCount++;

        // Cache for other tabs
        try {
            localStorage.setItem('entropy-monitor-data', JSON.stringify({
                ts: Date.now(),
                rankings: rankings.rankings || [],
                history: molterState.history || [],
                frame: molterState.frame || 0,
                identities: Object.keys(identities).length,
                techniques: extractTechniques(identities),
                categories: manifest.categories || {}
            }));
        } catch(e) { /* quota */ }

        processData(rankings.rankings || [], molterState, identities, manifest);
        $('status-dot').className = 'pulse-dot';
        addLog('ok', 'Scan complete â€” ' + (rankings.rankings || []).length + ' apps ingested');
    } catch(e) {
        // Try localStorage fallback
        const cached = localStorage.getItem('entropy-monitor-data');
        if (cached) {
            const d = JSON.parse(cached);
            addLog('warn', 'Live fetch failed, using cached data (' + new Date(d.ts).toLocaleTimeString() + ')');
            // Minimal processing from cache
        } else {
            addLog('crit', 'Data load failed: ' + e.message);
            $('status-dot').className = 'pulse-dot critical';
        }
    }
}

function extractTechniques(identities) {
    const techs = {};
    for (const [, data] of Object.entries(identities)) {
        for (const t of (data.techniques || [])) {
            const key = t.toLowerCase().trim();
            techs[key] = (techs[key] || 0) + 1;
        }
    }
    return techs;
}

// â”€â”€ Main Processing â”€â”€
function processData(apps, molterState, identities, manifest) {
    const scores = apps.map(a => a.score || 0);
    const cats = {};
    const grades = {};
    for (const a of apps) {
        cats[a.category] = (cats[a.category] || 0) + 1;
        const g = a.grade || '?';
        grades[g] = (grades[g] || 0) + 1;
    }

    // 1. Shannon Entropy (score buckets of 10)
    const buckets = {};
    for (const s of scores) {
        const b = Math.floor(s / 10) * 10;
        buckets[b] = (buckets[b] || 0) + 1;
    }
    const bucketCounts = Object.values(buckets);
    const entropy = shannonEntropy(bucketCounts);
    const maxEntropy = Math.log2(Object.keys(buckets).length);
    const entropyRatio = maxEntropy > 0 ? entropy / maxEntropy : 0;

    $('v-shannon').textContent = entropy.toFixed(4);
    $('max-shannon').textContent = maxEntropy.toFixed(2);
    setStatus('m-shannon', entropyRatio > 0.8 ? 'healthy' : entropyRatio > 0.6 ? 'warning' : 'critical');
    setDelta('d-shannon', entropy, prevEntropy, ' bits');
    prevEntropy = entropy;

    // 2. Gini Coefficient
    const catCounts = Object.values(cats);
    const gini = giniCoefficient(catCounts);

    $('v-gini').textContent = gini.toFixed(4);
    setStatus('m-gini', gini < 0.3 ? 'healthy' : gini < 0.5 ? 'warning' : 'critical');
    setDelta('d-gini', gini, prevGini, '', true); // inverted: lower is better
    prevGini = gini;

    // 3. Technique Diversity (Simpson's)
    const techniques = extractTechniques(identities);
    const techCounts = Object.values(techniques);
    const simpson = simpsonDiversity(techCounts);

    $('v-simpson').textContent = simpson.toFixed(4);
    $('tech-count').textContent = Object.keys(techniques).length;
    setStatus('m-simpson', simpson > 0.95 ? 'healthy' : simpson > 0.9 ? 'warning' : 'critical');
    setDelta('d-simpson', simpson, prevSimpson, '');
    prevSimpson = simpson;

    // 4. Score distribution bars
    renderScoreDist(buckets, scores.length);

    // 5. Category balance
    renderCatBalance(cats, manifest.categories || {});

    // 6. Grade entropy
    const gradeOrder = ['S','A','B','C','D','F'];
    const gradeCounts = gradeOrder.map(g => grades[g] || 0);
    const gradeEntropy = shannonEntropy(gradeCounts);
    $('v-grade').textContent = gradeEntropy.toFixed(3);
    setStatus('m-grade', gradeEntropy > 2 ? 'healthy' : gradeEntropy > 1.5 ? 'warning' : 'critical');
    renderGradeDist(grades, apps.length);

    // 7. Technique cloud
    renderTechCloud(techniques);

    // 8. Vitals
    const totalMolts = (molterState.history || []).reduce((s, h) => s + (h.actions.molted || []).length, 0);
    $('vital-apps').textContent = apps.length;
    $('vital-avg').textContent = (scores.reduce((s, v) => s + v, 0) / scores.length).toFixed(1);
    $('vital-ident').textContent = Object.keys(identities).length;
    $('vital-cats').textContent = Object.keys(cats).length;
    $('vital-frame').textContent = molterState.frame || 0;
    $('vital-molts').textContent = totalMolts;
    $('vital-stddev').textContent = stdDev(scores).toFixed(2);

    // 9. Historical analysis
    const history = molterState.history || [];
    historyData = computeHistoricalEntropy(history);
    renderHistoryChart(historyData);
    renderEntropyTimeline(historyData);

    // 10. Entropy rate
    if (historyData.length >= 2) {
        const entropies = historyData.map(h => h.entropy);
        const frames = historyData.map(h => h.frame);
        const reg = linearRegression(frames, entropies);
        $('vital-erate').textContent = (reg.slope >= 0 ? '+' : '') + reg.slope.toFixed(4) + ' bits/frame';
        $('vital-erate').style.color = reg.slope >= 0 ? 'var(--green)' : 'var(--red)';
    }

    // 11. Entropy breakdown
    renderBreakdown(entropy, maxEntropy, gini, simpson, gradeEntropy);

    // 12. Doomsday clock
    computeDoomsday(historyData, entropy);

    // 13. Alarm check
    checkAlarm(entropy);

    // 14. Update HUD
    $('uniformity-badge').textContent = (entropyRatio * 100).toFixed(1) + '% diverse';
    $('tech-badge').textContent = Object.keys(techniques).length + ' unique';
    $('last-update').textContent = 'Updated ' + new Date().toLocaleTimeString();
}

function computeHistoricalEntropy(history) {
    const results = [];
    for (const frame of history) {
        const m = frame.metrics || {};
        const grades = m.grades || {};
        // We can compute grade entropy from the frame's grade data
        const gradeCounts = ['S','A','B','C','D','F'].map(g => grades[g] || 0);
        const total = gradeCounts.reduce((s, c) => s + c, 0);
        const gradeEntropy = total > 0 ? shannonEntropy(gradeCounts) : 0;
        // Approximate score entropy from avg (less precise but we don't have raw scores per frame)
        // Use grade distribution as proxy
        results.push({
            frame: frame.frame,
            entropy: gradeEntropy,
            avgScore: m.avg_score || 0,
            totalApps: m.total_apps || 0,
            grades: grades
        });
    }
    return results;
}

// â”€â”€ Rendering â”€â”€
function setStatus(elId, status) {
    const el = $(elId);
    el.className = 'big-metric ' + status;
}

function setDelta(elId, current, prev, suffix, inverted) {
    const el = $(elId);
    if (prev === null) { el.textContent = ''; return; }
    const diff = current - prev;
    if (Math.abs(diff) < 0.0001) {
        el.className = 'delta delta-flat';
        el.textContent = 'â†’ no change';
    } else {
        const better = inverted ? diff < 0 : diff > 0;
        el.className = 'delta ' + (better ? 'delta-up' : 'delta-down');
        el.textContent = (diff > 0 ? 'â†‘ +' : 'â†“ ') + diff.toFixed(4) + suffix;
    }
}

function renderScoreDist(buckets, total) {
    const container = $('score-dist');
    const allBuckets = [30,40,50,60,70,80,90,100];
    const maxCount = Math.max(...allBuckets.map(b => buckets[b] || 0), 1);
    let html = '';
    for (const b of allBuckets) {
        const count = buckets[b] || 0;
        const pct = (count / maxCount * 100).toFixed(0);
        const hue = b < 40 ? 0 : b < 60 ? 30 : b < 80 ? 120 : 45;
        const sat = 60;
        const light = 40 + (b / 100) * 15;
        html += `<div class="dist-bar">
            <div class="bar-count">${count}</div>
            <div class="bar" style="height:${pct}%;background:hsla(${hue},${sat}%,${light}%,0.6)"></div>
            <div class="bar-label">${b}s</div>
        </div>`;
    }
    container.innerHTML = html;
}

function renderCatBalance(cats, manifestCats) {
    const container = $('cat-balance');
    const maxCount = Math.max(...Object.values(cats), 1);
    const sorted = Object.entries(cats).sort((a, b) => b[1] - a[1]);
    let html = '';
    for (const [cat, count] of sorted) {
        const color = CAT_COLORS[cat] || '#666';
        const pct = (count / maxCount * 100).toFixed(0);
        const name = cat.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        html += `<div class="gini-row">
            <span class="cat-name" title="${name}">${name.substring(0,10)}</span>
            <div class="gini-track"><div class="gini-fill" style="width:${pct}%;background:${color}"></div></div>
            <span class="gini-count">${count}</span>
        </div>`;
    }
    container.innerHTML = html;
}

function renderGradeDist(grades, total) {
    const container = $('grade-dist');
    const order = ['S','A','B','C','D','F'];
    const maxG = Math.max(...order.map(g => grades[g] || 0), 1);
    let html = '';
    for (const g of order) {
        const count = grades[g] || 0;
        const pct = (count / maxG * 100).toFixed(0);
        html += `<div class="dist-bar">
            <div class="bar-count">${count}</div>
            <div class="bar" style="height:${pct}%;background:${GRADE_COLORS[g]}80"></div>
            <div class="bar-label">${g}</div>
        </div>`;
    }
    container.innerHTML = html;
}

function renderTechCloud(techniques) {
    const container = $('tech-cloud');
    const sorted = Object.entries(techniques)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 50);
    const maxC = sorted[0] ? sorted[0][1] : 1;
    let html = '';
    for (const [tech, count] of sorted) {
        const intensity = Math.min(1, count / maxC);
        const hue = 180 + intensity * 120;
        const alpha = 0.3 + intensity * 0.7;
        html += `<span class="tech-tag" style="color:hsla(${hue},60%,65%,${alpha});border-color:hsla(${hue},40%,40%,${alpha * 0.3})" title="${count} apps">${tech}</span>`;
    }
    container.innerHTML = html;
}

function renderBreakdown(entropy, maxEntropy, gini, simpson, gradeEntropy) {
    const container = $('entropy-breakdown');
    const items = [
        { label: 'Score Entropy', val: entropy.toFixed(3) + ' / ' + maxEntropy.toFixed(2), pct: (entropy / maxEntropy * 100).toFixed(0) },
        { label: 'Grade Entropy', val: gradeEntropy.toFixed(3) + ' / 2.585', pct: (gradeEntropy / 2.585 * 100).toFixed(0) },
        { label: 'Cat Balance', val: (1 - gini).toFixed(3) + ' / 1.000', pct: ((1 - gini) * 100).toFixed(0) },
        { label: 'Tech Diversity', val: simpson.toFixed(3) + ' / 1.000', pct: (simpson * 100).toFixed(0) },
    ];
    // Composite
    const composite = (entropy / maxEntropy * 0.3 + (1 - gini) * 0.3 + simpson * 0.2 + gradeEntropy / 2.585 * 0.2);
    items.push({ label: 'Composite Health', val: (composite * 100).toFixed(1) + '%', pct: (composite * 100).toFixed(0) });

    let html = '';
    for (const item of items) {
        const color = item.pct > 75 ? 'var(--green)' : item.pct > 50 ? 'var(--amber)' : 'var(--red)';
        html += `<div style="display:flex;justify-content:space-between;align-items:center">
            <span style="color:var(--dim)">${item.label}</span>
            <span style="color:${color}">${item.val} (${item.pct}%)</span>
        </div>`;
    }
    container.innerHTML = html;
}

function renderEntropyTimeline(data) {
    const c = $('entropy-timeline');
    const ctx = c.getContext('2d');
    const rect = c.parentElement.getBoundingClientRect();
    c.width = rect.width; c.height = 80;
    ctx.clearRect(0, 0, c.width, c.height);
    if (data.length < 2) return;

    const entropies = data.map(d => d.entropy);
    const mn = Math.min(...entropies) - 0.1;
    const mx = Math.max(...entropies) + 0.1;

    // Area fill
    ctx.beginPath();
    for (let i = 0; i < data.length; i++) {
        const x = (i / (data.length - 1)) * c.width;
        const y = c.height - ((entropies[i] - mn) / (mx - mn)) * c.height * 0.85 - 5;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.lineTo(c.width, c.height); ctx.lineTo(0, c.height);
    ctx.fillStyle = 'rgba(124,77,255,0.06)'; ctx.fill();

    // Line
    ctx.beginPath(); ctx.strokeStyle = '#7c4dff'; ctx.lineWidth = 1.5;
    for (let i = 0; i < data.length; i++) {
        const x = (i / (data.length - 1)) * c.width;
        const y = c.height - ((entropies[i] - mn) / (mx - mn)) * c.height * 0.85 - 5;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();
}

function renderHistoryChart(data) {
    const c = $('history-chart');
    const ctx = c.getContext('2d');
    const rect = c.parentElement.getBoundingClientRect();
    c.width = rect.width; c.height = 160;
    ctx.clearRect(0, 0, c.width, c.height);
    if (data.length < 2) {
        ctx.fillStyle = '#333'; ctx.font = '12px monospace'; ctx.textAlign = 'center';
        ctx.fillText('Insufficient frame history for trend analysis', c.width/2, 80);
        return;
    }

    const pad = { l: 44, r: 16, t: 10, b: 24 };
    const w = c.width - pad.l - pad.r;
    const h = c.height - pad.t - pad.b;

    const entropies = data.map(d => d.entropy);
    const avgScores = data.map(d => d.avgScore);
    const appCounts = data.map(d => d.totalApps);

    const eMin = Math.min(...entropies) - 0.2;
    const eMax = Math.max(...entropies) + 0.2;
    const sMin = Math.min(...avgScores) - 2;
    const sMax = Math.max(...avgScores) + 2;

    // Grid
    ctx.strokeStyle = 'rgba(255,255,255,0.03)'; ctx.lineWidth = 0.5;
    for (let i = 0; i <= 4; i++) {
        const y = pad.t + (i / 4) * h;
        ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l + w, y); ctx.stroke();
    }

    // Y-axis labels
    ctx.fillStyle = '#444'; ctx.font = '9px monospace'; ctx.textAlign = 'right';
    for (let i = 0; i <= 4; i++) {
        const val = eMax - (i / 4) * (eMax - eMin);
        ctx.fillText(val.toFixed(1), pad.l - 4, pad.t + (i / 4) * h + 3);
    }

    // App count area
    const cMax = Math.max(...appCounts);
    ctx.beginPath();
    for (let i = 0; i < data.length; i++) {
        const x = pad.l + (i / (data.length - 1)) * w;
        const y = pad.t + h - (appCounts[i] / cMax) * h * 0.4;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.lineTo(pad.l + w, pad.t + h); ctx.lineTo(pad.l, pad.t + h);
    ctx.fillStyle = 'rgba(0,188,212,0.04)'; ctx.fill();

    // Avg score line
    ctx.beginPath(); ctx.strokeStyle = 'rgba(0,230,118,0.4)'; ctx.lineWidth = 1;
    for (let i = 0; i < data.length; i++) {
        const x = pad.l + (i / (data.length - 1)) * w;
        const y = pad.t + h - ((avgScores[i] - sMin) / (sMax - sMin)) * h;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();

    // Entropy line
    ctx.beginPath(); ctx.strokeStyle = '#ff1744'; ctx.lineWidth = 2;
    for (let i = 0; i < data.length; i++) {
        const x = pad.l + (i / (data.length - 1)) * w;
        const y = pad.t + ((eMax - entropies[i]) / (eMax - eMin)) * h;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();

    // Regression extrapolation line
    if (data.length >= 3) {
        const frames = data.map(d => d.frame);
        const reg = linearRegression(frames, entropies);
        const lastFrame = frames[frames.length - 1];
        const futureFrame = lastFrame + 20;
        const x1 = pad.l;
        const y1 = pad.t + ((eMax - (reg.slope * frames[0] + reg.intercept)) / (eMax - eMin)) * h;
        const x2 = pad.l + w + 10;
        const y2val = reg.slope * futureFrame + reg.intercept;
        const y2 = pad.t + ((eMax - y2val) / (eMax - eMin)) * h;
        ctx.beginPath(); ctx.strokeStyle = 'rgba(255,23,68,0.25)'; ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
        ctx.setLineDash([]);
    }

    // Threshold line
    const threshY = pad.t + ((eMax - alarmThreshold) / (eMax - eMin)) * h;
    if (threshY > pad.t && threshY < pad.t + h) {
        ctx.beginPath(); ctx.strokeStyle = 'rgba(255,23,68,0.3)'; ctx.lineWidth = 1;
        ctx.setLineDash([2, 3]);
        ctx.moveTo(pad.l, threshY); ctx.lineTo(pad.l + w, threshY); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = 'rgba(255,23,68,0.4)'; ctx.font = '8px monospace'; ctx.textAlign = 'left';
        ctx.fillText('ALARM', pad.l + 4, threshY - 3);
    }

    // Dots + frame labels
    for (let i = 0; i < data.length; i++) {
        const x = pad.l + (i / (data.length - 1)) * w;
        const y = pad.t + ((eMax - entropies[i]) / (eMax - eMin)) * h;
        ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fillStyle = '#ff1744'; ctx.fill();
        if (data.length <= 15) {
            ctx.fillStyle = '#555'; ctx.font = '8px monospace'; ctx.textAlign = 'center';
            ctx.fillText('F' + data[i].frame, x, pad.t + h + 14);
        }
    }

    // Legend
    ctx.font = '8px monospace'; ctx.textAlign = 'right';
    ctx.fillStyle = '#ff1744'; ctx.fillText('â— entropy', pad.l + w, pad.t + 10);
    ctx.fillStyle = 'rgba(0,230,118,0.6)'; ctx.fillText('â— avg score', pad.l + w, pad.t + 20);
    ctx.fillStyle = 'rgba(0,188,212,0.3)'; ctx.fillText('â–  app count', pad.l + w, pad.t + 30);
}

// â”€â”€ Doomsday Clock â”€â”€
function computeDoomsday(data, currentEntropy) {
    const clockCanvas = $('clock-canvas');
    const ctx = clockCanvas.getContext('2d');
    const s = 160;
    ctx.clearRect(0, 0, s, s);

    let framesLeft = Infinity;
    let prophecy = 'The ecosystem breathes. Diversity holds.';

    if (data.length >= 3) {
        const frames = data.map(d => d.frame);
        const entropies = data.map(d => d.entropy);
        const reg = linearRegression(frames, entropies);

        if (reg.slope < 0) {
            // Entropy is decreasing â€” heat death approaches
            const lastFrame = frames[frames.length - 1];
            // When does entropy hit the alarm threshold?
            const deathFrame = (alarmThreshold - reg.intercept) / reg.slope;
            framesLeft = Math.max(0, Math.ceil(deathFrame - lastFrame));

            if (framesLeft < 5) {
                prophecy = 'The end is near. Scores converge. Creativity crystallizes into sameness. The zoo becomes a museum.';
            } else if (framesLeft < 20) {
                prophecy = 'The gradient flattens. Each molt makes the next less surprising. Diversity is a memory being overwritten.';
            } else if (framesLeft < 50) {
                prophecy = 'A slow settling. The ecosystem drifts toward consensus. The outliers grow quieter.';
            } else {
                prophecy = 'Entropy declines, but slowly. The canary still sings â€” for now.';
            }
        } else if (reg.slope > 0) {
            framesLeft = Infinity;
            prophecy = 'Entropy is RISING. The ecosystem grows more diverse with each frame. The zoo thrives in chaos.';
        } else {
            prophecy = 'Entropy is stable. The ecosystem has reached equilibrium. Neither dying nor evolving.';
        }
    }

    $('frames-left').textContent = framesLeft === Infinity ? 'âˆž' : framesLeft;
    $('frames-left').style.color = framesLeft === Infinity ? 'var(--green)' : framesLeft > 20 ? 'var(--amber)' : 'var(--red)';
    $('prophecy').textContent = prophecy;

    // Draw clock face
    const cx = s / 2, cy = s / 2, r = 68;
    // Outer ring
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 2; ctx.stroke();
    // Tick marks
    for (let i = 0; i < 60; i++) {
        const angle = (i / 60) * Math.PI * 2 - Math.PI / 2;
        const inner = i % 5 === 0 ? r - 8 : r - 4;
        ctx.beginPath();
        ctx.moveTo(cx + Math.cos(angle) * inner, cy + Math.sin(angle) * inner);
        ctx.lineTo(cx + Math.cos(angle) * r, cy + Math.sin(angle) * r);
        ctx.strokeStyle = i % 5 === 0 ? 'rgba(255,255,255,0.15)' : 'rgba(255,255,255,0.05)';
        ctx.lineWidth = i % 5 === 0 ? 1.5 : 0.5;
        ctx.stroke();
    }

    // "Minute hand" â€” fraction toward heat death
    const frac = framesLeft === Infinity ? 0 : Math.min(1, 1 - framesLeft / 100);
    const handAngle = frac * Math.PI * 2 - Math.PI / 2;
    const handLen = r - 14;
    const handColor = frac > 0.8 ? '#ff1744' : frac > 0.4 ? '#ff9100' : '#00e676';
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(handAngle) * handLen, cy + Math.sin(handAngle) * handLen);
    ctx.strokeStyle = handColor; ctx.lineWidth = 2; ctx.stroke();
    // Center dot
    ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI * 2);
    ctx.fillStyle = handColor; ctx.fill();

    // Danger arc
    if (frac > 0) {
        ctx.beginPath();
        ctx.arc(cx, cy, r + 6, -Math.PI / 2, handAngle);
        ctx.strokeStyle = handColor + '40'; ctx.lineWidth = 4; ctx.stroke();
    }
}

// â”€â”€ Alarm System â”€â”€
function checkAlarm(entropy) {
    const banner = $('alarm-banner');
    const dot = $('status-dot');
    if (entropy < alarmThreshold) {
        banner.classList.add('active');
        dot.className = 'pulse-dot critical';
        addLog('crit', `ALARM: Entropy ${entropy.toFixed(4)} below threshold ${alarmThreshold.toFixed(2)}`);
    } else if (entropy < alarmThreshold + 0.3) {
        banner.classList.remove('active');
        dot.className = 'pulse-dot warning';
        addLog('warn', `Warning: Entropy ${entropy.toFixed(4)} approaching threshold`);
    } else {
        banner.classList.remove('active');
        dot.className = 'pulse-dot';
    }
}

$('thresh-slider').oninput = function() {
    alarmThreshold = parseInt(this.value) / 100;
    $('thresh-val').textContent = alarmThreshold.toFixed(2);
    // Re-render history chart with new threshold line
    if (historyData.length) renderHistoryChart(historyData);
};

// â”€â”€ Log â”€â”€
function addLog(level, msg) {
    const now = new Date();
    const time = now.toLocaleTimeString().substring(0, 8);
    logEntries.unshift({ time, level, msg });
    if (logEntries.length > 30) logEntries.pop();
    renderLog();
}

function renderLog() {
    const feed = $('log-feed');
    feed.innerHTML = logEntries.map(e =>
        `<div class="log-entry log-${e.level === 'crit' ? 'crit' : e.level === 'warn' ? 'warn' : 'ok'}">
            <span class="log-time">${e.time}</span>
            <span class="log-msg">${e.msg}</span>
        </div>`
    ).join('');
}

// â”€â”€ Refresh Loop â”€â”€
function startRefreshLoop() {
    setInterval(() => {
        refreshCountdown--;
        $('refresh-timer').textContent = `Next scan: ${refreshCountdown}s`;
        if (refreshCountdown <= 0) {
            refreshCountdown = 5;
            scan();
        }
    }, 1000);
}

// â”€â”€ Init â”€â”€
addLog('ok', 'Entropy Monitor initializing...');
scan().then(() => {
    addLog('ok', 'First scan complete. Monitoring active.');
    startRefreshLoop();
});

// Resize handler
window.addEventListener('resize', () => {
    if (historyData.length) {
        renderHistoryChart(historyData);
        renderEntropyTimeline(historyData);
    }
});

})();
</script>
</body>
</html>