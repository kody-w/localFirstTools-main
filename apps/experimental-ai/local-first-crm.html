<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local-First CRM</title>
    <meta name="description" content="Privacy-first CRM with Salesforce and Dynamics 365 integration. Import/export data seamlessly between platforms. All data stored locally.">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="color-scheme" content="dark">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 220px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 1.4rem;
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.4);
            margin-top: 3px;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .nav-item.active {
            background: rgba(0,212,255,0.1);
            border-left-color: #00d4ff;
            color: #00d4ff;
        }

        .nav-item .count {
            margin-left: auto;
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .nav-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 15px 20px;
        }

        .nav-section-label {
            padding: 8px 20px;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h2 {
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .search-box {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px 15px;
            color: white;
            width: 250px;
        }

        .search-box::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,212,255,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-salesforce {
            background: linear-gradient(135deg, #00a1e0, #1798c1);
            color: white;
        }

        .btn-dynamics {
            background: linear-gradient(135deg, #2b579a, #217346);
            color: white;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
        }

        /* List Views */
        .list-view {
            display: none;
        }

        .list-view.active {
            display: block;
        }

        .list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .list-table th {
            text-align: left;
            padding: 12px 15px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-weight: 500;
            color: rgba(255,255,255,0.7);
        }

        .list-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .list-table tr:hover td {
            background: rgba(255,255,255,0.03);
        }

        .contact-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
        }

        .tag.hot { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .tag.warm { background: rgba(255,193,7,0.2); color: #ffc107; }
        .tag.cold { background: rgba(108,117,125,0.2); color: #6c757d; }

        /* Pipeline */
        .pipeline-board {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .pipeline-stage {
            min-width: 280px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 15px;
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stage-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stage-count {
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .stage-value {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
        }

        .deal-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .deal-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-2px);
        }

        .deal-name { font-weight: 500; margin-bottom: 5px; }
        .deal-company { font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 8px; }
        .deal-value { font-size: 1.1rem; font-weight: 600; color: #00d4ff; }
        .deal-meta { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.8rem; color: rgba(255,255,255,0.5); }

        /* Activity */
        .activity-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .activity-icon.call { background: rgba(0,212,255,0.2); }
        .activity-icon.email { background: rgba(124,58,237,0.2); }
        .activity-icon.meeting { background: rgba(16,185,129,0.2); }
        .activity-icon.note { background: rgba(255,193,7,0.2); }

        .activity-content { flex: 1; }
        .activity-title { font-weight: 500; margin-bottom: 3px; }
        .activity-desc { font-size: 0.9rem; color: rgba(255,255,255,0.6); }
        .activity-time { font-size: 0.8rem; color: rgba(255,255,255,0.4); }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-label { font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 8px; }
        .stat-value { font-size: 2rem; font-weight: 600; }
        .stat-value.revenue { color: #10b981; }

        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-title { margin-bottom: 15px; font-weight: 500; }

        .pipeline-chart {
            display: flex;
            height: 30px;
            border-radius: 6px;
            overflow: hidden;
        }

        .pipeline-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
            transition: all 0.3s;
        }

        .pipeline-segment:hover { filter: brightness(1.2); }

        /* Integration View */
        .integration-view {
            display: none;
        }

        .integration-view.active {
            display: block;
        }

        .integration-header {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .integration-card {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .integration-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .integration-logo {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .salesforce-logo { background: linear-gradient(135deg, #00a1e0, #1798c1); }
        .dynamics-logo { background: linear-gradient(135deg, #2b579a, #217346); }

        .integration-card h3 { font-size: 1.2rem; }
        .integration-card p { font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 5px; }

        .integration-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .mapping-section {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .mapping-section h4 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .mapping-table {
            width: 100%;
            border-collapse: collapse;
        }

        .mapping-table th {
            text-align: left;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            font-size: 0.85rem;
        }

        .mapping-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
        }

        .mapping-table .field-local { color: #00d4ff; }
        .mapping-table .field-sf { color: #00a1e0; }
        .mapping-table .field-d365 { color: #217346; }

        .mapping-arrow {
            text-align: center;
            color: rgba(255,255,255,0.4);
        }

        .entity-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .entity-tab {
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .entity-tab:hover { background: rgba(255,255,255,0.15); }
        .entity-tab.active { background: rgba(0,212,255,0.2); color: #00d4ff; }

        .import-preview {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .import-preview pre {
            font-family: 'Monaco', monospace;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }

        .import-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .import-stat {
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .import-stat-value { font-size: 1.5rem; font-weight: 600; color: #00d4ff; }
        .import-stat-label { font-size: 0.8rem; color: rgba(255,255,255,0.5); }

        /* Settings */
        .settings-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h4 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal h3 { margin-bottom: 20px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: rgba(255,255,255,0.7); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        .btn-delete { background: rgba(255,107,107,0.2); color: #ff6b6b; margin-right: auto; }
        .btn-delete:hover { background: rgba(255,107,107,0.3); }

        .empty-state { text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.5); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 15px; }

        .clickable { cursor: pointer; }
        .clickable:hover { color: #00d4ff; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .sync-status.synced { background: rgba(16,185,129,0.2); color: #10b981; }
        .sync-status.pending { background: rgba(245,158,11,0.2); color: #f59e0b; }

        .file-drop-zone {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.2s;
        }

        .file-drop-zone:hover, .file-drop-zone.dragover {
            border-color: #00d4ff;
            background: rgba(0,212,255,0.05);
        }

        .file-drop-zone p { color: rgba(255,255,255,0.5); margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="logo">
                <h1>Local CRM</h1>
                <div class="logo-subtitle">Salesforce + Dynamics 365</div>
            </div>
            <div class="nav-item active" data-view="dashboard">
                <span>üìä</span> Dashboard
            </div>
            <div class="nav-item" data-view="contacts">
                <span>üë§</span> Contacts
                <span class="count" id="contactCount">0</span>
            </div>
            <div class="nav-item" data-view="companies">
                <span>üè¢</span> Companies
                <span class="count" id="companyCount">0</span>
            </div>
            <div class="nav-item" data-view="deals">
                <span>üí∞</span> Deals
                <span class="count" id="dealCount">0</span>
            </div>
            <div class="nav-item" data-view="activities">
                <span>üìÖ</span> Activities
                <span class="count" id="activityCount">0</span>
            </div>
            <div class="nav-divider"></div>
            <div class="nav-section-label">Integrations</div>
            <div class="nav-item" data-view="integrations">
                <span>üîÑ</span> Sync & Export
            </div>
            <div class="nav-item" data-view="settings" style="margin-top: auto;">
                <span>‚öôÔ∏è</span> Settings
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h2 id="pageTitle">Dashboard</h2>
                <div class="header-actions">
                    <input type="text" class="search-box" placeholder="Search..." id="searchBox">
                    <button class="btn btn-primary" id="addBtn">+ Add New</button>
                </div>
            </div>

            <div class="content-area">
                <!-- Dashboard View -->
                <div class="list-view active" id="dashboardView">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Contacts</div>
                            <div class="stat-value" id="statContacts">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Deals</div>
                            <div class="stat-value" id="statDeals">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Pipeline Value</div>
                            <div class="stat-value revenue" id="statPipeline">$0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Won This Month</div>
                            <div class="stat-value revenue" id="statWon">$0</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Pipeline Overview</div>
                        <div class="pipeline-chart" id="pipelineChart"></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Recent Activities</div>
                        <div id="recentActivities"></div>
                    </div>
                </div>

                <!-- Contacts View -->
                <div class="list-view" id="contactsView">
                    <table class="list-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Company</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="contactsList"></tbody>
                    </table>
                </div>

                <!-- Companies View -->
                <div class="list-view" id="companiesView">
                    <table class="list-table">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Industry</th>
                                <th>Contacts</th>
                                <th>Deals</th>
                                <th>Total Value</th>
                            </tr>
                        </thead>
                        <tbody id="companiesList"></tbody>
                    </table>
                </div>

                <!-- Deals View -->
                <div class="list-view" id="dealsView">
                    <div class="pipeline-board" id="pipelineBoard"></div>
                </div>

                <!-- Activities View -->
                <div class="list-view" id="activitiesView">
                    <div id="activitiesList"></div>
                </div>

                <!-- Integrations View -->
                <div class="integration-view list-view" id="integrationsView">
                    <div class="integration-header">
                        <div class="integration-card">
                            <div class="integration-card-header">
                                <div class="integration-logo salesforce-logo">SF</div>
                                <div>
                                    <h3>Salesforce</h3>
                                    <p>Account, Contact, Opportunity, Task</p>
                                </div>
                            </div>
                            <div class="integration-actions">
                                <button class="btn btn-salesforce" onclick="openImportModal('salesforce')">üì• Import</button>
                                <button class="btn btn-salesforce" onclick="exportToSalesforce()">üì§ Export</button>
                            </div>
                        </div>
                        <div class="integration-card">
                            <div class="integration-card-header">
                                <div class="integration-logo dynamics-logo">D365</div>
                                <div>
                                    <h3>Dynamics 365</h3>
                                    <p>Account, Contact, Opportunity, Activity</p>
                                </div>
                            </div>
                            <div class="integration-actions">
                                <button class="btn btn-dynamics" onclick="openImportModal('dynamics')">üì• Import</button>
                                <button class="btn btn-dynamics" onclick="exportToDynamics()">üì§ Export</button>
                            </div>
                        </div>
                    </div>

                    <div class="mapping-section">
                        <h4>üìã Schema Field Mappings</h4>
                        <div class="entity-tabs">
                            <div class="entity-tab active" data-entity="contacts">Contacts</div>
                            <div class="entity-tab" data-entity="companies">Companies</div>
                            <div class="entity-tab" data-entity="deals">Deals</div>
                            <div class="entity-tab" data-entity="activities">Activities</div>
                        </div>

                        <div class="tab-content active" id="mapping-contacts">
                            <table class="mapping-table">
                                <thead>
                                    <tr>
                                        <th style="width:30%">Local CRM</th>
                                        <th style="width:5%"></th>
                                        <th style="width:30%">Salesforce (Contact)</th>
                                        <th style="width:5%"></th>
                                        <th style="width:30%">Dynamics 365 (contact)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td class="field-local">firstName</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">FirstName</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">firstname</td></tr>
                                    <tr><td class="field-local">lastName</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">LastName</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">lastname</td></tr>
                                    <tr><td class="field-local">email</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Email</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">emailaddress1</td></tr>
                                    <tr><td class="field-local">phone</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Phone</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">telephone1</td></tr>
                                    <tr><td class="field-local">companyId</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">AccountId</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">parentcustomerid</td></tr>
                                    <tr><td class="field-local">notes</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Description</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">description</td></tr>
                                    <tr><td class="field-local">status</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">LeadSource</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">customertypecode</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-content" id="mapping-companies">
                            <table class="mapping-table">
                                <thead>
                                    <tr>
                                        <th style="width:30%">Local CRM</th>
                                        <th style="width:5%"></th>
                                        <th style="width:30%">Salesforce (Account)</th>
                                        <th style="width:5%"></th>
                                        <th style="width:30%">Dynamics 365 (account)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td class="field-local">name</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Name</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">name</td></tr>
                                    <tr><td class="field-local">industry</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Industry</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">industrycode</td></tr>
                                    <tr><td class="field-local">website</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Website</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">websiteurl</td></tr>
                                    <tr><td class="field-local">notes</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Description</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">description</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-content" id="mapping-deals">
                            <table class="mapping-table">
                                <thead>
                                    <tr>
                                        <th style="width:30%">Local CRM</th>
                                        <th style="width:5%"></th>
                                        <th style="width:30%">Salesforce (Opportunity)</th>
                                        <th style="width:5%"></th>
                                        <th style="width:30%">Dynamics 365 (opportunity)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td class="field-local">name</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Name</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">name</td></tr>
                                    <tr><td class="field-local">value</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Amount</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">estimatedvalue</td></tr>
                                    <tr><td class="field-local">stage</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">StageName</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">stepname</td></tr>
                                    <tr><td class="field-local">companyId</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">AccountId</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">parentaccountid</td></tr>
                                    <tr><td class="field-local">contactId</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">ContactId</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">parentcontactid</td></tr>
                                    <tr><td class="field-local">closeDate</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">CloseDate</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">estimatedclosedate</td></tr>
                                    <tr><td class="field-local">notes</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Description</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">description</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-content" id="mapping-activities">
                            <table class="mapping-table">
                                <thead>
                                    <tr>
                                        <th style="width:30%">Local CRM</th>
                                        <th style="width:5%"></th>
                                        <th style="width:30%">Salesforce (Task)</th>
                                        <th style="width:5%"></th>
                                        <th style="width:30%">Dynamics 365 (activity)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td class="field-local">title</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Subject</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">subject</td></tr>
                                    <tr><td class="field-local">type</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Type</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">activitytypecode</td></tr>
                                    <tr><td class="field-local">contactId</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">WhoId</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">regardingobjectid</td></tr>
                                    <tr><td class="field-local">dealId</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">WhatId</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">regardingobjectid</td></tr>
                                    <tr><td class="field-local">description</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Description</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">description</td></tr>
                                    <tr><td class="field-local">createdAt</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">ActivityDate</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">actualstart</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mapping-section">
                        <h4>üîÑ Stage Mappings</h4>
                        <table class="mapping-table">
                            <thead>
                                <tr>
                                    <th>Local CRM</th>
                                    <th></th>
                                    <th>Salesforce</th>
                                    <th></th>
                                    <th>Dynamics 365</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td class="field-local">lead</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Prospecting</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">1 - Qualify</td></tr>
                                <tr><td class="field-local">qualified</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Qualification</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">2 - Develop</td></tr>
                                <tr><td class="field-local">proposal</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Proposal/Price Quote</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">3 - Propose</td></tr>
                                <tr><td class="field-local">negotiation</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Negotiation/Review</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">4 - Close</td></tr>
                                <tr><td class="field-local">won</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Closed Won</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">Won</td></tr>
                                <tr><td class="field-local">lost</td><td class="mapping-arrow">‚Üî</td><td class="field-sf">Closed Lost</td><td class="mapping-arrow">‚Üî</td><td class="field-d365">Lost</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings View -->
                <div class="list-view" id="settingsView">
                    <div class="settings-section">
                        <h4>Data Management</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="exportData()">üì§ Export All (JSON)</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì• Import (JSON)</button>
                            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                            <button class="btn btn-delete" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Pipeline Stages</h4>
                        <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                            Lead ‚Üí Qualified ‚Üí Proposal ‚Üí Negotiation ‚Üí Won/Lost
                        </p>
                    </div>
                    <div class="settings-section">
                        <h4>About</h4>
                        <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                            Local-First CRM with Salesforce and Dynamics 365 integration.<br>
                            All data stored in browser localStorage. Export to sync with enterprise CRMs.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal-overlay" id="contactModal">
        <div class="modal">
            <h3 id="contactModalTitle">Add Contact</h3>
            <form id="contactForm">
                <input type="hidden" id="contactId">
                <div class="form-row">
                    <div class="form-group"><label>First Name *</label><input type="text" id="contactFirst" required></div>
                    <div class="form-group"><label>Last Name *</label><input type="text" id="contactLast" required></div>
                </div>
                <div class="form-group"><label>Email</label><input type="email" id="contactEmail"></div>
                <div class="form-group"><label>Phone</label><input type="tel" id="contactPhone"></div>
                <div class="form-group"><label>Company</label><select id="contactCompany"><option value="">Select company...</option></select></div>
                <div class="form-group"><label>Status</label><select id="contactStatus"><option value="hot">üî• Hot</option><option value="warm">‚òÄÔ∏è Warm</option><option value="cold">‚ùÑÔ∏è Cold</option></select></div>
                <div class="form-group"><label>Notes</label><textarea id="contactNotes" rows="3"></textarea></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-delete" id="deleteContactBtn" style="display: none;" onclick="deleteContact()">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('contactModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Company Modal -->
    <div class="modal-overlay" id="companyModal">
        <div class="modal">
            <h3 id="companyModalTitle">Add Company</h3>
            <form id="companyForm">
                <input type="hidden" id="companyId">
                <div class="form-group"><label>Company Name *</label><input type="text" id="companyName" required></div>
                <div class="form-group"><label>Industry</label><select id="companyIndustry"><option value="">Select...</option><option value="Technology">Technology</option><option value="Finance">Finance</option><option value="Healthcare">Healthcare</option><option value="Retail">Retail</option><option value="Manufacturing">Manufacturing</option><option value="Services">Services</option><option value="Other">Other</option></select></div>
                <div class="form-group"><label>Website</label><input type="url" id="companyWebsite"></div>
                <div class="form-group"><label>Notes</label><textarea id="companyNotes" rows="3"></textarea></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-delete" id="deleteCompanyBtn" style="display: none;" onclick="deleteCompany()">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('companyModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Deal Modal -->
    <div class="modal-overlay" id="dealModal">
        <div class="modal">
            <h3 id="dealModalTitle">Add Deal</h3>
            <form id="dealForm">
                <input type="hidden" id="dealId">
                <div class="form-group"><label>Deal Name *</label><input type="text" id="dealName" required></div>
                <div class="form-row">
                    <div class="form-group"><label>Value ($)</label><input type="number" id="dealValue" min="0" step="0.01"></div>
                    <div class="form-group"><label>Stage</label><select id="dealStage"><option value="lead">Lead</option><option value="qualified">Qualified</option><option value="proposal">Proposal</option><option value="negotiation">Negotiation</option><option value="won">Won</option><option value="lost">Lost</option></select></div>
                </div>
                <div class="form-group"><label>Company</label><select id="dealCompany"><option value="">Select...</option></select></div>
                <div class="form-group"><label>Contact</label><select id="dealContact"><option value="">Select...</option></select></div>
                <div class="form-group"><label>Expected Close Date</label><input type="date" id="dealCloseDate"></div>
                <div class="form-group"><label>Notes</label><textarea id="dealNotes" rows="3"></textarea></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-delete" id="deleteDealBtn" style="display: none;" onclick="deleteDeal()">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('dealModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Activity Modal -->
    <div class="modal-overlay" id="activityModal">
        <div class="modal">
            <h3 id="activityModalTitle">Log Activity</h3>
            <form id="activityForm">
                <input type="hidden" id="activityId">
                <div class="form-group"><label>Type</label><select id="activityType"><option value="call">üìû Call</option><option value="email">‚úâÔ∏è Email</option><option value="meeting">ü§ù Meeting</option><option value="note">üìù Note</option></select></div>
                <div class="form-group"><label>Title *</label><input type="text" id="activityTitle" required></div>
                <div class="form-group"><label>Contact</label><select id="activityContact"><option value="">Select...</option></select></div>
                <div class="form-group"><label>Deal</label><select id="activityDeal"><option value="">Select...</option></select></div>
                <div class="form-group"><label>Description</label><textarea id="activityDesc" rows="4"></textarea></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-delete" id="deleteActivityBtn" style="display: none;" onclick="deleteActivity()">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('activityModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal" style="max-width: 700px;">
            <h3 id="importModalTitle">Import from Salesforce</h3>
            <div class="file-drop-zone" id="fileDropZone">
                <p>Drag and drop your export file here, or click to browse</p>
                <button class="btn btn-secondary" onclick="document.getElementById('platformImportFile').click()">Choose File</button>
                <input type="file" id="platformImportFile" accept=".json,.csv" style="display: none;" onchange="handlePlatformImport(event)">
            </div>
            <div id="importPreviewArea" style="display: none;">
                <div class="import-stats" id="importStats"></div>
                <div class="import-preview"><pre id="importPreview"></pre></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmImportBtn" style="display: none;" onclick="confirmImport()">Import Data</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DATA STORE
        // ============================================
        let data = { contacts: [], companies: [], deals: [], activities: [] };
        let currentView = 'dashboard';
        let pendingImport = null;
        let importPlatform = null;

        const STAGES = ['lead', 'qualified', 'proposal', 'negotiation', 'won', 'lost'];
        const STAGE_COLORS = { lead: '#6366f1', qualified: '#8b5cf6', proposal: '#0ea5e9', negotiation: '#f59e0b', won: '#10b981', lost: '#ef4444' };

        // ============================================
        // SCHEMA MAPPINGS
        // ============================================
        const SALESFORCE_SCHEMA = {
            contacts: {
                entity: 'Contact',
                fields: {
                    firstName: 'FirstName', lastName: 'LastName', email: 'Email',
                    phone: 'Phone', companyId: 'AccountId', notes: 'Description', status: 'LeadSource'
                }
            },
            companies: {
                entity: 'Account',
                fields: { name: 'Name', industry: 'Industry', website: 'Website', notes: 'Description' }
            },
            deals: {
                entity: 'Opportunity',
                fields: {
                    name: 'Name', value: 'Amount', stage: 'StageName',
                    companyId: 'AccountId', contactId: 'ContactId', closeDate: 'CloseDate', notes: 'Description'
                }
            },
            activities: {
                entity: 'Task',
                fields: {
                    title: 'Subject', type: 'Type', contactId: 'WhoId',
                    dealId: 'WhatId', description: 'Description', createdAt: 'ActivityDate'
                }
            },
            stageMap: {
                'lead': 'Prospecting', 'qualified': 'Qualification', 'proposal': 'Proposal/Price Quote',
                'negotiation': 'Negotiation/Review', 'won': 'Closed Won', 'lost': 'Closed Lost'
            },
            reverseStageMap: {
                'Prospecting': 'lead', 'Qualification': 'qualified', 'Proposal/Price Quote': 'proposal',
                'Negotiation/Review': 'negotiation', 'Closed Won': 'won', 'Closed Lost': 'lost'
            }
        };

        const DYNAMICS_SCHEMA = {
            contacts: {
                entity: 'contact',
                fields: {
                    firstName: 'firstname', lastName: 'lastname', email: 'emailaddress1',
                    phone: 'telephone1', companyId: 'parentcustomerid', notes: 'description', status: 'customertypecode'
                }
            },
            companies: {
                entity: 'account',
                fields: { name: 'name', industry: 'industrycode', website: 'websiteurl', notes: 'description' }
            },
            deals: {
                entity: 'opportunity',
                fields: {
                    name: 'name', value: 'estimatedvalue', stage: 'stepname',
                    companyId: 'parentaccountid', contactId: 'parentcontactid', closeDate: 'estimatedclosedate', notes: 'description'
                }
            },
            activities: {
                entity: 'activitypointer',
                fields: {
                    title: 'subject', type: 'activitytypecode', contactId: 'regardingobjectid',
                    dealId: 'regardingobjectid', description: 'description', createdAt: 'actualstart'
                }
            },
            stageMap: {
                'lead': '1 - Qualify', 'qualified': '2 - Develop', 'proposal': '3 - Propose',
                'negotiation': '4 - Close', 'won': 'Won', 'lost': 'Lost'
            },
            reverseStageMap: {
                '1 - Qualify': 'lead', '2 - Develop': 'qualified', '3 - Propose': 'proposal',
                '4 - Close': 'negotiation', 'Won': 'won', 'Lost': 'lost'
            }
        };

        // ============================================
        // TRANSFORM FUNCTIONS
        // ============================================
        function transformToSalesforce(localData) {
            const idMap = { companies: {}, contacts: {} };
            const result = { Account: [], Contact: [], Opportunity: [], Task: [] };

            // Companies ‚Üí Accounts
            localData.companies.forEach(c => {
                const sfId = 'SF_' + c.id;
                idMap.companies[c.id] = sfId;
                result.Account.push({
                    Id: sfId, Name: c.name, Industry: c.industry || '',
                    Website: c.website || '', Description: c.notes || '',
                    CreatedDate: c.createdAt, LastModifiedDate: c.updatedAt
                });
            });

            // Contacts
            localData.contacts.forEach(c => {
                const sfId = 'SF_' + c.id;
                idMap.contacts[c.id] = sfId;
                result.Contact.push({
                    Id: sfId, FirstName: c.firstName, LastName: c.lastName,
                    Email: c.email || '', Phone: c.phone || '',
                    AccountId: c.companyId ? idMap.companies[c.companyId] : '',
                    Description: c.notes || '', LeadSource: c.status || 'warm',
                    CreatedDate: c.createdAt, LastModifiedDate: c.updatedAt
                });
            });

            // Deals ‚Üí Opportunities
            localData.deals.forEach(d => {
                result.Opportunity.push({
                    Id: 'SF_' + d.id, Name: d.name, Amount: d.value || 0,
                    StageName: SALESFORCE_SCHEMA.stageMap[d.stage] || 'Prospecting',
                    AccountId: d.companyId ? idMap.companies[d.companyId] : '',
                    ContactId: d.contactId ? idMap.contacts[d.contactId] : '',
                    CloseDate: d.closeDate || new Date().toISOString().split('T')[0],
                    Description: d.notes || '',
                    CreatedDate: d.createdAt, LastModifiedDate: d.updatedAt
                });
            });

            // Activities ‚Üí Tasks
            localData.activities.forEach(a => {
                result.Task.push({
                    Id: 'SF_' + a.id, Subject: a.title, Type: a.type,
                    WhoId: a.contactId ? idMap.contacts[a.contactId] : '',
                    WhatId: a.dealId ? 'SF_' + a.dealId : '',
                    Description: a.description || '', ActivityDate: a.createdAt?.split('T')[0] || '',
                    CreatedDate: a.createdAt
                });
            });

            return result;
        }

        function transformToDynamics(localData) {
            const idMap = { companies: {}, contacts: {} };
            const result = { account: [], contact: [], opportunity: [], activitypointer: [] };

            // Companies ‚Üí Accounts
            localData.companies.forEach(c => {
                const d365Id = c.id;
                idMap.companies[c.id] = d365Id;
                result.account.push({
                    accountid: d365Id, name: c.name,
                    industrycode: mapIndustryToDynamics(c.industry),
                    websiteurl: c.website || '', description: c.notes || '',
                    createdon: c.createdAt, modifiedon: c.updatedAt
                });
            });

            // Contacts
            localData.contacts.forEach(c => {
                const d365Id = c.id;
                idMap.contacts[c.id] = d365Id;
                result.contact.push({
                    contactid: d365Id, firstname: c.firstName, lastname: c.lastName,
                    emailaddress1: c.email || '', telephone1: c.phone || '',
                    parentcustomerid: c.companyId ? idMap.companies[c.companyId] : null,
                    description: c.notes || '',
                    customertypecode: c.status === 'hot' ? 1 : (c.status === 'cold' ? 3 : 2),
                    createdon: c.createdAt, modifiedon: c.updatedAt
                });
            });

            // Deals ‚Üí Opportunities
            localData.deals.forEach(d => {
                result.opportunity.push({
                    opportunityid: d.id, name: d.name, estimatedvalue: d.value || 0,
                    stepname: DYNAMICS_SCHEMA.stageMap[d.stage] || '1 - Qualify',
                    parentaccountid: d.companyId ? idMap.companies[d.companyId] : null,
                    parentcontactid: d.contactId ? idMap.contacts[d.contactId] : null,
                    estimatedclosedate: d.closeDate || null, description: d.notes || '',
                    createdon: d.createdAt, modifiedon: d.updatedAt
                });
            });

            // Activities
            localData.activities.forEach(a => {
                result.activitypointer.push({
                    activityid: a.id, subject: a.title,
                    activitytypecode: mapActivityType(a.type),
                    regardingobjectid: a.contactId || a.dealId || null,
                    description: a.description || '', actualstart: a.createdAt,
                    createdon: a.createdAt
                });
            });

            return result;
        }

        function transformFromSalesforce(sfData) {
            const result = { contacts: [], companies: [], deals: [], activities: [] };
            const idMap = { accounts: {}, contacts: {} };

            // Accounts ‚Üí Companies
            if (sfData.Account) {
                sfData.Account.forEach(a => {
                    const localId = generateId();
                    idMap.accounts[a.Id] = localId;
                    result.companies.push({
                        id: localId, name: a.Name, industry: a.Industry || '',
                        website: a.Website || '', notes: a.Description || '',
                        createdAt: a.CreatedDate || new Date().toISOString(),
                        updatedAt: a.LastModifiedDate || new Date().toISOString()
                    });
                });
            }

            // Contacts
            if (sfData.Contact) {
                sfData.Contact.forEach(c => {
                    const localId = generateId();
                    idMap.contacts[c.Id] = localId;
                    result.contacts.push({
                        id: localId, firstName: c.FirstName || '', lastName: c.LastName || '',
                        email: c.Email || '', phone: c.Phone || '',
                        companyId: c.AccountId ? idMap.accounts[c.AccountId] : '',
                        notes: c.Description || '', status: c.LeadSource || 'warm',
                        createdAt: c.CreatedDate || new Date().toISOString(),
                        updatedAt: c.LastModifiedDate || new Date().toISOString()
                    });
                });
            }

            // Opportunities ‚Üí Deals
            if (sfData.Opportunity) {
                sfData.Opportunity.forEach(o => {
                    result.deals.push({
                        id: generateId(), name: o.Name, value: parseFloat(o.Amount) || 0,
                        stage: SALESFORCE_SCHEMA.reverseStageMap[o.StageName] || 'lead',
                        companyId: o.AccountId ? idMap.accounts[o.AccountId] : '',
                        contactId: o.ContactId ? idMap.contacts[o.ContactId] : '',
                        closeDate: o.CloseDate || '', notes: o.Description || '',
                        createdAt: o.CreatedDate || new Date().toISOString(),
                        updatedAt: o.LastModifiedDate || new Date().toISOString()
                    });
                });
            }

            // Tasks ‚Üí Activities
            if (sfData.Task) {
                sfData.Task.forEach(t => {
                    result.activities.push({
                        id: generateId(), title: t.Subject || '', type: t.Type || 'note',
                        contactId: t.WhoId ? idMap.contacts[t.WhoId] : '',
                        dealId: '', description: t.Description || '',
                        createdAt: t.ActivityDate || t.CreatedDate || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                });
            }

            return result;
        }

        function transformFromDynamics(d365Data) {
            const result = { contacts: [], companies: [], deals: [], activities: [] };
            const idMap = { accounts: {}, contacts: {} };

            // Accounts ‚Üí Companies
            if (d365Data.account) {
                d365Data.account.forEach(a => {
                    const localId = generateId();
                    idMap.accounts[a.accountid] = localId;
                    result.companies.push({
                        id: localId, name: a.name || '',
                        industry: mapIndustryFromDynamics(a.industrycode),
                        website: a.websiteurl || '', notes: a.description || '',
                        createdAt: a.createdon || new Date().toISOString(),
                        updatedAt: a.modifiedon || new Date().toISOString()
                    });
                });
            }

            // Contacts
            if (d365Data.contact) {
                d365Data.contact.forEach(c => {
                    const localId = generateId();
                    idMap.contacts[c.contactid] = localId;
                    result.contacts.push({
                        id: localId, firstName: c.firstname || '', lastName: c.lastname || '',
                        email: c.emailaddress1 || '', phone: c.telephone1 || '',
                        companyId: c.parentcustomerid ? idMap.accounts[c.parentcustomerid] : '',
                        notes: c.description || '',
                        status: c.customertypecode === 1 ? 'hot' : (c.customertypecode === 3 ? 'cold' : 'warm'),
                        createdAt: c.createdon || new Date().toISOString(),
                        updatedAt: c.modifiedon || new Date().toISOString()
                    });
                });
            }

            // Opportunities ‚Üí Deals
            if (d365Data.opportunity) {
                d365Data.opportunity.forEach(o => {
                    result.deals.push({
                        id: generateId(), name: o.name || '',
                        value: parseFloat(o.estimatedvalue) || 0,
                        stage: DYNAMICS_SCHEMA.reverseStageMap[o.stepname] || 'lead',
                        companyId: o.parentaccountid ? idMap.accounts[o.parentaccountid] : '',
                        contactId: o.parentcontactid ? idMap.contacts[o.parentcontactid] : '',
                        closeDate: o.estimatedclosedate || '', notes: o.description || '',
                        createdAt: o.createdon || new Date().toISOString(),
                        updatedAt: o.modifiedon || new Date().toISOString()
                    });
                });
            }

            // Activities
            if (d365Data.activitypointer) {
                d365Data.activitypointer.forEach(a => {
                    result.activities.push({
                        id: generateId(), title: a.subject || '',
                        type: reverseMapActivityType(a.activitytypecode),
                        contactId: '', dealId: '', description: a.description || '',
                        createdAt: a.actualstart || a.createdon || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                });
            }

            return result;
        }

        function mapIndustryToDynamics(industry) {
            const map = { 'Technology': 12, 'Finance': 6, 'Healthcare': 8, 'Retail': 11, 'Manufacturing': 10, 'Services': 13 };
            return map[industry] || 0;
        }

        function mapIndustryFromDynamics(code) {
            const map = { 12: 'Technology', 6: 'Finance', 8: 'Healthcare', 11: 'Retail', 10: 'Manufacturing', 13: 'Services' };
            return map[code] || 'Other';
        }

        function mapActivityType(type) {
            const map = { 'call': 'phonecall', 'email': 'email', 'meeting': 'appointment', 'note': 'task' };
            return map[type] || 'task';
        }

        function reverseMapActivityType(code) {
            const map = { 'phonecall': 'call', 'email': 'email', 'appointment': 'meeting', 'task': 'note' };
            return map[code] || 'note';
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        function exportToSalesforce() {
            const sfData = transformToSalesforce(data);
            downloadJSON(sfData, `salesforce-export-${new Date().toISOString().split('T')[0]}.json`);
        }

        function exportToDynamics() {
            const d365Data = transformToDynamics(data);
            downloadJSON(d365Data, `dynamics365-export-${new Date().toISOString().split('T')[0]}.json`);
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================
        // IMPORT FUNCTIONS
        // ============================================
        function openImportModal(platform) {
            importPlatform = platform;
            pendingImport = null;
            document.getElementById('importModalTitle').textContent = `Import from ${platform === 'salesforce' ? 'Salesforce' : 'Dynamics 365'}`;
            document.getElementById('importPreviewArea').style.display = 'none';
            document.getElementById('confirmImportBtn').style.display = 'none';
            document.getElementById('importModal').classList.add('active');
        }

        function handlePlatformImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    let transformed;

                    if (importPlatform === 'salesforce') {
                        transformed = transformFromSalesforce(importedData);
                    } else {
                        transformed = transformFromDynamics(importedData);
                    }

                    pendingImport = transformed;

                    // Show preview
                    document.getElementById('importStats').innerHTML = `
                        <div class="import-stat"><div class="import-stat-value">${transformed.companies.length}</div><div class="import-stat-label">Companies</div></div>
                        <div class="import-stat"><div class="import-stat-value">${transformed.contacts.length}</div><div class="import-stat-label">Contacts</div></div>
                        <div class="import-stat"><div class="import-stat-value">${transformed.deals.length}</div><div class="import-stat-label">Deals</div></div>
                        <div class="import-stat"><div class="import-stat-value">${transformed.activities.length}</div><div class="import-stat-label">Activities</div></div>
                    `;
                    document.getElementById('importPreview').textContent = JSON.stringify(transformed, null, 2).substring(0, 2000) + '...';
                    document.getElementById('importPreviewArea').style.display = 'block';
                    document.getElementById('confirmImportBtn').style.display = 'flex';
                } catch (err) {
                    alert('Error parsing file: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function confirmImport() {
            if (!pendingImport) return;

            const merge = confirm('Merge with existing data? (Cancel to replace all)');
            if (merge) {
                data.companies = [...data.companies, ...pendingImport.companies];
                data.contacts = [...data.contacts, ...pendingImport.contacts];
                data.deals = [...data.deals, ...pendingImport.deals];
                data.activities = [...data.activities, ...pendingImport.activities];
            } else {
                data = pendingImport;
            }

            saveData();
            closeModal('importModal');
            renderCurrentView();
            alert(`Imported ${pendingImport.companies.length} companies, ${pendingImport.contacts.length} contacts, ${pendingImport.deals.length} deals, ${pendingImport.activities.length} activities!`);
            pendingImport = null;
        }

        // ============================================
        // CORE CRM FUNCTIONS
        // ============================================
        function init() {
            loadData();
            setupEventListeners();
            renderCurrentView();
            updateCounts();
        }

        function loadData() {
            const saved = localStorage.getItem('localCRM');
            if (saved) data = JSON.parse(saved);
        }

        function saveData() {
            localStorage.setItem('localCRM', JSON.stringify(data));
            updateCounts();
        }

        function updateCounts() {
            document.getElementById('contactCount').textContent = data.contacts.length;
            document.getElementById('companyCount').textContent = data.companies.length;
            document.getElementById('dealCount').textContent = data.deals.filter(d => d.stage !== 'won' && d.stage !== 'lost').length;
            document.getElementById('activityCount').textContent = data.activities.length;
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchView(item.dataset.view));
            });
            document.getElementById('addBtn').addEventListener('click', openAddModal);
            document.getElementById('searchBox').addEventListener('input', (e) => renderCurrentView(e.target.value));
            document.getElementById('contactForm').addEventListener('submit', saveContact);
            document.getElementById('companyForm').addEventListener('submit', saveCompany);
            document.getElementById('dealForm').addEventListener('submit', saveDeal);
            document.getElementById('activityForm').addEventListener('submit', saveActivity);
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal.id); });
            });
            document.querySelectorAll('.entity-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.entity-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('mapping-' + tab.dataset.entity).classList.add('active');
                });
            });

            // File drop zone
            const dropZone = document.getElementById('fileDropZone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    const fakeEvent = { target: { files: [file], value: '' } };
                    handlePlatformImport(fakeEvent);
                }
            });
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.view === view));
            const titles = { dashboard: 'Dashboard', contacts: 'Contacts', companies: 'Companies', deals: 'Deals Pipeline', activities: 'Activities', integrations: 'Integrations', settings: 'Settings' };
            document.getElementById('pageTitle').textContent = titles[view];
            document.getElementById('addBtn').style.display = ['dashboard', 'settings', 'integrations'].includes(view) ? 'none' : 'flex';
            document.querySelectorAll('.list-view').forEach(v => v.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');
            renderCurrentView();
        }

        function renderCurrentView(search = '') {
            switch (currentView) {
                case 'dashboard': renderDashboard(); break;
                case 'contacts': renderContacts(search); break;
                case 'companies': renderCompanies(search); break;
                case 'deals': renderDeals(search); break;
                case 'activities': renderActivities(search); break;
            }
        }

        function renderDashboard() {
            document.getElementById('statContacts').textContent = data.contacts.length;
            const activeDeals = data.deals.filter(d => d.stage !== 'won' && d.stage !== 'lost');
            document.getElementById('statDeals').textContent = activeDeals.length;
            const pipelineValue = activeDeals.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
            document.getElementById('statPipeline').textContent = formatCurrency(pipelineValue);
            const thisMonth = new Date(); thisMonth.setDate(1);
            const wonThisMonth = data.deals.filter(d => d.stage === 'won' && new Date(d.updatedAt) >= thisMonth).reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
            document.getElementById('statWon').textContent = formatCurrency(wonThisMonth);

            const chartEl = document.getElementById('pipelineChart');
            const stageTotals = {}; let total = 0;
            STAGES.filter(s => s !== 'lost').forEach(stage => {
                const stageValue = data.deals.filter(d => d.stage === stage).reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
                stageTotals[stage] = stageValue;
                total += stageValue;
            });
            if (total === 0) {
                chartEl.innerHTML = '<div style="width: 100%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.5);">No deals yet</div>';
            } else {
                chartEl.innerHTML = STAGES.filter(s => s !== 'lost').map(stage => {
                    const pct = (stageTotals[stage] / total * 100).toFixed(1);
                    if (pct < 1) return '';
                    return `<div class="pipeline-segment" style="width: ${pct}%; background: ${STAGE_COLORS[stage]}" title="${stage}: ${formatCurrency(stageTotals[stage])}">${pct > 10 ? stage : ''}</div>`;
                }).join('');
            }

            const recentEl = document.getElementById('recentActivities');
            const recent = [...data.activities].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
            recentEl.innerHTML = recent.length === 0 ? '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>No activities yet</p></div>' : recent.map(a => renderActivityItem(a)).join('');
        }

        function renderContacts(search = '') {
            const list = document.getElementById('contactsList');
            let contacts = data.contacts;
            if (search) {
                const s = search.toLowerCase();
                contacts = contacts.filter(c => c.firstName.toLowerCase().includes(s) || c.lastName.toLowerCase().includes(s) || (c.email && c.email.toLowerCase().includes(s)));
            }
            if (contacts.length === 0) {
                list.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px;"><div class="empty-state-icon">üë§</div><p>No contacts yet.</p></td></tr>`;
                return;
            }
            list.innerHTML = contacts.map(c => {
                const company = data.companies.find(co => co.id === c.companyId);
                const initials = (c.firstName[0] + c.lastName[0]).toUpperCase();
                return `<tr class="clickable" onclick="editContact('${c.id}')"><td><div class="contact-name"><div class="avatar" style="background: ${stringToColor(c.firstName + c.lastName)}">${initials}</div><span>${c.firstName} ${c.lastName}</span></div></td><td>${company ? company.name : '-'}</td><td>${c.email || '-'}</td><td>${c.phone || '-'}</td><td><span class="tag ${c.status}">${c.status}</span></td></tr>`;
            }).join('');
        }

        function renderCompanies(search = '') {
            const list = document.getElementById('companiesList');
            let companies = data.companies;
            if (search) {
                const s = search.toLowerCase();
                companies = companies.filter(c => c.name.toLowerCase().includes(s) || (c.industry && c.industry.toLowerCase().includes(s)));
            }
            if (companies.length === 0) {
                list.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px;"><div class="empty-state-icon">üè¢</div><p>No companies yet.</p></td></tr>`;
                return;
            }
            list.innerHTML = companies.map(c => {
                const contactCount = data.contacts.filter(co => co.companyId === c.id).length;
                const companyDeals = data.deals.filter(d => d.companyId === c.id);
                const totalValue = companyDeals.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
                return `<tr class="clickable" onclick="editCompany('${c.id}')"><td><div class="contact-name"><div class="avatar" style="background: ${stringToColor(c.name)}">${c.name[0].toUpperCase()}</div><span>${c.name}</span></div></td><td>${c.industry || '-'}</td><td>${contactCount}</td><td>${companyDeals.length}</td><td>${formatCurrency(totalValue)}</td></tr>`;
            }).join('');
        }

        function renderDeals(search = '') {
            const board = document.getElementById('pipelineBoard');
            board.innerHTML = STAGES.map(stage => {
                let deals = data.deals.filter(d => d.stage === stage);
                if (search) deals = deals.filter(d => d.name.toLowerCase().includes(search.toLowerCase()));
                const stageValue = deals.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0);
                return `<div class="pipeline-stage"><div class="stage-header"><div class="stage-title"><span style="color: ${STAGE_COLORS[stage]}">‚óè</span>${stage.charAt(0).toUpperCase() + stage.slice(1)}<span class="stage-count">${deals.length}</span></div><div class="stage-value">${formatCurrency(stageValue)}</div></div><div class="stage-deals">${deals.map(d => {
                    const company = data.companies.find(c => c.id === d.companyId);
                    return `<div class="deal-card" onclick="editDeal('${d.id}')"><div class="deal-name">${d.name}</div><div class="deal-company">${company ? company.name : 'No company'}</div><div class="deal-value">${formatCurrency(d.value)}</div>${d.closeDate ? `<div class="deal-meta"><span>Close: ${formatDate(d.closeDate)}</span></div>` : ''}</div>`;
                }).join('')}</div></div>`;
            }).join('');
        }

        function renderActivities(search = '') {
            const list = document.getElementById('activitiesList');
            let activities = [...data.activities].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (search) activities = activities.filter(a => a.title.toLowerCase().includes(search.toLowerCase()) || (a.description && a.description.toLowerCase().includes(search.toLowerCase())));
            list.innerHTML = activities.length === 0 ? '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>No activities yet.</p></div>' : activities.map(a => renderActivityItem(a, true)).join('');
        }

        function renderActivityItem(a, clickable = false) {
            const icons = { call: 'üìû', email: '‚úâÔ∏è', meeting: 'ü§ù', note: 'üìù' };
            const contact = data.contacts.find(c => c.id === a.contactId);
            return `<div class="activity-item ${clickable ? 'clickable' : ''}" ${clickable ? `onclick="editActivity('${a.id}')"` : ''}><div class="activity-icon ${a.type}">${icons[a.type]}</div><div class="activity-content"><div class="activity-title">${a.title}</div><div class="activity-desc">${contact ? contact.firstName + ' ' + contact.lastName : ''} ${a.description ? '- ' + a.description.substring(0, 100) : ''}</div></div><div class="activity-time">${timeAgo(a.createdAt)}</div></div>`;
        }

        // Modal & CRUD functions
        function openAddModal() {
            switch (currentView) {
                case 'contacts': openContactModal(); break;
                case 'companies': openCompanyModal(); break;
                case 'deals': openDealModal(); break;
                case 'activities': openActivityModal(); break;
            }
        }

        function openContactModal(contact = null) {
            document.getElementById('contactModalTitle').textContent = contact ? 'Edit Contact' : 'Add Contact';
            document.getElementById('contactForm').reset();
            document.getElementById('contactId').value = contact ? contact.id : '';
            document.getElementById('deleteContactBtn').style.display = contact ? 'block' : 'none';
            const companySelect = document.getElementById('contactCompany');
            companySelect.innerHTML = '<option value="">Select company...</option>' + data.companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if (contact) {
                document.getElementById('contactFirst').value = contact.firstName;
                document.getElementById('contactLast').value = contact.lastName;
                document.getElementById('contactEmail').value = contact.email || '';
                document.getElementById('contactPhone').value = contact.phone || '';
                document.getElementById('contactCompany').value = contact.companyId || '';
                document.getElementById('contactStatus').value = contact.status || 'warm';
                document.getElementById('contactNotes').value = contact.notes || '';
            }
            document.getElementById('contactModal').classList.add('active');
        }

        function openCompanyModal(company = null) {
            document.getElementById('companyModalTitle').textContent = company ? 'Edit Company' : 'Add Company';
            document.getElementById('companyForm').reset();
            document.getElementById('companyId').value = company ? company.id : '';
            document.getElementById('deleteCompanyBtn').style.display = company ? 'block' : 'none';
            if (company) {
                document.getElementById('companyName').value = company.name;
                document.getElementById('companyIndustry').value = company.industry || '';
                document.getElementById('companyWebsite').value = company.website || '';
                document.getElementById('companyNotes').value = company.notes || '';
            }
            document.getElementById('companyModal').classList.add('active');
        }

        function openDealModal(deal = null) {
            document.getElementById('dealModalTitle').textContent = deal ? 'Edit Deal' : 'Add Deal';
            document.getElementById('dealForm').reset();
            document.getElementById('dealId').value = deal ? deal.id : '';
            document.getElementById('deleteDealBtn').style.display = deal ? 'block' : 'none';
            const companySelect = document.getElementById('dealCompany');
            companySelect.innerHTML = '<option value="">Select...</option>' + data.companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const contactSelect = document.getElementById('dealContact');
            contactSelect.innerHTML = '<option value="">Select...</option>' + data.contacts.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
            if (deal) {
                document.getElementById('dealName').value = deal.name;
                document.getElementById('dealValue').value = deal.value || '';
                document.getElementById('dealStage').value = deal.stage || 'lead';
                document.getElementById('dealCompany').value = deal.companyId || '';
                document.getElementById('dealContact').value = deal.contactId || '';
                document.getElementById('dealCloseDate').value = deal.closeDate || '';
                document.getElementById('dealNotes').value = deal.notes || '';
            }
            document.getElementById('dealModal').classList.add('active');
        }

        function openActivityModal(activity = null) {
            document.getElementById('activityModalTitle').textContent = activity ? 'Edit Activity' : 'Log Activity';
            document.getElementById('activityForm').reset();
            document.getElementById('activityId').value = activity ? activity.id : '';
            document.getElementById('deleteActivityBtn').style.display = activity ? 'block' : 'none';
            const contactSelect = document.getElementById('activityContact');
            contactSelect.innerHTML = '<option value="">Select...</option>' + data.contacts.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
            const dealSelect = document.getElementById('activityDeal');
            dealSelect.innerHTML = '<option value="">Select...</option>' + data.deals.filter(d => d.stage !== 'won' && d.stage !== 'lost').map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            if (activity) {
                document.getElementById('activityType').value = activity.type;
                document.getElementById('activityTitle').value = activity.title;
                document.getElementById('activityContact').value = activity.contactId || '';
                document.getElementById('activityDeal').value = activity.dealId || '';
                document.getElementById('activityDesc').value = activity.description || '';
            }
            document.getElementById('activityModal').classList.add('active');
        }

        function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }

        function editContact(id) { const c = data.contacts.find(c => c.id === id); if (c) openContactModal(c); }
        function editCompany(id) { const c = data.companies.find(c => c.id === id); if (c) openCompanyModal(c); }
        function editDeal(id) { const d = data.deals.find(d => d.id === id); if (d) openDealModal(d); }
        function editActivity(id) { const a = data.activities.find(a => a.id === id); if (a) openActivityModal(a); }

        function saveContact(e) {
            e.preventDefault();
            const id = document.getElementById('contactId').value;
            const contact = { id: id || generateId(), firstName: document.getElementById('contactFirst').value, lastName: document.getElementById('contactLast').value, email: document.getElementById('contactEmail').value, phone: document.getElementById('contactPhone').value, companyId: document.getElementById('contactCompany').value, status: document.getElementById('contactStatus').value, notes: document.getElementById('contactNotes').value, createdAt: id ? data.contacts.find(c => c.id === id).createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
            if (id) { const idx = data.contacts.findIndex(c => c.id === id); data.contacts[idx] = contact; } else { data.contacts.push(contact); }
            saveData(); closeModal('contactModal'); renderCurrentView();
        }

        function saveCompany(e) {
            e.preventDefault();
            const id = document.getElementById('companyId').value;
            const company = { id: id || generateId(), name: document.getElementById('companyName').value, industry: document.getElementById('companyIndustry').value, website: document.getElementById('companyWebsite').value, notes: document.getElementById('companyNotes').value, createdAt: id ? data.companies.find(c => c.id === id).createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
            if (id) { const idx = data.companies.findIndex(c => c.id === id); data.companies[idx] = company; } else { data.companies.push(company); }
            saveData(); closeModal('companyModal'); renderCurrentView();
        }

        function saveDeal(e) {
            e.preventDefault();
            const id = document.getElementById('dealId').value;
            const deal = { id: id || generateId(), name: document.getElementById('dealName').value, value: parseFloat(document.getElementById('dealValue').value) || 0, stage: document.getElementById('dealStage').value, companyId: document.getElementById('dealCompany').value, contactId: document.getElementById('dealContact').value, closeDate: document.getElementById('dealCloseDate').value, notes: document.getElementById('dealNotes').value, createdAt: id ? data.deals.find(d => d.id === id).createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
            if (id) { const idx = data.deals.findIndex(d => d.id === id); data.deals[idx] = deal; } else { data.deals.push(deal); }
            saveData(); closeModal('dealModal'); renderCurrentView();
        }

        function saveActivity(e) {
            e.preventDefault();
            const id = document.getElementById('activityId').value;
            const activity = { id: id || generateId(), type: document.getElementById('activityType').value, title: document.getElementById('activityTitle').value, contactId: document.getElementById('activityContact').value, dealId: document.getElementById('activityDeal').value, description: document.getElementById('activityDesc').value, createdAt: id ? data.activities.find(a => a.id === id).createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
            if (id) { const idx = data.activities.findIndex(a => a.id === id); data.activities[idx] = activity; } else { data.activities.push(activity); }
            saveData(); closeModal('activityModal'); renderCurrentView();
        }

        function deleteContact() { if (confirm('Delete?')) { data.contacts = data.contacts.filter(c => c.id !== document.getElementById('contactId').value); saveData(); closeModal('contactModal'); renderCurrentView(); } }
        function deleteCompany() { if (confirm('Delete?')) { const id = document.getElementById('companyId').value; data.companies = data.companies.filter(c => c.id !== id); data.contacts.forEach(c => { if (c.companyId === id) c.companyId = ''; }); data.deals.forEach(d => { if (d.companyId === id) d.companyId = ''; }); saveData(); closeModal('companyModal'); renderCurrentView(); } }
        function deleteDeal() { if (confirm('Delete?')) { data.deals = data.deals.filter(d => d.id !== document.getElementById('dealId').value); saveData(); closeModal('dealModal'); renderCurrentView(); } }
        function deleteActivity() { if (confirm('Delete?')) { data.activities = data.activities.filter(a => a.id !== document.getElementById('activityId').value); saveData(); closeModal('activityModal'); renderCurrentView(); } }

        function exportData() { downloadJSON(data, `crm-export-${new Date().toISOString().split('T')[0]}.json`); }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (imported.contacts && imported.companies && imported.deals && imported.activities) {
                        if (confirm('Replace all data?')) { data = imported; saveData(); renderCurrentView(); alert('Imported!'); }
                    } else { alert('Invalid format.'); }
                } catch (err) { alert('Error: ' + err.message); }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function clearAllData() { if (confirm('Delete ALL data?')) { data = { contacts: [], companies: [], deals: [], activities: [] }; saveData(); renderCurrentView(); } }

        // Utilities
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function formatCurrency(value) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value || 0); }
        function formatDate(dateStr) { if (!dateStr) return ''; return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
        function timeAgo(dateStr) { const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000); const intervals = [{ label: 'y', seconds: 31536000 }, { label: 'mo', seconds: 2592000 }, { label: 'd', seconds: 86400 }, { label: 'h', seconds: 3600 }, { label: 'm', seconds: 60 }]; for (const interval of intervals) { const count = Math.floor(seconds / interval.seconds); if (count >= 1) return `${count}${interval.label} ago`; } return 'just now'; }
        function stringToColor(str) { let hash = 0; for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); } return `hsl(${hash % 360}, 60%, 45%)`; }

        init();
    </script>
</body>
</html>
