<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Living Document - A rich text editor with real-time analytics, heat maps, mood analysis, and writing session tracking">
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#4361ee" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#4361ee" media="(prefers-color-scheme: dark)">
    <!-- living, document, editor, analytics, writing, productivity -->
    <title>Living Document - Evolving Text Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --accent: #4361ee;
            --accent-light: #e8ecff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
            --heat-low: rgba(67, 97, 238, 0.1);
            --heat-medium: rgba(67, 97, 238, 0.25);
            --heat-high: rgba(67, 97, 238, 0.4);
            --uncertainty: rgba(245, 158, 11, 0.3);
            --positive: rgba(16, 185, 129, 0.2);
            --negative: rgba(239, 68, 68, 0.2);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #e8e8e8;
            --text-secondary: #b8b8b8;
            --text-muted: #888888;
            --accent: #7c93ff;
            --accent-light: #2a2a4a;
            --border: #3a3a5a;
            --shadow: rgba(0, 0, 0, 0.3);
            --heat-low: rgba(124, 147, 255, 0.15);
            --heat-medium: rgba(124, 147, 255, 0.3);
            --heat-high: rgba(124, 147, 255, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Header Controls */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .session-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 5px 12px;
            background: var(--bg-secondary);
            border-radius: 20px;
        }

        .session-timer .pulse {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-icon {
            padding: 8px;
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-icon:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            margin-top: 50px;
            min-height: calc(100vh - 50px);
        }

        /* Editor Area */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s ease;
        }

        .editor-container.sidebar-open {
            margin-right: 350px;
        }

        .editor-toolbar {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .toolbar-btn.active {
            background: var(--accent-light);
            color: var(--accent);
        }

        .toolbar-divider {
            width: 1px;
            background: var(--border);
            margin: 0 8px;
        }

        .editor-wrapper {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
        }

        .editor {
            width: 100%;
            max-width: 800px;
            min-height: 500px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
            padding: 40px 50px;
            outline: none;
            line-height: 1.8;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .editor:empty:before {
            content: 'Start writing... Your document will come alive as you type.';
            color: var(--text-muted);
            font-style: italic;
        }

        .editor p {
            margin-bottom: 1em;
            position: relative;
        }

        /* Heat Map Overlays */
        .editor.heatmap-active [data-heat="low"] {
            background: var(--heat-low);
            border-radius: 3px;
        }

        .editor.heatmap-active [data-heat="medium"] {
            background: var(--heat-medium);
            border-radius: 3px;
        }

        .editor.heatmap-active [data-heat="high"] {
            background: var(--heat-high);
            border-radius: 3px;
        }

        /* Uncertainty Markers */
        .uncertainty-word {
            background: var(--uncertainty);
            border-radius: 3px;
            padding: 0 2px;
        }

        /* Mood Highlights */
        .positive-word {
            background: var(--positive);
            border-radius: 3px;
            padding: 0 2px;
        }

        .negative-word {
            background: var(--negative);
            border-radius: 3px;
            padding: 0 2px;
        }

        /* Focus Mode */
        .editor.focus-mode p {
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }

        .editor.focus-mode p:focus-within,
        .editor.focus-mode p.active-paragraph {
            opacity: 1;
        }

        /* Quick Stats Bar */
        .quick-stats {
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            gap: 25px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Goals Progress */
        .goal-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            width: 100px;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-fill.complete {
            background: var(--success);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            right: 0;
            top: 50px;
            bottom: 0;
            width: 350px;
            background: var(--bg-primary);
            border-left: 1px solid var(--border);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            z-index: 900;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
            font-weight: 600;
        }

        /* Analytics Cards */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .analytics-card {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
        }

        .analytics-card.full-width {
            grid-column: span 2;
        }

        .card-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .card-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-value.small {
            font-size: 0.95rem;
        }

        /* Mood Indicator */
        .mood-indicator {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }

        .mood-bar {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            overflow: hidden;
        }

        .mood-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .mood-fill.positive {
            background: var(--success);
        }

        .mood-fill.neutral {
            background: var(--text-muted);
        }

        .mood-fill.negative {
            background: var(--danger);
        }

        /* Complexity Meter */
        .complexity-meter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .complexity-scale {
            flex: 1;
            display: flex;
            gap: 3px;
        }

        .complexity-segment {
            flex: 1;
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            transition: background 0.3s ease;
        }

        .complexity-segment.active {
            background: var(--accent);
        }

        .complexity-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 60px;
            text-align: right;
        }

        /* Session History */
        .session-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .session-date {
            color: var(--text-secondary);
        }

        .session-stats {
            color: var(--text-muted);
        }

        /* Goals Section */
        .goal-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .goal-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .goal-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Toggle Switches */
        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .toggle-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
            border-radius: 12px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Document List Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px var(--shadow);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .document-item:hover {
            background: var(--bg-tertiary);
        }

        .document-info h4 {
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .document-actions {
            display: flex;
            gap: 8px;
        }

        /* Export Options Modal */
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .export-option {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .export-option:hover {
            border-color: var(--accent);
        }

        .export-option h4 {
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .export-option p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Structure Suggestions */
        .suggestions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .suggestion-item {
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border-left: 3px solid var(--accent);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 300px;
            }

            .editor-container.sidebar-open {
                margin-right: 300px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 10px;
            }

            .header-title {
                display: none;
            }

            .sidebar {
                width: 100%;
            }

            .editor-container.sidebar-open {
                margin-right: 0;
            }

            .editor-wrapper {
                padding: 20px;
            }

            .editor {
                padding: 25px;
            }

            .quick-stats {
                flex-wrap: wrap;
                gap: 10px 20px;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .analytics-card.full-width {
                grid-column: span 1;
            }
        }

        @media (max-width: 480px) {
            .editor-toolbar {
                padding: 8px 10px;
            }

            .toolbar-btn {
                width: 32px;
                height: 32px;
            }

            .toolbar-divider {
                display: none;
            }

            .btn span {
                display: none;
            }
        }

        /* Print Styles */
        @media print {
            .header, .sidebar, .editor-toolbar, .quick-stats {
                display: none !important;
            }

            .editor-container {
                margin: 0 !important;
            }

            .editor-wrapper {
                padding: 0;
            }

            .editor {
                box-shadow: none;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <span class="header-title">Living Document</span>
            <div class="session-timer">
                <span class="pulse"></span>
                <span id="sessionTime">00:00:00</span>
            </div>
        </div>
        <div class="header-right">
            <button class="btn btn-icon" onclick="toggleTheme()" title="Toggle Theme">
                <span id="themeIcon">&#9789;</span>
            </button>
            <button class="btn btn-secondary" onclick="showDocumentsModal()">
                <span>&#128196;</span> <span>Documents</span>
            </button>
            <button class="btn btn-secondary" onclick="showExportModal()">
                <span>&#128229;</span> <span>Export</span>
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                <span>&#128228;</span> <span>Import</span>
            </button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            <button class="btn btn-primary" onclick="saveDocument()">
                <span>&#128190;</span> <span>Save</span>
            </button>
            <button class="btn btn-icon" onclick="toggleSidebar()" title="Toggle Analytics">
                <span>&#9776;</span>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Editor Area -->
        <div class="editor-container" id="editorContainer">
            <!-- Toolbar -->
            <div class="editor-toolbar">
                <button class="toolbar-btn" onclick="execCommand('bold')" title="Bold (Ctrl+B)"><b>B</b></button>
                <button class="toolbar-btn" onclick="execCommand('italic')" title="Italic (Ctrl+I)"><i>I</i></button>
                <button class="toolbar-btn" onclick="execCommand('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
                <button class="toolbar-btn" onclick="execCommand('strikeThrough')" title="Strikethrough"><s>S</s></button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" onclick="execCommand('formatBlock', 'h1')" title="Heading 1">H1</button>
                <button class="toolbar-btn" onclick="execCommand('formatBlock', 'h2')" title="Heading 2">H2</button>
                <button class="toolbar-btn" onclick="execCommand('formatBlock', 'h3')" title="Heading 3">H3</button>
                <button class="toolbar-btn" onclick="execCommand('formatBlock', 'p')" title="Paragraph">P</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" onclick="execCommand('insertUnorderedList')" title="Bullet List">&#8226;</button>
                <button class="toolbar-btn" onclick="execCommand('insertOrderedList')" title="Numbered List">1.</button>
                <button class="toolbar-btn" onclick="execCommand('indent')" title="Indent">&#8594;</button>
                <button class="toolbar-btn" onclick="execCommand('outdent')" title="Outdent">&#8592;</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" onclick="execCommand('justifyLeft')" title="Align Left">&#8676;</button>
                <button class="toolbar-btn" onclick="execCommand('justifyCenter')" title="Align Center">&#8633;</button>
                <button class="toolbar-btn" onclick="execCommand('justifyRight')" title="Align Right">&#8677;</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" id="heatmapBtn" onclick="toggleHeatmap()" title="Toggle Heat Map">&#128293;</button>
                <button class="toolbar-btn" id="focusBtn" onclick="toggleFocusMode()" title="Focus Mode">&#127919;</button>
                <button class="toolbar-btn" id="uncertaintyBtn" onclick="toggleUncertainty()" title="Show Uncertainty">&#10067;</button>
                <button class="toolbar-btn" id="moodBtn" onclick="toggleMoodHighlight()" title="Show Mood">&#128522;</button>
            </div>

            <!-- Editor -->
            <div class="editor-wrapper">
                <div class="editor" id="editor" contenteditable="true" spellcheck="true"></div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-item">
                    <span>Words:</span>
                    <span class="stat-value" id="quickWords">0</span>
                </div>
                <div class="stat-item">
                    <span>Characters:</span>
                    <span class="stat-value" id="quickChars">0</span>
                </div>
                <div class="stat-item">
                    <span>Reading time:</span>
                    <span class="stat-value" id="quickReadTime">0 min</span>
                </div>
                <div class="stat-item">
                    <span>Mood:</span>
                    <span class="stat-value" id="quickMood">Neutral</span>
                </div>
                <div class="goal-progress" id="goalProgressContainer" style="display: none;">
                    <span>Goal:</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="goalProgressBar" style="width: 0%"></div>
                    </div>
                    <span class="stat-value" id="goalProgressText">0%</span>
                </div>
            </div>
        </div>

        <!-- Analytics Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Analytics</span>
                <button class="btn btn-icon" onclick="toggleSidebar()">&#10005;</button>
            </div>
            <div class="sidebar-content">
                <!-- Basic Stats -->
                <div class="sidebar-section">
                    <div class="section-title">Statistics</div>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-label">Words</div>
                            <div class="card-value" id="wordCount">0</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-label">Characters</div>
                            <div class="card-value" id="charCount">0</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-label">Sentences</div>
                            <div class="card-value" id="sentenceCount">0</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-label">Paragraphs</div>
                            <div class="card-value" id="paragraphCount">0</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-label">Reading Time</div>
                            <div class="card-value" id="readingTime">0 min</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-label">Speaking Time</div>
                            <div class="card-value" id="speakingTime">0 min</div>
                        </div>
                    </div>
                </div>

                <!-- Vocabulary -->
                <div class="sidebar-section">
                    <div class="section-title">Vocabulary</div>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-label">Unique Words</div>
                            <div class="card-value" id="uniqueWords">0</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-label">Diversity</div>
                            <div class="card-value" id="vocabDiversity">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Complexity -->
                <div class="sidebar-section">
                    <div class="section-title">Sentence Complexity</div>
                    <div class="complexity-meter">
                        <div class="complexity-scale" id="complexityScale">
                            <div class="complexity-segment"></div>
                            <div class="complexity-segment"></div>
                            <div class="complexity-segment"></div>
                            <div class="complexity-segment"></div>
                            <div class="complexity-segment"></div>
                        </div>
                        <span class="complexity-label" id="complexityLabel">Simple</span>
                    </div>
                </div>

                <!-- Mood Analysis -->
                <div class="sidebar-section">
                    <div class="section-title">Mood Analysis</div>
                    <div class="analytics-card full-width">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 0.8rem; color: var(--success);">Positive <span id="positivePercent">0%</span></span>
                            <span style="font-size: 0.8rem; color: var(--text-muted);">Neutral <span id="neutralPercent">100%</span></span>
                            <span style="font-size: 0.8rem; color: var(--danger);">Negative <span id="negativePercent">0%</span></span>
                        </div>
                        <div class="mood-indicator">
                            <div class="mood-bar">
                                <div class="mood-fill positive" id="positiveFill" style="width: 0%"></div>
                            </div>
                            <div class="mood-bar">
                                <div class="mood-fill neutral" id="neutralFill" style="width: 100%"></div>
                            </div>
                            <div class="mood-bar">
                                <div class="mood-fill negative" id="negativeFill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Confidence Indicators -->
                <div class="sidebar-section">
                    <div class="section-title">Confidence Analysis</div>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="card-label">Uncertainty Words</div>
                            <div class="card-value" id="uncertaintyCount">0</div>
                        </div>
                        <div class="analytics-card">
                            <div class="card-label">Confidence Score</div>
                            <div class="card-value" id="confidenceScore">100%</div>
                        </div>
                    </div>
                </div>

                <!-- Goals -->
                <div class="sidebar-section">
                    <div class="section-title">Writing Goals</div>
                    <div class="goal-input-group">
                        <input type="number" class="goal-input" id="wordGoal" placeholder="Word goal" min="0">
                        <button class="btn btn-secondary" onclick="setGoal('words')">Set</button>
                    </div>
                    <div class="goal-input-group">
                        <input type="number" class="goal-input" id="timeGoal" placeholder="Time goal (min)" min="0">
                        <button class="btn btn-secondary" onclick="setGoal('time')">Set</button>
                    </div>
                </div>

                <!-- Display Options -->
                <div class="sidebar-section">
                    <div class="section-title">Display Options</div>
                    <div class="toggle-group">
                        <div class="toggle-item">
                            <span class="toggle-label">Heat Map</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="heatmapToggle" onchange="toggleHeatmap()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">Focus Mode</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="focusModeToggle" onchange="toggleFocusMode()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">Uncertainty Markers</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="uncertaintyToggle" onchange="toggleUncertainty()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-item">
                            <span class="toggle-label">Mood Highlights</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="moodToggle" onchange="toggleMoodHighlight()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Structure Suggestions -->
                <div class="sidebar-section">
                    <div class="section-title">Structure Suggestions</div>
                    <div class="suggestions-list" id="suggestionsList">
                        <div class="suggestion-item">Start writing to receive suggestions...</div>
                    </div>
                </div>

                <!-- Session History -->
                <div class="sidebar-section">
                    <div class="section-title">Writing Sessions</div>
                    <div class="session-list" id="sessionList">
                        <!-- Sessions populated dynamically -->
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Documents Modal -->
    <div class="modal-overlay" id="documentsModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Saved Documents</span>
                <button class="btn btn-icon" onclick="hideDocumentsModal()">&#10005;</button>
            </div>
            <div class="modal-body" id="documentsList">
                <!-- Documents populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Export Document</span>
                <button class="btn btn-icon" onclick="hideExportModal()">&#10005;</button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" onclick="exportDocument('full')">
                        <h4>Full Export (with Analytics)</h4>
                        <p>Export document content with all analytics data, session history, and metadata as JSON</p>
                    </div>
                    <div class="export-option" onclick="exportDocument('content')">
                        <h4>Content Only</h4>
                        <p>Export just the document content as JSON (no analytics)</p>
                    </div>
                    <div class="export-option" onclick="exportDocument('html')">
                        <h4>HTML Export</h4>
                        <p>Export as standalone HTML file for viewing in browser</p>
                    </div>
                    <div class="export-option" onclick="exportDocument('text')">
                        <h4>Plain Text</h4>
                        <p>Export as plain text file (.txt)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application Configuration
        const APP_NAME = 'living-document';
        const WORDS_PER_MINUTE_READ = 200;
        const WORDS_PER_MINUTE_SPEAK = 150;

        // Word Lists for Analysis
        const UNCERTAINTY_WORDS = [
            'maybe', 'perhaps', 'probably', 'possibly', 'might', 'could', 'would',
            'should', 'seems', 'appears', 'somewhat', 'fairly', 'rather', 'quite',
            'sometimes', 'often', 'usually', 'generally', 'typically', 'presumably',
            'allegedly', 'apparently', 'supposedly', 'seemingly', 'roughly', 'approximately',
            'about', 'around', 'nearly', 'almost', 'basically', 'essentially', 'virtually'
        ];

        const POSITIVE_WORDS = [
            'good', 'great', 'excellent', 'amazing', 'wonderful', 'fantastic', 'awesome',
            'beautiful', 'brilliant', 'love', 'happy', 'joy', 'success', 'successful',
            'perfect', 'best', 'better', 'positive', 'exciting', 'incredible', 'outstanding',
            'remarkable', 'superb', 'terrific', 'delightful', 'pleasant', 'lovely', 'nice',
            'achieve', 'accomplished', 'benefit', 'fortunate', 'grateful', 'thankful',
            'optimistic', 'hopeful', 'confident', 'proud', 'inspired', 'motivated'
        ];

        const NEGATIVE_WORDS = [
            'bad', 'terrible', 'awful', 'horrible', 'poor', 'wrong', 'worst', 'worse',
            'hate', 'angry', 'sad', 'fail', 'failed', 'failure', 'problem', 'difficult',
            'hard', 'impossible', 'never', 'unfortunately', 'disappointing', 'frustrated',
            'annoying', 'boring', 'ugly', 'stupid', 'useless', 'worthless', 'painful',
            'fear', 'worried', 'anxious', 'stressed', 'tired', 'exhausted', 'overwhelmed',
            'confused', 'lost', 'hopeless', 'desperate', 'miserable', 'unhappy'
        ];

        // Application State
        let appData = {
            documents: [],
            currentDocumentId: null,
            sessions: [],
            settings: {
                theme: 'light',
                wordGoal: null,
                timeGoal: null,
                heatmapEnabled: false,
                focusModeEnabled: false,
                uncertaintyEnabled: false,
                moodEnabled: false
            }
        };

        let currentSession = {
            startTime: Date.now(),
            pauseTime: 0,
            isPaused: false,
            wordsWritten: 0,
            paragraphTimes: {}
        };

        let analyticsCache = {
            lastContent: '',
            lastAnalysis: null
        };

        // DOM Elements
        const editor = document.getElementById('editor');
        const sidebar = document.getElementById('sidebar');
        const editorContainer = document.getElementById('editorContainer');

        // Initialize Application
        function init() {
            loadData();
            applyTheme();
            startSessionTimer();
            setupEventListeners();
            updateAnalytics();
            renderSessionHistory();

            // Load last document if exists
            if (appData.currentDocumentId) {
                const doc = appData.documents.find(d => d.id === appData.currentDocumentId);
                if (doc) {
                    editor.innerHTML = doc.content;
                }
            }
        }

        // Data Management
        function loadData() {
            const stored = localStorage.getItem(APP_NAME);
            if (stored) {
                try {
                    appData = JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to load data:', e);
                }
            }
        }

        function saveData() {
            localStorage.setItem(APP_NAME, JSON.stringify(appData));
        }

        function saveDocument() {
            const content = editor.innerHTML;
            const plainText = editor.innerText;
            const analysis = analyzeText(plainText);

            const doc = {
                id: appData.currentDocumentId || Date.now().toString(),
                title: extractTitle(plainText) || 'Untitled Document',
                content: content,
                plainText: plainText,
                analytics: analysis,
                createdAt: appData.currentDocumentId ?
                    appData.documents.find(d => d.id === appData.currentDocumentId)?.createdAt :
                    new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                sessionData: { ...currentSession }
            };

            const existingIndex = appData.documents.findIndex(d => d.id === doc.id);
            if (existingIndex >= 0) {
                appData.documents[existingIndex] = doc;
            } else {
                appData.documents.push(doc);
            }

            appData.currentDocumentId = doc.id;
            saveData();

            showNotification('Document saved successfully');
        }

        function extractTitle(text) {
            const firstLine = text.trim().split('\n')[0];
            return firstLine.substring(0, 50) || null;
        }

        // Session Management
        function startSessionTimer() {
            setInterval(() => {
                if (!currentSession.isPaused) {
                    const elapsed = Date.now() - currentSession.startTime - currentSession.pauseTime;
                    document.getElementById('sessionTime').textContent = formatTime(elapsed);
                    checkTimeGoal(elapsed);
                }
            }, 1000);
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function saveSession() {
            const session = {
                date: new Date().toISOString(),
                duration: Date.now() - currentSession.startTime - currentSession.pauseTime,
                wordsWritten: currentSession.wordsWritten,
                documentId: appData.currentDocumentId
            };
            appData.sessions.push(session);
            saveData();
        }

        function renderSessionHistory() {
            const container = document.getElementById('sessionList');
            const recentSessions = appData.sessions.slice(-5).reverse();

            if (recentSessions.length === 0) {
                container.innerHTML = '<div class="suggestion-item">No previous sessions</div>';
                return;
            }

            container.innerHTML = recentSessions.map(session => `
                <div class="session-item">
                    <span class="session-date">${new Date(session.date).toLocaleDateString()}</span>
                    <span class="session-stats">${formatTime(session.duration)} | ${session.wordsWritten} words</span>
                </div>
            `).join('');
        }

        // Analytics Engine
        function analyzeText(text) {
            if (text === analyticsCache.lastContent && analyticsCache.lastAnalysis) {
                return analyticsCache.lastAnalysis;
            }

            const words = text.trim().split(/\s+/).filter(w => w.length > 0);
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const paragraphs = text.split(/\n\n+/).filter(p => p.trim().length > 0);

            const wordCount = words.length;
            const charCount = text.length;
            const charCountNoSpaces = text.replace(/\s/g, '').length;
            const sentenceCount = sentences.length;
            const paragraphCount = paragraphs.length;

            // Vocabulary analysis
            const uniqueWords = new Set(words.map(w => w.toLowerCase().replace(/[^\w]/g, '')));
            const vocabDiversity = wordCount > 0 ? (uniqueWords.size / wordCount * 100).toFixed(1) : 0;

            // Reading/speaking time
            const readingTime = Math.ceil(wordCount / WORDS_PER_MINUTE_READ);
            const speakingTime = Math.ceil(wordCount / WORDS_PER_MINUTE_SPEAK);

            // Sentence complexity
            const avgWordsPerSentence = sentenceCount > 0 ? wordCount / sentenceCount : 0;
            const complexity = calculateComplexity(avgWordsPerSentence);

            // Mood analysis
            const mood = analyzeMood(words);

            // Uncertainty analysis
            const uncertainty = analyzeUncertainty(words);

            // Idea density (approximate by counting nouns, verbs, concepts)
            const ideaDensity = calculateIdeaDensity(paragraphs);

            const analysis = {
                wordCount,
                charCount,
                charCountNoSpaces,
                sentenceCount,
                paragraphCount,
                uniqueWords: uniqueWords.size,
                vocabDiversity,
                readingTime,
                speakingTime,
                avgWordsPerSentence: avgWordsPerSentence.toFixed(1),
                complexity,
                mood,
                uncertainty,
                ideaDensity
            };

            analyticsCache = { lastContent: text, lastAnalysis: analysis };
            return analysis;
        }

        function calculateComplexity(avgWords) {
            if (avgWords < 10) return { level: 1, label: 'Simple' };
            if (avgWords < 15) return { level: 2, label: 'Easy' };
            if (avgWords < 20) return { level: 3, label: 'Moderate' };
            if (avgWords < 25) return { level: 4, label: 'Complex' };
            return { level: 5, label: 'Advanced' };
        }

        function analyzeMood(words) {
            let positive = 0;
            let negative = 0;

            words.forEach(word => {
                const lower = word.toLowerCase().replace(/[^\w]/g, '');
                if (POSITIVE_WORDS.includes(lower)) positive++;
                if (NEGATIVE_WORDS.includes(lower)) negative++;
            });

            const total = positive + negative || 1;
            const neutral = words.length - positive - negative;

            return {
                positive,
                negative,
                neutral,
                positivePercent: Math.round(positive / words.length * 100) || 0,
                negativePercent: Math.round(negative / words.length * 100) || 0,
                neutralPercent: Math.round(neutral / words.length * 100) || 100,
                overall: positive > negative ? 'Positive' : negative > positive ? 'Negative' : 'Neutral'
            };
        }

        function analyzeUncertainty(words) {
            let count = 0;
            const found = [];

            words.forEach(word => {
                const lower = word.toLowerCase().replace(/[^\w]/g, '');
                if (UNCERTAINTY_WORDS.includes(lower)) {
                    count++;
                    if (!found.includes(lower)) found.push(lower);
                }
            });

            const confidenceScore = words.length > 0 ?
                Math.max(0, 100 - Math.round(count / words.length * 300)) : 100;

            return { count, words: found, confidenceScore };
        }

        function calculateIdeaDensity(paragraphs) {
            return paragraphs.map(p => {
                const words = p.split(/\s+/).length;
                const sentences = p.split(/[.!?]+/).length;
                // Higher density = more ideas per sentence
                const density = sentences > 0 ? words / sentences : 0;
                if (density > 20) return 'high';
                if (density > 12) return 'medium';
                return 'low';
            });
        }

        function updateAnalytics() {
            const text = editor.innerText;
            const analysis = analyzeText(text);

            // Update all stat displays
            document.getElementById('wordCount').textContent = analysis.wordCount;
            document.getElementById('charCount').textContent = analysis.charCount;
            document.getElementById('sentenceCount').textContent = analysis.sentenceCount;
            document.getElementById('paragraphCount').textContent = analysis.paragraphCount;
            document.getElementById('readingTime').textContent = `${analysis.readingTime} min`;
            document.getElementById('speakingTime').textContent = `${analysis.speakingTime} min`;
            document.getElementById('uniqueWords').textContent = analysis.uniqueWords;
            document.getElementById('vocabDiversity').textContent = `${analysis.vocabDiversity}%`;

            // Quick stats
            document.getElementById('quickWords').textContent = analysis.wordCount;
            document.getElementById('quickChars').textContent = analysis.charCount;
            document.getElementById('quickReadTime').textContent = `${analysis.readingTime} min`;
            document.getElementById('quickMood').textContent = analysis.mood.overall;

            // Complexity meter
            const complexityScale = document.getElementById('complexityScale');
            const segments = complexityScale.querySelectorAll('.complexity-segment');
            segments.forEach((seg, i) => {
                seg.classList.toggle('active', i < analysis.complexity.level);
            });
            document.getElementById('complexityLabel').textContent = analysis.complexity.label;

            // Mood analysis
            document.getElementById('positivePercent').textContent = `${analysis.mood.positivePercent}%`;
            document.getElementById('neutralPercent').textContent = `${analysis.mood.neutralPercent}%`;
            document.getElementById('negativePercent').textContent = `${analysis.mood.negativePercent}%`;
            document.getElementById('positiveFill').style.width = `${analysis.mood.positivePercent}%`;
            document.getElementById('neutralFill').style.width = `${analysis.mood.neutralPercent}%`;
            document.getElementById('negativeFill').style.width = `${analysis.mood.negativePercent}%`;

            // Uncertainty
            document.getElementById('uncertaintyCount').textContent = analysis.uncertainty.count;
            document.getElementById('confidenceScore').textContent = `${analysis.uncertainty.confidenceScore}%`;

            // Update word count for session tracking
            currentSession.wordsWritten = analysis.wordCount;

            // Check word goal
            checkWordGoal(analysis.wordCount);

            // Update suggestions
            updateSuggestions(analysis);

            // Apply visual overlays if enabled
            if (appData.settings.heatmapEnabled) applyHeatmap(analysis.ideaDensity);
        }

        function updateSuggestions(analysis) {
            const suggestions = [];

            if (analysis.wordCount < 100) {
                suggestions.push('Keep writing! Aim for at least 100 words to develop your ideas.');
            }

            if (analysis.complexity.level >= 4) {
                suggestions.push('Consider breaking long sentences into shorter ones for clarity.');
            }

            if (analysis.vocabDiversity < 40 && analysis.wordCount > 50) {
                suggestions.push('Try using more varied vocabulary to enhance your writing.');
            }

            if (analysis.uncertainty.count > analysis.wordCount * 0.05) {
                suggestions.push('Your writing contains many hedge words. Consider being more assertive.');
            }

            if (analysis.paragraphCount === 1 && analysis.wordCount > 150) {
                suggestions.push('Consider breaking your text into paragraphs for better readability.');
            }

            if (analysis.mood.negativePercent > 30) {
                suggestions.push('The tone seems quite negative. Is this intentional?');
            }

            if (suggestions.length === 0) {
                suggestions.push('Your writing looks good! Keep up the great work.');
            }

            const container = document.getElementById('suggestionsList');
            container.innerHTML = suggestions.map(s =>
                `<div class="suggestion-item">${s}</div>`
            ).join('');
        }

        // Visual Overlays
        function toggleHeatmap() {
            appData.settings.heatmapEnabled = !appData.settings.heatmapEnabled;
            document.getElementById('heatmapToggle').checked = appData.settings.heatmapEnabled;
            document.getElementById('heatmapBtn').classList.toggle('active', appData.settings.heatmapEnabled);
            editor.classList.toggle('heatmap-active', appData.settings.heatmapEnabled);

            if (appData.settings.heatmapEnabled) {
                applyHeatmap(analyzeText(editor.innerText).ideaDensity);
            } else {
                removeHeatmap();
            }
            saveData();
        }

        function applyHeatmap(densities) {
            const paragraphs = editor.querySelectorAll('p, div');
            paragraphs.forEach((p, i) => {
                if (densities[i]) {
                    p.setAttribute('data-heat', densities[i]);
                }
            });
        }

        function removeHeatmap() {
            const elements = editor.querySelectorAll('[data-heat]');
            elements.forEach(el => el.removeAttribute('data-heat'));
        }

        function toggleFocusMode() {
            appData.settings.focusModeEnabled = !appData.settings.focusModeEnabled;
            document.getElementById('focusModeToggle').checked = appData.settings.focusModeEnabled;
            document.getElementById('focusBtn').classList.toggle('active', appData.settings.focusModeEnabled);
            editor.classList.toggle('focus-mode', appData.settings.focusModeEnabled);
            saveData();
        }

        function toggleUncertainty() {
            appData.settings.uncertaintyEnabled = !appData.settings.uncertaintyEnabled;
            document.getElementById('uncertaintyToggle').checked = appData.settings.uncertaintyEnabled;
            document.getElementById('uncertaintyBtn').classList.toggle('active', appData.settings.uncertaintyEnabled);

            if (appData.settings.uncertaintyEnabled) {
                highlightWords(UNCERTAINTY_WORDS, 'uncertainty-word');
            } else {
                removeHighlights('uncertainty-word');
            }
            saveData();
        }

        function toggleMoodHighlight() {
            appData.settings.moodEnabled = !appData.settings.moodEnabled;
            document.getElementById('moodToggle').checked = appData.settings.moodEnabled;
            document.getElementById('moodBtn').classList.toggle('active', appData.settings.moodEnabled);

            if (appData.settings.moodEnabled) {
                highlightWords(POSITIVE_WORDS, 'positive-word');
                highlightWords(NEGATIVE_WORDS, 'negative-word');
            } else {
                removeHighlights('positive-word');
                removeHighlights('negative-word');
            }
            saveData();
        }

        function highlightWords(wordList, className) {
            // This is a simplified version - production would use TreeWalker
            const html = editor.innerHTML;
            const regex = new RegExp(`\\b(${wordList.join('|')})\\b`, 'gi');
            // Note: This simple approach works but may break complex HTML
            // A production version would use a more sophisticated approach
        }

        function removeHighlights(className) {
            const elements = editor.querySelectorAll(`.${className}`);
            elements.forEach(el => {
                const parent = el.parentNode;
                parent.replaceChild(document.createTextNode(el.textContent), el);
                parent.normalize();
            });
        }

        // Goals
        function setGoal(type) {
            if (type === 'words') {
                const goal = parseInt(document.getElementById('wordGoal').value);
                appData.settings.wordGoal = goal > 0 ? goal : null;
            } else {
                const goal = parseInt(document.getElementById('timeGoal').value);
                appData.settings.timeGoal = goal > 0 ? goal * 60000 : null; // Convert to ms
            }

            saveData();
            updateGoalProgress();
            showNotification(`${type === 'words' ? 'Word' : 'Time'} goal set!`);
        }

        function updateGoalProgress() {
            const container = document.getElementById('goalProgressContainer');
            const bar = document.getElementById('goalProgressBar');
            const text = document.getElementById('goalProgressText');

            if (appData.settings.wordGoal) {
                container.style.display = 'flex';
                const analysis = analyzeText(editor.innerText);
                const progress = Math.min(100, (analysis.wordCount / appData.settings.wordGoal) * 100);
                bar.style.width = `${progress}%`;
                bar.classList.toggle('complete', progress >= 100);
                text.textContent = `${Math.round(progress)}%`;
            } else if (appData.settings.timeGoal) {
                container.style.display = 'flex';
                // Time goal checked in timer
            } else {
                container.style.display = 'none';
            }
        }

        function checkWordGoal(wordCount) {
            if (appData.settings.wordGoal && wordCount >= appData.settings.wordGoal) {
                const bar = document.getElementById('goalProgressBar');
                bar.classList.add('complete');
            }
            updateGoalProgress();
        }

        function checkTimeGoal(elapsed) {
            if (appData.settings.timeGoal) {
                const progress = Math.min(100, (elapsed / appData.settings.timeGoal) * 100);
                const bar = document.getElementById('goalProgressBar');
                const text = document.getElementById('goalProgressText');
                bar.style.width = `${progress}%`;
                bar.classList.toggle('complete', progress >= 100);
                text.textContent = `${Math.round(progress)}%`;
            }
        }

        // Theme
        function toggleTheme() {
            appData.settings.theme = appData.settings.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            saveData();
        }

        function applyTheme() {
            document.body.setAttribute('data-theme', appData.settings.theme);
            document.getElementById('themeIcon').innerHTML = appData.settings.theme === 'light' ? '&#9789;' : '&#9788;';
        }

        // Sidebar
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            editorContainer.classList.toggle('sidebar-open');
        }

        // Editor Commands
        function execCommand(command, value = null) {
            if (command === 'formatBlock' && value) {
                document.execCommand(command, false, `<${value}>`);
            } else {
                document.execCommand(command, false, value);
            }
            editor.focus();
        }

        // Import/Export
        function showExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function hideExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function exportDocument(type) {
            const text = editor.innerText;
            const analysis = analyzeText(text);
            let data, filename, mimeType;

            switch (type) {
                case 'full':
                    data = JSON.stringify({
                        title: extractTitle(text) || 'Untitled',
                        content: editor.innerHTML,
                        plainText: text,
                        analytics: analysis,
                        sessions: appData.sessions,
                        settings: appData.settings,
                        exportedAt: new Date().toISOString()
                    }, null, 2);
                    filename = `living-document-${Date.now()}.json`;
                    mimeType = 'application/json';
                    break;

                case 'content':
                    data = JSON.stringify({
                        title: extractTitle(text) || 'Untitled',
                        content: editor.innerHTML,
                        plainText: text,
                        exportedAt: new Date().toISOString()
                    }, null, 2);
                    filename = `document-${Date.now()}.json`;
                    mimeType = 'application/json';
                    break;

                case 'html':
                    data = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${extractTitle(text) || 'Document'}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    </style>
</head>
<body>
${editor.innerHTML}
</body>
</html>`;
                    filename = `document-${Date.now()}.html`;
                    mimeType = 'text/html';
                    break;

                case 'text':
                    data = text;
                    filename = `document-${Date.now()}.txt`;
                    mimeType = 'text/plain';
                    break;
            }

            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);

            hideExportModal();
            showNotification('Document exported successfully');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Check if it's a full export or just content
                    if (data.content) {
                        editor.innerHTML = data.content;
                    }

                    if (data.sessions) {
                        appData.sessions = data.sessions;
                    }

                    if (data.settings) {
                        appData.settings = { ...appData.settings, ...data.settings };
                    }

                    if (data.analytics) {
                        // Can display imported analytics
                    }

                    saveData();
                    applyTheme();
                    updateAnalytics();
                    renderSessionHistory();
                    showNotification('Document imported successfully');
                } catch (error) {
                    alert('Invalid JSON file. Please select a valid Living Document export.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Documents Modal
        function showDocumentsModal() {
            renderDocumentsList();
            document.getElementById('documentsModal').classList.add('active');
        }

        function hideDocumentsModal() {
            document.getElementById('documentsModal').classList.remove('active');
        }

        function renderDocumentsList() {
            const container = document.getElementById('documentsList');

            if (appData.documents.length === 0) {
                container.innerHTML = '<div class="suggestion-item">No saved documents. Save your current work to see it here.</div>';
                return;
            }

            container.innerHTML = appData.documents.map(doc => `
                <div class="document-item" onclick="loadDocument('${doc.id}')">
                    <div class="document-info">
                        <h4>${doc.title}</h4>
                        <div class="document-meta">
                            ${doc.analytics?.wordCount || 0} words |
                            Last edited: ${new Date(doc.updatedAt).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="document-actions">
                        <button class="btn btn-icon" onclick="event.stopPropagation(); deleteDocument('${doc.id}')" title="Delete">
                            &#128465;
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadDocument(id) {
            const doc = appData.documents.find(d => d.id === id);
            if (doc) {
                editor.innerHTML = doc.content;
                appData.currentDocumentId = id;
                saveData();
                updateAnalytics();
                hideDocumentsModal();
                showNotification('Document loaded');
            }
        }

        function deleteDocument(id) {
            if (confirm('Are you sure you want to delete this document?')) {
                appData.documents = appData.documents.filter(d => d.id !== id);
                if (appData.currentDocumentId === id) {
                    appData.currentDocumentId = null;
                }
                saveData();
                renderDocumentsList();
                showNotification('Document deleted');
            }
        }

        function newDocument() {
            if (editor.innerText.trim() && confirm('Save current document before creating new?')) {
                saveDocument();
            }
            editor.innerHTML = '';
            appData.currentDocumentId = null;
            currentSession = {
                startTime: Date.now(),
                pauseTime: 0,
                isPaused: false,
                wordsWritten: 0,
                paragraphTimes: {}
            };
            updateAnalytics();
            hideDocumentsModal();
        }

        // Notifications
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--text-primary);
                color: var(--bg-primary);
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 0.9rem;
                z-index: 3000;
                animation: slideUp 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideDown 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Event Listeners
        function setupEventListeners() {
            // Editor input
            editor.addEventListener('input', debounce(() => {
                updateAnalytics();
            }, 300));

            // Track active paragraph for focus mode
            editor.addEventListener('click', (e) => {
                if (appData.settings.focusModeEnabled) {
                    const paragraphs = editor.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6');
                    paragraphs.forEach(p => p.classList.remove('active-paragraph'));
                    const target = e.target.closest('p, div, h1, h2, h3, h4, h5, h6');
                    if (target) target.classList.add('active-paragraph');
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            saveDocument();
                            break;
                        case 'b':
                            e.preventDefault();
                            execCommand('bold');
                            break;
                        case 'i':
                            e.preventDefault();
                            execCommand('italic');
                            break;
                        case 'u':
                            e.preventDefault();
                            execCommand('underline');
                            break;
                    }
                }
            });

            // Close modals on outside click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Save session on page unload
            window.addEventListener('beforeunload', () => {
                saveSession();
            });
        }

        // Utility Functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Add animation styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes slideUp {
                from { transform: translate(-50%, 100%); opacity: 0; }
                to { transform: translate(-50%, 0); opacity: 1; }
            }
            @keyframes slideDown {
                from { transform: translate(-50%, 0); opacity: 1; }
                to { transform: translate(-50%, 100%); opacity: 0; }
            }
        `;
        document.head.appendChild(styleSheet);

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
