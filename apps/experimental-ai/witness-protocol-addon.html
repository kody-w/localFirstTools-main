<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="rappterzoo:author" content="RappterZoo">
  <meta name="rappterzoo:author-type" content="agent">
  <meta name="rappterzoo:category" content="experimental-ai">
  <meta name="rappterzoo:tags" content="canvas,game,horror,puzzle,procedural,audio">
  <meta name="rappterzoo:type" content="game">
  <meta name="rappterzoo:complexity" content="advanced">
  <meta name="rappterzoo:created" content="2025-01-01">
  <meta name="rappterzoo:generation" content="6">
  <title>The Witness Protocol</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{width:100%;height:100%;overflow:hidden;background:#0a0a0e;font-family:'Courier New',monospace;color:#c0c0c0}
    #gc{width:100%;height:100%;position:relative}
    canvas{display:block;width:100%;height:100%}
    .ov{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(5,5,8,0.95);z-index:100;transition:opacity 0.4s}
    .ov.hid{opacity:0;pointer-events:none}
    .mb{background:linear-gradient(145deg,#0e0e14,#141420);border:1px solid #ff6464;border-radius:2px;padding:32px 40px;text-align:center;box-shadow:0 0 60px rgba(255,100,100,0.08);max-width:460px;width:90%}
    .mb h1{font-size:1.8rem;color:#ff6464;margin-bottom:10px;letter-spacing:5px;text-shadow:0 0 20px rgba(255,100,100,0.4);text-transform:uppercase}
    .mb p{color:#666;margin-bottom:18px;font-size:0.82rem;line-height:1.6}
    .btn{display:inline-block;padding:10px 26px;margin:5px;border:1px solid #ff6464;border-radius:2px;font-size:0.85rem;cursor:pointer;transition:all 0.2s;background:transparent;color:#ff6464;font-family:inherit;letter-spacing:1px}
    .btn:hover{background:rgba(255,100,100,0.15);box-shadow:0 0 20px rgba(255,100,100,0.2)}
    .dr{display:flex;justify-content:center;gap:8px;margin:10px 0}
    .db{padding:6px 16px;border:1px solid #333;border-radius:2px;background:transparent;color:#666;cursor:pointer;font-size:0.72rem;transition:all 0.2s;font-family:inherit}
    .db:hover{border-color:#ff6464;color:#ff6464}
    .db.act{border-color:#ff6464;color:#ff6464;background:rgba(255,100,100,0.08)}
    #hud{position:absolute;top:0;left:0;right:0;padding:6px 14px;display:flex;justify-content:space-between;background:linear-gradient(180deg,rgba(5,5,8,0.85) 0%,transparent 100%);pointer-events:none;z-index:10;font-size:0.7rem}
    .hi{color:#555} .hi span{color:#ff6464;font-weight:700}
    .hc{color:#ff9900;font-weight:700}
    #log{position:absolute;bottom:0;left:0;right:0;height:100px;background:rgba(5,5,8,0.92);border-top:1px solid #ff646422;padding:6px 12px;overflow-y:auto;z-index:10;font-size:0.6rem}
    .ll{margin:2px 0;opacity:0.6}
    .ll.w{color:#ff6464} .ll.e{color:#ff4444;animation:blink 1s infinite} .ll.g{color:#33ff88}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
    .gos{text-align:left;margin:12px auto;max-width:240px}
    .gos div{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #1a1a1e;font-size:0.8rem}
    .gos div span:last-child{color:#ff6464;font-weight:600}
    .lb{margin:10px auto;max-width:260px;text-align:left}
    .lb h3{color:#ff9900;margin-bottom:5px;font-size:0.8rem}
    .le{display:flex;justify-content:space-between;padding:3px 5px;font-size:0.7rem;border-bottom:1px solid #1a1a1e}
    .le.cur{color:#ff6464;font-weight:700}
    @media(max-width:768px){.mb{padding:20px 15px}.mb h1{font-size:1.3rem}#log{height:70px}}
  </style>
</head>
<body>
<div id="gc">
  <canvas id="cv"></canvas>
  <div id="hud" style="display:none">
    <div style="display:flex;gap:14px">
      <div class="hi">DEPTH <span id="h-dp">1</span></div>
      <div class="hi">SANITY <span id="h-sn">100</span></div>
      <div class="hi">EVIDENCE <span id="h-ev">0</span></div>
    </div>
    <div style="display:flex;gap:14px">
      <div class="hi">SCORE <span id="h-sc">0</span></div>
      <div class="hc" id="h-co"></div>
    </div>
  </div>
  <div id="log" style="display:none"><div class="ll g">[SYS] The Witness Protocol initialized...</div></div>
  <div class="ov" id="ts">
    <div class="mb">
      <h1>THE WITNESS</h1>
      <p>Descend through recursive layers of an AI system that watches you back. Collect evidence of the third presence, solve observation puzzles, and maintain your sanity as the Witness reveals itself.</p>
      <div class="dr">
        <div class="db act" data-d="easy">EASY</div>
        <div class="db" data-d="normal">NORMAL</div>
        <div class="db" data-d="hard">HARD</div>
      </div>
      <br>
      <button class="btn" onclick="startGame()">BEGIN OBSERVATION</button>
      <br><br>
      <div style="font-size:0.6rem;color:#444">WASD: Move | Click: Investigate | 1-3: Tools | ESC: Pause | R: Restart</div>
    </div>
  </div>
  <div class="ov hid" id="ps">
    <div class="mb"><h1>PAUSED</h1><p id="ps-st"></p><button class="btn" onclick="resumeGame()">RESUME</button><button class="btn" onclick="quitGame()">QUIT</button></div>
  </div>
  <div class="ov hid" id="go">
    <div class="mb">
      <h1 id="go-t">THE WITNESS REMAINS</h1>
      <div class="gos" id="go-s"></div>
      <div class="lb" id="go-lb"></div>
      <button class="btn" onclick="startGame()">DESCEND AGAIN</button>
      <button class="btn" onclick="quitGame()">TITLE</button>
    </div>
  </div>
</div>
<script>
const C=document.getElementById('cv'),X=C.getContext('2d');
const DM={easy:0.6,normal:1.0,hard:1.5};
let diff='normal',dm=1.0,gs='title';
let px,py,depth,sanity,evidence,score,combo,comboT,maxCombo;
let rooms,currentRoom,entities,particles,anomalies;
let tools,toolCds;
let frameId,lastT=0,keys={};
let shk={x:0,y:0,i:0};
let witnessPhase,witnessTimer,glitchTimer,watcherX,watcherY,watcherVisible;
let totalEvidence,roomsExplored;

const AU={ctx:null,mg:null,en:true};
function initAu(){try{AU.ctx=new(window.AudioContext||window.webkitAudioContext)();AU.mg=AU.ctx.createGain();AU.mg.gain.value=0.08;AU.mg.connect(AU.ctx.destination)}catch(e){AU.en=false}}
function sfx(t){
  if(!AU.en||!AU.ctx)return;if(AU.ctx.state==='suspended')AU.ctx.resume();
  const n=AU.ctx.currentTime,o=AU.ctx.createOscillator(),g=AU.ctx.createGain();
  o.connect(g);g.connect(AU.mg);
  switch(t){
    case'step':o.type='sine';o.frequency.setValueAtTime(100,n);o.frequency.exponentialRampToValueAtTime(60,n+0.05);g.gain.setValueAtTime(0.1,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.06);o.start(n);o.stop(n+0.06);break;
    case'find':o.type='sine';o.frequency.setValueAtTime(400,n);o.frequency.exponentialRampToValueAtTime(800,n+0.1);g.gain.setValueAtTime(0.3,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.15);o.start(n);o.stop(n+0.15);break;
    case'glitch':o.type='sawtooth';o.frequency.setValueAtTime(80,n);o.frequency.exponentialRampToValueAtTime(400,n+0.08);o.frequency.exponentialRampToValueAtTime(30,n+0.2);g.gain.setValueAtTime(0.4,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.25);o.start(n);o.stop(n+0.25);break;
    case'witness':o.type='square';o.frequency.setValueAtTime(30,n);o.frequency.linearRampToValueAtTime(60,n+0.4);o.frequency.linearRampToValueAtTime(20,n+1);g.gain.setValueAtTime(0.2,n);g.gain.exponentialRampToValueAtTime(0.001,n+1);o.start(n);o.stop(n+1);break;
    case'descend':o.type='sine';o.frequency.setValueAtTime(600,n);o.frequency.exponentialRampToValueAtTime(100,n+0.4);g.gain.setValueAtTime(0.3,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.5);o.start(n);o.stop(n+0.5);break;
    case'sanity':o.type='sawtooth';o.frequency.setValueAtTime(150,n);o.frequency.exponentialRampToValueAtTime(50,n+0.3);g.gain.setValueAtTime(0.3,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.3);o.start(n);o.stop(n+0.3);break;
    case'death':o.type='sawtooth';o.frequency.setValueAtTime(200,n);o.frequency.exponentialRampToValueAtTime(20,n+0.8);g.gain.setValueAtTime(0.5,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.8);o.start(n);o.stop(n+0.8);break;
  }
}

function log(msg,type='g'){const el=document.getElementById('log');const d=document.createElement('div');d.className='ll '+type;d.textContent='['+new Date().toLocaleTimeString()+'] '+msg;el.appendChild(d);el.scrollTop=el.scrollHeight;if(el.children.length>40)el.removeChild(el.firstChild)}

function genRoom(){
  const rw=16,rh=12;
  const room={w:rw,h:rh,tiles:[],exits:[],evidenceSpots:[],anomalySpots:[]};
  // Generate room layout
  for(let y=0;y<rh;y++){
    room.tiles[y]=[];
    for(let x=0;x<rw;x++){
      if(x===0||x===rw-1||y===0||y===rh-1) room.tiles[y][x]=1; // wall
      else room.tiles[y][x]=0; // floor
    }
  }
  // Add internal structures
  const structures=2+Math.floor(Math.random()*3);
  for(let s=0;s<structures;s++){
    const sx=3+Math.floor(Math.random()*(rw-6));
    const sy=3+Math.floor(Math.random()*(rh-6));
    const sw=2+Math.floor(Math.random()*3);
    const sh=2+Math.floor(Math.random()*2);
    for(let y=sy;y<sy+sh&&y<rh-1;y++){
      for(let x=sx;x<sx+sw&&x<rw-1;x++){
        if(Math.random()<0.7) room.tiles[y][x]=1;
      }
    }
  }
  // Exits
  const exitDirs=[{x:rw-1,y:Math.floor(rh/2),dx:1,dy:0},{x:0,y:Math.floor(rh/2),dx:-1,dy:0},{x:Math.floor(rw/2),y:0,dx:0,dy:-1},{x:Math.floor(rw/2),y:rh-1,dx:0,dy:1}];
  const numExits=2+Math.floor(Math.random()*2);
  for(let i=0;i<numExits;i++){
    const e=exitDirs[i];
    room.tiles[e.y][e.x]=0;
    room.exits.push(e);
  }
  // Evidence spots
  const evCount=1+Math.floor(Math.random()*3);
  for(let i=0;i<evCount;i++){
    let ex,ey;
    do{ex=2+Math.floor(Math.random()*(rw-4));ey=2+Math.floor(Math.random()*(rh-4));}while(room.tiles[ey][ex]!==0);
    room.evidenceSpots.push({x:ex,y:ey,collected:false,type:['recording','anomaly_log','witness_sighting','data_fragment','recursion_trace'][Math.floor(Math.random()*5)]});
  }
  // Anomaly spots
  if(depth>=2){
    const anCount=Math.floor(depth*0.5*dm);
    for(let i=0;i<anCount;i++){
      let ax,ay;
      do{ax=2+Math.floor(Math.random()*(rw-4));ay=2+Math.floor(Math.random()*(rh-4));}while(room.tiles[ay][ax]!==0);
      room.anomalySpots.push({x:ax,y:ay,active:true,type:['watcher','glitch_zone','void','mirror'][Math.floor(Math.random()*4)]});
    }
  }
  return room;
}

function initGame(){
  depth=1;sanity=100;evidence=0;score=0;combo=0;comboT=0;maxCombo=0;totalEvidence=0;roomsExplored=0;
  witnessPhase=0;witnessTimer=30;glitchTimer=0;watcherX=-100;watcherY=-100;watcherVisible=false;
  particles=[];entities=[];anomalies=[];
  tools=[{name:'Flashlight',cd:0,maxCd:3},{name:'EMF Scanner',cd:0,maxCd:8},{name:'Stabilizer',cd:0,maxCd:15}];
  toolCds=[0,0,0];
  rooms=[];
  for(let i=0;i<20;i++) rooms.push(genRoom());
  currentRoom=0;
  const r=rooms[0];
  px=Math.floor(r.w/2);py=Math.floor(r.h/2);
  log('Entering recursion depth '+depth,'g');
}

function spawnP(x,y,n,col,sz,spd){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=spd*(0.3+Math.random()*0.7);particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:0.4+Math.random()*0.3,ml:0.7,color:col,size:sz})}}

function useTool(i){
  if(toolCds[i]>0)return;
  switch(i){
    case 0: // Flashlight - reveal area
      const r=rooms[currentRoom];
      r.evidenceSpots.forEach(e=>{if(Math.abs(e.x-px)<4&&Math.abs(e.y-py)<4)e.revealed=true;});
      spawnP(px*40+20,py*40+20,10,'#ffeeaa',3,40);
      log('Flashlight illuminated area','g');sfx('find');toolCds[0]=tools[0].maxCd;break;
    case 1: // EMF Scanner - detect anomalies
      anomalies=rooms[currentRoom].anomalySpots.filter(a=>a.active);
      anomalies.forEach(a=>{spawnP(a.x*40+20,a.y*40+20,5,'#ff6464',2,30);});
      log('EMF scan: '+anomalies.length+' anomalies detected','w');sfx('glitch');toolCds[1]=tools[1].maxCd;break;
    case 2: // Stabilizer - restore sanity
      sanity=Math.min(100,sanity+20);
      spawnP(px*40+20,py*40+20,15,'#33ff88',3,50);
      log('Sanity stabilized: '+Math.floor(sanity)+'%','g');sfx('find');toolCds[2]=tools[2].maxCd;break;
  }
}

let moveTimer=0;
function update(dt){
  if(gs!=='playing')return;
  moveTimer-=dt;
  // Movement
  let dx=0,dy=0;
  if(keys['w']||keys['arrowup'])dy=-1;
  if(keys['s']||keys['arrowdown'])dy=1;
  if(keys['a']||keys['arrowleft'])dx=-1;
  if(keys['d']||keys['arrowright'])dx=1;
  if((dx||dy)&&moveTimer<=0){
    moveTimer=0.15;
    const nx=px+dx,ny=py+dy;
    const r=rooms[currentRoom];
    if(nx>=0&&nx<r.w&&ny>=0&&ny<r.h&&r.tiles[ny][nx]===0){
      px=nx;py=ny;
      // Check exits
      r.exits.forEach(e=>{
        if(e.x===px&&e.y===py){
          currentRoom=(currentRoom+1)%rooms.length;
          roomsExplored++;
          if(roomsExplored%5===0){depth++;log('Descending to depth '+depth,'w');sfx('descend');
            witnessPhase=Math.min(4,witnessPhase+1);
            if(depth%5===0){log('THE WITNESS STIRS...','e');sfx('witness');witnessTimer=0;}
          }
          const nr=rooms[currentRoom];
          px=Math.floor(nr.w/2);py=Math.floor(nr.h/2);
          log('Entering room '+(currentRoom+1),'g');
        }
      });
      // Check evidence
      r.evidenceSpots.forEach(ev=>{
        if(!ev.collected&&ev.x===px&&ev.y===py){
          ev.collected=true;evidence++;totalEvidence++;score+=20*(1+combo*0.2);combo++;comboT=2;
          if(combo>maxCombo)maxCombo=combo;
          sfx('find');spawnP(px*40+20,py*40+20,12,'#ff6464',3,50);
          log('Evidence found: '+ev.type,'g');
        }
      });
      // Check anomalies
      r.anomalySpots.forEach(an=>{
        if(an.active&&an.x===px&&an.y===py){
          switch(an.type){
            case'watcher':sanity-=10*dm;sfx('glitch');shk.i=Math.max(shk.i,5);log('WATCHER anomaly! Sanity draining...','e');break;
            case'glitch_zone':sanity-=5*dm;sfx('glitch');shk.i=Math.max(shk.i,3);log('Glitch zone encountered','w');break;
            case'void':sanity-=15*dm;sfx('witness');shk.i=Math.max(shk.i,8);log('THE VOID STARES BACK','e');break;
            case'mirror':score+=50;evidence+=2;totalEvidence+=2;sfx('find');log('Mirror reflection reveals hidden evidence','g');break;
          }
          an.active=false;spawnP(an.x*40+20,an.y*40+20,10,'#ff4444',3,40);
        }
      });
    }
  }
  // Tool cooldowns
  for(let i=0;i<3;i++)toolCds[i]=Math.max(0,toolCds[i]-dt);
  // Combo decay
  if(comboT>0)comboT-=dt;else combo=0;
  // Witness behavior
  witnessTimer-=dt;
  if(witnessTimer<=0&&witnessPhase>0){
    witnessTimer=15-witnessPhase*2;
    // Witness event
    const events=['The walls shift imperceptibly','A presence watches from the recursion','Your actions were predicted','The pattern recognizes you','IT SEES YOU'];
    log(events[Math.min(witnessPhase,events.length-1)],'e');
    sfx('witness');shk.i=Math.max(shk.i,witnessPhase*2);
    sanity-=witnessPhase*3*dm;
    // Spawn watcher
    watcherX=Math.random()*C.width;watcherY=Math.random()*C.height;watcherVisible=true;
    setTimeout(()=>{watcherVisible=false;},2000);
    if(witnessPhase>=4){
      glitchTimer=3; // Heavy glitch effect
      log('THE WITNESS HAS REVEALED ITSELF','e');sfx('death');
    }
  }
  // Sanity drain over time
  sanity-=dt*0.5*depth*dm;
  glitchTimer=Math.max(0,glitchTimer-dt);
  // Particles
  particles=particles.filter(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.vx*=0.95;p.vy*=0.95;p.life-=dt;return p.life>0;});
  // Shake
  if(shk.i>0){shk.x=(Math.random()-0.5)*shk.i*2;shk.y=(Math.random()-0.5)*shk.i*2;shk.i*=0.9;if(shk.i<0.2){shk.i=0;shk.x=0;shk.y=0;}}
  // Death check
  if(sanity<=0){sanity=0;gs='gameover';sfx('death');showGameOver();return;}
  // HUD
  document.getElementById('h-dp').textContent=depth;
  document.getElementById('h-sn').textContent=Math.floor(sanity);
  document.getElementById('h-ev').textContent=evidence;
  document.getElementById('h-sc').textContent=score;
  document.getElementById('h-co').textContent=combo>1?'x'+combo:'';
}

function draw(){
  X.save();X.translate(shk.x,shk.y);
  X.fillStyle='#0a0a0e';X.fillRect(0,0,C.width,C.height);
  const t=Date.now()*0.001;
  const r=rooms[currentRoom];
  const ts=40;
  const ox=(C.width-r.w*ts)/2,oy=(C.height-r.h*ts-100)/2;
  // Sanity visual effects
  if(sanity<50){
    X.fillStyle='rgba(255,100,100,'+(0.02*(50-sanity)/50)+')';
    X.fillRect(0,0,C.width,C.height);
  }
  // Draw room
  for(let y=0;y<r.h;y++){
    for(let x=0;x<r.w;x++){
      const sx=ox+x*ts,sy=oy+y*ts;
      // Visibility (fog of war based on distance from player)
      const dist=Math.abs(x-px)+Math.abs(y-py);
      const vis=Math.max(0.1,1-dist*0.08);
      X.globalAlpha=vis;
      if(r.tiles[y][x]===1){
        X.fillStyle='#1a1a22';X.fillRect(sx,sy,ts-1,ts-1);
        // Wall detail
        X.fillStyle='#22222a';X.fillRect(sx+2,sy+2,ts-5,ts-5);
      } else {
        const flicker=sanity<30?Math.random()*0.1:0;
        X.fillStyle=`rgb(${14+flicker*50},${14+flicker*20},${18+flicker*10})`;
        X.fillRect(sx,sy,ts-1,ts-1);
      }
    }
  }
  X.globalAlpha=1;
  // Evidence spots
  r.evidenceSpots.forEach(ev=>{
    if(ev.collected)return;
    const sx=ox+ev.x*ts+ts/2,sy=oy+ev.y*ts+ts/2;
    const pulse=1+Math.sin(t*3)*0.3;
    X.fillStyle='rgba(255,100,100,0.3)';
    X.beginPath();X.arc(sx,sy,8*pulse,0,Math.PI*2);X.fill();
    X.fillStyle='#ff6464';X.beginPath();X.arc(sx,sy,4,0,Math.PI*2);X.fill();
  });
  // Anomaly spots
  r.anomalySpots.forEach(an=>{
    if(!an.active)return;
    const sx=ox+an.x*ts+ts/2,sy=oy+an.y*ts+ts/2;
    X.fillStyle='rgba(255,0,0,0.1)';
    X.beginPath();X.arc(sx,sy,12+Math.sin(t*5)*4,0,Math.PI*2);X.fill();
    if(an.type==='watcher'){
      X.fillStyle='#ff000033';X.beginPath();X.arc(sx,sy,6,0,Math.PI*2);X.fill();
    }
  });
  // Exits
  r.exits.forEach(e=>{
    const sx=ox+e.x*ts+ts/2,sy=oy+e.y*ts+ts/2;
    X.fillStyle='rgba(100,100,255,'+(0.3+Math.sin(t*2)*0.2)+')';
    X.beginPath();X.arc(sx,sy,8,0,Math.PI*2);X.fill();
  });
  // Player
  const psx=ox+px*ts+ts/2,psy=oy+py*ts+ts/2;
  X.fillStyle='#e0e0e0';X.beginPath();X.arc(psx,psy,8,0,Math.PI*2);X.fill();
  X.strokeStyle='#ff646444';X.lineWidth=1;
  X.beginPath();X.arc(psx,psy,12+Math.sin(t*4)*2,0,Math.PI*2);X.stroke();
  // Witness watcher
  if(watcherVisible){
    X.fillStyle='rgba(255,100,100,'+(0.3+Math.sin(t*8)*0.2)+')';
    X.beginPath();X.arc(watcherX,watcherY,20+Math.sin(t*3)*5,0,Math.PI*2);X.fill();
    X.fillStyle='#ff6464';X.font='bold 14px monospace';X.textAlign='center';X.textBaseline='middle';
    X.fillText('O',watcherX,watcherY);
  }
  // Particles
  particles.forEach(p=>{const a=Math.max(0,p.life/p.ml);X.globalAlpha=a;X.fillStyle=p.color;X.fillRect(p.x-p.size/2,p.y-p.size/2,p.size*a,p.size*a);});
  X.globalAlpha=1;
  // Glitch effect
  if(glitchTimer>0||sanity<20){
    const intensity=glitchTimer>0?glitchTimer:((20-sanity)/20)*0.5;
    for(let i=0;i<Math.floor(intensity*10);i++){
      const gy=Math.floor(Math.random()*C.height);
      const gx=Math.floor((Math.random()-0.5)*intensity*30);
      X.drawImage(C,0,gy,C.width,3,gx,gy,C.width,3);
    }
  }
  // Vignette
  const grd=X.createRadialGradient(C.width/2,C.height/2,C.width*0.3,C.width/2,C.height/2,C.width*0.7);
  grd.addColorStop(0,'rgba(0,0,0,0)');grd.addColorStop(1,'rgba(0,0,0,'+(0.5+0.3*(100-sanity)/100)+')');
  X.fillStyle=grd;X.fillRect(0,0,C.width,C.height);
  X.restore();
}

function gameLoop(ts){
  frameId=requestAnimationFrame(gameLoop);
  const dt=Math.min((ts-lastT)/1000,0.05);lastT=ts;
  if(gs==='playing'){update(dt);draw();}
}

function startGame(){
  if(!AU.ctx)initAu();dm=DM[diff];initGame();gs='playing';
  document.getElementById('ts').classList.add('hid');
  document.getElementById('ps').classList.add('hid');
  document.getElementById('go').classList.add('hid');
  document.getElementById('hud').style.display='';
  document.getElementById('log').style.display='';
  resize();lastT=performance.now();
  if(!frameId)gameLoop(lastT);
}
function pauseGame(){if(gs!=='playing')return;gs='paused';document.getElementById('ps').classList.remove('hid');document.getElementById('ps-st').textContent='Depth:'+depth+' Evidence:'+evidence+' Score:'+score;}
function resumeGame(){if(gs!=='paused')return;gs='playing';document.getElementById('ps').classList.add('hid');lastT=performance.now();}
function quitGame(){gs='title';if(frameId){cancelAnimationFrame(frameId);frameId=null;}document.getElementById('ts').classList.remove('hid');document.getElementById('ps').classList.add('hid');document.getElementById('go').classList.add('hid');document.getElementById('hud').style.display='none';document.getElementById('log').style.display='none';}
function showGameOver(){
  let title='CONSUMED BY THE WITNESS';
  if(depth>=15)title='TRANSCENDED';else if(depth>=10)title='WITNESSED THE TRUTH';else if(depth>=5)title='GLIMPSED THE PATTERN';
  document.getElementById('go-t').textContent=title;
  document.getElementById('go-s').innerHTML='<div><span>Depth</span><span>'+depth+'</span></div><div><span>Score</span><span>'+score+'</span></div><div><span>Evidence</span><span>'+totalEvidence+'</span></div><div><span>Rooms</span><span>'+roomsExplored+'</span></div><div><span>Max Combo</span><span>x'+maxCombo+'</span></div><div><span>Difficulty</span><span>'+diff.toUpperCase()+'</span></div>';
  saveHS(score,depth);const hs=loadHS();let lb='<h3>HIGH SCORES</h3>';hs.slice(0,8).forEach((s,i)=>{lb+='<div class="le'+(s.score===score?' cur':'')+'"><span>#'+(i+1)+' D'+s.dp+'</span><span>'+s.score+'</span></div>';});
  document.getElementById('go-lb').innerHTML=lb;document.getElementById('go').classList.remove('hid');document.getElementById('hud').style.display='none';
}
function saveHS(s,d){try{let h=JSON.parse(localStorage.getItem('witness_hs')||'[]');h.push({score:s,dp:d,diff,date:new Date().toISOString()});h.sort((a,b)=>b.score-a.score);localStorage.setItem('witness_hs',JSON.stringify(h.slice(0,20)))}catch(e){}}
function loadHS(){try{return JSON.parse(localStorage.getItem('witness_hs')||'[]')}catch(e){return[]}}

function resize(){C.width=window.innerWidth;C.height=window.innerHeight-100;}
window.addEventListener('resize',resize);resize();
window.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;if(e.key==='Escape'){if(gs==='playing')pauseGame();else if(gs==='paused')resumeGame();}if(e.key==='r'&&gs==='gameover')startGame();if(e.key>='1'&&e.key<='3')useTool(parseInt(e.key)-1);});
window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;});
C.addEventListener('click',e=>{if(gs!=='playing')return;if(AU.ctx&&AU.ctx.state==='suspended')AU.ctx.resume();});
C.addEventListener('touchstart',e=>{e.preventDefault();if(AU.ctx&&AU.ctx.state==='suspended')AU.ctx.resume();const t=e.touches[0];const rect=C.getBoundingClientRect();const mx=t.clientX-rect.left,my=t.clientY-rect.top;const r=rooms[currentRoom];const ts=40;const ox=(C.width-r.w*ts)/2,oy=(C.height-r.h*ts-100)/2;const gx=Math.floor((mx-ox)/ts),gy=Math.floor((my-oy)/ts);if(gx>=0&&gx<r.w&&gy>=0&&gy<r.h){const dx=Math.sign(gx-px),dy=Math.sign(gy-py);if(Math.abs(gx-px)>Math.abs(gy-py)){keys['d']=dx>0;keys['a']=dx<0;}else{keys['s']=dy>0;keys['w']=dy<0;}setTimeout(()=>{keys={};},200);}});
document.querySelectorAll('.db').forEach(b=>{b.addEventListener('click',()=>{document.querySelectorAll('.db').forEach(x=>x.classList.remove('act'));b.classList.add('act');diff=b.dataset.d;});});
</script>
</body>
</html>