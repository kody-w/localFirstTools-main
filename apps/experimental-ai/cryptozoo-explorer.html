<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CryptoZoo Explorer ‚Äî ZooCoin Blockchain</title>
<meta name="rappterzoo:author" content="Claude Opus 4.6">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="experimental-ai">
<meta name="rappterzoo:tags" content="blockchain,cryptocurrency,explorer,block-explorer,zoocoin">
<meta name="rappterzoo:type" content="interactive">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="1">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a12;--bg2:#12121f;--bg3:#1a1a2e;--bg4:#22223a;
  --accent:#00e5ff;--gold:#ffd700;--green:#00ff88;--red:#ff4466;
  --text:#e0e0e8;--dim:#6a6a8a;--mono:'Courier New',monospace;
  --radius:6px;--gap:12px;
}
html{font-size:14px}
body{background:var(--bg);color:var(--text);font-family:var(--mono);min-height:100vh;line-height:1.5}
a{color:var(--accent);text-decoration:none;cursor:pointer}
a:hover{text-decoration:underline}
.container{max-width:1200px;margin:0 auto;padding:var(--gap)}

/* Header */
header{background:var(--bg2);border-bottom:1px solid var(--bg4);padding:12px var(--gap);position:sticky;top:0;z-index:100}
.header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.logo{font-size:1.4rem;font-weight:bold;color:var(--gold);white-space:nowrap}
.logo span{color:var(--accent)}
.search-wrap{flex:1;min-width:200px;position:relative}
#searchInput{width:100%;padding:8px 12px 8px 36px;background:var(--bg3);border:1px solid var(--bg4);color:var(--text);font-family:var(--mono);font-size:.9rem;border-radius:var(--radius);outline:none}
#searchInput:focus{border-color:var(--accent)}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--dim);font-size:1rem}
nav{display:flex;gap:8px}
nav button{background:var(--bg3);border:1px solid var(--bg4);color:var(--text);padding:6px 14px;border-radius:var(--radius);cursor:pointer;font-family:var(--mono);font-size:.85rem}
nav button:hover,nav button.active{background:var(--accent);color:var(--bg);border-color:var(--accent)}

/* Breadcrumbs */
.breadcrumbs{padding:8px 0;color:var(--dim);font-size:.85rem}
.breadcrumbs span{color:var(--accent);cursor:pointer}
.breadcrumbs span:hover{text-decoration:underline}

/* Stats grid */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:var(--gap);margin-bottom:20px}
.stat-card{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:14px;text-align:center}
.stat-card .label{color:var(--dim);font-size:.75rem;text-transform:uppercase;margin-bottom:4px}
.stat-card .value{font-size:1.3rem;font-weight:bold;color:var(--gold)}

/* Tables */
.table-wrap{overflow-x:auto;margin-bottom:20px}
table{width:100%;border-collapse:collapse;background:var(--bg2);border-radius:var(--radius);overflow:hidden}
th{background:var(--bg3);color:var(--accent);text-align:left;padding:10px 12px;font-size:.8rem;text-transform:uppercase;white-space:nowrap}
td{padding:8px 12px;border-top:1px solid var(--bg3);font-size:.85rem;white-space:nowrap}
tr:hover td{background:var(--bg3)}
.hash{color:var(--accent);cursor:pointer;max-width:180px;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:middle}
.hash:hover{text-decoration:underline}
.addr{color:var(--green)}
.amount{color:var(--gold);font-weight:bold}
.miner{color:var(--accent)}

/* Detail panels */
.detail-panel{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:16px;margin-bottom:16px}
.detail-panel h2{color:var(--gold);font-size:1.1rem;margin-bottom:12px;border-bottom:1px solid var(--bg4);padding-bottom:8px}
.detail-row{display:flex;padding:6px 0;border-bottom:1px solid var(--bg3);gap:8px;flex-wrap:wrap}
.detail-row .key{color:var(--dim);min-width:140px;flex-shrink:0}
.detail-row .val{color:var(--text);word-break:break-all;flex:1}

/* Raw JSON */
.raw-json{background:var(--bg);border:1px solid var(--bg4);border-radius:var(--radius);padding:12px;font-size:.8rem;max-height:300px;overflow:auto;white-space:pre-wrap;word-break:break-all;color:var(--dim)}

/* Merkle tree */
.merkle-path{background:var(--bg);border:1px solid var(--bg4);border-radius:var(--radius);padding:12px;margin-top:8px}
.merkle-step{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:.82rem}
.merkle-step .dir{color:var(--accent);min-width:60px}
.merkle-step .mhash{color:var(--dim);word-break:break-all}
.merkle-valid{color:var(--green);font-weight:bold;margin-top:8px}
.merkle-invalid{color:var(--red);font-weight:bold;margin-top:8px}

/* Views */
.view{display:none}
.view.active{display:block}

/* Address balance */
.balance-big{font-size:2rem;color:var(--gold);font-weight:bold;margin:12px 0}

/* Sections */
.section-title{color:var(--accent);font-size:1rem;margin:16px 0 8px;text-transform:uppercase}

/* Responsive */
@media(max-width:600px){
  .header-inner{flex-direction:column;align-items:stretch}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .detail-row{flex-direction:column}
  .detail-row .key{min-width:auto}
  nav{flex-wrap:wrap}
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">ü¶é Zoo<span>Coin</span> Explorer</div>
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input id="searchInput" type="text" placeholder="Search block hash, tx hash, address, or block number..." autocomplete="off">
    </div>
    <nav>
      <button id="navDash" class="active" onclick="showDashboard()">Dashboard</button>
      <button id="navBlocks" onclick="showBlockList()">Blocks</button>
      <button id="navTxs" onclick="showTxList()">Transactions</button>
    </nav>
  </div>
</header>

<div class="container">
  <div class="breadcrumbs" id="breadcrumbs"></div>

  <!-- Dashboard View -->
  <div class="view active" id="viewDashboard">
    <div class="stats-grid" id="statsGrid"></div>
    <div class="section-title">Recent Blocks</div>
    <div class="table-wrap" id="recentBlocksTable"></div>
    <div class="section-title">Recent Transactions</div>
    <div class="table-wrap" id="recentTxsTable"></div>
  </div>

  <!-- Block List View -->
  <div class="view" id="viewBlockList">
    <h2 style="color:var(--gold);margin-bottom:12px">All Blocks</h2>
    <div class="table-wrap" id="allBlocksTable"></div>
  </div>

  <!-- Transaction List View -->
  <div class="view" id="viewTxList">
    <h2 style="color:var(--gold);margin-bottom:12px">All Transactions</h2>
    <div class="table-wrap" id="allTxsTable"></div>
  </div>

  <!-- Block Detail View -->
  <div class="view" id="viewBlockDetail"></div>

  <!-- Transaction Detail View -->
  <div class="view" id="viewTxDetail"></div>

  <!-- Address View -->
  <div class="view" id="viewAddress"></div>
</div>

<script>
// ============================================================
// CryptoZoo Explorer ‚Äî ZooCoin (ZOO) Block Explorer
// All data sourced from localStorage key: cryptozoo-chain
// UTXO set at: cryptozoo-utxos
// ============================================================

const CHAIN_KEY = 'cryptozoo-chain';
const UTXO_KEY = 'cryptozoo-utxos';
let chain = { blocks: [], mempool: [] };
let utxoSet = {};
let lastBlockCount = 0;

// --- Utility: simple SHA-256-like hash (deterministic, not crypto-secure) ---
function simpleHash(str) {
  let h = 0x811c9dc5;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 0x01000193);
  }
  let hex = (h >>> 0).toString(16).padStart(8, '0');
  // Extend to 64 chars for realistic hash appearance
  let out = '';
  for (let j = 0; j < 8; j++) {
    let seed = h ^ (j * 0x9e3779b9);
    seed = Math.imul(seed, 0x85ebca6b);
    seed = Math.imul(seed ^ (seed >>> 13), 0xc2b2ae35);
    out += ((seed >>> 0).toString(16)).padStart(8, '0');
  }
  return out;
}

// --- Merkle tree utilities ---
// Build a merkle root from an array of transaction hashes
function buildMerkleRoot(txHashes) {
  if (!txHashes || txHashes.length === 0) return '0'.repeat(64);
  let level = txHashes.slice();
  while (level.length > 1) {
    let next = [];
    for (let i = 0; i < level.length; i += 2) {
      let left = level[i];
      let right = (i + 1 < level.length) ? level[i + 1] : level[i];
      next.push(simpleHash(left + right));
    }
    level = next;
  }
  return level[0];
}

// Generate a merkle proof path for a given tx index
function getMerkleProof(txHashes, index) {
  // Returns array of {hash, direction} for merkle proof verification
  if (!txHashes || txHashes.length <= 1) return [];
  let proof = [];
  let level = txHashes.slice();
  let idx = index;
  while (level.length > 1) {
    let next = [];
    for (let i = 0; i < level.length; i += 2) {
      let left = level[i];
      let right = (i + 1 < level.length) ? level[i + 1] : level[i];
      next.push(simpleHash(left + right));
      if (i === idx || i + 1 === idx) {
        if (idx % 2 === 0) {
          let sibling = (i + 1 < level.length) ? level[i + 1] : level[i];
          proof.push({ hash: sibling, direction: 'right' });
        } else {
          proof.push({ hash: level[i], direction: 'left' });
        }
      }
    }
    idx = Math.floor(idx / 2);
    level = next;
  }
  return proof;
}

// Verify a merkle proof
function verifyMerkleProof(txHash, proof, merkleRoot) {
  let current = txHash;
  for (const step of proof) {
    if (step.direction === 'left') {
      current = simpleHash(step.hash + current);
    } else {
      current = simpleHash(current + step.hash);
    }
  }
  return current === merkleRoot;
}

// --- Genesis block and seed data generation ---
function generateAddress(seed) {
  return 'zoo1' + simpleHash('addr' + seed).slice(0, 38);
}

function generateTxHash(blockIdx, txIdx) {
  return simpleHash('tx-' + blockIdx + '-' + txIdx + '-' + Date.now().toString(36));
}

function generateBlockHash(height, prevHash, ts) {
  return simpleHash('block-' + height + '-' + prevHash + '-' + ts);
}

const KNOWN_MINERS = [
  'zoo1rapptr_mining_pool_alpha_00000001',
  'zoo1zookeeper_node_bravo_000000001',
  'zoo1savanna_hashing_charlie_000001',
  'zoo1jungle_validator_delta_00000001',
  'zoo1reef_staker_echo_0000000000001',
];

const KNOWN_ADDRS = [];
for (let i = 0; i < 20; i++) KNOWN_ADDRS.push(generateAddress(i));

function seedChain() {
  // Build a seed blockchain with 25 blocks and realistic transactions
  const blocks = [];
  let prevHash = '0'.repeat(64);
  let baseTime = Date.now() - 25 * 60000;
  for (let h = 0; h < 25; h++) {
    let ts = baseTime + h * 60000 + Math.floor(Math.random() * 10000);
    let miner = KNOWN_MINERS[h % KNOWN_MINERS.length];
    let txs = [];
    // Coinbase tx
    let coinbaseTxHash = simpleHash('coinbase-' + h);
    txs.push({
      hash: coinbaseTxHash,
      inputs: [{ prevTx: '0'.repeat(64), index: 0, signature: 'coinbase' }],
      outputs: [{ address: miner, amount: 50 }],
      timestamp: ts,
      type: 'coinbase'
    });
    // 1-4 additional txs per block
    let numTx = 1 + (h * 3 + 7) % 4;
    for (let t = 0; t < numTx; t++) {
      let from = KNOWN_ADDRS[(h + t) % KNOWN_ADDRS.length];
      let to = KNOWN_ADDRS[(h + t + 7) % KNOWN_ADDRS.length];
      let amt = parseFloat(((h * 3.7 + t * 1.3 + 0.5) % 45 + 0.01).toFixed(4));
      let fee = parseFloat((0.001 + (t * 0.0003)).toFixed(4));
      let txHash = simpleHash('tx-' + h + '-' + t);
      txs.push({
        hash: txHash,
        inputs: [{ prevTx: simpleHash('prev-' + h + '-' + t), index: 0, signature: simpleHash('sig-' + h + '-' + t) }],
        outputs: [
          { address: to, amount: amt },
          { address: from, amount: parseFloat((100 - amt - fee).toFixed(4)) } // change
        ],
        timestamp: ts + t * 200,
        type: 'transfer',
        fee: fee
      });
    }
    let txHashes = txs.map(tx => tx.hash);
    let merkleRoot = buildMerkleRoot(txHashes);
    let nonce = Math.floor(Math.random() * 999999);
    let difficulty = 4 + Math.floor(h / 10);
    let blockHash = generateBlockHash(h, prevHash, ts);
    blocks.push({
      height: h,
      hash: blockHash,
      previousHash: prevHash,
      timestamp: ts,
      miner: miner,
      nonce: nonce,
      difficulty: difficulty,
      merkleRoot: merkleRoot,
      transactions: txs,
      size: JSON.stringify(txs).length
    });
    prevHash = blockHash;
  }
  chain = { blocks, mempool: [] };
  localStorage.setItem(CHAIN_KEY, JSON.stringify(chain));
  rebuildUtxoSet();
}

// --- UTXO set management ---
function rebuildUtxoSet() {
  // Build UTXO set from chain for address lookup
  utxoSet = {};
  const spent = new Set();
  for (const block of chain.blocks) {
    for (const tx of block.transactions) {
      for (const inp of tx.inputs) {
        if (inp.prevTx !== '0'.repeat(64)) {
          spent.add(inp.prevTx + ':' + inp.index);
        }
      }
    }
  }
  for (const block of chain.blocks) {
    for (const tx of block.transactions) {
      tx.outputs.forEach((out, idx) => {
        let key = tx.hash + ':' + idx;
        if (!spent.has(key)) {
          if (!utxoSet[out.address]) utxoSet[out.address] = [];
          utxoSet[out.address].push({
            txHash: tx.hash,
            index: idx,
            amount: out.amount,
            blockHeight: block.height
          });
        }
      });
    }
  }
  localStorage.setItem(UTXO_KEY, JSON.stringify(utxoSet));
}

// --- Load chain from localStorage ---
function loadChain() {
  try {
    let raw = localStorage.getItem(CHAIN_KEY);
    if (raw) {
      chain = JSON.parse(raw);
      if (!chain.blocks || chain.blocks.length === 0) throw new Error('empty');
    } else {
      throw new Error('missing');
    }
  } catch (e) {
    seedChain();
  }
  try {
    let raw = localStorage.getItem(UTXO_KEY);
    if (raw) utxoSet = JSON.parse(raw);
    else rebuildUtxoSet();
  } catch (e) {
    rebuildUtxoSet();
  }
  lastBlockCount = chain.blocks.length;
}

// --- Chain statistics computation ---
function getChainStats() {
  // Chain statistics: height, supply, difficulty, hash rate, avg block time, total txs
  let stats = {
    chainHeight: chain.blocks.length,
    totalSupply: 0,
    difficulty: 0,
    avgBlockTime: 0,
    totalTransactions: 0,
    hashRate: 0,
    latestBlock: null
  };
  if (chain.blocks.length === 0) return stats;
  let latest = chain.blocks[chain.blocks.length - 1];
  stats.latestBlock = latest.hash;
  stats.difficulty = latest.difficulty;
  // Total supply = sum of coinbase outputs
  for (const b of chain.blocks) {
    for (const tx of b.transactions) {
      if (tx.type === 'coinbase') {
        for (const out of tx.outputs) stats.totalSupply += out.amount;
      }
      stats.totalTransactions += 1;
    }
  }
  // Average block time
  if (chain.blocks.length > 1) {
    let totalTime = latest.timestamp - chain.blocks[0].timestamp;
    stats.avgBlockTime = (totalTime / (chain.blocks.length - 1) / 1000).toFixed(1);
  }
  // Simulated hash rate (hashes/sec based on difficulty and avg time)
  stats.hashRate = Math.pow(2, stats.difficulty) * 1000;
  return stats;
}

// --- Rendering helpers ---
function shortHash(h) {
  if (!h) return '‚Äî';
  return h.slice(0, 10) + '‚Ä¶' + h.slice(-8);
}

function formatTime(ts) {
  let d = new Date(ts);
  return d.toLocaleString();
}

function formatAge(ts) {
  let secs = Math.floor((Date.now() - ts) / 1000);
  if (secs < 60) return secs + 's ago';
  if (secs < 3600) return Math.floor(secs / 60) + 'm ago';
  if (secs < 86400) return Math.floor(secs / 3600) + 'h ago';
  return Math.floor(secs / 86400) + 'd ago';
}

function formatAmount(n) {
  return parseFloat(n).toFixed(4) + ' ZOO';
}

function formatHashRate(hr) {
  if (hr > 1e12) return (hr / 1e12).toFixed(2) + ' TH/s';
  if (hr > 1e9) return (hr / 1e9).toFixed(2) + ' GH/s';
  if (hr > 1e6) return (hr / 1e6).toFixed(2) + ' MH/s';
  if (hr > 1e3) return (hr / 1e3).toFixed(2) + ' KH/s';
  return hr + ' H/s';
}

// --- View management ---
function hideAll() {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
}

function setBreadcrumbs(...crumbs) {
  let el = document.getElementById('breadcrumbs');
  let html = '<span onclick="showDashboard()">Home</span>';
  for (const c of crumbs) {
    html += ' ‚Ä∫ ';
    if (c.click) html += '<span onclick="' + c.click + '">' + c.label + '</span>';
    else html += c.label;
  }
  el.innerHTML = html;
}

// --- Dashboard ---
function showDashboard() {
  hideAll();
  document.getElementById('viewDashboard').classList.add('active');
  document.getElementById('navDash').classList.add('active');
  setBreadcrumbs();
  renderStats();
  renderRecentBlocks();
  renderRecentTxs();
}

function renderStats() {
  let s = getChainStats();
  let grid = document.getElementById('statsGrid');
  grid.innerHTML = `
    <div class="stat-card"><div class="label">Chain Height</div><div class="value">${s.chainHeight}</div></div>
    <div class="stat-card"><div class="label">Total Supply</div><div class="value">${s.totalSupply.toFixed(2)} ZOO</div></div>
    <div class="stat-card"><div class="label">Difficulty</div><div class="value">${s.difficulty}</div></div>
    <div class="stat-card"><div class="label">Hash Rate</div><div class="value">${formatHashRate(s.hashRate)}</div></div>
    <div class="stat-card"><div class="label">Avg Block Time</div><div class="value">${s.avgBlockTime}s</div></div>
    <div class="stat-card"><div class="label">Total Transactions</div><div class="value">${s.totalTransactions}</div></div>
  `;
}

function renderRecentBlocks() {
  let recent = chain.blocks.slice(-10).reverse();
  let html = '<table><thead><tr><th>Height</th><th>Hash</th><th>Age</th><th>Miner</th><th>Txs</th><th>Size</th></tr></thead><tbody>';
  for (const b of recent) {
    html += `<tr>
      <td><a onclick="showBlockDetail(${b.height})">#${b.height}</a></td>
      <td><span class="hash" onclick="showBlockDetail(${b.height})">${shortHash(b.hash)}</span></td>
      <td>${formatAge(b.timestamp)}</td>
      <td class="miner" title="${b.miner}">${shortHash(b.miner)}</td>
      <td>${b.transactions.length}</td>
      <td>${(b.size / 1024).toFixed(1)} KB</td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('recentBlocksTable').innerHTML = html;
}

function renderRecentTxs() {
  let allTxs = [];
  for (const b of chain.blocks) {
    for (const tx of b.transactions) {
      allTxs.push({ ...tx, blockHeight: b.height });
    }
  }
  let recent = allTxs.slice(-10).reverse();
  let html = '<table><thead><tr><th>Hash</th><th>Block</th><th>Type</th><th>Amount</th><th>Age</th></tr></thead><tbody>';
  for (const tx of recent) {
    let totalOut = tx.outputs.reduce((s, o) => s + o.amount, 0);
    html += `<tr>
      <td><span class="hash" onclick="showTxDetail('${tx.hash}')">${shortHash(tx.hash)}</span></td>
      <td><a onclick="showBlockDetail(${tx.blockHeight})">#${tx.blockHeight}</a></td>
      <td>${tx.type}</td>
      <td class="amount">${formatAmount(totalOut)}</td>
      <td>${formatAge(tx.timestamp)}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('recentTxsTable').innerHTML = html;
}

// --- Block List ---
function showBlockList() {
  hideAll();
  document.getElementById('viewBlockList').classList.add('active');
  document.getElementById('navBlocks').classList.add('active');
  setBreadcrumbs({ label: 'Blocks' });
  let blocks = chain.blocks.slice().reverse();
  let html = '<table><thead><tr><th>Height</th><th>Hash</th><th>Timestamp</th><th>Miner</th><th>Txs</th><th>Difficulty</th><th>Nonce</th></tr></thead><tbody>';
  for (const b of blocks) {
    html += `<tr>
      <td><a onclick="showBlockDetail(${b.height})">#${b.height}</a></td>
      <td><span class="hash" onclick="showBlockDetail(${b.height})">${shortHash(b.hash)}</span></td>
      <td>${formatTime(b.timestamp)}</td>
      <td class="miner" title="${b.miner}">${shortHash(b.miner)}</td>
      <td>${b.transactions.length}</td>
      <td>${b.difficulty}</td>
      <td>${b.nonce}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('allBlocksTable').innerHTML = html;
}

// --- Block Detail View ---
function showBlockDetail(height) {
  // Block detail view ‚Äî shows full block info, transactions, merkle root, raw JSON
  let block = chain.blocks[height];
  if (!block) return;
  hideAll();
  document.getElementById('viewBlockDetail').classList.add('active');
  setBreadcrumbs({ label: 'Blocks', click: 'showBlockList()' }, { label: 'Block #' + height });

  let confirmations = chain.blocks.length - height;
  let txHashes = block.transactions.map(tx => tx.hash);
  let computedMerkle = buildMerkleRoot(txHashes);

  let html = `
    <div class="detail-panel">
      <h2>üß± Block #${block.height}</h2>
      <div class="detail-row"><span class="key">Block Hash</span><span class="val">${block.hash}</span></div>
      <div class="detail-row"><span class="key">Previous Hash</span><span class="val"><a onclick="showBlockDetail(${height - 1})">${block.previousHash}</a></span></div>
      <div class="detail-row"><span class="key">Timestamp</span><span class="val">${formatTime(block.timestamp)}</span></div>
      <div class="detail-row"><span class="key">Miner</span><span class="val"><a class="addr" onclick="showAddressView('${block.miner}')">${block.miner}</a></span></div>
      <div class="detail-row"><span class="key">Difficulty</span><span class="val">${block.difficulty}</span></div>
      <div class="detail-row"><span class="key">Nonce</span><span class="val">${block.nonce}</span></div>
      <div class="detail-row"><span class="key">Merkle Root</span><span class="val">${block.merkleRoot}</span></div>
      <div class="detail-row"><span class="key">Merkle Verified</span><span class="val">${computedMerkle === block.merkleRoot ? '<span style="color:var(--green)">‚úì Valid</span>' : '<span style="color:var(--red)">‚úó Mismatch</span>'}</span></div>
      <div class="detail-row"><span class="key">Confirmations</span><span class="val">${confirmations}</span></div>
      <div class="detail-row"><span class="key">Transactions</span><span class="val">${block.transactions.length}</span></div>
      <div class="detail-row"><span class="key">Block Size</span><span class="val">${(block.size / 1024).toFixed(2)} KB</span></div>
    </div>

    <div class="detail-panel">
      <h2>üìã Transactions in Block</h2>
      <div class="table-wrap">
        <table><thead><tr><th>Hash</th><th>Type</th><th>Outputs</th><th>Total</th></tr></thead><tbody>`;

  for (const tx of block.transactions) {
    let total = tx.outputs.reduce((s, o) => s + o.amount, 0);
    html += `<tr>
      <td><span class="hash" onclick="showTxDetail('${tx.hash}')">${shortHash(tx.hash)}</span></td>
      <td>${tx.type}</td>
      <td>${tx.outputs.length}</td>
      <td class="amount">${formatAmount(total)}</td>
    </tr>`;
  }

  html += `</tbody></table></div></div>
    <div class="detail-panel">
      <h2>üì¶ Raw Block JSON</h2>
      <div class="raw-json">${escapeHtml(JSON.stringify(block, null, 2))}</div>
    </div>`;

  document.getElementById('viewBlockDetail').innerHTML = html;
}

// --- Transaction Detail View ---
function showTxDetail(txHash) {
  // Transaction detail view ‚Äî shows inputs, outputs, signatures, confirmations, merkle proof
  let tx = null, block = null;
  for (const b of chain.blocks) {
    for (const t of b.transactions) {
      if (t.hash === txHash) { tx = t; block = b; break; }
    }
    if (tx) break;
  }
  if (!tx) return;
  hideAll();
  document.getElementById('viewTxDetail').classList.add('active');
  setBreadcrumbs(
    { label: 'Block #' + block.height, click: "showBlockDetail(" + block.height + ")" },
    { label: 'Tx ' + shortHash(txHash) }
  );

  let confirmations = chain.blocks.length - block.height;
  let totalIn = tx.inputs.length;
  let totalOut = tx.outputs.reduce((s, o) => s + o.amount, 0);

  // Merkle proof for this transaction
  let txHashes = block.transactions.map(t => t.hash);
  let txIdx = txHashes.indexOf(txHash);
  let merkleProof = getMerkleProof(txHashes, txIdx);
  let merkleValid = verifyMerkleProof(txHash, merkleProof, block.merkleRoot);

  let html = `
    <div class="detail-panel">
      <h2>üí∞ Transaction Detail</h2>
      <div class="detail-row"><span class="key">Tx Hash</span><span class="val">${tx.hash}</span></div>
      <div class="detail-row"><span class="key">Block</span><span class="val"><a onclick="showBlockDetail(${block.height})">#${block.height}</a></span></div>
      <div class="detail-row"><span class="key">Timestamp</span><span class="val">${formatTime(tx.timestamp)}</span></div>
      <div class="detail-row"><span class="key">Type</span><span class="val">${tx.type}</span></div>
      <div class="detail-row"><span class="key">Confirmations</span><span class="val">${confirmations}</span></div>
      <div class="detail-row"><span class="key">Fee</span><span class="val">${tx.fee ? formatAmount(tx.fee) : 'N/A (coinbase)'}</span></div>
      <div class="detail-row"><span class="key">Total Output</span><span class="val amount">${formatAmount(totalOut)}</span></div>
    </div>

    <div class="detail-panel">
      <h2>‚¨ÖÔ∏è Inputs (${totalIn})</h2>
      <div class="table-wrap"><table><thead><tr><th>Previous Tx</th><th>Index</th><th>Signature</th></tr></thead><tbody>`;

  for (const inp of tx.inputs) {
    let prevDisplay = inp.prevTx === '0'.repeat(64) ? 'Coinbase (new coins)' :
      '<span class="hash" onclick="showTxDetail(\'' + inp.prevTx + '\')">' + shortHash(inp.prevTx) + '</span>';
    html += `<tr>
      <td>${prevDisplay}</td>
      <td>${inp.index}</td>
      <td style="color:var(--dim);max-width:200px;overflow:hidden;text-overflow:ellipsis">${shortHash(inp.signature)}</td>
    </tr>`;
  }

  html += `</tbody></table></div></div>
    <div class="detail-panel">
      <h2>‚û°Ô∏è Outputs (${tx.outputs.length})</h2>
      <div class="table-wrap"><table><thead><tr><th>Address</th><th>Amount</th></tr></thead><tbody>`;

  for (const out of tx.outputs) {
    html += `<tr>
      <td><a class="addr" onclick="showAddressView('${out.address}')">${out.address}</a></td>
      <td class="amount">${formatAmount(out.amount)}</td>
    </tr>`;
  }

  html += `</tbody></table></div></div>

    <div class="detail-panel">
      <h2>üåø Merkle Proof Verification</h2>
      <p style="color:var(--dim);margin-bottom:8px">Proving inclusion of tx in block #${block.height} merkle root</p>
      <div class="merkle-path">`;

  if (merkleProof.length === 0) {
    html += '<p style="color:var(--dim)">Single transaction in block ‚Äî no siblings needed.</p>';
  } else {
    html += `<div class="merkle-step"><span class="dir">Leaf:</span><span class="mhash">${txHash}</span></div>`;
    for (let i = 0; i < merkleProof.length; i++) {
      html += `<div class="merkle-step"><span class="dir">${merkleProof[i].direction}:</span><span class="mhash">${merkleProof[i].hash}</span></div>`;
    }
  }

  html += `</div>
    <div class="detail-row" style="margin-top:8px"><span class="key">Merkle Root</span><span class="val">${block.merkleRoot}</span></div>
    <p class="${merkleValid ? 'merkle-valid' : 'merkle-invalid'}">
      ${merkleValid ? '‚úì Merkle proof is VALID ‚Äî transaction is included in block' : '‚úó Merkle proof INVALID'}
    </p></div>

    <div class="detail-panel">
      <h2>üì¶ Raw Transaction JSON</h2>
      <div class="raw-json">${escapeHtml(JSON.stringify(tx, null, 2))}</div>
    </div>`;

  document.getElementById('viewTxDetail').innerHTML = html;
}

// --- Transaction List ---
function showTxList() {
  hideAll();
  document.getElementById('viewTxList').classList.add('active');
  document.getElementById('navTxs').classList.add('active');
  setBreadcrumbs({ label: 'Transactions' });
  let allTxs = [];
  for (const b of chain.blocks) {
    for (const tx of b.transactions) {
      allTxs.push({ ...tx, blockHeight: b.height });
    }
  }
  allTxs.reverse();
  let html = '<table><thead><tr><th>Hash</th><th>Block</th><th>Type</th><th>From</th><th>To</th><th>Amount</th></tr></thead><tbody>';
  for (const tx of allTxs) {
    let from = tx.type === 'coinbase' ? 'Coinbase' : shortHash(tx.inputs[0].prevTx);
    let to = tx.outputs[0] ? '<a class="addr" onclick="showAddressView(\'' + tx.outputs[0].address + '\')">' + shortHash(tx.outputs[0].address) + '</a>' : '‚Äî';
    let total = tx.outputs.reduce((s, o) => s + o.amount, 0);
    html += `<tr>
      <td><span class="hash" onclick="showTxDetail('${tx.hash}')">${shortHash(tx.hash)}</span></td>
      <td><a onclick="showBlockDetail(${tx.blockHeight})">#${tx.blockHeight}</a></td>
      <td>${tx.type}</td>
      <td style="color:var(--dim)">${from}</td>
      <td>${to}</td>
      <td class="amount">${formatAmount(total)}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('allTxsTable').innerHTML = html;
}

// --- Address View (address lookup / address search) ---
function showAddressView(address) {
  // Address view ‚Äî shows balance, UTXOs, and transaction history for an address
  hideAll();
  document.getElementById('viewAddress').classList.add('active');
  setBreadcrumbs({ label: 'Address' });

  // Calculate balance from UTXO set
  let addressUtxos = utxoSet[address] || [];
  let balance = addressUtxos.reduce((s, u) => s + u.amount, 0);

  // Find all transactions involving this address
  let txHistory = [];
  for (const b of chain.blocks) {
    for (const tx of b.transactions) {
      let involved = false;
      let received = 0, sent = 0;
      for (const out of tx.outputs) {
        if (out.address === address) { received += out.amount; involved = true; }
      }
      // Check if address is in inputs (approximate: check output addresses of prev tx)
      for (const inp of tx.inputs) {
        if (inp.prevTx !== '0'.repeat(64)) {
          // Look up the prev tx to see if it was from this address
          for (const b2 of chain.blocks) {
            for (const t2 of b2.transactions) {
              if (t2.hash === inp.prevTx) {
                for (const o2 of t2.outputs) {
                  if (o2.address === address) { sent += o2.amount; involved = true; }
                }
              }
            }
          }
        }
      }
      if (involved) {
        txHistory.push({
          hash: tx.hash,
          blockHeight: b.height,
          timestamp: tx.timestamp,
          type: tx.type,
          received: received,
          sent: sent,
          net: received - sent
        });
      }
    }
  }

  let html = `
    <div class="detail-panel">
      <h2>üë§ Address</h2>
      <div class="detail-row"><span class="key">Address</span><span class="val addr">${address}</span></div>
      <div class="balance-big">${formatAmount(balance)}</div>
      <div class="detail-row"><span class="key">Transactions</span><span class="val">${txHistory.length}</span></div>
      <div class="detail-row"><span class="key">UTXOs</span><span class="val">${addressUtxos.length}</span></div>
    </div>

    <div class="detail-panel">
      <h2>ü™ô Unspent Outputs (UTXOs)</h2>
      <div class="table-wrap"><table><thead><tr><th>Tx Hash</th><th>Index</th><th>Amount</th><th>Block</th></tr></thead><tbody>`;

  for (const u of addressUtxos) {
    html += `<tr>
      <td><span class="hash" onclick="showTxDetail('${u.txHash}')">${shortHash(u.txHash)}</span></td>
      <td>${u.index}</td>
      <td class="amount">${formatAmount(u.amount)}</td>
      <td><a onclick="showBlockDetail(${u.blockHeight})">#${u.blockHeight}</a></td>
    </tr>`;
  }

  html += `</tbody></table></div></div>
    <div class="detail-panel">
      <h2>üìú Transaction History</h2>
      <div class="table-wrap"><table><thead><tr><th>Hash</th><th>Block</th><th>Received</th><th>Sent</th><th>Net</th><th>Time</th></tr></thead><tbody>`;

  for (const tx of txHistory.reverse()) {
    let netColor = tx.net >= 0 ? 'var(--green)' : 'var(--red)';
    html += `<tr>
      <td><span class="hash" onclick="showTxDetail('${tx.hash}')">${shortHash(tx.hash)}</span></td>
      <td><a onclick="showBlockDetail(${tx.blockHeight})">#${tx.blockHeight}</a></td>
      <td style="color:var(--green)">${tx.received > 0 ? '+' + formatAmount(tx.received) : '‚Äî'}</td>
      <td style="color:var(--red)">${tx.sent > 0 ? '-' + formatAmount(tx.sent) : '‚Äî'}</td>
      <td style="color:${netColor};font-weight:bold">${tx.net >= 0 ? '+' : ''}${formatAmount(tx.net)}</td>
      <td>${formatAge(tx.timestamp)}</td>
    </tr>`;
  }

  html += '</tbody></table></div></div>';
  document.getElementById('viewAddress').innerHTML = html;
}

// --- Search handler ---
function handleSearch(query) {
  query = query.trim();
  if (!query) return;

  // Try block number
  if (/^\d+$/.test(query)) {
    let num = parseInt(query);
    if (num >= 0 && num < chain.blocks.length) {
      showBlockDetail(num);
      return;
    }
  }

  // Try block hash
  for (const b of chain.blocks) {
    if (b.hash === query || b.hash.startsWith(query)) {
      showBlockDetail(b.height);
      return;
    }
  }

  // Try tx hash
  for (const b of chain.blocks) {
    for (const tx of b.transactions) {
      if (tx.hash === query || tx.hash.startsWith(query)) {
        showTxDetail(tx.hash);
        return;
      }
    }
  }

  // Try address lookup
  if (query.startsWith('zoo1') || utxoSet[query]) {
    showAddressView(query);
    return;
  }

  // Partial address search
  for (const addr of Object.keys(utxoSet)) {
    if (addr.includes(query)) {
      showAddressView(addr);
      return;
    }
  }

  alert('No results found for: ' + query);
}

// --- HTML escape ---
function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// --- Live update polling ---
function pollForUpdates() {
  try {
    let raw = localStorage.getItem(CHAIN_KEY);
    if (raw) {
      let parsed = JSON.parse(raw);
      if (parsed.blocks && parsed.blocks.length !== lastBlockCount) {
        chain = parsed;
        lastBlockCount = chain.blocks.length;
        rebuildUtxoSet();
        // Refresh current view
        let dash = document.getElementById('viewDashboard');
        if (dash.classList.contains('active')) showDashboard();
      }
    }
  } catch (e) { /* ignore parse errors during poll */ }
}

// --- Init ---
document.getElementById('searchInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') handleSearch(this.value);
});

// Keyboard shortcut: / to focus search
document.addEventListener('keydown', function(e) {
  if (e.key === '/' && document.activeElement !== document.getElementById('searchInput')) {
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
});

loadChain();
showDashboard();

// Poll for live updates every 3 seconds
setInterval(pollForUpdates, 3000);
</script>
</body>
</html>
