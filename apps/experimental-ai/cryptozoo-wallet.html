<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CryptoZoo Wallet â€” ZooCoin</title>
<meta name="rappterzoo:author" content="Claude Opus 4.6">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="experimental-ai">
<meta name="rappterzoo:tags" content="blockchain,cryptocurrency,wallet,ecdsa,zoocoin">
<meta name="rappterzoo:type" content="interactive">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a12;--surface:#12121e;--surface2:#1a1a2e;--border:#2a2a3e;--text:#e0e0e0;--dim:#888;--accent:#00e5ff;--gold:#ffd700;--red:#ff4444;--green:#00cc66;--mono:'Courier New',monospace}
body{background:var(--bg);color:var(--text);font-family:var(--mono);min-height:100vh;display:flex;flex-direction:column}
header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:12px}
header h1{font-size:1.1rem;color:var(--gold)}
header h1 span{color:var(--accent)}
.zoo-logo{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#ff8c00);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;color:#000}
.main-wrap{display:flex;flex:1;overflow:hidden}
nav{width:180px;background:var(--surface);border-right:1px solid var(--border);padding:8px 0;flex-shrink:0}
nav button{display:block;width:100%;text-align:left;background:none;border:none;color:var(--dim);font-family:var(--mono);font-size:0.85rem;padding:10px 16px;cursor:pointer;border-left:3px solid transparent;transition:all .15s}
nav button:hover{color:var(--text);background:var(--surface2)}
nav button.active{color:var(--accent);border-left-color:var(--accent);background:var(--surface2)}
.content{flex:1;padding:20px;overflow-y:auto}
.section{display:none}
.section.active{display:block}
h2{color:var(--gold);font-size:1rem;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:8px}
h3{color:var(--accent);font-size:0.9rem;margin:16px 0 8px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
.balance-big{font-size:2rem;color:var(--gold);text-align:center;padding:20px 0}
.balance-big small{font-size:0.9rem;color:var(--dim);display:block;margin-top:4px}
label{display:block;color:var(--dim);font-size:0.8rem;margin-bottom:4px;margin-top:12px}
label:first-child{margin-top:0}
input,textarea,select{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:0.85rem;padding:8px 10px;border-radius:4px;outline:none}
input:focus,textarea:focus,select:focus{border-color:var(--accent)}
textarea{resize:vertical;min-height:60px}
button.btn{background:var(--accent);color:#000;border:none;font-family:var(--mono);font-size:0.85rem;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:12px;transition:opacity .15s}
button.btn:hover{opacity:0.85}
button.btn-gold{background:var(--gold)}
button.btn-red{background:var(--red);color:#fff}
button.btn-green{background:var(--green);color:#000}
button.btn-outline{background:none;border:1px solid var(--accent);color:var(--accent)}
button.btn:disabled{opacity:0.4;cursor:default}
.addr{font-size:0.8rem;color:var(--accent);word-break:break-all;background:var(--bg);padding:6px 8px;border-radius:4px;margin:4px 0}
.warn{background:#2a1a00;border:1px solid #664400;color:#ffaa00;padding:10px;border-radius:4px;margin:12px 0;font-size:0.8rem}
.warn::before{content:"âš  "}
table{width:100%;border-collapse:collapse;font-size:0.8rem;margin-top:8px}
th{text-align:left;color:var(--dim);padding:6px 8px;border-bottom:1px solid var(--border)}
td{padding:6px 8px;border-bottom:1px solid var(--border)}
.tx-sent{color:var(--red)}
.tx-recv{color:var(--green)}
.tx-pending{color:var(--gold)}
.status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
.status-dot.green{background:var(--green)}
.status-dot.gold{background:var(--gold)}
.status-dot.red{background:var(--red)}
.key-item{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:12px;margin-bottom:8px;position:relative}
.key-item .key-label{color:var(--gold);font-size:0.85rem}
.key-item .key-addr{font-size:0.75rem;color:var(--accent);word-break:break-all;margin-top:4px}
.key-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.key-actions button{font-size:0.75rem;padding:4px 10px;margin-top:0}
.contact-item{display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;margin-bottom:6px}
.contact-item .c-label{color:var(--gold);font-size:0.85rem}
.contact-item .c-addr{font-size:0.75rem;color:var(--accent);word-break:break-all}
.contact-actions{display:flex;gap:4px}
.contact-actions button{font-size:0.7rem;padding:3px 8px;margin:0}
.flex-row{display:flex;gap:8px;align-items:flex-end}
.flex-row>*{flex:1}
.copy-toast{position:fixed;bottom:20px;right:20px;background:var(--accent);color:#000;padding:8px 16px;border-radius:4px;font-size:0.8rem;opacity:0;transition:opacity .3s;pointer-events:none;z-index:999}
.copy-toast.show{opacity:1}
.overview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;text-align:center}
.stat-val{font-size:1.4rem;color:var(--gold);margin:8px 0 4px}
.stat-label{color:var(--dim);font-size:0.75rem}
@media(max-width:600px){
  .main-wrap{flex-direction:column}
  nav{width:100%;display:flex;overflow-x:auto;border-right:none;border-bottom:1px solid var(--border);padding:0}
  nav button{white-space:nowrap;border-left:none;border-bottom:3px solid transparent;padding:8px 12px;font-size:0.75rem}
  nav button.active{border-left-color:transparent;border-bottom-color:var(--accent)}
  .content{padding:12px}
  .overview-grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<header>
  <div class="zoo-logo">Z</div>
  <h1><span>ZooCoin</span> Wallet</h1>
</header>
<div class="main-wrap">
  <nav id="nav">
    <button class="active" data-tab="overview">â—ˆ Overview</button>
    <button data-tab="send">â†— Send</button>
    <button data-tab="receive">â†™ Receive</button>
    <button data-tab="history">â˜° History</button>
    <button data-tab="keys">ðŸ”‘ Keys</button>
    <button data-tab="contacts">ðŸ“‡ Contacts</button>
    <button data-tab="backup">ðŸ’¾ Backup</button>
  </nav>
  <div class="content">

    <!-- OVERVIEW -->
    <div id="tab-overview" class="section active">
      <h2>â—ˆ Wallet Overview</h2>
      <div class="card">
        <div class="balance-big" id="total-balance">0.000000 ZOO</div>
        <small style="text-align:center;display:block;color:var(--dim)" id="balance-detail"></small>
      </div>
      <div class="overview-grid">
        <div class="stat-card"><div class="stat-val" id="stat-keys">0</div><div class="stat-label">Key Pairs</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-txs">0</div><div class="stat-label">Transactions</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-utxos">0</div><div class="stat-label">UTXOs</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-contacts">0</div><div class="stat-label">Contacts</div></div>
      </div>
      <h3>Recent Activity</h3>
      <div id="recent-activity"><span style="color:var(--dim)">No recent transactions</span></div>
    </div>

    <!-- SEND -->
    <div id="tab-send" class="section">
      <h2>â†— Send ZooCoin</h2>
      <div class="card">
        <label>From Address</label>
        <select id="send-from"></select>
        <label>Recipient Address</label>
        <div class="flex-row">
          <input id="send-to" placeholder="zoo1...">
          <button class="btn btn-outline" onclick="pickContact()" style="flex:none;width:auto">ðŸ“‡</button>
        </div>
        <label>Amount (ZOO)</label>
        <input id="send-amount" type="number" step="0.000001" min="0" placeholder="0.000000">
        <div style="margin-top:8px;color:var(--dim);font-size:0.8rem">Available: <span id="send-avail">0</span> ZOO Â· Fee: 0.001000 ZOO</div>
        <button class="btn btn-gold" onclick="createTransaction()">Sign & Create Transaction</button>
      </div>
      <div id="send-result" style="display:none">
        <h3>Signed Transaction</h3>
        <div class="card">
          <textarea id="send-tx-data" rows="6" readonly></textarea>
          <button class="btn" onclick="broadcastTx()">Broadcast to Mempool</button>
          <button class="btn btn-outline" onclick="copyTxData()" style="margin-left:6px">Copy</button>
        </div>
      </div>
    </div>

    <!-- RECEIVE -->
    <div id="tab-receive" class="section">
      <h2>â†™ Receive ZooCoin</h2>
      <div class="card">
        <label>Select Address</label>
        <select id="recv-addr" onchange="showRecvAddr()"></select>
        <div id="recv-display" style="margin-top:16px;text-align:center">
          <div class="addr" id="recv-addr-text" style="font-size:1rem;padding:12px">â€”</div>
          <button class="btn" onclick="copyAddr()">Copy Address</button>
        </div>
        <p style="color:var(--dim);font-size:0.8rem;margin-top:12px">Share this address with the sender. Funds sent to this address will appear in your wallet once confirmed on the CryptoZoo blockchain.</p>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="tab-history" class="section">
      <h2>â˜° Transaction History</h2>
      <div class="card">
        <label>Filter by Address</label>
        <select id="hist-filter" onchange="renderHistory()">
          <option value="all">All addresses</option>
        </select>
      </div>
      <div id="history-list"></div>
    </div>

    <!-- KEYS -->
    <div id="tab-keys" class="section">
      <h2>ðŸ”‘ Key Management</h2>
      <div class="warn">Private keys grant full access to your ZooCoin. Never share them. Always keep a backup.</div>
      <button class="btn btn-gold" onclick="generateNewKey()">Generate New ECDSA Key Pair</button>
      <div id="keys-list" style="margin-top:16px"></div>
    </div>

    <!-- CONTACTS / ADDRESS BOOK -->
    <div id="tab-contacts" class="section">
      <h2>ðŸ“‡ Address Book</h2>
      <div class="card">
        <label>Contact Label</label>
        <input id="contact-label" placeholder="e.g. Alice">
        <label>Recipient Address</label>
        <input id="contact-addr" placeholder="zoo1...">
        <button class="btn btn-green" onclick="addContact()">Add Contact</button>
      </div>
      <h3>Saved Contacts</h3>
      <div id="contacts-list"></div>
    </div>

    <!-- BACKUP / RESTORE -->
    <div id="tab-backup" class="section">
      <h2>ðŸ’¾ Backup & Restore</h2>
      <div class="warn">Your exported backup contains private keys. Store it securely and never share it publicly. Anyone with this file can spend your ZooCoin.</div>
      <div class="card">
        <h3 style="margin-top:0">Export Wallet</h3>
        <p style="font-size:0.8rem;color:var(--dim)">Download all key pairs, contacts, and settings as encrypted JSON.</p>
        <label>Encryption Password</label>
        <input id="backup-pass" type="password" placeholder="Enter a strong password">
        <button class="btn btn-gold" onclick="exportWallet()">Export Encrypted Backup</button>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Import / Restore Wallet</h3>
        <p style="font-size:0.8rem;color:var(--dim)">Restore from a previously exported backup file.</p>
        <label>Backup JSON</label>
        <textarea id="import-data" rows="4" placeholder="Paste backup JSON here..."></textarea>
        <label>Decryption Password</label>
        <input id="import-pass" type="password" placeholder="Password used during export">
        <button class="btn btn-green" onclick="importWallet()">Restore Wallet</button>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Import Single Key (JWK)</h3>
        <textarea id="import-jwk" rows="4" placeholder='Paste JWK JSON...'></textarea>
        <label>Label</label>
        <input id="import-jwk-label" placeholder="Key label">
        <button class="btn" onclick="importSingleKey()">Import Key</button>
      </div>
    </div>
  </div>
</div>
<div class="copy-toast" id="toast">Copied!</div>

<script>
// â”€â”€ State â”€â”€
const STORAGE_WALLET  = 'cryptozoo-wallet';
const STORAGE_CHAIN   = 'cryptozoo-chain';
const STORAGE_MEMPOOL = 'cryptozoo-mempool';
const STORAGE_UTXOS   = 'cryptozoo-utxos';
const TX_FEE = 0.001;

let wallet = loadJSON(STORAGE_WALLET, { keys: [], contacts: [] });

// â”€â”€ Helpers â”€â”€
function loadJSON(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) || fallback; }
  catch { return fallback; }
}
function saveWallet() { localStorage.setItem(STORAGE_WALLET, JSON.stringify(wallet)); }

function getChain() { return loadJSON(STORAGE_CHAIN, { blocks: [], height: 0 }); }
function getMempool() { return loadJSON(STORAGE_MEMPOOL, []); }
function getUTXOs() { return loadJSON(STORAGE_UTXOS, []); }

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 1500);
}

function hexFromBuf(buf) {
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function bufFromHex(hex) {
  const bytes = [];
  for (let i = 0; i < hex.length; i += 2) bytes.push(parseInt(hex.substr(i, 2), 16));
  return new Uint8Array(bytes);
}

async function sha256hex(data) {
  const enc = new TextEncoder().encode(typeof data === 'string' ? data : JSON.stringify(data));
  const hash = await crypto.subtle.digest('SHA-256', enc);
  return hexFromBuf(hash);
}

async function deriveAddress(pubJWK) {
  const hash = await sha256hex(JSON.stringify(pubJWK));
  return 'zoo1' + hash.substring(0, 16);
}

// â”€â”€ ECDSA Key Management â”€â”€
async function generateKeyPair() {
  const keyPair = await crypto.subtle.generateKey(
    { name: 'ECDSA', namedCurve: 'P-256' },
    true,
    ['sign', 'verify']
  );
  const pubJWK = await crypto.subtle.exportKey('jwk', keyPair.publicKey);
  const privJWK = await crypto.subtle.exportKey('jwk', keyPair.privateKey);
  const address = await deriveAddress(pubJWK);
  return { pubJWK, privJWK, address };
}

async function importKeyFromJWK(privJWK) {
  const privKey = await crypto.subtle.importKey(
    'jwk', privJWK,
    { name: 'ECDSA', namedCurve: 'P-256' },
    true, ['sign']
  );
  const pubJWK = { ...privJWK };
  delete pubJWK.d;
  pubJWK.key_ops = ['verify'];
  const address = await deriveAddress(pubJWK);
  return { privKey, pubJWK, privJWK, address };
}

async function signData(privJWK, data) {
  const privKey = await crypto.subtle.importKey(
    'jwk', privJWK,
    { name: 'ECDSA', namedCurve: 'P-256' },
    false, ['sign']
  );
  const encoded = new TextEncoder().encode(typeof data === 'string' ? data : JSON.stringify(data));
  const sig = await crypto.subtle.sign(
    { name: 'ECDSA', hash: 'SHA-256' },
    privKey, encoded
  );
  return hexFromBuf(sig);
}

// â”€â”€ UTXO & Balance â”€â”€
function computeUTXOs() {
  const chain = getChain();
  const mempool = getMempool();
  const spent = new Set();
  const utxos = [];

  // Process confirmed blocks
  if (chain.blocks) {
    for (const block of chain.blocks) {
      if (!block.transactions) continue;
      for (const tx of block.transactions) {
        if (tx.inputs) {
          for (const inp of tx.inputs) {
            spent.add(inp.txid + ':' + inp.vout);
          }
        }
        if (tx.outputs) {
          tx.outputs.forEach((out, idx) => {
            utxos.push({ txid: tx.id, vout: idx, address: out.address, amount: out.amount, confirmed: true });
          });
        }
      }
    }
  }

  // Process unconfirmed mempool
  for (const tx of mempool) {
    if (tx.inputs) {
      for (const inp of tx.inputs) {
        spent.add(inp.txid + ':' + inp.vout);
      }
    }
    if (tx.outputs) {
      tx.outputs.forEach((out, idx) => {
        utxos.push({ txid: tx.id, vout: idx, address: out.address, amount: out.amount, confirmed: false });
      });
    }
  }

  // Filter out spent
  const unspent = utxos.filter(u => !spent.has(u.txid + ':' + u.vout));
  localStorage.setItem(STORAGE_UTXOS, JSON.stringify(unspent));
  return unspent;
}

function getBalance(address) {
  const utxos = computeUTXOs();
  let confirmed = 0, unconfirmed = 0;
  for (const u of utxos) {
    if (u.address === address) {
      if (u.confirmed) confirmed += u.amount;
      else unconfirmed += u.amount;
    }
  }
  return { confirmed, unconfirmed, total: confirmed + unconfirmed };
}

function getTotalBalance() {
  const addrs = new Set(wallet.keys.map(k => k.address));
  let confirmed = 0, unconfirmed = 0;
  const utxos = computeUTXOs();
  for (const u of utxos) {
    if (addrs.has(u.address)) {
      if (u.confirmed) confirmed += u.amount;
      else unconfirmed += u.amount;
    }
  }
  return { confirmed, unconfirmed, total: confirmed + unconfirmed };
}

// â”€â”€ Transaction History â”€â”€
function getAllTransactions() {
  const chain = getChain();
  const mempool = getMempool();
  const txs = [];

  if (chain.blocks) {
    for (const block of chain.blocks) {
      if (!block.transactions) continue;
      for (const tx of block.transactions) {
        txs.push({ ...tx, status: 'confirmed', blockHeight: block.height, timestamp: block.timestamp });
      }
    }
  }
  for (const tx of mempool) {
    txs.push({ ...tx, status: 'pending' });
  }
  return txs;
}

function getWalletTransactions(filterAddr) {
  const addrs = filterAddr === 'all'
    ? new Set(wallet.keys.map(k => k.address))
    : new Set([filterAddr]);
  const txs = getAllTransactions();
  return txs.filter(tx => {
    const inAddrs = (tx.inputs || []).some(i => addrs.has(i.address));
    const outAddrs = (tx.outputs || []).some(o => addrs.has(o.address));
    return inAddrs || outAddrs;
  }).map(tx => {
    const isSend = (tx.inputs || []).some(i => addrs.has(i.address));
    const isRecv = (tx.outputs || []).some(o => addrs.has(o.address));
    let amount = 0;
    if (isSend) {
      const inputAmt = (tx.inputs || []).filter(i => addrs.has(i.address)).reduce((s, i) => s + (i.amount || 0), 0);
      const changeAmt = (tx.outputs || []).filter(o => addrs.has(o.address)).reduce((s, o) => s + o.amount, 0);
      amount = -(inputAmt - changeAmt);
    } else if (isRecv) {
      amount = (tx.outputs || []).filter(o => addrs.has(o.address)).reduce((s, o) => s + o.amount, 0);
    }
    return { ...tx, direction: isSend ? 'sent' : 'received', amount };
  }).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
}

// â”€â”€ Transaction Creation â”€â”€
async function createTransaction() {
  const fromAddr = document.getElementById('send-from').value;
  const toAddr = document.getElementById('send-to').value.trim();
  const amount = parseFloat(document.getElementById('send-amount').value);

  if (!fromAddr) return toast('Select a sending address');
  if (!toAddr || !toAddr.startsWith('zoo1')) return toast('Invalid recipient address');
  if (!amount || amount <= 0) return toast('Enter a valid amount');

  const totalNeeded = amount + TX_FEE;
  const utxos = computeUTXOs().filter(u => u.address === fromAddr);
  let selected = [];
  let inputSum = 0;

  // Simple UTXO selection: largest first
  utxos.sort((a, b) => b.amount - a.amount);
  for (const u of utxos) {
    selected.push(u);
    inputSum += u.amount;
    if (inputSum >= totalNeeded) break;
  }

  if (inputSum < totalNeeded) return toast('Insufficient balance (' + inputSum.toFixed(6) + ' < ' + totalNeeded.toFixed(6) + ')');

  const keyEntry = wallet.keys.find(k => k.address === fromAddr);
  if (!keyEntry) return toast('Key not found for address');

  const change = inputSum - totalNeeded;
  const outputs = [{ address: toAddr, amount }];
  if (change > 0.000001) outputs.push({ address: fromAddr, amount: parseFloat(change.toFixed(6)) });

  const txBody = {
    inputs: selected.map(u => ({ txid: u.txid, vout: u.vout, address: u.address, amount: u.amount })),
    outputs,
    fee: TX_FEE,
    timestamp: Date.now()
  };

  const txHash = await sha256hex(txBody);
  const signature = await signData(keyEntry.privJWK, txHash);

  const signedTx = {
    id: txHash,
    ...txBody,
    signature,
    pubKey: keyEntry.pubJWK
  };

  document.getElementById('send-tx-data').value = JSON.stringify(signedTx, null, 2);
  document.getElementById('send-result').style.display = 'block';
  window._lastSignedTx = signedTx;
  toast('Transaction signed');
}

function broadcastTx() {
  if (!window._lastSignedTx) return toast('No transaction to broadcast');
  const mp = getMempool();
  if (mp.find(t => t.id === window._lastSignedTx.id)) return toast('Already in mempool');
  mp.push(window._lastSignedTx);
  localStorage.setItem(STORAGE_MEMPOOL, JSON.stringify(mp));
  toast('Broadcast to mempool');
  window._lastSignedTx = null;
  document.getElementById('send-result').style.display = 'none';
  document.getElementById('send-to').value = '';
  document.getElementById('send-amount').value = '';
  refreshAll();
}

function copyTxData() {
  const el = document.getElementById('send-tx-data');
  navigator.clipboard.writeText(el.value).then(() => toast('Transaction data copied'));
}

// â”€â”€ Key Generation UI â”€â”€
async function generateNewKey() {
  const kp = await generateKeyPair();
  wallet.keys.push({
    label: 'Key #' + (wallet.keys.length + 1),
    address: kp.address,
    pubJWK: kp.pubJWK,
    privJWK: kp.privJWK,
    created: new Date().toISOString()
  });
  saveWallet();
  refreshAll();
  toast('New ECDSA P-256 key pair generated');
}

async function importSingleKey() {
  const raw = document.getElementById('import-jwk').value.trim();
  const label = document.getElementById('import-jwk-label').value.trim() || 'Imported Key';
  if (!raw) return toast('Paste a JWK private key');
  try {
    const jwk = JSON.parse(raw);
    const result = await importKeyFromJWK(jwk);
    wallet.keys.push({
      label,
      address: result.address,
      pubJWK: result.pubJWK,
      privJWK: result.privJWK,
      created: new Date().toISOString()
    });
    saveWallet();
    document.getElementById('import-jwk').value = '';
    document.getElementById('import-jwk-label').value = '';
    refreshAll();
    toast('Key imported: ' + result.address);
  } catch (e) { toast('Invalid JWK: ' + e.message); }
}

function removeKey(idx) {
  if (!confirm('Delete key "' + wallet.keys[idx].label + '"? This cannot be undone if you have no backup.')) return;
  wallet.keys.splice(idx, 1);
  saveWallet();
  refreshAll();
}

function exportKeyJWK(idx) {
  const k = wallet.keys[idx];
  const data = JSON.stringify(k.privJWK, null, 2);
  navigator.clipboard.writeText(data).then(() => toast('Private JWK copied'));
}

function renameKey(idx) {
  const newName = prompt('New label:', wallet.keys[idx].label);
  if (newName && newName.trim()) {
    wallet.keys[idx].label = newName.trim();
    saveWallet();
    refreshAll();
  }
}

// â”€â”€ Address Book / Contacts â”€â”€
function addContact() {
  const label = document.getElementById('contact-label').value.trim();
  const addr = document.getElementById('contact-addr').value.trim();
  if (!label) return toast('Enter a contact label');
  if (!addr || !addr.startsWith('zoo1')) return toast('Enter a valid zoo1... address');
  if (wallet.contacts.find(c => c.address === addr)) return toast('Contact already exists');
  wallet.contacts.push({ label, address: addr });
  saveWallet();
  document.getElementById('contact-label').value = '';
  document.getElementById('contact-addr').value = '';
  refreshAll();
  toast('Contact added');
}

function removeContact(idx) {
  wallet.contacts.splice(idx, 1);
  saveWallet();
  refreshAll();
}

function pickContact() {
  if (wallet.contacts.length === 0) return toast('No saved contacts');
  const items = wallet.contacts.map((c, i) => (i + 1) + '. ' + c.label + ' (' + c.address + ')').join('\n');
  const choice = prompt('Pick a recipient:\n' + items);
  if (choice) {
    const idx = parseInt(choice) - 1;
    if (wallet.contacts[idx]) {
      document.getElementById('send-to').value = wallet.contacts[idx].address;
      toast('Selected: ' + wallet.contacts[idx].label);
    }
  }
}

function sendToContact(addr) {
  switchTab('send');
  document.getElementById('send-to').value = addr;
}

// â”€â”€ Backup & Restore â”€â”€
async function deriveEncKey(password, salt) {
  const enc = new TextEncoder().encode(password);
  const base = await crypto.subtle.importKey('raw', enc, 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
    base,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function exportWallet() {
  const pass = document.getElementById('backup-pass').value;
  if (!pass || pass.length < 4) return toast('Password must be at least 4 characters');
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveEncKey(pass, salt);
  const data = new TextEncoder().encode(JSON.stringify(wallet));
  const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, data);
  const backup = {
    version: 1,
    type: 'cryptozoo-wallet-backup',
    salt: hexFromBuf(salt),
    iv: hexFromBuf(iv),
    data: hexFromBuf(encrypted),
    exported: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cryptozoo-wallet-backup-' + Date.now() + '.json';
  a.click();
  URL.revokeObjectURL(url);
  toast('Encrypted backup exported');
}

async function importWallet() {
  const raw = document.getElementById('import-data').value.trim();
  const pass = document.getElementById('import-pass').value;
  if (!raw) return toast('Paste backup JSON');
  if (!pass) return toast('Enter decryption password');
  try {
    const backup = JSON.parse(raw);
    if (backup.type !== 'cryptozoo-wallet-backup') return toast('Invalid backup format');
    const salt = bufFromHex(backup.salt);
    const iv = bufFromHex(backup.iv);
    const encrypted = bufFromHex(backup.data);
    const key = await deriveEncKey(pass, salt);
    const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, encrypted);
    const restored = JSON.parse(new TextDecoder().decode(decrypted));
    if (!restored.keys) return toast('Invalid wallet data');
    const mergeKeys = confirm('Merge with existing keys? (Cancel to replace)');
    if (mergeKeys) {
      const existing = new Set(wallet.keys.map(k => k.address));
      for (const k of restored.keys) {
        if (!existing.has(k.address)) wallet.keys.push(k);
      }
      const existingC = new Set(wallet.contacts.map(c => c.address));
      for (const c of (restored.contacts || [])) {
        if (!existingC.has(c.address)) wallet.contacts.push(c);
      }
    } else {
      wallet = restored;
    }
    saveWallet();
    document.getElementById('import-data').value = '';
    document.getElementById('import-pass').value = '';
    refreshAll();
    toast('Wallet restored (' + wallet.keys.length + ' keys)');
  } catch (e) {
    toast('Restore failed: ' + e.message);
  }
}

// â”€â”€ Copy Address â”€â”€
function copyAddr() {
  const addr = document.getElementById('recv-addr-text').textContent;
  if (addr && addr !== 'â€”') {
    navigator.clipboard.writeText(addr).then(() => toast('Address copied'));
  }
}

function showRecvAddr() {
  const sel = document.getElementById('recv-addr').value;
  document.getElementById('recv-addr-text').textContent = sel || 'â€”';
}

// â”€â”€ Navigation â”€â”€
function switchTab(name) {
  document.querySelectorAll('#nav button').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
  document.querySelectorAll('.section').forEach(s => s.classList.toggle('active', s.id === 'tab-' + name));
}

document.querySelectorAll('#nav button').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

// â”€â”€ Render â”€â”€
function refreshAll() {
  wallet = loadJSON(STORAGE_WALLET, { keys: [], contacts: [] });
  renderOverview();
  renderSendForm();
  renderReceive();
  renderHistory();
  renderKeys();
  renderContacts();
}

function renderOverview() {
  const bal = getTotalBalance();
  document.getElementById('total-balance').textContent = bal.total.toFixed(6) + ' ZOO';
  const parts = [];
  if (bal.confirmed > 0) parts.push('Confirmed: ' + bal.confirmed.toFixed(6));
  if (bal.unconfirmed > 0) parts.push('Unconfirmed: ' + bal.unconfirmed.toFixed(6));
  document.getElementById('balance-detail').textContent = parts.join(' Â· ') || 'No funds yet';

  document.getElementById('stat-keys').textContent = wallet.keys.length;
  document.getElementById('stat-contacts').textContent = wallet.contacts.length;
  const utxos = computeUTXOs();
  const addrs = new Set(wallet.keys.map(k => k.address));
  document.getElementById('stat-utxos').textContent = utxos.filter(u => addrs.has(u.address)).length;

  const txs = getWalletTransactions('all');
  document.getElementById('stat-txs').textContent = txs.length;

  const recentEl = document.getElementById('recent-activity');
  if (txs.length === 0) {
    recentEl.innerHTML = '<span style="color:var(--dim)">No recent transactions</span>';
  } else {
    const rows = txs.slice(0, 5).map(tx => {
      const cls = tx.direction === 'sent' ? 'tx-sent' : 'tx-recv';
      const sign = tx.direction === 'sent' ? '-' : '+';
      const statusCls = tx.status === 'confirmed' ? 'green' : 'gold';
      const date = tx.timestamp ? new Date(tx.timestamp).toLocaleDateString() : 'â€”';
      return '<div class="card" style="padding:8px 12px;display:flex;justify-content:space-between;align-items:center">' +
        '<div><span class="status-dot ' + statusCls + '"><\/span>' + tx.id.substring(0, 12) + 'â€¦ <span style="color:var(--dim);font-size:0.75rem">' + date + '<\/span><\/div>' +
        '<span class="' + cls + '">' + sign + Math.abs(tx.amount).toFixed(6) + ' ZOO<\/span>' +
        '<\/div>';
    }).join('');
    recentEl.innerHTML = rows;
  }
}

function renderSendForm() {
  const sel = document.getElementById('send-from');
  const cur = sel.value;
  sel.innerHTML = wallet.keys.map(k =>
    '<option value="' + k.address + '">' + k.label + ' (' + k.address + ')<\/option>'
  ).join('');
  if (cur && wallet.keys.find(k => k.address === cur)) sel.value = cur;
  updateSendAvail();
  sel.onchange = updateSendAvail;
}

function updateSendAvail() {
  const addr = document.getElementById('send-from').value;
  if (addr) {
    const bal = getBalance(addr);
    document.getElementById('send-avail').textContent = bal.total.toFixed(6);
  }
}

function renderReceive() {
  const sel = document.getElementById('recv-addr');
  sel.innerHTML = wallet.keys.map(k =>
    '<option value="' + k.address + '">' + k.label + ' â€” ' + k.address + '<\/option>'
  ).join('');
  showRecvAddr();
}

function renderHistory() {
  const filter = document.getElementById('hist-filter');
  const curVal = filter.value;
  filter.innerHTML = '<option value="all">All addresses<\/option>' +
    wallet.keys.map(k => '<option value="' + k.address + '">' + k.label + '<\/option>').join('');
  filter.value = curVal || 'all';

  const txs = getWalletTransactions(filter.value);
  const el = document.getElementById('history-list');
  if (txs.length === 0) {
    el.innerHTML = '<div class="card"><span style="color:var(--dim)">No transaction history found<\/span><\/div>';
    return;
  }
  let html = '<table><tr><th>Status<\/th><th>TX ID<\/th><th>Direction<\/th><th>Amount<\/th><th>Date<\/th><\/tr>';
  for (const tx of txs) {
    const cls = tx.direction === 'sent' ? 'tx-sent' : 'tx-recv';
    const sign = tx.direction === 'sent' ? 'âˆ’' : '+';
    const statusCls = tx.status === 'confirmed' ? 'green' : 'gold';
    const date = tx.timestamp ? new Date(tx.timestamp).toLocaleString() : 'â€”';
    html += '<tr>' +
      '<td><span class="status-dot ' + statusCls + '"><\/span>' + tx.status + '<\/td>' +
      '<td style="color:var(--accent);font-size:0.75rem">' + tx.id.substring(0, 16) + 'â€¦<\/td>' +
      '<td class="' + cls + '">' + tx.direction + '<\/td>' +
      '<td class="' + cls + '">' + sign + Math.abs(tx.amount).toFixed(6) + ' ZOO<\/td>' +
      '<td style="color:var(--dim)">' + date + '<\/td>' +
      '<\/tr>';
  }
  html += '<\/table>';
  el.innerHTML = html;
}

function renderKeys() {
  const el = document.getElementById('keys-list');
  if (wallet.keys.length === 0) {
    el.innerHTML = '<div style="color:var(--dim)">No keys yet. Generate one to get started.<\/div>';
    return;
  }
  el.innerHTML = wallet.keys.map((k, i) => {
    const bal = getBalance(k.address);
    return '<div class="key-item">' +
      '<div class="key-label">' + k.label + ' <span style="color:var(--dim);font-size:0.75rem">(ECDSA P-256)<\/span><\/div>' +
      '<div class="key-addr">' + k.address + '<\/div>' +
      '<div style="font-size:0.75rem;color:var(--dim);margin-top:4px">Balance: ' + bal.total.toFixed(6) + ' ZOO Â· Created: ' + (k.created || 'â€”') + '<\/div>' +
      '<div class="key-actions">' +
        '<button class="btn btn-outline" onclick="navigator.clipboard.writeText(\'' + k.address + '\').then(()=>toast(\'Copied\'))">Copy Addr<\/button>' +
        '<button class="btn btn-outline" onclick="exportKeyJWK(' + i + ')">Export JWK<\/button>' +
        '<button class="btn btn-outline" onclick="renameKey(' + i + ')">Rename<\/button>' +
        '<button class="btn btn-red" onclick="removeKey(' + i + ')" style="font-size:0.75rem;padding:4px 10px">Delete<\/button>' +
      '<\/div>' +
    '<\/div>';
  }).join('');
}

function renderContacts() {
  const el = document.getElementById('contacts-list');
  if (wallet.contacts.length === 0) {
    el.innerHTML = '<div style="color:var(--dim)">No contacts saved. Add a recipient above.<\/div>';
    return;
  }
  el.innerHTML = wallet.contacts.map((c, i) =>
    '<div class="contact-item">' +
      '<div><div class="c-label">' + c.label + '<\/div><div class="c-addr">' + c.address + '<\/div><\/div>' +
      '<div class="contact-actions">' +
        '<button class="btn btn-outline" onclick="sendToContact(\'' + c.address + '\')">Send<\/button>' +
        '<button class="btn btn-outline" onclick="navigator.clipboard.writeText(\'' + c.address + '\').then(()=>toast(\'Copied\'))">Copy<\/button>' +
        '<button class="btn btn-red" onclick="removeContact(' + i + ')" style="font-size:0.7rem;padding:3px 8px">âœ•<\/button>' +
      '<\/div>' +
    '<\/div>'
  ).join('');
}

// â”€â”€ Init â”€â”€
refreshAll();

// Auto-generate first key if wallet is empty
if (wallet.keys.length === 0) {
  generateNewKey().then(() => {
    toast('Welcome to ZooCoin Wallet! First key generated.');
  });
}
<\/script>
</body>
</html>
