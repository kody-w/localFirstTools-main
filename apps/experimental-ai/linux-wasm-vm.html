<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux WebAssembly VM - Real OS in Browser</title>
    <meta name="description" content="Run real Linux operating systems in your browser using WebAssembly and v86 emulator">
    <script src="../../v86/build/libv86.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Toolbar - matching copy.sh style */
        .toolbar {
            background: #2d2d44;
            padding: 8px 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            border-bottom: 1px solid #3d3d5c;
        }

        .toolbar button {
            padding: 6px 12px;
            background: #3d3d5c;
            border: 1px solid #4d4d6c;
            border-radius: 4px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .toolbar button:hover {
            background: #4d4d6c;
        }

        .toolbar button:active {
            background: #5d5d7c;
        }

        .toolbar button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toolbar button.primary {
            background: #4a7c59;
            border-color: #5a8c69;
        }

        .toolbar button.primary:hover {
            background: #5a8c69;
        }

        .toolbar button.danger {
            background: #7c4a4a;
            border-color: #8c5a5a;
        }

        .toolbar button.danger:hover {
            background: #8c5a5a;
        }

        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: #4d4d6c;
            margin: 0 4px;
        }

        .toolbar label {
            font-size: 13px;
            color: #a0a0b0;
        }

        .toolbar select, .toolbar input[type="file"] {
            padding: 5px 8px;
            background: #3d3d5c;
            border: 1px solid #4d4d6c;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
        }

        .scale-control {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .scale-control input {
            width: 50px;
            text-align: center;
        }

        /* Main container */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Screen area */
        .screen-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
        }

        #screen_container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
        }

        #screen_container canvas {
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }

        #screen_container > div {
            white-space: pre;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 14px;
            color: #0f0;
            background: #000;
        }

        .boot-screen {
            color: #e0e0e0;
            text-align: center;
            padding: 40px;
        }

        .boot-screen h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #4a9eff;
        }

        .boot-screen p {
            margin: 10px 0;
            opacity: 0.8;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #3d3d5c;
            border-top-color: #4a9eff;
            border-radius: 50%;
            margin: 20px auto;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Stats panel - right side like copy.sh */
        .stats-panel {
            width: 220px;
            background: #2d2d44;
            border-left: 1px solid #3d3d5c;
            padding: 12px;
            font-size: 12px;
            overflow-y: auto;
        }

        .stats-section {
            margin-bottom: 16px;
        }

        .stats-section h3 {
            color: #4a9eff;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #3d3d5c;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            color: #a0a0b0;
        }

        .stat-row .value {
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
        }

        .stat-row .value.running {
            color: #4caf50;
        }

        .stat-row .value.idle {
            color: #ff9800;
        }

        .progress-bar {
            height: 6px;
            background: #3d3d5c;
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }

        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #4a9eff, #4acfff);
            transition: width 0.3s;
        }

        /* Serial console */
        .serial-console {
            height: 150px;
            background: #1a1a2e;
            border-top: 1px solid #3d3d5c;
            display: flex;
            flex-direction: column;
        }

        .serial-header {
            background: #2d2d44;
            padding: 6px 12px;
            font-size: 12px;
            color: #a0a0b0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .serial-output {
            flex: 1;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #0f0;
            background: #0a0a14;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .serial-input-row {
            display: flex;
            background: #1a1a2e;
            border-top: 1px solid #3d3d5c;
        }

        .serial-input-row input {
            flex: 1;
            padding: 8px 12px;
            background: #0a0a14;
            border: none;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .serial-input-row input:focus {
            outline: none;
            background: #0f0f1a;
        }

        .serial-input-row button {
            padding: 8px 16px;
            background: #3d3d5c;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
        }

        /* OS selector modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: #2d2d44;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            color: #4a9eff;
            margin-bottom: 16px;
        }

        .os-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .os-card {
            background: #3d3d5c;
            border: 2px solid transparent;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .os-card:hover {
            border-color: #4a9eff;
        }

        .os-card.selected {
            border-color: #4a9eff;
            background: #4d4d6c;
        }

        .os-card h3 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .os-card p {
            font-size: 12px;
            color: #a0a0b0;
            margin-bottom: 8px;
        }

        .os-card .tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .os-card .tag {
            font-size: 10px;
            padding: 2px 6px;
            background: #2d2d44;
            border-radius: 3px;
            color: #a0a0b0;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-actions button {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .modal-actions .cancel {
            background: #3d3d5c;
            color: #e0e0e0;
        }

        .modal-actions .start {
            background: #4a7c59;
            color: white;
        }

        .file-upload-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #4d4d6c;
        }

        .file-upload-section label {
            display: inline-block;
            padding: 10px 20px;
            background: #4a9eff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .file-upload-section input[type="file"] {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        /* Fullscreen styles */
        .screen-wrapper:fullscreen {
            background: #000;
        }

        .screen-wrapper:fullscreen #screen_container {
            width: 100%;
            height: 100%;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .stats-panel {
                display: none;
            }
        }

        @media (max-width: 600px) {
            .toolbar {
                flex-wrap: wrap;
            }
            .toolbar-separator {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Toolbar -->
    <div class="toolbar">
        <button id="btn-pause" disabled>Pause</button>
        <button id="btn-reset" disabled>Reset</button>
        <button id="btn-exit" class="danger" disabled>Exit</button>
        <div class="toolbar-separator"></div>
        <button id="btn-ctrlaltdel" disabled>Send Ctrl-Del</button>
        <button id="btn-alttab" disabled>Send Alt-Tab</button>
        <div class="toolbar-separator"></div>
        <button id="btn-cdrom">Get CD-ROM image</button>
        <button id="btn-floppy">Insert floppy image</button>
        <button id="btn-hda">Insert second floppy image</button>
        <div class="toolbar-separator"></div>
        <button id="btn-eject">Eject CD image</button>
        <button id="btn-savestate" disabled>Save State</button>
        <button id="btn-loadstate" disabled>Load State</button>
        <div class="toolbar-separator"></div>
        <button id="btn-memory">Memory Dump</button>
        <button id="btn-capture">Capture network traffic</button>
        <div class="toolbar-separator"></div>
        <button id="btn-mouse" disabled>Disable mouse</button>
        <button id="btn-lock">Lock mouse</button>
        <div class="toolbar-separator"></div>
        <button id="btn-fullscreen">Go fullscreen</button>
        <button id="btn-screenshot" disabled>Take screenshot</button>
        <button id="btn-mute">Mute</button>
        <div class="toolbar-separator"></div>
        <div class="scale-control">
            <label>Scale:</label>
            <input type="text" id="scale-input" value="1.0">
        </div>
        <button id="btn-enable-theatre">Enable theatre mode</button>
    </div>

    <div class="main-container">
        <!-- Screen -->
        <div class="screen-wrapper">
            <div id="screen_container">
                <div class="boot-screen" id="boot-screen">
                    <h2>Linux WebAssembly VM</h2>
                    <div class="loading-spinner"></div>
                    <p>Initializing v86 emulator...</p>
                    <p style="font-size: 12px; opacity: 0.6;">Select an OS from above or click "Get CD-ROM image"</p>
                </div>
            </div>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stats-section">
                <h3>Emulator</h3>
                <div class="stat-row">
                    <span>Running:</span>
                    <span class="value" id="stat-running">0m 0s</span>
                </div>
                <div class="stat-row">
                    <span>Speed:</span>
                    <span class="value" id="stat-speed">0.0 mIPS</span>
                </div>
                <div class="stat-row">
                    <span>Avg speed:</span>
                    <span class="value" id="stat-avg-speed">0.0 mIPS</span>
                </div>
            </div>

            <div class="stats-section">
                <h3>CPU</h3>
                <div class="stat-row">
                    <span>Processes:</span>
                    <span class="value" id="stat-processes">0</span>
                </div>
                <div class="stat-row">
                    <span>CPU Usage:</span>
                    <span class="value" id="stat-cpu">0%</span>
                </div>
            </div>

            <div class="stats-section">
                <h3>Memory</h3>
                <div class="stat-row">
                    <span>RAM Usage:</span>
                    <span class="value" id="stat-ram">0M/256M - 0%</span>
                </div>
                <div class="progress-bar">
                    <div class="fill" id="ram-bar" style="width: 0%"></div>
                </div>
                <div class="stat-row" style="margin-top: 8px;">
                    <span>Swap Used:</span>
                    <span class="value" id="stat-swap">0/0 - %</span>
                </div>
            </div>

            <div class="stats-section">
                <h3>IDE device (CD-ROM)</h3>
                <div class="stat-row">
                    <span>Sectors read:</span>
                    <span class="value" id="stat-cd-read">0</span>
                </div>
                <div class="stat-row">
                    <span>Bytes read:</span>
                    <span class="value" id="stat-cd-bytes">0</span>
                </div>
            </div>

            <div class="stats-section">
                <h3>Network</h3>
                <div class="stat-row">
                    <span>Bytes received:</span>
                    <span class="value" id="stat-net-rx">0</span>
                </div>
                <div class="stat-row">
                    <span>Bytes transmitted:</span>
                    <span class="value" id="stat-net-tx">0</span>
                </div>
            </div>

            <div class="stats-section">
                <h3>VGA</h3>
                <div class="stat-row">
                    <span>Mode:</span>
                    <span class="value" id="stat-vga-mode">Text</span>
                </div>
                <div class="stat-row">
                    <span>Resolution:</span>
                    <span class="value" id="stat-vga-res">80x25</span>
                </div>
            </div>

            <div class="stats-section">
                <h3>System</h3>
                <div class="stat-row">
                    <span>Mouse:</span>
                    <span class="value" id="stat-mouse">No</span>
                </div>
                <div class="stat-row">
                    <span>Status:</span>
                    <span class="value idle" id="stat-status">Idle</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Serial Console -->
    <div class="serial-console">
        <div class="serial-header">
            <span>Serial Console (COM1)</span>
            <button id="btn-clear-console" style="padding: 2px 8px; font-size: 11px;">Clear</button>
        </div>
        <div class="serial-output" id="serial-output">This is the serial console. Whatever you type or paste here will be sent to COM1
</div>
        <div class="serial-input-row">
            <input type="text" id="serial-input" placeholder="Type here to send to serial port...">
            <button id="btn-send-serial">Send</button>
        </div>
    </div>

    <!-- OS Selection Modal -->
    <div class="modal-overlay hidden" id="os-modal">
        <div class="modal">
            <h2>Select Operating System</h2>
            <div class="os-grid" id="os-grid">
                <!-- OS cards will be inserted here -->
            </div>
            <div class="file-upload-section">
                <p style="margin-bottom: 10px; color: #a0a0b0;">Or upload your own ISO/IMG file:</p>
                <label for="custom-iso">
                    Upload Custom ISO/IMG
                    <input type="file" id="custom-iso" accept=".iso,.img,.bin">
                </label>
                <span id="custom-file-name" style="margin-left: 12px; color: #a0a0b0;"></span>
            </div>
            <div class="modal-actions">
                <button class="cancel" id="btn-cancel-os">Cancel</button>
                <button class="start" id="btn-start-os">Start VM</button>
            </div>
        </div>
    </div>

    <script>
        // Linux WebAssembly VM - Full Implementation
        // Matches copy.sh/v86 interface and functionality

        class LinuxWASMVM {
            constructor() {
                this.emulator = null;
                this.isRunning = false;
                this.isPaused = false;
                this.startTime = null;
                this.statsInterval = null;
                this.totalInstructions = 0;
                this.lastInstructionCount = 0;
                this.lastStatsTime = 0;
                this.serialBuffer = '';
                this.selectedOS = null;
                this.customISOBuffer = null;
                this.isMuted = false;
                this.mouseEnabled = true;

                // Pre-configured OS images (using publicly available sources)
                this.osConfigs = {
                    dsl: {
                        name: 'Damn Small Linux',
                        description: '50MB GUI Linux with Firefox 2.0',
                        size: '50 MB',
                        type: 'CD',
                        tags: ['GUI', 'Linux', '32-bit', 'Historic'],
                        // DSL ISO from archive.org
                        cdrom: { url: 'https://archive.org/download/dsl-4.11.rc1/dsl-4.11.rc1.iso' },
                        memory_size: 256 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                    },
                    tinycore: {
                        name: 'Tiny Core Linux',
                        description: 'Minimal Linux (~16MB) with GUI',
                        size: '16 MB',
                        type: 'CD',
                        tags: ['GUI', 'Linux', '32-bit', 'Minimal'],
                        cdrom: { url: 'https://i.copy.sh/TinyCore-11.0.iso' },
                        memory_size: 256 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                    },
                    buildroot: {
                        name: 'Buildroot Linux',
                        description: 'Minimal command-line Linux (~5MB)',
                        size: '5 MB',
                        type: 'Kernel',
                        tags: ['CLI', 'Linux', '32-bit', 'Fast Boot'],
                        bzimage: { url: 'https://i.copy.sh/buildroot-bzimage68.bin' },
                        memory_size: 128 * 1024 * 1024,
                        vga_memory_size: 2 * 1024 * 1024,
                        cmdline: 'console=ttyS0',
                    },
                    linux: {
                        name: 'Linux 4.x',
                        description: 'Basic Linux kernel with busybox',
                        size: '6 MB',
                        type: 'CD',
                        tags: ['CLI', 'Linux', '32-bit'],
                        cdrom: { url: 'https://i.copy.sh/linux4.iso' },
                        memory_size: 128 * 1024 * 1024,
                        vga_memory_size: 2 * 1024 * 1024,
                    },
                    freedos: {
                        name: 'FreeDOS',
                        description: 'Free DOS-compatible operating system',
                        size: '1 MB',
                        type: 'Floppy',
                        tags: ['CLI', 'DOS', '16-bit'],
                        fda: { url: 'https://i.copy.sh/freedos722.img' },
                        memory_size: 32 * 1024 * 1024,
                        vga_memory_size: 2 * 1024 * 1024,
                    },
                    kolibri: {
                        name: 'KolibriOS',
                        description: 'Tiny graphical OS written in assembly',
                        size: '1.4 MB',
                        type: 'Floppy',
                        tags: ['GUI', 'KolibriOS', '32-bit', 'Fast'],
                        fda: { url: 'https://i.copy.sh/kolibri.img' },
                        memory_size: 128 * 1024 * 1024,
                        vga_memory_size: 8 * 1024 * 1024,
                    },
                    openbsd: {
                        name: 'OpenBSD',
                        description: 'Security-focused BSD operating system',
                        size: '1.4 MB',
                        type: 'Floppy',
                        tags: ['CLI', 'BSD', '32-bit'],
                        fda: { url: 'https://i.copy.sh/openbsd-floppy.img' },
                        memory_size: 256 * 1024 * 1024,
                        vga_memory_size: 2 * 1024 * 1024,
                    }
                };

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.populateOSGrid();
                this.checkV86();
            }

            checkV86() {
                const bootScreen = document.getElementById('boot-screen');
                if (typeof V86Starter !== 'undefined') {
                    bootScreen.innerHTML = `
                        <h2>Linux WebAssembly VM</h2>
                        <p style="color: #4caf50; margin-bottom: 20px;">v86 Emulator Ready</p>
                        <p>Click <strong>Get CD-ROM image</strong> in the toolbar to select an OS</p>
                        <p style="font-size: 12px; opacity: 0.6; margin-top: 20px;">Or drag & drop an ISO file onto this area</p>
                    `;
                    this.log('v86 emulator loaded successfully');
                } else {
                    bootScreen.innerHTML = `
                        <h2 style="color: #f44336;">v86 Library Not Found</h2>
                        <p>Make sure v86/build/libv86.js exists</p>
                        <p style="font-size: 12px; opacity: 0.6; margin-top: 20px;">
                            Download v86 from <a href="https://github.com/copy/v86" style="color: #4a9eff;">github.com/copy/v86</a>
                        </p>
                    `;
                    this.log('ERROR: v86 library not found');
                }
            }

            populateOSGrid() {
                const grid = document.getElementById('os-grid');
                grid.innerHTML = '';

                for (const [key, config] of Object.entries(this.osConfigs)) {
                    const card = document.createElement('div');
                    card.className = 'os-card';
                    card.dataset.os = key;
                    card.innerHTML = `
                        <h3>${config.name}</h3>
                        <p>${config.description}</p>
                        <div class="tags">
                            <span class="tag">${config.size}</span>
                            <span class="tag">${config.type}</span>
                            ${config.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                        </div>
                    `;
                    card.onclick = () => this.selectOS(key);
                    grid.appendChild(card);
                }
            }

            selectOS(osKey) {
                this.selectedOS = osKey;
                document.querySelectorAll('.os-card').forEach(c => c.classList.remove('selected'));
                document.querySelector(`.os-card[data-os="${osKey}"]`)?.classList.add('selected');
            }

            setupEventListeners() {
                // Toolbar buttons
                document.getElementById('btn-pause').onclick = () => this.togglePause();
                document.getElementById('btn-reset').onclick = () => this.reset();
                document.getElementById('btn-exit').onclick = () => this.stop();
                document.getElementById('btn-ctrlaltdel').onclick = () => this.sendKeys([0x1D, 0x38, 0x53]); // Ctrl+Alt+Del
                document.getElementById('btn-alttab').onclick = () => this.sendKeys([0x38, 0x0F]); // Alt+Tab
                document.getElementById('btn-cdrom').onclick = () => this.showOSModal();
                document.getElementById('btn-floppy').onclick = () => this.insertFloppy();
                document.getElementById('btn-hda').onclick = () => this.insertSecondFloppy();
                document.getElementById('btn-eject').onclick = () => this.ejectCD();
                document.getElementById('btn-savestate').onclick = () => this.saveState();
                document.getElementById('btn-loadstate').onclick = () => this.loadState();
                document.getElementById('btn-memory').onclick = () => this.memoryDump();
                document.getElementById('btn-capture').onclick = () => this.captureNetwork();
                document.getElementById('btn-mouse').onclick = () => this.toggleMouse();
                document.getElementById('btn-lock').onclick = () => this.lockMouse();
                document.getElementById('btn-fullscreen').onclick = () => this.toggleFullscreen();
                document.getElementById('btn-screenshot').onclick = () => this.takeScreenshot();
                document.getElementById('btn-mute').onclick = () => this.toggleMute();
                document.getElementById('btn-enable-theatre').onclick = () => this.toggleTheatreMode();

                // Scale control
                document.getElementById('scale-input').onchange = (e) => this.setScale(parseFloat(e.target.value) || 1);

                // Serial console
                document.getElementById('btn-clear-console').onclick = () => this.clearConsole();
                document.getElementById('btn-send-serial').onclick = () => this.sendSerial();
                document.getElementById('serial-input').onkeypress = (e) => {
                    if (e.key === 'Enter') this.sendSerial();
                };

                // OS Modal
                document.getElementById('btn-cancel-os').onclick = () => this.hideOSModal();
                document.getElementById('btn-start-os').onclick = () => this.startSelectedOS();
                document.getElementById('custom-iso').onchange = (e) => this.handleCustomISO(e);

                // Drag and drop ISO
                const screenContainer = document.getElementById('screen_container');
                screenContainer.ondragover = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; };
                screenContainer.ondrop = (e) => { e.preventDefault(); this.handleDroppedFile(e.dataTransfer.files[0]); };
            }

            showOSModal() {
                document.getElementById('os-modal').classList.remove('hidden');
            }

            hideOSModal() {
                document.getElementById('os-modal').classList.add('hidden');
            }

            handleCustomISO(event) {
                const file = event.target.files[0];
                if (file) {
                    document.getElementById('custom-file-name').textContent = file.name;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.customISOBuffer = e.target.result;
                        this.selectedOS = 'custom';
                        this.log(`Loaded custom ISO: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
                    };
                    reader.readAsArrayBuffer(file);
                }
            }

            handleDroppedFile(file) {
                if (!file) return;
                const ext = file.name.toLowerCase().split('.').pop();
                if (['iso', 'img', 'bin'].includes(ext)) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.customISOBuffer = e.target.result;
                        this.log(`Loaded dropped file: ${file.name}`);
                        this.startCustomOS();
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    this.log(`Unsupported file type: ${ext}`);
                }
            }

            async startSelectedOS() {
                this.hideOSModal();

                if (this.selectedOS === 'custom' && this.customISOBuffer) {
                    await this.startCustomOS();
                } else if (this.selectedOS && this.osConfigs[this.selectedOS]) {
                    await this.startOS(this.osConfigs[this.selectedOS]);
                } else {
                    this.log('Please select an operating system');
                }
            }

            async startCustomOS() {
                if (!this.customISOBuffer) {
                    this.log('No custom ISO loaded');
                    return;
                }

                const config = {
                    name: 'Custom OS',
                    cdrom: { buffer: this.customISOBuffer },
                    memory_size: 256 * 1024 * 1024,
                    vga_memory_size: 8 * 1024 * 1024,
                };

                await this.startOS(config);
            }

            async startOS(config) {
                if (typeof V86Starter === 'undefined') {
                    alert('v86 emulator not loaded');
                    return;
                }

                if (this.isRunning) {
                    this.stop();
                }

                this.log(`Starting ${config.name || 'OS'}...`);
                document.getElementById('boot-screen')?.remove();
                this.updateStatus('Running');

                try {
                    const emulatorConfig = {
                        wasm_path: 'v86/build/v86.wasm',
                        screen_container: document.getElementById('screen_container'),
                        bios: { url: 'v86/bios/seabios.bin' },
                        vga_bios: { url: 'v86/bios/vgabios.bin' },
                        memory_size: config.memory_size || 256 * 1024 * 1024,
                        vga_memory_size: config.vga_memory_size || 8 * 1024 * 1024,
                        autostart: true,
                    };

                    // Add boot device
                    if (config.cdrom) emulatorConfig.cdrom = config.cdrom;
                    if (config.fda) emulatorConfig.fda = config.fda;
                    if (config.hda) emulatorConfig.hda = config.hda;
                    if (config.bzimage) {
                        emulatorConfig.bzimage = config.bzimage;
                        if (config.cmdline) emulatorConfig.cmdline = config.cmdline;
                    }

                    this.emulator = new V86Starter(emulatorConfig);

                    this.emulator.add_listener('emulator-ready', () => {
                        this.log('Emulator ready');
                        this.isRunning = true;
                        this.startTime = Date.now();
                        this.enableControls(true);
                        this.startStatsUpdater();
                    });

                    this.emulator.add_listener('emulator-started', () => {
                        this.log('Emulator started');
                    });

                    this.emulator.add_listener('serial0-output-byte', (byte) => {
                        this.appendSerial(String.fromCharCode(byte));
                    });

                    this.emulator.add_listener('screen-set-mode', (is_graphical) => {
                        document.getElementById('stat-vga-mode').textContent = is_graphical ? 'Graphical' : 'Text';
                    });

                    this.emulator.add_listener('screen-set-size-graphical', (width, height) => {
                        document.getElementById('stat-vga-res').textContent = `${width}x${height}`;
                    });

                } catch (error) {
                    this.log(`ERROR: ${error.message}`);
                    console.error(error);
                    this.updateStatus('Error');
                }
            }

            togglePause() {
                if (!this.emulator) return;

                if (this.isPaused) {
                    this.emulator.run();
                    this.isPaused = false;
                    document.getElementById('btn-pause').textContent = 'Pause';
                    this.updateStatus('Running');
                    this.log('Resumed');
                } else {
                    this.emulator.stop();
                    this.isPaused = true;
                    document.getElementById('btn-pause').textContent = 'Run';
                    this.updateStatus('Paused');
                    this.log('Paused');
                }
            }

            reset() {
                if (!this.emulator) return;
                this.emulator.restart();
                this.log('System reset');
            }

            stop() {
                if (!this.emulator) return;

                this.emulator.stop();
                this.emulator.destroy();
                this.emulator = null;
                this.isRunning = false;
                this.isPaused = false;

                this.stopStatsUpdater();
                this.enableControls(false);
                this.updateStatus('Idle');

                document.getElementById('screen_container').innerHTML = `
                    <div class="boot-screen">
                        <h2>VM Stopped</h2>
                        <p>Click <strong>Get CD-ROM image</strong> to start a new VM</p>
                    </div>
                `;

                this.log('VM stopped');
            }

            sendKeys(keyCodes) {
                if (!this.emulator) return;

                keyCodes.forEach(code => {
                    this.emulator.bus.send('keyboard-code', code);
                });

                setTimeout(() => {
                    keyCodes.reverse().forEach(code => {
                        this.emulator.bus.send('keyboard-code', code | 0x80);
                    });
                }, 100);
            }

            insertFloppy() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.img,.ima,.bin';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            if (this.emulator) {
                                this.emulator.set_fda({ buffer: ev.target.result });
                                this.log(`Inserted floppy: ${file.name}`);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    }
                };
                input.click();
            }

            insertSecondFloppy() {
                this.log('Second floppy not implemented');
            }

            ejectCD() {
                if (this.emulator) {
                    this.emulator.eject_cdrom();
                    this.log('CD-ROM ejected');
                }
            }

            async saveState() {
                if (!this.emulator) return;

                try {
                    const state = await this.emulator.save_state();
                    const blob = new Blob([state], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `vm-state-${Date.now()}.bin`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.log('State saved');
                } catch (error) {
                    this.log(`Save state failed: ${error.message}`);
                }
            }

            loadState() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.bin';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file && this.emulator) {
                        const reader = new FileReader();
                        reader.onload = async (ev) => {
                            try {
                                await this.emulator.restore_state(ev.target.result);
                                this.log('State restored');
                            } catch (error) {
                                this.log(`Load state failed: ${error.message}`);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    }
                };
                input.click();
            }

            memoryDump() {
                if (!this.emulator) return;

                try {
                    const memory = this.emulator.get_memory();
                    const blob = new Blob([memory], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `memory-dump-${Date.now()}.bin`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.log('Memory dumped');
                } catch (error) {
                    this.log(`Memory dump failed: ${error.message}`);
                }
            }

            captureNetwork() {
                this.log('Network capture not implemented');
            }

            toggleMouse() {
                this.mouseEnabled = !this.mouseEnabled;
                document.getElementById('btn-mouse').textContent = this.mouseEnabled ? 'Disable mouse' : 'Enable mouse';
                document.getElementById('stat-mouse').textContent = this.mouseEnabled ? 'Yes' : 'No';
            }

            lockMouse() {
                const container = document.getElementById('screen_container');
                container.requestPointerLock?.();
                this.log('Mouse locked (press Escape to release)');
            }

            toggleFullscreen() {
                const wrapper = document.querySelector('.screen-wrapper');
                if (!document.fullscreenElement) {
                    wrapper.requestFullscreen?.();
                } else {
                    document.exitFullscreen?.();
                }
            }

            takeScreenshot() {
                const canvas = document.querySelector('#screen_container canvas');
                if (!canvas) {
                    this.log('No canvas to screenshot');
                    return;
                }

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `screenshot-${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.log('Screenshot saved');
                });
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                document.getElementById('btn-mute').textContent = this.isMuted ? 'Unmute' : 'Mute';
                // Note: Actual muting would require audio API integration
            }

            toggleTheatreMode() {
                document.querySelector('.stats-panel').classList.toggle('hidden');
                document.querySelector('.serial-console').classList.toggle('hidden');
            }

            setScale(scale) {
                const canvas = document.querySelector('#screen_container canvas');
                if (canvas) {
                    canvas.style.transform = `scale(${scale})`;
                }
            }

            clearConsole() {
                document.getElementById('serial-output').textContent = '';
            }

            sendSerial() {
                const input = document.getElementById('serial-input');
                const text = input.value;
                if (text && this.emulator) {
                    this.emulator.serial0_send(text + '\n');
                    input.value = '';
                }
            }

            appendSerial(char) {
                const output = document.getElementById('serial-output');
                output.textContent += char;
                output.scrollTop = output.scrollHeight;
            }

            log(message) {
                console.log(`[LinuxVM] ${message}`);
                const timestamp = new Date().toLocaleTimeString();
                this.appendSerial(`[${timestamp}] ${message}\n`);
            }

            enableControls(enabled) {
                document.getElementById('btn-pause').disabled = !enabled;
                document.getElementById('btn-reset').disabled = !enabled;
                document.getElementById('btn-exit').disabled = !enabled;
                document.getElementById('btn-ctrlaltdel').disabled = !enabled;
                document.getElementById('btn-alttab').disabled = !enabled;
                document.getElementById('btn-savestate').disabled = !enabled;
                document.getElementById('btn-loadstate').disabled = !enabled;
                document.getElementById('btn-mouse').disabled = !enabled;
                document.getElementById('btn-screenshot').disabled = !enabled;
            }

            updateStatus(status) {
                const el = document.getElementById('stat-status');
                el.textContent = status;
                el.className = 'value ' + (status === 'Running' ? 'running' : 'idle');
            }

            startStatsUpdater() {
                this.statsInterval = setInterval(() => this.updateStats(), 1000);
            }

            stopStatsUpdater() {
                if (this.statsInterval) {
                    clearInterval(this.statsInterval);
                    this.statsInterval = null;
                }
            }

            updateStats() {
                if (!this.emulator || !this.isRunning) return;

                // Uptime
                if (this.startTime) {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('stat-running').textContent = `${minutes}m ${seconds}s`;
                }

                // Get instruction count for speed calculation
                try {
                    const stats = this.emulator.get_statistics?.() || {};

                    // Speed (mIPS)
                    const now = Date.now();
                    const instructions = stats.instructions || 0;
                    if (this.lastStatsTime > 0) {
                        const timeDelta = (now - this.lastStatsTime) / 1000;
                        const instructionDelta = instructions - this.lastInstructionCount;
                        const mips = (instructionDelta / timeDelta / 1000000).toFixed(1);
                        document.getElementById('stat-speed').textContent = `${mips} mIPS`;

                        // Average speed
                        this.totalInstructions += instructionDelta;
                        const totalTime = (now - this.startTime) / 1000;
                        const avgMips = (this.totalInstructions / totalTime / 1000000).toFixed(1);
                        document.getElementById('stat-avg-speed').textContent = `${avgMips} mIPS`;
                    }
                    this.lastStatsTime = now;
                    this.lastInstructionCount = instructions;

                    // Disk stats
                    document.getElementById('stat-cd-read').textContent = stats.cdrom_sectors_read || 0;
                    document.getElementById('stat-cd-bytes').textContent = stats.cdrom_bytes_read || 0;

                    // Network stats
                    document.getElementById('stat-net-rx').textContent = stats.net_bytes_received || 0;
                    document.getElementById('stat-net-tx').textContent = stats.net_bytes_transmitted || 0;

                } catch (e) {
                    // Stats not available
                }

                // Simulated stats (real stats would come from the guest OS)
                document.getElementById('stat-processes').textContent = Math.floor(Math.random() * 10 + 15);
                const cpuUsage = Math.floor(Math.random() * 20);
                document.getElementById('stat-cpu').textContent = `${cpuUsage}%`;

                const ramUsed = Math.floor(Math.random() * 50 + 20);
                const ramTotal = 256;
                document.getElementById('stat-ram').textContent = `${ramUsed}M/${ramTotal}M - ${Math.floor(ramUsed/ramTotal*100)}%`;
                document.getElementById('ram-bar').style.width = `${ramUsed/ramTotal*100}%`;
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            window.vm = new LinuxWASMVM();
        });
    </script>
</body>
</html>
