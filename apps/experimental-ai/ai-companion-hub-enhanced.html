<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI Companion Hub - Enhanced Interactive Assistant</title>

    <!-- DNS preconnect for faster CDN loading -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://threejs.org" crossorigin>
    <link rel="dns-prefetch" href="https://aka.ms">

    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" as="script">
    <link rel="preload" href="https://threejs.org/examples/fonts/helvetiker_regular.typeface.json" as="fetch" crossorigin>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            -webkit-overflow-scrolling: touch;
        }

        /* Enhanced loading screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 30px;
            position: relative;
        }

        .loading-orb {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #06ffa5, #8338ec);
            border-radius: 50%;
            animation: loadingPulse 2s infinite;
            box-shadow: 0 0 40px rgba(6, 255, 165, 0.5);
        }

        @keyframes loadingPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        .loading-text {
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 200;
            letter-spacing: 0.1em;
            margin-bottom: 20px;
        }

        .loading-progress {
            width: 200px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1px;
            overflow: hidden;
            margin: 0 auto;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #06ffa5, #8338ec);
            border-radius: 1px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-status {
            margin-top: 15px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.6);
        }

        #three-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            cursor: default;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #three-container.visible {
            opacity: 1;
        }

        /* NEW FEATURE: Accessibility - Focus Indicators */
        .settings-button:focus-visible,
        .ai-companion-button:focus-visible,
        .show-mode-button:focus-visible,
        .tasks-button:focus-visible,
        .voice-pause-button:focus-visible,
        .tool-gallery-button:focus-visible {
            outline: 3px solid #06ffa5;
            outline-offset: 4px;
            box-shadow: 0 0 40px rgba(6, 255, 165, 0.6), inset 0 0 20px rgba(6, 255, 165, 0.2);
        }

        /* Remove default focus outline */
        .settings-button:focus,
        .ai-companion-button:focus,
        .show-mode-button:focus,
        .tasks-button:focus,
        .voice-pause-button:focus,
        .tool-gallery-button:focus {
            outline: none;
        }

        /* Tool Overlay Window */
        .tool-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            background: rgba(20, 20, 40, 0.98);
            border: 2px solid rgba(138, 43, 226, 0.5);
            border-radius: 20px;
            z-index: 2004;
            display: none;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 0 50px rgba(138, 43, 226, 0.3);
            backdrop-filter: blur(10px);
        }

        .tool-overlay.active {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .tool-overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px 20px 0 0;
        }

        .tool-overlay-title {
            font-size: 1.5em;
            font-weight: 300;
            color: #06ffa5;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-overlay-actions {
            display: flex;
            gap: 10px;
        }

        .tool-overlay-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .tool-overlay-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tool-overlay-btn.primary {
            background: linear-gradient(45deg, #06ffa5, #00cc88);
            border: none;
            color: #000;
            font-weight: bold;
        }

        .tool-overlay-btn.primary:hover {
            box-shadow: 0 4px 20px rgba(6, 255, 165, 0.4);
        }

        .tool-overlay-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s;
        }

        .tool-overlay-close:hover {
            color: #ff006e;
            transform: rotate(90deg);
        }

        .tool-overlay-content {
            height: calc(100% - 80px);
            position: relative;
            overflow: hidden;
            border-radius: 0 0 20px 20px;
        }

        .tool-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            border-radius: 0 0 20px 20px;
        }

        .tool-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
        }

        .tool-loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #06ffa5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tool Gallery Button */
        .tool-gallery-button {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 30px) + 320px);
            right: calc(env(safe-area-inset-right, 30px));
            width: 60px;
            height: 60px;
            background: rgba(255, 106, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 106, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1002;
            box-shadow: 0 0 20px rgba(255, 106, 0, 0.3);
            opacity: 0;
            transform: scale(0.8) translateZ(0);
            animation: fadeInButton 0.5s ease 0.4s forwards;
            will-change: transform, opacity;
        }

        .tool-gallery-button:hover {
            background: rgba(255, 106, 0, 0.5);
            transform: scale(1.1) translateZ(0);
            box-shadow: 0 0 30px rgba(255, 106, 0, 0.5);
        }

        .tool-gallery-button svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        /* Show Mode Button */
        .show-mode-button {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 30px) + 240px);
            right: calc(env(safe-area-inset-right, 30px));
            width: 60px;
            height: 60px;
            background: rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1002;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            opacity: 0;
            transform: scale(0.8) translateZ(0);
            animation: fadeInButton 0.5s ease 0.5s forwards;
            will-change: transform, opacity;
        }

        @keyframes fadeInButton {
            to {
                opacity: 1;
                transform: scale(1) translateZ(0);
            }
        }

        .show-mode-button:hover {
            background: rgba(0, 255, 255, 0.5);
            transform: scale(1.1) translateZ(0);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        .show-mode-button.active {
            background: rgba(0, 255, 0, 0.3);
            border-color: rgba(0, 255, 0, 0.5);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        .show-mode-button svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        /* Show Mode Status */
        .show-mode-status {
            position: fixed;
            top: env(safe-area-inset-top, 80px);
            right: env(safe-area-inset-right, 20px);
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .show-mode-status.visible {
            opacity: 1;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #888;
            transition: all 0.3s ease;
        }

        .status-indicator.connected {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        .status-indicator.hosting {
            background: #06ffa5;
            box-shadow: 0 0 10px #06ffa5;
        }

        .status-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        .viewer-count {
            color: #06ffa5;
            font-weight: bold;
        }

        /* Viewer Mode Indicator */
        .viewer-mode-indicator {
            position: fixed;
            top: env(safe-area-inset-top, 20px);
            left: env(safe-area-inset-left, 20px);
            background: rgba(138, 43, 226, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1005;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .viewer-mode-indicator.active {
            display: flex;
        }

        .viewer-mode-indicator svg {
            width: 20px;
            height: 20px;
        }

        /* Show Mode Modal */
        .show-mode-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2001;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .show-mode-modal.show {
            display: flex;
        }

        .show-mode-modal-content {
            background: rgba(20, 20, 40, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s;
        }

        .modal-close:hover {
            color: #ff006e;
            transform: rotate(90deg);
        }

        .show-mode-modal h3 {
            margin: 0 0 20px 0;
            font-size: 24px;
            background: linear-gradient(45deg, #00ffff, #0088ff, #06ffa5);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .show-mode-info {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            padding: 10px;
            margin: 15px 0;
            font-size: 0.9em;
            color: #06ffa5;
        }

        #qr-code-container {
            margin: 20px auto;
            display: flex;
            justify-content: center;
            padding: 20px;
            background: white;
            border-radius: 15px;
            min-height: 250px;
        }

        #qr-code-container canvas,
        #qr-code-container img {
            border-radius: 10px;
        }

        .qr-url {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            word-break: break-all;
            margin: 20px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-family: monospace;
        }

        .copy-url-btn {
            background: linear-gradient(45deg, #00ffff, #0088ff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .copy-url-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.4);
        }

        .copy-url-btn.copied {
            background: linear-gradient(45deg, #06ffa5, #00ff88);
        }

        /* Show Mode Notifications */
        .show-mode-notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid rgba(0, 255, 255, 0.5);
            animation: slideIn 0.3s ease;
            z-index: 1005;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Following Indicator */
        .following-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 255, 255, 0.9);
            color: #000;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1004;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .following-indicator.active {
            display: flex;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 0.6; }
        }

        /* Settings Button */
        .settings-button {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 30px) + 160px);
            right: calc(env(safe-area-inset-right, 30px));
            width: 60px;
            height: 60px;
            background: rgba(138, 43, 226, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(138, 43, 226, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1002;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
            opacity: 0;
            transform: scale(0.8) translateZ(0);
            animation: fadeInButton 0.5s ease 0.6s forwards;
            will-change: transform, opacity;
        }

        .settings-button:hover {
            background: rgba(138, 43, 226, 0.5);
            transform: scale(1.1) translateZ(0);
            box-shadow: 0 0 30px rgba(138, 43, 226, 0.5);
        }

        .settings-button svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20, 20, 40, 0.95);
            border: 2px solid rgba(138, 43, 226, 0.5);
            border-radius: 20px;
            padding: 30px;
            z-index: 2003;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(138, 43, 226, 0.3);
            display: none;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .settings-panel.active {
            display: block;
        }

        .settings-panel h2 {
            margin: 0 0 25px 0;
            font-size: 28px;
            background: linear-gradient(45deg, #8a2be2, #06ffa5);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .settings-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .settings-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .settings-tab.active {
            background: linear-gradient(45deg, #8a2be2, #06ffa5);
            border-color: transparent;
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .settings-group {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-group h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #06ffa5;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .setting-item input[type="text"],
        .setting-item input[type="password"],
        .setting-item input[type="number"],
        .setting-item select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .setting-item input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .setting-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #8a2be2;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .setting-item input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #06ffa5;
        }

        .range-value {
            display: inline-block;
            margin-left: 10px;
            font-family: monospace;
            color: #06ffa5;
            font-size: 13px;
            min-width: 60px;
        }

        .toggle-setting {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #06ffa5;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        .settings-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .settings-btn {
            flex: 1;
            padding: 12px 20px;
            background: linear-gradient(45deg, #8a2be2, #06ffa5);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(138, 43, 226, 0.4);
        }

        .settings-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .settings-btn.danger {
            background: linear-gradient(45deg, #ff0066, #ff4458);
        }

        .close-settings {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s;
        }

        .close-settings:hover {
            color: #ff006e;
            transform: rotate(90deg);
        }

        .import-export-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(138, 43, 226, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(138, 43, 226, 0.3);
        }

        .import-export-section h4 {
            margin: 0 0 15px 0;
            color: #8a2be2;
            font-size: 16px;
        }

        .json-preview {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #8a2be2;
        }

        /* Perspective Controls */
        .perspective-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .perspective-preset {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .preset-btn {
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: rgba(138, 43, 226, 0.3);
            border-color: #8a2be2;
        }

        /* Click to Chat Tooltip */
        .companion-tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            white-space: nowrap;
            z-index: 1010;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .companion-tooltip.visible {
            opacity: 1;
        }

        /* Voice Pause Button - PROMINENT POSITION */
        .voice-pause-button {
            position: fixed;
            top: calc(env(safe-area-inset-top, 20px) + 60px);
            right: calc(env(safe-area-inset-right, 20px));
            width: 120px;
            height: 50px;
            background: rgba(255, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 0, 0, 0.5);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1006;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
            font-weight: bold;
            font-size: 14px;
            opacity: 0;
            transform: scale(0.8) translateZ(0);
            animation: fadeInButton 0.5s ease 0.4s forwards;
            will-change: transform, opacity;
        }

        .voice-pause-button:hover {
            background: rgba(255, 0, 0, 0.5);
            transform: scale(1.05) translateZ(0);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
        }

        .voice-pause-button.paused {
            background: rgba(255, 165, 0, 0.3);
            border-color: rgba(255, 165, 0, 0.5);
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.3);
        }

        .voice-pause-button.paused:hover {
            background: rgba(255, 165, 0, 0.5);
            box-shadow: 0 0 30px rgba(255, 165, 0, 0.5);
        }

        .voice-pause-button svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        /* Voice Paused Indicator */
        .voice-paused-indicator {
            position: fixed;
            top: calc(env(safe-area-inset-top, 20px) + 10px);
            right: calc(env(safe-area-inset-right, 20px));
            background: rgba(255, 165, 0, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 1005;
            animation: fadeIn 0.3s ease-out;
            font-size: 13px;
            font-weight: bold;
        }

        .voice-paused-indicator.active {
            display: flex;
        }

        .voice-paused-indicator svg {
            width: 16px;
            height: 16px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }

        /* Voice Indicator */
        .voice-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(138, 56, 236, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1004;
            animation: fadeIn 0.3s ease-out;
        }

        .voice-indicator.active {
            display: flex;
        }

        .voice-indicator i {
            animation: pulse 1.5s infinite;
        }

        /* Listening Indicator */
        .listening-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(255, 0, 110, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1004;
            animation: fadeIn 0.3s ease-out;
        }

        .listening-indicator.active {
            display: flex;
        }

        .listening-indicator svg {
            width: 20px;
            height: 20px;
            animation: voicePulse 1s infinite;
        }

        @keyframes voicePulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* AI Chat Interface */
        .ai-chat-interface {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 20px) + 100px);
            right: calc(env(safe-area-inset-right, 20px));
            width: 350px;
            height: 450px;
            background: rgba(20, 20, 40, 0.85);
            border: 2px solid rgba(138, 56, 236, 0.5);
            border-radius: 20px;
            display: none;
            flex-direction: column;
            z-index: 1003;
            box-shadow: 0 0 30px rgba(138, 56, 236, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .ai-chat-interface.active {
            display: flex;
        }

        /* Special styling for viewer mode chat */
        .ai-chat-interface.viewer-mode {
            border-color: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }

        /* Viewers can still interact with chat */
        .ai-chat-interface.viewer-mode .ai-chat-input-container {
            opacity: 1;
            pointer-events: all;
        }

        .ai-chat-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-title {
            font-weight: bold;
            color: #06ffa5;
        }

        .viewer-chat-label {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .ai-message {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            font-size: 15px;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            max-width: 100%;
            overflow-x: auto;
            -webkit-user-select: text;
            user-select: text;
        }

        .ai-message.user {
            background: rgba(131, 56, 236, 0.3);
            margin-left: auto;
            text-align: right;
        }

        .ai-message.ai {
            background: rgba(6, 255, 165, 0.2);
            margin-right: auto;
        }

        /* Tool recommendation styling */
        .tool-recommendation {
            background: rgba(255, 106, 0, 0.15);
            border: 1px solid rgba(255, 106, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }

        .tool-recommendation-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            color: #ff6a00;
            margin-bottom: 8px;
        }

        .tool-recommendation-title {
            font-size: 1.1em;
            color: #ffa500;
            margin-bottom: 5px;
        }

        .tool-recommendation-description {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
        }

        .tool-recommendation-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .tool-action-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #ff6a00, #ff8c00);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .tool-action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 106, 0, 0.4);
        }

        .tool-action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .tool-action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Presenter label for viewer mode */
        .ai-message.presenter-message::before {
            content: "Presenter";
            display: block;
            font-size: 11px;
            color: #00ffff;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        /* Viewer label for presenter mode */
        .ai-message.viewer-message::before {
            content: attr(data-viewer-name);
            display: block;
            font-size: 11px;
            color: #ff6a00;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        /* Markdown Styles for AI Messages */
        .ai-message.ai h1,
        .ai-message.ai h2,
        .ai-message.ai h3,
        .ai-message.ai h4,
        .ai-message.ai h5,
        .ai-message.ai h6 {
            margin: 0.5em 0 0.3em 0;
            font-weight: 600;
            line-height: 1.3;
            color: #06ffa5;
        }

        .ai-message.ai h1 { font-size: 1.3em; }
        .ai-message.ai h2 { font-size: 1.2em; }
        .ai-message.ai h3 { font-size: 1.1em; }
        .ai-message.ai h4 { font-size: 1.05em; }
        .ai-message.ai h5 { font-size: 1em; }
        .ai-message.ai h6 { font-size: 0.95em; }

        .ai-message.ai p {
            margin: 0.5em 0;
        }

        .ai-message.ai a {
            color: #00ffff;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .ai-message.ai a:hover {
            color: #06ffa5;
            text-decoration: underline;
        }

        .ai-message.ai strong {
            font-weight: 600;
            color: #ffffff;
        }

        .ai-message.ai em {
            font-style: italic;
            color: rgba(255, 255, 255, 0.9);
        }

        .ai-message.ai code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            color: #06ffa5;
        }

        .ai-message.ai pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .ai-message.ai pre code {
            background: none;
            padding: 0;
            color: #ffffff;
        }

        .ai-message.ai blockquote {
            border-left: 4px solid #8338ec;
            padding-left: 12px;
            margin: 0.5em 0;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
        }

        .ai-message.ai ul,
        .ai-message.ai ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .ai-message.ai li {
            margin: 0.25em 0;
        }

        .ai-message.ai hr {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin: 1em 0;
        }

        .ai-message.ai table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5em 0;
        }

        .ai-message.ai th,
        .ai-message.ai td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            text-align: left;
        }

        .ai-message.ai th {
            background: rgba(138, 43, 226, 0.2);
            font-weight: 600;
        }

        .ai-message.ai img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 0.5em 0;
        }

        .ai-message.task-replay {
            border: 1px solid rgba(255, 106, 0, 0.5);
            opacity: 0.8;
            font-style: italic;
        }

        .ai-typing {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            background: rgba(6, 255, 165, 0.2);
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: typingPulse 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingPulse {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .ai-chat-input-container {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .ai-chat-input {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            font-size: 16px;
        }

        .ai-chat-send {
            background: linear-gradient(45deg, #8338ec, #3a86ff);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-chat-send:hover {
            transform: scale(1.05);
        }

        /* Voice Input Button */
        .voice-input-btn {
            background: linear-gradient(45deg, #ff006e, #ff4458);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .voice-input-btn:hover {
            transform: scale(1.1);
        }

        .voice-input-btn.recording {
            background: linear-gradient(45deg, #ff0000, #ff4444);
            animation: recordPulse 1.5s infinite;
        }

        .voice-input-btn.disabled {
            background: linear-gradient(45deg, #666, #888);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .voice-input-btn.disabled:hover {
            transform: scale(1);
        }

        @keyframes recordPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
            }
        }

        /* AI Companion Button */
        .ai-companion-button {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 30px));
            right: calc(env(safe-area-inset-right, 30px));
            width: 60px;
            height: 60px;
            background: rgba(131, 56, 236, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(131, 56, 236, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1002;
            box-shadow: 0 0 20px rgba(131, 56, 236, 0.3);
            opacity: 0;
            transform: scale(0.8) translateZ(0);
            animation: fadeInButton 0.5s ease 0.8s forwards;
            will-change: transform, opacity;
        }

        .ai-companion-button:hover {
            background: rgba(131, 56, 236, 0.5);
            transform: scale(1.1) translateZ(0);
            box-shadow: 0 0 30px rgba(131, 56, 236, 0.5);
        }

        .ai-companion-button.active {
            background: rgba(6, 255, 165, 0.3);
            border-color: rgba(6, 255, 165, 0.5);
        }

        /* Tasks Button */
        .tasks-button {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 30px) + 80px);
            right: calc(env(safe-area-inset-right, 30px));
            width: 60px;
            height: 60px;
            background: rgba(255, 106, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 106, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1002;
            box-shadow: 0 0 20px rgba(255, 106, 0, 0.3);
            opacity: 0;
            transform: scale(0.8) translateZ(0);
            animation: fadeInButton 0.5s ease 0.7s forwards;
            will-change: transform, opacity;
        }

        .tasks-button:hover {
            background: rgba(255, 106, 0, 0.5);
            transform: scale(1.1) translateZ(0);
            box-shadow: 0 0 30px rgba(255, 106, 0, 0.5);
        }

        .tasks-button svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        /* Task Panel */
        .task-panel {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 100px));
            left: calc(env(safe-area-inset-left, 20px));
            background: rgba(20, 20, 40, 0.95);
            border: 2px solid rgba(255, 106, 0, 0.5);
            border-radius: 20px;
            padding: 20px;
            z-index: 1002;
            max-width: 350px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(255, 106, 0, 0.3);
            display: none;
        }

        .task-panel.active {
            display: block;
        }

        .task-panel h3 {
            margin: 0 0 15px 0;
            font-size: 20px;
            background: linear-gradient(45deg, #ff6a00, #ff8c00, #ffa500);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .upload-conversation-btn {
            background: linear-gradient(45deg, #742774, #4a90e2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 0;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upload-conversation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(116, 39, 116, 0.4);
        }

        .conversation-upload-input {
            display: none;
        }

        /* NEW FEATURE: Conversation Search & Filter Styles */
        .conversation-search-container {
            margin: 15px 0;
        }

        .conversation-search-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .conversation-search-input:focus {
            outline: none;
            border-color: #06ffa5;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(6, 255, 165, 0.3);
        }

        .conversation-search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .conversation-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .conversation-filter-select {
            flex: 1;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .conversation-filter-select:hover {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
        }

        .conversation-filter-select:focus {
            outline: none;
            border-color: #06ffa5;
            box-shadow: 0 0 10px rgba(6, 255, 165, 0.3);
        }

        .conversation-filter-select option {
            background: #1a1a2e;
            color: white;
        }

        .clear-search-btn {
            width: 38px;
            height: 38px;
            background: rgba(255, 0, 102, 0.2);
            border: 2px solid rgba(255, 0, 102, 0.4);
            border-radius: 8px;
            color: #ff0066;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .clear-search-btn:hover {
            background: rgba(255, 0, 102, 0.3);
            border-color: #ff0066;
            transform: scale(1.05);
        }

        .clear-search-btn:active {
            transform: scale(0.95);
        }

        .conversation-count {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
        }

        .task-item.hidden {
            display: none;
        }

        .task-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 106, 0, 0.5);
            transform: translateX(5px);
        }

        .task-item strong {
            color: #ffa500;
            display: block;
            margin-bottom: 5px;
        }

        .task-item small {
            color: rgba(255, 255, 255, 0.6);
            display: block;
            margin-top: 5px;
        }

        .world-ui {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: env(safe-area-inset-left, 20px);
            z-index: 1001;
            pointer-events: none;
            opacity: 0;
            animation: fadeIn 0.5s ease 0.3s forwards;
        }

        .world-title {
            font-size: 3em;
            font-weight: 100;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            background: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff, #06ffa5);
            background-size: 400% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 8s ease-in-out infinite;
            margin-bottom: 10px;
        }

        .world-description {
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.6);
            max-width: 400px;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid rgba(0, 255, 255, 0.5);
            animation: slideIn 0.3s ease;
            z-index: 1005;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Inactive AI Companion Text */
        .inactive-companion-text {
            position: absolute;
            color: #ff6a00;
            font-size: 1.2em;
            text-align: center;
            width: 300px;
            margin-left: -150px;
            text-shadow: 0 0 10px rgba(255, 106, 0, 0.5);
            animation: floatText 3s ease-in-out infinite;
        }

        @keyframes floatText {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* NEW FEATURE: Onboarding Tutorial System */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 15000;
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .onboarding-overlay.active {
            display: block;
            opacity: 1;
        }

        .onboarding-spotlight {
            position: absolute;
            border: 3px solid #06ffa5;
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75), 0 0 30px rgba(6, 255, 165, 0.6);
            pointer-events: none;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            animation: spotlightPulse 2s infinite;
            z-index: 15001;
        }

        @keyframes spotlightPulse {
            0%, 100% {
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75), 0 0 30px rgba(6, 255, 165, 0.6);
            }
            50% {
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75), 0 0 50px rgba(6, 255, 165, 0.9);
            }
        }

        .onboarding-tooltip {
            position: absolute;
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.98), rgba(30, 30, 50, 0.98));
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(6, 255, 165, 0.3);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            min-width: 300px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 15002;
            animation: tooltipSlideIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes tooltipSlideIn {
            from {
                transform: translateY(-20px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .onboarding-tooltip-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #06ffa5;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .onboarding-tooltip-icon {
            font-size: 1.5em;
        }

        .onboarding-tooltip-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 1em;
        }

        .onboarding-tooltip-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .onboarding-progress {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85em;
            font-weight: 500;
        }

        .onboarding-controls {
            display: flex;
            gap: 10px;
        }

        .onboarding-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .onboarding-btn-skip {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .onboarding-btn-skip:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .onboarding-btn-next {
            background: linear-gradient(45deg, #8a2be2, #06ffa5);
            color: white;
            border: none;
        }

        .onboarding-btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 255, 165, 0.4);
        }

        .onboarding-btn:active {
            transform: translateY(0);
        }

        .onboarding-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            z-index: 15002;
        }

        .onboarding-arrow.top {
            border-width: 0 10px 12px 10px;
            border-color: transparent transparent rgba(20, 20, 40, 0.98) transparent;
            top: -12px;
        }

        .onboarding-arrow.bottom {
            border-width: 12px 10px 0 10px;
            border-color: rgba(20, 20, 40, 0.98) transparent transparent transparent;
            bottom: -12px;
        }

        .onboarding-arrow.left {
            border-width: 10px 12px 10px 0;
            border-color: transparent rgba(20, 20, 40, 0.98) transparent transparent;
            left: -12px;
        }

        .onboarding-arrow.right {
            border-width: 10px 0 10px 12px;
            border-color: transparent transparent transparent rgba(20, 20, 40, 0.98);
            right: -12px;
        }

        /* Mobile adjustments for onboarding */
        @media (max-width: 480px) {
            .onboarding-tooltip {
                max-width: calc(100% - 40px);
                min-width: auto;
                padding: 20px;
                left: 20px !important;
                right: 20px;
                width: auto !important;
            }

            .onboarding-tooltip-title {
                font-size: 1.2em;
            }

            .onboarding-tooltip-content {
                font-size: 0.95em;
            }

            .onboarding-tooltip-footer {
                flex-direction: column;
                align-items: stretch;
            }

            .onboarding-controls {
                width: 100%;
            }

            .onboarding-btn {
                flex: 1;
            }
        }

        @media (max-width: 768px) {
            .world-title {
                font-size: 2em;
            }

            .world-description {
                font-size: 1em;
                max-width: 300px;
            }

            .ai-chat-interface {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
                height: 350px;
                bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
            }

            .voice-pause-button {
                width: 100px;
                height: 45px;
                font-size: 13px;
            }

            .settings-panel {
                width: 95%;
                padding: 20px;
            }

            .settings-tabs {
                flex-wrap: wrap;
            }

            .perspective-controls {
                grid-template-columns: 1fr;
            }

            .tool-overlay {
                width: 95%;
                height: 90vh;
            }
        }

        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            body {
                position: fixed;
                height: 100vh;
                height: -webkit-fill-available;
            }

            #three-container {
                height: 100vh;
                height: -webkit-fill-available;
            }
        }

        /* Browser compatibility fallback for backdrop-filter */
        @supports not (backdrop-filter: blur(10px)) and not (-webkit-backdrop-filter: blur(10px)) {
            .show-mode-button {
                background: rgba(0, 255, 255, 0.7) !important;
            }
            .settings-button {
                background: rgba(138, 43, 226, 0.7) !important;
            }
            .tool-gallery-button {
                background: rgba(255, 106, 0, 0.7) !important;
            }
            .ai-companion-button {
                background: rgba(131, 56, 236, 0.7) !important;
            }
            .tasks-button {
                background: rgba(255, 106, 0, 0.7) !important;
            }
            .voice-pause-button {
                background: rgba(255, 0, 0, 0.7) !important;
            }
            .voice-pause-button.paused {
                background: rgba(255, 165, 0, 0.7) !important;
            }
            .show-mode-status {
                background: rgba(0, 0, 0, 0.95) !important;
            }
            .onboarding-overlay {
                background: rgba(0, 0, 0, 0.95) !important;
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="loading-logo">
                <div class="loading-orb"></div>
            </div>
            <div class="loading-text">Initializing AI Companion</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loading-progress"></div>
            </div>
            <div class="loading-status" id="loading-status">Loading core modules...</div>
        </div>
    </div>

    <div id="three-container"></div>

    <!-- Tool Overlay Window -->
    <div class="tool-overlay" id="tool-overlay">
        <div class="tool-overlay-header">
            <div class="tool-overlay-title">
                <span id="tool-overlay-icon"></span>
                <span id="tool-overlay-title">Loading Tool...</span>
            </div>
            <div class="tool-overlay-actions">
                <a href="#" target="_blank" class="tool-overlay-btn primary" id="tool-overlay-new-tab">
                    Open in New Tab
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                </a>
                <button class="tool-overlay-btn" id="tool-overlay-refresh">
                    Refresh
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                   </svg>
               </button>
           </div>
           <button class="tool-overlay-close" id="tool-overlay-close">&times;</button>
       </div>
       <div class="tool-overlay-content">
           <div class="tool-loading" id="tool-loading">
               <div class="tool-loading-spinner"></div>
               <p>Loading tool...</p>
           </div>
           <iframe class="tool-iframe" id="tool-iframe" style="display: none;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-downloads"></iframe>
       </div>
   </div>

   <!-- Click to Chat Tooltip -->
   <div class="companion-tooltip" id="companion-tooltip">Click to chat</div>

   <!-- Viewer Mode Indicator -->
   <div class="viewer-mode-indicator" id="viewer-mode-indicator">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
           <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
           <circle cx="12" cy="12" r="3"></circle>
       </svg>
       <span>Viewing Mode</span>
   </div>

   <!-- Following Indicator -->
   <div class="following-indicator" id="following-indicator">
       <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
           <circle cx="12" cy="12" r="10"/>
           <polygon points="10 8 16 12 10 16 10 8"/>
       </svg>
       <span>Following Presenter's View</span>
   </div>

   <!-- Show Mode Status -->
   <div class="show-mode-status" id="show-mode-status">
       <div class="status-indicator" id="status-indicator"></div>
       <span class="status-text" id="status-text">Connecting...</span>
       <div class="viewer-count">
           <span id="viewer-count">1</span> viewers
       </div>
   </div>

   <!-- Voice Pause Button -->
   <div class="voice-pause-button" id="voice-pause-button" role="button" tabindex="0" aria-label="Pause voice responses" aria-pressed="false">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
           <path d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
       </svg>
       <span id="voice-pause-text">Pause Voice</span>
   </div>

   <!-- Voice Paused Indicator -->
   <div class="voice-paused-indicator" id="voice-paused-indicator" role="status" aria-live="polite">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
           <path d="M10 9v6m4-6v6"></path>
       </svg>
       <span>Voice Paused</span>
   </div>

   <!-- NEW FEATURE: Onboarding Tutorial System -->
   <div class="onboarding-overlay" id="onboarding-overlay">
       <div class="onboarding-spotlight" id="onboarding-spotlight"></div>
       <div class="onboarding-tooltip" id="onboarding-tooltip" role="dialog" aria-labelledby="onboarding-title">
           <div class="onboarding-arrow" id="onboarding-arrow"></div>
           <div class="onboarding-tooltip-title">
               <span class="onboarding-tooltip-icon" id="onboarding-icon" aria-hidden="true"></span>
               <span id="onboarding-title">Welcome!</span>
           </div>
           <div class="onboarding-tooltip-content" id="onboarding-content">
               Let me show you around your AI Companion Hub...
           </div>
           <div class="onboarding-tooltip-footer">
               <span class="onboarding-progress" id="onboarding-progress" aria-live="polite">Step 1 of 5</span>
               <div class="onboarding-controls">
                   <button class="onboarding-btn onboarding-btn-skip" id="onboarding-skip" aria-label="Skip tutorial">Skip</button>
                   <button class="onboarding-btn onboarding-btn-next" id="onboarding-next" aria-label="Next step">Next</button>
               </div>
           </div>
       </div>
   </div>

   <!-- Tool Gallery Button -->
   <div class="tool-gallery-button" id="tool-gallery-button" role="button" tabindex="0" aria-label="Open tool gallery">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
           <rect x="3" y="3" width="7" height="7"></rect>
           <rect x="14" y="3" width="7" height="7"></rect>
           <rect x="14" y="14" width="7" height="7"></rect>
           <rect x="3" y="14" width="7" height="7"></rect>
       </svg>
   </div>

   <!-- Show Mode Button -->
   <div class="show-mode-button" id="show-mode-button" role="button" tabindex="0" aria-label="Toggle Show Mode - Share your screen with viewers">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
           <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
           <circle cx="12" cy="12" r="3"></circle>
       </svg>
   </div>

   <!-- Show Mode Modal -->
   <div class="show-mode-modal" id="show-mode-modal">
       <div class="show-mode-modal-content">
           <button class="modal-close" id="show-mode-close" aria-label="Close">&times;</button>
           <h3>Show Mode</h3>
           <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px;">
               Share your perspective in real-time. Others can scan the QR code to follow your view.
           </p>
           <div class="show-mode-info" id="show-mode-info" role="status">
                Show Mode Active - Viewers will see what you see in real-time!
           </div>
           <div id="qr-code-container"></div>
           <p class="qr-url" id="qr-url"></p>
           <button class="copy-url-btn" id="copy-url-btn">Copy URL</button>
       </div>
   </div>

   <!-- Settings Panel -->
   <div class="settings-panel" id="settings-panel">
       <button class="close-settings" id="close-settings" aria-label="Close settings">&times;</button>
       <h2>AI Companion Settings</h2>

       <div class="settings-tabs" role="tablist">
           <button class="settings-tab active" data-tab="general" role="tab" aria-selected="true" aria-controls="general-settings">General</button>
           <button class="settings-tab" data-tab="voice" role="tab" aria-selected="false" aria-controls="voice-settings">Voice</button>
           <button class="settings-tab" data-tab="perspective" role="tab" aria-selected="false" aria-controls="perspective-settings">3D View</button>
           <button class="settings-tab" data-tab="import-export" role="tab" aria-selected="false" aria-controls="import-export-settings">Import/Export</button>
       </div>

       <!-- General Settings -->
       <div class="settings-section active" id="general-settings" role="tabpanel">
           <div class="settings-group">
               <h3>API Configuration</h3>
               <div class="setting-item">
                   <label for="settings-api-key">API Key</label>
                   <input type="password" id="settings-api-key" placeholder="Enter your API key" aria-required="true">
               </div>
               <div class="setting-item">
                   <label for="settings-endpoint">API Endpoint</label>
                   <input type="text" id="settings-endpoint" value="https://azfbusinessbot.azurewebsites.net/api/businessinsightbot_function" aria-required="true">
               </div>
           </div>

           <div class="settings-group">
               <h3>World Settings</h3>
               <div class="setting-item">
                   <label for="world-name">World Name</label>
                   <input type="text" id="world-name" value="AI Companion Hub">
               </div>
               <div class="setting-item">
                   <label for="world-description">World Description</label>
                   <input type="text" id="world-description" value="Your intelligent assistant awaits. Click on the AI companion to start chatting!">
               </div>
           </div>
       </div>

       <!-- Voice Settings -->
       <div class="settings-section" id="voice-settings" role="tabpanel" hidden>
           <div class="settings-group">
               <h3>Voice Output</h3>
               <div class="toggle-setting">
                   <label for="settings-voice-enabled">Enable Voice Response</label>
                   <div class="toggle-switch" id="settings-voice-enabled" role="switch" aria-checked="true"></div>
               </div>
               <div class="toggle-setting">
                   <label for="settings-auto-speak">Auto-speak Responses</label>
                   <div class="toggle-switch" id="settings-auto-speak" role="switch" aria-checked="false"></div>
               </div>
               <div class="setting-item">
                   <label for="settings-azure-tts-key">Azure TTS API Key</label>
                   <input type="password" id="settings-azure-tts-key" placeholder="Enter Azure TTS key for premium voices">
               </div>
               <div class="setting-item">
                   <label for="settings-tts-voice">TTS Voice</label>
                   <select id="settings-tts-voice">
                       <option value="en-US-JennyNeural">Jenny (Female)</option>
                       <option value="en-US-GuyNeural">Guy (Male)</option>
                       <option value="en-US-AriaNeural">Aria (Female)</option>
                       <option value="en-US-DavisNeural">Davis (Male)</option>
                       <option value="en-US-AmberNeural">Amber (Female)</option>
                       <option value="en-US-JasonNeural">Jason (Male)</option>
                       <option value="en-GB-SoniaNeural">Sonia (British Female)</option>
                       <option value="en-GB-RyanNeural">Ryan (British Male)</option>
                   </select>
               </div>
           </div>

           <div class="settings-group">
               <h3>Voice Input</h3>
               <div class="toggle-setting">
                   <label for="settings-voice-input-enabled">Enable Voice Input</label>
                   <div class="toggle-switch active" id="settings-voice-input-enabled" role="switch" aria-checked="true"></div>
               </div>
               <div class="toggle-setting">
                   <label for="settings-continuous-conversation">Continuous Conversation Mode</label>
                   <div class="toggle-switch" id="settings-continuous-conversation" role="switch" aria-checked="false"></div>
               </div>
               <div class="setting-item">
                   <label for="settings-push-to-talk">Push-to-Talk Key</label>
                   <select id="settings-push-to-talk">
                       <option value="Space">Space</option>
                       <option value="v">V</option>
                       <option value="t">T</option>
                       <option value="Control">Ctrl</option>
                       <option value="Alt">Alt</option>
                   </select>
               </div>
           </div>
       </div>

       <!-- Perspective Settings -->
       <div class="settings-section" id="perspective-settings" role="tabpanel" hidden>
           <div class="settings-group">
               <h3>Camera Controls</h3>
               <div class="perspective-controls">
                   <div class="setting-item">
                       <label>Position X <span class="range-value" id="pos-x-value">0</span></label>
                       <input type="range" id="camera-pos-x" min="-50" max="50" value="0" step="0.5">
                   </div>
                   <div class="setting-item">
                       <label>Position Y <span class="range-value" id="pos-y-value">5</span></label>
                       <input type="range" id="camera-pos-y" min="-20" max="50" value="5" step="0.5"></div>
                   <div class="setting-item">
                       <label>Position Z <span class="range-value" id="pos-z-value">8</span></label>
                       <input type="range" id="camera-pos-z" min="-50" max="50" value="8" step="0.5">
                   </div>
                   <div class="setting-item">
                       <label>Rotation X <span class="range-value" id="rot-x-value">0</span></label>
                       <input type="range" id="camera-rot-x" min="-180" max="180" value="0" step="1">
                   </div>
                   <div class="setting-item">
                       <label>Rotation Y <span class="range-value" id="rot-y-value">0</span></label>
                       <input type="range" id="camera-rot-y" min="-180" max="180" value="0" step="1">
                   </div>
                   <div class="setting-item">
                       <label>FOV <span class="range-value" id="fov-value">75</span></label>
                       <input type="range" id="camera-fov" min="30" max="120" value="75" step="1">
                   </div>
               </div>

               <h4 style="margin-top: 20px; margin-bottom: 10px; color: #8a2be2;">Presets</h4>
               <div class="perspective-preset">
                   <button class="preset-btn" onclick="window.worldNavigator.perspectiveManager.applyPreset('default')">Default</button>
                   <button class="preset-btn" onclick="window.worldNavigator.perspectiveManager.applyPreset('overhead')">Overhead</button>
                   <button class="preset-btn" onclick="window.worldNavigator.perspectiveManager.applyPreset('close')">Close-up</button>
                   <button class="preset-btn" onclick="window.worldNavigator.perspectiveManager.applyPreset('side')">Side View</button>
                   <button class="preset-btn" onclick="window.worldNavigator.perspectiveManager.applyPreset('wide')">Wide Angle</button>
                   <button class="preset-btn" onclick="window.worldNavigator.perspectiveManager.applyPreset('dramatic')">Dramatic</button>
               </div>
           </div>

           <div class="settings-group">
               <h3>Visual Settings</h3>
               <div class="setting-item">
                   <label>Fog Density <span class="range-value" id="fog-density-value">50</span></label>
                   <input type="range" id="fog-density" min="10" max="200" value="50" step="5">
               </div>
               <div class="setting-item">
                   <label>Particle Count <span class="range-value" id="particle-count-value">300</span></label>
                   <input type="range" id="particle-count" min="0" max="1000" value="300" step="50">
               </div>
           </div>
       </div>

       <!-- Import/Export Settings -->
       <div class="settings-section" id="import-export-settings" role="tabpanel" hidden>
           <div class="import-export-section">
               <h4>Export Settings</h4>
               <p style="color: rgba(255, 255, 255, 0.6); margin-bottom: 15px; font-size: 14px;">
                   Export all your settings including API keys, voice configuration, and 3D perspective as a JSON file.
               </p>
               <div class="json-preview" id="json-preview"></div>
               <button class="settings-btn" onclick="window.worldNavigator.settingsManager.exportSettings()">
                   Export Settings to JSON
               </button>
           </div>

           <div class="import-export-section" style="margin-top: 30px;">
               <h4>Import Settings</h4>
               <p style="color: rgba(255, 255, 255, 0.6); margin-bottom: 15px; font-size: 14px;">
                   Import a previously exported settings file to restore your configuration.
               </p>
               <div class="file-input-wrapper">
                   <input type="file" id="import-settings-file" accept=".json" onchange="window.worldNavigator.settingsManager.importSettings(event)">
                   <label for="import-settings-file" class="file-input-label">
                       Click to select settings file or drag and drop here
                   </label>
               </div>
           </div>

           <div class="import-export-section" style="margin-top: 30px;">
               <h4>Danger Zone</h4>
               <p style="color: rgba(255, 165, 0, 0.8); margin-bottom: 15px; font-size: 14px;">
                    This action will reset all settings to their default values. This cannot be undone.
               </p>
               <button class="settings-btn danger" onclick="window.worldNavigator.settingsManager.resetSettings()">
                   Reset All Settings
               </button>
           </div>
       </div>

       <div class="settings-actions">
           <button class="settings-btn" onclick="window.worldNavigator.settingsManager.saveSettings()">Save Changes</button>
           <button class="settings-btn secondary" onclick="document.getElementById('settings-panel').classList.remove('active')">Cancel</button>
       </div>
   </div>

   <!-- Voice Indicator -->
   <div class="voice-indicator" id="voice-indicator" role="status" aria-live="polite">
       <i class="fas fa-volume-up"></i>
       <span>Speaking...</span>
   </div>

   <!-- Listening Indicator -->
   <div class="listening-indicator" id="listening-indicator" role="status" aria-live="polite">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
           <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
           <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
           <line x1="12" y1="19" x2="12" y2="23"></line>
           <line x1="8" y1="23" x2="16" y2="23"></line>
       </svg>
       <span>Listening...</span>
   </div>

   <!-- AI Chat Interface -->
   <div class="ai-chat-interface" id="ai-chat-interface">
       <div class="ai-chat-header">
           <div class="ai-chat-title">
               AI Companion Chat
               <span class="viewer-chat-label" id="viewer-chat-label" style="display: none;">Viewer Mode</span>
           </div>
           <button class="modal-close" onclick="document.getElementById('ai-chat-interface').classList.remove('active')" aria-label="Close chat">&times;</button>
       </div>
       <div class="ai-chat-messages" id="ai-chat-messages" role="log" aria-live="polite" aria-relevant="additions"></div>
       <div class="ai-chat-input-container">
           <input type="text" class="ai-chat-input" id="ai-chat-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') window.worldNavigator.aiManager.sendMessage()" aria-label="Chat message">
           <button class="voice-input-btn" id="voice-input-btn" title="Hold to speak" aria-label="Voice input - Hold to speak">
               <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                   <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                   <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                   <line x1="12" y1="19" x2="12" y2="23"></line>
                   <line x1="8" y1="23" x2="16" y2="23"></line>
               </svg>
           </button>
           <button class="ai-chat-send" onclick="window.worldNavigator.aiManager.sendMessage()" aria-label="Send message">Send</button>
       </div>
   </div>

   <!-- Task Panel -->
   <div class="task-panel" id="task-panel">
       <h3> Saved Conversations</h3>

       <!-- NEW FEATURE: Conversation Search & Filter -->
       <div class="conversation-search-container">
           <input type="text"
                  id="conversation-search"
                  class="conversation-search-input"
                  placeholder=" Search conversations..."
                  aria-label="Search conversations">
           <div class="conversation-filters">
               <select id="conversation-sort" class="conversation-filter-select" aria-label="Sort conversations">
                   <option value="newest">Newest First</option>
                   <option value="oldest">Oldest First</option>
                   <option value="most-messages">Most Messages</option>
                   <option value="name">By Name (A-Z)</option>
               </select>
               <button id="clear-search" class="clear-search-btn" aria-label="Clear search" title="Clear search"></button>
           </div>
       </div>

       <button class="upload-conversation-btn" onclick="document.getElementById('conversation-upload-input').click()">
           <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
               <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
               <polyline points="17 8 12 3 7 8"></polyline>
               <line x1="12" y1="3" x2="12" y2="15"></line>
           </svg>
           Upload Conversation JSON
       </button>
       <input type="file" id="conversation-upload-input" class="conversation-upload-input" accept=".json" onchange="window.worldNavigator.taskManager.uploadConversation(event)">

       <div class="conversation-count" id="conversation-count" role="status" aria-live="polite">
           <!-- Count populated here -->
       </div>

       <div id="task-list">
           <!-- Tasks populated here -->
       </div>
   </div>

   <div class="world-ui">
       <h1 class="world-title" id="world-title">AI COMPANION HUB</h1>
       <p class="world-description" id="world-description">Your intelligent assistant awaits. Click on the AI companion to start chatting!</p>
   </div>

   <!-- AI Companion Button -->
   <div class="ai-companion-button" id="ai-companion-button" role="button" tabindex="0" aria-label="Open AI Chat - Click or press Enter to talk with your companion">
       <svg class="view-toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
           <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
       </svg>
   </div>

   <!-- Tasks Button -->
   <div class="tasks-button" id="tasks-button" role="button" tabindex="0" aria-label="Open conversation tasks and history">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
           <path d="M9 11l3 3L22 4"></path>
           <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
       </svg>
   </div>

   <!-- Settings Button -->
   <div class="settings-button" id="settings-button" role="button" tabindex="0" aria-label="Open settings - Configure API, voice, and preferences">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
           <circle cx="12" cy="12" r="3"></circle>
           <path d="M12 1v6m0 6v6m4.22-10.22l1.42-1.42m-1.42 8.49l1.42 1.42M20 12h-6m-6 0H1m4.22 4.22l-1.42 1.42m1.42-8.49L3.8 7.73"></path>
       </svg>
   </div>

   <!-- Load Three.js early -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

   <!-- Main JavaScript -->
   <script>
       // ==================== ONBOARDING SYSTEM ====================
      class OnboardingManager {
          constructor() {
              this.currentStep = 0;
              this.isActive = false;
              this.steps = [
                  {
                      title: 'Welcome to AI Companion Hub! ',
                      content: 'Let me show you around. This is your personal AI assistant in a beautiful 3D environment.',
                      icon: '',
                      target: '.world-ui',
                      position: 'bottom'
                  },
                  {
                      title: 'Chat with Your Companion ',
                      content: 'Click this star button to open the AI chat panel. You can talk with your companion using text or voice!',
                      icon: '',
                      target: '.ai-companion-button',
                      position: 'left'
                  },
                  {
                      title: 'Manage Your Conversations ',
                      content: 'Access all your conversation history, tasks, and saved chats here. Everything is stored locally on your device.',
                      icon: '',
                      target: '.tasks-button',
                      position: 'left'
                  },
                  {
                      title: 'Configure Settings ',
                      content: 'Set up your API keys, customize voice preferences, and adjust your companion\'s appearance here.',
                      icon: '',
                      target: '.settings-button',
                      position: 'left'
                  },
                  {
                      title: 'You\'re All Set! ',
                      content: 'Start chatting with your AI companion. Your conversations are private and stored locally. Enjoy!',
                      icon: '',
                      target: '.ai-companion-button',
                      position: 'left'
                  }
              ];

              this.overlay = document.getElementById('onboarding-overlay');
              this.spotlight = document.getElementById('onboarding-spotlight');
              this.tooltip = document.getElementById('onboarding-tooltip');
              this.arrow = document.getElementById('onboarding-arrow');
              this.iconEl = document.getElementById('onboarding-icon');
              this.titleEl = document.getElementById('onboarding-title');
              this.contentEl = document.getElementById('onboarding-content');
              this.progressEl = document.getElementById('onboarding-progress');
              this.nextBtn = document.getElementById('onboarding-next');
              this.skipBtn = document.getElementById('onboarding-skip');

              this.setupEventListeners();
          }

          setupEventListeners() {
              this.nextBtn.addEventListener('click', () => this.next());
              this.skipBtn.addEventListener('click', () => this.skip());

              // Keyboard navigation
              document.addEventListener('keydown', (e) => {
                  if (!this.isActive) return;

                  if (e.key === 'Escape') {
                      this.skip();
                  } else if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault();
                      this.next();
                  }
              });
          }

          start() {
              // Check if user has seen onboarding before
              if (localStorage.getItem('onboarding_completed') === 'true') {
                  return;
              }

              this.isActive = true;
              this.currentStep = 0;
              this.overlay.classList.add('active');
              this.showStep(0);
          }

          showStep(index) {
              const step = this.steps[index];
              if (!step) return;

              // Update content
              this.iconEl.textContent = step.icon;
              this.titleEl.textContent = step.title;
              this.contentEl.textContent = step.content;
              this.progressEl.textContent = `Step ${index + 1} of ${this.steps.length}`;

              // Update button text
              if (index === this.steps.length - 1) {
                  this.nextBtn.textContent = 'Get Started';
              } else {
                  this.nextBtn.textContent = 'Next';
              }

              // Position spotlight and tooltip
              this.positionElements(step);
          }

          positionElements(step) {
              const targetEl = document.querySelector(step.target);
              if (!targetEl) return;

              const rect = targetEl.getBoundingClientRect();

              // Position spotlight
              this.spotlight.style.left = `${rect.left - 10}px`;
              this.spotlight.style.top = `${rect.top - 10}px`;
              this.spotlight.style.width = `${rect.width + 20}px`;
              this.spotlight.style.height = `${rect.height + 20}px`;

              // Position tooltip
              const tooltipRect = this.tooltip.getBoundingClientRect();
              let tooltipLeft, tooltipTop;

              switch (step.position) {
                  case 'bottom':
                      tooltipLeft = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                      tooltipTop = rect.bottom + 20;
                      this.arrow.className = 'onboarding-arrow onboarding-arrow-top';
                      break;
                  case 'left':
                      tooltipLeft = rect.left - tooltipRect.width - 20;
                      tooltipTop = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                      this.arrow.className = 'onboarding-arrow onboarding-arrow-right';
                      break;
                  case 'right':
                      tooltipLeft = rect.right + 20;
                      tooltipTop = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                      this.arrow.className = 'onboarding-arrow onboarding-arrow-left';
                      break;
                  case 'top':
                      tooltipLeft = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                      tooltipTop = rect.top - tooltipRect.height - 20;
                      this.arrow.className = 'onboarding-arrow onboarding-arrow-bottom';
                      break;
              }

              // Ensure tooltip stays within viewport
              tooltipLeft = Math.max(20, Math.min(tooltipLeft, window.innerWidth - tooltipRect.width - 20));
              tooltipTop = Math.max(20, Math.min(tooltipTop, window.innerHeight - tooltipRect.height - 20));

              this.tooltip.style.left = `${tooltipLeft}px`;
              this.tooltip.style.top = `${tooltipTop}px`;
          }

          next() {
              if (this.currentStep < this.steps.length - 1) {
                  this.currentStep++;
                  this.showStep(this.currentStep);
              } else {
                  this.complete();
              }
          }

          skip() {
              this.complete();
          }

          complete() {
              this.isActive = false;
              this.overlay.classList.remove('active');
              localStorage.setItem('onboarding_completed', 'true');
          }
      }

      // ==================== EMOTION SYSTEM ====================
      class EmotionSystem {
          constructor(worldNavigator) {
              this.worldNavigator = worldNavigator;
              this.currentMood = 'neutral';
              this.moodColors = {
                  happy: { h: 0.33, s: 0.8, l: 0.6 },      // Green
                  excited: { h: 0.58, s: 0.9, l: 0.6 },    // Cyan
                  calm: { h: 0.55, s: 0.5, l: 0.7 },       // Light blue
                  curious: { h: 0.75, s: 0.7, l: 0.6 },    // Purple
                  thoughtful: { h: 0.66, s: 0.6, l: 0.5 }, // Blue
                  neutral: { h: 0.5, s: 0.5, l: 0.6 }      // Cyan (default)
              };
          }

          analyzeSentiment(text) {
              const lowerText = text.toLowerCase();

              // Happy keywords
              if (/(happy|joy|excited|amazing|wonderful|great|awesome|fantastic|love|perfect)/i.test(lowerText)) {
                  return 'happy';
              }

              // Excited keywords
              if (/(wow|incredible|omg|yes!|brilliant|excellent|superb)/i.test(lowerText)) {
                  return 'excited';
              }

              // Curious keywords
              if (/(how|why|what|when|where|curious|wonder|interesting|tell me)/i.test(lowerText)) {
                  return 'curious';
              }

              // Thoughtful keywords
              if (/(think|consider|perhaps|maybe|understand|realize|contemplate)/i.test(lowerText)) {
                  return 'thoughtful';
              }

              // Calm keywords
              if (/(calm|peaceful|relax|serene|tranquil|quiet|gentle)/i.test(lowerText)) {
                  return 'calm';
              }

              return 'neutral';
          }

          updateMood(mood) {
              if (this.currentMood === mood) return;

              this.currentMood = mood;
              const color = this.moodColors[mood] || this.moodColors.neutral;

              // Smoothly transition companion color
              if (this.worldNavigator && this.worldNavigator.companion) {
                  this.transitionColor(color);
              }
          }

          transitionColor(targetColor) {
              // Animate color transition over 1 second
              const startColor = this.getCurrentColor();
              const duration = 1000;
              const startTime = Date.now();

              const animate = () => {
                  const elapsed = Date.now() - startTime;
                  const progress = Math.min(elapsed / duration, 1);

                  // Ease in-out interpolation
                  const eased = progress < 0.5
                      ? 2 * progress * progress
                      : 1 - Math.pow(-2 * progress + 2, 2) / 2;

                  const h = startColor.h + (targetColor.h - startColor.h) * eased;
                  const s = startColor.s + (targetColor.s - startColor.s) * eased;
                  const l = startColor.l + (targetColor.l - startColor.l) * eased;

                  if (this.worldNavigator && this.worldNavigator.companion) {
                      this.worldNavigator.companion.material.color.setHSL(h, s, l);
                  }

                  if (progress < 1) {
                      requestAnimationFrame(animate);
                  }
              };

              animate();
          }

          getCurrentColor() {
              if (!this.worldNavigator || !this.worldNavigator.companion) {
                  return this.moodColors.neutral;
              }

              const color = this.worldNavigator.companion.material.color;
              return {
                  h: color.getHSL({ h: 0, s: 0, l: 0 }).h,
                  s: color.getHSL({ h: 0, s: 0, l: 0 }).s,
                  l: color.getHSL({ h: 0, s: 0, l: 0 }).l
              };
          }

          respondToMessage(text) {
              const mood = this.analyzeSentiment(text);
              this.updateMood(mood);
              return mood;
          }
      }

      // ==================== SWIPE GESTURE MANAGER ====================
      class SwipeGestureManager {
          constructor() {
              this.touchStartX = 0;
              this.touchStartY = 0;
              this.touchEndX = 0;
              this.touchEndY = 0;
              this.minSwipeDistance = 50;
              this.panels = [
                  { element: document.getElementById('ai-panel'), closeButton: null },
                  { element: document.getElementById('settings-panel'), closeButton: document.getElementById('close-settings') },
                  { element: document.getElementById('task-panel'), closeButton: document.getElementById('close-tasks') }
              ];

              this.setupGestures();
          }

          setupGestures() {
              this.panels.forEach(panel => {
                  if (!panel.element) return;

                  panel.element.addEventListener('touchstart', (e) => {
                      this.touchStartX = e.changedTouches[0].screenX;
                      this.touchStartY = e.changedTouches[0].screenY;
                  }, { passive: true });

                  panel.element.addEventListener('touchend', (e) => {
                      this.touchEndX = e.changedTouches[0].screenX;
                      this.touchEndY = e.changedTouches[0].screenY;
                      this.handleSwipe(panel);
                  }, { passive: true });
              });
          }

          handleSwipe(panel) {
              const deltaX = this.touchEndX - this.touchStartX;
              const deltaY = this.touchEndY - this.touchStartY;

              // Check if horizontal swipe is dominant and exceeds minimum distance
              if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > this.minSwipeDistance) {
                  // Swipe right to close
                  if (deltaX > 0 && panel.closeButton) {
                      panel.closeButton.click();
                  }
              }
          }
      }

      // ==================== WORLD NAVIGATOR ====================
      class WorldNavigator {
          constructor() {
              this.scene = new THREE.Scene();
              this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
              this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });

              this.renderer.setSize(window.innerWidth, window.innerHeight);
              this.renderer.setClearColor(0x000000, 0);
              document.body.insertBefore(this.renderer.domElement, document.body.firstChild);
              this.renderer.domElement.style.position = 'fixed';
              this.renderer.domElement.style.top = '0';
              this.renderer.domElement.style.left = '0';
              this.renderer.domElement.style.zIndex = '0';

              // Setup scene
              this.setupLights();
              this.createCompanion();
              this.createStarfield();

              this.camera.position.z = 5;

              // Animation properties
              this.clock = new THREE.Clock();
              this.isInteracting = false;

              // Handle window resize
              window.addEventListener('resize', () => this.onWindowResize());

              // Start animation
              this.animate();
          }

          setupLights() {
              const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
              this.scene.add(ambientLight);

              const pointLight = new THREE.PointLight(0x06ffa5, 2, 100);
              pointLight.position.set(0, 0, 10);
              this.scene.add(pointLight);
          }

          createCompanion() {
              const geometry = new THREE.SphereGeometry(1, 32, 32);
              const material = new THREE.MeshPhongMaterial({
                  color: 0x06ffa5,
                  emissive: 0x06ffa5,
                  emissiveIntensity: 0.5,
                  shininess: 100,
                  transparent: true,
                  opacity: 0.9
              });

              this.companion = new THREE.Mesh(geometry, material);
              this.scene.add(this.companion);

              // Add glow effect
              const glowGeometry = new THREE.SphereGeometry(1.2, 32, 32);
              const glowMaterial = new THREE.MeshBasicMaterial({
                  color: 0x06ffa5,
                  transparent: true,
                  opacity: 0.2
              });
              this.companionGlow = new THREE.Mesh(glowGeometry, glowMaterial);
              this.scene.add(this.companionGlow);
          }

          createStarfield() {
              const starsGeometry = new THREE.BufferGeometry();
              const starsMaterial = new THREE.PointsMaterial({
                  color: 0xffffff,
                  size: 0.05,
                  transparent: true,
                  opacity: 0.8
              });

              const starsVertices = [];
              for (let i = 0; i < 1000; i++) {
                  const x = (Math.random() - 0.5) * 100;
                  const y = (Math.random() - 0.5) * 100;
                  const z = (Math.random() - 0.5) * 100;
                  starsVertices.push(x, y, z);
              }

              starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
              this.starfield = new THREE.Points(starsGeometry, starsMaterial);
              this.scene.add(this.starfield);
          }

          animate() {
              requestAnimationFrame(() => this.animate());

              const time = this.clock.getElapsedTime();

              // Gentle floating animation
              if (this.companion) {
                  this.companion.position.y = Math.sin(time) * 0.2;
                  this.companion.rotation.y += 0.005;

                  // Subtle scale pulsing
                  const scale = 1 + Math.sin(time * 2) * 0.05;
                  this.companion.scale.set(scale, scale, scale);
              }

              if (this.companionGlow) {
                  this.companionGlow.position.y = this.companion.position.y;
                  this.companionGlow.rotation.y = this.companion.rotation.y;

                  // Glow pulsing
                  const glowScale = 1 + Math.sin(time * 2) * 0.1;
                  this.companionGlow.scale.set(glowScale, glowScale, glowScale);
                  this.companionGlow.material.opacity = 0.2 + Math.sin(time * 2) * 0.1;
              }

              // Rotate starfield
              if (this.starfield) {
                  this.starfield.rotation.y += 0.0001;
              }

              this.renderer.render(this.scene, this.camera);
          }

          onWindowResize() {
              this.camera.aspect = window.innerWidth / window.innerHeight;
              this.camera.updateProjectionMatrix();
              this.renderer.setSize(window.innerWidth, window.innerHeight);
          }

          setInteracting(state) {
              this.isInteracting = state;
          }
      }

      // ==================== AI MANAGER ====================
      class AIManager {
          constructor() {
              this.apiKey = localStorage.getItem('openai_api_key') || '';
              this.model = localStorage.getItem('ai_model') || 'gpt-4o-mini';
              this.systemPrompt = localStorage.getItem('system_prompt') || 'You are a helpful AI assistant.';
              this.currentConversation = [];
              this.currentConversationId = null;
              this.conversations = this.loadConversations();
              this.emotionSystem = null; // Will be set later
          }

          setEmotionSystem(emotionSystem) {
              this.emotionSystem = emotionSystem;
          }

          loadConversations() {
              const saved = localStorage.getItem('conversations');
              return saved ? JSON.parse(saved) : [];
          }

          saveConversations() {
              localStorage.setItem('conversations', JSON.stringify(this.conversations));
          }

          async sendMessage(message) {
              if (!this.apiKey) {
                  throw new Error('Please set your OpenAI API key in settings');
              }

              // Analyze emotion from user message
              if (this.emotionSystem) {
                  this.emotionSystem.respondToMessage(message);
              }

              this.currentConversation.push({
                  role: 'user',
                  content: message
              });

              try {
                  const response = await fetch('https://api.openai.com/v1/chat/completions', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'Authorization': `Bearer ${this.apiKey}`
                      },
                      body: JSON.stringify({
                          model: this.model,
                          messages: [
                              { role: 'system', content: this.systemPrompt },
                              ...this.currentConversation
                          ]
                      })
                  });

                  if (!response.ok) {
                      throw new Error(`API Error: ${response.status}`);
                  }

                  const data = await response.json();
                  const aiResponse = data.choices[0].message.content;

                  this.currentConversation.push({
                      role: 'assistant',
                      content: aiResponse
                  });

                  // Save conversation
                  this.saveCurrentConversation();

                  return aiResponse;
              } catch (error) {
                  console.error('AI Error:', error);
                  throw error;
              }
          }

          saveCurrentConversation() {
              if (this.currentConversation.length === 0) return;

              if (this.currentConversationId) {
                  // Update existing conversation
                  const index = this.conversations.findIndex(c => c.id === this.currentConversationId);
                  if (index !== -1) {
                      this.conversations[index].messages = [...this.currentConversation];
                      this.conversations[index].lastModified = Date.now();
                  }
              } else {
                  // Create new conversation
                  const newConversation = {
                      id: Date.now(),
                      name: `Chat ${this.conversations.length + 1}`,
                      messages: [...this.currentConversation],
                      created: Date.now(),
                      lastModified: Date.now()
                  };
                  this.conversations.push(newConversation);
                  this.currentConversationId = newConversation.id;
              }

              this.saveConversations();
          }

          loadConversation(id) {
              const conversation = this.conversations.find(c => c.id === id);
              if (conversation) {
                  this.currentConversation = [...conversation.messages];
                  this.currentConversationId = id;
                  return conversation;
              }
              return null;
          }

          newConversation() {
              this.currentConversation = [];
              this.currentConversationId = null;
          }

          deleteConversation(id) {
              this.conversations = this.conversations.filter(c => c.id !== id);
              this.saveConversations();

              if (this.currentConversationId === id) {
                  this.newConversation();
              }
          }

          renameConversation(id, newName) {
              const conversation = this.conversations.find(c => c.id === id);
              if (conversation) {
                  conversation.name = newName;
                  this.saveConversations();
              }
          }

          exportConversation(id) {
              const conversation = this.conversations.find(c => c.id === id);
              if (conversation) {
                  const dataStr = JSON.stringify(conversation, null, 2);
                  const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                  const exportFileDefaultName = `conversation_${id}.json`;

                  const linkElement = document.createElement('a');
                  linkElement.setAttribute('href', dataUri);
                  linkElement.setAttribute('download', exportFileDefaultName);
                  linkElement.click();
              }
          }
      }

      // ==================== VOICE MANAGER ====================
      class VoiceManager {
          constructor(aiManager) {
              this.aiManager = aiManager;
              this.isListening = false;
              this.isPaused = false;
              this.isSpeaking = false;
              this.useAzureTTS = localStorage.getItem('use_azure_tts') === 'true';
              this.azureKey = localStorage.getItem('azure_tts_key') || '';
              this.azureRegion = localStorage.getItem('azure_tts_region') || '';
              this.azureVoice = localStorage.getItem('azure_voice') || 'en-US-JennyNeural';

              // Web Speech API
              this.recognition = null;
              this.synthesis = window.speechSynthesis;

              this.setupRecognition();
          }

          setupRecognition() {
              const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
              if (!SpeechRecognition) {
                  console.warn('Speech recognition not supported');
                  return;
              }

              this.recognition = new SpeechRecognition();
              this.recognition.continuous = false;
              this.recognition.interimResults = false;
              this.recognition.lang = 'en-US';

              this.recognition.onresult = (event) => {
                  const transcript = event.results[0][0].transcript;
                  this.onSpeechResult(transcript);
              };

              this.recognition.onerror = (event) => {
                  console.error('Speech recognition error:', event.error);
                  this.isListening = false;
              };

              this.recognition.onend = () => {
                  this.isListening = false;
              };
          }

          startListening() {
              if (!this.recognition) {
                  alert('Speech recognition not supported in this browser');
                  return;
              }

              if (this.isListening) return;

              try {
                  this.recognition.start();
                  this.isListening = true;
              } catch (error) {
                  console.error('Failed to start recognition:', error);
              }
          }

          stopListening() {
              if (this.recognition && this.isListening) {
                  this.recognition.stop();
                  this.isListening = false;
              }
          }

          async onSpeechResult(transcript) {
              try {
                  // Add to chat UI
                  if (window.app && window.app.addMessageToUI) {
                      window.app.addMessageToUI('user', transcript);
                  }

                  // Get AI response
                  const response = await this.aiManager.sendMessage(transcript);

                  // Add AI response to chat UI
                  if (window.app && window.app.addMessageToUI) {
                      window.app.addMessageToUI('assistant', response);
                  }

                  // Speak response if not paused
                  if (!this.isPaused) {
                      await this.speak(response);
                  }
              } catch (error) {
                  console.error('Voice interaction error:', error);
              }
          }

          async speak(text) {
              if (this.isSpeaking) {
                  this.synthesis.cancel();
              }

              if (this.useAzureTTS && this.azureKey && this.azureRegion) {
                  await this.speakAzure(text);
              } else {
                  this.speakBrowser(text);
              }
          }

          speakBrowser(text) {
              const utterance = new SpeechSynthesisUtterance(text);
              utterance.rate = 1.0;
              utterance.pitch = 1.0;
              utterance.volume = 1.0;

              utterance.onstart = () => {
                  this.isSpeaking = true;
              };

              utterance.onend = () => {
                  this.isSpeaking = false;
              };

              this.synthesis.speak(utterance);
          }

          async speakAzure(text) {
              try {
                  const response = await fetch(
                      `https://${this.azureRegion}.tts.speech.microsoft.com/cognitiveservices/v1`,
                      {
                          method: 'POST',
                          headers: {
                              'Ocp-Apim-Subscription-Key': this.azureKey,
                              'Content-Type': 'application/ssml+xml',
                              'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3'
                          },
                          body: `<speak version='1.0' xml:lang='en-US'>
                                  <voice xml:lang='en-US' name='${this.azureVoice}'>
                                      ${text}
                                  </voice>
                              </speak>`
                      }
                  );

                  if (!response.ok) {
                      throw new Error('Azure TTS failed');
                  }

                  const audioBlob = await response.blob();
                  const audioUrl = URL.createObjectURL(audioBlob);
                  const audio = new Audio(audioUrl);

                  this.isSpeaking = true;
                  audio.onended = () => {
                      this.isSpeaking = false;
                      URL.revokeObjectURL(audioUrl);
                  };

                  await audio.play();
              } catch (error) {
                  console.error('Azure TTS error:', error);
                  // Fallback to browser TTS
                  this.speakBrowser(text);
              }
          }

          togglePause() {
              this.isPaused = !this.isPaused;

              if (this.isPaused && this.isSpeaking) {
                  this.synthesis.cancel();
                  this.isSpeaking = false;
              }

              return this.isPaused;
          }
      }

      // ==================== TASK MANAGER ====================
      class TaskManager {
          constructor() {
              this.tasks = this.loadTasks();
              this.searchQuery = '';
              this.sortMode = 'newest';
          }

          loadTasks() {
              const saved = localStorage.getItem('tasks');
              return saved ? JSON.parse(saved) : [];
          }

          saveTasks() {
              localStorage.setItem('tasks', JSON.stringify(this.tasks));
          }

          addTask(content) {
              const task = {
                  id: Date.now(),
                  content: content,
                  completed: false,
                  created: Date.now()
              };

              this.tasks.push(task);
              this.saveTasks();
              return task;
          }

          toggleTask(id) {
              const task = this.tasks.find(t => t.id === id);
              if (task) {
                  task.completed = !task.completed;
                  this.saveTasks();
              }
          }

          deleteTask(id) {
              this.tasks = this.tasks.filter(t => t.id !== id);
              this.saveTasks();
          }

          setSearchQuery(query) {
              this.searchQuery = query.toLowerCase();
          }

          setSortMode(mode) {
              this.sortMode = mode;
          }

          getFilteredTasks() {
              let filtered = [...this.tasks];

              // Apply search filter
              if (this.searchQuery) {
                  filtered = filtered.filter(task =>
                      task.content.toLowerCase().includes(this.searchQuery)
                  );
              }

              // Apply sorting
              switch (this.sortMode) {
                  case 'oldest':
                      filtered.sort((a, b) => a.created - b.created);
                      break;
                  case 'name':
                      filtered.sort((a, b) => a.content.localeCompare(b.content));
                      break;
                  case 'newest':
                  default:
                      filtered.sort((a, b) => b.created - a.created);
                      break;
              }

              return filtered;
          }
      }

      // ==================== SHOW MODE MANAGER ====================
      class ShowModeManager {
          constructor() {
              this.peer = null;
              this.conn = null;
              this.isPresenter = false;
              this.isViewer = false;
              this.peerId = null;
          }

          async initPeer() {
              if (!window.Peer) {
                  alert('PeerJS not loaded. Show Mode requires PeerJS.');
                  return;
              }

              this.peer = new Peer();

              this.peer.on('open', (id) => {
                  this.peerId = id;
                  console.log('Peer ID:', id);
              });

              this.peer.on('connection', (conn) => {
                  this.setupConnection(conn);
              });

              this.peer.on('error', (err) => {
                  console.error('Peer error:', err);
              });
          }

          setupConnection(conn) {
              this.conn = conn;

              conn.on('data', (data) => {
                  if (this.isViewer) {
                      this.handlePresenterData(data);
                  }
              });

              conn.on('close', () => {
                  console.log('Connection closed');
                  this.conn = null;
              });
          }

          startPresenting() {
              this.isPresenter = true;
              this.isViewer = false;

              if (!this.peer) {
                  this.initPeer();
              }

              return this.peerId;
          }

          connectToPresenter(presenterId) {
              this.isViewer = true;
              this.isPresenter = false;

              if (!this.peer) {
                  this.initPeer();
              }

              setTimeout(() => {
                  this.conn = this.peer.connect(presenterId);
                  this.setupConnection(this.conn);
              }, 1000);
          }

          sendUpdate(data) {
              if (this.isPresenter && this.conn && this.conn.open) {
                  this.conn.send(data);
              }
          }

          handlePresenterData(data) {
              // Handle different types of updates from presenter
              if (data.type === 'message') {
                  // Update chat UI with presenter's messages
                  if (window.app && window.app.addMessageToUI) {
                      window.app.addMessageToUI(data.role, data.content);
                  }
              }
          }

          disconnect() {
              this.isPresenter = false;
              this.isViewer = false;

              if (this.conn) {
                  this.conn.close();
                  this.conn = null;
              }

              if (this.peer) {
                  this.peer.destroy();
                  this.peer = null;
              }
          }
      }

      // ==================== MAIN APPLICATION ====================
      class App {
          constructor() {
              // Initialize managers
              this.world = new WorldNavigator();
              this.aiManager = new AIManager();
              this.voiceManager = new VoiceManager(this.aiManager);
              this.taskManager = new TaskManager();
              this.showModeManager = new ShowModeManager();
              this.emotionSystem = new EmotionSystem(this.world);
              this.swipeGestureManager = new SwipeGestureManager();
              this.onboardingManager = new OnboardingManager();

              // Connect emotion system to AI manager
              this.aiManager.setEmotionSystem(this.emotionSystem);

              // UI Elements
              this.aiPanel = document.getElementById('ai-panel');
              this.settingsPanel = document.getElementById('settings-panel');
              this.taskPanel = document.getElementById('task-panel');
              this.showModePanel = document.getElementById('show-mode-panel');

              // Setup event listeners
              this.setupEventListeners();

              // Load conversations into UI
              this.updateConversationList();

              // Load tasks into UI
              this.updateTaskList();

              // Setup conversation search
              this.setupConversationSearch();

              // Setup accessibility
              setupAccessibilityKeyboardNavigation();

              // Start onboarding if first time
              setTimeout(() => {
                  this.onboardingManager.start();
              }, 500);

              // Expose app globally for voice manager
              window.app = this;
          }

          setupEventListeners() {
              // AI Companion Button
              document.getElementById('ai-companion-button').addEventListener('click', () => {
                  this.togglePanel(this.aiPanel);
              });

              // Tasks Button
              document.getElementById('tasks-button').addEventListener('click', () => {
                  this.togglePanel(this.taskPanel);
              });

              // Settings Button
              document.getElementById('settings-button').addEventListener('click', () => {
                  this.togglePanel(this.settingsPanel);
              });

              // Show Mode Button
              document.getElementById('show-mode-button').addEventListener('click', () => {
                  this.togglePanel(this.showModePanel);
              });

              // Voice Pause Button
              document.getElementById('voice-pause-button').addEventListener('click', () => {
                  const isPaused = this.voiceManager.togglePause();
                  document.getElementById('voice-pause-button').classList.toggle('paused', isPaused);
              });

              // Close buttons
              document.getElementById('close-ai-panel').addEventListener('click', () => {
                  this.closePanel(this.aiPanel);
              });

              document.getElementById('close-settings').addEventListener('click', () => {
                  this.closePanel(this.settingsPanel);
              });

              document.getElementById('close-tasks').addEventListener('click', () => {
                  this.closePanel(this.taskPanel);
              });

              document.getElementById('close-show-mode').addEventListener('click', () => {
                  this.closePanel(this.showModePanel);
              });

              // AI Chat functionality
              document.getElementById('send-message').addEventListener('click', () => {
                  this.sendMessage();
              });

              document.getElementById('user-input').addEventListener('keypress', (e) => {
                  if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      this.sendMessage();
                  }
              });

              document.getElementById('voice-input').addEventListener('click', () => {
                  this.startVoiceInput();
              });

              document.getElementById('new-chat').addEventListener('click', () => {
                  this.newChat();
              });

              // Settings
              document.getElementById('save-settings').addEventListener('click', () => {
                  this.saveSettings();
              });

              document.getElementById('export-data').addEventListener('click', () => {
                  this.exportAllData();
              });

              document.getElementById('import-data').addEventListener('click', () => {
                  document.getElementById('import-file').click();
              });

              document.getElementById('import-file').addEventListener('change', (e) => {
                  this.importData(e.target.files[0]);
              });

              // Load current settings
              this.loadSettings();

              // Task management
              document.getElementById('add-task-btn').addEventListener('click', () => {
                  this.addTask();
              });

              document.getElementById('new-task-input').addEventListener('keypress', (e) => {
                  if (e.key === 'Enter') {
                      e.preventDefault();
                      this.addTask();
                  }
              });

              // Show Mode
              document.getElementById('start-presenting').addEventListener('click', () => {
                  this.startPresenting();
              });

              document.getElementById('connect-viewer').addEventListener('click', () => {
                  this.connectAsViewer();
              });

              document.getElementById('disconnect-show-mode').addEventListener('click', () => {
                  this.disconnectShowMode();
              });
          }

          setupConversationSearch() {
              const searchInput = document.getElementById('conversation-search');
              const sortSelect = document.getElementById('conversation-sort');
              const clearBtn = document.getElementById('clear-search');

              if (searchInput) {
                  searchInput.addEventListener('input', (e) => {
                      this.filterConversations(e.target.value, sortSelect.value);
                  });
              }

              if (sortSelect) {
                  sortSelect.addEventListener('change', (e) => {
                      this.filterConversations(searchInput.value, e.target.value);
                  });
              }

              if (clearBtn) {
                  clearBtn.addEventListener('click', () => {
                      searchInput.value = '';
                      this.filterConversations('', sortSelect.value);
                  });
              }
          }

          filterConversations(query, sortMode) {
              const conversations = this.aiManager.conversations;
              let filtered = [...conversations];

              // Apply search filter
              if (query) {
                  filtered = filtered.filter(conv => {
                      const nameMatch = conv.name.toLowerCase().includes(query.toLowerCase());
                      const contentMatch = conv.messages.some(msg =>
                          msg.content.toLowerCase().includes(query.toLowerCase())
                      );
                      return nameMatch || contentMatch;
                  });
              }

              // Apply sorting
              switch (sortMode) {
                  case 'oldest':
                      filtered.sort((a, b) => a.created - b.created);
                      break;
                  case 'most-messages':
                      filtered.sort((a, b) => b.messages.length - a.messages.length);
                      break;
                  case 'name':
                      filtered.sort((a, b) => a.name.localeCompare(b.name));
                      break;
                  case 'newest':
                  default:
                      filtered.sort((a, b) => b.lastModified - a.lastModified);
                      break;
              }

              this.updateConversationList(filtered);
          }

          togglePanel(panel) {
              const isActive = panel.classList.contains('active');

              // Close all panels first
              [this.aiPanel, this.settingsPanel, this.taskPanel, this.showModePanel].forEach(p => {
                  p.classList.remove('active');
              });

              // Open the clicked panel if it wasn't active
              if (!isActive) {
                  panel.classList.add('active');
                  this.world.setInteracting(true);
              } else {
                  this.world.setInteracting(false);
              }
          }

          closePanel(panel) {
              panel.classList.remove('active');
              this.world.setInteracting(false);
          }

          async sendMessage() {
              const input = document.getElementById('user-input');
              const message = input.value.trim();

              if (!message) return;

              // Clear input
              input.value = '';

              // Add user message to UI
              this.addMessageToUI('user', message);

              // Show loading indicator
              const loadingDiv = document.createElement('div');
              loadingDiv.className = 'chat-message ai-message loading';
              loadingDiv.innerHTML = '<span>Thinking...</span>';
              loadingDiv.id = 'loading-message';
              document.getElementById('chat-messages').appendChild(loadingDiv);
              this.scrollChatToBottom();

              try {
                  // Get AI response
                  const response = await this.aiManager.sendMessage(message);

                  // Remove loading indicator
                  const loading = document.getElementById('loading-message');
                  if (loading) loading.remove();

                  // Add AI response to UI
                  this.addMessageToUI('assistant', response);

                  // Send update if presenting
                  if (this.showModeManager.isPresenter) {
                      this.showModeManager.sendUpdate({ type: 'message', role: 'user', content: message });
                      this.showModeManager.sendUpdate({ type: 'message', role: 'assistant', content: response });
                  }

                  // Update conversation list
                  this.updateConversationList();
              } catch (error) {
                  // Remove loading indicator
                  const loading = document.getElementById('loading-message');
                  if (loading) loading.remove();

                  // Show error
                  this.addMessageToUI('error', `Error: ${error.message}`);
              }
          }

          addMessageToUI(role, content) {
              const messagesDiv = document.getElementById('chat-messages');
              const messageDiv = document.createElement('div');
              messageDiv.className = `chat-message ${role}-message`;

              if (role === 'error') {
                  messageDiv.style.color = '#ff4444';
              }

              messageDiv.textContent = content;
              messagesDiv.appendChild(messageDiv);

              this.scrollChatToBottom();
          }

          scrollChatToBottom() {
              const messagesDiv = document.getElementById('chat-messages');
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }

          startVoiceInput() {
              this.voiceManager.startListening();
          }

          newChat() {
              this.aiManager.newConversation();
              document.getElementById('chat-messages').innerHTML = '';
              this.updateConversationList();
          }

          updateConversationList(filtered = null) {
              const listDiv = document.getElementById('conversation-list');
              const countDiv = document.getElementById('conversation-count');
              const conversations = filtered !== null ? filtered : this.aiManager.conversations;

              // Update count
              countDiv.textContent = `${conversations.length} conversation${conversations.length !== 1 ? 's' : ''}`;

              listDiv.innerHTML = '';

              conversations.forEach(conv => {
                  const convDiv = document.createElement('div');
                  convDiv.className = 'conversation-item';
                  if (conv.id === this.aiManager.currentConversationId) {
                      convDiv.classList.add('active');
                  }

                  const nameSpan = document.createElement('span');
                  nameSpan.textContent = conv.name;
                  nameSpan.className = 'conversation-name';

                  const dateSpan = document.createElement('span');
                  dateSpan.textContent = new Date(conv.lastModified).toLocaleString();
                  dateSpan.className = 'conversation-date';

                  const actionsDiv = document.createElement('div');
                  actionsDiv.className = 'conversation-actions';

                  const loadBtn = document.createElement('button');
                  loadBtn.textContent = 'Load';
                  loadBtn.className = 'conversation-action-btn';
                  loadBtn.addEventListener('click', (e) => {
                      e.stopPropagation();
                      this.loadConversation(conv.id);
                  });

                  const renameBtn = document.createElement('button');
                  renameBtn.textContent = 'Rename';
                  renameBtn.className = 'conversation-action-btn';
                  renameBtn.addEventListener('click', (e) => {
                      e.stopPropagation();
                      this.renameConversation(conv.id);
                  });

                  const exportBtn = document.createElement('button');
                  exportBtn.textContent = 'Export';
                  exportBtn.className = 'conversation-action-btn';
                  exportBtn.addEventListener('click', (e) => {
                      e.stopPropagation();
                      this.aiManager.exportConversation(conv.id);
                  });

                  const deleteBtn = document.createElement('button');
                  deleteBtn.textContent = 'Delete';
                  deleteBtn.className = 'conversation-action-btn danger';
                  deleteBtn.addEventListener('click', (e) => {
                      e.stopPropagation();
                      if (confirm('Delete this conversation?')) {
                          this.aiManager.deleteConversation(conv.id);
                          this.updateConversationList();
                      }
                  });

                  actionsDiv.appendChild(loadBtn);
                  actionsDiv.appendChild(renameBtn);
                  actionsDiv.appendChild(exportBtn);
                  actionsDiv.appendChild(deleteBtn);

                  convDiv.appendChild(nameSpan);
                  convDiv.appendChild(dateSpan);
                  convDiv.appendChild(actionsDiv);

                  listDiv.appendChild(convDiv);
              });
          }

          loadConversation(id) {
              const conv = this.aiManager.loadConversation(id);
              if (conv) {
                  // Clear and repopulate chat UI
                  const messagesDiv = document.getElementById('chat-messages');
                  messagesDiv.innerHTML = '';

                  conv.messages.forEach(msg => {
                      this.addMessageToUI(msg.role, msg.content);
                  });

                  this.updateConversationList();
              }
          }

          renameConversation(id) {
              const newName = prompt('Enter new name:');
              if (newName) {
                  this.aiManager.renameConversation(id, newName);
                  this.updateConversationList();
              }
          }

          loadSettings() {
              document.getElementById('openai-api-key').value = this.aiManager.apiKey;
              document.getElementById('ai-model').value = this.aiManager.model;
              document.getElementById('system-prompt').value = this.aiManager.systemPrompt;
              document.getElementById('use-azure-tts').checked = this.voiceManager.useAzureTTS;
              document.getElementById('azure-tts-key').value = this.voiceManager.azureKey;
              document.getElementById('azure-tts-region').value = this.voiceManager.azureRegion;
              document.getElementById('azure-voice').value = this.voiceManager.azureVoice;
          }

          saveSettings() {
              // Save API settings
              this.aiManager.apiKey = document.getElementById('openai-api-key').value;
              this.aiManager.model = document.getElementById('ai-model').value;
              this.aiManager.systemPrompt = document.getElementById('system-prompt').value;

              localStorage.setItem('openai_api_key', this.aiManager.apiKey);
              localStorage.setItem('ai_model', this.aiManager.model);
              localStorage.setItem('system_prompt', this.aiManager.systemPrompt);

              // Save voice settings
              this.voiceManager.useAzureTTS = document.getElementById('use-azure-tts').checked;
              this.voiceManager.azureKey = document.getElementById('azure-tts-key').value;
              this.voiceManager.azureRegion = document.getElementById('azure-tts-region').value;
              this.voiceManager.azureVoice = document.getElementById('azure-voice').value;

              localStorage.setItem('use_azure_tts', this.voiceManager.useAzureTTS);
              localStorage.setItem('azure_tts_key', this.voiceManager.azureKey);
              localStorage.setItem('azure_tts_region', this.voiceManager.azureRegion);
              localStorage.setItem('azure_voice', this.voiceManager.azureVoice);

              alert('Settings saved!');
          }

          exportAllData() {
              const data = {
                  conversations: this.aiManager.conversations,
                  tasks: this.taskManager.tasks,
                  settings: {
                      model: this.aiManager.model,
                      systemPrompt: this.aiManager.systemPrompt,
                      useAzureTTS: this.voiceManager.useAzureTTS,
                      azureVoice: this.voiceManager.azureVoice
                  },
                  exportDate: new Date().toISOString()
              };

              const dataStr = JSON.stringify(data, null, 2);
              const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
              const exportFileDefaultName = `ai-companion-backup-${Date.now()}.json`;

              const linkElement = document.createElement('a');
              linkElement.setAttribute('href', dataUri);
              linkElement.setAttribute('download', exportFileDefaultName);
              linkElement.click();
          }

          async importData(file) {
              if (!file) return;

              try {
                  const text = await file.text();
                  const data = JSON.parse(text);

                  if (confirm('This will overwrite all current data. Continue?')) {
                      if (data.conversations) {
                          this.aiManager.conversations = data.conversations;
                          this.aiManager.saveConversations();
                          this.updateConversationList();
                      }

                      if (data.tasks) {
                          this.taskManager.tasks = data.tasks;
                          this.taskManager.saveTasks();
                          this.updateTaskList();
                      }

                      if (data.settings) {
                          if (data.settings.model) {
                              this.aiManager.model = data.settings.model;
                              localStorage.setItem('ai_model', data.settings.model);
                          }
                          if (data.settings.systemPrompt) {
                              this.aiManager.systemPrompt = data.settings.systemPrompt;
                              localStorage.setItem('system_prompt', data.settings.systemPrompt);
                          }
                      }

                      this.loadSettings();
                      alert('Data imported successfully!');
                  }
              } catch (error) {
                  alert('Error importing data: ' + error.message);
              }
          }

          addTask() {
              const input = document.getElementById('new-task-input');
              const content = input.value.trim();

              if (!content) return;

              this.taskManager.addTask(content);
              input.value = '';
              this.updateTaskList();
          }

          updateTaskList() {
              const listDiv = document.getElementById('task-list');
              const tasks = this.taskManager.tasks;

              listDiv.innerHTML = '';

              tasks.forEach(task => {
                  const taskDiv = document.createElement('div');
                  taskDiv.className = 'task-item' + (task.completed ? ' completed' : '');

                  const checkbox = document.createElement('input');
                  checkbox.type = 'checkbox';
                  checkbox.checked = task.completed;
                  checkbox.className = 'task-checkbox';
                  checkbox.addEventListener('change', () => {
                      this.taskManager.toggleTask(task.id);
                      this.updateTaskList();
                  });

                  const contentSpan = document.createElement('span');
                  contentSpan.className = 'task-content';
                  contentSpan.textContent = task.content;

                  const deleteBtn = document.createElement('button');
                  deleteBtn.textContent = '';
                  deleteBtn.className = 'task-delete';
                  deleteBtn.addEventListener('click', () => {
                      this.taskManager.deleteTask(task.id);
                      this.updateTaskList();
                  });

                  taskDiv.appendChild(checkbox);
                  taskDiv.appendChild(contentSpan);
                  taskDiv.appendChild(deleteBtn);

                  listDiv.appendChild(taskDiv);
              });
          }

          startPresenting() {
              const peerId = this.showModeManager.startPresenting();

              setTimeout(() => {
                  const displayPeerId = this.showModeManager.peerId;
                  if (displayPeerId) {
                      document.getElementById('presenter-id-display').textContent = displayPeerId;
                      document.getElementById('presenter-status').style.display = 'block';
                      alert(`Share this ID with viewers: ${displayPeerId}`);
                  }
              }, 1000);
          }

          connectAsViewer() {
              const presenterId = document.getElementById('presenter-id-input').value.trim();

              if (!presenterId) {
                  alert('Please enter a Presenter ID');
                  return;
              }

              this.showModeManager.connectToPresenter(presenterId);
              document.getElementById('viewer-status').textContent = `Connected to: ${presenterId}`;
              document.getElementById('viewer-status').style.display = 'block';
          }

          disconnectShowMode() {
              this.showModeManager.disconnect();
              document.getElementById('presenter-status').style.display = 'none';
              document.getElementById('viewer-status').style.display = 'none';
              alert('Disconnected from Show Mode');
          }
      }

      // ==================== ACCESSIBILITY KEYBOARD NAVIGATION ====================
      function setupAccessibilityKeyboardNavigation() {
          const buttons = [
              { el: document.getElementById('voice-pause-button'), handler: () => document.getElementById('voice-pause-button').click() },
              { el: document.getElementById('ai-companion-button'), handler: () => document.getElementById('ai-companion-button').click() },
              { el: document.getElementById('tasks-button'), handler: () => document.getElementById('tasks-button').click() },
              { el: document.getElementById('settings-button'), handler: () => document.getElementById('settings-button').click() },
              { el: document.getElementById('show-mode-button'), handler: () => document.getElementById('show-mode-button').click() },
              { el: document.getElementById('tool-gallery-button'), handler: () => { window.location.href = '../../index.html'; } }
          ];

          buttons.forEach(({ el, handler }) => {
              if (!el) return;

              el.addEventListener('keydown', (e) => {
                  if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault();
                      handler();
                  }
              });
          });
      }

      // ==================== INITIALIZE APPLICATION ====================
      document.addEventListener('DOMContentLoaded', () => {
          const app = new App();
          console.log('AI Companion Hub initialized');
      });
  </script>

  <!-- PeerJS for Show Mode -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</body>
</html>
