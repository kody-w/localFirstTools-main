<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Autonomous multi-agent system for continuous app improvement through 8-strategy consensus analysis">
    <meta name="theme-color" content="#0a0e17">
    <meta name="color-scheme" content="dark">
    <title>Meta-Improvement System - Agent Orchestrator</title>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-tertiary: #1f2937;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border-color: #374151;
            --glow-blue: 0 0 20px rgba(59, 130, 246, 0.3);
            --glow-green: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background grid */
        .bg-grid {
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--glow-blue);
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-blue);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-blue);
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        /* Status Bar */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
        }

        .status-card.running::before {
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .status-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .status-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Panels */
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        .panel-title {
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Strategy Grid */
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        @media (max-width: 600px) {
            .strategy-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .strategy-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .strategy-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .strategy-card.active {
            border-color: var(--accent-green);
            box-shadow: var(--glow-green);
        }

        .strategy-card.running {
            border-color: var(--accent-yellow);
            animation: borderPulse 1.5s infinite;
        }

        @keyframes borderPulse {
            0%, 100% { border-color: var(--accent-yellow); }
            50% { border-color: var(--accent-blue); }
        }

        .strategy-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .strategy-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .strategy-focus {
            font-size: 0.625rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .strategy-score {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.625rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--accent-green);
            color: white;
        }

        /* App Queue */
        .app-queue {
            list-style: none;
        }

        .app-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }

        .app-item:hover {
            background: var(--bg-tertiary);
        }

        .app-item:last-child {
            border-bottom: none;
        }

        .app-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-priority {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .app-priority.high {
            background: var(--accent-red);
            color: white;
        }

        .app-priority.medium {
            background: var(--accent-yellow);
            color: black;
        }

        .app-name {
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .app-category {
            font-size: 0.625rem;
            color: var(--text-muted);
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .app-status {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 4px;
        }

        .app-status.pending {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .app-status.running {
            background: var(--accent-yellow);
            color: black;
        }

        .app-status.complete {
            background: var(--accent-green);
            color: white;
        }

        /* Learning Log */
        .log-entry {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8125rem;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .log-app {
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .log-time {
            font-size: 0.625rem;
            color: var(--text-muted);
        }

        .log-changes {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .log-outcome {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
        }

        .outcome-badge {
            font-size: 0.625rem;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .outcome-badge.success {
            background: var(--accent-green);
            color: white;
        }

        .outcome-badge.partial {
            background: var(--accent-yellow);
            color: black;
        }

        .outcome-badge.failed {
            background: var(--accent-red);
            color: white;
        }

        /* Consensus Panel */
        .consensus-result {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .consensus-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .consensus-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .consensus-votes {
            font-size: 0.75rem;
            color: var(--accent-green);
        }

        .consensus-description {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .consensus-strategies {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .strategy-chip {
            font-size: 0.625rem;
            padding: 3px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            color: var(--text-muted);
        }

        /* Pattern Insights */
        .insight-card {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-purple);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

        .insight-text {
            font-size: 0.8125rem;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .insight-meta {
            font-size: 0.625rem;
            color: var(--text-muted);
        }

        /* Charts placeholder */
        .chart-container {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        /* Progress bar */
        .progress-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            transition: width 0.3s ease;
        }

        /* Command Input */
        .command-section {
            grid-column: 1 / -1;
        }

        .command-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .command-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
        }

        .command-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .command-input::placeholder {
            color: var(--text-muted);
        }

        /* Terminal Output */
        .terminal {
            background: #000;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.75rem;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }

        .terminal-line {
            margin-bottom: 5px;
        }

        .terminal-line.info {
            color: var(--accent-cyan);
        }

        .terminal-line.success {
            color: var(--accent-green);
        }

        .terminal-line.warning {
            color: var(--accent-yellow);
        }

        .terminal-line.error {
            color: var(--accent-red);
        }

        .terminal-line.dim {
            color: var(--text-muted);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 140px);
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Config Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 15px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .checkbox-item:hover {
            background: var(--border-color);
        }

        .checkbox-item input {
            accent-color: var(--accent-blue);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 0.75rem;
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>

    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üß†</div>
                <div>
                    <h1>Meta-Improvement System</h1>
                    <p>8-Strategy Consensus Engine</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openConfigModal()">‚öôÔ∏è Configure</button>
                <button class="btn btn-secondary" onclick="exportData()">üì§ Export</button>
                <button class="btn btn-secondary" onclick="importData()">üì• Import</button>
                <button class="btn btn-primary" onclick="startImprovementCycle()" id="startBtn">‚ñ∂Ô∏è Start Cycle</button>
            </div>
        </header>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-card" id="statusCard">
                <div class="status-label">System Status</div>
                <div class="status-value" id="systemStatus">IDLE</div>
                <div class="status-meta" id="statusMeta">Ready to begin</div>
            </div>
            <div class="status-card">
                <div class="status-label">Apps Improved</div>
                <div class="status-value" id="appsImproved">0</div>
                <div class="status-meta" id="improvementRate">--</div>
            </div>
            <div class="status-card">
                <div class="status-label">Consensus Rate</div>
                <div class="status-value" id="consensusRate">--</div>
                <div class="status-meta">Agreement threshold: 6/8</div>
            </div>
            <div class="status-card">
                <div class="status-label">Success Rate</div>
                <div class="status-value" id="successRate">--</div>
                <div class="status-meta" id="successMeta">Based on all cycles</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Strategy Panel -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üéØ Active Strategies</div>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">Click to toggle</span>
                </div>
                <div class="panel-content">
                    <div class="strategy-grid" id="strategyGrid">
                        <!-- Strategies populated by JS -->
                    </div>
                </div>
            </div>

            <!-- App Queue Panel -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üìã App Queue</div>
                    <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.75rem;" onclick="loadAppQueue()">üîÑ Refresh</button>
                </div>
                <div class="panel-content">
                    <ul class="app-queue" id="appQueue">
                        <!-- Apps populated by JS -->
                    </ul>
                </div>
            </div>

            <!-- Consensus Results Panel -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">ü§ù Current Consensus</div>
                    <span style="font-size: 0.75rem; color: var(--text-muted);" id="consensusCount">0 agreements</span>
                </div>
                <div class="panel-content" id="consensusPanel">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No active consensus analysis</p>
                    </div>
                </div>
            </div>

            <!-- Learning Log Panel -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üìö Learning Log</div>
                    <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.75rem;" onclick="clearLog()">üóëÔ∏è Clear</button>
                </div>
                <div class="panel-content" id="learningLog">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No improvement cycles recorded yet</p>
                    </div>
                </div>
            </div>

            <!-- Pattern Insights Panel -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üí° Pattern Insights</div>
                    <span style="font-size: 0.75rem; color: var(--text-muted);" id="insightCount">Analyzing...</span>
                </div>
                <div class="panel-content" id="insightsPanel">
                    <div class="empty-state">
                        <div class="empty-state-icon">üîÆ</div>
                        <p>Insights will appear after cycles complete</p>
                    </div>
                </div>
            </div>

            <!-- Terminal Output Panel -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üíª Terminal Output</div>
                    <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.75rem;" onclick="clearTerminal()">Clear</button>
                </div>
                <div class="panel-content" style="padding: 0;">
                    <div class="terminal" id="terminal">
                        <div class="terminal-line dim">[System] Meta-Improvement System v1.0.0</div>
                        <div class="terminal-line dim">[System] Ready to orchestrate 8-strategy analysis</div>
                        <div class="terminal-line info">[Info] Load app queue to begin...</div>
                    </div>
                </div>
            </div>

            <!-- Command Section -->
            <div class="panel command-section">
                <div class="panel-header">
                    <div class="panel-title">‚å®Ô∏è Command Interface</div>
                </div>
                <div class="panel-content">
                    <div class="command-input-wrapper">
                        <input type="text" class="command-input" id="commandInput"
                               placeholder="Enter command: analyze [app], improve [app], status, help..."
                               onkeydown="if(event.key === 'Enter') executeCommand()">
                        <button class="btn btn-primary" onclick="executeCommand()">Execute</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.75rem; color: var(--text-muted);">
                        Commands: <code>analyze [app]</code> | <code>improve [app]</code> | <code>queue add [app]</code> | <code>status</code> | <code>patterns</code> | <code>help</code>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            Meta-Improvement System ‚Ä¢ Building the future through autonomous evolution ‚Ä¢ Data stored locally
        </footer>
    </div>

    <!-- Config Modal -->
    <div class="modal-overlay" id="configModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è System Configuration</div>
                <button class="modal-close" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Queue Selection Mode</label>
                    <select class="form-select" id="queueMode">
                        <option value="priority">Priority-based (highest first)</option>
                        <option value="round-robin">Round-robin (sequential)</option>
                        <option value="random">Random selection</option>
                        <option value="least-improved">Least recently improved</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Consensus Threshold</label>
                    <select class="form-select" id="consensusThreshold">
                        <option value="5">5/8 strategies (62.5%)</option>
                        <option value="6" selected>6/8 strategies (75%) - Recommended</option>
                        <option value="7">7/8 strategies (87.5%)</option>
                        <option value="8">8/8 strategies (100% - Unanimous)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Active Strategies</label>
                    <div class="checkbox-group" id="strategyCheckboxes">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Auto-continue after cycle</label>
                    <select class="form-select" id="autoContinue">
                        <option value="false">No - Wait for approval</option>
                        <option value="true">Yes - Continue automatically</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Max improvements per cycle</label>
                    <input type="number" class="form-input" id="maxImprovements" value="3" min="1" max="10">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfigModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importInput" accept=".json" style="display: none;" onchange="handleImport(event)">

    <script>
        // ==================== DATA MODELS ====================

        const STRATEGIES = [
            { id: 'minimalist', name: 'Minimalist', icon: '‚úÇÔ∏è', focus: 'Remove complexity', perspective: 'What can we delete?', active: true, successRate: 0, uses: 0 },
            { id: 'maximalist', name: 'Maximalist', icon: '‚ú®', focus: 'Add delight', perspective: 'What\'s missing?', active: true, successRate: 0, uses: 0 },
            { id: 'performance', name: 'Performance', icon: '‚ö°', focus: 'Speed & efficiency', perspective: 'What\'s slow?', active: true, successRate: 0, uses: 0 },
            { id: 'accessibility', name: 'Accessibility', icon: '‚ôø', focus: 'Universal design', perspective: 'Who\'s excluded?', active: true, successRate: 0, uses: 0 },
            { id: 'security', name: 'Security', icon: 'üîí', focus: 'Attack surface', perspective: 'What\'s vulnerable?', active: true, successRate: 0, uses: 0 },
            { id: 'ux', name: 'UX Expert', icon: 'üé®', focus: 'User journey', perspective: 'What\'s confusing?', active: true, successRate: 0, uses: 0 },
            { id: 'quality', name: 'Code Quality', icon: 'üîß', focus: 'Maintainability', perspective: 'What\'s fragile?', active: true, successRate: 0, uses: 0 },
            { id: 'innovation', name: 'Innovation', icon: 'üöÄ', focus: 'Novel approaches', perspective: 'What\'s possible?', active: true, successRate: 0, uses: 0 }
        ];

        // State management
        let state = {
            status: 'idle', // idle, running, paused
            currentApp: null,
            appQueue: [],
            learningLog: [],
            patterns: [],
            config: {
                queueMode: 'priority',
                consensusThreshold: 6,
                autoContinue: false,
                maxImprovements: 3,
                activeStrategies: STRATEGIES.map(s => s.id)
            },
            stats: {
                totalCycles: 0,
                successfulCycles: 0,
                partialCycles: 0,
                failedCycles: 0,
                totalImprovements: 0
            },
            currentConsensus: []
        };

        // ==================== INITIALIZATION ====================

        function init() {
            loadState();
            renderStrategies();
            renderStrategyCheckboxes();
            updateUI();
            loadAppQueue();
            log('System initialized', 'info');
        }

        function loadState() {
            const saved = localStorage.getItem('metaImprovementSystem');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                STRATEGIES.forEach((s, i) => {
                    if (parsed.strategies && parsed.strategies[i]) {
                        Object.assign(s, parsed.strategies[i]);
                    }
                });
            }
        }

        function saveState() {
            const toSave = {
                ...state,
                strategies: STRATEGIES
            };
            localStorage.setItem('metaImprovementSystem', JSON.stringify(toSave));
        }

        // ==================== UI RENDERING ====================

        function renderStrategies() {
            const grid = document.getElementById('strategyGrid');
            grid.innerHTML = STRATEGIES.map(s => `
                <div class="strategy-card ${s.active ? 'active' : ''}"
                     onclick="toggleStrategy('${s.id}')"
                     id="strategy-${s.id}">
                    ${s.uses > 0 ? `<span class="strategy-score">${Math.round(s.successRate)}%</span>` : ''}
                    <div class="strategy-icon">${s.icon}</div>
                    <div class="strategy-name">${s.name}</div>
                    <div class="strategy-focus">${s.focus}</div>
                </div>
            `).join('');
        }

        function renderStrategyCheckboxes() {
            const container = document.getElementById('strategyCheckboxes');
            container.innerHTML = STRATEGIES.map(s => `
                <label class="checkbox-item">
                    <input type="checkbox" ${s.active ? 'checked' : ''}
                           onchange="updateStrategyActive('${s.id}', this.checked)">
                    ${s.icon} ${s.name}
                </label>
            `).join('');
        }

        function updateUI() {
            // Status
            document.getElementById('systemStatus').textContent = state.status.toUpperCase();
            document.getElementById('statusCard').className = `status-card ${state.status === 'running' ? 'running' : ''}`;

            if (state.status === 'running' && state.currentApp) {
                document.getElementById('statusMeta').textContent = `Processing: ${state.currentApp}`;
            } else {
                document.getElementById('statusMeta').textContent = 'Ready to begin';
            }

            // Stats
            document.getElementById('appsImproved').textContent = state.stats.totalCycles;
            document.getElementById('improvementRate').textContent =
                state.stats.totalCycles > 0
                    ? `${state.stats.totalImprovements} total improvements`
                    : '--';

            const consensusRate = calculateConsensusRate();
            document.getElementById('consensusRate').textContent =
                consensusRate !== null ? `${consensusRate}%` : '--';

            const successRate = calculateSuccessRate();
            document.getElementById('successRate').textContent =
                successRate !== null ? `${successRate}%` : '--';

            // Button state
            const startBtn = document.getElementById('startBtn');
            if (state.status === 'running') {
                startBtn.innerHTML = '‚è∏Ô∏è Pause';
                startBtn.onclick = pauseCycle;
            } else {
                startBtn.innerHTML = '‚ñ∂Ô∏è Start Cycle';
                startBtn.onclick = startImprovementCycle;
            }

            // Render log
            renderLearningLog();
            renderPatterns();
        }

        function renderAppQueue() {
            const queue = document.getElementById('appQueue');
            if (state.appQueue.length === 0) {
                queue.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No apps in queue. Click Refresh to load.</p>
                    </div>
                `;
                return;
            }

            queue.innerHTML = state.appQueue.slice(0, 10).map((app, i) => `
                <li class="app-item">
                    <div class="app-info">
                        <span class="app-priority ${app.priority || ''}">${i + 1}</span>
                        <span class="app-name">${app.name}</span>
                        <span class="app-category">${app.category || 'uncategorized'}</span>
                    </div>
                    <span class="app-status ${app.status || 'pending'}">${app.status || 'pending'}</span>
                </li>
            `).join('');
        }

        function renderLearningLog() {
            const logEl = document.getElementById('learningLog');
            if (state.learningLog.length === 0) {
                logEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No improvement cycles recorded yet</p>
                    </div>
                `;
                return;
            }

            logEl.innerHTML = state.learningLog.slice(-10).reverse().map(entry => `
                <div class="log-entry">
                    <div class="log-header">
                        <span class="log-app">${entry.app}</span>
                        <span class="log-time">${formatTime(entry.timestamp)}</span>
                    </div>
                    <div class="log-changes">${entry.changes.join(', ')}</div>
                    <div class="log-outcome">
                        <span class="outcome-badge ${entry.outcome}">${entry.outcome}</span>
                        <span style="font-size: 0.625rem; color: var(--text-muted);">
                            ${entry.consensusCount}/8 agreed ‚Ä¢ ${entry.strategiesUsed.length} strategies
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function renderPatterns() {
            const panel = document.getElementById('insightsPanel');
            const insights = analyzePatterns();

            if (insights.length === 0) {
                panel.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîÆ</div>
                        <p>Insights will appear after cycles complete</p>
                    </div>
                `;
                document.getElementById('insightCount').textContent = 'Analyzing...';
                return;
            }

            document.getElementById('insightCount').textContent = `${insights.length} insights`;
            panel.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-text">${insight.text}</div>
                    <div class="insight-meta">${insight.confidence}% confidence ‚Ä¢ Based on ${insight.samples} cycles</div>
                </div>
            `).join('');
        }

        function renderConsensus(results) {
            const panel = document.getElementById('consensusPanel');
            const count = document.getElementById('consensusCount');

            if (!results || results.length === 0) {
                panel.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No active consensus analysis</p>
                    </div>
                `;
                count.textContent = '0 agreements';
                return;
            }

            count.textContent = `${results.length} agreements`;
            panel.innerHTML = results.map(r => `
                <div class="consensus-result">
                    <div class="consensus-header">
                        <span class="consensus-title">${r.title}</span>
                        <span class="consensus-votes">${r.votes}/8 agree</span>
                    </div>
                    <div class="consensus-description">${r.description}</div>
                    <div class="consensus-strategies">
                        ${r.strategies.map(s => `<span class="strategy-chip">${s}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // ==================== CORE FUNCTIONS ====================

        async function loadAppQueue() {
            log('Loading app queue from gallery config...', 'info');

            try {
                const response = await fetch('vibe_gallery_config.json');
                const config = await response.json();

                // Flatten all apps from all categories
                const allApps = [];
                Object.entries(config.categories || {}).forEach(([category, apps]) => {
                    apps.forEach(app => {
                        allApps.push({
                            name: app.title || app.file,
                            file: app.file,
                            category: category,
                            description: app.description,
                            complexity: app.complexity,
                            lastImproved: null,
                            priority: calculatePriority(app),
                            status: 'pending'
                        });
                    });
                });

                // Sort by priority
                state.appQueue = allApps.sort((a, b) => {
                    if (state.config.queueMode === 'random') {
                        return Math.random() - 0.5;
                    }
                    return (b.priority || 0) - (a.priority || 0);
                });

                renderAppQueue();
                log(`Loaded ${state.appQueue.length} apps into queue`, 'success');
                saveState();
            } catch (e) {
                log(`Error loading app queue: ${e.message}`, 'error');
                // Add some default apps for testing
                state.appQueue = [
                    { name: 'war-card-game-tutor.html', category: 'games', status: 'pending', priority: 1 },
                    { name: 'particle-garden.html', category: 'visual_art', status: 'pending', priority: 2 }
                ];
                renderAppQueue();
            }
        }

        function calculatePriority(app) {
            let priority = 0;

            // Complexity score
            if (app.complexity === 'simple') priority += 1;
            if (app.complexity === 'intermediate') priority += 2;
            if (app.complexity === 'advanced') priority += 3;

            // Has never been improved
            const wasImproved = state.learningLog.some(l => l.app === app.file);
            if (!wasImproved) priority += 2;

            return priority;
        }

        async function startImprovementCycle() {
            if (state.status === 'running') return;
            if (state.appQueue.length === 0) {
                log('No apps in queue. Load apps first.', 'warning');
                return;
            }

            state.status = 'running';
            const app = state.appQueue[0];
            state.currentApp = app.name;
            app.status = 'running';

            updateUI();
            renderAppQueue();

            log(`Starting improvement cycle for: ${app.name}`, 'info');
            log('Spawning 8 strategy analyzers...', 'info');

            // Simulate the 8-strategy analysis (in real use, this would spawn actual agents)
            await simulateStrategyAnalysis(app);
        }

        async function simulateStrategyAnalysis(app) {
            const activeStrategies = STRATEGIES.filter(s => s.active);

            for (let i = 0; i < activeStrategies.length; i++) {
                const strategy = activeStrategies[i];
                document.getElementById(`strategy-${strategy.id}`).classList.add('running');

                log(`[${strategy.icon} ${strategy.name}] Analyzing: "${strategy.perspective}"`, 'dim');

                await sleep(500); // Simulate analysis time

                document.getElementById(`strategy-${strategy.id}`).classList.remove('running');
            }

            // Generate mock consensus results
            const consensusResults = generateMockConsensus(app);
            state.currentConsensus = consensusResults;
            renderConsensus(consensusResults);

            log(`Analysis complete. ${consensusResults.length} consensus improvements found.`, 'success');

            // Record the cycle
            recordCycle(app, consensusResults);
        }

        function generateMockConsensus(app) {
            // This would be replaced with actual agent output aggregation
            const possibleImprovements = [
                { title: 'Add keyboard shortcuts', description: 'Implement common keyboard shortcuts for power users', votes: 7, strategies: ['UX', 'Accessibility', 'Innovation'] },
                { title: 'Improve color contrast', description: 'Increase contrast ratios for better accessibility', votes: 8, strategies: ['Accessibility', 'UX', 'Quality'] },
                { title: 'Add loading states', description: 'Show feedback during async operations', votes: 6, strategies: ['UX', 'Quality', 'Performance'] },
                { title: 'Optimize render loop', description: 'Reduce unnecessary re-renders', votes: 5, strategies: ['Performance', 'Quality'] },
                { title: 'Add error boundaries', description: 'Gracefully handle runtime errors', votes: 7, strategies: ['Quality', 'Security', 'UX'] },
            ];

            // Filter by consensus threshold
            return possibleImprovements
                .filter(i => i.votes >= state.config.consensusThreshold)
                .slice(0, state.config.maxImprovements);
        }

        function recordCycle(app, consensus) {
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                app: app.name,
                changes: consensus.map(c => c.title),
                consensusCount: consensus.length > 0 ? Math.max(...consensus.map(c => c.votes)) : 0,
                strategiesUsed: STRATEGIES.filter(s => s.active).map(s => s.id),
                outcome: consensus.length >= 3 ? 'success' : consensus.length >= 1 ? 'partial' : 'failed'
            };

            state.learningLog.push(entry);

            // Update stats
            state.stats.totalCycles++;
            state.stats.totalImprovements += consensus.length;
            if (entry.outcome === 'success') state.stats.successfulCycles++;
            if (entry.outcome === 'partial') state.stats.partialCycles++;
            if (entry.outcome === 'failed') state.stats.failedCycles++;

            // Update strategy success rates
            STRATEGIES.forEach(s => {
                if (s.active) {
                    s.uses++;
                    // Simple moving average
                    s.successRate = ((s.successRate * (s.uses - 1)) + (entry.outcome === 'success' ? 100 : entry.outcome === 'partial' ? 50 : 0)) / s.uses;
                }
            });

            // Move to next app
            state.appQueue[0].status = 'complete';
            state.appQueue.push(state.appQueue.shift());

            state.status = 'idle';
            state.currentApp = null;

            saveState();
            updateUI();
            renderStrategies();
            renderAppQueue();

            log(`Cycle complete. Outcome: ${entry.outcome}`, entry.outcome === 'success' ? 'success' : entry.outcome === 'partial' ? 'warning' : 'error');

            // Auto-continue if enabled
            if (state.config.autoContinue) {
                log('Auto-continuing to next app in 2 seconds...', 'info');
                setTimeout(startImprovementCycle, 2000);
            }
        }

        function pauseCycle() {
            state.status = 'paused';
            updateUI();
            log('Cycle paused', 'warning');
        }

        // ==================== PATTERN ANALYSIS ====================

        function analyzePatterns() {
            if (state.learningLog.length < 3) return [];

            const insights = [];

            // Strategy effectiveness
            const bestStrategy = STRATEGIES.reduce((best, s) =>
                s.uses > 0 && s.successRate > (best?.successRate || 0) ? s : best, null);

            if (bestStrategy && bestStrategy.uses >= 3) {
                insights.push({
                    text: `"${bestStrategy.name}" strategy has the highest success rate at ${Math.round(bestStrategy.successRate)}%`,
                    confidence: Math.min(90, 50 + bestStrategy.uses * 5),
                    samples: bestStrategy.uses
                });
            }

            // Category patterns
            const categorySuccess = {};
            state.learningLog.forEach(log => {
                const app = state.appQueue.find(a => a.name === log.app);
                const cat = app?.category || 'unknown';
                if (!categorySuccess[cat]) categorySuccess[cat] = { success: 0, total: 0 };
                categorySuccess[cat].total++;
                if (log.outcome === 'success') categorySuccess[cat].success++;
            });

            Object.entries(categorySuccess).forEach(([cat, data]) => {
                if (data.total >= 3) {
                    const rate = Math.round((data.success / data.total) * 100);
                    insights.push({
                        text: `Apps in "${cat}" category have a ${rate}% improvement success rate`,
                        confidence: Math.min(85, 40 + data.total * 10),
                        samples: data.total
                    });
                }
            });

            // Consensus correlation
            const highConsensus = state.learningLog.filter(l => l.consensusCount >= 7);
            if (highConsensus.length >= 3) {
                const successRate = highConsensus.filter(l => l.outcome === 'success').length / highConsensus.length;
                insights.push({
                    text: `High consensus (7-8 strategies) leads to ${Math.round(successRate * 100)}% success rate`,
                    confidence: Math.min(95, 60 + highConsensus.length * 5),
                    samples: highConsensus.length
                });
            }

            return insights.slice(0, 5);
        }

        function calculateConsensusRate() {
            if (state.learningLog.length === 0) return null;
            const avgConsensus = state.learningLog.reduce((sum, l) => sum + l.consensusCount, 0) / state.learningLog.length;
            return Math.round((avgConsensus / 8) * 100);
        }

        function calculateSuccessRate() {
            if (state.stats.totalCycles === 0) return null;
            return Math.round((state.stats.successfulCycles / state.stats.totalCycles) * 100);
        }

        // ==================== COMMAND INTERFACE ====================

        function executeCommand() {
            const input = document.getElementById('commandInput');
            const cmd = input.value.trim().toLowerCase();
            input.value = '';

            if (!cmd) return;

            log(`> ${cmd}`, 'dim');

            const parts = cmd.split(' ');
            const action = parts[0];
            const arg = parts.slice(1).join(' ');

            switch (action) {
                case 'analyze':
                    if (arg) {
                        log(`Queuing analysis for: ${arg}`, 'info');
                        const app = state.appQueue.find(a => a.name.includes(arg) || a.file?.includes(arg));
                        if (app) {
                            // Move to front of queue
                            state.appQueue = [app, ...state.appQueue.filter(a => a !== app)];
                            renderAppQueue();
                            startImprovementCycle();
                        } else {
                            log(`App not found: ${arg}`, 'error');
                        }
                    } else {
                        log('Usage: analyze [app-name]', 'warning');
                    }
                    break;

                case 'improve':
                    startImprovementCycle();
                    break;

                case 'queue':
                    if (parts[1] === 'add' && arg) {
                        state.appQueue.unshift({ name: parts.slice(2).join(' '), status: 'pending', priority: 10 });
                        renderAppQueue();
                        log(`Added to queue: ${parts.slice(2).join(' ')}`, 'success');
                    } else {
                        log(`Queue: ${state.appQueue.length} apps`, 'info');
                        state.appQueue.slice(0, 5).forEach((a, i) => log(`  ${i+1}. ${a.name}`, 'dim'));
                    }
                    break;

                case 'status':
                    log(`Status: ${state.status}`, 'info');
                    log(`Total cycles: ${state.stats.totalCycles}`, 'info');
                    log(`Success rate: ${calculateSuccessRate() || 0}%`, 'info');
                    break;

                case 'patterns':
                    const patterns = analyzePatterns();
                    if (patterns.length === 0) {
                        log('Not enough data for pattern analysis yet.', 'warning');
                    } else {
                        patterns.forEach(p => log(`‚Ä¢ ${p.text}`, 'info'));
                    }
                    break;

                case 'help':
                    log('Available commands:', 'info');
                    log('  analyze [app] - Analyze specific app', 'dim');
                    log('  improve      - Start improvement cycle', 'dim');
                    log('  queue        - Show queue status', 'dim');
                    log('  queue add [app] - Add app to queue', 'dim');
                    log('  status       - Show system status', 'dim');
                    log('  patterns     - Show learned patterns', 'dim');
                    break;

                case 'clear':
                    clearTerminal();
                    break;

                default:
                    log(`Unknown command: ${action}. Type "help" for available commands.`, 'error');
            }
        }

        // ==================== UTILITIES ====================

        function toggleStrategy(id) {
            const strategy = STRATEGIES.find(s => s.id === id);
            if (strategy) {
                strategy.active = !strategy.active;
                state.config.activeStrategies = STRATEGIES.filter(s => s.active).map(s => s.id);
                renderStrategies();
                saveState();
            }
        }

        function updateStrategyActive(id, active) {
            const strategy = STRATEGIES.find(s => s.id === id);
            if (strategy) {
                strategy.active = active;
                state.config.activeStrategies = STRATEGIES.filter(s => s.active).map(s => s.id);
                renderStrategies();
                saveState();
            }
        }

        function log(message, type = 'info') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function clearTerminal() {
            document.getElementById('terminal').innerHTML = '';
            log('Terminal cleared', 'dim');
        }

        function clearLog() {
            if (confirm('Clear all learning log entries? This cannot be undone.')) {
                state.learningLog = [];
                state.stats = { totalCycles: 0, successfulCycles: 0, partialCycles: 0, failedCycles: 0, totalImprovements: 0 };
                STRATEGIES.forEach(s => { s.successRate = 0; s.uses = 0; });
                saveState();
                updateUI();
                renderStrategies();
                log('Learning log cleared', 'warning');
            }
        }

        function openConfigModal() {
            document.getElementById('queueMode').value = state.config.queueMode;
            document.getElementById('consensusThreshold').value = state.config.consensusThreshold;
            document.getElementById('autoContinue').value = state.config.autoContinue.toString();
            document.getElementById('maxImprovements').value = state.config.maxImprovements;
            document.getElementById('configModal').classList.add('active');
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        function saveConfig() {
            state.config.queueMode = document.getElementById('queueMode').value;
            state.config.consensusThreshold = parseInt(document.getElementById('consensusThreshold').value);
            state.config.autoContinue = document.getElementById('autoContinue').value === 'true';
            state.config.maxImprovements = parseInt(document.getElementById('maxImprovements').value);
            saveState();
            closeConfigModal();
            log('Configuration saved', 'success');
        }

        function exportData() {
            const data = {
                exportDate: new Date().toISOString(),
                version: '1.0.0',
                state: state,
                strategies: STRATEGIES
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `meta-improvement-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            log('Data exported successfully', 'success');
        }

        function importData() {
            document.getElementById('importInput').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    state = { ...state, ...data.state };
                    if (data.strategies) {
                        STRATEGIES.forEach((s, i) => {
                            if (data.strategies[i]) {
                                Object.assign(s, data.strategies[i]);
                            }
                        });
                    }
                    saveState();
                    updateUI();
                    renderStrategies();
                    renderAppQueue();
                    log(`Data imported: ${data.state?.learningLog?.length || 0} log entries`, 'success');
                } catch (err) {
                    log(`Import failed: ${err.message}`, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function formatTime(iso) {
            const date = new Date(iso);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
