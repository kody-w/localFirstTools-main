<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Pomodoro productivity timer with session tracking, analytics, categories, and streak counter. Includes browser notifications and detailed weekly statistics.">
    <title>Pomodoro Timer - Analytics & Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-work: #dc3545;
            --accent-break: #28a745;
            --accent-long-break: #007bff;
            --accent-hover: #0056b3;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --shadow: rgba(0, 0, 0, 0.1);
            --chart-color-1: #007bff;
            --chart-color-2: #28a745;
            --chart-color-3: #ffc107;
            --chart-color-4: #dc3545;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #404040;
            --accent-work: #ff6b6b;
            --accent-break: #51cf66;
            --accent-long-break: #4dabf7;
            --accent-hover: #339af0;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow);
        }

        h1 {
            font-size: 1.5rem;
            color: var(--accent-work);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--accent-work);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-icon {
            padding: 0.6rem;
            font-size: 1.2rem;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Timer Card */
        .timer-card {
            text-align: center;
        }

        .timer-canvas-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 2rem auto;
        }

        #timerCanvas {
            display: block;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .timer-display {
            font-size: 4rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--accent-work);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .timer-label {
            font-size: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .session-info {
            margin: 1rem 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .category-select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            margin: 1rem 0;
            cursor: pointer;
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .timer-controls button {
            font-size: 1.1rem;
            padding: 1rem 2rem;
            min-width: 120px;
        }

        .btn-start {
            background: var(--success-color);
            color: white;
        }

        .btn-pause {
            background: var(--warning-color);
            color: white;
        }

        .btn-reset {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Stats Card */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-box {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-work);
            display: block;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .streak-box {
            background: linear-gradient(135deg, var(--accent-work), var(--accent-long-break));
            color: white;
        }

        .streak-box .stat-value,
        .streak-box .stat-label {
            color: white;
        }

        /* Chart */
        .chart-container {
            margin-top: 2rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        #analyticsChart {
            display: block;
            max-width: 100%;
        }

        /* Settings Card */
        .settings-grid {
            display: grid;
            gap: 1.5rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .setting-label {
            font-weight: 500;
        }

        .setting-input {
            width: 100px;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            text-align: center;
            font-size: 1rem;
        }

        /* History */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .history-info {
            flex: 1;
        }

        .history-time {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .history-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .history-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-work {
            background: var(--accent-work);
            color: white;
        }

        .badge-break {
            background: var(--accent-break);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px var(--shadow);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .keyboard-shortcuts {
            display: grid;
            gap: 0.75rem;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .shortcut-key {
            background: var(--bg-tertiary);
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            font-family: monospace;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 968px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .timer-canvas-container {
                width: 250px;
                height: 250px;
            }

            .timer-display {
                font-size: 3rem;
            }

            header {
                padding: 1rem;
            }

            main {
                padding: 1rem;
            }
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body data-theme="light">
    <!-- Header -->
    <header>
        <h1>üçÖ Pomodoro Timer</h1>
        <div class="header-actions">
            <button class="btn-secondary btn-icon" id="exportBtn" title="Export Data">üì•</button>
            <button class="btn-secondary btn-icon" id="importBtn" title="Import Data">üì§</button>
            <button class="btn-secondary btn-icon" id="themeBtn" title="Toggle Theme">üåô</button>
            <button class="btn-secondary btn-icon" id="helpBtn" title="Help">‚ùì</button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Top Row: Timer and Stats -->
        <div class="grid">
            <!-- Timer Card -->
            <div class="card timer-card">
                <div class="card-title">‚è±Ô∏è Timer</div>

                <div class="timer-canvas-container">
                    <canvas id="timerCanvas" width="300" height="300"></canvas>
                    <div class="timer-text">
                        <div class="timer-display" id="timerDisplay">25:00</div>
                        <div class="timer-label" id="timerLabel">WORK SESSION</div>
                    </div>
                </div>

                <div class="session-info" id="sessionInfo">
                    Session 1 of 4 ‚Ä¢ Focus Time
                </div>

                <select class="category-select" id="categorySelect" aria-label="Session category">
                    <option value="Work">üíº Work</option>
                    <option value="Study">üìö Study</option>
                    <option value="Exercise">üí™ Exercise</option>
                    <option value="Creative">üé® Creative</option>
                    <option value="Reading">üìñ Reading</option>
                    <option value="Other">‚≠ê Other</option>
                </select>

                <div class="timer-controls">
                    <button class="btn-start" id="startBtn">‚ñ∂Ô∏è Start</button>
                    <button class="btn-reset" id="resetBtn">‚èπÔ∏è Reset</button>
                </div>
            </div>

            <!-- Stats Card -->
            <div class="card">
                <div class="card-title">üìä Today's Stats</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="stat-value" id="todaySessions">0</span>
                        <span class="stat-label">Sessions</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="todayMinutes">0</span>
                        <span class="stat-label">Minutes</span>
                    </div>
                    <div class="stat-box streak-box">
                        <span class="stat-value" id="currentStreak">0</span>
                        <span class="stat-label">Day Streak</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="longestStreak">0</span>
                        <span class="stat-label">Best Streak</span>
                    </div>
                </div>

                <div class="card-title" style="margin-top: 2rem;">üìà Weekly Overview</div>
                <div class="chart-container">
                    <canvas id="analyticsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Bottom Row: Settings and History -->
        <div class="grid">
            <!-- Settings Card -->
            <div class="card">
                <div class="card-title">‚öôÔ∏è Settings</div>
                <div class="settings-grid">
                    <div class="setting-item">
                        <span class="setting-label">Work Duration (minutes)</span>
                        <input type="number" class="setting-input" id="workDuration" min="1" max="60" value="25">
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Short Break (minutes)</span>
                        <input type="number" class="setting-input" id="shortBreak" min="1" max="30" value="5">
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Long Break (minutes)</span>
                        <input type="number" class="setting-input" id="longBreak" min="1" max="60" value="15">
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Sessions Until Long Break</span>
                        <input type="number" class="setting-input" id="sessionsUntilLongBreak" min="2" max="10" value="4">
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Desktop Notifications</span>
                        <button class="btn-secondary" id="notificationBtn">Enable</button>
                    </div>
                </div>
            </div>

            <!-- History Card -->
            <div class="card">
                <div class="card-title">üìú Recent Sessions</div>
                <div class="history-list" id="historyList">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No sessions yet. Start your first Pomodoro!
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Help Modal -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">‚ùì Help & Shortcuts</div>
            <div class="modal-body">
                <h3 style="margin-bottom: 1rem;">Keyboard Shortcuts</h3>
                <div class="keyboard-shortcuts">
                    <div class="shortcut-item">
                        <span>Start/Pause Timer</span>
                        <span class="shortcut-key">Space</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Reset Timer</span>
                        <span class="shortcut-key">R</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle Help</span>
                        <span class="shortcut-key">?</span>
                    </div>
                </div>

                <h3 style="margin: 2rem 0 1rem;">What is Pomodoro Technique?</h3>
                <p style="line-height: 1.6; color: var(--text-secondary);">
                    The Pomodoro Technique is a time management method that uses a timer to break work into intervals,
                    traditionally 25 minutes in length, separated by short breaks. After 4 work sessions, take a longer break.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('helpModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">üì• Export Data</div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">Export all your Pomodoro data including sessions, settings, and statistics.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('exportModal')">Cancel</button>
                <button class="btn-primary" id="confirmExportBtn">Export JSON</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">üì§ Import Data</div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">Import previously exported Pomodoro data.</p>
                <input type="file" id="importFile" accept=".json" style="width: 100%; padding: 0.5rem;">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('importModal')">Cancel</button>
                <button class="btn-primary" id="confirmImportBtn">Import</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        const APP_STATE = {
            timer: {
                mode: 'work', // 'work', 'shortBreak', 'longBreak'
                isRunning: false,
                timeRemaining: 25 * 60, // seconds
                sessionCount: 0,
                currentCategory: 'Work'
            },
            settings: {
                workDuration: 25,
                shortBreak: 5,
                longBreak: 15,
                sessionsUntilLongBreak: 4,
                notificationsEnabled: false
            },
            sessions: [],
            streaks: {
                current: 0,
                longest: 0,
                lastDate: null
            },
            startTime: null,
            animationId: null
        };

        // DOM Elements
        const elements = {
            canvas: document.getElementById('timerCanvas'),
            display: document.getElementById('timerDisplay'),
            label: document.getElementById('timerLabel'),
            sessionInfo: document.getElementById('sessionInfo'),
            categorySelect: document.getElementById('categorySelect'),
            startBtn: document.getElementById('startBtn'),
            resetBtn: document.getElementById('resetBtn'),
            todaySessions: document.getElementById('todaySessions'),
            todayMinutes: document.getElementById('todayMinutes'),
            currentStreak: document.getElementById('currentStreak'),
            longestStreak: document.getElementById('longestStreak'),
            historyList: document.getElementById('historyList'),
            analyticsChart: document.getElementById('analyticsChart')
        };

        const ctx = elements.canvas.getContext('2d');
        const chartCtx = elements.analyticsChart.getContext('2d');

        // Initialize
        function init() {
            loadFromStorage();
            setupEventListeners();
            updateDisplay();
            updateStats();
            updateHistory();
            drawChart();
            checkNotificationPermission();
            updateStreaks();

            // Update every second
            setInterval(tick, 1000);
        }

        // Storage
        function loadFromStorage() {
            const stored = localStorage.getItem('pomodoroTimerData');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    APP_STATE.settings = { ...APP_STATE.settings, ...data.settings };
                    APP_STATE.sessions = data.sessions || [];
                    APP_STATE.streaks = { ...APP_STATE.streaks, ...data.streaks };

                    // Apply settings to UI
                    document.getElementById('workDuration').value = APP_STATE.settings.workDuration;
                    document.getElementById('shortBreak').value = APP_STATE.settings.shortBreak;
                    document.getElementById('longBreak').value = APP_STATE.settings.longBreak;
                    document.getElementById('sessionsUntilLongBreak').value = APP_STATE.settings.sessionsUntilLongBreak;

                    // Apply theme
                    const theme = data.theme || 'light';
                    document.body.setAttribute('data-theme', theme);
                    document.getElementById('themeBtn').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                } catch (e) {
                    console.error('Failed to load data:', e);
                }
            }
        }

        function saveToStorage() {
            try {
                const data = {
                    settings: APP_STATE.settings,
                    sessions: APP_STATE.sessions,
                    streaks: APP_STATE.streaks,
                    theme: document.body.getAttribute('data-theme')
                };
                localStorage.setItem('pomodoroTimerData', JSON.stringify(data));
            } catch (e) {
                console.error('Failed to save data:', e);
            }
        }

        // Timer Logic
        function tick() {
            if (!APP_STATE.timer.isRunning) return;

            APP_STATE.timer.timeRemaining--;

            if (APP_STATE.timer.timeRemaining <= 0) {
                completeSession();
            }

            updateDisplay();
            drawTimerCircle();
        }

        function startTimer() {
            if (APP_STATE.timer.isRunning) {
                pauseTimer();
                return;
            }

            APP_STATE.timer.isRunning = true;
            APP_STATE.startTime = Date.now();
            elements.startBtn.innerHTML = '‚è∏Ô∏è Pause';
            elements.startBtn.className = 'btn-pause';

            drawTimerCircle();
        }

        function pauseTimer() {
            APP_STATE.timer.isRunning = false;
            elements.startBtn.innerHTML = '‚ñ∂Ô∏è Start';
            elements.startBtn.className = 'btn-start';
        }

        function resetTimer() {
            pauseTimer();
            APP_STATE.timer.mode = 'work';
            APP_STATE.timer.timeRemaining = APP_STATE.settings.workDuration * 60;
            APP_STATE.timer.sessionCount = 0;
            updateDisplay();
            drawTimerCircle();
        }

        function completeSession() {
            pauseTimer();

            // Save session
            const session = {
                id: Date.now(),
                startTime: APP_STATE.startTime,
                endTime: Date.now(),
                duration: getCurrentDuration() * 60,
                type: APP_STATE.timer.mode,
                category: APP_STATE.timer.currentCategory,
                completed: true,
                date: new Date().toISOString().split('T')[0]
            };

            APP_STATE.sessions.unshift(session);

            // Update streaks only for work sessions
            if (APP_STATE.timer.mode === 'work') {
                APP_STATE.timer.sessionCount++;
                updateStreaks();
            }

            saveToStorage();
            updateStats();
            updateHistory();
            drawChart();

            // Notify user
            playNotificationSound();
            showNotification();

            // Switch mode
            if (APP_STATE.timer.mode === 'work') {
                if (APP_STATE.timer.sessionCount % APP_STATE.settings.sessionsUntilLongBreak === 0) {
                    switchMode('longBreak');
                } else {
                    switchMode('shortBreak');
                }
            } else {
                switchMode('work');
            }
        }

        function switchMode(newMode) {
            APP_STATE.timer.mode = newMode;

            switch(newMode) {
                case 'work':
                    APP_STATE.timer.timeRemaining = APP_STATE.settings.workDuration * 60;
                    break;
                case 'shortBreak':
                    APP_STATE.timer.timeRemaining = APP_STATE.settings.shortBreak * 60;
                    break;
                case 'longBreak':
                    APP_STATE.timer.timeRemaining = APP_STATE.settings.longBreak * 60;
                    break;
            }

            updateDisplay();
            drawTimerCircle();
        }

        function getCurrentDuration() {
            switch(APP_STATE.timer.mode) {
                case 'work': return APP_STATE.settings.workDuration;
                case 'shortBreak': return APP_STATE.settings.shortBreak;
                case 'longBreak': return APP_STATE.settings.longBreak;
            }
        }

        // Display Updates
        function updateDisplay() {
            const minutes = Math.floor(APP_STATE.timer.timeRemaining / 60);
            const seconds = APP_STATE.timer.timeRemaining % 60;
            elements.display.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            let label = '';
            let color = '';

            switch(APP_STATE.timer.mode) {
                case 'work':
                    label = 'WORK SESSION';
                    color = 'var(--accent-work)';
                    break;
                case 'shortBreak':
                    label = 'SHORT BREAK';
                    color = 'var(--accent-break)';
                    break;
                case 'longBreak':
                    label = 'LONG BREAK';
                    color = 'var(--accent-long-break)';
                    break;
            }

            elements.label.textContent = label;
            elements.display.style.color = color;

            const sessionNum = (APP_STATE.timer.sessionCount % APP_STATE.settings.sessionsUntilLongBreak) + 1;
            elements.sessionInfo.textContent = `Session ${sessionNum} of ${APP_STATE.settings.sessionsUntilLongBreak} ‚Ä¢ ${APP_STATE.timer.currentCategory}`;

            // Update page title
            document.title = `${elements.display.textContent} - ${label}`;
        }

        function drawTimerCircle() {
            const centerX = elements.canvas.width / 2;
            const centerY = elements.canvas.height / 2;
            const radius = 120;

            // Clear canvas
            ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);

            // Background circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border-color');
            ctx.lineWidth = 12;
            ctx.stroke();

            // Progress arc
            const totalTime = getCurrentDuration() * 60;
            const progress = 1 - (APP_STATE.timer.timeRemaining / totalTime);
            const startAngle = -Math.PI / 2;
            const endAngle = startAngle + (2 * Math.PI * progress);

            let color = '';
            switch(APP_STATE.timer.mode) {
                case 'work': color = getComputedStyle(document.body).getPropertyValue('--accent-work'); break;
                case 'shortBreak': color = getComputedStyle(document.body).getPropertyValue('--accent-break'); break;
                case 'longBreak': color = getComputedStyle(document.body).getPropertyValue('--accent-long-break'); break;
            }

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.strokeStyle = color;
            ctx.lineWidth = 12;
            ctx.lineCap = 'round';
            ctx.stroke();

            if (APP_STATE.timer.isRunning) {
                requestAnimationFrame(() => drawTimerCircle());
            }
        }

        // Statistics
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const todaySessions = APP_STATE.sessions.filter(s => s.date === today && s.type === 'work');

            elements.todaySessions.textContent = todaySessions.length;

            const totalMinutes = todaySessions.reduce((sum, s) => sum + (s.duration / 60), 0);
            elements.todayMinutes.textContent = Math.round(totalMinutes);

            elements.currentStreak.textContent = APP_STATE.streaks.current;
            elements.longestStreak.textContent = APP_STATE.streaks.longest;
        }

        function updateStreaks() {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            const todaySessions = APP_STATE.sessions.filter(s => s.date === today && s.type === 'work');

            if (todaySessions.length > 0) {
                if (APP_STATE.streaks.lastDate === today) {
                    // Already counted today
                    return;
                } else if (APP_STATE.streaks.lastDate === yesterday || APP_STATE.streaks.lastDate === null) {
                    // Continue streak
                    APP_STATE.streaks.current++;
                } else {
                    // Streak broken, start new
                    APP_STATE.streaks.current = 1;
                }

                APP_STATE.streaks.lastDate = today;
                APP_STATE.streaks.longest = Math.max(APP_STATE.streaks.longest, APP_STATE.streaks.current);

                saveToStorage();
                updateStats();
            }
        }

        function updateHistory() {
            const recentSessions = APP_STATE.sessions.slice(0, 10);

            if (recentSessions.length === 0) {
                elements.historyList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No sessions yet. Start your first Pomodoro!
                    </div>
                `;
                return;
            }

            elements.historyList.innerHTML = recentSessions.map(session => {
                const time = new Date(session.endTime).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const date = new Date(session.endTime).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });

                const badgeClass = session.type === 'work' ? 'badge-work' : 'badge-break';
                const typeLabel = session.type === 'work' ? 'Work' : 'Break';

                return `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-time">${time} ‚Ä¢ ${date}</div>
                            <div class="history-meta">${session.category} ‚Ä¢ ${Math.round(session.duration / 60)}m</div>
                        </div>
                        <div class="history-badge ${badgeClass}">${typeLabel}</div>
                    </div>
                `;
            }).join('');
        }

        // Chart
        function drawChart() {
            const width = elements.analyticsChart.width = elements.analyticsChart.offsetWidth * 2;
            const height = elements.analyticsChart.height = 300;

            chartCtx.clearRect(0, 0, width, height);

            // Get last 7 days
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 86400000).toISOString().split('T')[0];
                days.push(date);
            }

            // Count sessions per day
            const data = days.map(date => {
                return APP_STATE.sessions.filter(s => s.date === date && s.type === 'work').length;
            });

            const maxSessions = Math.max(...data, 1);
            const barWidth = width / (days.length * 2);
            const padding = 40;
            const chartHeight = height - padding * 2;

            // Draw bars
            data.forEach((value, index) => {
                const barHeight = (value / maxSessions) * chartHeight;
                const x = padding + (index * barWidth * 2);
                const y = height - padding - barHeight;

                chartCtx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent-work');
                chartCtx.fillRect(x, y, barWidth, barHeight);

                // Labels
                chartCtx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary');
                chartCtx.font = '20px sans-serif';
                chartCtx.textAlign = 'center';

                const dayLabel = new Date(days[index]).toLocaleDateString('en-US', { weekday: 'short' });
                chartCtx.fillText(dayLabel, x + barWidth / 2, height - 10);

                // Value
                if (value > 0) {
                    chartCtx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary');
                    chartCtx.fillText(value, x + barWidth / 2, y - 10);
                }
            });
        }

        // Notifications
        function checkNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    APP_STATE.settings.notificationsEnabled = true;
                    document.getElementById('notificationBtn').textContent = 'Enabled';
                    document.getElementById('notificationBtn').disabled = true;
                }
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        APP_STATE.settings.notificationsEnabled = true;
                        document.getElementById('notificationBtn').textContent = 'Enabled';
                        document.getElementById('notificationBtn').disabled = true;
                        saveToStorage();
                    }
                });
            }
        }

        function showNotification() {
            if (!APP_STATE.settings.notificationsEnabled) return;

            let title = '';
            let body = '';

            switch(APP_STATE.timer.mode) {
                case 'work':
                    title = 'Work Session Complete!';
                    body = 'Time for a break. Great job!';
                    break;
                case 'shortBreak':
                case 'longBreak':
                    title = 'Break Complete!';
                    body = 'Ready to get back to work?';
                    break;
            }

            new Notification(title, { body, icon: 'üçÖ' });
        }

        function playNotificationSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Event Listeners
        function setupEventListeners() {
            elements.startBtn.addEventListener('click', startTimer);
            elements.resetBtn.addEventListener('click', resetTimer);

            elements.categorySelect.addEventListener('change', (e) => {
                APP_STATE.timer.currentCategory = e.target.value;
                updateDisplay();
            });

            // Settings
            ['workDuration', 'shortBreak', 'longBreak', 'sessionsUntilLongBreak'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    APP_STATE.settings[id] = parseInt(e.target.value);
                    saveToStorage();
                    if (!APP_STATE.timer.isRunning) {
                        resetTimer();
                    }
                });
            });

            document.getElementById('notificationBtn').addEventListener('click', requestNotificationPermission);

            // Theme
            document.getElementById('themeBtn').addEventListener('click', () => {
                const current = document.body.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', newTheme);
                document.getElementById('themeBtn').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                saveToStorage();
                drawTimerCircle();
                drawChart();
            });

            // Modals
            document.getElementById('helpBtn').addEventListener('click', () => openModal('helpModal'));
            document.getElementById('exportBtn').addEventListener('click', () => openModal('exportModal'));
            document.getElementById('importBtn').addEventListener('click', () => openModal('importModal'));

            document.getElementById('confirmExportBtn').addEventListener('click', exportData);
            document.getElementById('confirmImportBtn').addEventListener('click', importData);

            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT') return;

                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        startTimer();
                        break;
                    case 'r':
                    case 'R':
                        e.preventDefault();
                        resetTimer();
                        break;
                    case '?':
                        e.preventDefault();
                        openModal('helpModal');
                        break;
                }
            });

            // Resize chart
            window.addEventListener('resize', () => {
                drawChart();
            });
        }

        // Import/Export
        function exportData() {
            const data = {
                settings: APP_STATE.settings,
                sessions: APP_STATE.sessions,
                streaks: APP_STATE.streaks,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pomodoro-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            closeModal('exportModal');
        }

        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    if (confirm('This will merge imported data with existing data. Continue?')) {
                        APP_STATE.sessions.push(...data.sessions);
                        APP_STATE.streaks = { ...APP_STATE.streaks, ...data.streaks };

                        saveToStorage();
                        updateStats();
                        updateHistory();
                        drawChart();

                        alert('Data imported successfully!');
                    }

                    closeModal('importModal');
                } catch (err) {
                    alert('Failed to import: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // Modal helpers
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', init);

        // Save before unload
        window.addEventListener('beforeunload', saveToStorage);
    </script>
</body>
</html>