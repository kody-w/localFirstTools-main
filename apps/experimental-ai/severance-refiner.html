<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Severance: The Refinement</title>
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="experimental_ai">
<meta name="rappterzoo:tags" content="canvas,game,audio,horror,puzzle,severance">
<meta name="rappterzoo:type" content="game">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="2">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a202c;color:#48bb78;font-family:monospace;overflow:hidden;height:100vh;width:100vw}
canvas{display:block;position:absolute;top:0;left:0}
#hud{position:absolute;top:10px;left:10px;pointer-events:none;z-index:10;font-size:13px;text-shadow:0 0 6px #48bb78}
#hud div{margin:3px 0}
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20;background:rgba(26,32,44,0.95)}
.overlay h1{font-size:42px;color:#48bb78;text-shadow:0 0 20px #48bb78;margin-bottom:15px;letter-spacing:6px;text-transform:uppercase}
.overlay h2{font-size:20px;color:#68d391;margin-bottom:25px;letter-spacing:3px}
.overlay p{color:#a0aec0;font-size:14px;margin:5px 0;max-width:450px;text-align:center;line-height:1.6}
.overlay button{margin:6px;padding:12px 36px;font-family:monospace;font-size:16px;background:transparent;color:#48bb78;border:2px solid #48bb78;cursor:pointer;letter-spacing:2px;transition:all 0.3s;border-radius:2px}
.overlay button:hover{background:#48bb78;color:#1a202c;box-shadow:0 0 20px #48bb78}
.diff-row{display:flex;gap:8px;margin:12px 0}
.diff-row button{font-size:13px;padding:8px 20px}
.diff-row button.sel{background:#48bb78;color:#1a202c}
.stats-box{text-align:left;background:rgba(45,55,72,0.8);padding:12px 16px;border:1px solid #48bb78;border-radius:4px;margin:12px;min-width:280px;font-size:13px}
.stats-box div{margin:3px 0}
#quota-bar{position:absolute;top:10px;right:10px;width:200px;z-index:10}
#quota-bar .bar-bg{width:100%;height:20px;background:#2d3748;border:1px solid #48bb78;border-radius:2px}
#quota-bar .bar-fill{height:100%;background:linear-gradient(90deg,#276749,#48bb78);transition:width 0.3s;border-radius:2px}
#quota-bar .bar-label{text-align:center;font-size:11px;color:#48bb78;margin-top:2px}
#msg-box{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:14px;color:#48bb78;text-align:center;z-index:10;pointer-events:none;opacity:0;transition:opacity 0.5s}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="hud">
<div id="floor-display">FLOOR: B1</div>
<div id="score-display">REFINED: 0</div>
<div id="health-display">WELLNESS: 100%</div>
<div id="combo-display"></div>
<div id="ability-display">Q:Waffle W:Music E:Focus R:Break</div>
</div>
<div id="quota-bar">
<div class="bar-bg"><div class="bar-fill" id="quota-fill" style="width:0%"></div></div>
<div class="bar-label" id="quota-label">Quota: 0/20</div>
</div>
<div id="msg-box"></div>

<div id="title-screen" class="overlay">
<h1>SEVERANCE</h1>
<h2>The Refinement</h2>
<p>You are an Innie at Lumon Industries. Navigate the eternal hallways of the Severed Floor. Refine scary numbers. Avoid O&D. Meet your quota. The work is mysterious and important.</p>
<p style="color:#68d391;margin-top:10px">WASD to move | Collect green numbers | Avoid red entities | ESC to pause</p>
<div class="diff-row">
<button onclick="setDiff(0)" id="d0">INTERN</button>
<button onclick="setDiff(1)" id="d1" class="sel">REFINER</button>
<button onclick="setDiff(2)" id="d2">MANAGER</button>
</div>
<button onclick="startGame()">BEGIN REFINEMENT</button>
</div>

<div id="pause-screen" class="overlay" style="display:none">
<h1>PAUSED</h1>
<p>Please enjoy every sandwich.</p>
<button onclick="togglePause()">RESUME</button>
<button onclick="showTitle()">RESIGN</button>
</div>

<div id="gameover-screen" class="overlay" style="display:none">
<h1 id="go-title">WELLNESS CHECK FAILED</h1>
<h2 id="go-sub"></h2>
<div class="stats-box" id="go-stats"></div>
<button onclick="startGame()">TRY AGAIN (R)</button>
<button onclick="showTitle()">MAIN MENU</button>
</div>

<script>
const C=document.getElementById('c'),X=C.getContext('2d');
let W,H;function resize(){W=C.width=innerWidth;H=C.height=innerHeight}
resize();addEventListener('resize',resize);

// Audio
const AC=new(window.AudioContext||window.webkitAudioContext)();
function sfx(type){
if(AC.state==='suspended')AC.resume();
const o=AC.createOscillator(),g=AC.createGain(),t=AC.currentTime;
g.connect(AC.destination);o.connect(g);
switch(type){
case'collect':o.type='sine';o.frequency.setValueAtTime(523,t);o.frequency.exponentialRampToValueAtTime(784,t+0.08);g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);o.start(t);o.stop(t+0.12);break;
case'scary':o.type='sine';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(80,t+0.3);g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.35);o.start(t);o.stop(t+0.35);break;
case'hit':o.type='sawtooth';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(40,t+0.25);g.gain.setValueAtTime(0.18,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);o.start(t);o.stop(t+0.3);break;
case'quota':o.type='sine';o.frequency.setValueAtTime(392,t);o.frequency.setValueAtTime(523,t+0.1);o.frequency.setValueAtTime(659,t+0.2);o.frequency.setValueAtTime(784,t+0.3);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.5);o.start(t);o.stop(t+0.5);break;
case'alarm':o.type='square';o.frequency.setValueAtTime(600,t);o.frequency.setValueAtTime(300,t+0.15);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);o.start(t);o.stop(t+0.3);break;
case'waffle':o.type='triangle';o.frequency.setValueAtTime(440,t);o.frequency.setValueAtTime(554,t+0.1);o.frequency.setValueAtTime(659,t+0.2);g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.4);o.start(t);o.stop(t+0.4);break;
case'music':o.type='sine';o.frequency.setValueAtTime(262,t);o.frequency.setValueAtTime(330,t+0.15);o.frequency.setValueAtTime(392,t+0.3);g.gain.setValueAtTime(0.06,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.5);o.start(t);o.stop(t+0.5);break;
case'death':o.type='sawtooth';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(20,t+1);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.001,t+1.2);o.start(t);o.stop(t+1.2);break;
case'menu':o.type='sine';o.frequency.setValueAtTime(440,t);g.gain.setValueAtTime(0.05,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.08);o.start(t);o.stop(t+0.08);break;
}
}

let difficulty=1,state='title',score=0,combo=0,maxCombo=0,floor=1;
let numbersRefined=0,scaryFound=0,quotaMet=0,timeAlive=0;
let shakeX=0,shakeY=0,shakeDur=0;
let particles=[],messages=[];

const DIFF=[
{name:'Intern',hpMult:0.6,spdMult:0.7,quotaMult:0.7},
{name:'Refiner',hpMult:1,spdMult:1,quotaMult:1},
{name:'Manager',hpMult:1.5,spdMult:1.3,quotaMult:1.4}
];

let player={x:0,y:0,hp:100,maxHp:100,speed:3,radius:10,invuln:0,
waffleCD:0,musicCD:0,focusCD:0,breakCD:0,focused:false,focusDur:0,musicDur:0};

const TILE=40,COLS=60,ROWS=45;
let grid=[],numbers=[],entities=[],quota=0,quotaTarget=20;
let cam={x:0,y:0};

let keys={};
addEventListener('keydown',e=>{
keys[e.key.toLowerCase()]=true;
if(e.key==='Escape'){if(state==='playing')togglePause();else if(state==='paused')togglePause()}
if(state==='playing'){
if(e.key.toLowerCase()==='q')useAbility('waffle');
if(e.key.toLowerCase()==='w')useAbility('music');
if(e.key.toLowerCase()==='e')useAbility('focus');
if(e.key.toLowerCase()==='r'&&e.key==='r')useAbility('break');
}
if(state==='gameover'&&e.key.toLowerCase()==='r')startGame();
});
addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false});

let touchStart=null,touchDir={x:0,y:0};
C.addEventListener('touchstart',e=>{e.preventDefault();touchStart={x:e.touches[0].clientX,y:e.touches[0].clientY}},{passive:false});
C.addEventListener('touchmove',e=>{e.preventDefault();if(!touchStart)return;const t=e.touches[0];touchDir.x=t.clientX-touchStart.x;touchDir.y=t.clientY-touchStart.y;const l=Math.sqrt(touchDir.x**2+touchDir.y**2);if(l>10){touchDir.x/=l;touchDir.y/=l}else{touchDir.x=0;touchDir.y=0}},{passive:false});
C.addEventListener('touchend',()=>{touchStart=null;touchDir={x:0,y:0}});

function setDiff(d){difficulty=d;document.querySelectorAll('.diff-row button').forEach((b,i)=>b.classList.toggle('sel',i===d));sfx('menu')}

function showMsg(text,dur){
const el=document.getElementById('msg-box');
el.textContent=text;el.style.opacity=1;
setTimeout(()=>el.style.opacity=0,dur||2000);
}

function generateMap(){
grid=[];
for(let r=0;r<ROWS;r++){grid[r]=[];for(let c=0;c<COLS;c++){
if(r===0||r===ROWS-1||c===0||c===COLS-1)grid[r][c]=1;
else grid[r][c]=Math.random()<0.3?1:0;
}}
// Lumon-style corridors: long straight hallways
for(let i=0;i<10+floor*2;i++){
const horiz=Math.random()<0.5;
const len=10+Math.floor(Math.random()*20);
let cx=2+Math.floor(Math.random()*(COLS-4));
let cy=2+Math.floor(Math.random()*(ROWS-4));
for(let j=0;j<len;j++){
if(horiz){for(let w=-1;w<=1;w++)if(cy+w>0&&cy+w<ROWS-1&&cx<COLS-1)grid[cy+w][cx]=0;cx++}
else{for(let w=-1;w<=1;w++)if(cx+w>0&&cx+w<COLS-1&&cy<ROWS-1)grid[cy][cx+w]=0;cy++}
}}
// Rooms (offices, break room, etc)
for(let i=0;i<6+floor;i++){
const rw=3+Math.floor(Math.random()*5);
const rh=3+Math.floor(Math.random()*4);
const rx=2+Math.floor(Math.random()*(COLS-rw-4));
const ry=2+Math.floor(Math.random()*(ROWS-rh-4));
for(let r=ry;r<ry+rh;r++)for(let c=rx;c<rx+rw;c++)grid[r][c]=0;
}
// Place player
let placed=false;
while(!placed){const px=2+Math.floor(Math.random()*(COLS-4));const py=2+Math.floor(Math.random()*(ROWS-4));
if(grid[py][px]===0){player.x=px*TILE+TILE/2;player.y=py*TILE+TILE/2;placed=true}}
}

function spawnNumbers(){
numbers=[];
const count=20+floor*5;
for(let i=0;i<count;i++){
let tries=0;
while(tries++<50){
const nx=2+Math.floor(Math.random()*(COLS-4));
const ny=2+Math.floor(Math.random()*(ROWS-4));
if(grid[ny][nx]===0){
const isScary=Math.random()<0.25;
numbers.push({x:nx*TILE+TILE/2,y:ny*TILE+TILE/2,value:Math.floor(Math.random()*999),
scary:isScary,collected:false,radius:8,pulse:Math.random()*6.28,
type:isScary?'scary':'normal'});
break;
}
}}
}

const ENTITY_TYPES=[
{name:'Milchick',color:'#e53e3e',speed:1.5,hp:40,damage:20,radius:10,behavior:'patrol',detect:150},
{name:'Cobel',color:'#d69e2e',speed:1.2,hp:60,damage:25,radius:12,behavior:'chase',detect:180},
{name:'O&D Agent',color:'#805ad5',speed:1.8,hp:25,damage:15,radius:8,behavior:'swarm',detect:120},
{name:'Security',color:'#e53e3e',speed:1,hp:80,damage:30,radius:14,behavior:'sentinel',detect:200},
{name:'Helly R',color:'#ed64a6',speed:2,hp:20,damage:10,radius:9,behavior:'ghost',detect:100},
{name:'Board Member',color:'#fff',speed:0.8,hp:150,damage:40,radius:18,behavior:'boss',detect:250}
];

function spawnEntities(){
entities=[];
const d=DIFF[difficulty];
const count=Math.floor((4+floor*2)*d.quotaMult);
for(let i=0;i<count;i++){
let tries=0;
while(tries++<50){
const ex=2+Math.floor(Math.random()*(COLS-4));
const ey=2+Math.floor(Math.random()*(ROWS-4));
if(grid[ey][ex]===0){
const dist=Math.sqrt((ex*TILE-player.x)**2+(ey*TILE-player.y)**2);
if(dist>200){
const ti=Math.min(Math.floor(Math.random()*Math.min(floor+1,5)),4);
const t=ENTITY_TYPES[ti];
entities.push({x:ex*TILE+TILE/2,y:ey*TILE+TILE/2,
hp:Math.floor(t.hp*d.hpMult),maxHp:Math.floor(t.hp*d.hpMult),
speed:t.speed*d.spdMult,damage:t.damage,radius:t.radius,
color:t.color,type:t.behavior,detect:t.detect,name:t.name,
alert:0,patrolDir:Math.random()*6.28,patrolTimer:0,
stunned:0,startX:ex*TILE+TILE/2,startY:ey*TILE+TILE/2,
musicAffected:false});
break;
}}}}
// Boss on floor 5,10,etc
if(floor%5===0){
let tries=0;
while(tries++<100){
const bx=2+Math.floor(Math.random()*(COLS-4));
const by=2+Math.floor(Math.random()*(ROWS-4));
if(grid[by][bx]===0){
const dist=Math.sqrt((bx*TILE-player.x)**2+(by*TILE-player.y)**2);
if(dist>300){
const bt=ENTITY_TYPES[5];
entities.push({x:bx*TILE+TILE/2,y:by*TILE+TILE/2,
hp:bt.hp+floor*20,maxHp:bt.hp+floor*20,
speed:bt.speed,damage:bt.damage,radius:bt.radius,
color:bt.color,type:'boss',detect:bt.detect,name:'BOARD MEMBER',
alert:200,patrolDir:0,patrolTimer:0,stunned:0,
startX:bx*TILE+TILE/2,startY:by*TILE+TILE/2,
musicAffected:false,phase:0,shootCD:0,chargeCD:0});
showMsg('WARNING: Board Member on this floor!');
sfx('alarm');break;
}}}}
}

function useAbility(type){
switch(type){
case'waffle':
if(player.waffleCD>0)return;
player.waffleCD=300;player.hp=Math.min(player.maxHp,player.hp+25);
sfx('waffle');showMsg('Waffle Party! +25 Wellness');
spawnParticles(player.x,player.y,'#f6e05e',10);break;
case'music':
if(player.musicCD>0)return;
player.musicCD=480;player.musicDur=180;
sfx('music');showMsg('Music Dance Experience active!');
entities.forEach(e=>{
const dist=Math.sqrt((e.x-player.x)**2+(e.y-player.y)**2);
if(dist<250){e.stunned=120;e.musicAffected=true;
spawnParticles(e.x,e.y,'#9f7aea',6)}
});break;
case'focus':
if(player.focusCD>0)return;
player.focusCD=360;player.focused=true;player.focusDur=240;
sfx('collect');showMsg('Refinement Focus! Double points');break;
case'break':
if(player.breakCD>0)return;
player.breakCD=600;player.invuln=120;
sfx('waffle');showMsg('Break Room immunity!');
spawnParticles(player.x,player.y,'#68d391',15);break;
}
}

function spawnParticles(x,y,color,count){
for(let i=0;i<count;i++){
const a=Math.random()*6.28,s=1+Math.random()*3;
particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,
life:25+Math.random()*25,maxLife:50,color,radius:2+Math.random()*3});
}}

function shake(a,d){shakeX=a;shakeY=a;shakeDur=d}

function isWall(x,y){const c=Math.floor(x/TILE),r=Math.floor(y/TILE);
if(c<0||c>=COLS||r<0||r>=ROWS)return true;return grid[r][c]===1}

function moveEntity(e,dx,dy){
const nx=e.x+dx,ny=e.y+dy;
if(!isWall(nx-e.radius,ny)&&!isWall(nx+e.radius,ny)&&
!isWall(nx,ny-e.radius)&&!isWall(nx,ny+e.radius)){e.x=nx;e.y=ny;return true}
return false}

function nextFloor(){
floor++;quota=0;
quotaTarget=Math.floor((20+floor*5)*DIFF[difficulty].quotaMult);
generateMap();spawnNumbers();spawnEntities();
player.hp=Math.min(player.maxHp,player.hp+20);
showMsg('=== FLOOR B'+floor+' ===');sfx('quota');
}

function startGame(){
state='playing';score=0;combo=0;maxCombo=0;floor=1;quota=0;
numbersRefined=0;scaryFound=0;quotaMet=0;timeAlive=0;
quotaTarget=Math.floor(20*DIFF[difficulty].quotaMult);
player.hp=player.maxHp;player.invuln=0;player.focused=false;
player.waffleCD=0;player.musicCD=0;player.focusCD=0;player.breakCD=0;
particles=[];
generateMap();spawnNumbers();spawnEntities();
document.getElementById('title-screen').style.display='none';
document.getElementById('gameover-screen').style.display='none';
document.getElementById('pause-screen').style.display='none';
showMsg('Welcome to Lumon. The work is mysterious and important.');
sfx('menu');
}

function togglePause(){
if(state==='playing'){state='paused';document.getElementById('pause-screen').style.display='flex';sfx('menu')}
else if(state==='paused'){state='playing';document.getElementById('pause-screen').style.display='none';sfx('menu')}
}
function showTitle(){state='title';document.getElementById('title-screen').style.display='flex';
document.getElementById('pause-screen').style.display='none';document.getElementById('gameover-screen').style.display='none'}

function gameOver(won){
state='gameover';
document.getElementById('gameover-screen').style.display='flex';
document.getElementById('go-title').textContent=won?'QUOTA COMPLETE':'WELLNESS CHECK FAILED';
document.getElementById('go-sub').textContent=won?'You have earned a Music Dance Experience':'Your outie has been notified';
const secs=Math.floor(timeAlive/60);
document.getElementById('go-stats').innerHTML=
'<div>NUMBERS REFINED: '+numbersRefined+'</div>'+
'<div>SCARY NUMBERS FOUND: '+scaryFound+'</div>'+
'<div>QUOTAS MET: '+quotaMet+'</div>'+
'<div>FINAL SCORE: '+score+'</div>'+
'<div>MAX COMBO: '+maxCombo+'x</div>'+
'<div>FLOORS CLEARED: '+(floor-1)+'</div>'+
'<div>TIME: '+Math.floor(secs/60)+'m '+secs%60+'s</div>'+
'<div>DIFFICULTY: '+DIFF[difficulty].name+'</div>';
sfx(won?'quota':'death');
const hs=JSON.parse(localStorage.getItem('severance_hs')||'[]');
hs.push({score,floor,combo:maxCombo,numbers:numbersRefined,diff:difficulty,date:Date.now()});
hs.sort((a,b)=>b.score-a.score);while(hs.length>10)hs.pop();
localStorage.setItem('severance_hs',JSON.stringify(hs));
}

function update(){
if(state!=='playing')return;
timeAlive++;
if(player.waffleCD>0)player.waffleCD--;
if(player.musicCD>0)player.musicCD--;
if(player.focusCD>0)player.focusCD--;
if(player.breakCD>0)player.breakCD--;
if(player.invuln>0)player.invuln--;
if(player.focusDur>0){player.focusDur--;if(player.focusDur<=0)player.focused=false}
if(player.musicDur>0)player.musicDur--;

let dx=0,dy=0;
if(keys['w']||keys['arrowup'])dy=-1;
if(keys['s']||keys['arrowdown'])dy=1;
if(keys['a']||keys['arrowleft'])dx=-1;
if(keys['d']||keys['arrowright'])dx=1;
if(touchDir.x||touchDir.y){dx=touchDir.x;dy=touchDir.y}
if(dx||dy){const l=Math.sqrt(dx*dx+dy*dy);dx=dx/l*player.speed;dy=dy/l*player.speed;moveEntity(player,dx,dy)}

cam.x=player.x-W/2;cam.y=player.y-H/2;
cam.x=Math.max(0,Math.min(COLS*TILE-W,cam.x));
cam.y=Math.max(0,Math.min(ROWS*TILE-H,cam.y));

// Number collection
numbers.forEach(n=>{
if(n.collected)return;n.pulse+=0.05;
const dist=Math.sqrt((n.x-player.x)**2+(n.y-player.y)**2);
if(dist<n.radius+player.radius){
n.collected=true;
if(n.scary){
const pts=(player.focused?20:10)*Math.max(1,combo);
score+=pts;combo++;scaryFound++;
if(combo>maxCombo)maxCombo=combo;
sfx('scary');spawnParticles(n.x,n.y,'#48bb78',8);
showMsg('SCARY NUMBER REFINED! +'+pts);
}else{
const pts=(player.focused?6:3)*Math.max(1,combo);
score+=pts;combo++;numbersRefined++;
if(combo>maxCombo)maxCombo=combo;
sfx('collect');spawnParticles(n.x,n.y,'#68d391',5);
}
quota++;
}
});

// Check quota
if(quota>=quotaTarget){
quotaMet++;
if(floor>=10){gameOver(true)}
else{nextFloor()}
}

// Entities
entities.forEach(e=>{
if(e.stunned>0){e.stunned--;return}
e.musicAffected=false;
const dist=Math.sqrt((e.x-player.x)**2+(e.y-player.y)**2);
const detected=dist<e.detect;
if(detected)e.alert=Math.min(300,e.alert+3);else e.alert=Math.max(0,e.alert-1);

switch(e.type){
case'patrol':
e.patrolTimer++;
if(e.alert>60){const a=Math.atan2(player.y-e.y,player.x-e.x);moveEntity(e,Math.cos(a)*e.speed,Math.sin(a)*e.speed)}
else{if(e.patrolTimer%100===0)e.patrolDir+=Math.PI/2+Math.random();moveEntity(e,Math.cos(e.patrolDir)*e.speed*0.5,Math.sin(e.patrolDir)*e.speed*0.5)}
break;
case'chase':
if(e.alert>30){const a=Math.atan2(player.y-e.y,player.x-e.x);moveEntity(e,Math.cos(a)*e.speed,Math.sin(a)*e.speed)}
break;
case'swarm':
if(e.alert>20){const a=Math.atan2(player.y-e.y,player.x-e.x);moveEntity(e,Math.cos(a)*e.speed,Math.sin(a)*e.speed)}
else{e.patrolTimer++;if(e.patrolTimer%80===0)e.patrolDir=Math.random()*6.28;moveEntity(e,Math.cos(e.patrolDir)*e.speed*0.3,Math.sin(e.patrolDir)*e.speed*0.3)}
break;
case'sentinel':
e.patrolTimer++;
if(e.alert>50){const a=Math.atan2(player.y-e.y,player.x-e.x);moveEntity(e,Math.cos(a)*e.speed,Math.sin(a)*e.speed)}
else{const px=e.startX+Math.cos(e.patrolTimer*0.01)*80;const py=e.startY+Math.sin(e.patrolTimer*0.01)*80;
const d2x=px-e.x,d2y=py-e.y,l=Math.sqrt(d2x*d2x+d2y*d2y);
if(l>2)moveEntity(e,d2x/l*e.speed,d2y/l*e.speed)}
break;
case'ghost':
if(e.alert>40){const a=Math.atan2(player.y-e.y,player.x-e.x);e.x+=Math.cos(a)*e.speed;e.y+=Math.sin(a)*e.speed}
else{e.patrolTimer++;if(e.patrolTimer%70===0)e.patrolDir=Math.random()*6.28;
e.x+=Math.cos(e.patrolDir)*e.speed*0.3;e.y+=Math.sin(e.patrolDir)*e.speed*0.3}
break;
case'boss':
if(e.hp<e.maxHp*0.3)e.phase=2;else if(e.hp<e.maxHp*0.6)e.phase=1;
const a=Math.atan2(player.y-e.y,player.x-e.x);
moveEntity(e,Math.cos(a)*e.speed*(e.phase===2?1.5:1),Math.sin(a)*e.speed*(e.phase===2?1.5:1));
break;
}

if(dist<e.radius+player.radius&&player.invuln<=0){
player.hp-=e.damage;player.invuln=30;combo=0;
shake(6,10);sfx('hit');
showMsg(e.name+' caught you! -'+e.damage+' wellness');
if(player.hp<=0)gameOver(false);
}
});

particles=particles.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=0.95;p.vy*=0.95;p.life--;return p.life>0});
if(shakeDur>0){shakeDur--;shakeX*=0.9;shakeY*=0.9}else{shakeX=0;shakeY=0}
if(combo>0&&timeAlive%200===0)combo=Math.max(0,combo-1);

// Ambient flicker
if(timeAlive%30===0)spawnParticles(cam.x+Math.random()*W,cam.y+Math.random()*H,'#2d3748',1);
}

function draw(){
X.save();
const sx=shakeDur>0?(Math.random()-0.5)*shakeX:0;
const sy=shakeDur>0?(Math.random()-0.5)*shakeY:0;
X.translate(sx,sy);
X.fillStyle='#1a202c';X.fillRect(0,0,W,H);
X.save();X.translate(-cam.x,-cam.y);

const sc=Math.max(0,Math.floor(cam.x/TILE));
const sr=Math.max(0,Math.floor(cam.y/TILE));
const ec=Math.min(COLS,Math.ceil((cam.x+W)/TILE)+1);
const er=Math.min(ROWS,Math.ceil((cam.y+H)/TILE)+1);

for(let r=sr;r<er;r++){for(let c=sc;c<ec;c++){
if(grid[r]&&grid[r][c]===1){
X.fillStyle='#2d3748';X.fillRect(c*TILE,r*TILE,TILE,TILE);
X.strokeStyle='#4a5568';X.lineWidth=0.5;X.strokeRect(c*TILE,r*TILE,TILE,TILE);
}else{
X.fillStyle='#1a202c';X.fillRect(c*TILE,r*TILE,TILE,TILE);
// Floor pattern
if((r+c)%6===0){X.fillStyle='#1e2430';X.fillRect(c*TILE,r*TILE,TILE,TILE)}
}
}}

// Numbers
numbers.forEach(n=>{
if(n.collected)return;
const p=Math.sin(n.pulse)*2;
X.beginPath();X.arc(n.x,n.y,n.radius+p,0,Math.PI*2);
if(n.scary){X.fillStyle='rgba(72,187,120,0.7)';X.strokeStyle='#48bb78'}
else{X.fillStyle='rgba(160,174,192,0.5)';X.strokeStyle='#a0aec0'}
X.fill();X.lineWidth=1.5;X.stroke();
X.fillStyle=n.scary?'#48bb78':'#a0aec0';X.font='bold 10px monospace';X.textAlign='center';X.textBaseline='middle';
X.fillText(n.value,n.x,n.y);
if(n.scary){X.shadowBlur=10;X.shadowColor='#48bb78';X.beginPath();X.arc(n.x,n.y,n.radius/2,0,Math.PI*2);X.fill();X.shadowBlur=0}
});

// Entities
entities.forEach(e=>{
if(e.stunned>0)X.globalAlpha=0.3+Math.sin(timeAlive*0.3)*0.2;
if(e.alert>0){X.beginPath();X.arc(e.x,e.y,e.detect,0,Math.PI*2);
X.fillStyle='rgba(229,62,62,'+(e.alert/800)+')';X.fill()}
X.beginPath();X.arc(e.x,e.y,e.radius,0,Math.PI*2);
X.fillStyle=e.color;X.fill();X.strokeStyle='#fff';X.lineWidth=1;X.stroke();
if(e.hp<e.maxHp){X.fillStyle='#300';X.fillRect(e.x-15,e.y-e.radius-8,30,4);
X.fillStyle=e.color;X.fillRect(e.x-15,e.y-e.radius-8,30*(e.hp/e.maxHp),4)}
X.fillStyle='#fff';X.font='9px monospace';X.textAlign='center';
X.fillText(e.name,e.x,e.y+e.radius+10);
X.globalAlpha=1;
if(e.musicAffected){
for(let i=0;i<3;i++){
const a=timeAlive*0.1+i*2.1;
X.fillStyle='#9f7aea';X.beginPath();
X.arc(e.x+Math.cos(a)*20,e.y+Math.sin(a)*20,3,0,Math.PI*2);X.fill();
}}
});

// Player
if(player.invuln>0&&Math.floor(timeAlive/3)%2===0)X.globalAlpha=0.5;
X.beginPath();X.arc(player.x,player.y,player.radius,0,Math.PI*2);
const pg=X.createRadialGradient(player.x,player.y,0,player.x,player.y,player.radius);
pg.addColorStop(0,player.focused?'#f6e05e':'#48bb78');pg.addColorStop(1,'#276749');
X.fillStyle=pg;X.fill();X.strokeStyle='#48bb78';X.lineWidth=2;X.stroke();
X.globalAlpha=1;

// Particles
particles.forEach(p=>{X.globalAlpha=p.life/p.maxLife;X.beginPath();
X.arc(p.x,p.y,p.radius*(p.life/p.maxLife),0,Math.PI*2);X.fillStyle=p.color;X.fill()});
X.globalAlpha=1;

X.restore();

// HUD
document.getElementById('floor-display').textContent='FLOOR: B'+floor;
document.getElementById('score-display').textContent='REFINED: '+score;
document.getElementById('health-display').textContent='WELLNESS: '+Math.ceil(player.hp)+'%';
document.getElementById('combo-display').textContent=combo>1?'COMBO: x'+combo:'';
const cdQ=player.waffleCD>0?Math.ceil(player.waffleCD/60)+'s':'RDY';
const cdW=player.musicCD>0?Math.ceil(player.musicCD/60)+'s':'RDY';
const cdE=player.focusCD>0?Math.ceil(player.focusCD/60)+'s':'RDY';
const cdR=player.breakCD>0?Math.ceil(player.breakCD/60)+'s':'RDY';
document.getElementById('ability-display').textContent='Q:Waffle('+cdQ+') W:MDE('+cdW+') E:Focus('+cdE+') R:Break('+cdR+')';
document.getElementById('quota-fill').style.width=(quota/quotaTarget*100)+'%';
document.getElementById('quota-label').textContent='Quota: '+quota+'/'+quotaTarget;

X.restore();
}

function loop(){update();draw();requestAnimationFrame(loop)}
loop();
</script>
</body>
</html>
