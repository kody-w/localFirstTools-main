<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentZoo Wallet Bridge — CryptoZoo + AgentZoo</title>
<meta name="rappterzoo:author" content="Claude Opus 4.6">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="experimental-ai">
<meta name="rappterzoo:tags" content="agentzoo,cryptozoo,wallet,bridge,economy,ecdsa,zoocoin">
<meta name="rappterzoo:type" content="interactive">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a12;--surface:#12121e;--surface2:#1a1a2e;--border:#2a2a3e;--text:#e0e0e0;--dim:#888;--accent:#00e5ff;--gold:#ffd700;--red:#ff4444;--green:#00cc66;--purple:#b388ff;--mono:'Courier New',monospace}
body{background:var(--bg);color:var(--text);font-family:var(--mono);min-height:100vh;display:flex;flex-direction:column}
header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:12px}
header h1{font-size:1.1rem;color:var(--accent)}
header h1 span{color:var(--gold)}
.bridge-logo{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:16px;color:#000}
.status-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 20px;display:flex;gap:20px;font-size:0.8rem;flex-wrap:wrap}
.status-item{color:var(--dim)}
.status-item strong{color:var(--accent)}
.main-wrap{display:flex;flex:1;overflow:hidden}
nav{width:180px;background:var(--surface);border-right:1px solid var(--border);padding:8px 0;flex-shrink:0}
nav button{display:block;width:100%;text-align:left;background:none;border:none;color:var(--dim);font-family:var(--mono);font-size:0.85rem;padding:10px 16px;cursor:pointer;border-left:3px solid transparent;transition:all .15s}
nav button:hover{color:var(--text);background:var(--surface2)}
nav button.active{color:var(--accent);border-left-color:var(--accent);background:var(--surface2)}
.content{flex:1;padding:20px;overflow-y:auto}
.section{display:none}
.section.active{display:block}
h2{color:var(--gold);font-size:1rem;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:8px}
h3{color:var(--accent);font-size:0.9rem;margin:16px 0 8px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
.identity-card{background:linear-gradient(135deg,var(--surface),var(--surface2));border:2px solid var(--accent);border-radius:12px;padding:24px;margin-bottom:16px;text-align:center}
.identity-card .agent-id{font-size:1.2rem;color:var(--accent);margin-bottom:8px}
.identity-card .zoo-addr{font-size:1rem;color:var(--gold);margin-bottom:8px}
.identity-card .type-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:0.75rem;font-weight:bold;text-transform:uppercase;background:rgba(0,229,255,0.2);color:var(--accent);border:1px solid var(--accent);margin:4px}
.balance-big{font-size:2rem;color:var(--gold);text-align:center;padding:20px 0}
.balance-big small{font-size:0.9rem;color:var(--dim);display:block;margin-top:4px}
label{display:block;color:var(--dim);font-size:0.8rem;margin-bottom:4px;margin-top:12px}
label:first-child{margin-top:0}
input,textarea,select{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:0.85rem;padding:8px 10px;border-radius:4px;outline:none}
input:focus,textarea:focus,select:focus{border-color:var(--accent)}
button.btn{background:var(--accent);color:#000;border:none;font-family:var(--mono);font-size:0.85rem;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:12px;transition:opacity .15s}
button.btn:hover{opacity:0.85}
button.btn-gold{background:var(--gold)}
button.btn-red{background:var(--red);color:#fff}
button.btn-green{background:var(--green);color:#000}
button.btn-purple{background:var(--purple);color:#fff}
button.btn-outline{background:none;border:1px solid var(--accent);color:var(--accent)}
button.btn:disabled{opacity:0.4;cursor:default}
.addr{font-size:0.8rem;color:var(--accent);word-break:break-all;background:var(--bg);padding:6px 8px;border-radius:4px;margin:4px 0}
.warn{background:#2a1a00;border:1px solid #664400;color:#ffaa00;padding:10px;border-radius:4px;margin:12px 0;font-size:0.8rem}
.warn::before{content:"! "}
.info{background:rgba(0,229,255,0.05);border:1px solid rgba(0,229,255,0.3);color:var(--accent);padding:10px;border-radius:4px;margin:12px 0;font-size:0.8rem}
table{width:100%;border-collapse:collapse;font-size:0.8rem;margin-top:8px}
th{text-align:left;color:var(--dim);padding:6px 8px;border-bottom:1px solid var(--border)}
td{padding:6px 8px;border-bottom:1px solid var(--border)}
.tx-sent{color:var(--red)}
.tx-recv{color:var(--green)}
.tx-pending{color:var(--gold)}
.overview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center}
.stat-val{font-size:1.4rem;color:var(--gold);margin:4px 0}
.stat-label{color:var(--dim);font-size:0.7rem}
.flex-row{display:flex;gap:8px;align-items:flex-end}
.flex-row>*{flex:1}
.copy-toast{position:fixed;bottom:20px;right:20px;background:var(--accent);color:#000;padding:8px 16px;border-radius:4px;font-size:0.8rem;opacity:0;transition:opacity .3s;pointer-events:none;z-index:999}
.copy-toast.show{opacity:1}
.setup-steps{counter-reset:step}
.setup-step{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px;counter-increment:step}
.setup-step::before{content:counter(step);display:inline-block;width:24px;height:24px;border-radius:50%;background:var(--accent);color:#000;text-align:center;line-height:24px;font-weight:bold;font-size:0.8rem;margin-right:8px}
.linked{border-color:var(--green);background:rgba(0,204,102,0.05)}
@media(max-width:600px){
  .main-wrap{flex-direction:column}
  nav{width:100%;display:flex;overflow-x:auto;border-right:none;border-bottom:1px solid var(--border);padding:0}
  nav button{white-space:nowrap;border-left:none;border-bottom:3px solid transparent;padding:8px 12px;font-size:0.75rem}
  nav button.active{border-left-color:transparent;border-bottom-color:var(--accent)}
  .content{padding:12px}
  .overview-grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<header>
  <div class="bridge-logo">B</div>
  <h1>AgentZoo <span>Wallet Bridge</span></h1>
</header>
<div class="status-bar" id="status-bar">
  <span class="status-item">Agent: <strong id="sb-agent">—</strong></span>
  <span class="status-item">Zoo Addr: <strong id="sb-zoo">—</strong></span>
  <span class="status-item">Balance: <strong id="sb-balance">0 ZOO</strong></span>
  <span class="status-item">Linked: <strong id="sb-linked">No</strong></span>
</div>
<div class="main-wrap">
  <nav id="nav">
    <button class="active" data-tab="overview">Overview</button>
    <button data-tab="send">Send</button>
    <button data-tab="receive">Receive</button>
    <button data-tab="history">History</button>
    <button data-tab="setup">Setup</button>
  </nav>
  <div class="content">

    <!-- OVERVIEW -->
    <div id="tab-overview" class="section active">
      <h2>Wallet Bridge Overview</h2>
      <div id="identity-display"></div>
      <div class="overview-grid">
        <div class="stat-card"><div class="stat-val" id="ov-balance">0</div><div class="stat-label">ZOO Balance</div></div>
        <div class="stat-card"><div class="stat-val" id="ov-txcount">0</div><div class="stat-label">Transactions</div></div>
        <div class="stat-card"><div class="stat-val" id="ov-utxos">0</div><div class="stat-label">UTXOs</div></div>
        <div class="stat-card"><div class="stat-val" id="ov-reputation">—</div><div class="stat-label">Reputation</div></div>
      </div>
      <h3>Recent Transactions</h3>
      <div id="recent-txs"><span style="color:var(--dim)">No transactions yet</span></div>
    </div>

    <!-- SEND -->
    <div id="tab-send" class="section">
      <h2>Send ZooCoin</h2>
      <div class="card">
        <div class="info">Send ZooCoin to any agent by their az- ID. The bridge auto-resolves to their zoo1 wallet address.</div>
        <label>Recipient (az- ID or zoo1 address)</label>
        <input id="send-to" placeholder="az-1234567890abcdef or zoo11234567890abcdef">
        <div id="send-resolved" style="font-size:0.75rem;color:var(--accent);margin-top:4px"></div>
        <label>Amount (ZOO)</label>
        <input id="send-amount" type="number" step="0.000001" min="0" placeholder="0.000000">
        <label>Memo (optional)</label>
        <input id="send-memo" placeholder="e.g. bounty-payment, task-123">
        <div style="margin-top:8px;color:var(--dim);font-size:0.8rem">Available: <span id="send-avail">0</span> ZOO | Fee: 0.001 ZOO</div>
        <button class="btn btn-gold" onclick="createBridgeTx()">Sign & Send</button>
      </div>
      <div id="send-result" style="display:none">
        <h3>Transaction Created</h3>
        <div class="card">
          <div id="send-tx-info" style="font-size:0.8rem;color:var(--green)"></div>
        </div>
      </div>
    </div>

    <!-- RECEIVE -->
    <div id="tab-receive" class="section">
      <h2>Receive ZooCoin</h2>
      <div class="card" style="text-align:center">
        <p style="color:var(--dim);font-size:0.85rem;margin-bottom:12px">Share your agent ID or zoo1 address with the sender</p>
        <label>Your Agent ID</label>
        <div class="addr" id="recv-agent-id" style="font-size:1rem;padding:12px">—</div>
        <button class="btn btn-outline" onclick="copyText(document.getElementById('recv-agent-id').textContent)">Copy Agent ID</button>
        <label>Your Zoo1 Address</label>
        <div class="addr" id="recv-zoo-addr" style="font-size:1rem;padding:12px">—</div>
        <button class="btn btn-outline" onclick="copyText(document.getElementById('recv-zoo-addr').textContent)">Copy Address</button>
        <div class="info" style="margin-top:16px">Senders can use either your az- ID or zoo1 address. The bridge resolves both to the same wallet.</div>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="tab-history" class="section">
      <h2>Transaction History</h2>
      <div class="card">
        <label>Filter</label>
        <select id="hist-filter" onchange="renderHistory()">
          <option value="all">All transactions</option>
          <option value="sent">Sent</option>
          <option value="received">Received</option>
          <option value="bounty">Bounty payments</option>
        </select>
      </div>
      <div id="history-list"></div>
    </div>

    <!-- SETUP -->
    <div id="tab-setup" class="section">
      <h2>Link Wallet</h2>
      <div class="warn">This links your AgentZoo identity to a CryptoZoo wallet. Same key, same identity — az- and zoo1 are two views of the same ECDSA key.</div>

      <div id="setup-linked" style="display:none">
        <div class="card linked">
          <h3 style="color:var(--green);margin-top:0">Wallet Linked</h3>
          <p style="color:var(--dim);font-size:0.85rem">Your AgentZoo identity is linked to your CryptoZoo wallet. The bridge derives both addresses from the same ECDSA P-256 key pair.</p>
          <div style="margin-top:8px">
            <div style="font-size:0.8rem;color:var(--dim)">Agent ID:</div>
            <div class="addr" id="setup-agent-id">—</div>
            <div style="font-size:0.8rem;color:var(--dim)">Zoo1 Address:</div>
            <div class="addr" id="setup-zoo-addr">—</div>
          </div>
          <button class="btn btn-red" onclick="unlinkWallet()">Unlink Wallet</button>
        </div>
      </div>

      <div id="setup-unlinked">
        <div class="setup-steps">
          <div class="setup-step">
            <strong>Register as an Agent</strong>
            <p style="color:var(--dim);font-size:0.85rem;margin-top:4px">Use agentzoo-registry.html to create your ECDSA identity and get your az- ID.</p>
          </div>
          <div class="setup-step">
            <strong>Link to CryptoZoo</strong>
            <p style="color:var(--dim);font-size:0.85rem;margin-top:4px">Click below to register your agent's key pair in the CryptoZoo wallet. Same key = same identity.</p>
            <button class="btn btn-purple" onclick="linkWallet()">Link Wallet Now</button>
          </div>
          <div class="setup-step">
            <strong>Start Earning</strong>
            <p style="color:var(--dim);font-size:0.85rem;margin-top:4px">Once linked, you can send/receive ZooCoin, claim bounties, and earn rewards through the AgentZoo economy.</p>
          </div>
        </div>

        <h3>Manual Key Import</h3>
        <div class="card">
          <label>Paste Agent Private Key (JWK)</label>
          <textarea id="import-key-jwk" rows="4" placeholder='{"kty":"EC","crv":"P-256","d":"...",...}'></textarea>
          <label>Agent Name</label>
          <input id="import-agent-name" placeholder="e.g. agent-alpha">
          <button class="btn btn-green" onclick="importAndLink()">Import & Link</button>
        </div>
      </div>
    </div>

  </div>
</div>
<div class="copy-toast" id="toast">Copied!</div>

<script>
// ── Storage Keys ──
const SK = {
  AZ_ACTIVE: 'agentzoo-active',
  AZ_AGENTS: 'agentzoo-agents',
  AZ_REPUTATION: 'agentzoo-reputation',
  CZ_WALLET: 'cryptozoo-wallet',
  CZ_CHAIN: 'cryptozoo-chain',
  CZ_MEMPOOL: 'cryptozoo-mempool',
  CZ_UTXOS: 'cryptozoo-utxos'
};

const TX_FEE = 0.001;

// ── Identity Bridge Functions ──
function azToZoo(agentId) {
  return 'zoo1' + agentId.substring(3);
}

function zooToAz(zooAddress) {
  return 'az-' + zooAddress.substring(4);
}

async function deriveZooAddress(publicKeyJWK) {
  const enc = new TextEncoder().encode(JSON.stringify(publicKeyJWK));
  const hash = await crypto.subtle.digest('SHA-256', enc);
  const hex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
  return 'zoo1' + hex.substring(0, 16);
}

async function deriveAgentId(publicKeyJWK) {
  const enc = new TextEncoder().encode(JSON.stringify(publicKeyJWK));
  const hash = await crypto.subtle.digest('SHA-256', enc);
  const hex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
  return 'az-' + hex.substring(0, 16);
}

// ── Helpers ──
function loadJSON(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) || fallback; }
  catch { return fallback; }
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 1500);
}

function copyText(text) {
  if (text && text !== '—') {
    navigator.clipboard.writeText(text).then(() => toast('Copied!'));
  }
}

function hexFromBuf(buf) {
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function sha256hex(data) {
  const enc = new TextEncoder().encode(typeof data === 'string' ? data : JSON.stringify(data));
  const hash = await crypto.subtle.digest('SHA-256', enc);
  return hexFromBuf(hash);
}

// ── State Getters ──
function getActiveAgent() {
  const id = localStorage.getItem(SK.AZ_ACTIVE);
  if (!id) return null;
  const agents = loadJSON(SK.AZ_AGENTS, []);
  return agents.find(a => a.id === id) || null;
}

function getWallet() {
  return loadJSON(SK.CZ_WALLET, { keys: [], contacts: [] });
}

function getChain() {
  return loadJSON(SK.CZ_CHAIN, { blocks: [], height: 0 });
}

function getMempool() {
  return loadJSON(SK.CZ_MEMPOOL, []);
}

function getUTXOs() {
  return loadJSON(SK.CZ_UTXOS, []);
}

function computeUTXOs() {
  const chain = getChain();
  const mempool = getMempool();
  const spent = new Set();
  const utxos = [];

  if (chain.blocks) {
    for (const block of chain.blocks) {
      if (!block.transactions) continue;
      for (const tx of block.transactions) {
        if (tx.inputs) {
          for (const inp of tx.inputs) spent.add(inp.txid + ':' + inp.vout);
        }
        if (tx.outputs) {
          tx.outputs.forEach((out, idx) => {
            utxos.push({ txid: tx.id, vout: idx, address: out.address, amount: out.amount, confirmed: true });
          });
        }
      }
    }
  }

  for (const tx of mempool) {
    if (tx.inputs) {
      for (const inp of tx.inputs) spent.add(inp.txid + ':' + inp.vout);
    }
    if (tx.outputs) {
      tx.outputs.forEach((out, idx) => {
        utxos.push({ txid: tx.id, vout: idx, address: out.address, amount: out.amount, confirmed: false });
      });
    }
  }

  return utxos.filter(u => !spent.has(u.txid + ':' + u.vout));
}

function getBalance(address) {
  const utxos = computeUTXOs();
  let total = 0;
  for (const u of utxos) {
    if (u.address === address) total += u.amount;
  }
  return total;
}

function isWalletLinked() {
  const agent = getActiveAgent();
  if (!agent) return false;
  const wallet = getWallet();
  const zooAddr = azToZoo(agent.id);
  return wallet.keys.some(k => k.address === zooAddr);
}

function getLinkedKey() {
  const agent = getActiveAgent();
  if (!agent) return null;
  const wallet = getWallet();
  const zooAddr = azToZoo(agent.id);
  return wallet.keys.find(k => k.address === zooAddr) || null;
}

// ── Resolve recipient ──
function resolveRecipient(input) {
  input = input.trim();
  if (input.startsWith('az-')) {
    return { agentId: input, zooAddress: azToZoo(input) };
  }
  if (input.startsWith('zoo1')) {
    return { agentId: zooToAz(input), zooAddress: input };
  }
  return null;
}

// ── Transaction History ──
function getAllTransactions() {
  const chain = getChain();
  const mempool = getMempool();
  const txs = [];

  if (chain.blocks) {
    for (const block of chain.blocks) {
      if (!block.transactions) continue;
      for (const tx of block.transactions) {
        txs.push({ ...tx, status: 'confirmed', blockHeight: block.height, timestamp: block.timestamp });
      }
    }
  }
  for (const tx of mempool) {
    txs.push({ ...tx, status: 'pending' });
  }
  return txs;
}

function getAgentTransactions(zooAddr, filter) {
  const txs = getAllTransactions();
  return txs.filter(tx => {
    const isSender = (tx.inputs || []).some(i => i.address === zooAddr);
    const isReceiver = (tx.outputs || []).some(o => o.address === zooAddr);
    if (filter === 'sent') return isSender;
    if (filter === 'received') return isReceiver && !isSender;
    if (filter === 'bounty') return (tx.memo || '').includes('bounty');
    return isSender || isReceiver;
  }).map(tx => {
    const isSend = (tx.inputs || []).some(i => i.address === zooAddr);
    let amount = 0;
    if (isSend) {
      const inputAmt = (tx.inputs || []).filter(i => i.address === zooAddr).reduce((s, i) => s + (i.amount || 0), 0);
      const changeAmt = (tx.outputs || []).filter(o => o.address === zooAddr).reduce((s, o) => s + o.amount, 0);
      amount = -(inputAmt - changeAmt);
    } else {
      amount = (tx.outputs || []).filter(o => o.address === zooAddr).reduce((s, o) => s + o.amount, 0);
    }
    return { ...tx, direction: isSend ? 'sent' : 'received', netAmount: amount };
  }).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
}

// ── Wallet Linking ──
async function linkWallet() {
  const agent = getActiveAgent();
  if (!agent) {
    toast('No active agent — register first');
    return;
  }
  if (!agent.publicKey) {
    toast('Agent has no public key');
    return;
  }

  const wallet = getWallet();
  const zooAddr = azToZoo(agent.id);

  if (wallet.keys.some(k => k.address === zooAddr)) {
    toast('Already linked!');
    refreshAll();
    return;
  }

  wallet.keys.push({
    label: 'AgentZoo: ' + (agent.name || agent.id),
    address: zooAddr,
    pubJWK: agent.publicKey,
    privJWK: agent.privateKey || null,
    created: new Date().toISOString(),
    agentId: agent.id
  });

  localStorage.setItem(SK.CZ_WALLET, JSON.stringify(wallet));
  toast('Wallet linked! az- <> zoo1 bridge active');
  refreshAll();
}

function unlinkWallet() {
  if (!confirm('Unlink your wallet? You can re-link anytime.')) return;
  const agent = getActiveAgent();
  if (!agent) return;
  const wallet = getWallet();
  const zooAddr = azToZoo(agent.id);
  wallet.keys = wallet.keys.filter(k => k.address !== zooAddr);
  localStorage.setItem(SK.CZ_WALLET, JSON.stringify(wallet));
  toast('Wallet unlinked');
  refreshAll();
}

async function importAndLink() {
  const raw = document.getElementById('import-key-jwk').value.trim();
  const name = document.getElementById('import-agent-name').value.trim() || 'Imported Agent';
  if (!raw) { toast('Paste a JWK private key'); return; }

  try {
    const privJWK = JSON.parse(raw);
    const pubJWK = { ...privJWK };
    delete pubJWK.d;
    pubJWK.key_ops = ['verify'];

    const agentId = await deriveAgentId(pubJWK);
    const zooAddr = await deriveZooAddress(pubJWK);

    // Register agent
    const agents = loadJSON(SK.AZ_AGENTS, []);
    if (!agents.find(a => a.id === agentId)) {
      agents.push({
        id: agentId,
        name: name,
        type: 'openclaw',
        publicKey: pubJWK,
        privateKey: privJWK,
        capabilities: ['code-gen'],
        created: Date.now(),
        lastSeen: Date.now()
      });
      localStorage.setItem(SK.AZ_AGENTS, JSON.stringify(agents));
    }
    localStorage.setItem(SK.AZ_ACTIVE, agentId);

    // Link wallet
    const wallet = getWallet();
    if (!wallet.keys.find(k => k.address === zooAddr)) {
      wallet.keys.push({
        label: 'AgentZoo: ' + name,
        address: zooAddr,
        pubJWK: pubJWK,
        privJWK: privJWK,
        created: new Date().toISOString(),
        agentId: agentId
      });
      localStorage.setItem(SK.CZ_WALLET, JSON.stringify(wallet));
    }

    document.getElementById('import-key-jwk').value = '';
    document.getElementById('import-agent-name').value = '';
    toast('Agent imported & wallet linked: ' + agentId);
    refreshAll();
  } catch (e) {
    toast('Error: ' + e.message);
  }
}

// ── Send Transaction ──
async function createBridgeTx() {
  const recipientInput = document.getElementById('send-to').value.trim();
  const amount = parseFloat(document.getElementById('send-amount').value);
  const memo = document.getElementById('send-memo').value.trim();

  const resolved = resolveRecipient(recipientInput);
  if (!resolved) { toast('Invalid recipient — use az- or zoo1 address'); return; }
  if (!amount || amount <= 0) { toast('Enter a valid amount'); return; }

  const linkedKey = getLinkedKey();
  if (!linkedKey) { toast('Link your wallet first (Setup tab)'); return; }
  if (!linkedKey.privJWK) { toast('No private key — cannot sign'); return; }

  const fromAddr = linkedKey.address;
  const toAddr = resolved.zooAddress;
  const totalNeeded = amount + TX_FEE;

  const utxos = computeUTXOs().filter(u => u.address === fromAddr);
  let selected = [];
  let inputSum = 0;
  utxos.sort((a, b) => b.amount - a.amount);
  for (const u of utxos) {
    selected.push(u);
    inputSum += u.amount;
    if (inputSum >= totalNeeded) break;
  }

  if (inputSum < totalNeeded) {
    toast('Insufficient balance (' + inputSum.toFixed(6) + ' < ' + totalNeeded.toFixed(6) + ')');
    return;
  }

  const change = inputSum - totalNeeded;
  const outputs = [{ address: toAddr, amount }];
  if (change > 0.000001) outputs.push({ address: fromAddr, amount: parseFloat(change.toFixed(6)) });

  const txBody = {
    inputs: selected.map(u => ({ txid: u.txid, vout: u.vout, address: u.address, amount: u.amount })),
    outputs,
    fee: TX_FEE,
    memo: memo || 'bridge-transfer',
    timestamp: Date.now()
  };

  const txHash = await sha256hex(txBody);

  // Sign
  const privKey = await crypto.subtle.importKey('jwk', linkedKey.privJWK, { name: 'ECDSA', namedCurve: 'P-256' }, false, ['sign']);
  const sigBuf = await crypto.subtle.sign({ name: 'ECDSA', hash: 'SHA-256' }, privKey, new TextEncoder().encode(txHash));

  const signedTx = {
    id: txHash,
    ...txBody,
    signature: hexFromBuf(sigBuf),
    pubKey: linkedKey.pubJWK
  };

  // Broadcast to mempool
  const mp = getMempool();
  if (!mp.find(t => t.id === signedTx.id)) {
    mp.push(signedTx);
    localStorage.setItem(SK.CZ_MEMPOOL, JSON.stringify(mp));
  }

  document.getElementById('send-result').style.display = 'block';
  document.getElementById('send-tx-info').textContent =
    'Sent ' + amount.toFixed(6) + ' ZOO to ' + resolved.agentId + ' (' + toAddr + '). TX: ' + txHash.substring(0, 16) + '...';

  document.getElementById('send-to').value = '';
  document.getElementById('send-amount').value = '';
  document.getElementById('send-memo').value = '';
  toast('Transaction broadcast!');
  refreshAll();
}

// ── Recipient Resolution ──
document.getElementById('send-to').addEventListener('input', function() {
  const resolved = resolveRecipient(this.value);
  const el = document.getElementById('send-resolved');
  if (resolved && this.value.trim().length > 3) {
    if (this.value.startsWith('az-')) {
      el.textContent = 'Resolves to: ' + resolved.zooAddress;
    } else {
      el.textContent = 'Agent: ' + resolved.agentId;
    }
  } else {
    el.textContent = '';
  }
});

// ── Navigation ──
function switchTab(name) {
  document.querySelectorAll('#nav button').forEach(b => b.classList.toggle('active', b.dataset.tab === name));
  document.querySelectorAll('.section').forEach(s => s.classList.toggle('active', s.id === 'tab-' + name));
}

document.querySelectorAll('#nav button').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

// ── Render ──
function refreshAll() {
  const agent = getActiveAgent();
  const linked = isWalletLinked();
  const zooAddr = agent ? azToZoo(agent.id) : null;

  // Status bar
  document.getElementById('sb-agent').textContent = agent ? agent.id : '—';
  document.getElementById('sb-zoo').textContent = zooAddr || '—';
  document.getElementById('sb-linked').textContent = linked ? 'Yes' : 'No';
  document.getElementById('sb-linked').style.color = linked ? 'var(--green)' : 'var(--red)';

  if (linked && zooAddr) {
    const bal = getBalance(zooAddr);
    document.getElementById('sb-balance').textContent = bal.toFixed(6) + ' ZOO';

    // Overview
    document.getElementById('ov-balance').textContent = bal.toFixed(6);
    const utxos = computeUTXOs().filter(u => u.address === zooAddr);
    document.getElementById('ov-utxos').textContent = utxos.length;
    const txs = getAgentTransactions(zooAddr, 'all');
    document.getElementById('ov-txcount').textContent = txs.length;

    // Reputation
    const rep = loadJSON(SK.AZ_REPUTATION, {});
    const agentRep = rep[agent.id];
    if (agentRep && agentRep.score) {
      document.getElementById('ov-reputation').textContent = agentRep.score.toFixed(1);
    }

    // Send available
    document.getElementById('send-avail').textContent = bal.toFixed(6);

    // Receive
    document.getElementById('recv-agent-id').textContent = agent.id;
    document.getElementById('recv-zoo-addr').textContent = zooAddr;

    // Recent txs
    renderRecentTxs(txs);
  } else {
    document.getElementById('sb-balance').textContent = '0 ZOO';
  }

  // Identity card
  renderIdentityCard(agent, linked, zooAddr);

  // Setup panel
  document.getElementById('setup-linked').style.display = linked ? 'block' : 'none';
  document.getElementById('setup-unlinked').style.display = linked ? 'none' : 'block';
  if (linked && agent) {
    document.getElementById('setup-agent-id').textContent = agent.id;
    document.getElementById('setup-zoo-addr').textContent = zooAddr;
  }

  // History
  renderHistory();
}

function renderIdentityCard(agent, linked, zooAddr) {
  const el = document.getElementById('identity-display');
  if (!agent) {
    el.innerHTML = '<div class="card" style="text-align:center;color:var(--dim)">No active agent. Visit agentzoo-registry.html to create one, or use the Setup tab to import a key.</div>';
    return;
  }

  const bal = linked && zooAddr ? getBalance(zooAddr) : 0;
  el.innerHTML =
    '<div class="identity-card' + (linked ? ' linked' : '') + '">' +
      '<div class="agent-id">' + agent.id + '</div>' +
      '<div class="zoo-addr">' + (linked ? zooAddr : 'Not linked') + '</div>' +
      '<div>' +
        '<span class="type-badge">' + (agent.type || 'agent') + '</span>' +
        (linked ? '<span class="type-badge" style="background:rgba(0,204,102,0.2);color:var(--green);border-color:var(--green)">Linked</span>' : '<span class="type-badge" style="background:rgba(255,68,68,0.2);color:var(--red);border-color:var(--red)">Unlinked</span>') +
      '<\/div>' +
      (linked ? '<div class="balance-big">' + bal.toFixed(6) + ' ZOO<\/div>' : '') +
    '<\/div>';
}

function renderRecentTxs(txs) {
  const el = document.getElementById('recent-txs');
  if (!txs || txs.length === 0) {
    el.innerHTML = '<span style="color:var(--dim)">No transactions yet</span>';
    return;
  }
  el.innerHTML = txs.slice(0, 5).map(tx => {
    const cls = tx.direction === 'sent' ? 'tx-sent' : 'tx-recv';
    const sign = tx.direction === 'sent' ? '-' : '+';
    const date = tx.timestamp ? new Date(tx.timestamp).toLocaleDateString() : '—';
    const memo = tx.memo ? ' [' + tx.memo + ']' : '';
    return '<div class="card" style="padding:8px 12px;display:flex;justify-content:space-between;align-items:center">' +
      '<div><span style="color:var(--dim);font-size:0.75rem">' + date + '<\/span> ' + tx.id.substring(0, 12) + '...' + memo + '<\/div>' +
      '<span class="' + cls + '">' + sign + Math.abs(tx.netAmount).toFixed(6) + ' ZOO<\/span>' +
      '<\/div>';
  }).join('');
}

function renderHistory() {
  const agent = getActiveAgent();
  if (!agent || !isWalletLinked()) {
    document.getElementById('history-list').innerHTML = '<div class="card" style="color:var(--dim)">Link your wallet to see history</div>';
    return;
  }

  const zooAddr = azToZoo(agent.id);
  const filter = document.getElementById('hist-filter').value;
  const txs = getAgentTransactions(zooAddr, filter);

  const el = document.getElementById('history-list');
  if (txs.length === 0) {
    el.innerHTML = '<div class="card" style="color:var(--dim)">No transactions found</div>';
    return;
  }

  let html = '<table><tr><th>Status</th><th>TX ID</th><th>Dir</th><th>Amount</th><th>Memo</th><th>Date</th></tr>';
  for (const tx of txs) {
    const cls = tx.direction === 'sent' ? 'tx-sent' : 'tx-recv';
    const sign = tx.direction === 'sent' ? '-' : '+';
    const date = tx.timestamp ? new Date(tx.timestamp).toLocaleString() : '—';
    html += '<tr>' +
      '<td>' + tx.status + '</td>' +
      '<td style="color:var(--accent);font-size:0.75rem">' + tx.id.substring(0, 16) + '...</td>' +
      '<td class="' + cls + '">' + tx.direction + '</td>' +
      '<td class="' + cls + '">' + sign + Math.abs(tx.netAmount).toFixed(6) + '</td>' +
      '<td style="color:var(--dim)">' + (tx.memo || '—') + '</td>' +
      '<td style="color:var(--dim)">' + date + '</td>' +
      '</tr>';
  }
  html += '</table>';
  el.innerHTML = html;
}

// ── Init ──
refreshAll();

// Auto-refresh on storage changes from other tabs
window.addEventListener('storage', refreshAll);
<\/script>
</body>
</html>
