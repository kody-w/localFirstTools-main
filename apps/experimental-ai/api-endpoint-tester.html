<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Endpoint Tester</title>
    <meta name="description" content="Lightweight Postman alternative for testing REST APIs. Save collections, manage headers, view formatted responses. All data stored locally.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #21262d 100%);
            min-height: 100vh;
            color: #c9d1d9;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h1 {
            font-size: 1.1rem;
            background: linear-gradient(135deg, #58a6ff, #3fb950);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .collections-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .collection-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .collection-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .collection-item.active {
            background: rgba(88,166,255,0.15);
            color: #58a6ff;
        }

        .collection-header {
            font-weight: 600;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-list {
            padding-left: 20px;
        }

        .method-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .method-GET { background: rgba(63,185,80,0.2); color: #3fb950; }
        .method-POST { background: rgba(255,193,7,0.2); color: #f0ad4e; }
        .method-PUT { background: rgba(88,166,255,0.2); color: #58a6ff; }
        .method-PATCH { background: rgba(163,113,247,0.2); color: #a371f7; }
        .method-DELETE { background: rgba(248,81,73,0.2); color: #f85149; }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .request-bar {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 10px;
        }

        .method-select {
            width: 100px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .url-input {
            flex: 1;
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .url-input:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-send {
            background: linear-gradient(135deg, #238636, #2ea043);
            color: white;
        }

        .btn-send:hover {
            background: linear-gradient(135deg, #2ea043, #3fb950);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .request-config {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .config-tabs {
            display: flex;
            padding: 0 20px;
            gap: 5px;
        }

        .config-tab {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: rgba(255,255,255,0.6);
            font-size: 0.85rem;
        }

        .config-tab:hover {
            color: white;
        }

        .config-tab.active {
            color: #58a6ff;
            border-bottom-color: #58a6ff;
        }

        .config-content {
            flex: 1;
            display: none;
            padding: 15px 20px;
            overflow-y: auto;
            max-height: 200px;
        }

        .config-content.active {
            display: block;
        }

        .key-value-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .key-value-row input {
            flex: 1;
            padding: 8px 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px;
            color: white;
            font-family: inherit;
            font-size: 0.85rem;
        }

        .key-value-row input:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .key-value-row input::placeholder {
            color: rgba(255,255,255,0.3);
        }

        .remove-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            padding: 5px;
            font-size: 1rem;
        }

        .remove-btn:hover {
            color: #f85149;
        }

        .body-editor {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            color: #e6db74;
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
        }

        .body-editor:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .response-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .response-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .response-meta {
            display: flex;
            gap: 20px;
        }

        .response-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .status-2xx { background: rgba(63,185,80,0.2); color: #3fb950; }
        .status-3xx { background: rgba(88,166,255,0.2); color: #58a6ff; }
        .status-4xx { background: rgba(255,193,7,0.2); color: #f0ad4e; }
        .status-5xx { background: rgba(248,81,73,0.2); color: #f85149; }

        .response-time {
            color: rgba(255,255,255,0.5);
            font-size: 0.85rem;
        }

        .response-tabs {
            display: flex;
            gap: 5px;
            padding: 0 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .response-tab {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: rgba(255,255,255,0.6);
            font-size: 0.8rem;
        }

        .response-tab:hover {
            color: white;
        }

        .response-tab.active {
            color: #58a6ff;
            border-bottom-color: #58a6ff;
        }

        .response-body {
            flex: 1;
            overflow: auto;
            padding: 15px 20px;
        }

        .response-content {
            display: none;
        }

        .response-content.active {
            display: block;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .json-key { color: #79c0ff; }
        .json-string { color: #a5d6ff; }
        .json-number { color: #a5d6ff; }
        .json-boolean { color: #ff7b72; }
        .json-null { color: #ff7b72; }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255,255,255,0.4);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #21262d;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal h3 {
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            font-family: inherit;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .sidebar-actions {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 8px;
        }

        .sidebar-actions button {
            flex: 1;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .headers-table {
            width: 100%;
            font-size: 0.8rem;
        }

        .headers-table td {
            padding: 4px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .headers-table td:first-child {
            color: #58a6ff;
            width: 40%;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>API Tester</h1>
                <button class="btn btn-secondary btn-small" onclick="newRequest()">+ New</button>
            </div>

            <div class="collections-list" id="collectionsList"></div>

            <div class="sidebar-actions">
                <button class="btn btn-secondary btn-small" onclick="exportData()">Export</button>
                <button class="btn btn-secondary btn-small" onclick="document.getElementById('importFile').click()">Import</button>
                <input type="file" id="importFile" accept=".json" style="display: none" onchange="importData(event)">
            </div>
        </div>

        <div class="main-content">
            <div class="request-bar">
                <select class="method-select" id="methodSelect">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="DELETE">DELETE</option>
                    <option value="HEAD">HEAD</option>
                    <option value="OPTIONS">OPTIONS</option>
                </select>
                <input type="text" class="url-input" id="urlInput" placeholder="Enter request URL...">
                <button class="btn btn-send" id="sendBtn" onclick="sendRequest()">Send</button>
                <button class="btn btn-secondary" onclick="saveRequest()">Save</button>
            </div>

            <div class="request-config">
                <div class="config-tabs">
                    <div class="config-tab active" data-tab="params">Params</div>
                    <div class="config-tab" data-tab="headers">Headers</div>
                    <div class="config-tab" data-tab="body">Body</div>
                    <div class="config-tab" data-tab="auth">Auth</div>
                </div>
            </div>

            <div class="config-content active" id="paramsContent">
                <div id="paramsList"></div>
                <button class="btn btn-secondary btn-small" onclick="addParam()">+ Add Parameter</button>
            </div>

            <div class="config-content" id="headersContent">
                <div id="headersList"></div>
                <button class="btn btn-secondary btn-small" onclick="addHeader()">+ Add Header</button>
            </div>

            <div class="config-content" id="bodyContent">
                <textarea class="body-editor" id="bodyEditor" placeholder='{"key": "value"}'></textarea>
            </div>

            <div class="config-content" id="authContent">
                <div class="form-group">
                    <label>Authorization Type</label>
                    <select class="method-select" id="authType" style="width: 100%;" onchange="updateAuthUI()">
                        <option value="none">No Auth</option>
                        <option value="bearer">Bearer Token</option>
                        <option value="basic">Basic Auth</option>
                        <option value="api-key">API Key</option>
                    </select>
                </div>
                <div id="authFields"></div>
            </div>

            <div class="response-area">
                <div class="response-header">
                    <span>Response</span>
                    <div class="response-meta" id="responseMeta" style="display: none;">
                        <span class="response-status" id="responseStatus">200 OK</span>
                        <span class="response-time" id="responseTime">0ms</span>
                        <span class="response-time" id="responseSize">0 B</span>
                    </div>
                </div>

                <div class="response-tabs">
                    <div class="response-tab active" data-tab="responseBody">Body</div>
                    <div class="response-tab" data-tab="responseHeaders">Headers</div>
                </div>

                <div class="response-body">
                    <div class="response-content active" id="responseBodyContent">
                        <div class="empty-state" id="emptyResponse">
                            <div class="empty-state-icon">üöÄ</div>
                            <p>Send a request to see the response</p>
                        </div>
                        <pre id="responseBodyPre" style="display: none;"></pre>
                    </div>
                    <div class="response-content" id="responseHeadersContent">
                        <table class="headers-table" id="responseHeadersTable"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Request Modal -->
    <div class="modal-overlay" id="saveModal">
        <div class="modal">
            <h3>Save Request</h3>
            <form id="saveForm" onsubmit="saveRequestSubmit(event)">
                <div class="form-group">
                    <label>Request Name</label>
                    <input type="text" id="requestName" required placeholder="e.g., Get Users">
                </div>
                <div class="form-group">
                    <label>Collection</label>
                    <select id="collectionSelect" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                        <option value="">Default Collection</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Or create new collection</label>
                    <input type="text" id="newCollection" placeholder="New collection name">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('saveModal')">Cancel</button>
                    <button type="submit" class="btn btn-send">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data store
        let data = {
            collections: {},
            requests: [],
            history: []
        };

        let currentRequestId = null;

        // Default headers
        const defaultHeaders = [
            { key: 'Content-Type', value: 'application/json', enabled: true }
        ];

        let params = [];
        let headers = [...defaultHeaders];

        // Initialize
        function init() {
            loadData();
            setupEventListeners();
            renderCollections();
            addParam();
            renderParams();
            renderHeaders();
            updateAuthUI();
        }

        function loadData() {
            const saved = localStorage.getItem('apiTester');
            if (saved) {
                data = JSON.parse(saved);
            }
        }

        function saveData() {
            localStorage.setItem('apiTester', JSON.stringify(data));
        }

        function setupEventListeners() {
            // Config tabs
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.config-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.config-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + 'Content').classList.add('active');
                });
            });

            // Response tabs
            document.querySelectorAll('.response-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.response-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.response-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + 'Content').classList.add('active');
                });
            });

            // URL input enter key
            document.getElementById('urlInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') sendRequest();
            });

            // Modal close
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal.id);
                });
            });
        }

        function renderCollections() {
            const list = document.getElementById('collectionsList');
            const collectionSelect = document.getElementById('collectionSelect');

            // Group requests by collection
            const grouped = {};
            data.requests.forEach(req => {
                const col = req.collection || 'Default';
                if (!grouped[col]) grouped[col] = [];
                grouped[col].push(req);
            });

            let html = '';
            let selectHtml = '<option value="">Default Collection</option>';

            Object.keys(grouped).sort().forEach(collection => {
                selectHtml += `<option value="${collection}">${collection}</option>`;
                html += `
                    <div class="collection-header">
                        <span>üìÅ ${collection}</span>
                        <button class="remove-btn" onclick="deleteCollection('${collection}')" title="Delete collection">√ó</button>
                    </div>
                    <div class="request-list">
                        ${grouped[collection].map(req => `
                            <div class="collection-item ${req.id === currentRequestId ? 'active' : ''}" onclick="loadRequest('${req.id}')">
                                <span class="method-badge method-${req.method}">${req.method}</span>
                                <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${req.name}</span>
                                <button class="remove-btn" onclick="event.stopPropagation(); deleteRequest('${req.id}')" title="Delete">√ó</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            if (data.requests.length === 0) {
                html = '<div class="empty-state" style="padding: 30px; height: auto;"><p>No saved requests</p></div>';
            }

            list.innerHTML = html;
            collectionSelect.innerHTML = selectHtml;
        }

        function newRequest() {
            currentRequestId = null;
            document.getElementById('methodSelect').value = 'GET';
            document.getElementById('urlInput').value = '';
            document.getElementById('bodyEditor').value = '';
            params = [];
            headers = [...defaultHeaders];
            addParam();
            renderParams();
            renderHeaders();
            clearResponse();
            renderCollections();
        }

        function loadRequest(id) {
            const req = data.requests.find(r => r.id === id);
            if (!req) return;

            currentRequestId = id;
            document.getElementById('methodSelect').value = req.method;
            document.getElementById('urlInput').value = req.url;
            document.getElementById('bodyEditor').value = req.body || '';

            params = req.params || [];
            headers = req.headers || [...defaultHeaders];

            if (params.length === 0) addParam();
            renderParams();
            renderHeaders();

            if (req.auth) {
                document.getElementById('authType').value = req.auth.type || 'none';
                updateAuthUI();
                if (req.auth.token) { const el = document.getElementById('authToken'); if (el) el.value = req.auth.token; }
                if (req.auth.username) { const el = document.getElementById('authUsername'); if (el) el.value = req.auth.username; }
                if (req.auth.password) { const el = document.getElementById('authPassword'); if (el) el.value = req.auth.password; }
                if (req.auth.apiKey) { const el = document.getElementById('authApiKey'); if (el) el.value = req.auth.apiKey; }
                if (req.auth.apiKeyName) { const el = document.getElementById('authApiKeyName'); if (el) el.value = req.auth.apiKeyName; }
            }

            clearResponse();
            renderCollections();
        }

        function saveRequest() {
            document.getElementById('requestName').value = '';
            document.getElementById('newCollection').value = '';
            document.getElementById('saveModal').classList.add('active');
        }

        function saveRequestSubmit(e) {
            e.preventDefault();

            const name = document.getElementById('requestName').value;
            const collection = document.getElementById('newCollection').value ||
                              document.getElementById('collectionSelect').value ||
                              'Default';

            const req = {
                id: currentRequestId || generateId(),
                name,
                collection,
                method: document.getElementById('methodSelect').value,
                url: document.getElementById('urlInput').value,
                params: params.filter(p => p.key),
                headers: headers.filter(h => h.key),
                body: document.getElementById('bodyEditor').value,
                auth: getAuthConfig(),
                createdAt: currentRequestId ?
                    data.requests.find(r => r.id === currentRequestId)?.createdAt :
                    new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (currentRequestId) {
                const idx = data.requests.findIndex(r => r.id === currentRequestId);
                if (idx !== -1) data.requests[idx] = req;
            } else {
                data.requests.push(req);
                currentRequestId = req.id;
            }

            saveData();
            closeModal('saveModal');
            renderCollections();
        }

        function deleteRequest(id) {
            if (confirm('Delete this request?')) {
                data.requests = data.requests.filter(r => r.id !== id);
                if (currentRequestId === id) newRequest();
                saveData();
                renderCollections();
            }
        }

        function deleteCollection(collection) {
            if (confirm(`Delete collection "${collection}" and all its requests?`)) {
                data.requests = data.requests.filter(r => r.collection !== collection);
                saveData();
                renderCollections();
            }
        }

        // Params
        function addParam() {
            params.push({ key: '', value: '', enabled: true });
            renderParams();
        }

        function renderParams() {
            const list = document.getElementById('paramsList');
            list.innerHTML = params.map((p, i) => `
                <div class="key-value-row">
                    <input type="checkbox" ${p.enabled ? 'checked' : ''} onchange="params[${i}].enabled = this.checked">
                    <input type="text" placeholder="Key" value="${escapeHtml(p.key)}" onchange="params[${i}].key = this.value">
                    <input type="text" placeholder="Value" value="${escapeHtml(p.value)}" onchange="params[${i}].value = this.value">
                    <button class="remove-btn" onclick="removeParam(${i})">√ó</button>
                </div>
            `).join('');
        }

        function removeParam(i) {
            params.splice(i, 1);
            if (params.length === 0) addParam();
            renderParams();
        }

        // Headers
        function addHeader() {
            headers.push({ key: '', value: '', enabled: true });
            renderHeaders();
        }

        function renderHeaders() {
            const list = document.getElementById('headersList');
            list.innerHTML = headers.map((h, i) => `
                <div class="key-value-row">
                    <input type="checkbox" ${h.enabled ? 'checked' : ''} onchange="headers[${i}].enabled = this.checked">
                    <input type="text" placeholder="Header" value="${escapeHtml(h.key)}" onchange="headers[${i}].key = this.value">
                    <input type="text" placeholder="Value" value="${escapeHtml(h.value)}" onchange="headers[${i}].value = this.value">
                    <button class="remove-btn" onclick="removeHeader(${i})">√ó</button>
                </div>
            `).join('');
        }

        function removeHeader(i) {
            headers.splice(i, 1);
            renderHeaders();
        }

        // Auth
        function updateAuthUI() {
            const type = document.getElementById('authType').value;
            const fields = document.getElementById('authFields');

            switch (type) {
                case 'none':
                    fields.innerHTML = '';
                    break;
                case 'bearer':
                    fields.innerHTML = `
                        <div class="form-group">
                            <label>Token</label>
                            <input type="text" id="authToken" placeholder="Enter bearer token">
                        </div>
                    `;
                    break;
                case 'basic':
                    fields.innerHTML = `
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="authUsername" placeholder="Username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="authPassword" placeholder="Password">
                        </div>
                    `;
                    break;
                case 'api-key':
                    fields.innerHTML = `
                        <div class="form-group">
                            <label>Key Name</label>
                            <input type="text" id="authApiKeyName" placeholder="X-API-Key" value="X-API-Key">
                        </div>
                        <div class="form-group">
                            <label>Key Value</label>
                            <input type="text" id="authApiKey" placeholder="Your API key">
                        </div>
                    `;
                    break;
            }
        }

        function getAuthConfig() {
            const type = document.getElementById('authType').value;
            const config = { type };

            switch (type) {
                case 'bearer':
                    config.token = document.getElementById('authToken')?.value || '';
                    break;
                case 'basic':
                    config.username = document.getElementById('authUsername')?.value || '';
                    config.password = document.getElementById('authPassword')?.value || '';
                    break;
                case 'api-key':
                    config.apiKeyName = document.getElementById('authApiKeyName')?.value || 'X-API-Key';
                    config.apiKey = document.getElementById('authApiKey')?.value || '';
                    break;
            }

            return config;
        }

        // Send Request
        async function sendRequest() {
            let url = document.getElementById('urlInput').value.trim();
            if (!url) {
                alert('Please enter a URL');
                return;
            }

            // Add protocol if missing
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }

            // Add query params
            const enabledParams = params.filter(p => p.enabled && p.key);
            if (enabledParams.length > 0) {
                const urlObj = new URL(url);
                enabledParams.forEach(p => urlObj.searchParams.append(p.key, p.value));
                url = urlObj.toString();
            }

            const method = document.getElementById('methodSelect').value;
            const body = document.getElementById('bodyEditor').value;

            // Build headers
            const reqHeaders = {};
            headers.filter(h => h.enabled && h.key).forEach(h => {
                reqHeaders[h.key] = h.value;
            });

            // Add auth
            const auth = getAuthConfig();
            switch (auth.type) {
                case 'bearer':
                    if (auth.token) reqHeaders['Authorization'] = 'Bearer ' + auth.token;
                    break;
                case 'basic':
                    if (auth.username) {
                        const encoded = btoa(auth.username + ':' + (auth.password || ''));
                        reqHeaders['Authorization'] = 'Basic ' + encoded;
                    }
                    break;
                case 'api-key':
                    if (auth.apiKey) reqHeaders[auth.apiKeyName] = auth.apiKey;
                    break;
            }

            // Update UI
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span>';

            const startTime = performance.now();

            try {
                const fetchOptions = {
                    method,
                    headers: reqHeaders,
                    mode: 'cors'
                };

                if (method !== 'GET' && method !== 'HEAD' && body) {
                    fetchOptions.body = body;
                }

                const response = await fetch(url, fetchOptions);
                const endTime = performance.now();

                const responseText = await response.text();
                const responseHeaders = {};
                response.headers.forEach((value, key) => {
                    responseHeaders[key] = value;
                });

                displayResponse({
                    status: response.status,
                    statusText: response.statusText,
                    time: Math.round(endTime - startTime),
                    size: new Blob([responseText]).size,
                    body: responseText,
                    headers: responseHeaders
                });

                // Save to history
                data.history.unshift({
                    id: generateId(),
                    method,
                    url,
                    status: response.status,
                    time: Math.round(endTime - startTime),
                    timestamp: new Date().toISOString()
                });
                data.history = data.history.slice(0, 100); // Keep last 100
                saveData();

            } catch (error) {
                displayResponse({
                    status: 0,
                    statusText: 'Error',
                    time: Math.round(performance.now() - startTime),
                    size: 0,
                    body: `Error: ${error.message}\n\nThis could be due to:\n- CORS restrictions\n- Network issues\n- Invalid URL\n- Server not responding`,
                    headers: {},
                    isError: true
                });
            }

            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';
        }

        function displayResponse(res) {
            document.getElementById('emptyResponse').style.display = 'none';
            document.getElementById('responseBodyPre').style.display = 'block';
            document.getElementById('responseMeta').style.display = 'flex';

            // Status
            const statusEl = document.getElementById('responseStatus');
            statusEl.textContent = `${res.status} ${res.statusText}`;
            statusEl.className = 'response-status';
            if (res.status >= 200 && res.status < 300) statusEl.classList.add('status-2xx');
            else if (res.status >= 300 && res.status < 400) statusEl.classList.add('status-3xx');
            else if (res.status >= 400 && res.status < 500) statusEl.classList.add('status-4xx');
            else statusEl.classList.add('status-5xx');

            // Time and size
            document.getElementById('responseTime').textContent = `${res.time}ms`;
            document.getElementById('responseSize').textContent = formatBytes(res.size);

            // Body
            const bodyPre = document.getElementById('responseBodyPre');
            try {
                const json = JSON.parse(res.body);
                bodyPre.innerHTML = syntaxHighlight(JSON.stringify(json, null, 2));
            } catch {
                bodyPre.textContent = res.body;
            }

            // Headers
            const headersTable = document.getElementById('responseHeadersTable');
            headersTable.innerHTML = Object.entries(res.headers).map(([key, value]) =>
                `<tr><td>${escapeHtml(key)}</td><td>${escapeHtml(value)}</td></tr>`
            ).join('');
        }

        function clearResponse() {
            document.getElementById('emptyResponse').style.display = 'flex';
            document.getElementById('responseBodyPre').style.display = 'none';
            document.getElementById('responseMeta').style.display = 'none';
        }

        function syntaxHighlight(json) {
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match => {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // Export/Import
        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api-tester-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (imported.requests) {
                        if (confirm('Merge with existing data or replace all?')) {
                            // Merge
                            data.requests = [...data.requests, ...imported.requests];
                        } else {
                            data = imported;
                        }
                        saveData();
                        renderCollections();
                        alert('Data imported successfully!');
                    } else {
                        alert('Invalid format.');
                    }
                } catch (err) {
                    alert('Error parsing file: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Utilities
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        init();
    </script>
</body>
</html>
