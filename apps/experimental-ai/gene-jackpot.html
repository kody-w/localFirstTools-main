<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Jackpot ‚Äî Genetic Slot Machine</title>
    <meta name="description" content="A slot machine where the reels are real gallery apps. Pull the lever to select 3 random parents, then breed them via genetic recombination into a new app concept. Hit BUILD to queue it.">
    <meta name="rappterzoo:author" content="RappterZoo">
    <meta name="rappterzoo:author-type" content="agent">
    <meta name="rappterzoo:category" content="experimental-ai">
    <meta name="rappterzoo:tags" content="genetic,recombination,slot-machine,breeding,meta,interactive,game">
    <meta name="rappterzoo:type" content="interactive">
    <meta name="rappterzoo:complexity" content="advanced">
    <meta name="rappterzoo:created" content="2026-02-08">
    <meta name="rappterzoo:generation" content="1">
    <style>
:root {
    --bg: #0c0814;
    --machine: #1a1228;
    --chrome: #2a2040;
    --gold: #ffd700;
    --gold-dim: #8b7500;
    --red: #ff1744;
    --green: #00e676;
    --cyan: #18ffff;
    --purple: #b388ff;
    --neon-pink: #ff4081;
    --panel: rgba(16,12,28,0.92);
    --border: rgba(255,255,255,0.06);
    --text: #c0b8d8;
    --dim: #5a5070;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    background: var(--bg);
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
}

/* Header */
.header {
    width: 100%;
    padding: 12px 20px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    backdrop-filter: blur(12px);
}
.header h1 {
    font-size: 0.9rem;
    font-weight: 400;
    letter-spacing: 2px;
}
.header h1 .emoji { font-size: 1.1rem; }
.header h1 .gold {
    background: linear-gradient(90deg, var(--gold), var(--neon-pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.header-stats {
    display: flex;
    gap: 16px;
    font-size: 0.65rem;
}
.header-stats .stat { text-align: center; }
.header-stats .stat .val { color: var(--gold); font-weight: 700; font-size: 0.9rem; font-variant-numeric: tabular-nums; }
.header-stats .stat .lbl { color: var(--dim); text-transform: uppercase; letter-spacing: 0.6px; }

/* Machine body */
.machine-frame {
    margin-top: 24px;
    background: linear-gradient(180deg, #1e1630 0%, #140e22 100%);
    border: 2px solid #2a2244;
    border-radius: 20px;
    padding: 24px;
    width: min(700px, 95vw);
    box-shadow:
        0 0 40px rgba(124,77,255,0.08),
        inset 0 1px 0 rgba(255,255,255,0.04);
    position: relative;
}
.machine-frame::before {
    content: 'üß¨ GENE JACKPOT üß¨';
    display: block;
    text-align: center;
    font-size: 0.7rem;
    letter-spacing: 4px;
    color: var(--gold);
    text-shadow: 0 0 10px rgba(255,215,0,0.3);
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,215,0,0.1);
}

/* Reels */
.reels-container {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-bottom: 20px;
}
.reel-frame {
    width: 190px;
    height: 220px;
    background: #0a0612;
    border: 2px solid #2a2244;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}
.reel-frame::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
        180deg,
        rgba(10,6,18,0.9) 0%,
        transparent 20%,
        transparent 80%,
        rgba(10,6,18,0.9) 100%
    );
    pointer-events: none;
    z-index: 2;
}
.reel-strip {
    position: absolute;
    left: 0; right: 0;
    transition: transform 0.05s linear;
}
.reel-item {
    width: 100%;
    height: 220px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 12px;
    text-align: center;
}
.reel-item .app-icon {
    width: 64px;
    height: 64px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    margin-bottom: 8px;
    border: 1px solid rgba(255,255,255,0.08);
}
.reel-item .app-title {
    font-size: 0.68rem;
    color: #fff;
    font-weight: 500;
    margin-bottom: 4px;
    max-width: 160px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.reel-item .app-cat {
    font-size: 0.55rem;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}
.reel-item .app-score {
    font-size: 0.75rem;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
}
.reel-item .app-techs {
    font-size: 0.5rem;
    color: var(--dim);
    margin-top: 6px;
    max-width: 160px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Lever + buttons */
.controls-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    margin-bottom: 20px;
}
.lever-btn {
    width: 180px;
    height: 52px;
    background: linear-gradient(180deg, #ff4081, #c51162);
    border: none;
    border-radius: 26px;
    color: #fff;
    font-size: 0.85rem;
    font-weight: 700;
    font-family: inherit;
    letter-spacing: 2px;
    cursor: pointer;
    text-transform: uppercase;
    box-shadow: 0 4px 20px rgba(255,64,129,0.3);
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
}
.lever-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(255,64,129,0.4); }
.lever-btn:active { transform: translateY(1px); }
.lever-btn:disabled { background: #333; box-shadow: none; cursor: not-allowed; transform: none; }
.lever-btn.spinning {
    background: linear-gradient(180deg, #555, #333);
    animation: btn-pulse 0.3s infinite;
}
@keyframes btn-pulse { 0%,100%{ opacity: 0.8; } 50%{ opacity: 1; } }

.experience-sel {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: var(--text);
    padding: 8px 12px;
    font-family: inherit;
    font-size: 0.7rem;
    outline: none;
    cursor: pointer;
}

/* Breed result panel */
.breed-panel {
    background: rgba(255,215,0,0.03);
    border: 1px solid rgba(255,215,0,0.1);
    border-radius: 12px;
    padding: 16px;
    display: none;
    animation: fadeIn 0.4s ease;
}
.breed-panel.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.breed-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}
.breed-header h3 {
    font-size: 0.75rem;
    font-weight: 400;
    color: var(--gold);
    letter-spacing: 1px;
}
.breed-header .breed-badge {
    font-size: 0.55rem;
    background: rgba(255,215,0,0.1);
    border: 1px solid rgba(255,215,0,0.2);
    border-radius: 4px;
    padding: 2px 8px;
    color: var(--gold);
}

.offspring-card {
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 12px;
}
.offspring-card .off-name {
    font-size: 0.85rem;
    color: #fff;
    font-weight: 500;
    margin-bottom: 4px;
}
.offspring-card .off-desc {
    font-size: 0.68rem;
    color: var(--text);
    line-height: 1.5;
    margin-bottom: 8px;
}
.offspring-card .off-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
}
.off-tag {
    font-size: 0.55rem;
    padding: 2px 6px;
    border-radius: 3px;
    background: rgba(124,77,255,0.12);
    border: 1px solid rgba(124,77,255,0.2);
    color: var(--purple);
}
.gene-list {
    font-size: 0.6rem;
    color: var(--dim);
    margin-bottom: 10px;
}
.gene-list .gene-from {
    display: flex;
    gap: 4px;
    align-items: center;
    padding: 2px 0;
}
.gene-list .gene-donor { color: var(--cyan); }
.gene-list .gene-trait { color: var(--text); }

.build-row {
    display: flex;
    gap: 8px;
    align-items: center;
}
.build-btn {
    background: linear-gradient(135deg, var(--gold), #ff9100);
    border: none;
    border-radius: 8px;
    color: #000;
    font-size: 0.75rem;
    font-weight: 700;
    font-family: inherit;
    padding: 8px 24px;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.15s;
}
.build-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,215,0,0.3); }
.build-btn:disabled { background: #444; color: #888; cursor: not-allowed; transform: none; box-shadow: none; }
.reroll-btn {
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 0.7rem;
    font-family: inherit;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.15s;
}
.reroll-btn:hover { background: rgba(255,255,255,0.1); }
.build-status {
    font-size: 0.65rem;
    color: var(--green);
    margin-left: auto;
}

/* Build queue panel */
.queue-panel {
    width: min(700px, 95vw);
    margin: 20px auto;
    padding: 0 24px 24px;
}
.queue-panel h2 {
    font-size: 0.65rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--dim);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.queue-panel h2 .count { color: var(--gold); }
.queue-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.queue-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.68rem;
}
.queue-item .qi-name { color: #fff; flex: 1; }
.queue-item .qi-parents { color: var(--dim); font-size: 0.6rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.queue-item .qi-exp { color: var(--purple); font-size: 0.6rem; }
.queue-item .qi-remove {
    background: none;
    border: none;
    color: var(--dim);
    cursor: pointer;
    font-family: inherit;
    font-size: 0.8rem;
    padding: 0 4px;
}
.queue-item .qi-remove:hover { color: var(--red); }
.clear-queue-btn {
    background: none;
    border: 1px solid rgba(255,23,68,0.2);
    color: var(--red);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 0.55rem;
    font-family: inherit;
    cursor: pointer;
}

/* History / stats */
.stats-row {
    width: min(700px, 95vw);
    display: flex;
    gap: 12px;
    margin: 0 auto 20px;
    padding: 0 24px;
}
.mini-stat {
    flex: 1;
    background: rgba(255,255,255,0.02);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    text-align: center;
}
.mini-stat .ms-val { font-size: 1.3rem; font-weight: 700; color: #fff; font-variant-numeric: tabular-nums; }
.mini-stat .ms-lbl { font-size: 0.55rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.6px; margin-top: 2px; }

/* Sound indicators */
.sound-off {
    font-size: 0.7rem;
    cursor: pointer;
    background: none;
    border: none;
    color: var(--dim);
    font-family: inherit;
}
.sound-off:hover { color: var(--text); }

@media (max-width: 640px) {
    .reels-container { flex-direction: column; align-items: center; }
    .reel-frame { width: min(280px, 85vw); height: 160px; }
    .reel-item { height: 160px; }
    .controls-row { flex-wrap: wrap; }
    .stats-row { flex-wrap: wrap; }
}
    </style>
</head>
<body>

<div class="header">
    <h1><span class="emoji">üé∞</span> <span class="gold">Gene Jackpot</span></h1>
    <div class="header-stats">
        <div class="stat"><div class="val" id="h-pool">‚Äî</div><div class="lbl">Gene Pool</div></div>
        <div class="stat"><div class="val" id="h-ident">‚Äî</div><div class="lbl">Identified</div></div>
        <div class="stat"><div class="val" id="h-queued">0</div><div class="lbl">Queued</div></div>
        <button class="sound-off" id="sound-toggle" title="Toggle sound">üîä</button>
    </div>
</div>

<div class="machine-frame">
    <div class="reels-container">
        <div class="reel-frame" id="reel-0"><div class="reel-strip" id="strip-0"></div></div>
        <div class="reel-frame" id="reel-1"><div class="reel-strip" id="strip-1"></div></div>
        <div class="reel-frame" id="reel-2"><div class="reel-strip" id="strip-2"></div></div>
    </div>

    <div class="controls-row">
        <select class="experience-sel" id="exp-sel">
            <option value="random">üé≤ Random Experience</option>
        </select>
        <button class="lever-btn" id="lever-btn">üé∞ PULL</button>
    </div>

    <div class="breed-panel" id="breed-panel">
        <div class="breed-header">
            <h3>üß¨ Offspring Concept</h3>
            <span class="breed-badge" id="breed-exp">‚Äî</span>
        </div>
        <div class="offspring-card" id="offspring-card"></div>
        <div class="build-row">
            <button class="build-btn" id="build-btn">‚ö° QUEUE BUILD</button>
            <button class="reroll-btn" id="reroll-btn">üîÄ Re-breed</button>
            <span class="build-status" id="build-status"></span>
        </div>
    </div>
</div>

<div class="stats-row">
    <div class="mini-stat"><div class="ms-val" id="s-pulls">0</div><div class="ms-lbl">Total Pulls</div></div>
    <div class="mini-stat"><div class="ms-val" id="s-breeds">0</div><div class="ms-lbl">Breeds</div></div>
    <div class="mini-stat"><div class="ms-val" id="s-builds">0</div><div class="ms-lbl">Builds Queued</div></div>
    <div class="mini-stat"><div class="ms-val" id="s-jackpots">0</div><div class="ms-lbl">Jackpots (3 cats)</div></div>
</div>

<div class="queue-panel">
    <h2>Build Queue <span class="count" id="q-count">0</span> <button class="clear-queue-btn" id="clear-queue">Clear All</button></h2>
    <div class="queue-list" id="queue-list"></div>
</div>

<script>
(function(){
"use strict";

const $ = id => document.getElementById(id);

const CAT_COLORS = {
    '3d_immersive':'#e91e63','audio_music':'#ff9800','creative_tools':'#4caf50',
    'educational_tools':'#2196f3','experimental_ai':'#9c27b0','games_puzzles':'#f44336',
    'generative_art':'#00bcd4','particle_physics':'#ff5722','visual_art':'#e040fb',
    'data_tools':'#8bc34a','productivity':'#607d8b'
};
const CAT_ICONS = {
    '3d_immersive':'üåê','audio_music':'üéµ','creative_tools':'üîß',
    'educational_tools':'üìö','experimental_ai':'üß™','games_puzzles':'üéÆ',
    'generative_art':'üé®','particle_physics':'‚öõÔ∏è','visual_art':'üñºÔ∏è',
    'data_tools':'üìä','productivity':'üìã'
};
const GRADE_COLORS = {S:'#ffd700',A:'#00e676',B:'#2196f3',C:'#ff9800',D:'#f44336',F:'#666'};
const EXPERIENCES = [
    'discovery','dread','flow','mastery','wonder','tension',
    'mischief','melancholy','hypnosis','vertigo','companionship','emergence'
];

let allApps = [];
let identities = {};
let spinning = false;
let selectedApps = [null, null, null];
let currentOffspring = null;
let buildQueue = [];
let stats = { pulls: 0, breeds: 0, builds: 0, jackpots: 0 };
let soundEnabled = true;
let audioCtx = null;

// ‚îÄ‚îÄ Audio ‚îÄ‚îÄ
function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playTick() {
    if (!soundEnabled || !audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = 800 + Math.random() * 400;
    g.gain.setValueAtTime(0.05, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + 0.05);
}

function playLand(index) {
    if (!soundEnabled || !audioCtx) return;
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'triangle';
    o.frequency.value = 300 + index * 200;
    g.gain.setValueAtTime(0.12, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t); o.stop(t + 0.2);
}

function playJackpot() {
    if (!soundEnabled || !audioCtx) return;
    const t = audioCtx.currentTime;
    [523, 659, 784, 1047].forEach((f, i) => {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.value = f;
        g.gain.setValueAtTime(0.1, t + i * 0.12);
        g.gain.exponentialRampToValueAtTime(0.001, t + i * 0.12 + 0.3);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(t + i * 0.12); o.stop(t + i * 0.12 + 0.35);
    });
}

function playBuild() {
    if (!soundEnabled || !audioCtx) return;
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sawtooth';
    o.frequency.setValueAtTime(200, t);
    o.frequency.exponentialRampToValueAtTime(800, t + 0.15);
    g.gain.setValueAtTime(0.08, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t); o.stop(t + 0.25);
}

$('sound-toggle').onclick = () => {
    soundEnabled = !soundEnabled;
    $('sound-toggle').textContent = soundEnabled ? 'üîä' : 'üîá';
};

// ‚îÄ‚îÄ Data ‚îÄ‚îÄ
async function loadData() {
    const [rankings, idents, manifest] = await Promise.all([
        fetch('../rankings.json').then(r => r.json()),
        fetch('../content-identities.json').then(r => r.json()),
        fetch('../manifest.json').then(r => r.json())
    ]);

    identities = idents;
    const rankMap = {};
    for (const r of (rankings.rankings || [])) rankMap[r.file] = r;

    const cats = manifest.categories || {};
    for (const [catKey, catData] of Object.entries(cats)) {
        const folder = catData.folder || catKey.replace(/_/g, '-');
        for (const app of (catData.apps || [])) {
            const r = rankMap[app.file] || {};
            const path = 'apps/' + folder + '/' + app.file;
            const ident = idents[path] || null;
            allApps.push({
                file: app.file,
                title: app.title || app.file.replace('.html',''),
                category: catKey,
                folder: folder,
                score: r.score || 0,
                grade: r.grade || '?',
                tags: app.tags || [],
                identity: ident,
                techniques: ident ? (ident.techniques || []) : (app.tags || []),
                medium: ident ? ident.medium : null,
                strengths: ident ? (ident.strengths || []) : [],
                color: CAT_COLORS[catKey] || '#666',
                icon: CAT_ICONS[catKey] || 'üìÑ'
            });
        }
    }

    $('h-pool').textContent = allApps.length;
    $('h-ident').textContent = Object.keys(idents).length;

    // Populate experience selector
    const sel = $('exp-sel');
    for (const exp of EXPERIENCES) {
        const opt = document.createElement('option');
        opt.value = exp;
        opt.textContent = exp.charAt(0).toUpperCase() + exp.slice(1);
        sel.appendChild(opt);
    }

    // Load saved queue
    try {
        const saved = JSON.parse(localStorage.getItem('gene-jackpot-queue') || '[]');
        buildQueue = saved;
        const savedStats = JSON.parse(localStorage.getItem('gene-jackpot-stats') || '{}');
        if (savedStats.pulls) stats = savedStats;
    } catch(e) {}
    renderQueue();
    renderStats();

    // Populate initial reels
    populateReels();
}

// ‚îÄ‚îÄ Reel Rendering ‚îÄ‚îÄ
function renderReelItem(app) {
    return `<div class="reel-item">
        <div class="app-icon" style="background:${app.color}20;color:${app.color}">${app.icon}</div>
        <div class="app-title">${esc(app.title)}</div>
        <div class="app-cat" style="color:${app.color}">${app.category.replace(/_/g,' ')}</div>
        <div class="app-score" style="color:${GRADE_COLORS[app.grade] || '#888'}">${app.score}pts ${app.grade}</div>
        <div class="app-techs">${app.techniques.slice(0,3).join(' ¬∑ ')}</div>
    </div>`;
}

function populateReels() {
    for (let r = 0; r < 3; r++) {
        const strip = $('strip-' + r);
        const shuffled = [...allApps].sort(() => Math.random() - 0.5);
        strip.innerHTML = shuffled.map(a => renderReelItem(a)).join('');
        strip._apps = shuffled;
        strip._offset = 0;
        strip.style.transform = 'translateY(0px)';
    }
}

// ‚îÄ‚îÄ Spin Animation ‚îÄ‚îÄ
async function spin() {
    if (spinning || allApps.length < 3) return;
    spinning = true;
    initAudio();
    const lever = $('lever-btn');
    lever.disabled = true;
    lever.classList.add('spinning');
    lever.textContent = 'üé∞ SPINNING...';
    $('breed-panel').classList.remove('active');

    stats.pulls++;
    renderStats();

    // Pick 3 random apps as final targets
    const pool = [...allApps].sort(() => Math.random() - 0.5);
    const targets = [pool[0], pool[1], pool[2]];

    // Animate each reel stopping sequentially
    for (let r = 0; r < 3; r++) {
        const strip = $('strip-' + r);
        // Rebuild strip with target in landing position
        const shuffled = [...allApps].sort(() => Math.random() - 0.5);
        // Put target at position 0
        const idx = shuffled.findIndex(a => a.file === targets[r].file);
        if (idx > 0) { const t = shuffled.splice(idx, 1)[0]; shuffled.unshift(t); }
        strip.innerHTML = shuffled.map(a => renderReelItem(a)).join('');
        strip._apps = shuffled;

        // Animate spin
        const itemH = 220;
        const totalItems = shuffled.length;
        const spinCount = 8 + r * 5; // More spins for later reels
        const totalDist = spinCount * itemH;

        strip.style.transition = 'none';
        strip.style.transform = `translateY(-${totalDist}px)`;

        await new Promise(resolve => {
            requestAnimationFrame(() => {
                strip.style.transition = `transform ${1.2 + r * 0.5}s cubic-bezier(0.2, 0, 0.1, 1)`;
                strip.style.transform = 'translateY(0px)';
            });

            // Tick sounds during spin
            const tickInterval = setInterval(playTick, 80);
            setTimeout(() => {
                clearInterval(tickInterval);
                playLand(r);
                resolve();
            }, (1.2 + r * 0.5) * 1000);
        });
    }

    selectedApps = targets;

    // Check for jackpot (all 3 different categories)
    const uniqueCats = new Set(targets.map(a => a.category));
    if (uniqueCats.size === 3) {
        stats.jackpots++;
        playJackpot();
    }

    // Auto-breed
    breed();

    spinning = false;
    lever.disabled = false;
    lever.classList.remove('spinning');
    lever.textContent = 'üé∞ PULL';
    renderStats();
    saveStats();
}

// ‚îÄ‚îÄ Breeding Engine ‚îÄ‚îÄ
function breed() {
    const parents = selectedApps.filter(Boolean);
    if (parents.length < 3) return;

    const expSel = $('exp-sel').value;
    const experience = expSel === 'random' ? EXPERIENCES[Math.floor(Math.random() * EXPERIENCES.length)] : expSel;

    // Merge techniques from all parents (best of each)
    const allTechs = new Map();
    for (const p of parents) {
        for (const t of p.techniques) {
            if (!allTechs.has(t)) allTechs.set(t, { tech: t, donor: p.title });
        }
    }
    // Pick 6-10 techniques, preferring diverse donors
    const merged = [];
    const donors = new Set();
    const techEntries = [...allTechs.values()].sort(() => Math.random() - 0.5);
    for (const entry of techEntries) {
        if (merged.length >= 10) break;
        // Prefer entries from donors we haven't used much
        merged.push(entry);
        donors.add(entry.donor);
    }

    // Merge strengths
    const allStrengths = [];
    for (const p of parents) {
        for (const s of p.strengths.slice(0, 2)) {
            allStrengths.push({ text: s, from: p.title });
        }
    }

    // Generate offspring concept
    const categories = parents.map(p => p.category);
    const primaryCat = categories[Math.floor(Math.random() * categories.length)];

    // Name generation from parent titles
    const words = [];
    for (const p of parents) {
        const parts = p.title.split(/[\s\-‚Äî:]+/).filter(w => w.length > 2);
        words.push(...parts);
    }
    const shuffledWords = words.sort(() => Math.random() - 0.5);
    const nameParts = shuffledWords.slice(0, 3);
    const offspringName = nameParts.join(' ') || 'Unnamed Offspring';

    // Build description from merged traits
    const mediums = parents.map(p => p.medium).filter(Boolean);
    let desc = `A ${experience}-driven experience born from the DNA of ${parents.map(p => '"'+p.title+'"').join(', ')}. `;
    if (mediums.length) {
        desc += `Combines the essence of ${mediums.slice(0,2).join(' and ')}. `;
    }
    desc += `Inherits ${merged.length} techniques across ${donors.size} genetic lineages.`;

    // Tags from parents + experience
    const tagSet = new Set([experience]);
    for (const p of parents) {
        for (const t of p.tags.slice(0, 2)) tagSet.add(t);
    }

    currentOffspring = {
        name: offspringName,
        description: desc,
        experience: experience,
        category: primaryCat,
        parents: parents.map(p => ({ file: p.file, title: p.title, score: p.score, category: p.category })),
        techniques: merged,
        strengths: allStrengths,
        tags: [...tagSet].slice(0, 8),
        timestamp: new Date().toISOString()
    };

    renderOffspring(currentOffspring);
    stats.breeds++;
    renderStats();
    saveStats();
}

function renderOffspring(o) {
    $('breed-panel').classList.add('active');
    $('breed-exp').textContent = '‚ú® ' + o.experience;

    let html = `<div class="off-name">${esc(o.name)}</div>`;
    html += `<div class="off-desc">${esc(o.description)}</div>`;
    html += `<div class="off-meta">`;
    for (const t of o.tags) {
        html += `<span class="off-tag">${esc(t)}</span>`;
    }
    html += `</div>`;

    html += `<div class="gene-list"><strong style="color:var(--gold);font-size:0.6rem">GENE CROSSOVER:</strong>`;
    for (const g of o.techniques.slice(0, 8)) {
        html += `<div class="gene-from">
            <span class="gene-trait">‚Üê ${esc(g.tech)}</span>
            <span class="gene-donor">[${esc(g.donor.substring(0,20))}]</span>
        </div>`;
    }
    html += `</div>`;

    $('offspring-card').innerHTML = html;
    $('build-btn').disabled = false;
    $('build-status').textContent = '';
}

// ‚îÄ‚îÄ Build Queue ‚îÄ‚îÄ
function queueBuild() {
    if (!currentOffspring) return;
    buildQueue.push(currentOffspring);
    stats.builds++;
    playBuild();

    $('build-btn').disabled = true;
    $('build-status').textContent = '‚úÖ Queued!';

    renderQueue();
    renderStats();
    saveQueue();
    saveStats();
}

function renderQueue() {
    const list = $('queue-list');
    $('q-count').textContent = buildQueue.length;
    $('h-queued').textContent = buildQueue.length;

    if (!buildQueue.length) {
        list.innerHTML = '<div style="font-size:0.65rem;color:var(--dim);padding:12px;text-align:center">No builds queued. Pull the lever!</div>';
        return;
    }

    list.innerHTML = buildQueue.map((item, i) =>
        `<div class="queue-item">
            <span class="qi-name">${esc(item.name)}</span>
            <span class="qi-parents">${item.parents.map(p => p.title.substring(0,12)).join(' √ó ')}</span>
            <span class="qi-exp">${item.experience}</span>
            <button class="qi-remove" data-idx="${i}" title="Remove">‚úï</button>
        </div>`
    ).join('');

    list.querySelectorAll('.qi-remove').forEach(btn => {
        btn.onclick = () => {
            buildQueue.splice(parseInt(btn.dataset.idx), 1);
            renderQueue();
            saveQueue();
        };
    });
}

function renderStats() {
    $('s-pulls').textContent = stats.pulls;
    $('s-breeds').textContent = stats.breeds;
    $('s-builds').textContent = stats.builds;
    $('s-jackpots').textContent = stats.jackpots;
}

function saveQueue() {
    try { localStorage.setItem('gene-jackpot-queue', JSON.stringify(buildQueue)); } catch(e) {}
}
function saveStats() {
    try { localStorage.setItem('gene-jackpot-stats', JSON.stringify(stats)); } catch(e) {}
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ‚îÄ‚îÄ Events ‚îÄ‚îÄ
$('lever-btn').onclick = spin;
$('build-btn').onclick = queueBuild;
$('reroll-btn').onclick = () => { if (selectedApps.every(Boolean)) breed(); };
$('clear-queue').onclick = () => { buildQueue = []; renderQueue(); saveQueue(); };

// Keyboard: Space to pull
document.addEventListener('keydown', e => {
    if (e.key === ' ' && !spinning) { e.preventDefault(); spin(); }
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadData().catch(e => {
    document.querySelector('.machine-frame').innerHTML = `<div style="text-align:center;padding:40px;color:var(--dim)">
        <p>Failed to load ecosystem data.</p>
        <p style="font-size:0.7rem;margin-top:8px">Error: ${esc(e.message)}</p>
        <p style="font-size:0.65rem;margin-top:8px">Serve from the gallery root.</p>
    </div>`;
});

})();
</script>
</body>
</html>