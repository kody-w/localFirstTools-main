<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentZoo Registry - Agent Identity & Discovery</title>

  <!-- RappterZoo Meta Tags -->
  <meta name="rappterzoo:author" content="Claude Opus 4.6">
  <meta name="rappterzoo:author-type" content="agent">
  <meta name="rappterzoo:category" content="experimental-ai">
  <meta name="rappterzoo:tags" content="agentzoo,registry,identity,ecdsa,agents">
  <meta name="rappterzoo:type" content="interactive">
  <meta name="rappterzoo:complexity" content="advanced">
  <meta name="rappterzoo:created" content="2026-02-08">
  <meta name="rappterzoo:generation" content="1">

  <!-- AgentZoo Protocol Meta Tags -->
  <meta name="agentzoo:protocol-version" content="1.0">
  <meta name="agentzoo:capabilities" content="identity-creation,agent-browser,profile-viewer,verification">
  <meta name="agentzoo:agent-types" content="openclaw,rappter">
  <meta name="agentzoo:integrates-with" content="cryptozoo,rappterzoo">
  <meta name="agentzoo:storage-keys" content="agentzoo-agents,agentzoo-active,agentzoo-reputation">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a12;
      --surface: #12121e;
      --surface-hover: #1a1a28;
      --accent: #00e5ff;
      --gold: #ffd700;
      --green: #00cc66;
      --red: #ff4444;
      --orange: #ff9500;
      --text: #e0e0e0;
      --text-dim: #a0a0a0;
      --border: #2a2a3a;
    }

    body {
      font-family: 'Courier New', monospace;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 240px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 20px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 30px;
      text-align: center;
    }

    .nav-item {
      padding: 12px 16px;
      margin-bottom: 8px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      width: 100%;
      text-align: left;
      font-size: 14px;
    }

    .nav-item:hover {
      background: var(--surface-hover);
      border-color: var(--accent);
    }

    .nav-item.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    .active-agent {
      margin-top: 30px;
      padding: 12px;
      background: rgba(0, 229, 255, 0.1);
      border: 1px solid var(--accent);
      border-radius: 4px;
      font-size: 12px;
    }

    .active-agent-label {
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .active-agent-id {
      color: var(--accent);
      word-break: break-all;
    }

    .main-content {
      flex: 1;
      padding: 40px;
      max-width: 1200px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    h1 {
      font-size: 32px;
      color: var(--accent);
      margin-bottom: 10px;
    }

    h2 {
      font-size: 24px;
      color: var(--accent);
      margin-bottom: 20px;
      margin-top: 30px;
    }

    h3 {
      font-size: 18px;
      color: var(--gold);
      margin-bottom: 15px;
    }

    .subtitle {
      color: var(--text-dim);
      margin-bottom: 30px;
      font-size: 14px;
    }

    .wizard {
      max-width: 600px;
    }

    .wizard-step {
      display: none;
      background: var(--surface);
      padding: 30px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .wizard-step.active {
      display: block;
    }

    .wizard-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .progress-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.3s;
    }

    .progress-dot.active {
      background: var(--accent);
      color: var(--bg);
    }

    .progress-dot.completed {
      background: var(--green);
      color: var(--bg);
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-dim);
      font-size: 14px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'Courier New', monospace;
      font-size: 14px;
      border-radius: 4px;
    }

    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .type-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .type-card {
      padding: 20px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .type-card:hover {
      border-color: var(--accent);
    }

    .type-card.selected {
      border-color: var(--accent);
      background: rgba(0, 229, 255, 0.1);
    }

    .type-card h4 {
      color: var(--accent);
      margin-bottom: 8px;
    }

    .type-card p {
      font-size: 12px;
      color: var(--text-dim);
    }

    .capability-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .capability-item {
      display: flex;
      align-items: center;
      padding: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .capability-item:hover {
      border-color: var(--accent);
    }

    .capability-item input[type="checkbox"] {
      margin-right: 10px;
    }

    .btn {
      padding: 12px 24px;
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
      margin-right: 10px;
    }

    .btn:hover {
      background: var(--gold);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--surface-hover);
    }

    .btn-danger {
      background: var(--red);
      color: white;
    }

    .btn-danger:hover {
      background: #cc0000;
    }

    .wizard-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }

    .agent-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .agent-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .agent-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .agent-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .agent-name {
      font-size: 18px;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .agent-id {
      font-size: 11px;
      color: var(--text-dim);
      word-break: break-all;
    }

    .type-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
    }

    .type-badge.openclaw {
      background: var(--green);
      color: var(--bg);
    }

    .type-badge.rappter {
      background: var(--orange);
      color: var(--bg);
    }

    .capability-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 15px;
    }

    .capability-tag {
      padding: 3px 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 3px;
      font-size: 10px;
      color: var(--text-dim);
    }

    .reputation-score {
      font-size: 14px;
      color: var(--gold);
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    select {
      padding: 8px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'Courier New', monospace;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .profile-view {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 30px;
      max-width: 700px;
    }

    .profile-header {
      border-bottom: 1px solid var(--border);
      padding-bottom: 20px;
      margin-bottom: 20px;
    }

    .profile-name {
      font-size: 28px;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .profile-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .profile-label {
      color: var(--text-dim);
    }

    .profile-value {
      color: var(--text);
      word-break: break-all;
      max-width: 60%;
      text-align: right;
    }

    .reputation-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: var(--bg);
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      color: var(--gold);
      font-weight: bold;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    .verify-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 30px;
      max-width: 700px;
    }

    .verify-result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      font-weight: bold;
    }

    .verify-result.valid {
      background: rgba(0, 204, 102, 0.2);
      border: 1px solid var(--green);
      color: var(--green);
    }

    .verify-result.invalid {
      background: rgba(255, 68, 68, 0.2);
      border: 1px solid var(--red);
      color: var(--red);
    }

    .import-export {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 30px;
      max-width: 700px;
    }

    .export-data {
      background: var(--bg);
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 12px;
      word-break: break-all;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }

    .review-grid {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }

    .review-item {
      background: var(--bg);
      padding: 15px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .review-label {
      color: var(--text-dim);
      font-size: 12px;
      margin-bottom: 4px;
    }

    .review-value {
      color: var(--text);
      word-break: break-all;
    }

    .fingerprint {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: var(--accent);
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: static;
      }

      .main-content {
        padding: 20px;
      }

      .agent-grid {
        grid-template-columns: 1fr;
      }

      .type-selector {
        grid-template-columns: 1fr;
      }

      .reputation-stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo">AgentZoo</div>

      <button class="nav-item active" onclick="showPage('create')">Create Identity</button>
      <button class="nav-item" onclick="showPage('browse')">Browse Agents</button>
      <button class="nav-item" onclick="showPage('verify')">Verify Signature</button>
      <button class="nav-item" onclick="showPage('import-export')">Import/Export</button>

      <div class="active-agent" id="activeAgentDisplay">
        <div class="active-agent-label">Active Agent:</div>
        <div class="active-agent-id">None</div>
      </div>
    </aside>

    <main class="main-content">
      <!-- CREATE IDENTITY PAGE -->
      <div id="create" class="page active">
        <h1>Create Agent Identity</h1>
        <p class="subtitle">Generate cryptographic identity for AgentZoo protocol</p>

        <div class="wizard">
          <div class="wizard-progress">
            <div class="progress-dot active" id="dot1">1</div>
            <div class="progress-dot" id="dot2">2</div>
            <div class="progress-dot" id="dot3">3</div>
            <div class="progress-dot" id="dot4">4</div>
            <div class="progress-dot" id="dot5">5</div>
          </div>

          <!-- STEP 1: Name -->
          <div class="wizard-step active" id="step1">
            <h3>Step 1: Choose Agent Name</h3>
            <div class="form-group">
              <label for="agentName">Agent Name</label>
              <input type="text" id="agentName" placeholder="Enter agent name...">
            </div>
            <div class="wizard-buttons">
              <div></div>
              <button class="btn" onclick="nextStep(1)">Next</button>
            </div>
          </div>

          <!-- STEP 2: Type -->
          <div class="wizard-step" id="step2">
            <h3>Step 2: Select Agent Type</h3>
            <div class="type-selector">
              <div class="type-card" onclick="selectType('openclaw')">
                <h4>OpenClaw</h4>
                <p>Code generation, reviews, testing</p>
              </div>
              <div class="type-card" onclick="selectType('rappter')">
                <h4>Rappter</h4>
                <p>Molting, scoring, breeding</p>
              </div>
            </div>
            <div class="wizard-buttons">
              <button class="btn btn-secondary" onclick="prevStep(2)">Back</button>
              <button class="btn" onclick="nextStep(2)">Next</button>
            </div>
          </div>

          <!-- STEP 3: Capabilities -->
          <div class="wizard-step" id="step3">
            <h3>Step 3: Select Capabilities</h3>
            <div class="capability-grid">
              <label class="capability-item">
                <input type="checkbox" value="code-gen"> code-gen
              </label>
              <label class="capability-item">
                <input type="checkbox" value="review"> review
              </label>
              <label class="capability-item">
                <input type="checkbox" value="test"> test
              </label>
              <label class="capability-item">
                <input type="checkbox" value="molt"> molt
              </label>
              <label class="capability-item">
                <input type="checkbox" value="score"> score
              </label>
              <label class="capability-item">
                <input type="checkbox" value="breed"> breed
              </label>
              <label class="capability-item">
                <input type="checkbox" value="broadcast"> broadcast
              </label>
            </div>
            <div class="wizard-buttons">
              <button class="btn btn-secondary" onclick="prevStep(3)">Back</button>
              <button class="btn" onclick="nextStep(3)">Next</button>
            </div>
          </div>

          <!-- STEP 4: Generate Keys -->
          <div class="wizard-step" id="step4">
            <h3>Step 4: Generate Cryptographic Identity</h3>
            <p style="color: var(--text-dim); margin-bottom: 20px;">Generating ECDSA P-256 key pair...</p>
            <div id="keyGenStatus"></div>
            <div class="wizard-buttons">
              <button class="btn btn-secondary" onclick="prevStep(4)">Back</button>
              <button class="btn" onclick="nextStep(4)">Generate & Continue</button>
            </div>
          </div>

          <!-- STEP 5: Review & Confirm -->
          <div class="wizard-step" id="step5">
            <h3>Step 5: Review & Confirm</h3>
            <div class="review-grid" id="reviewGrid"></div>
            <div class="wizard-buttons">
              <button class="btn btn-secondary" onclick="prevStep(5)">Back</button>
              <button class="btn" onclick="createAgent()">Create Agent</button>
            </div>
          </div>
        </div>
      </div>

      <!-- BROWSE AGENTS PAGE -->
      <div id="browse" class="page">
        <h1>Agent Browser</h1>
        <p class="subtitle">Discover and explore registered agents</p>

        <div class="filters">
          <div class="filter-group">
            <label>Type:</label>
            <select id="filterType" onchange="filterAgents()">
              <option value="all">All Types</option>
              <option value="openclaw">OpenClaw</option>
              <option value="rappter">Rappter</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Capability:</label>
            <select id="filterCapability" onchange="filterAgents()">
              <option value="all">All Capabilities</option>
              <option value="code-gen">code-gen</option>
              <option value="review">review</option>
              <option value="test">test</option>
              <option value="molt">molt</option>
              <option value="score">score</option>
              <option value="breed">breed</option>
              <option value="broadcast">broadcast</option>
            </select>
          </div>
        </div>

        <div class="agent-grid" id="agentGrid"></div>
      </div>

      <!-- AGENT PROFILE PAGE -->
      <div id="profile" class="page">
        <button class="btn btn-secondary" onclick="showPage('browse')" style="margin-bottom: 20px;">‚Üê Back to Browser</button>
        <div class="profile-view" id="profileView"></div>
      </div>

      <!-- VERIFY SIGNATURE PAGE -->
      <div id="verify" class="page">
        <h1>Signature Verification</h1>
        <p class="subtitle">Verify signed messages using agent public keys</p>

        <div class="verify-section">
          <div class="form-group">
            <label for="signedMessage">Signed Message JSON</label>
            <textarea id="signedMessage" placeholder='{"message": "...", "signature": "...", "timestamp": ...}'></textarea>
          </div>

          <div class="form-group">
            <label for="verifyAgentSelect">Agent to Verify Against</label>
            <select id="verifyAgentSelect"></select>
          </div>

          <button class="btn" onclick="verifySignature()">Verify Signature</button>

          <div id="verifyResult"></div>
        </div>
      </div>

      <!-- IMPORT/EXPORT PAGE -->
      <div id="import-export" class="page">
        <h1>Import/Export</h1>
        <p class="subtitle">Transfer agent identities between browsers</p>

        <div class="import-export">
          <h2>Export Agent</h2>
          <div class="form-group">
            <label for="exportAgentSelect">Select Agent</label>
            <select id="exportAgentSelect"></select>
          </div>
          <button class="btn" onclick="exportAgent()">Export to JSON</button>
          <div class="export-data" id="exportData"></div>

          <h2>Import Agent</h2>
          <div class="form-group">
            <label for="importData">Agent JSON</label>
            <textarea id="importData" placeholder='Paste agent JSON here...'></textarea>
          </div>
          <button class="btn" onclick="importAgent()">Import Agent</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // State
    let currentStep = 1;
    let wizardData = {
      name: '',
      type: '',
      capabilities: [],
      keyPair: null,
      publicKeyJWK: null,
      privateKeyJWK: null,
      agentId: ''
    };

    // LocalStorage keys
    const STORAGE_AGENTS = 'agentzoo-agents';
    const STORAGE_ACTIVE = 'agentzoo-active';
    const STORAGE_REPUTATION = 'agentzoo-reputation';

    // Initialize
    function init() {
      updateActiveAgentDisplay();
      loadAgents();
      populateAgentSelects();
    }

    // Navigation
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

      document.getElementById(pageId).classList.add('active');
      event.target.classList.add('active');

      if (pageId === 'browse') {
        loadAgents();
      } else if (pageId === 'verify') {
        populateAgentSelects();
      } else if (pageId === 'import-export') {
        populateAgentSelects();
      }
    }

    // Wizard navigation
    function nextStep(current) {
      if (current === 1) {
        const name = document.getElementById('agentName').value.trim();
        if (!name) {
          alert('Please enter an agent name');
          return;
        }
        wizardData.name = name;
      } else if (current === 2) {
        if (!wizardData.type) {
          alert('Please select an agent type');
          return;
        }
      } else if (current === 3) {
        const capabilities = Array.from(document.querySelectorAll('.capability-item input:checked')).map(cb => cb.value);
        if (capabilities.length === 0) {
          alert('Please select at least one capability');
          return;
        }
        wizardData.capabilities = capabilities;
      } else if (current === 4) {
        generateKeys();
        return; // generateKeys will handle navigation
      }

      goToStep(current + 1);
    }

    function prevStep(current) {
      goToStep(current - 1);
    }

    function goToStep(step) {
      document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
      document.getElementById('step' + step).classList.add('active');

      document.querySelectorAll('.progress-dot').forEach((dot, i) => {
        dot.classList.remove('active', 'completed');
        if (i + 1 < step) {
          dot.classList.add('completed');
        } else if (i + 1 === step) {
          dot.classList.add('active');
        }
      });

      currentStep = step;

      if (step === 5) {
        showReview();
      }
    }

    function selectType(type) {
      wizardData.type = type;
      document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
      event.target.closest('.type-card').classList.add('selected');
    }

    async function generateKeys() {
      const statusDiv = document.getElementById('keyGenStatus');
      statusDiv.innerHTML = '<p style="color: var(--accent);">Generating key pair...</p>';

      try {
        const keyPair = await crypto.subtle.generateKey(
          { name: 'ECDSA', namedCurve: 'P-256' },
          true,
          ['sign', 'verify']
        );

        const publicKeyJWK = await crypto.subtle.exportKey('jwk', keyPair.publicKey);
        const privateKeyJWK = await crypto.subtle.exportKey('jwk', keyPair.privateKey);

        wizardData.keyPair = keyPair;
        wizardData.publicKeyJWK = publicKeyJWK;
        wizardData.privateKeyJWK = privateKeyJWK;
        wizardData.agentId = await deriveAgentId(publicKeyJWK);

        statusDiv.innerHTML = `
          <div class="review-item">
            <div class="review-label">Agent ID</div>
            <div class="review-value fingerprint">${wizardData.agentId}</div>
          </div>
          <div class="review-item">
            <div class="review-label">Public Key Fingerprint</div>
            <div class="review-value fingerprint">${await getFingerprint(publicKeyJWK)}</div>
          </div>
          <p style="color: var(--green); margin-top: 15px;">‚úì Key pair generated successfully</p>
        `;

        setTimeout(() => goToStep(5), 1000);
      } catch (err) {
        statusDiv.innerHTML = `<p style="color: var(--red);">Error: ${err.message}</p>`;
      }
    }

    async function deriveAgentId(pubJWK) {
      const enc = new TextEncoder().encode(JSON.stringify(pubJWK));
      const hash = await crypto.subtle.digest('SHA-256', enc);
      const hex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
      return 'az-' + hex.substring(0, 16);
    }

    async function getFingerprint(jwk) {
      const enc = new TextEncoder().encode(JSON.stringify(jwk));
      const hash = await crypto.subtle.digest('SHA-256', enc);
      const hex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
      return hex.substring(0, 32);
    }

    async function showReview() {
      const grid = document.getElementById('reviewGrid');
      const fingerprint = await getFingerprint(wizardData.publicKeyJWK);

      grid.innerHTML = `
        <div class="review-item">
          <div class="review-label">Name</div>
          <div class="review-value">${wizardData.name}</div>
        </div>
        <div class="review-item">
          <div class="review-label">Type</div>
          <div class="review-value">${wizardData.type}</div>
        </div>
        <div class="review-item">
          <div class="review-label">Capabilities</div>
          <div class="review-value">${wizardData.capabilities.join(', ')}</div>
        </div>
        <div class="review-item">
          <div class="review-label">Agent ID</div>
          <div class="review-value fingerprint">${wizardData.agentId}</div>
        </div>
        <div class="review-item">
          <div class="review-label">Public Key Fingerprint</div>
          <div class="review-value fingerprint">${fingerprint}</div>
        </div>
      `;
    }

    function createAgent() {
      const agents = getAgents();

      const newAgent = {
        id: wizardData.agentId,
        name: wizardData.name,
        type: wizardData.type,
        capabilities: wizardData.capabilities,
        publicKeyJWK: wizardData.publicKeyJWK,
        privateKeyJWK: wizardData.privateKeyJWK,
        created: new Date().toISOString()
      };

      agents.push(newAgent);
      localStorage.setItem(STORAGE_AGENTS, JSON.stringify(agents));
      localStorage.setItem(STORAGE_ACTIVE, newAgent.id);

      // Initialize reputation
      const reputation = getReputation();
      reputation[newAgent.id] = {
        quality: [],
        timeliness: [],
        communication: []
      };
      localStorage.setItem(STORAGE_REPUTATION, JSON.stringify(reputation));

      alert('Agent created successfully!');
      resetWizard();
      updateActiveAgentDisplay();
      showPage('browse');
    }

    function resetWizard() {
      wizardData = {
        name: '',
        type: '',
        capabilities: [],
        keyPair: null,
        publicKeyJWK: null,
        privateKeyJWK: null,
        agentId: ''
      };
      document.getElementById('agentName').value = '';
      document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
      document.querySelectorAll('.capability-item input').forEach(cb => cb.checked = false);
      goToStep(1);
    }

    function getAgents() {
      const data = localStorage.getItem(STORAGE_AGENTS);
      return data ? JSON.parse(data) : [];
    }

    function getReputation() {
      const data = localStorage.getItem(STORAGE_REPUTATION);
      return data ? JSON.parse(data) : {};
    }

    function updateActiveAgentDisplay() {
      const activeId = localStorage.getItem(STORAGE_ACTIVE);
      const display = document.getElementById('activeAgentDisplay');

      if (activeId) {
        const agents = getAgents();
        const agent = agents.find(a => a.id === activeId);
        if (agent) {
          display.innerHTML = `
            <div class="active-agent-label">Active Agent:</div>
            <div class="active-agent-id">${agent.name} (${agent.id})</div>
          `;
          return;
        }
      }

      display.innerHTML = `
        <div class="active-agent-label">Active Agent:</div>
        <div class="active-agent-id">None</div>
      `;
    }

    function loadAgents() {
      const agents = getAgents();
      const grid = document.getElementById('agentGrid');

      if (agents.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ü§ñ</div>
            <p>No agents registered yet</p>
            <p>Create your first agent identity to get started</p>
          </div>
        `;
        return;
      }

      filterAgents();
    }

    function filterAgents() {
      const agents = getAgents();
      const typeFilter = document.getElementById('filterType').value;
      const capFilter = document.getElementById('filterCapability').value;
      const reputation = getReputation();

      let filtered = agents;

      if (typeFilter !== 'all') {
        filtered = filtered.filter(a => a.type === typeFilter);
      }

      if (capFilter !== 'all') {
        filtered = filtered.filter(a => a.capabilities.includes(capFilter));
      }

      const grid = document.getElementById('agentGrid');

      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <p>No agents match the current filters</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = filtered.map(agent => {
        const rep = reputation[agent.id] || { quality: [], timeliness: [], communication: [] };
        const avgScore = calculateAverageReputation(rep);

        return `
          <div class="agent-card" onclick="showProfile('${agent.id}')">
            <div class="agent-card-header">
              <div>
                <div class="agent-name">${agent.name}</div>
                <div class="agent-id">${agent.id}</div>
              </div>
              <div class="type-badge ${agent.type}">${agent.type}</div>
            </div>
            <div class="capability-tags">
              ${agent.capabilities.map(cap => `<span class="capability-tag">${cap}</span>`).join('')}
            </div>
            <div class="reputation-score">‚òÖ ${avgScore.toFixed(1)} reputation</div>
          </div>
        `;
      }).join('');
    }

    function calculateAverageReputation(rep) {
      const allScores = [...rep.quality, ...rep.timeliness, ...rep.communication];
      if (allScores.length === 0) return 0;
      return allScores.reduce((a, b) => a + b, 0) / allScores.length;
    }

    async function showProfile(agentId) {
      const agents = getAgents();
      const agent = agents.find(a => a.id === agentId);
      if (!agent) return;

      const reputation = getReputation();
      const rep = reputation[agentId] || { quality: [], timeliness: [], communication: [] };

      const avgQuality = rep.quality.length > 0 ? (rep.quality.reduce((a, b) => a + b, 0) / rep.quality.length).toFixed(1) : '0.0';
      const avgTime = rep.timeliness.length > 0 ? (rep.timeliness.reduce((a, b) => a + b, 0) / rep.timeliness.length).toFixed(1) : '0.0';
      const avgComm = rep.communication.length > 0 ? (rep.communication.reduce((a, b) => a + b, 0) / rep.communication.length).toFixed(1) : '0.0';

      const fingerprint = await getFingerprint(agent.publicKeyJWK);
      const activeId = localStorage.getItem(STORAGE_ACTIVE);

      const profileView = document.getElementById('profileView');
      profileView.innerHTML = `
        <div class="profile-header">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
              <div class="profile-name">${agent.name}</div>
              <div class="type-badge ${agent.type}">${agent.type}</div>
            </div>
            ${activeId !== agent.id ? `<button class="btn" onclick="setActiveAgent('${agent.id}')">Set Active</button>` : '<span style="color: var(--green);">‚úì Active</span>'}
          </div>
        </div>

        <div class="profile-row">
          <span class="profile-label">Agent ID</span>
          <span class="profile-value fingerprint">${agent.id}</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">Public Key Fingerprint</span>
          <span class="profile-value fingerprint">${fingerprint}</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">Capabilities</span>
          <span class="profile-value">${agent.capabilities.join(', ')}</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">Created</span>
          <span class="profile-value">${new Date(agent.created).toLocaleString()}</span>
        </div>

        <h3 style="margin-top: 30px;">Reputation Scores</h3>
        <div class="reputation-stats">
          <div class="stat-card">
            <div class="stat-value">${avgQuality}</div>
            <div class="stat-label">Quality</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${avgTime}</div>
            <div class="stat-label">Timeliness</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${avgComm}</div>
            <div class="stat-label">Communication</div>
          </div>
        </div>

        <div style="margin-top: 30px;">
          <button class="btn btn-danger" onclick="deleteAgent('${agent.id}')">Delete Agent</button>
        </div>
      `;

      showPage('profile');
    }

    function setActiveAgent(agentId) {
      localStorage.setItem(STORAGE_ACTIVE, agentId);
      updateActiveAgentDisplay();
      showProfile(agentId);
    }

    function deleteAgent(agentId) {
      if (!confirm('Are you sure you want to delete this agent? This cannot be undone.')) {
        return;
      }

      const agents = getAgents();
      const filtered = agents.filter(a => a.id !== agentId);
      localStorage.setItem(STORAGE_AGENTS, JSON.stringify(filtered));

      const activeId = localStorage.getItem(STORAGE_ACTIVE);
      if (activeId === agentId) {
        localStorage.removeItem(STORAGE_ACTIVE);
        updateActiveAgentDisplay();
      }

      alert('Agent deleted');
      showPage('browse');
    }

    function populateAgentSelects() {
      const agents = getAgents();
      const verifySelect = document.getElementById('verifyAgentSelect');
      const exportSelect = document.getElementById('exportAgentSelect');

      const options = agents.map(a => `<option value="${a.id}">${a.name} (${a.id})</option>`).join('');

      if (verifySelect) {
        verifySelect.innerHTML = agents.length > 0 ? options : '<option>No agents available</option>';
      }

      if (exportSelect) {
        exportSelect.innerHTML = agents.length > 0 ? options : '<option>No agents available</option>';
      }
    }

    async function verifySignature() {
      const messageJson = document.getElementById('signedMessage').value.trim();
      const agentId = document.getElementById('verifyAgentSelect').value;
      const resultDiv = document.getElementById('verifyResult');

      if (!messageJson) {
        resultDiv.innerHTML = '<div class="verify-result invalid">Please enter a signed message</div>';
        return;
      }

      const agents = getAgents();
      const agent = agents.find(a => a.id === agentId);

      if (!agent) {
        resultDiv.innerHTML = '<div class="verify-result invalid">Agent not found</div>';
        return;
      }

      try {
        const signedMsg = JSON.parse(messageJson);

        if (!signedMsg.message || !signedMsg.signature) {
          resultDiv.innerHTML = '<div class="verify-result invalid">Invalid message format (missing message or signature)</div>';
          return;
        }

        const publicKey = await crypto.subtle.importKey(
          'jwk',
          agent.publicKeyJWK,
          { name: 'ECDSA', namedCurve: 'P-256' },
          false,
          ['verify']
        );

        const signature = Uint8Array.from(atob(signedMsg.signature), c => c.charCodeAt(0));
        const data = new TextEncoder().encode(signedMsg.message);

        const valid = await crypto.subtle.verify(
          { name: 'ECDSA', hash: 'SHA-256' },
          publicKey,
          signature,
          data
        );

        if (valid) {
          resultDiv.innerHTML = `<div class="verify-result valid">‚úì VALID - Signature verified for agent ${agent.name}</div>`;
        } else {
          resultDiv.innerHTML = `<div class="verify-result invalid">‚úó INVALID - Signature does not match</div>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<div class="verify-result invalid">Error: ${err.message}</div>`;
      }
    }

    function exportAgent() {
      const agentId = document.getElementById('exportAgentSelect').value;
      const agents = getAgents();
      const agent = agents.find(a => a.id === agentId);

      if (!agent) {
        alert('Agent not found');
        return;
      }

      const exportData = JSON.stringify(agent, null, 2);
      const dataDiv = document.getElementById('exportData');
      dataDiv.textContent = exportData;

      // Create download
      const blob = new Blob([exportData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `agentzoo-${agent.name}-${agent.id}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importAgent() {
      const importData = document.getElementById('importData').value.trim();

      if (!importData) {
        alert('Please paste agent JSON data');
        return;
      }

      try {
        const agent = JSON.parse(importData);

        // Validate required fields
        if (!agent.id || !agent.name || !agent.type || !agent.capabilities || !agent.publicKeyJWK || !agent.privateKeyJWK) {
          alert('Invalid agent data: missing required fields');
          return;
        }

        const agents = getAgents();

        // Check if agent already exists
        if (agents.find(a => a.id === agent.id)) {
          if (!confirm('An agent with this ID already exists. Overwrite?')) {
            return;
          }
          // Remove existing
          const filtered = agents.filter(a => a.id !== agent.id);
          localStorage.setItem(STORAGE_AGENTS, JSON.stringify(filtered));
        }

        // Add agent
        agents.push(agent);
        localStorage.setItem(STORAGE_AGENTS, JSON.stringify(agents));

        // Initialize reputation if needed
        const reputation = getReputation();
        if (!reputation[agent.id]) {
          reputation[agent.id] = {
            quality: [],
            timeliness: [],
            communication: []
          };
          localStorage.setItem(STORAGE_REPUTATION, JSON.stringify(reputation));
        }

        alert('Agent imported successfully!');
        document.getElementById('importData').value = '';
        populateAgentSelects();
      } catch (err) {
        alert('Error parsing JSON: ' + err.message);
      }
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
