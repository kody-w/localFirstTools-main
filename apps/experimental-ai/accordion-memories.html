<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accordion Memories - Interactive Memory Palace</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a1520;color:#d4c4a0;font-family:Georgia,serif;overflow:hidden}
canvas{display:block;cursor:pointer}
.ov{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(20,15,25,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
.ov h1{font-size:2.8rem;color:#e4d4b4;text-shadow:0 0 30px rgba(228,212,180,.3);margin-bottom:8px;font-family:Georgia,serif}
.ov h2{font-size:1.2rem;color:#8a7a6a;margin-bottom:30px;font-weight:normal;font-style:italic}
.btn{background:rgba(100,80,60,.3);border:1px solid rgba(200,180,140,.4);color:#d4c4a0;padding:12px 32px;margin:6px;font-size:1rem;border-radius:8px;cursor:pointer;transition:all .3s;font-family:Georgia,serif}
.btn:hover{background:rgba(140,120,80,.4);border-color:rgba(228,212,180,.6);transform:scale(1.03)}
.panel{position:fixed;top:0;right:0;width:280px;height:100%;background:rgba(20,15,25,.95);border-left:1px solid rgba(200,180,140,.2);padding:16px;z-index:50;overflow-y:auto;font-size:.85rem;transform:translateX(100%);transition:transform .3s}
.panel.open{transform:translateX(0)}
.panel h3{color:#e4d4b4;margin-bottom:12px;font-size:1rem}
.panel input,.panel textarea,.panel select{width:100%;padding:6px 8px;margin:4px 0;background:rgba(60,50,40,.5);border:1px solid rgba(200,180,140,.3);color:#d4c4a0;border-radius:4px;font-family:Georgia,serif;font-size:.85rem}
.panel button{display:block;width:100%;padding:8px;margin:6px 0}
.toggle-panel{position:fixed;top:10px;right:10px;z-index:60;background:rgba(100,80,60,.4);border:1px solid rgba(200,180,140,.3);color:#d4c4a0;padding:6px 12px;border-radius:6px;cursor:pointer;font-family:Georgia,serif;font-size:.8rem}
.hud{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);color:rgba(200,180,140,.5);font-size:.75rem;z-index:20}
</style>
</head>
<body>
<canvas id="c"></canvas>
<button class="toggle-panel" onclick="togglePanel()">+ Add Memory</button>
<div class="panel" id="panel">
  <h3>Add New Memory</h3>
  <input type="text" id="inp-title" placeholder="Memory title...">
  <input type="date" id="inp-date">
  <textarea id="inp-content" rows="3" placeholder="What happened..."></textarea>
  <select id="inp-emotion">
    <option value="joy">Joy</option><option value="love">Love</option>
    <option value="peace">Peace</option><option value="sadness">Sadness</option>
    <option value="wonder">Wonder</option><option value="fear">Fear</option>
    <option value="nostalgia">Nostalgia</option><option value="triumph">Triumph</option>
  </select>
  <button class="btn" onclick="addMemory()">Add to Accordion</button>
  <hr style="border-color:rgba(200,180,140,.2);margin:12px 0">
  <h3>Tools</h3>
  <button class="btn" onclick="exportMem()">Export JSON</button>
  <button class="btn" onclick="document.getElementById('imp-file').click()">Import JSON</button>
  <input type="file" id="imp-file" accept=".json" style="display:none">
  <button class="btn" onclick="shuffleMode=!shuffleMode">Toggle Shuffle View</button>
  <button class="btn" onclick="autoPlay()">Auto-Play Timeline</button>
  <hr style="border-color:rgba(200,180,140,.2);margin:12px 0">
  <h3>Stats</h3>
  <div id="stats" style="color:#8a7a6a;line-height:1.8"></div>
</div>
<div class="hud" id="hud">Click pages to expand | Scroll to navigate | Arrow keys to browse</div>
<script>
const C=document.getElementById('c'),X=C.getContext('2d');
let W,H;function resize(){W=C.width=innerWidth;H=C.height=innerHeight}
addEventListener('resize',resize);resize();

/* ===== AUDIO ===== */
class SFX{
  constructor(){this.c=null;this.ok=false}
  init(){if(this.ok)return;try{this.c=new(AudioContext||webkitAudioContext)();this.ok=true}catch(e){}}
  tone(t,f,d,v){if(!this.c)return;const o=this.c.createOscillator(),g=this.c.createGain();
    o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v||.08,this.c.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,this.c.currentTime+d);o.connect(g).connect(this.c.destination);o.start();o.stop(this.c.currentTime+d)}
  page(){this.tone('sine',400,.15,.06);setTimeout(()=>this.tone('sine',500,.1,.04),60)}
  fold(){this.tone('triangle',300,.2,.05);this.tone('sine',350,.15,.04)}
  add(){this.tone('sine',600,.2,.08);setTimeout(()=>this.tone('sine',800,.15,.06),100);setTimeout(()=>this.tone('sine',1000,.1,.04),200)}
  reveal(){this.tone('sine',500,.3,.06);setTimeout(()=>this.tone('triangle',700,.2,.04),150)}
  ambient(){const f=[261,329,392,523][~~(Math.random()*4)];this.tone('sine',f,.8,.03)}
}
const sfx=new SFX();

/* ===== PARTICLES ===== */
const particles=[];
class Ptc{constructor(x,y,vx,vy,col,life,sz){this.x=x;this.y=y;this.vx=vx;this.vy=vy;this.col=col;this.life=life;this.ml=life;this.sz=sz||2}
  upd(dt){this.x+=this.vx*dt;this.y+=this.vy*dt;this.vy-=15*dt;this.life-=dt}
  draw(){const a=Math.max(0,this.life/this.ml);X.globalAlpha=a*.6;X.fillStyle=this.col;X.beginPath();X.arc(this.x,this.y,this.sz*a,0,Math.PI*2);X.fill();X.globalAlpha=1}}
function emit(x,y,col,n){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=30+Math.random()*40;particles.push(new Ptc(x,y,Math.cos(a)*s,Math.sin(a)*s,col,.8+Math.random(),1+Math.random()*2))}}

/* ===== EMOTION SYSTEM ===== */
const EMOTIONS={
  joy:{col:'#f4d03f',glow:'rgba(244,208,63,.3)',icon:'*',ambient:'#fff8dc'},
  love:{col:'#e74c3c',glow:'rgba(231,76,60,.3)',icon:'<3',ambient:'#fdd'},
  peace:{col:'#82e0aa',glow:'rgba(130,224,170,.3)',icon:'~',ambient:'#e8fdf5'},
  sadness:{col:'#5dade2',glow:'rgba(93,173,226,.3)',icon:'.',ambient:'#d6eaf8'},
  wonder:{col:'#bb8fce',glow:'rgba(187,143,206,.3)',icon:'!',ambient:'#f4ecf7'},
  fear:{col:'#566573',glow:'rgba(86,101,115,.3)',icon:'?',ambient:'#d5d8dc'},
  nostalgia:{col:'#dc7633',glow:'rgba(220,118,51,.3)',icon:'^',ambient:'#fdebd0'},
  triumph:{col:'#f1c40f',glow:'rgba(241,196,15,.4)',icon:'+',ambient:'#fef9e7'},
};

/* ===== DATA ===== */
let memories=[];
let selected=-1,scrollX=0,targetScrollX=0,expandedIdx=-1;
let shuffleMode=false,autoPlaying=false,autoTimer=0;
let ambientTimer=0,time=0;

const CONNECTIONS=[
  'Between these moments, time folded into itself...',
  'Here lies the space where one memory became another...',
  'The echo of what was meets the shadow of what came...',
  'In this crease, the past whispers to itself...',
  'Two moments touch, creating something unseen...',
  'A bridge of feeling connects these pages...',
  'The accordion breathes between these folds...',
  'One ending becomes another beginning...',
];

function loadMem(){
  try{const d=JSON.parse(localStorage.getItem('accordion_memories_v2'));if(d&&d.length)memories=d}catch(e){}
  if(!memories.length){
    memories=[
      {id:1,title:'First Light',date:'2000-01-01',content:'The beginning of everything. A moment of pure potential.',emotion:'wonder',connections:0},
      {id:2,title:'Learning to Walk',date:'2001-06-15',content:'Falling down, getting up. The first steps toward independence.',emotion:'joy',connections:0},
      {id:3,title:'First Friend',date:'2005-09-01',content:'A stranger became someone who understood.',emotion:'love',connections:0},
      {id:4,title:'Storm Night',date:'2008-03-12',content:'The sky split open and we huddled together, counting seconds between thunder.',emotion:'fear',connections:0},
      {id:5,title:'Graduation',date:'2010-06-20',content:'Standing at the edge of everything known, looking out at the vast unknown.',emotion:'triumph',connections:0},
      {id:6,title:'Old Photograph',date:'2015-11-30',content:'Found it in a drawer. Everyone smiling. Some of those smiles exist only here now.',emotion:'nostalgia',connections:0},
      {id:7,title:'Quiet Morning',date:'2020-04-15',content:'Coffee steam rising. Birds outside. Nothing needed to be done or said.',emotion:'peace',connections:0},
      {id:8,title:'The Letter',date:'2022-08-10',content:'Words that changed the shape of tomorrow.',emotion:'sadness',connections:0},
    ];
  }
}
function saveMem(){localStorage.setItem('accordion_memories_v2',JSON.stringify(memories))}

function addMemory(){
  sfx.init();
  const title=document.getElementById('inp-title').value||'Untitled';
  const date=document.getElementById('inp-date').value||new Date().toISOString().split('T')[0];
  const content=document.getElementById('inp-content').value||'A moment in time...';
  const emotion=document.getElementById('inp-emotion').value;
  memories.push({id:Date.now(),title,date,content,emotion,connections:0});
  memories.sort((a,b)=>new Date(a.date)-new Date(b.date));
  saveMem();sfx.add();
  document.getElementById('inp-title').value='';document.getElementById('inp-content').value='';
  emit(W/2,H/2,EMOTIONS[emotion].col,20);
  updateStats();
}

function exportMem(){
  const blob=new Blob([JSON.stringify(memories,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='accordion-memories.json';a.click();
}
document.getElementById('imp-file').onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{memories=JSON.parse(ev.target.result);saveMem();updateStats()};r.readAsText(f);
};

function togglePanel(){
  const p=document.getElementById('panel');p.classList.toggle('open');
}

function autoPlay(){
  autoPlaying=!autoPlaying;autoTimer=0;expandedIdx=autoPlaying?0:-1;
}

function updateStats(){
  const counts={};memories.forEach(m=>{counts[m.emotion]=(counts[m.emotion]||0)+1});
  let html='<div>Total Memories: '+memories.length+'</div>';
  for(const[e,c]of Object.entries(counts)){
    html+='<div style="color:'+EMOTIONS[e].col+'">'+e+': '+c+'</div>';
  }
  if(memories.length>1){
    const span=new Date(memories[memories.length-1].date)-new Date(memories[0].date);
    const years=~~(span/31557600000);const months=~~((span%31557600000)/2629800000);
    html+='<div>Span: '+years+'y '+months+'m</div>';
  }
  document.getElementById('stats').innerHTML=html;
}

/* ===== RENDERING ===== */
const PAGE_W=180,PAGE_H=260,PAGE_GAP=30;

function getPageX(i){
  const totalW=memories.length*(PAGE_W+PAGE_GAP);
  const startX=(W-Math.min(totalW,W*.8))/2;
  return startX+i*(PAGE_W+PAGE_GAP)-scrollX;
}

function drawPage(mem,x,y,w,h,expanded,idx){
  const em=EMOTIONS[mem.emotion]||EMOTIONS.wonder;
  const hover=idx===selected;

  // Shadow
  X.save();
  X.shadowColor='rgba(0,0,0,.4)';X.shadowBlur=expanded?20:10;X.shadowOffsetY=expanded?8:4;

  // Page background
  const grad=X.createLinearGradient(x,y,x,y+h);
  grad.addColorStop(0,'#f4e4c4');grad.addColorStop(1,'#e4d4b4');
  X.fillStyle=grad;
  X.beginPath();X.moveTo(x+4,y);X.lineTo(x+w-4,y);X.quadraticCurveTo(x+w,y,x+w,y+4);
  X.lineTo(x+w,y+h-4);X.quadraticCurveTo(x+w,y+h,x+w-4,y+h);X.lineTo(x+4,y+h);
  X.quadraticCurveTo(x,y+h,x,y+h-4);X.lineTo(x,y+4);X.quadraticCurveTo(x,y,x+4,y);X.closePath();
  X.fill();
  X.restore();

  // Glow for expanded/hovered
  if(expanded||hover){
    X.save();X.globalAlpha=.4;X.shadowColor=em.col;X.shadowBlur=30;
    X.fillStyle=em.glow;X.fillRect(x-5,y-5,w+10,h+10);X.restore();
  }

  // Fold crease
  const creaseGrad=X.createLinearGradient(x,y,x+4,y);
  creaseGrad.addColorStop(0,'rgba(0,0,0,.15)');creaseGrad.addColorStop(1,'transparent');
  X.fillStyle=creaseGrad;X.fillRect(x,y,4,h);

  // Age staining effect
  X.globalAlpha=.05;X.fillStyle='#8a7a6a';
  for(let i=0;i<3;i++){X.beginPath();X.arc(x+Math.random()*w,y+Math.random()*h,10+Math.random()*20,0,Math.PI*2);X.fill()}
  X.globalAlpha=1;

  // Title
  X.fillStyle='#4a3a2a';X.font='bold 13px Georgia,serif';X.textAlign='left';
  X.fillText(mem.title,x+12,y+24,w-24);

  // Date
  X.fillStyle='#8a7a6a';X.font='10px Georgia,serif';
  X.fillText(mem.date,x+12,y+40);

  // Emotion indicator
  X.fillStyle=em.col;X.globalAlpha=.8;
  X.beginPath();X.arc(x+w-16,y+16,8,0,Math.PI*2);X.fill();X.globalAlpha=1;
  X.fillStyle='#fff';X.font='bold 8px sans-serif';X.textAlign='center';
  X.fillText(em.icon,x+w-16,y+19);
  X.textAlign='left';

  // Content
  if(expanded){
    X.fillStyle='#5a4a3a';X.font='11px Georgia,serif';
    const words=mem.content.split(' ');let line='',ly=y+65;
    for(const word of words){
      const test=line+(line?' ':'')+word;
      if(X.measureText(test).width>w-24){X.fillText(line,x+12,ly);ly+=16;line=word}
      else line=test;
    }
    X.fillText(line,x+12,ly);

    // Connection text
    if(idx>0){
      const conn=CONNECTIONS[idx%CONNECTIONS.length];
      X.globalAlpha=.6;X.fillStyle='#6a5a4a';X.font='italic 9px Georgia,serif';
      X.fillText(conn,x+12,y+h-20,w-24);X.globalAlpha=1;
    }

    // Border glow
    X.strokeStyle=em.col;X.lineWidth=2;X.globalAlpha=.5;
    X.strokeRect(x+1,y+1,w-2,h-2);X.globalAlpha=1;
  } else {
    // Preview text (first line only)
    X.fillStyle='#7a6a5a';X.font='10px Georgia,serif';
    const preview=mem.content.substring(0,40)+(mem.content.length>40?'...':'');
    X.fillText(preview,x+12,y+60,w-24);
  }

  // Page number
  X.fillStyle='#aaa';X.font='9px Georgia,serif';X.textAlign='center';
  X.fillText((idx+1)+'',x+w/2,y+h-8);X.textAlign='left';
}

function drawConnectionLine(x1,x2,y,emotion){
  const em=EMOTIONS[emotion]||EMOTIONS.wonder;
  const mx=(x1+x2)/2;
  X.strokeStyle=em.col;X.lineWidth=1;X.globalAlpha=.3;
  X.setLineDash([3,3]);
  X.beginPath();X.moveTo(x1,y);X.quadraticCurveTo(mx,y-30,x2,y);X.stroke();
  X.setLineDash([]);X.globalAlpha=1;
}

function drawTimeline(){
  const y=H-50;
  if(memories.length<2)return;
  // Timeline bar
  X.fillStyle='rgba(200,180,140,.1)';X.fillRect(40,y,W-80,2);
  // Markers
  memories.forEach((m,i)=>{
    const x=getPageX(i)+PAGE_W/2;
    if(x<-20||x>W+20)return;
    const em=EMOTIONS[m.emotion]||EMOTIONS.wonder;
    X.fillStyle=i===expandedIdx?em.col:'rgba(200,180,140,.3)';
    X.beginPath();X.arc(x,y,i===expandedIdx?5:3,0,Math.PI*2);X.fill();
  });
}

/* ===== MAIN RENDER ===== */
function render(){
  // Background
  const bg=X.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'#1a1520');bg.addColorStop(.5,'#2a2030');bg.addColorStop(1,'#1a1520');
  X.fillStyle=bg;X.fillRect(0,0,W,H);

  // Ambient floating particles (dust motes)
  const t=time;
  X.globalAlpha=.15;X.fillStyle='#d4c4a0';
  for(let i=0;i<20;i++){
    const px=(i*197.3+t*10)%W;
    const py=H*.2+Math.sin(t*.5+i*1.7)*H*.3;
    const sz=1+Math.sin(t+i*2.3)*.5;
    X.beginPath();X.arc(px,py,sz,0,Math.PI*2);X.fill();
  }
  X.globalAlpha=1;

  // Pages
  const centerY=H/2-PAGE_H/2-20;
  const order=shuffleMode?[...Array(memories.length).keys()].sort(()=>Math.random()-.5):[...Array(memories.length).keys()];

  // Connection lines
  for(let i=1;i<memories.length;i++){
    const x1=getPageX(i-1)+PAGE_W;
    const x2=getPageX(i);
    if(x1>-100&&x2<W+100){
      drawConnectionLine(x1,x2,centerY+PAGE_H/2,memories[i].emotion);
    }
  }

  // Draw pages
  memories.forEach((m,i)=>{
    const x=getPageX(i);
    if(x<-PAGE_W-50||x>W+50)return;
    const expanded=i===expandedIdx;
    const pageH=expanded?PAGE_H+60:PAGE_H;
    const pageY=expanded?centerY-30:centerY;
    drawPage(m,x,pageY,PAGE_W,pageH,expanded,i);
  });

  // Particles
  particles.forEach(p=>p.draw());

  // Timeline
  drawTimeline();

  // Title
  X.fillStyle='rgba(228,212,180,.15)';X.font='italic 14px Georgia,serif';X.textAlign='center';
  X.fillText('Accordion Memories',W/2,30);X.textAlign='left';
}

/* ===== INPUT ===== */
let dragStartX=0,dragging=false;
C.addEventListener('mousedown',e=>{sfx.init();dragStartX=e.clientX+scrollX;dragging=true});
C.addEventListener('mousemove',e=>{
  if(dragging){targetScrollX=dragStartX-e.clientX;scrollX+=(targetScrollX-scrollX)*.3}
  // Hover detection
  selected=-1;
  const centerY=H/2-PAGE_H/2-20;
  for(let i=memories.length-1;i>=0;i--){
    const x=getPageX(i);
    if(e.clientX>=x&&e.clientX<=x+PAGE_W&&e.clientY>=centerY&&e.clientY<=centerY+PAGE_H){selected=i;break}
  }
});
C.addEventListener('mouseup',e=>{
  if(dragging&&Math.abs(e.clientX+scrollX-dragStartX)<5){
    // Click
    const centerY=H/2-PAGE_H/2-20;
    for(let i=memories.length-1;i>=0;i--){
      const x=getPageX(i);
      if(e.clientX>=x&&e.clientX<=x+PAGE_W&&e.clientY>=centerY&&e.clientY<=centerY+PAGE_H+60){
        expandedIdx=expandedIdx===i?-1:i;
        sfx.page();
        if(expandedIdx>=0)emit(x+PAGE_W/2,centerY+PAGE_H/2,EMOTIONS[memories[i].emotion].col,12);
        break;
      }
    }
  }
  dragging=false;
});
C.addEventListener('wheel',e=>{targetScrollX+=e.deltaY*.5;scrollX+=(targetScrollX-scrollX)*.3},{passive:true});
C.addEventListener('touchstart',e=>{sfx.init();dragStartX=e.touches[0].clientX+scrollX;dragging=true},{passive:true});
C.addEventListener('touchmove',e=>{if(dragging)targetScrollX=dragStartX-e.touches[0].clientX},{passive:true});
C.addEventListener('touchend',e=>{dragging=false},{passive:true});

addEventListener('keydown',e=>{
  if(e.key==='ArrowRight'){expandedIdx=Math.min(expandedIdx+1,memories.length-1);sfx.page();
    targetScrollX=expandedIdx*(PAGE_W+PAGE_GAP)-W/2+PAGE_W/2}
  if(e.key==='ArrowLeft'){expandedIdx=Math.max(expandedIdx-1,0);sfx.page();
    targetScrollX=expandedIdx*(PAGE_W+PAGE_GAP)-W/2+PAGE_W/2}
  if(e.key==='Escape'){expandedIdx=-1}
  if(e.key==='Delete'&&expandedIdx>=0){memories.splice(expandedIdx,1);expandedIdx=-1;saveMem();updateStats()}
});

/* ===== GAME LOOP ===== */
let lt=0;
function loop(t){
  const dt=Math.min((t-lt)/1000,.05);lt=t;time=t*.001;

  // Smooth scroll
  scrollX+=(targetScrollX-scrollX)*.08;
  // Clamp scroll
  const maxScroll=Math.max(0,memories.length*(PAGE_W+PAGE_GAP)-W+100);
  targetScrollX=Math.max(-100,Math.min(maxScroll,targetScrollX));

  // Particles
  for(let i=particles.length-1;i>=0;i--){particles[i].upd(dt);if(particles[i].life<=0)particles.splice(i,1)}

  // Auto-play
  if(autoPlaying){
    autoTimer+=dt;
    if(autoTimer>3){
      autoTimer=0;expandedIdx++;
      if(expandedIdx>=memories.length){expandedIdx=-1;autoPlaying=false}
      else{sfx.page();targetScrollX=expandedIdx*(PAGE_W+PAGE_GAP)-W/2+PAGE_W/2}
    }
  }

  // Ambient sound
  ambientTimer+=dt;
  if(ambientTimer>8){ambientTimer=0;sfx.ambient()}

  render();
  requestAnimationFrame(loop);
}

loadMem();updateStats();requestAnimationFrame(loop);
</script>
</body>
</html>