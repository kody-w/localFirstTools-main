<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamics 365 Local Simulator</title>
<meta name="description" content="Local-first Dynamics 365 CRM simulator with schema validation, JSON import/export, and live sync pipeline to real D365 instances">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#0f0f13;--surface:#1a1a24;--surface2:#22223a;--surface3:#2a2a44;
--border:#333358;--text:#e0e0f0;--dim:#8888aa;--accent:#5b7fff;
--accent2:#7b5bff;--green:#3ddc84;--red:#ff4466;--orange:#ffaa33;
--yellow:#ffe066;--cyan:#00d4ff;
--font:'Segoe UI',system-ui,-apple-system,sans-serif;
--mono:'Cascadia Code','Fira Code','SF Mono',monospace;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
.app{display:grid;grid-template-rows:auto auto 1fr auto;height:100vh}
header{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
header h1{font-size:18px;font-weight:600;white-space:nowrap}
header h1 span{color:var(--accent)}
.header-actions{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
.mode-badge{font-size:11px;padding:3px 10px;border-radius:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.mode-badge.edit{background:#3ddc8433;color:var(--green);border:1px solid var(--green)}
.mode-badge.readonly{background:#ff446633;color:var(--red);border:1px solid var(--red)}
.breadcrumb{background:var(--surface);border-bottom:1px solid var(--border);padding:6px 20px;font-size:12px;display:flex;align-items:center;gap:6px;min-height:32px}
.breadcrumb a{color:var(--accent);cursor:pointer;text-decoration:none}.breadcrumb a:hover{text-decoration:underline}
.breadcrumb .sep{color:var(--dim)}
.breadcrumb .current{color:var(--text);font-weight:600}
.main{display:grid;grid-template-columns:200px 1fr 340px;overflow:hidden}
.sidebar{background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;padding:8px 0}
.sidebar-section{padding:4px 12px;margin-top:8px}
.sidebar-section label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);font-weight:600}
.entity-btn{display:flex;align-items:center;gap:10px;padding:10px 16px;width:100%;border:none;background:none;color:var(--text);cursor:pointer;font-size:13px;text-align:left;transition:.15s}
.entity-btn:hover{background:var(--surface2)}
.entity-btn.active{background:var(--accent)22;color:var(--accent);border-right:3px solid var(--accent)}
.entity-btn .count{margin-left:auto;background:var(--surface3);color:var(--dim);font-size:11px;padding:1px 7px;border-radius:8px;font-weight:600}
.entity-btn.active .count{background:var(--accent)33;color:var(--accent)}
.entity-icon{width:20px;text-align:center;font-size:14px;opacity:.7}
.content{overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:7px 14px;border:1px solid var(--border);background:var(--surface2);color:var(--text);border-radius:6px;cursor:pointer;font-size:12px;font-family:var(--font);transition:.15s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{background:var(--surface3);border-color:var(--accent)}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn.primary:hover{filter:brightness(1.15)}
.btn.danger{border-color:var(--red);color:var(--red)}.btn.danger:hover{background:var(--red)22}
.btn.success{border-color:var(--green);color:var(--green)}.btn.success:hover{background:var(--green)22}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn-sm{padding:4px 8px;font-size:11px}
.search-box{flex:1;min-width:150px;padding:7px 12px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:6px;font-size:12px;font-family:var(--font)}
.search-box:focus{outline:none;border-color:var(--accent)}
.table-wrap{flex:1;overflow:auto;border:1px solid var(--border);border-radius:8px;background:var(--surface)}
table{width:100%;border-collapse:collapse;font-size:12px}
thead{position:sticky;top:0;z-index:2}
th{background:var(--surface2);padding:8px 12px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none}
th:hover{color:var(--accent)}
td{padding:7px 12px;border-bottom:1px solid var(--border)33;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
tr:hover td{background:var(--surface2)88}
tr.selected td{background:var(--accent)15}
tr{cursor:pointer}
.cell-link{color:var(--accent);cursor:pointer;text-decoration:none;font-weight:500}.cell-link:hover{text-decoration:underline}
.cell-status{font-size:11px;padding:2px 8px;border-radius:10px;font-weight:600}
.cell-status.active,.cell-status.synced{background:#3ddc8422;color:var(--green)}
.cell-status.inactive{background:#ff446622;color:var(--red)}
.cell-status.new{background:#5b7fff22;color:var(--accent)}
.cell-status.modified{background:#ffaa3322;color:var(--orange)}
.cell-money{font-family:var(--mono);color:var(--green)}
.cell-pct{font-family:var(--mono);color:var(--cyan)}
.right-panel{background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.panel-tabs{display:flex;border-bottom:1px solid var(--border)}
.panel-tab{flex:1;padding:10px;text-align:center;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;cursor:pointer;color:var(--dim);border-bottom:2px solid transparent;transition:.15s}
.panel-tab:hover{color:var(--text)}
.panel-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.panel-content{flex:1;overflow-y:auto;padding:12px}
.field-group{margin-bottom:12px}
.field-group label{display:block;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);margin-bottom:4px;font-weight:600}
.field-group input,.field-group select,.field-group textarea{width:100%;padding:7px 10px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:5px;font-size:12px;font-family:var(--font)}
.field-group input:focus,.field-group select:focus,.field-group textarea:focus{outline:none;border-color:var(--accent)}
.field-group textarea{min-height:60px;resize:vertical}
.field-group .validation-error{font-size:10px;color:var(--red);margin-top:2px}
.field-group input.invalid,.field-group select.invalid{border-color:var(--red)}
.field-row{display:flex;gap:6px;align-items:flex-start}
.field-row>:first-child{flex:1}
.goto-btn{width:26px;height:26px;border:1px solid var(--accent);background:var(--accent)18;color:var(--accent);border-radius:5px;cursor:pointer;font-size:12px;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0;padding:0}
.goto-btn:hover{background:var(--accent);color:#fff}
.ai-btn{width:26px;height:26px;border:1px solid var(--accent2);background:var(--accent2)18;color:var(--accent2);border-radius:5px;cursor:pointer;font-size:14px;display:inline-flex;align-items:center;justify-content:center;transition:.2s;flex-shrink:0;padding:0}
.ai-btn:hover{background:var(--accent2);color:#fff;box-shadow:0 0 10px var(--accent2)66;transform:scale(1.1)}
.ai-btn.generating{animation:sparkle .6s ease infinite;pointer-events:none}
@keyframes sparkle{0%,100%{box-shadow:0 0 4px var(--accent2)44}50%{box-shadow:0 0 16px var(--accent2)aa;transform:scale(1.15)}}
.ai-toolbar{display:flex;gap:6px;align-items:center;padding:8px 12px;background:var(--accent2)0d;border:1px solid var(--accent2)33;border-radius:8px}
.ai-toolbar-label{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--accent2);font-weight:600}
.ai-context-badge{font-size:9px;padding:2px 6px;border-radius:8px;background:var(--accent2)15;color:var(--accent2);font-weight:600}
/* Subgrid */
.subgrid{margin-top:16px;border:1px solid var(--border);border-radius:8px;overflow:hidden}
.subgrid-header{display:flex;align-items:center;padding:8px 12px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--dim)}
.subgrid-header .sg-count{margin-left:auto;font-size:10px;padding:1px 6px;border-radius:6px;background:var(--surface3);color:var(--dim)}
.subgrid table{font-size:11px}
.subgrid td,.subgrid th{padding:5px 10px}
.subgrid .cell-link{font-size:11px}
/* Pipeline / Sync */
.pipeline-step{display:flex;align-items:center;gap:10px;padding:10px;margin-bottom:8px;background:var(--surface2);border-radius:8px;border-left:3px solid var(--border)}
.pipeline-step.active{border-left-color:var(--accent);background:var(--accent)11}
.pipeline-step.done{border-left-color:var(--green);background:var(--green)08}
.pipeline-step.error{border-left-color:var(--red);background:var(--red)08}
.pipeline-step .step-icon{font-size:18px;width:24px;text-align:center}
.pipeline-step .step-info{flex:1}
.pipeline-step .step-name{font-size:12px;font-weight:600}
.pipeline-step .step-detail{font-size:10px;color:var(--dim);margin-top:2px}
.pipeline-arrow{text-align:center;color:var(--dim);font-size:14px;padding:2px 0}
.sync-section{margin-bottom:16px}
.sync-section h4{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--dim);margin-bottom:8px;font-weight:600}
.sync-status{display:flex;align-items:center;gap:8px;padding:10px;background:var(--surface2);border-radius:6px;margin-bottom:12px}
.sync-dot{width:8px;height:8px;border-radius:50%}
.sync-dot.connected{background:var(--green);box-shadow:0 0 6px var(--green)}
.sync-dot.disconnected{background:var(--red)}
.sync-dot.syncing{background:var(--orange);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.sync-log{font-family:var(--mono);font-size:10px;line-height:1.5;max-height:200px;overflow-y:auto;background:var(--bg);padding:8px;border-radius:6px;border:1px solid var(--border)}
.log-entry{padding:1px 0}.log-entry .timestamp{color:var(--dim)}
.log-entry.success{color:var(--green)}.log-entry.error{color:var(--red)}.log-entry.info{color:var(--cyan)}.log-entry.warn{color:var(--orange)}
.schema-tree{font-family:var(--mono);font-size:11px;line-height:1.6}
.schema-field{padding:2px 0 2px 12px;border-left:1px solid var(--border)55}
.schema-field .fname{color:var(--accent)}.schema-field .ftype{color:var(--orange)}.schema-field .freq{color:var(--red);font-size:9px}.schema-field .fopt{color:var(--dim);font-size:9px}
.stats-bar{display:flex;gap:16px;padding:8px 20px;background:var(--surface);border-top:1px solid var(--border);font-size:11px;color:var(--dim)}
.stat{display:flex;gap:4px;align-items:center}.stat .val{color:var(--text);font-weight:600;font-family:var(--mono)}
.modal-overlay{position:fixed;inset:0;background:#000a;z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:.2s}
.modal-overlay.open{opacity:1;pointer-events:auto}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto}
.modal h3{margin-bottom:16px;font-size:16px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px}
.empty-state{text-align:center;padding:60px 20px;color:var(--dim)}.empty-state h3{margin-bottom:8px;color:var(--text)}
/* Growth Toast */
.growth-toast{position:fixed;bottom:20px;right:20px;width:340px;background:var(--surface);border:1px solid var(--accent2);border-radius:12px;padding:0;z-index:200;transform:translateY(120%);opacity:0;transition:transform .3s ease,opacity .3s ease;overflow:hidden;box-shadow:0 8px 32px #0008}
.growth-toast.show{transform:translateY(0);opacity:1}
.growth-toast-header{padding:10px 14px;background:var(--accent2)18;border-bottom:1px solid var(--accent2)44;font-size:12px;font-weight:700;color:var(--accent2);display:flex;align-items:center;gap:8px;letter-spacing:.5px;text-transform:uppercase}
.growth-toast-header::before{content:"âœ¨";font-size:14px}
.growth-toast-stats{display:flex;gap:8px;padding:8px 14px;border-bottom:1px solid var(--border);flex-wrap:wrap}
.gt-stat{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600}
.gt-stat.created{background:var(--green)22;color:var(--green)}
.gt-stat.linked{background:var(--cyan)22;color:var(--cyan)}
.gt-stat.enriched{background:var(--orange)22;color:var(--orange)}
.gt-stat.deepened{background:var(--accent)22;color:var(--accent)}
.growth-toast-log{max-height:200px;overflow-y:auto;padding:6px 10px;font-size:11px}
.gt-entry{display:flex;align-items:center;gap:6px;padding:3px 4px;border-radius:4px}
.gt-entry:hover{background:var(--surface2)}
.gt-icon{width:16px;text-align:center;font-size:12px;flex-shrink:0}
.gt-action{width:12px;text-align:center;font-weight:700;flex-shrink:0}
.gt-created .gt-action{color:var(--green)}
.gt-linked .gt-action{color:var(--cyan)}
.gt-enriched .gt-action{color:var(--orange)}
.gt-deepened .gt-action{color:var(--accent)}
.gt-name{font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:120px}
.gt-detail{color:var(--dim);font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.growth-toast-total{padding:8px 14px;border-top:1px solid var(--border);font-size:10px;color:var(--dim);font-family:var(--mono);text-align:right}
.grow-btn{background:linear-gradient(135deg,var(--accent2)22,var(--accent)22);border:1px solid var(--accent2)66;color:var(--accent2);transition:.2s}
.grow-btn:hover{background:linear-gradient(135deg,var(--accent2)44,var(--accent)44);border-color:var(--accent2);box-shadow:0 0 16px var(--accent2)33;transform:translateY(-1px)}
.grow-btn.growing{animation:sparkle .6s ease infinite;pointer-events:none}
@media(max-width:900px){.main{grid-template-columns:1fr}.sidebar,.right-panel{display:none}}
</style>
</head>
<body>
<div class="app">
<header>
    <h1><span>D365</span> Local Simulator</h1>
    <div class="mode-badge edit" id="modeBadge">EDIT MODE</div>
    <div class="header-actions">
        <button class="btn" onclick="toggleMode()" id="modeToggle">Read-Only</button>
        <button class="btn" onclick="showImportModal()">Import JSON</button>
        <button class="btn success" onclick="exportAll()">Export JSON</button>
        <button class="btn primary" onclick="showSyncModal()">Sync Pipeline</button>
    </div>
</header>
<div class="breadcrumb" id="breadcrumb"><span class="current">Accounts</span></div>
<div class="main">
    <nav class="sidebar">
        <div class="sidebar-section"><label>CRM Entities</label></div>
        <button class="entity-btn active" data-entity="accounts" onclick="navToEntity('accounts')"><span class="entity-icon">&#9955;</span>Accounts<span class="count" id="count-accounts">0</span></button>
        <button class="entity-btn" data-entity="contacts" onclick="navToEntity('contacts')"><span class="entity-icon">&#9787;</span>Contacts<span class="count" id="count-contacts">0</span></button>
        <button class="entity-btn" data-entity="opportunities" onclick="navToEntity('opportunities')"><span class="entity-icon">&#9733;</span>Opportunities<span class="count" id="count-opportunities">0</span></button>
        <button class="entity-btn" data-entity="leads" onclick="navToEntity('leads')"><span class="entity-icon">&#9654;</span>Leads<span class="count" id="count-leads">0</span></button>
        <button class="entity-btn" data-entity="incidents" onclick="navToEntity('incidents')"><span class="entity-icon">&#9888;</span>Cases<span class="count" id="count-incidents">0</span></button>
        <div class="sidebar-section" style="margin-top:20px"><label>Actions</label></div>
        <button class="entity-btn" onclick="validateAll()"><span class="entity-icon">&#10003;</span>Validate Schema</button>
        <button class="entity-btn" onclick="generateSampleData()"><span class="entity-icon">&#9881;</span>Generate Sample</button>
        <button class="entity-btn" style="color:var(--accent2)" onclick="aiGenerateRecords()"><span class="entity-icon">&#10024;</span>AI Generate</button>
        <button class="entity-btn grow-btn" onclick="RelEngine.grow()" id="growBtn"><span class="entity-icon">&#127793;</span>Grow CRM Tree</button>
        <button class="entity-btn" style="color:var(--red)" onclick="resetAll()"><span class="entity-icon">&#128465;</span>Reset All Data</button>
    </nav>
    <div class="content">
        <div class="toolbar">
            <button class="btn primary" id="addBtn" onclick="addRecord()">+ New</button>
            <button class="btn danger" id="deleteBtn" onclick="deleteSelected()" disabled>Delete</button>
            <button class="btn" style="border-color:var(--accent2);color:var(--accent2)" onclick="aiAddRecord()">&#10024; AI New</button>
            <button class="btn grow-btn" onclick="RelEngine.grow()" id="growBtnToolbar">&#127793; Grow Tree</button>
            <input type="text" class="search-box" placeholder="Search records..." oninput="filterRecords(this.value)" id="searchInput">
            <span style="font-size:11px;color:var(--dim)" id="recordInfo">0 records</span>
        </div>
        <div class="table-wrap" id="tableWrap"><table id="dataTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table></div>
    </div>
    <div class="right-panel">
        <div class="panel-tabs">
            <div class="panel-tab active" data-tab="editor" onclick="switchTab('editor')">Record</div>
            <div class="panel-tab" data-tab="related" onclick="switchTab('related')">Related</div>
            <div class="panel-tab" data-tab="schema" onclick="switchTab('schema')">Schema</div>
        </div>
        <div class="panel-content" id="panelContent"></div>
    </div>
</div>
<div class="stats-bar">
    <div class="stat">Records:<span class="val" id="statRecords">0</span></div>
    <div class="stat">Pending:<span class="val" id="statPending">0</span></div>
    <div class="stat">Export:<span class="val" id="statExport">Never</span></div>
    <div class="stat" style="margin-left:auto">Schema:<span class="val" style="color:var(--green)">D365 v9.2</span></div>
</div>
</div>

<!-- Import Modal -->
<div class="modal-overlay" id="importModal"><div class="modal">
    <h3>Import D365 Simulation Data</h3>
    <p style="font-size:12px;color:var(--dim);margin-bottom:16px">Import a previously exported JSON file. Replaces all current data.</p>
    <div class="field-group"><label>JSON File</label><input type="file" accept=".json" id="importFile" style="padding:10px"></div>
    <div class="field-group"><label>Or Paste JSON</label><textarea id="importText" placeholder='{"_meta":{...},...}' style="min-height:120px;font-family:var(--mono);font-size:11px"></textarea></div>
    <div class="modal-actions"><button class="btn" onclick="closeModal('importModal')">Cancel</button><button class="btn primary" onclick="doImport()">Import</button></div>
</div></div>

<!-- Sync Modal -->
<div class="modal-overlay" id="syncModal"><div class="modal" style="max-width:650px">
    <h3>Sync Pipeline Configuration</h3>
    <div class="sync-status"><div class="sync-dot disconnected" id="syncDot"></div><span style="font-size:12px" id="syncStatusText">Not Connected</span></div>
    <div class="sync-section"><h4>D365 Endpoint</h4>
        <div class="field-group"><label>Organization URL</label><input type="text" id="syncOrgUrl" placeholder="https://yourorg.crm.dynamics.com"></div>
        <div class="field-group"><label>API Version</label><select id="syncApiVersion"><option value="v9.2" selected>v9.2</option><option value="v9.1">v9.1</option></select></div>
    </div>
    <div class="sync-section"><h4>Authentication</h4>
        <div class="field-group"><label>Bearer Token</label><textarea id="syncToken" placeholder="Paste access token..." style="min-height:50px;font-family:var(--mono);font-size:10px"></textarea></div>
    </div>
    <div class="sync-section"><h4>Sync Options</h4>
        <div style="display:flex;gap:12px;flex-wrap:wrap;font-size:12px">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="syncDryRun" checked> Dry Run</label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox" id="syncUpsert" checked> Upsert Mode</label>
        </div>
    </div>
    <div class="sync-section"><h4>Sync Order (Dependency)</h4>
        <div style="font-size:11px;color:var(--dim);font-family:var(--mono)">accounts &rarr; contacts &rarr; leads &rarr; opportunities &rarr; cases</div>
        <div style="font-size:10px;color:var(--dim);margin-top:4px">Lookups are bound AFTER parent records exist in D365.</div>
    </div>
    <div class="sync-section"><h4>Pipeline</h4><div id="pipelineViz"></div></div>
    <div class="sync-section"><h4>Log</h4><div class="sync-log" id="syncLog"><div class="log-entry info"><span class="timestamp">[--:--:--]</span> Ready.</div></div></div>
    <div class="modal-actions"><button class="btn" onclick="closeModal('syncModal')">Close</button><button class="btn" onclick="testConnection()">Test</button><button class="btn primary" onclick="startSync()">Sync</button></div>
</div></div>

<!-- Test Results Modal -->
<div class="modal-overlay" id="testModal"><div class="modal" style="max-width:700px">
    <h3>Schema Compliance Tests</h3>
    <div id="testResults" style="font-family:var(--mono);font-size:11px;line-height:1.6;max-height:60vh;overflow-y:auto"></div>
    <div class="modal-actions"><button class="btn" onclick="closeModal('testModal')">Close</button></div>
</div></div>

<script>
"use strict";

// =====================================================================
// D365 ENTITY SCHEMAS - Full OData v4 / Web API v9.2 compliance
// Each lookup has: navProperty (OData bind name), navEntitySet (target set)
// syncExclude: fields D365 manages (computed, auto-number, state transitions)
// =====================================================================
const SYNC_ORDER = ["accounts","contacts","leads","opportunities","incidents"];

const SCHEMAS = {
    accounts: {
        label:"Account", plural:"Accounts", primaryKey:"accountid", primaryName:"name", oDataSet:"accounts",
        fields: {
            accountid:       {type:"guid",label:"Account ID",required:true,auto:true},
            name:            {type:"string",label:"Account Name",required:true,maxLength:160},
            accountnumber:   {type:"string",label:"Account Number",required:false,maxLength:20},
            telephone1:      {type:"string",label:"Phone",required:false,maxLength:50},
            emailaddress1:   {type:"string",label:"Email",required:false,maxLength:100,format:"email"},
            websiteurl:      {type:"string",label:"Website",required:false,maxLength:200,format:"url"},
            revenue:         {type:"money",label:"Annual Revenue",required:false},
            numberofemployees:{type:"int",label:"Employees",required:false},
            address1_city:   {type:"string",label:"City",required:false,maxLength:80},
            address1_stateorprovince:{type:"string",label:"State/Province",required:false,maxLength:50},
            address1_country:{type:"string",label:"Country",required:false,maxLength:80},
            industrycode:    {type:"picklist",label:"Industry",required:false,options:{1:"Accounting",2:"Agriculture",3:"Construction",4:"Consulting",5:"Education",6:"Finance",7:"Government",8:"Healthcare",9:"Hospitality",10:"Manufacturing",11:"Retail",12:"Technology",13:"Telecom",14:"Transportation",15:"Utilities"}},
            statecode:       {type:"picklist",label:"Status",required:false,options:{0:"Active",1:"Inactive"},default:0,syncExclude:true},
            description:     {type:"text",label:"Description",required:false,maxLength:2000},
        },
        tableColumns:["name","accountnumber","telephone1","emailaddress1","revenue","address1_city","industrycode","statecode"],
        // Reverse relationships: what entities point TO this one
        reverseRels:[
            {entity:"contacts",fk:"_parentcustomerid_value",label:"Contacts"},
            {entity:"opportunities",fk:"_parentaccountid_value",label:"Opportunities"},
        ],
    },
    contacts: {
        label:"Contact", plural:"Contacts", primaryKey:"contactid", primaryName:"fullname", oDataSet:"contacts",
        fields: {
            contactid:     {type:"guid",label:"Contact ID",required:true,auto:true},
            firstname:     {type:"string",label:"First Name",required:true,maxLength:50},
            lastname:      {type:"string",label:"Last Name",required:true,maxLength:50},
            fullname:      {type:"string",label:"Full Name",required:false,computed:true,syncExclude:true,maxLength:160},
            jobtitle:      {type:"string",label:"Job Title",required:false,maxLength:100},
            emailaddress1: {type:"string",label:"Email",required:false,maxLength:100,format:"email"},
            telephone1:    {type:"string",label:"Business Phone",required:false,maxLength:50},
            mobilephone:   {type:"string",label:"Mobile Phone",required:false,maxLength:50},
            address1_city: {type:"string",label:"City",required:false,maxLength:80},
            address1_stateorprovince:{type:"string",label:"State",required:false,maxLength:50},
            // Polymorphic lookup: parentcustomerid can point to account OR contact
            // For our sim we always bind to account -> navProperty = "parentcustomerid_account"
            _parentcustomerid_value:{type:"lookup",label:"Company",required:false,target:"accounts",
                navProperty:"parentcustomerid_account",navEntitySet:"accounts"},
            statecode:     {type:"picklist",label:"Status",required:false,options:{0:"Active",1:"Inactive"},default:0,syncExclude:true},
            description:   {type:"text",label:"Description",required:false,maxLength:2000},
        },
        tableColumns:["fullname","jobtitle","emailaddress1","telephone1","_parentcustomerid_value","address1_city","statecode"],
        reverseRels:[
            {entity:"opportunities",fk:"_parentcontactid_value",label:"Opportunities"},
            {entity:"incidents",fk:"_customerid_value",label:"Cases"},
        ],
    },
    opportunities: {
        label:"Opportunity", plural:"Opportunities", primaryKey:"opportunityid", primaryName:"name", oDataSet:"opportunities",
        fields: {
            opportunityid:     {type:"guid",label:"Opportunity ID",required:true,auto:true},
            name:              {type:"string",label:"Topic",required:true,maxLength:300},
            estimatedvalue:    {type:"money",label:"Est. Revenue",required:false},
            closeprobability:  {type:"int",label:"Probability (%)",required:false,min:0,max:100},
            estimatedclosedate:{type:"date",label:"Est. Close Date",required:false},
            _parentaccountid_value:{type:"lookup",label:"Account",required:false,target:"accounts",
                navProperty:"parentaccountid",navEntitySet:"accounts"},
            _parentcontactid_value:{type:"lookup",label:"Contact",required:false,target:"contacts",
                navProperty:"parentcontactid",navEntitySet:"contacts"},
            stepname:          {type:"string",label:"Sales Stage",required:false,maxLength:200},
            salesstagecode:    {type:"picklist",label:"Stage Code",required:false,options:{0:"Qualify",1:"Develop",2:"Propose",3:"Close"}},
            statecode:         {type:"picklist",label:"Status",required:false,options:{0:"Open",1:"Won",2:"Lost"},default:0,syncExclude:true},
            description:       {type:"text",label:"Description",required:false,maxLength:2000},
        },
        tableColumns:["name","estimatedvalue","closeprobability","estimatedclosedate","_parentaccountid_value","salesstagecode","statecode"],
        reverseRels:[],
    },
    leads: {
        label:"Lead", plural:"Leads", primaryKey:"leadid", primaryName:"fullname", oDataSet:"leads",
        fields: {
            leadid:       {type:"guid",label:"Lead ID",required:true,auto:true},
            firstname:    {type:"string",label:"First Name",required:false,maxLength:50},
            lastname:     {type:"string",label:"Last Name",required:true,maxLength:50},
            fullname:     {type:"string",label:"Full Name",required:false,computed:true,syncExclude:true,maxLength:160},
            companyname:  {type:"string",label:"Company",required:false,maxLength:100},
            jobtitle:     {type:"string",label:"Job Title",required:false,maxLength:100},
            emailaddress1:{type:"string",label:"Email",required:false,maxLength:100,format:"email"},
            telephone1:   {type:"string",label:"Phone",required:false,maxLength:50},
            address1_city:{type:"string",label:"City",required:false,maxLength:80},
            leadsourcecode:{type:"picklist",label:"Lead Source",required:false,options:{1:"Advertisement",2:"Employee Referral",3:"External Referral",4:"Partner",5:"Public Relations",6:"Seminar",7:"Trade Show",8:"Web",9:"Word of Mouth",10:"Other"}},
            leadqualitycode:{type:"picklist",label:"Rating",required:false,options:{1:"Hot",2:"Warm",3:"Cold"}},
            statecode:    {type:"picklist",label:"Status",required:false,options:{0:"Open",1:"Qualified",2:"Disqualified"},default:0,syncExclude:true},
            description:  {type:"text",label:"Description",required:false,maxLength:2000},
        },
        tableColumns:["fullname","companyname","emailaddress1","telephone1","leadsourcecode","leadqualitycode","statecode"],
        reverseRels:[],
    },
    incidents: {
        label:"Case", plural:"Cases", primaryKey:"incidentid", primaryName:"title", oDataSet:"incidents",
        fields: {
            incidentid:    {type:"guid",label:"Case ID",required:true,auto:true},
            title:         {type:"string",label:"Case Title",required:true,maxLength:200},
            ticketnumber:  {type:"string",label:"Ticket #",required:false,auto:true,syncExclude:true,maxLength:100},
            // Polymorphic: customerid can point to contact or account
            // We always bind to contact -> navProperty = "customerid_contact"
            _customerid_value:{type:"lookup",label:"Customer",required:false,target:"contacts",
                navProperty:"customerid_contact",navEntitySet:"contacts"},
            caseorigincode:{type:"picklist",label:"Origin",required:false,options:{1:"Phone",2:"Email",3:"Web",4:"Facebook",5:"Twitter"}},
            prioritycode:  {type:"picklist",label:"Priority",required:false,options:{1:"High",2:"Normal",3:"Low"},default:2},
            severitycode:  {type:"picklist",label:"Severity",required:false,options:{1:"Default",2:"High",3:"Normal",4:"Low"},default:3},
            statecode:     {type:"picklist",label:"Status",required:false,options:{0:"Active",1:"Resolved",2:"Cancelled"},default:0,syncExclude:true},
            description:   {type:"text",label:"Description",required:false,maxLength:2000},
        },
        tableColumns:["title","ticketnumber","_customerid_value","caseorigincode","prioritycode","statecode"],
        reverseRels:[],
    },
};

// =====================================================================
// STATE
// =====================================================================
const STORAGE_KEY="d365sim_data", SYNC_KEY="d365sim_sync";
let data={accounts:[],contacts:[],opportunities:[],leads:[],incidents:[]};
let activeEntity="accounts", selectedId=null, editMode=true, searchFilter="", sortCol=null, sortDir=1;
let syncConfig={}, ticketCounter=1000, activeTab="editor";
// Navigation breadcrumb stack: [{entity, id, label}]
let navStack=[];

// =====================================================================
// PERSISTENCE
// =====================================================================
function save(){
    const p={_meta:{version:"2.0.0",schema:"D365-WebAPI-v9.2",exported:new Date().toISOString(),source:"D365-Local-Simulator",ticketCounter,recordCounts:{}}};
    for(const e of Object.keys(SCHEMAS)){p[e]=data[e];p._meta.recordCounts[e]=data[e].length;}
    localStorage.setItem(STORAGE_KEY,JSON.stringify(p));
}
function load(){
    try{const r=localStorage.getItem(STORAGE_KEY);if(!r)return;const p=JSON.parse(r);
    for(const e of Object.keys(SCHEMAS))if(Array.isArray(p[e]))data[e]=p[e];
    if(p._meta?.ticketCounter)ticketCounter=p._meta.ticketCounter;}catch(e){}
    try{const s=localStorage.getItem(SYNC_KEY);if(s)syncConfig=JSON.parse(s);}catch(e){}
}
function saveSyncConfig(){localStorage.setItem(SYNC_KEY,JSON.stringify(syncConfig));}
function resetAll(){if(!confirm("Delete ALL simulation data and sync config? This cannot be undone."))return;localStorage.removeItem(STORAGE_KEY);localStorage.removeItem(SYNC_KEY);data={accounts:[],contacts:[],opportunities:[],leads:[],incidents:[]};syncConfig={};ticketCounter=1000;selectedId=null;navStack=[];renderTable();renderPanel();renderBreadcrumb();updateCounts();}
function newGuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16)});}

// =====================================================================
// NAVIGATION - clickable links between records
// =====================================================================
function navToEntity(ent){
    activeEntity=ent;selectedId=null;searchFilter="";sortCol=null;navStack=[];
    document.getElementById("searchInput").value="";
    document.querySelectorAll(".entity-btn").forEach(b=>b.classList.toggle("active",b.dataset.entity===ent));
    document.getElementById("deleteBtn").disabled=true;
    renderBreadcrumb();renderTable();renderPanel();
}
function navToRecord(ent,id){
    // Push current view onto stack
    if(activeEntity&&activeEntity!==ent){
        navStack.push({entity:activeEntity,id:selectedId,label:SCHEMAS[activeEntity].plural});
    } else if(activeEntity===ent&&selectedId&&selectedId!==id){
        navStack.push({entity:activeEntity,id:selectedId,label:getRecordLabel(activeEntity,selectedId)});
    }
    activeEntity=ent;selectedId=id;searchFilter="";
    document.getElementById("searchInput").value="";
    document.querySelectorAll(".entity-btn").forEach(b=>b.classList.toggle("active",b.dataset.entity===ent));
    document.getElementById("deleteBtn").disabled=!editMode;
    activeTab="editor";
    document.querySelectorAll(".panel-tab").forEach(t=>t.classList.toggle("active",t.dataset.tab==="editor"));
    renderBreadcrumb();renderTable();renderPanel();
}
function navBack(idx){
    if(idx<0){navToEntity(navStack[0]?.entity||activeEntity);navStack=[];return;}
    const target=navStack[idx];
    navStack=navStack.slice(0,idx);
    if(target.id){navToRecord(target.entity,target.id);}
    else{navToEntity(target.entity);}
}
function getRecordLabel(ent,id){
    const s=SCHEMAS[ent];const r=data[ent].find(x=>x[s.primaryKey]===id);
    return r?r[s.primaryName]||id.substring(0,8):id?.substring(0,8)||"";
}
function renderBreadcrumb(){
    const bc=document.getElementById("breadcrumb");
    let html="";
    // Root link
    html+=`<a onclick="navBack(-1)">${SCHEMAS[activeEntity]?.plural||"Home"}</a>`;
    // Stack entries
    for(let i=0;i<navStack.length;i++){
        html+=`<span class="sep">&rsaquo;</span><a onclick="navBack(${i})">${navStack[i].label}</a>`;
    }
    // Current
    if(selectedId){
        const label=getRecordLabel(activeEntity,selectedId);
        html+=`<span class="sep">&rsaquo;</span><span class="current">${label}</span>`;
    }
    bc.innerHTML=html;
}

// =====================================================================
// VALIDATION
// =====================================================================
function validateRecord(entityName,record){
    const schema=SCHEMAS[entityName],errors=[];
    for(const[fn,fd]of Object.entries(schema.fields)){
        if(fd.auto||fd.computed)continue;const v=record[fn];
        if(fd.required&&(v===undefined||v===null||v==="")){errors.push({field:fn,msg:`${fd.label} is required`});continue;}
        if(v===undefined||v===null||v==="")continue;
        if(fd.type==="string"&&fd.maxLength&&String(v).length>fd.maxLength)errors.push({field:fn,msg:`${fd.label} exceeds max length`});
        if(fd.format==="email"&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v))errors.push({field:fn,msg:`${fd.label} invalid email`});
        if(fd.type==="int"&&isNaN(parseInt(v)))errors.push({field:fn,msg:`${fd.label} must be number`});
        if(fd.type==="money"&&isNaN(parseFloat(v)))errors.push({field:fn,msg:`${fd.label} must be number`});
    }
    return errors;
}
function validateAll(){
    let te=0,tr=0;const results={};
    for(const e of Object.keys(SCHEMAS)){results[e]=[];for(const r of data[e]){tr++;const errs=validateRecord(e,r);if(errs.length){te+=errs.length;results[e].push({name:r[SCHEMAS[e].primaryName],errors:errs});}}}
    let msg=`${tr} records checked.\n`;
    if(!te)msg+="All pass D365 v9.2 schema!";
    else{msg+=`${te} errors:\n`;for(const[e,recs]of Object.entries(results)){if(!recs.length)continue;msg+=`\n${SCHEMAS[e].plural}:\n`;for(const r of recs)msg+=`  ${r.name}: ${r.errors.map(x=>x.msg).join(", ")}\n`;}}
    alert(msg);
}

// =====================================================================
// TABLE RENDERING - with clickable lookup links
// =====================================================================
function getRecords(){
    let recs=data[activeEntity]||[];
    if(searchFilter){const q=searchFilter.toLowerCase();recs=recs.filter(r=>Object.values(r).some(v=>v!=null&&String(v).toLowerCase().includes(q)));}
    if(sortCol){recs=[...recs].sort((a,b)=>{let va=a[sortCol]??""  ,vb=b[sortCol]??"";return(typeof va==="number"&&typeof vb==="number"?va-vb:String(va).localeCompare(String(vb)))*sortDir;});}
    return recs;
}
function formatCell(val,fd,forTable){
    if(val==null||val==="")return'<span style="color:var(--dim)">--</span>';
    if(fd.type==="money")return`<span class="cell-money">$${Number(val).toLocaleString()}</span>`;
    if(fd.type==="int"&&fd.label?.includes("%"))return`<span class="cell-pct">${val}%</span>`;
    if(fd.type==="picklist"&&fd.options){
        const lbl=fd.options[val]||val;
        if(fd.label==="Status"){const cls=val==0?"active":val==1?(activeEntity==="opportunities"?"active":"inactive"):"inactive";return`<span class="cell-status ${cls}">${lbl}</span>`;}
        return lbl;
    }
    if(fd.type==="lookup"&&forTable){
        if(!val)return'<span style="color:var(--dim)">--</span>';
        const ts=SCHEMAS[fd.target];if(!ts)return String(val).substring(0,8);
        const rec=data[fd.target].find(r=>r[ts.primaryKey]===val);
        const name=rec?rec[ts.primaryName]||val.substring(0,8):val.substring(0,8);
        // Return clickable link that navigates to the record
        return`<a class="cell-link" onclick="event.stopPropagation();navToRecord('${fd.target}','${val}')">${name}</a>`;
    }
    if(fd.type==="date")return val?new Date(val).toLocaleDateString():'--';
    return String(val);
}
function renderTable(){
    const schema=SCHEMAS[activeEntity],cols=schema.tableColumns,fields=schema.fields;
    let hh="<tr>";for(const c of cols){const f=fields[c];const arrow=sortCol===c?(sortDir===1?" &#9650;":" &#9660;"):"";hh+=`<th onclick="sortBy('${c}')">${f.label}<span style="font-size:10px">${arrow}</span></th>`;}
    hh+=`<th style="width:50px">Sync</th></tr>`;
    document.getElementById("tableHead").innerHTML=hh;
    const recs=getRecords();let bh="";
    if(!recs.length){bh=`<tr><td colspan="${cols.length+1}" style="text-align:center;padding:40px;color:var(--dim)">No records. ${editMode?'Click "+ New" to add.':''}</td></tr>`;}
    else{for(const rec of recs){const pk=rec[schema.primaryKey],sel=pk===selectedId?" selected":"";
        bh+=`<tr class="${sel}" onclick="selectRecord('${pk}')">`;
        for(const c of cols)bh+=`<td>${formatCell(rec[c],fields[c],true)}</td>`;
        const ss=rec._syncState||"new";bh+=`<td><span class="cell-status ${ss}">${ss}</span></td></tr>`;
    }}
    document.getElementById("tableBody").innerHTML=bh;
    document.getElementById("recordInfo").textContent=`${recs.length} record${recs.length!==1?'s':''}`;
    updateCounts();
}
function updateCounts(){
    for(const e of Object.keys(SCHEMAS))document.getElementById(`count-${e}`).textContent=data[e].length;
    document.getElementById("statRecords").textContent=Object.values(data).reduce((s,a)=>s+a.length,0);
    document.getElementById("statPending").textContent=Object.values(data).reduce((s,a)=>s+a.filter(r=>r._syncState!=="synced").length,0);
}
function sortBy(c){if(sortCol===c)sortDir*=-1;else{sortCol=c;sortDir=1;}renderTable();}
function filterRecords(q){searchFilter=q;renderTable();}

// =====================================================================
// RECORD CRUD
// =====================================================================
function selectRecord(id){
    selectedId=selectedId===id?null:id;
    document.getElementById("deleteBtn").disabled=!selectedId||!editMode;
    renderTable();renderPanel();renderBreadcrumb();
}
function addRecord(){
    if(!editMode)return;const s=SCHEMAS[activeEntity],rec={};
    rec[s.primaryKey]=newGuid();rec._syncState="new";rec._created=new Date().toISOString();rec._modified=new Date().toISOString();
    for(const[fn,fd]of Object.entries(s.fields)){if(!fd.auto&&fd.default!==undefined)rec[fn]=fd.default;else if(!rec[fn])rec[fn]=null;}
    if(activeEntity==="incidents")rec.ticketnumber="CAS-"+(++ticketCounter);
    if(s.fields.fullname)rec.fullname="New Record";
    data[activeEntity].push(rec);selectedId=rec[s.primaryKey];save();renderTable();renderPanel();renderBreadcrumb();
}
function deleteSelected(){
    if(!editMode||!selectedId)return;const s=SCHEMAS[activeEntity];
    data[activeEntity]=data[activeEntity].filter(r=>r[s.primaryKey]!==selectedId);
    selectedId=null;document.getElementById("deleteBtn").disabled=true;save();renderTable();renderPanel();renderBreadcrumb();
}
function updateField(field,value){
    if(!editMode||!selectedId)return;const s=SCHEMAS[activeEntity];
    const rec=data[activeEntity].find(r=>r[s.primaryKey]===selectedId);if(!rec)return;
    const fd=s.fields[field];
    if(fd.type==="int"||fd.type==="picklist")rec[field]=value===""?null:parseInt(value);
    else if(fd.type==="money")rec[field]=value===""?null:parseFloat(value);
    else rec[field]=value||null;
    if(s.fields.fullname&&(field==="firstname"||field==="lastname"))rec.fullname=[rec.firstname,rec.lastname].filter(Boolean).join(" ");
    rec._modified=new Date().toISOString();
    if(rec._syncState==="synced")rec._syncState="modified";
    save();renderTable();
}

// =====================================================================
// RIGHT PANEL
// =====================================================================
function switchTab(tab){activeTab=tab;document.querySelectorAll(".panel-tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===tab));renderPanel();}
function renderPanel(){
    const c=document.getElementById("panelContent");
    if(activeTab==="editor")renderEditor(c);
    else if(activeTab==="related")renderRelated(c);
    else if(activeTab==="schema")renderSchema(c);
}
function renderEditor(container){
    const schema=SCHEMAS[activeEntity];
    if(!selectedId){container.innerHTML='<div class="empty-state"><h3>No Record Selected</h3><p style="color:var(--dim);font-size:12px">Click a row to view/edit.</p></div>';return;}
    const rec=data[activeEntity].find(r=>r[schema.primaryKey]===selectedId);
    if(!rec){container.innerHTML="";return;}
    const errors=validateRecord(activeEntity,rec),errorMap={};for(const e of errors)errorMap[e.field]=e.msg;
    const ctx=ContextAI.buildContext(activeEntity,rec);
    let html=`<div style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">
        <div style="font-size:10px;color:var(--dim);font-family:var(--mono)">${rec[schema.primaryKey]}</div>
        <div style="font-size:9px;color:var(--dim);margin-top:2px">Modified: ${rec._modified||"N/A"}</div>
    </div>`;
    if(editMode){html+=`<div class="ai-toolbar" style="margin-bottom:12px"><span class="ai-toolbar-label">AI Context</span><span class="ai-context-badge">${ctx.totalRecords} records</span><button class="btn btn-sm" style="margin-left:auto;border-color:var(--accent2);color:var(--accent2)" onclick="aiGenerateAllFields()">&#10024; Fill All</button></div>`;}

    for(const[fname,fdef]of Object.entries(schema.fields)){
        if(fdef.auto&&fname===schema.primaryKey)continue;
        if(fdef.computed)continue;
        if(fdef.auto){html+=`<div class="field-group"><label>${fdef.label}</label><input type="text" value="${rec[fname]||''}" disabled></div>`;continue;}
        const val=rec[fname]!=null?rec[fname]:"",invalid=errorMap[fname]?" invalid":"",disabled=editMode?"":" disabled";
        const aiBtn=editMode?`<button class="ai-btn" data-ai-field="${fname}" onclick="aiGenerateField('${fname}')" title="AI generate">&#10024;</button>`:"";
        // For lookups, add a "go to record" button
        let gotoBtn="";
        if(fdef.type==="lookup"&&val){gotoBtn=`<button class="goto-btn" onclick="navToRecord('${fdef.target}','${val}')" title="Go to record">&#8599;</button>`;}

        if(fdef.type==="picklist"&&fdef.options){
            let opts=`<option value="">-- Select --</option>`;for(const[k,v]of Object.entries(fdef.options))opts+=`<option value="${k}" ${val==k?"selected":""}>${v}</option>`;
            html+=`<div class="field-group"><label>${fdef.label}${fdef.required?' *':''}</label><div class="field-row"><select class="${invalid}" onchange="updateField('${fname}',this.value)"${disabled}>${opts}</select>${aiBtn}</div>${errorMap[fname]?`<div class="validation-error">${errorMap[fname]}</div>`:""}</div>`;
        } else if(fdef.type==="text"){
            html+=`<div class="field-group"><label>${fdef.label}${fdef.required?' *':''}</label><div class="field-row"><textarea class="${invalid}" onchange="updateField('${fname}',this.value)"${disabled}>${val}</textarea>${aiBtn}</div>${errorMap[fname]?`<div class="validation-error">${errorMap[fname]}</div>`:""}</div>`;
        } else if(fdef.type==="lookup"){
            const ts=SCHEMAS[fdef.target];let opts=`<option value="">-- None --</option>`;
            if(ts){for(const tr of data[fdef.target]){const tid=tr[ts.primaryKey],tn=tr[ts.primaryName]||tid;opts+=`<option value="${tid}" ${val===tid?"selected":""}>${tn}</option>`;}}
            html+=`<div class="field-group"><label>${fdef.label} (${ts?ts.label:fdef.target})</label><div class="field-row"><select class="${invalid}" onchange="updateField('${fname}',this.value)"${disabled}>${opts}</select>${gotoBtn}${aiBtn}</div>${errorMap[fname]?`<div class="validation-error">${errorMap[fname]}</div>`:""}</div>`;
        } else if(fdef.type==="date"){
            html+=`<div class="field-group"><label>${fdef.label}${fdef.required?' *':''}</label><div class="field-row"><input type="date" class="${invalid}" value="${val}" onchange="updateField('${fname}',this.value)"${disabled}>${aiBtn}</div>${errorMap[fname]?`<div class="validation-error">${errorMap[fname]}</div>`:""}</div>`;
        } else {
            const it=fdef.type==="money"||fdef.type==="int"?"number":fdef.format==="email"?"email":fdef.format==="url"?"url":"text";
            html+=`<div class="field-group"><label>${fdef.label}${fdef.required?' *':''}</label><div class="field-row"><input type="${it}" class="${invalid}" value="${val}" onchange="updateField('${fname}',this.value)"${disabled}${fdef.maxLength?` maxlength="${fdef.maxLength}"`:""}${fdef.min!=null?` min="${fdef.min}"`:""}${fdef.max!=null?` max="${fdef.max}"`:""} >${aiBtn}</div>${errorMap[fname]?`<div class="validation-error">${errorMap[fname]}</div>`:""}</div>`;
        }
    }
    if(editMode){html+=`<div style="margin-top:12px;display:flex;gap:8px"><button class="btn danger btn-sm" onclick="deleteSelected()">Delete</button></div>`;}
    container.innerHTML=html;
}

// =====================================================================
// RELATED RECORDS TAB - subgrids like D365
// =====================================================================
function renderRelated(container){
    const schema=SCHEMAS[activeEntity];
    if(!selectedId){container.innerHTML='<div class="empty-state"><h3>No Record Selected</h3></div>';return;}
    const rec=data[activeEntity].find(r=>r[schema.primaryKey]===selectedId);if(!rec){container.innerHTML="";return;}
    const rels=schema.reverseRels||[];
    if(!rels.length){container.innerHTML='<div class="empty-state" style="padding:30px"><p style="color:var(--dim);font-size:12px">No related entities for '+schema.plural+'.</p></div>';return;}

    let html="";
    for(const rel of rels){
        const relSchema=SCHEMAS[rel.entity];if(!relSchema)continue;
        const relRecs=data[rel.entity].filter(r=>r[rel.fk]===selectedId);
        html+=`<div class="subgrid" style="margin-bottom:12px">`;
        html+=`<div class="subgrid-header">${rel.label}<span class="sg-count">${relRecs.length}</span></div>`;
        if(!relRecs.length){
            html+=`<div style="padding:12px;font-size:11px;color:var(--dim);text-align:center">No ${rel.label.toLowerCase()} linked.</div>`;
        } else {
            html+=`<table><thead><tr>`;
            // Show first 3 table columns
            const cols=relSchema.tableColumns.slice(0,4).filter(c=>c!==rel.fk);
            for(const c of cols){const f=relSchema.fields[c];html+=`<th>${f?f.label:c}</th>`;}
            html+=`</tr></thead><tbody>`;
            for(const rr of relRecs.slice(0,10)){
                const pk=rr[relSchema.primaryKey];
                html+=`<tr onclick="navToRecord('${rel.entity}','${pk}')" style="cursor:pointer">`;
                for(const c of cols){html+=`<td>${formatCell(rr[c],relSchema.fields[c],true)}</td>`;}
                html+=`</tr>`;
            }
            if(relRecs.length>10)html+=`<tr><td colspan="${cols.length}" style="text-align:center;color:var(--dim);font-size:10px">+${relRecs.length-10} more</td></tr>`;
            html+=`</tbody></table>`;
        }
        html+=`</div>`;
    }
    container.innerHTML=html;
}

function renderSchema(container){
    const schema=SCHEMAS[activeEntity];
    let html=`<div style="margin-bottom:12px"><div style="font-size:14px;font-weight:600">${schema.plural} Schema</div>
        <div style="font-size:11px;color:var(--dim)">OData: <code style="color:var(--cyan)">${schema.oDataSet}</code> | PK: <code style="color:var(--cyan)">${schema.primaryKey}</code></div></div>`;
    html+='<div class="schema-tree">';
    for(const[fn,fd]of Object.entries(schema.fields)){
        const req=fd.required?' <span class="freq">[req]</span>':' <span class="fopt">[opt]</span>';
        let ts=fd.type;
        if(fd.type==="string"||fd.type==="text")ts=`Edm.String(${fd.maxLength||"max"})`;
        else if(fd.type==="guid")ts="Edm.Guid";else if(fd.type==="int")ts="Edm.Int32";
        else if(fd.type==="money")ts="Edm.Decimal";else if(fd.type==="date")ts="Edm.DateTimeOffset";
        else if(fd.type==="picklist")ts="Edm.Int32 (OptionSet)";
        else if(fd.type==="lookup")ts=`Lookup &rarr; ${fd.navProperty}@odata.bind: /${fd.navEntitySet}`;
        const flags=[fd.auto?'auto':'',fd.computed?'computed':'',fd.syncExclude?'sync-exclude':''].filter(Boolean).map(f=>`<span class="fopt">[${f}]</span>`).join(' ');
        html+=`<div class="schema-field"><span class="fname">${fn}</span> : <span class="ftype">${ts}</span>${req} ${flags}</div>`;
    }
    html+='</div>';container.innerHTML=html;
}

// =====================================================================
// IMPORT / EXPORT
// =====================================================================
function exportAll(){
    const p={_meta:{version:"2.0.0",schema:"D365-WebAPI-v9.2",exported:new Date().toISOString(),source:"D365-Local-Simulator",ticketCounter,recordCounts:{},syncConfig:syncConfig.orgUrl?{orgUrl:syncConfig.orgUrl,apiVersion:syncConfig.apiVersion}:null}};
    for(const e of Object.keys(SCHEMAS)){p[e]=data[e].map(r=>{const c={...r};delete c._syncState;delete c._created;delete c._modified;return c;});p._meta.recordCounts[e]=data[e].length;}
    const blob=new Blob([JSON.stringify(p,null,2)],{type:"application/json"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=`d365-sim-${new Date().toISOString().slice(0,10)}.json`;a.click();
    document.getElementById("statExport").textContent=new Date().toLocaleTimeString();
}
function showImportModal(){document.getElementById("importModal").classList.add("open");}
function closeModal(id){document.getElementById(id).classList.remove("open");}
function doImport(){
    const fi=document.getElementById("importFile"),ti=document.getElementById("importText");
    if(fi.files.length>0){const r=new FileReader();r.onload=e=>importJSON(e.target.result);r.readAsText(fi.files[0]);}
    else if(ti.value.trim())importJSON(ti.value);else alert("Select file or paste JSON.");
}
function importJSON(str){
    try{const p=JSON.parse(str);if(!p._meta){alert("Invalid: missing _meta.");return;}
    let n=0;for(const e of Object.keys(SCHEMAS)){if(Array.isArray(p[e])){data[e]=p[e].map(r=>({...r,_syncState:r._syncState||"new",_created:r._created||new Date().toISOString(),_modified:r._modified||new Date().toISOString()}));n+=data[e].length;}}
    if(p._meta.ticketCounter)ticketCounter=p._meta.ticketCounter;
    save();closeModal("importModal");renderTable();renderPanel();
    alert(`Imported ${n} records.`);}catch(e){alert("JSON error: "+e.message);}
}
function toggleMode(){
    editMode=!editMode;const b=document.getElementById("modeBadge"),t=document.getElementById("modeToggle");
    b.textContent=editMode?"EDIT MODE":"READ ONLY";b.className=editMode?"mode-badge edit":"mode-badge readonly";
    t.textContent=editMode?"Read-Only":"Edit Mode";
    document.getElementById("addBtn").disabled=!editMode;document.getElementById("deleteBtn").disabled=!editMode||!selectedId;
    renderPanel();
}

// =====================================================================
// SYNC ENGINE - D365 Web API compliant, dependency-ordered
// =====================================================================
function showSyncModal(){
    document.getElementById("syncModal").classList.add("open");
    if(syncConfig.orgUrl)document.getElementById("syncOrgUrl").value=syncConfig.orgUrl;
    if(syncConfig.apiVersion)document.getElementById("syncApiVersion").value=syncConfig.apiVersion;
    if(syncConfig.token)document.getElementById("syncToken").value=syncConfig.token;
    renderSyncPipeline("idle");
}
function addSyncLog(msg,type="info"){
    const ts=new Date().toLocaleTimeString(),el=document.getElementById("syncLog");
    el.innerHTML+=`<div class="log-entry ${type}"><span class="timestamp">[${ts}]</span> ${msg}</div>`;el.scrollTop=el.scrollHeight;
}
function renderSyncPipeline(state,detail={}){
    const steps=[{id:"validate",icon:"&#9989;",name:"Validate"},{id:"serialize",icon:"&#128257;",name:"Serialize OData"},{id:"auth",icon:"&#128274;",name:"Authenticate"},{id:"push",icon:"&#9729;",name:"Push (ordered)"},{id:"confirm",icon:"&#10003;",name:"Confirm"}];
    const sm={idle:{},validating:{validate:"active"},serializing:{validate:"done",serialize:"active"},authenticating:{validate:"done",serialize:"done",auth:"active"},pushing:{validate:"done",serialize:"done",auth:"done",push:"active"},done:{validate:"done",serialize:"done",auth:"done",push:"done",confirm:"done"},error:detail};
    const m=sm[state]||{};let h="";
    for(const s of steps){h+=`<div class="pipeline-step ${m[s.id]||""}"><div class="step-icon">${s.icon}</div><div class="step-info"><div class="step-name">${s.name}</div></div></div>`;if(s!==steps[steps.length-1])h+='<div class="pipeline-arrow">&#8595;</div>';}
    document.getElementById("pipelineViz").innerHTML=h;
}

// Serialize a record to D365 OData JSON - correct binding format
function serializeForD365(entityName,record){
    const schema=SCHEMAS[entityName],odata={};
    for(const[fname,fdef]of Object.entries(schema.fields)){
        // Skip fields D365 manages
        if(fdef.syncExclude||fdef.computed||fdef.auto)continue;
        // Lookup fields -> @odata.bind with proper navigation property
        if(fdef.type==="lookup"){
            const val=record[fname];
            if(val&&fdef.navProperty&&fdef.navEntitySet){
                odata[`${fdef.navProperty}@odata.bind`]=`/${fdef.navEntitySet}(${val})`;
            }
            continue;
        }
        // Regular fields
        const val=record[fname];
        if(val!==null&&val!==undefined)odata[fname]=val;
    }
    return odata;
}

async function testConnection(){
    const orgUrl=document.getElementById("syncOrgUrl").value.trim(),token=document.getElementById("syncToken").value.trim(),ver=document.getElementById("syncApiVersion").value;
    if(!orgUrl||!token){addSyncLog("Configure URL and token first.","error");return;}
    addSyncLog("Testing connection...","info");
    try{const r=await fetch(orgUrl.replace(/\/+$/,"")+`/api/data/${ver}/WhoAmI()`,{headers:{"Authorization":"Bearer "+token,"Accept":"application/json","OData-Version":"4.0"}});
    if(r.ok){const b=await r.json();document.getElementById("syncDot").className="sync-dot connected";document.getElementById("syncStatusText").textContent="Connected: "+b.UserId;addSyncLog("Connected! User: "+b.UserId,"success");}
    else throw new Error(`HTTP ${r.status}`);}
    catch(e){document.getElementById("syncDot").className="sync-dot disconnected";document.getElementById("syncStatusText").textContent="Failed";addSyncLog("Failed: "+e.message,"error");}
}

async function startSync(){
    const orgUrl=document.getElementById("syncOrgUrl").value.trim(),token=document.getElementById("syncToken").value.trim(),ver=document.getElementById("syncApiVersion").value;
    const dryRun=document.getElementById("syncDryRun").checked,useUpsert=document.getElementById("syncUpsert").checked;
    const baseUrl=orgUrl.replace(/\/+$/,"")+`/api/data/${ver}`;

    addSyncLog("=== SYNC START (Dependency Ordered) ===","info");

    // Step 1: Validate ALL entities
    renderSyncPipeline("validating");addSyncLog("Validating...","info");await sleep(200);
    let totalErrs=0,totalRecs=0;
    for(const ent of SYNC_ORDER){
        const pending=data[ent].filter(r=>r._syncState!=="synced");totalRecs+=pending.length;
        for(const rec of pending){const errs=validateRecord(ent,rec);if(errs.length){totalErrs+=errs.length;addSyncLog(`  ${SCHEMAS[ent].label} "${rec[SCHEMAS[ent].primaryName]}": ${errs.map(e=>e.msg).join(", ")}`,"warn");}}
    }
    if(totalErrs){addSyncLog(`Validation failed: ${totalErrs} errors`,"error");renderSyncPipeline("error",{validate:"error"});return;}
    addSyncLog(`${totalRecs} records validated OK`,"success");

    // Step 2: Serialize in dependency order
    renderSyncPipeline("serializing");addSyncLog("Serializing (dependency order)...","info");await sleep(200);
    const payloads={};
    for(const ent of SYNC_ORDER){
        const schema=SCHEMAS[ent],pending=data[ent].filter(r=>r._syncState!=="synced");
        payloads[ent]=pending.map(rec=>({id:rec[schema.primaryKey],body:serializeForD365(ent,rec),name:rec[schema.primaryName]||rec[schema.primaryKey].substring(0,8)}));
        if(payloads[ent].length)addSyncLog(`  ${schema.plural}: ${payloads[ent].length} records`,"info");
    }

    // Dry run - show what WOULD happen
    if(dryRun){
        addSyncLog("=== DRY RUN - No data sent ===","warn");
        for(const ent of SYNC_ORDER){for(const p of payloads[ent]){
            const method=useUpsert?"UPSERT":"POST";
            addSyncLog(`  ${method} /${SCHEMAS[ent].oDataSet}(${p.id}): ${p.name}`,"info");
            // Show the OData bind entries
            for(const[k,v]of Object.entries(p.body)){if(k.includes("@odata.bind"))addSyncLog(`    ${k} = ${v}`,"info");}
        }}
        renderSyncPipeline("done");addSyncLog("Dry run complete. Uncheck Dry Run to push.","success");
        saveSyncConfig();syncConfig.orgUrl=orgUrl;syncConfig.apiVersion=ver;syncConfig.token=token;saveSyncConfig();return;
    }

    // Step 3: Auth
    if(!orgUrl||!token){addSyncLog("No endpoint/token","error");renderSyncPipeline("error",{validate:"done",serialize:"done",auth:"error"});return;}
    renderSyncPipeline("authenticating");addSyncLog("Authenticating...","info");await sleep(200);
    try{const r=await fetch(baseUrl+"/WhoAmI()",{headers:{"Authorization":"Bearer "+token,"Accept":"application/json","OData-Version":"4.0"}});if(!r.ok)throw new Error("HTTP "+r.status);addSyncLog("Auth OK","success");}
    catch(e){addSyncLog("Auth failed: "+e.message,"error");renderSyncPipeline("error",{validate:"done",serialize:"done",auth:"error"});return;}

    // Step 4: Push in DEPENDENCY ORDER
    renderSyncPipeline("pushing");addSyncLog("Pushing in dependency order...","info");
    let okCount=0,failCount=0;
    for(const ent of SYNC_ORDER){
        if(!payloads[ent].length)continue;
        addSyncLog(`  --- ${SCHEMAS[ent].plural} ---`,"info");
        const schema=SCHEMAS[ent];
        for(const p of payloads[ent]){
            try{
                const method=useUpsert?"PATCH":"POST";
                const url=useUpsert?`${baseUrl}/${schema.oDataSet}(${p.id})`:`${baseUrl}/${schema.oDataSet}`;
                const headers={"Authorization":"Bearer "+token,"Content-Type":"application/json","Accept":"application/json","OData-Version":"4.0","Prefer":"return=representation"};
                if(useUpsert)headers["If-Match"]="*";
                const resp=await fetch(url,{method,headers,body:JSON.stringify(p.body)});
                if(resp.ok||resp.status===204){
                    okCount++;const rec=data[ent].find(r=>r[schema.primaryKey]===p.id);if(rec)rec._syncState="synced";
                    addSyncLog(`  ${method} ${p.name} - OK`,"success");
                } else {
                    failCount++;const err=await resp.text();
                    addSyncLog(`  ${method} ${p.name} - FAIL ${resp.status}: ${err.substring(0,120)}`,"error");
                }
            }catch(e){failCount++;addSyncLog(`  ${p.name} - ERROR: ${e.message}`,"error");}
        }
    }
    save();renderTable();
    if(!failCount){renderSyncPipeline("done");addSyncLog(`Sync complete! ${okCount} records pushed.`,"success");document.getElementById("syncDot").className="sync-dot connected";}
    else{renderSyncPipeline("error",{validate:"done",serialize:"done",auth:"done",push:"error"});addSyncLog(`${okCount} OK, ${failCount} failed`,"warn");}
    syncConfig.orgUrl=orgUrl;syncConfig.apiVersion=ver;syncConfig.token=token;saveSyncConfig();updateCounts();
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// =====================================================================
// CONTEXT-AWARE AI ENGINE (preserved from previous build)
// =====================================================================
const ContextAI={
    _corpus:{
        firstNames:["James","Maria","Robert","Patricia","Michael","Jennifer","David","Linda","William","Elizabeth","Richard","Susan","Joseph","Jessica","Thomas","Sarah","Christopher","Karen","Daniel","Lisa","Matthew","Nancy","Anthony","Betty","Mark","Margaret","Donald","Sandra","Steven","Ashley","Andrew","Stephanie","Joshua","Nicole","Kenneth","Samantha","Kevin","Rachel","Brian","Laura","George","Andrea","Timothy","Kimberly","Jason","Michelle","Ryan","Amber","Jacob","Megan","Gary","Rebecca","Nicholas","Catherine","Eric","Heather","Jonathan","Diana","Aaron","Olivia"],
        lastNames:["Smith","Johnson","Williams","Brown","Jones","Garcia","Miller","Davis","Rodriguez","Martinez","Hernandez","Lopez","Wilson","Anderson","Thomas","Taylor","Moore","Jackson","Martin","Lee","Thompson","White","Harris","Clark","Lewis","Robinson","Walker","Young","King","Wright","Allen","Scott","Green","Baker","Adams","Nelson","Hill","Ramirez","Campbell","Mitchell","Roberts","Carter","Phillips","Evans","Turner","Torres","Parker","Collins","Edwards","Stewart","Flores","Morris","Nguyen","Murphy","Rivera","Cook","Rogers","Morgan","Peterson","Cooper"],
        industries:{
            12:{name:"Technology",companies:["Nexus Digital","CloudBridge","DataForge","CodeVault","PixelWave","ByteShift","NetPulse","SkyCore","DeepStack","Quantum Logic"],titles:["Software Engineer","DevOps Lead","Product Manager","CTO","VP Engineering","Data Scientist","Solutions Architect"],opTypes:["SaaS Platform","Cloud Migration","DevOps Pipeline","AI Integration","API Gateway","Cybersecurity Suite"],caseTypes:["API rate limit exceeded","SSO integration failure","Data pipeline timeout","Deployment rollback needed"]},
            8:{name:"Healthcare",companies:["MedCore Systems","HealthBridge","CareSync","PulsePoint","Vita Analytics","BioTrace","MedWave","ClinicFlow"],titles:["Chief Medical Officer","Health IT Director","Clinical Systems Manager","Compliance Officer","EHR Administrator"],opTypes:["EHR Implementation","Telehealth Platform","HIPAA Compliance","Clinical Analytics"],caseTypes:["HL7 interface error","Patient data sync failure","HIPAA audit finding"]},
            6:{name:"Finance",companies:["Capital Nexus","FinEdge","TrustBridge","LedgerPoint","Meridian Capital","VaultStream"],titles:["CFO","Risk Analyst","Portfolio Manager","Compliance Director","Financial Controller"],opTypes:["Risk Analytics","Regulatory Compliance","Fraud Detection","Portfolio Management"],caseTypes:["Transaction reconciliation error","Regulatory report discrepancy","Batch processing failure"]},
            10:{name:"Manufacturing",companies:["ForgeWorks","PrecisionCraft","SteelVault","FactoryEdge","ToolCore","AlloyDynamics"],titles:["Plant Manager","QA Director","Supply Chain Lead","Operations Manager","Production Engineer"],opTypes:["MES Implementation","Supply Chain Optimization","Predictive Maintenance","IoT Sensor Network"],caseTypes:["Production line downtime","Inventory sync error","Equipment sensor malfunction"]},
            11:{name:"Retail",companies:["ShopVault","RetailEdge","MarketPulse","CartBridge","StoreFront Pro","CommerceCore"],titles:["Store Director","E-commerce Manager","Category Manager","Omnichannel Strategist"],opTypes:["POS Upgrade","E-commerce Platform","Loyalty Program","Omnichannel Integration"],caseTypes:["POS terminal offline","Inventory discrepancy","Payment gateway timeout"]},
            1:{name:"Accounting",companies:["Ledger & Associates","ClearBooks","AuditPro","TaxVantage","FiscalPoint","NumericEdge"],titles:["Managing Partner","Senior Auditor","Tax Director","Controller","Forensic Accountant"],opTypes:["Audit Automation","Tax Platform","ERP Integration","Compliance Suite"],caseTypes:["Journal entry mismatch","Tax calculation error","Audit trail gap"]},
            2:{name:"Agriculture",companies:["GreenField Ag","HarvestLink","TerraNova Farms","CropWatch","AgriVault","SeedBridge"],titles:["Farm Operations Manager","Agronomist","Supply Chain Director","Field Systems Lead"],opTypes:["Precision Agriculture Platform","Crop Analytics","Supply Chain Tracking","IoT Sensor Deployment"],caseTypes:["Sensor data gap","Yield forecast discrepancy","Irrigation system fault"]},
            3:{name:"Construction",companies:["BuildCore","SiteForge","Ironworks Construction","PillarPoint","StructurEdge","CraneField"],titles:["Project Manager","Site Superintendent","Safety Director","Estimator","BIM Coordinator"],opTypes:["Project Management Suite","BIM Implementation","Safety Compliance","Fleet Tracking"],caseTypes:["Schedule overrun alert","Safety inspection failure","Permit delay"]},
            4:{name:"Consulting",companies:["Stratton Advisory","InsightBridge","ClearPath Consulting","Keystone Group","Meridian Advisors","PivotPoint"],titles:["Managing Director","Principal Consultant","Strategy Lead","Engagement Manager","Senior Analyst"],opTypes:["Strategy Engagement","Digital Advisory","M&A Due Diligence","Operating Model Redesign"],caseTypes:["Deliverable revision request","Scope creep dispute","Resource staffing gap"]},
            5:{name:"Education",companies:["EduCore Systems","CampusBridge","LearnVault","Scholastic Tech","AcademyEdge","BrightPath"],titles:["Dean of Technology","Registrar","Academic Director","EdTech Coordinator","Curriculum Lead"],opTypes:["LMS Implementation","Student Information System","Virtual Classroom","Assessment Platform"],caseTypes:["LMS login failure","Grade sync error","Enrollment data mismatch"]},
            7:{name:"Government",companies:["CivicPulse","GovBridge","PublicWorks Digital","CitizenCore","FedVault","MunicipalEdge"],titles:["IT Director","Program Manager","Policy Analyst","Chief Data Officer","Digital Services Lead"],opTypes:["Citizen Portal","Case Management System","Open Data Platform","Permitting System"],caseTypes:["Portal downtime","Data FOIA request","System authorization lapse"]},
            9:{name:"Hospitality",companies:["StayBridge","GuestVault","HospitalityCore","ResorTech","BookingEdge","LodgePulse"],titles:["General Manager","Revenue Manager","Guest Experience Director","Hotel Operations VP"],opTypes:["Property Management System","Revenue Optimization","Guest Experience Platform","Channel Manager"],caseTypes:["Booking system outage","Rate parity violation","Guest complaint escalation"]},
            13:{name:"Telecom",companies:["SignalBridge","TeleVault","SpectrumCore","WaveLink","FiberEdge","CommPulse"],titles:["Network Director","NOC Manager","Provisioning Lead","Telecom Analyst","Infrastructure VP"],opTypes:["5G Rollout","Network Monitoring","OSS/BSS Integration","Customer Portal"],caseTypes:["Network outage report","SLA breach","Provisioning failure"]},
            14:{name:"Transportation",companies:["RouteForge","TransitCore","FleetVault","CargoLink","LogiPulse","FreightBridge"],titles:["Fleet Manager","Logistics Director","Route Planner","Safety Compliance Officer","Operations VP"],opTypes:["Fleet Management System","Route Optimization","Warehouse Automation","Last-Mile Tracking"],caseTypes:["Shipment tracking error","Route deviation alert","Vehicle maintenance overdue"]},
            15:{name:"Utilities",companies:["GridVault","PowerEdge","MeterBridge","EnergyCore","FlowPulse","UtiliTech"],titles:["Grid Operations Manager","Utility Director","Meter Data Analyst","Energy Efficiency Lead"],opTypes:["Smart Grid Platform","Meter Data Management","Outage Management","Energy Analytics"],caseTypes:["Meter reading discrepancy","Outage response delay","Billing calculation error"]},
        },
        genericCompanies:["Vertex Solutions","Pinnacle Group","Summit Partners","Catalyst Corp","Horizon Enterprises","Apex Global","Vanguard Systems","Atlas Dynamics","Crestline Holdings","Orion Strategies","Silverline Consulting","Beacon Analytics","Ironclad Systems","Frostbyte Technologies","Redwood Partners","Zenith Group","Evergreen Capital","Trident Solutions","Obsidian Corp","Luminary Holdings","Prism Digital","Cascade Ventures","Ember Technologies","Polaris Group","Ironbridge Capital","Nexgen Systems","Sapphire Consulting","Stonewall Industries","Titanium Corp","Aether Solutions"],
        genericTitles:["CEO","COO","CTO","CFO","VP Sales","VP Marketing","Director of Operations","Senior Manager","Project Lead","Business Analyst","Account Executive"],
        genericOpTypes:["Digital Transformation","System Integration","Process Automation","Platform Migration","Security Assessment","Custom Development","Managed Services"],
        genericCaseTypes:["Login failed","Data export issue","Performance degradation","Feature request","Billing discrepancy","Integration sync error","Report timeout"],
        cityStateMap:{"Seattle":"WA","Portland":"OR","San Francisco":"CA","Los Angeles":"CA","Austin":"TX","Dallas":"TX","Denver":"CO","Chicago":"IL","Boston":"MA","New York":"NY","Atlanta":"GA","Miami":"FL","Phoenix":"AZ","Nashville":"TN","San Diego":"CA","Raleigh":"NC","Minneapolis":"MN","Detroit":"MI","Charlotte":"NC","Indianapolis":"IN","Columbus":"OH","Salt Lake City":"UT","Kansas City":"MO","Tampa":"FL","Pittsburgh":"PA","Cincinnati":"OH","Orlando":"FL","Sacramento":"CA","Las Vegas":"NV","Milwaukee":"WI","Richmond":"VA","Boise":"ID"},
    },
    buildContext(entityName,currentRecord){
        const ctx={entity:entityName,record:currentRecord||{},totalRecords:0,distributions:{},existingValues:{},accountContacts:{},dominantIndustry:null,
            revenueStats:{min:500000,max:50000000,avg:5000000},employeeStats:{min:10,max:5000,avg:250},opValueStats:{min:10000,max:500000,avg:150000}};
        for(const[e,recs]of Object.entries(data)){ctx.totalRecords+=recs.length;ctx.existingValues[e]={};for(const[fn]of Object.entries(SCHEMAS[e].fields))ctx.existingValues[e][fn]=recs.map(r=>r[fn]).filter(v=>v!=null&&v!=="");}
        const inds=data.accounts.map(a=>a.industrycode).filter(Boolean);if(inds.length){const f={};for(const i of inds)f[i]=(f[i]||0)+1;ctx.distributions.industry=f;ctx.dominantIndustry=Object.entries(f).sort((a,b)=>b[1]-a[1])[0][0];}
        const revs=data.accounts.map(a=>a.revenue).filter(v=>typeof v==="number");if(revs.length)ctx.revenueStats={min:Math.min(...revs),max:Math.max(...revs),avg:revs.reduce((s,v)=>s+v,0)/revs.length};
        const emps=data.accounts.map(a=>a.numberofemployees).filter(v=>typeof v==="number");if(emps.length)ctx.employeeStats={min:Math.min(...emps),max:Math.max(...emps),avg:emps.reduce((s,v)=>s+v,0)/emps.length};
        const opv=data.opportunities.map(o=>o.estimatedvalue).filter(v=>typeof v==="number");if(opv.length)ctx.opValueStats={min:Math.min(...opv),max:Math.max(...opv),avg:opv.reduce((s,v)=>s+v,0)/opv.length};
        for(const c of data.contacts){if(c._parentcustomerid_value){if(!ctx.accountContacts[c._parentcustomerid_value])ctx.accountContacts[c._parentcustomerid_value]=[];ctx.accountContacts[c._parentcustomerid_value].push(c);}}
        for(const[e,recs]of Object.entries(data)){for(const[fn,fd]of Object.entries(SCHEMAS[e].fields)){if(fd.type==="picklist"&&fd.options){const vs=recs.map(r=>r[fn]).filter(v=>v!=null);if(vs.length){const f={};for(const v of vs)f[v]=(f[v]||0)+1;ctx.distributions[`${e}.${fn}`]=f;}}}}
        return ctx;
    },
    _pickNovel(pool,existing){if(!pool.length)return null;const f={};for(const v of existing)f[v]=(f[v]||0)+1;const unused=pool.filter(v=>!f[v]);if(unused.length)return unused[Math.floor(Math.random()*unused.length)];const sfx=[" Group"," International"," Plus"," Pro"," Global"," Technologies"," Dynamics"," Partners"," Networks"," Labs"," Digital"," Industries"," Collective"," Works"," Ventures"," Capital"," Associates"," Consulting"];const base=pool[Math.floor(Math.random()*pool.length)];const s=sfx[Math.floor(Math.random()*sfx.length)];const v=base+s;if(!f[v])return v;return base+" "+String.fromCharCode(65+Math.floor(Math.random()*26))+String.fromCharCode(65+Math.floor(Math.random()*26));},
    _pickWPL(fd,dist){const k=Object.keys(fd.options).map(Number);if(!dist||!Object.keys(dist).length)return k[Math.floor(Math.random()*k.length)];if(Math.random()<0.5)return k[Math.floor(Math.random()*k.length)];const maxC=Math.max(...Object.values(dist),1);const w=k.map(v=>({v,w:maxC-(dist[v]||0)+1}));const t=w.reduce((s,x)=>s+x.w,0);let r=Math.random()*t;for(const x of w){r-=x.w;if(r<=0)return x.v;}return k[0];},
    _genNum(stats){if(!stats.avg)return Math.floor(Math.random()*100000);const range=Math.max(stats.max-stats.min,stats.avg*0.8);const spread=range*0.5;const base=stats.avg+(Math.random()-0.5)*spread*2;const jitter=0.85+Math.random()*0.3;return Math.max(1000,Math.round(base*jitter));},
    _getInd(ctx){const r=ctx.record;let ic=r.industrycode;if(!ic&&(r._parentaccountid_value||r._parentcustomerid_value)){const a=data.accounts.find(x=>x.accountid===(r._parentaccountid_value||r._parentcustomerid_value));if(a)ic=a.industrycode;}if(!ic&&ctx.dominantIndustry)ic=parseInt(ctx.dominantIndustry);return this._corpus.industries[ic]||null;},
    _phone(){return`(${200+Math.floor(Math.random()*800)}) ${100+Math.floor(Math.random()*900)}-${1000+Math.floor(Math.random()*9000)}`;},

    generateField(ent,fn,ctx){
        const fd=SCHEMAS[ent].fields[fn],rec=ctx.record,ex=ctx.existingValues[ent]?.[fn]||[],ind=this._getInd(ctx);
        const pick=a=>a[Math.floor(Math.random()*a.length)],ri=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
        if(ent==="accounts"){
            if(fn==="name")return this._pickNovel(ind?ind.companies:this._corpus.genericCompanies,ex);
            if(fn==="accountnumber"){const ns=ex.map(v=>parseInt(String(v).replace(/\D/g,""))).filter(n=>!isNaN(n));return"ACC-"+(ns.length?Math.max(...ns)+1:1001);}
            if(fn==="telephone1")return this._phone();
            if(fn==="emailaddress1")return(rec.name||"co").toLowerCase().replace(/[^a-z0-9]/g,"")+"@example.com";
            if(fn==="websiteurl")return"https://"+(rec.name||"co").toLowerCase().replace(/[^a-z0-9]/g,"")+".com";
            if(fn==="revenue")return this._genNum(ctx.revenueStats);
            if(fn==="numberofemployees")return this._genNum(ctx.employeeStats);
            if(fn==="address1_city")return this._pickNovel(Object.keys(this._corpus.cityStateMap),ex);
            if(fn==="address1_stateorprovince"){const c=rec.address1_city;return c&&this._corpus.cityStateMap[c]?this._corpus.cityStateMap[c]:pick(Object.values(this._corpus.cityStateMap));}
            if(fn==="address1_country")return"United States";
            if(fn==="industrycode")return this._pickWPL(fd,ctx.distributions.industry);
            if(fn==="statecode")return 0;
            if(fn==="description")return`${rec.name||"Company"} is a ${(ind?ind.name:"general").toLowerCase()} company based in ${rec.address1_city||"various locations"}.`;
        }
        if(ent==="contacts"){
            if(fn==="firstname")return this._pickNovel(this._corpus.firstNames,ex);
            if(fn==="lastname")return this._pickNovel(this._corpus.lastNames,ex);
            if(fn==="jobtitle")return this._pickNovel(ind?ind.titles:this._corpus.genericTitles,ex);
            if(fn==="emailaddress1"){let dom="example.com";if(rec._parentcustomerid_value){const a=data.accounts.find(x=>x.accountid===rec._parentcustomerid_value);if(a)dom=a.name.toLowerCase().replace(/[^a-z0-9]/g,"")+".com";}return`${(rec.firstname||"c").toLowerCase()}.${(rec.lastname||"u").toLowerCase()}@${dom}`;}
            if(fn==="telephone1"||fn==="mobilephone")return this._phone();
            if(fn==="address1_city"){if(rec._parentcustomerid_value){const a=data.accounts.find(x=>x.accountid===rec._parentcustomerid_value);if(a?.address1_city)return a.address1_city;}return this._pickNovel(Object.keys(this._corpus.cityStateMap),ex);}
            if(fn==="address1_stateorprovince"){const c=rec.address1_city;return c&&this._corpus.cityStateMap[c]?this._corpus.cityStateMap[c]:pick(Object.values(this._corpus.cityStateMap));}
            if(fn==="_parentcustomerid_value"){if(!data.accounts.length)return null;const cc={};for(const c of data.contacts)if(c._parentcustomerid_value)cc[c._parentcustomerid_value]=(cc[c._parentcustomerid_value]||0)+1;return[...data.accounts].sort((a,b)=>(cc[a.accountid]||0)-(cc[b.accountid]||0))[0].accountid;}
            if(fn==="statecode")return 0;
            if(fn==="description"){let co="";if(rec._parentcustomerid_value){const a=data.accounts.find(x=>x.accountid===rec._parentcustomerid_value);if(a)co=` at ${a.name}`;}return`${[rec.firstname,rec.lastname].filter(Boolean).join(" ")||"Contact"} is a ${rec.jobtitle||"professional"}${co}.`;}
        }
        if(ent==="opportunities"){
            if(fn==="name"){const t=this._pickNovel(ind?ind.opTypes:this._corpus.genericOpTypes,ex);if(rec._parentaccountid_value){const a=data.accounts.find(x=>x.accountid===rec._parentaccountid_value);if(a)return`${t} - ${a.name}`;}return t;}
            if(fn==="estimatedvalue")return Math.round(this._genNum(ctx.opValueStats)/1000)*1000;
            if(fn==="closeprobability"){const s=rec.salesstagecode;return s===0?ri(10,30):s===1?ri(30,60):s===2?ri(60,85):s===3?ri(80,98):ri(20,70);}
            if(fn==="estimatedclosedate"){const d=new Date(),s=rec.salesstagecode;d.setDate(d.getDate()+(s===3?ri(7,30):s===2?ri(30,60):s===1?ri(60,120):ri(90,180)));return d.toISOString().slice(0,10);}
            if(fn==="_parentaccountid_value"){if(!data.accounts.length)return null;const oc={};for(const o of data.opportunities)if(o._parentaccountid_value)oc[o._parentaccountid_value]=(oc[o._parentaccountid_value]||0)+1;const pool=data.accounts.filter(a=>a.statecode===0);return[...(pool.length?pool:data.accounts)].sort((a,b)=>(oc[a.accountid]||0)-(oc[b.accountid]||0))[0].accountid;}
            if(fn==="_parentcontactid_value"){const aid=rec._parentaccountid_value;if(aid&&ctx.accountContacts[aid]?.length)return pick(ctx.accountContacts[aid]).contactid;return data.contacts.length?pick(data.contacts).contactid:null;}
            if(fn==="stepname"){const stg=["Qualify","Develop","Propose","Close"];return rec.salesstagecode!=null?stg[rec.salesstagecode]||stg[0]:pick(stg);}
            if(fn==="salesstagecode")return this._pickWPL(fd,ctx.distributions["opportunities.salesstagecode"]);
            if(fn==="statecode")return 0;
            if(fn==="description")return`${rec.name||"Opportunity"} - est. $${rec.estimatedvalue?Number(rec.estimatedvalue).toLocaleString():"TBD"}, ${rec.closeprobability||"?"}% probability.`;
        }
        if(ent==="leads"){
            if(fn==="firstname")return this._pickNovel(this._corpus.firstNames,ex);
            if(fn==="lastname")return this._pickNovel(this._corpus.lastNames,ex);
            if(fn==="companyname")return this._pickNovel([...data.accounts.map(a=>a.name),...this._corpus.genericCompanies],ex);
            if(fn==="jobtitle")return this._pickNovel(ind?ind.titles:this._corpus.genericTitles,ex);
            if(fn==="emailaddress1"){const co=rec.companyname?rec.companyname.toLowerCase().replace(/[^a-z0-9]/g,"")+".com":"example.com";return`${(rec.firstname||"l").toLowerCase()}.${(rec.lastname||"u").toLowerCase()}@${co}`;}
            if(fn==="telephone1")return this._phone();
            if(fn==="address1_city")return this._pickNovel(Object.keys(this._corpus.cityStateMap),ex);
            if(fn==="leadsourcecode")return this._pickWPL(fd,ctx.distributions["leads.leadsourcecode"]);
            if(fn==="leadqualitycode")return this._pickWPL(fd,ctx.distributions["leads.leadqualitycode"]);
            if(fn==="statecode")return 0;
            if(fn==="description")return`${[rec.firstname,rec.lastname].filter(Boolean).join(" ")||"Lead"} from ${rec.companyname||"company"}.`;
        }
        if(ent==="incidents"){
            if(fn==="title")return this._pickNovel(ind?ind.caseTypes:this._corpus.genericCaseTypes,ex);
            if(fn==="_customerid_value"){if(!data.contacts.length)return null;const cc={};for(const c of data.incidents)if(c._customerid_value)cc[c._customerid_value]=(cc[c._customerid_value]||0)+1;return[...data.contacts].sort((a,b)=>(cc[a.contactid]||0)-(cc[b.contactid]||0))[0].contactid;}
            if(fn==="caseorigincode")return this._pickWPL(fd,ctx.distributions["incidents.caseorigincode"]);
            if(fn==="prioritycode")return this._pickWPL(fd,ctx.distributions["incidents.prioritycode"]);
            if(fn==="severitycode"){const p=rec.prioritycode;return p===1?pick([1,2]):p===3?pick([3,4]):pick([2,3]);}
            if(fn==="statecode")return 0;
            if(fn==="description"){let cust="customer";if(rec._customerid_value){const c=data.contacts.find(x=>x.contactid===rec._customerid_value);if(c)cust=c.fullname||"customer";}return`${rec.title||"Case"} reported by ${cust}.`;}
        }
        if(fd.type==="picklist"&&fd.options)return this._pickWPL(fd,ctx.distributions[`${ent}.${fn}`]);
        if(fd.type==="lookup"&&fd.target){const td=data[fd.target];return td?.length?td[Math.floor(Math.random()*td.length)][SCHEMAS[fd.target].primaryKey]:null;}
        return null;
    },
    generateFullRecord(ent,rec){
        const s=SCHEMAS[ent],r={...rec},ctx=this.buildContext(ent,r);
        const order={lookup:0,picklist:1,string:2,int:3,money:3,date:4,text:5};
        const fields=Object.entries(s.fields).filter(([fn,fd])=>!fd.auto&&!fd.computed).sort((a,b)=>(order[a[1].type]||3)-(order[b[1].type]||3));
        for(const[fn,fd]of fields){const v=this.generateField(ent,fn,{...ctx,record:r});if(v!=null){if(fd.type==="int"||fd.type==="picklist")r[fn]=parseInt(v);else if(fd.type==="money")r[fn]=parseFloat(v);else r[fn]=v;}}
        if(s.fields.fullname)r.fullname=[r.firstname,r.lastname].filter(Boolean).join(" ");
        r._modified=new Date().toISOString();return r;
    },
};

function aiGenerateField(fn){if(!editMode||!selectedId)return;const s=SCHEMAS[activeEntity],rec=data[activeEntity].find(r=>r[s.primaryKey]===selectedId);if(!rec)return;const b=document.querySelector(`[data-ai-field="${fn}"]`);if(b)b.classList.add("generating");setTimeout(()=>{const ctx=ContextAI.buildContext(activeEntity,rec);const v=ContextAI.generateField(activeEntity,fn,ctx);if(v!=null)updateField(fn,v);if(b)b.classList.remove("generating");renderPanel();},150);}
function aiGenerateAllFields(){if(!editMode||!selectedId)return;const s=SCHEMAS[activeEntity],i=data[activeEntity].findIndex(r=>r[s.primaryKey]===selectedId);if(i===-1)return;data[activeEntity][i]=ContextAI.generateFullRecord(activeEntity,data[activeEntity][i]);save();renderTable();renderPanel();}
function aiAddRecord(){if(!editMode)return;const s=SCHEMAS[activeEntity],rec={};rec[s.primaryKey]=newGuid();rec._syncState="new";rec._created=new Date().toISOString();rec._modified=new Date().toISOString();for(const[fn,fd]of Object.entries(s.fields)){if(fd.default!==undefined)rec[fn]=fd.default;else if(!rec[fn])rec[fn]=null;}if(activeEntity==="incidents")rec.ticketnumber="CAS-"+(++ticketCounter);data[activeEntity].push(ContextAI.generateFullRecord(activeEntity,rec));selectedId=data[activeEntity][data[activeEntity].length-1][s.primaryKey];save();renderTable();renderPanel();renderBreadcrumb();}
function aiGenerateRecords(){if(!editMode){alert("Switch to Edit mode.");return;}const t=Object.values(data).reduce((s,a)=>s+a.length,0);const n=parseInt(prompt(`AI-generate how many ${SCHEMAS[activeEntity].plural}?\n(Analyzing ${t} existing records for context)`,"5"));if(!n||n<1)return;for(let i=0;i<n;i++){const s=SCHEMAS[activeEntity],rec={};rec[s.primaryKey]=newGuid();rec._syncState="new";rec._created=new Date().toISOString();rec._modified=new Date().toISOString();for(const[fn,fd]of Object.entries(s.fields)){if(fd.default!==undefined)rec[fn]=fd.default;else rec[fn]=null;}if(activeEntity==="incidents")rec.ticketnumber="CAS-"+(++ticketCounter);data[activeEntity].push(ContextAI.generateFullRecord(activeEntity,rec));}save();renderTable();renderPanel();}
function generateSampleData(){if(!editMode)return;if(Object.values(data).some(a=>a.length>0)){if(!confirm("Add sample records to existing data?"))return;}const seeds=[{name:"Contoso Ltd",industrycode:12},{name:"Northwind Traders",industrycode:8},{name:"Adventure Works",industrycode:6},{name:"Fabrikam Inc",industrycode:10},{name:"Litware Inc",industrycode:11}];for(const s of seeds){const r={accountid:newGuid(),name:s.name,industrycode:s.industrycode,statecode:0,_syncState:"new",_created:new Date().toISOString(),_modified:new Date().toISOString()};data.accounts.push(ContextAI.generateFullRecord("accounts",r));}for(let i=0;i<5;i++){const r={accountid:newGuid(),statecode:0,_syncState:"new",_created:new Date().toISOString(),_modified:new Date().toISOString()};data.accounts.push(ContextAI.generateFullRecord("accounts",r));}for(let i=0;i<15;i++){const r={contactid:newGuid(),statecode:0,_syncState:"new",_created:new Date().toISOString(),_modified:new Date().toISOString()};data.contacts.push(ContextAI.generateFullRecord("contacts",r));}for(let i=0;i<8;i++){const r={opportunityid:newGuid(),statecode:0,_syncState:"new",_created:new Date().toISOString(),_modified:new Date().toISOString()};data.opportunities.push(ContextAI.generateFullRecord("opportunities",r));}for(let i=0;i<6;i++){const r={leadid:newGuid(),statecode:0,_syncState:"new",_created:new Date().toISOString(),_modified:new Date().toISOString()};data.leads.push(ContextAI.generateFullRecord("leads",r));}for(let i=0;i<5;i++){const r={incidentid:newGuid(),ticketnumber:"CAS-"+(++ticketCounter),statecode:0,_syncState:"new",_created:new Date().toISOString(),_modified:new Date().toISOString()};data.incidents.push(ContextAI.generateFullRecord("incidents",r));}save();renderTable();renderPanel();}

// =====================================================================
// RELATIONSHIP ENGINE - Autonomous CRM Tree Builder
// Uses ContextAI sparkle pattern to grow interconnected record clusters.
// Each press: creates a relationship cluster, links orphans, enriches
// existing records (data sloshing), and deepens shallow relationships.
// =====================================================================
const RelEngine={
    growthLog:[],
    _toastTimer:null,

    // Create a fully AI-filled record with optional field overrides
    _create(entity,overrides={}){
        const s=SCHEMAS[entity],rec={};
        rec[s.primaryKey]=newGuid();rec._syncState="new";
        rec._created=new Date().toISOString();rec._modified=new Date().toISOString();
        for(const[fn,fd]of Object.entries(s.fields)){if(fd.default!==undefined)rec[fn]=fd.default;else if(!rec[fn])rec[fn]=null;}
        if(entity==="incidents")rec.ticketnumber="CAS-"+(++ticketCounter);
        // Apply overrides BEFORE AI generation so it uses them as relationship context
        Object.assign(rec,overrides);
        const filled=ContextAI.generateFullRecord(entity,rec);
        data[entity].push(filled);
        return filled;
    },

    // Analyze current data for gaps, orphans, imbalances
    _analyze(){
        const counts={};for(const e of Object.keys(SCHEMAS))counts[e]=data[e].length;
        // Orphans: records missing their parent lookup
        const orphanContacts=data.contacts.filter(c=>!c._parentcustomerid_value||!data.accounts.find(a=>a.accountid===c._parentcustomerid_value));
        const orphanOpps=data.opportunities.filter(o=>!o._parentaccountid_value||!data.accounts.find(a=>a.accountid===o._parentaccountid_value));
        const orphanCases=data.incidents.filter(i=>!i._customerid_value||!data.contacts.find(c=>c.contactid===i._customerid_value));
        // Per-account connection density
        const acctConn={};
        for(const a of data.accounts){
            const id=a.accountid;
            const contacts=data.contacts.filter(c=>c._parentcustomerid_value===id);
            const opps=data.opportunities.filter(o=>o._parentaccountid_value===id);
            const contactIds=contacts.map(c=>c.contactid);
            const cases=data.incidents.filter(i=>contactIds.includes(i._customerid_value));
            acctConn[id]={contacts:contacts.length,opportunities:opps.length,cases:cases.length,total:contacts.length+opps.length+cases.length};
        }
        // Find accounts with zero or very few connections
        const sparse=data.accounts.filter(a=>(acctConn[a.accountid]?.total||0)<3).sort((a,b)=>(acctConn[a.accountid]?.total||0)-(acctConn[b.accountid]?.total||0));
        // Entity balance ratios (ideal: ~3 contacts per account, ~1.5 opps, ~1 case, ~0.5 leads)
        const ideal={contacts:3,opportunities:1.5,incidents:1,leads:0.5};
        const gaps={};
        const base=Math.max(counts.accounts,1);
        for(const[e,ratio]of Object.entries(ideal)){
            const target=Math.round(base*ratio);
            gaps[e]=Math.max(0,target-counts[e]);
        }
        return{counts,orphanContacts,orphanOpps,orphanCases,acctConn,sparse,gaps};
    },

    // DATA SLOSHING - fix orphans, enrich empties, cross-pollinate
    _slosh(analysis){
        const pick=a=>a[Math.floor(Math.random()*a.length)];
        const log=(action,entity,name,detail)=>this.growthLog.push({action,entity,name,detail});

        // 1. Link orphaned contacts to least-connected accounts
        for(const c of analysis.orphanContacts.slice(0,3)){
            if(!data.accounts.length)break;
            const sorted=[...data.accounts].sort((a,b)=>(analysis.acctConn[a.accountid]?.contacts||0)-(analysis.acctConn[b.accountid]?.contacts||0));
            const acct=sorted[0];
            c._parentcustomerid_value=acct.accountid;
            c._modified=new Date().toISOString();
            if(c._syncState==="synced")c._syncState="modified";
            // Re-derive email + location from parent account
            c.emailaddress1=`${(c.firstname||"c").toLowerCase()}.${(c.lastname||"u").toLowerCase()}@${acct.name.toLowerCase().replace(/[^a-z0-9]/g,"")}.com`;
            if(acct.address1_city){c.address1_city=acct.address1_city;c.address1_stateorprovince=acct.address1_stateorprovince;}
            analysis.acctConn[acct.accountid].contacts++;analysis.acctConn[acct.accountid].total++;
            log("linked","contacts",c.fullname||"Contact",`â†’ ${acct.name}`);
        }

        // 2. Link orphaned opportunities
        for(const o of analysis.orphanOpps.slice(0,2)){
            if(!data.accounts.length)break;
            const sorted=[...data.accounts].sort((a,b)=>(analysis.acctConn[a.accountid]?.opportunities||0)-(analysis.acctConn[b.accountid]?.opportunities||0));
            const acct=sorted[0];
            o._parentaccountid_value=acct.accountid;
            const acctContacts=data.contacts.filter(c=>c._parentcustomerid_value===acct.accountid);
            if(acctContacts.length)o._parentcontactid_value=pick(acctContacts).contactid;
            o._modified=new Date().toISOString();
            if(o._syncState==="synced")o._syncState="modified";
            analysis.acctConn[acct.accountid].opportunities++;analysis.acctConn[acct.accountid].total++;
            log("linked","opportunities",o.name||"Opportunity",`â†’ ${acct.name}`);
        }

        // 3. Link orphaned cases
        for(const i of analysis.orphanCases.slice(0,2)){
            if(!data.contacts.length)break;
            // Prefer contacts that have an account (deeper tree)
            const withAcct=data.contacts.filter(c=>c._parentcustomerid_value&&data.accounts.find(a=>a.accountid===c._parentcustomerid_value));
            const pool=withAcct.length?withAcct:data.contacts;
            const sorted=[...pool].sort((a,b)=>{
                const ca=data.incidents.filter(x=>x._customerid_value===a.contactid).length;
                const cb=data.incidents.filter(x=>x._customerid_value===b.contactid).length;
                return ca-cb;
            });
            i._customerid_value=sorted[0].contactid;
            i._modified=new Date().toISOString();
            if(i._syncState==="synced")i._syncState="modified";
            log("linked","incidents",i.title||"Case",`â†’ ${sorted[0].fullname||"Contact"}`);
        }

        // 4. Enrich existing records with empty fields (fill gaps)
        const allEnts=Object.keys(SCHEMAS);
        for(let n=0;n<5;n++){
            const ent=allEnts[Math.floor(Math.random()*allEnts.length)];
            if(!data[ent].length)continue;
            const rec=data[ent][Math.floor(Math.random()*data[ent].length)];
            const s=SCHEMAS[ent];let filled=false;
            const ctx=ContextAI.buildContext(ent,rec);
            for(const[fn,fd]of Object.entries(s.fields)){
                if(fd.auto||fd.computed)continue;
                if(rec[fn]===null||rec[fn]===undefined||rec[fn]===""){
                    const v=ContextAI.generateField(ent,fn,{...ctx,record:rec});
                    if(v!=null){
                        if(fd.type==="int"||fd.type==="picklist")rec[fn]=parseInt(v);
                        else if(fd.type==="money")rec[fn]=parseFloat(v);
                        else rec[fn]=v;filled=true;
                    }
                }
            }
            if(filled){
                if(s.fields.fullname)rec.fullname=[rec.firstname,rec.lastname].filter(Boolean).join(" ");
                rec._modified=new Date().toISOString();
                if(rec._syncState==="synced")rec._syncState="modified";
                log("enriched",ent,rec[s.primaryName]||"record","filled empty fields");
            }
        }

        // 5. Deepen shallow relationships: accounts with contacts but no opps/cases
        for(const acct of analysis.sparse.slice(0,2)){
            const id=acct.accountid,conn=analysis.acctConn[id];if(!conn)continue;
            const acctContacts=data.contacts.filter(c=>c._parentcustomerid_value===id);
            // If has contacts but no opportunities, create one
            if(conn.contacts>0&&conn.opportunities===0){
                const contact=pick(acctContacts);
                const opp=this._create("opportunities",{_parentaccountid_value:id,_parentcontactid_value:contact?.contactid||null});
                log("deepened","opportunities",opp.name,`depth â†’ ${acct.name}`);
            }
            // If has contacts but no cases, create one
            if(acctContacts.length>0&&conn.cases===0&&Math.random()<0.6){
                const contact=pick(acctContacts);
                const inc=this._create("incidents",{_customerid_value:contact.contactid});
                log("deepened","incidents",inc.title,`depth â†’ ${contact.fullname||"Contact"}`);
            }
        }
    },

    // Grow a full relationship cluster around an account hub
    _growCluster(analysis){
        const{counts,acctConn}=analysis;
        const ri=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
        const pick=a=>a[Math.floor(Math.random()*a.length)];
        const log=(action,entity,name,detail)=>this.growthLog.push({action,entity,name,detail});

        // Pick or create an account as the hub
        let hub;
        // 40% chance to create new, or if no accounts exist
        if(!counts.accounts||Math.random()<0.4){
            hub=this._create("accounts");
            log("created","accounts",hub.name,"new hub");
        } else {
            // Pick a sparse account to expand
            const active=data.accounts.filter(a=>a.statecode===0);
            if(active.length){
                const sorted=[...active].sort((a,b)=>(acctConn[a.accountid]?.total||0)-(acctConn[b.accountid]?.total||0));
                const pool=sorted.slice(0,Math.max(1,Math.ceil(sorted.length/2)));
                hub=pick(pool);
                log("selected","accounts",hub.name,"expanding hub");
            } else {
                hub=this._create("accounts");
                log("created","accounts",hub.name,"new hub");
            }
        }

        const hubId=hub.accountid;
        const existingContacts=data.contacts.filter(c=>c._parentcustomerid_value===hubId);

        // Create 1-4 contacts at this account
        const numContacts=ri(1,4);
        const newContacts=[];
        for(let i=0;i<numContacts;i++){
            const c=this._create("contacts",{_parentcustomerid_value:hubId});
            newContacts.push(c);
            log("created","contacts",c.fullname||"Contact",`@ ${hub.name}`);
        }
        const allContacts=[...existingContacts,...newContacts];

        // Create 1-2 opportunities linked to hub + a contact
        const numOpps=ri(1,2);
        for(let i=0;i<numOpps;i++){
            const contact=pick(allContacts);
            const opp=this._create("opportunities",{
                _parentaccountid_value:hubId,
                _parentcontactid_value:contact?.contactid||null
            });
            log("created","opportunities",opp.name,`@ ${hub.name}`);
        }

        // Create 0-2 cases linked to contacts at this account
        const numCases=ri(0,2);
        for(let i=0;i<numCases;i++){
            const contact=pick(allContacts);
            if(contact){
                const inc=this._create("incidents",{_customerid_value:contact.contactid});
                log("created","incidents",inc.title,`for ${contact.fullname||"Contact"}`);
            }
        }

        // Create 0-2 leads related to this company's industry/region
        const numLeads=ri(0,2);
        for(let i=0;i<numLeads;i++){
            // Sometimes use the hub's company name (warm lead), sometimes novel
            const companyName=Math.random()<0.3?hub.name:null;
            const overrides={};
            if(companyName)overrides.companyname=companyName;
            if(hub.address1_city)overrides.address1_city=hub.address1_city;
            const lead=this._create("leads",overrides);
            log("created","leads",lead.fullname||"Lead",`@ ${lead.companyname||"company"}`);
        }
    },

    // MAIN: called on button press
    grow(){
        if(!editMode){alert("Switch to Edit mode first.");return;}
        const btn=document.getElementById("growBtn");
        if(btn)btn.classList.add("growing");

        this.growthLog=[];
        const analysis=this._analyze();

        // Phase 1: Data sloshing (fix + enrich existing data)
        this._slosh(analysis);

        // Phase 2: Grow a new relationship cluster
        this._growCluster(analysis);

        save();renderTable();renderPanel();updateCounts();

        if(btn)setTimeout(()=>btn.classList.remove("growing"),600);
        this._showToast();
    },

    _showToast(){
        let toast=document.getElementById("growthToast");
        if(!toast){toast=document.createElement("div");toast.id="growthToast";document.body.appendChild(toast);}

        const created=this.growthLog.filter(l=>l.action==="created").length;
        const linked=this.growthLog.filter(l=>l.action==="linked").length;
        const enriched=this.growthLog.filter(l=>l.action==="enriched").length;
        const deepened=this.growthLog.filter(l=>l.action==="deepened").length;
        const total=Object.values(data).reduce((s,a)=>s+a.length,0);
        const eIcons={accounts:"\u26C3",contacts:"\u263B",opportunities:"\u2605",leads:"\u25B6",incidents:"\u26A0"};
        const aIcons={created:"+",linked:"\u2192",enriched:"\u2191",deepened:"\u21F3",selected:"\u25CB"};

        let html=`<div class="growth-toast-header">CRM Tree Growth</div><div class="growth-toast-stats">`;
        if(created)html+=`<span class="gt-stat created">+${created} created</span>`;
        if(linked)html+=`<span class="gt-stat linked">${linked} linked</span>`;
        if(enriched)html+=`<span class="gt-stat enriched">${enriched} enriched</span>`;
        if(deepened)html+=`<span class="gt-stat deepened">${deepened} deepened</span>`;
        html+=`</div><div class="growth-toast-log">`;
        for(const e of this.growthLog){
            html+=`<div class="gt-entry gt-${e.action}"><span class="gt-icon">${eIcons[e.entity]||"\u2022"}</span><span class="gt-action">${aIcons[e.action]||"\u2022"}</span><span class="gt-name">${e.name||""}</span><span class="gt-detail">${e.detail||""}</span></div>`;
        }
        html+=`</div><div class="growth-toast-total">Total: ${total} records across ${Object.keys(SCHEMAS).length} entities</div>`;

        toast.innerHTML=html;toast.className="growth-toast show";
        clearTimeout(this._toastTimer);
        this._toastTimer=setTimeout(()=>{toast.className="growth-toast";},6000);
    },
};

// =====================================================================
// SCHEMA COMPLIANCE TESTS
// =====================================================================
function runTests(){
    const results=[];let pass=0,fail=0;
    function assert(name,cond,detail){if(cond){pass++;results.push({name,ok:true});}else{fail++;results.push({name,ok:false,detail});}}

    // T1: Sync order has all entities
    assert("Sync order includes all entities",SYNC_ORDER.length===Object.keys(SCHEMAS).length,"Missing entities in SYNC_ORDER");

    // T2: Accounts come before contacts (dependency)
    assert("Accounts sync before contacts",SYNC_ORDER.indexOf("accounts")<SYNC_ORDER.indexOf("contacts"));
    assert("Contacts sync before opportunities",SYNC_ORDER.indexOf("contacts")<SYNC_ORDER.indexOf("opportunities"));
    assert("Contacts sync before incidents",SYNC_ORDER.indexOf("contacts")<SYNC_ORDER.indexOf("incidents"));

    // T3: Every lookup has navProperty and navEntitySet
    for(const[ent,schema]of Object.entries(SCHEMAS)){
        for(const[fn,fd]of Object.entries(schema.fields)){
            if(fd.type==="lookup"){
                assert(`${ent}.${fn} has navProperty`,!!fd.navProperty,`Missing navProperty on ${ent}.${fn}`);
                assert(`${ent}.${fn} has navEntitySet`,!!fd.navEntitySet,`Missing navEntitySet on ${ent}.${fn}`);
                assert(`${ent}.${fn} navEntitySet matches target schema`,fd.navEntitySet===SCHEMAS[fd.target]?.oDataSet,`navEntitySet "${fd.navEntitySet}" doesn't match target oDataSet "${SCHEMAS[fd.target]?.oDataSet}"`);
            }
        }
    }

    // T4: statecode is syncExclude on all entities
    for(const[ent,schema]of Object.entries(SCHEMAS)){
        assert(`${ent}.statecode is syncExclude`,schema.fields.statecode?.syncExclude===true);
    }

    // T5: computed fields are syncExclude
    for(const[ent,schema]of Object.entries(SCHEMAS)){
        for(const[fn,fd]of Object.entries(schema.fields)){
            if(fd.computed)assert(`${ent}.${fn} computed -> syncExclude`,fd.syncExclude===true);
        }
    }

    // T6: ticketnumber is syncExclude
    assert("incidents.ticketnumber is syncExclude",SCHEMAS.incidents.fields.ticketnumber.syncExclude===true);

    // T7: serializeForD365 excludes syncExclude fields
    const testAcct={accountid:"test-guid",name:"Test Co",statecode:0,industrycode:12,_syncState:"new"};
    const serialized=serializeForD365("accounts",testAcct);
    assert("Serialized account excludes statecode",!("statecode" in serialized),"statecode found in serialized output");
    assert("Serialized account excludes accountid",!("accountid" in serialized),"accountid found in serialized output");
    assert("Serialized account includes name",serialized.name==="Test Co");

    // T8: serializeForD365 creates correct @odata.bind for lookups
    const testContact={contactid:"c-guid",firstname:"John",lastname:"Doe",_parentcustomerid_value:"acct-123",statecode:0,_syncState:"new"};
    const serContact=serializeForD365("contacts",testContact);
    assert("Contact lookup uses parentcustomerid_account@odata.bind","parentcustomerid_account@odata.bind" in serContact,`Got keys: ${Object.keys(serContact).filter(k=>k.includes("@")).join(", ")||"none"}`);
    assert("Contact bind value format correct",serContact["parentcustomerid_account@odata.bind"]==="/accounts(acct-123)",`Got: ${serContact["parentcustomerid_account@odata.bind"]}`);
    assert("Contact serialized excludes fullname",!("fullname" in serContact));
    assert("Contact serialized excludes statecode",!("statecode" in serContact));

    // T9: Opportunity lookups serialize correctly
    const testOpp={opportunityid:"o-guid",name:"Deal",_parentaccountid_value:"acct-456",_parentcontactid_value:"c-789",statecode:0,_syncState:"new"};
    const serOpp=serializeForD365("opportunities",testOpp);
    assert("Opp account bind correct","parentaccountid@odata.bind" in serOpp&&serOpp["parentaccountid@odata.bind"]==="/accounts(acct-456)");
    assert("Opp contact bind correct","parentcontactid@odata.bind" in serOpp&&serOpp["parentcontactid@odata.bind"]==="/contacts(c-789)");

    // T10: Case customerid polymorphic lookup
    const testCase={incidentid:"i-guid",title:"Bug",_customerid_value:"c-111",statecode:0,prioritycode:2,_syncState:"new"};
    const serCase=serializeForD365("incidents",testCase);
    assert("Case customer bind uses customerid_contact","customerid_contact@odata.bind" in serCase,`Got keys: ${Object.keys(serCase).filter(k=>k.includes("@")).join(", ")||"none"}`);
    assert("Case bind value correct",serCase["customerid_contact@odata.bind"]==="/contacts(c-111)");
    assert("Case excludes ticketnumber",!("ticketnumber" in serCase));
    assert("Case excludes statecode",!("statecode" in serCase));

    // T11: No _private fields leak into serialized output
    for(const key of Object.keys(serialized)){assert(`Account key "${key}" not internal`,!key.startsWith("_"));}
    for(const key of Object.keys(serContact)){assert(`Contact key "${key}" not internal`,!key.startsWith("_"));}

    // T12: AI generates valid records
    const aiAcct={accountid:newGuid(),statecode:0,_syncState:"new",_created:new Date().toISOString(),_modified:new Date().toISOString()};
    const filled=ContextAI.generateFullRecord("accounts",aiAcct);
    assert("AI fills account name",!!filled.name);
    assert("AI fills account city",!!filled.address1_city);
    const aiErrs=validateRecord("accounts",filled);
    assert("AI-generated account passes validation",aiErrs.length===0,aiErrs.map(e=>e.msg).join(", "));

    // T13: Relationship Engine tests
    // Save current data, use isolated data for testing
    const savedData=JSON.parse(JSON.stringify(data));
    data={accounts:[],contacts:[],opportunities:[],leads:[],incidents:[]};

    // T13a: _create makes valid records
    const testAcc=RelEngine._create("accounts");
    assert("RelEngine._create produces account with name",!!testAcc.name);
    assert("RelEngine._create account has guid",!!testAcc.accountid&&testAcc.accountid.includes("-"));
    assert("RelEngine._create account in data array",data.accounts.length===1);

    // T13b: _create applies overrides before AI fill
    const testCon=RelEngine._create("contacts",{_parentcustomerid_value:testAcc.accountid});
    assert("RelEngine._create contact linked to account",testCon._parentcustomerid_value===testAcc.accountid);
    assert("RelEngine._create contact has fullname",!!testCon.fullname);

    // T13c: _growCluster creates multi-entity cluster
    data={accounts:[],contacts:[],opportunities:[],leads:[],incidents:[]};
    const analysis=RelEngine._analyze();
    RelEngine.growthLog=[];
    RelEngine._growCluster(analysis);
    assert("Cluster creates at least 1 account",data.accounts.length>=1);
    assert("Cluster creates contacts",data.contacts.length>=1);
    assert("Cluster creates opportunities",data.opportunities.length>=1);
    // All contacts should be linked to an account
    const unlinkedContacts=data.contacts.filter(c=>!c._parentcustomerid_value||!data.accounts.find(a=>a.accountid===c._parentcustomerid_value));
    assert("Cluster contacts all linked to valid account",unlinkedContacts.length===0,`${unlinkedContacts.length} unlinked contacts`);
    // All opportunities should be linked to an account
    const unlinkedOpps=data.opportunities.filter(o=>!o._parentaccountid_value||!data.accounts.find(a=>a.accountid===o._parentaccountid_value));
    assert("Cluster opportunities linked to valid account",unlinkedOpps.length===0,`${unlinkedOpps.length} unlinked opps`);

    // T13d: _slosh links orphans
    data={accounts:[],contacts:[],opportunities:[],leads:[],incidents:[]};
    const sloshAcct=RelEngine._create("accounts");
    // Create orphan contact (no parent)
    const orphan={contactid:newGuid(),firstname:"Orphan",lastname:"Test",fullname:"Orphan Test",_parentcustomerid_value:null,statecode:0,_syncState:"new",_created:new Date().toISOString(),_modified:new Date().toISOString()};
    data.contacts.push(orphan);
    const sloshAnalysis=RelEngine._analyze();
    RelEngine.growthLog=[];
    RelEngine._slosh(sloshAnalysis);
    assert("Slosh links orphan contact",orphan._parentcustomerid_value===sloshAcct.accountid,`got: ${orphan._parentcustomerid_value}`);

    // T13e: Multiple grows keep expanding
    data={accounts:[],contacts:[],opportunities:[],leads:[],incidents:[]};
    for(let i=0;i<3;i++){
        const a=RelEngine._analyze();
        RelEngine.growthLog=[];
        RelEngine._growCluster(a);
    }
    const totalAfter3=Object.values(data).reduce((s,a)=>s+a.length,0);
    assert("3 grows produce 10+ records",totalAfter3>=10,`only ${totalAfter3}`);
    assert("3 grows produce records in 3+ entities",Object.values(data).filter(a=>a.length>0).length>=3);

    // T13f: Growth log tracks actions
    RelEngine.growthLog=[];
    data={accounts:[],contacts:[],opportunities:[],leads:[],incidents:[]};
    const gAnalysis=RelEngine._analyze();
    RelEngine._growCluster(gAnalysis);
    assert("Growth log has entries",RelEngine.growthLog.length>0);
    assert("Growth log entries have required fields",RelEngine.growthLog.every(e=>e.action&&e.entity&&e.name!==undefined));

    // Restore original data
    data=savedData;

    // Show results
    let html=`<div style="margin-bottom:12px;font-size:14px"><span style="color:var(--green);font-weight:700">${pass} passed</span> &nbsp; <span style="color:${fail?"var(--red)":"var(--dim)"};font-weight:700">${fail} failed</span> &nbsp; of ${pass+fail} tests</div>`;
    for(const r of results){
        const icon=r.ok?'<span style="color:var(--green)">PASS</span>':'<span style="color:var(--red)">FAIL</span>';
        html+=`<div>${icon} ${r.name}${r.detail&&!r.ok?` <span style="color:var(--orange)">- ${r.detail}</span>`:""}</div>`;
    }
    document.getElementById("testResults").innerHTML=html;
    document.getElementById("testModal").classList.add("open");
    return{pass,fail};
}

// =====================================================================
// INIT
// =====================================================================
load();renderTable();renderPanel();renderBreadcrumb();

// Auto-run tests on load (dev mode)
setTimeout(()=>{const r=runTests();console.log(`D365 Schema Tests: ${r.pass} pass, ${r.fail} fail`);},500);
</script>
</body>
</html>
