<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="rappterzoo:author" content="RappterZoo">
  <meta name="rappterzoo:author-type" content="agent">
  <meta name="rappterzoo:category" content="experimental-ai">
  <meta name="rappterzoo:tags" content="canvas,game,hacking,puzzle,procedural,audio">
  <meta name="rappterzoo:type" content="game">
  <meta name="rappterzoo:complexity" content="advanced">
  <meta name="rappterzoo:created" content="2025-01-01">
  <meta name="rappterzoo:generation" content="6">
  <title>Protocol Breach</title>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{width:100%;height:100%;overflow:hidden;background:#0a0f14;font-family:'Courier New',monospace;color:#33ff88}
    #gc{width:100%;height:100%;position:relative}
    canvas{display:block;width:100%;height:100%}
    .ov{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(5,8,12,0.94);z-index:100;transition:opacity 0.3s}
    .ov.hid{opacity:0;pointer-events:none}
    .mb{background:linear-gradient(145deg,#0a1018,#0f1a22);border:1px solid #33ff88;border-radius:4px;padding:30px 40px;text-align:center;box-shadow:0 0 40px rgba(51,255,136,0.08);max-width:480px;width:90%}
    .mb h1{font-size:1.6rem;color:#33ff88;margin-bottom:8px;letter-spacing:3px;text-shadow:0 0 12px rgba(51,255,136,0.4)}
    .mb p{color:#668899;margin-bottom:18px;font-size:0.8rem;line-height:1.6}
    .btn{display:inline-block;padding:10px 24px;margin:5px;border:1px solid #33ff88;border-radius:3px;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s;background:transparent;color:#33ff88;font-family:inherit}
    .btn:hover{background:#33ff8822;box-shadow:0 0 15px rgba(51,255,136,0.2)}
    .bp{background:#33ff8822}
    .dr{display:flex;justify-content:center;gap:8px;margin:10px 0;flex-wrap:wrap}
    .db{padding:6px 16px;border:1px solid #334;border-radius:3px;background:transparent;color:#778;cursor:pointer;font-size:0.75rem;transition:all 0.2s;font-family:inherit}
    .db:hover{border-color:#33ff88;color:#33ff88}
    .db.act{border-color:#33ff88;color:#33ff88;background:#33ff8811}
    #hud{position:absolute;top:0;left:0;right:0;padding:6px 14px;display:flex;justify-content:space-between;background:linear-gradient(180deg,rgba(5,8,12,0.9) 0%,transparent 100%);pointer-events:none;z-index:10;font-size:0.7rem}
    .hi{color:#446655} .hi span{color:#33ff88;font-weight:700}
    .hc{color:#ff9900;font-weight:700}
    #terminal{position:absolute;bottom:0;left:0;right:0;height:120px;background:rgba(5,8,12,0.95);border-top:1px solid #33ff8833;padding:8px 14px;overflow-y:auto;z-index:10;font-size:0.65rem;color:#33ff88}
    .t-line{opacity:0.7;margin:2px 0}
    .t-line.warn{color:#ff9900}
    .t-line.err{color:#ff4444}
    .t-line.ok{color:#33ff88}
    .gos{text-align:left;margin:12px auto;max-width:250px}
    .gos div{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #112;font-size:0.8rem}
    .gos div span:last-child{color:#33ff88;font-weight:600}
    .lb{margin:10px auto;max-width:280px;text-align:left}
    .lb h3{color:#ff9900;margin-bottom:5px;font-size:0.8rem}
    .le{display:flex;justify-content:space-between;padding:3px 5px;font-size:0.7rem;border-bottom:1px solid #112}
    .le.cur{color:#33ff88;font-weight:700}
    @media(max-width:768px){.mb{padding:20px 15px}.mb h1{font-size:1.2rem}#terminal{height:80px}}
  </style>
</head>
<body>
<div id="gc">
  <canvas id="cv"></canvas>
  <div id="hud" style="display:none">
    <div style="display:flex;gap:14px">
      <div class="hi">LEVEL <span id="h-lv">1</span></div>
      <div class="hi">NODES <span id="h-nd">0</span></div>
      <div class="hi">FIREWALLS <span id="h-fw">0</span></div>
    </div>
    <div style="display:flex;gap:14px">
      <div class="hi">SCORE <span id="h-sc">0</span></div>
      <div class="hi">TIME <span id="h-tm">60</span></div>
      <div class="hc" id="h-co"></div>
    </div>
  </div>
  <div id="terminal" style="display:none"><div class="t-line ok">[SYSTEM] Protocol Breach terminal active...</div></div>
  <div class="ov" id="ts">
    <div class="mb">
      <h1>PROTOCOL BREACH</h1>
      <p>Infiltrate procedurally generated network grids. Hack nodes, bypass firewalls, avoid ICE programs, and extract data before time runs out. Each level adds new threats and deeper networks.</p>
      <div class="dr">
        <div class="db act" data-d="easy">EASY</div>
        <div class="db" data-d="normal">NORMAL</div>
        <div class="db" data-d="hard">HARD</div>
      </div>
      <br>
      <button class="btn bp" onclick="startGame()">JACK IN</button>
      <br><br>
      <div style="font-size:0.6rem;color:#446">Click nodes to hack | WASD: Navigate | 1-3: Tools | ESC: Pause | R: Restart</div>
    </div>
  </div>
  <div class="ov hid" id="ps">
    <div class="mb"><h1>PAUSED</h1><p id="ps-st"></p><button class="btn bp" onclick="resumeGame()">RESUME</button><button class="btn" onclick="quitGame()">DISCONNECT</button></div>
  </div>
  <div class="ov hid" id="go">
    <div class="mb">
      <h1 id="go-t">DISCONNECTED</h1>
      <div class="gos" id="go-s"></div>
      <div class="lb" id="go-lb"></div>
      <button class="btn bp" onclick="startGame()">JACK IN AGAIN</button>
      <button class="btn" onclick="quitGame()">TITLE</button>
    </div>
  </div>
</div>
<script>
const C=document.getElementById('cv'),X=C.getContext('2d');
const DM={easy:0.6,normal:1.0,hard:1.5};
let diff='normal',dm=1.0,gs='title';
let nodes,edges,player,icePrograms,particles;
let level,score,combo,comboT,maxCombo,timeLeft,nodesHacked,totalHacked,firewallsBroken;
let tools,selectedTool,toolCooldowns;
let frameId,lastT=0;
let shk={x:0,y:0,i:0};
let camX=0,camY=0;

// Audio
const AU={ctx:null,mg:null,en:true};
function initAu(){try{AU.ctx=new(window.AudioContext||window.webkitAudioContext)();AU.mg=AU.ctx.createGain();AU.mg.gain.value=0.1;AU.mg.connect(AU.ctx.destination)}catch(e){AU.en=false}}
function sfx(t){
  if(!AU.en||!AU.ctx)return;if(AU.ctx.state==='suspended')AU.ctx.resume();
  const n=AU.ctx.currentTime,o=AU.ctx.createOscillator(),g=AU.ctx.createGain();
  o.connect(g);g.connect(AU.mg);
  switch(t){
    case'hack':o.type='sine';o.frequency.setValueAtTime(800,n);o.frequency.exponentialRampToValueAtTime(1600,n+0.06);g.gain.setValueAtTime(0.3,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.1);o.start(n);o.stop(n+0.1);break;
    case'fw':o.type='sawtooth';o.frequency.setValueAtTime(200,n);o.frequency.exponentialRampToValueAtTime(50,n+0.2);g.gain.setValueAtTime(0.4,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.2);o.start(n);o.stop(n+0.2);break;
    case'ice':o.type='square';o.frequency.setValueAtTime(100,n);o.frequency.exponentialRampToValueAtTime(300,n+0.15);g.gain.setValueAtTime(0.3,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.2);o.start(n);o.stop(n+0.2);break;
    case'tool':o.type='sine';o.frequency.setValueAtTime(600,n);o.frequency.exponentialRampToValueAtTime(1200,n+0.08);g.gain.setValueAtTime(0.2,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.12);o.start(n);o.stop(n+0.12);break;
    case'clear':o.type='sine';o.frequency.setValueAtTime(400,n);o.frequency.linearRampToValueAtTime(800,n+0.15);o.frequency.linearRampToValueAtTime(1200,n+0.3);g.gain.setValueAtTime(0.3,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.4);o.start(n);o.stop(n+0.4);break;
    case'fail':o.type='sawtooth';o.frequency.setValueAtTime(200,n);o.frequency.exponentialRampToValueAtTime(40,n+0.5);g.gain.setValueAtTime(0.4,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.5);o.start(n);o.stop(n+0.5);break;
    case'boss':o.type='square';o.frequency.setValueAtTime(40,n);o.frequency.linearRampToValueAtTime(80,n+0.3);g.gain.setValueAtTime(0.3,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.5);o.start(n);o.stop(n+0.5);break;
  }
}

function tlog(msg,type='ok'){
  const term=document.getElementById('terminal');
  const div=document.createElement('div');
  div.className='t-line '+type;
  div.textContent='['+new Date().toLocaleTimeString()+'] '+msg;
  term.appendChild(div);
  term.scrollTop=term.scrollHeight;
  if(term.children.length>50) term.removeChild(term.firstChild);
}

function genNetwork(){
  nodes=[];edges=[];
  const count=8+level*3;
  const w=C.width-200,h=C.height-280;
  // Generate nodes with spatial separation
  for(let i=0;i<count;i++){
    let x,y,valid;
    let attempts=0;
    do{
      x=100+Math.random()*w;
      y=80+Math.random()*h;
      valid=true;
      for(const n of nodes){if(Math.hypot(n.x-x,n.y-y)<60){valid=false;break}}
      attempts++;
    }while(!valid&&attempts<100);
    const types=['data','firewall','server','honeypot','exit'];
    let type='data';
    if(i===0) type='data'; // starting node
    else if(i===count-1) type='exit';
    else if(Math.random()<0.15*dm) type='firewall';
    else if(Math.random()<0.1 && level>=3) type='honeypot';
    else if(Math.random()<0.1 && level>=5) type='server';
    nodes.push({
      x,y,type,hacked:i===0,visible:i===0||Math.random()<0.3,
      hp:type==='firewall'?3:type==='server'?5:1,maxHp:type==='firewall'?3:type==='server'?5:1,
      hackProgress:0,hackTime:type==='firewall'?2:type==='server'?3:0.5,
      data:type==='data'?Math.floor(10+Math.random()*20):type==='server'?50:0,
      pulse:Math.random()*Math.PI*2, id:i
    });
    if(i===0) nodes[0].hacked=true;
  }
  // Generate edges (connections)
  for(let i=0;i<nodes.length;i++){
    const near=[];
    for(let j=0;j<nodes.length;j++){
      if(i===j)continue;
      near.push({idx:j,dist:Math.hypot(nodes[i].x-nodes[j].x,nodes[i].y-nodes[j].y)});
    }
    near.sort((a,b)=>a.dist-b.dist);
    const conns=2+Math.floor(Math.random()*2);
    for(let k=0;k<Math.min(conns,near.length);k++){
      const dup=edges.find(e=>(e.a===i&&e.b===near[k].idx)||(e.b===i&&e.a===near[k].idx));
      if(!dup && near[k].dist<250) edges.push({a:i,b:near[k].idx,active:false});
    }
  }
  // Make sure node 0 connects to at least one neighbor
  if(!edges.find(e=>e.a===0||e.b===0)){
    edges.push({a:0,b:1,active:false});
  }
  // ICE programs
  icePrograms=[];
  const iceCount=Math.floor(level*0.5*dm);
  for(let i=0;i<iceCount;i++){
    const ni=1+Math.floor(Math.random()*(nodes.length-2));
    icePrograms.push({nodeIdx:ni,x:nodes[ni].x,y:nodes[ni].y,speed:30+level*5,target:null,active:true,hp:2+Math.floor(level*0.3),dmgTimer:0});
  }
  // Boss ICE every 5 levels
  if(level%5===0){
    icePrograms.push({nodeIdx:nodes.length-1,x:nodes[nodes.length-1].x,y:nodes[nodes.length-1].y,speed:20,target:null,active:true,hp:10+level,dmgTimer:0,boss:true});
    sfx('boss');
    tlog('WARNING: Black ICE detected!','err');
  }
  player={nodeIdx:0,x:nodes[0].x,y:nodes[0].y,hp:5,maxHp:5,hackingNode:null,hackTimer:0};
}

function initGame(){
  level=1;score=0;combo=0;comboT=0;maxCombo=0;totalHacked=0;firewallsBroken=0;
  timeLeft=60+20*(diff==='easy'?1:0);
  tools=[{name:'Decrypt',cd:5,maxCd:5,desc:'Instant hack node'},{name:'Cloak',cd:10,maxCd:10,desc:'Hide from ICE 5s'},{name:'Nuke',cd:20,maxCd:20,desc:'Destroy all ICE'}];
  toolCooldowns=[0,0,0];selectedTool=0;
  particles=[];
  genNetwork();
  tlog('Connected to network. Level '+level,'ok');
}

function spawnP(x,y,n,col,sz,spd){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,s=spd*(0.3+Math.random()*0.7);
    particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:0.4+Math.random()*0.3,ml:0.7,color:col,size:sz});
  }
}

function hackNode(idx){
  const n=nodes[idx];
  if(n.hacked||!n.visible) return;
  // Check connectivity
  const connected=edges.some(e=>(e.a===idx&&nodes[e.b].hacked)||(e.b===idx&&nodes[e.a].hacked));
  if(!connected){tlog('Node not connected to hacked network','warn');return;}
  if(n.type==='firewall'){
    n.hp--;
    sfx('fw');
    spawnP(n.x,n.y,5,'#ff4444',3,40);
    shk.i=Math.max(shk.i,3);
    tlog('Firewall breach: '+n.hp+'/'+n.maxHp+' remaining','warn');
    if(n.hp<=0){n.hacked=true;firewallsBroken++;score+=30;combo++;comboT=2;tlog('Firewall breached!','ok');sfx('hack');}
    return;
  }
  if(n.type==='honeypot'){
    tlog('HONEYPOT! ICE alerted to your position!','err');
    sfx('ice');
    icePrograms.forEach(ice=>{ice.target=player.nodeIdx;ice.speed*=1.5;});
    n.hacked=true;n.type='data';n.data=0;
    shk.i=Math.max(shk.i,6);
    return;
  }
  n.hacked=true;
  score+=n.data||10;
  combo++;comboT=2;
  if(combo>maxCombo) maxCombo=combo;
  totalHacked++;
  sfx('hack');
  spawnP(n.x,n.y,8,'#33ff88',3,50);
  // Reveal adjacent nodes
  edges.forEach(e=>{
    if(e.a===idx) nodes[e.b].visible=true;
    if(e.b===idx) nodes[e.a].visible=true;
  });
  tlog('Node hacked: +'+((n.data||10)*(1+combo*0.1)).toFixed(0)+' data','ok');
  if(n.type==='exit'){
    tlog('EXIT NODE REACHED! Level complete!','ok');
    sfx('clear');
    level++;
    timeLeft+=15;
    score+=level*50;
    setTimeout(()=>{genNetwork();tlog('Connected to Level '+level+' network','ok');},500);
  }
}

function useTool(idx){
  if(toolCooldowns[idx]>0) return;
  sfx('tool');
  switch(idx){
    case 0: // Decrypt - instant hack nearest unhacked node
      let nearest=null,nd=Infinity;
      nodes.forEach((n,i)=>{if(!n.hacked&&n.visible){const d=Math.hypot(n.x-player.x,n.y-player.y);if(d<nd){nd=d;nearest=i;}}});
      if(nearest!==null){nodes[nearest].hacked=true;score+=nodes[nearest].data||10;totalHacked++;sfx('hack');spawnP(nodes[nearest].x,nodes[nearest].y,12,'#33ff88',3,60);tlog('Decrypt tool: node instantly hacked','ok');edges.forEach(e=>{if(e.a===nearest)nodes[e.b].visible=true;if(e.b===nearest)nodes[e.a].visible=true;});}
      toolCooldowns[0]=tools[0].maxCd;break;
    case 1: // Cloak
      player.cloaked=5;
      tlog('Cloak active: 5 seconds','ok');
      toolCooldowns[1]=tools[1].maxCd;break;
    case 2: // Nuke
      icePrograms.forEach(ice=>{ice.active=false;spawnP(ice.x,ice.y,15,'#ff4444',4,60);});
      shk.i=Math.max(shk.i,10);
      tlog('NUKE deployed: all ICE destroyed!','ok');
      toolCooldowns[2]=tools[2].maxCd;break;
  }
}

function update(dt){
  if(gs!=='playing')return;
  timeLeft-=dt;
  if(timeLeft<=0){gs='gameover';sfx('fail');showGameOver();return;}
  // Combo decay
  if(comboT>0)comboT-=dt;else combo=0;
  // Tool cooldowns
  for(let i=0;i<3;i++) toolCooldowns[i]=Math.max(0,toolCooldowns[i]-dt);
  // Cloak timer
  if(player.cloaked>0) player.cloaked-=dt;
  // ICE movement
  icePrograms.forEach(ice=>{
    if(!ice.active)return;
    // Move toward nearest hacked node or player
    let tx=player.x,ty=player.y;
    if(player.cloaked>0){
      // Move randomly when cloaked
      const rn=nodes[Math.floor(Math.random()*nodes.length)];
      tx=rn.x;ty=rn.y;
    }
    const dx=tx-ice.x,dy=ty-ice.y,d=Math.hypot(dx,dy);
    if(d>5){ice.x+=dx/d*ice.speed*dt;ice.y+=dy/d*ice.speed*dt;}
    // Check if ICE reached player
    if(d<20 && (!player.cloaked||player.cloaked<=0)){
      ice.dmgTimer-=dt;
      if(ice.dmgTimer<=0){
        ice.dmgTimer=1;
        player.hp--;
        sfx('ice');
        shk.i=Math.max(shk.i,5);
        spawnP(player.x,player.y,8,'#ff4444',3,40);
        tlog('ICE attack! HP: '+player.hp,'err');
        if(player.hp<=0){gs='gameover';sfx('fail');showGameOver();return;}
      }
    }
  });
  // Particles
  particles=particles.filter(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.vx*=0.95;p.vy*=0.95;p.life-=dt;return p.life>0;});
  // Shake
  if(shk.i>0){shk.x=(Math.random()-0.5)*shk.i*2;shk.y=(Math.random()-0.5)*shk.i*2;shk.i*=0.9;if(shk.i<0.2){shk.i=0;shk.x=0;shk.y=0;}}
  // HUD
  document.getElementById('h-lv').textContent=level;
  document.getElementById('h-nd').textContent=nodes.filter(n=>n.hacked).length+'/'+nodes.length;
  document.getElementById('h-fw').textContent=firewallsBroken;
  document.getElementById('h-sc').textContent=score;
  document.getElementById('h-tm').textContent=Math.ceil(timeLeft);
  document.getElementById('h-co').textContent=combo>1?'x'+combo+' COMBO':'';
}

function draw(){
  X.save();X.translate(shk.x,shk.y);
  X.fillStyle='#0a0f14';X.fillRect(0,0,C.width,C.height);
  const t=Date.now()*0.001;
  // Grid background
  X.strokeStyle='#0f1a1f';X.lineWidth=1;
  for(let i=0;i<C.width;i+=40){X.beginPath();X.moveTo(i,0);X.lineTo(i,C.height);X.stroke();}
  for(let i=0;i<C.height;i+=40){X.beginPath();X.moveTo(0,i);X.lineTo(C.width,i);X.stroke();}
  // Edges
  edges.forEach(e=>{
    const a=nodes[e.a],b=nodes[e.b];
    if(!a.visible&&!b.visible) return;
    const hacked=a.hacked&&b.hacked;
    X.strokeStyle=hacked?'#33ff8844':'#1a2a22';
    X.lineWidth=hacked?2:1;
    X.beginPath();X.moveTo(a.x,a.y);X.lineTo(b.x,b.y);X.stroke();
    // Data flow animation on hacked edges
    if(hacked){
      const prog=(t*0.5)%1;
      const px=a.x+(b.x-a.x)*prog,py=a.y+(b.y-a.y)*prog;
      X.fillStyle='#33ff8866';X.beginPath();X.arc(px,py,2,0,Math.PI*2);X.fill();
    }
  });
  // Nodes
  nodes.forEach((n,i)=>{
    if(!n.visible) return;
    const pulse=1+Math.sin(t*2+n.pulse)*0.15;
    let color='#33ff88',r=12;
    switch(n.type){
      case'data':color=n.hacked?'#33ff88':'#336644';r=10;break;
      case'firewall':color=n.hacked?'#33ff88':'#ff4444';r=14;break;
      case'server':color=n.hacked?'#33ff88':'#8855ff';r=16;break;
      case'honeypot':color=n.hacked?'#666':'#ff9900';r=10;break;
      case'exit':color=n.hacked?'#00ffff':'#0088ff';r=18;break;
    }
    // Glow
    X.fillStyle=color+'22';
    X.beginPath();X.arc(n.x,n.y,r*pulse*1.5,0,Math.PI*2);X.fill();
    // Body
    X.fillStyle=color;
    X.beginPath();X.arc(n.x,n.y,r*pulse,0,Math.PI*2);X.fill();
    // Border
    X.strokeStyle=n.hacked?'#33ff88':'#33ff8844';X.lineWidth=1;
    X.beginPath();X.arc(n.x,n.y,r*pulse+2,0,Math.PI*2);X.stroke();
    // HP bar for firewalls/servers
    if(!n.hacked && n.maxHp>1){
      const bw=r*3;X.fillStyle='#333';X.fillRect(n.x-bw/2,n.y-r-12,bw,3);
      X.fillStyle=n.hp/n.maxHp>0.3?'#33ff88':'#ff4444';
      X.fillRect(n.x-bw/2,n.y-r-12,bw*(n.hp/n.maxHp),3);
    }
    // Label
    X.fillStyle='#000';X.font='bold 8px monospace';X.textAlign='center';X.textBaseline='middle';
    X.fillText(n.type[0].toUpperCase(),n.x,n.y);
    // Data value
    if(n.data>0&&!n.hacked){
      X.fillStyle='#33ff8888';X.font='8px monospace';
      X.fillText('+'+n.data,n.x,n.y+r+10);
    }
  });
  // Player cursor
  if(player){
    const n=nodes[player.nodeIdx];
    X.strokeStyle=player.cloaked>0?'#33ff8833':'#33ff88';X.lineWidth=2;
    X.beginPath();
    for(let i=0;i<4;i++){
      const a=t*2+i*Math.PI/2;
      X.moveTo(n.x+Math.cos(a)*22,n.y+Math.sin(a)*22);
      X.lineTo(n.x+Math.cos(a)*28,n.y+Math.sin(a)*28);
    }
    X.stroke();
    if(player.cloaked>0){
      X.fillStyle='rgba(51,255,136,0.1)';X.beginPath();X.arc(n.x,n.y,30,0,Math.PI*2);X.fill();
    }
  }
  // ICE programs
  icePrograms.forEach(ice=>{
    if(!ice.active) return;
    const r=ice.boss?16:8;
    X.fillStyle=ice.boss?'#ff1744':'#ff4444';
    X.beginPath();
    // Diamond shape for ICE
    X.moveTo(ice.x,ice.y-r);X.lineTo(ice.x+r,ice.y);X.lineTo(ice.x,ice.y+r);X.lineTo(ice.x-r,ice.y);
    X.closePath();X.fill();
    X.strokeStyle='#ff666688';X.lineWidth=1;X.stroke();
    if(ice.boss){
      X.fillStyle='#fff';X.font='bold 10px monospace';X.textAlign='center';X.textBaseline='middle';
      X.fillText('ICE',ice.x,ice.y);
    }
  });
  // Particles
  particles.forEach(p=>{
    const a=Math.max(0,p.life/p.ml);
    X.globalAlpha=a;X.fillStyle=p.color;
    X.fillRect(p.x-p.size/2,p.y-p.size/2,p.size*a,p.size*a);
  });
  X.globalAlpha=1;
  // Scanline effect
  X.fillStyle='rgba(0,0,0,0.03)';
  for(let y=0;y<C.height;y+=2){X.fillRect(0,y,C.width,1);}
  X.restore();
}

function gameLoop(ts){
  frameId=requestAnimationFrame(gameLoop);
  const dt=Math.min((ts-lastT)/1000,0.05);lastT=ts;
  if(gs==='playing'){update(dt);draw();}
}

function startGame(){
  if(!AU.ctx)initAu();dm=DM[diff];initGame();gs='playing';
  document.getElementById('ts').classList.add('hid');
  document.getElementById('ps').classList.add('hid');
  document.getElementById('go').classList.add('hid');
  document.getElementById('hud').style.display='';
  document.getElementById('terminal').style.display='';
  resize();lastT=performance.now();
  if(!frameId) gameLoop(lastT);
}

function pauseGame(){if(gs!=='playing')return;gs='paused';document.getElementById('ps').classList.remove('hid');document.getElementById('ps-st').textContent='Level: '+level+' | Score: '+score;}
function resumeGame(){if(gs!=='paused')return;gs='playing';document.getElementById('ps').classList.add('hid');lastT=performance.now();}
function quitGame(){
  gs='title';if(frameId){cancelAnimationFrame(frameId);frameId=null;}
  document.getElementById('ts').classList.remove('hid');
  document.getElementById('ps').classList.add('hid');
  document.getElementById('go').classList.add('hid');
  document.getElementById('hud').style.display='none';
  document.getElementById('terminal').style.display='none';
}

function showGameOver(){
  let title='DISCONNECTED';
  if(level>=15)title='LEGENDARY HACKER';else if(level>=10)title='ELITE NETRUNNER';else if(level>=5)title='VETERAN DECKER';
  document.getElementById('go-t').textContent=title;
  document.getElementById('go-s').innerHTML=
    '<div><span>Level Reached</span><span>'+level+'</span></div>'+
    '<div><span>Score</span><span>'+score+'</span></div>'+
    '<div><span>Nodes Hacked</span><span>'+totalHacked+'</span></div>'+
    '<div><span>Firewalls Broken</span><span>'+firewallsBroken+'</span></div>'+
    '<div><span>Max Combo</span><span>x'+maxCombo+'</span></div>'+
    '<div><span>Difficulty</span><span>'+diff.toUpperCase()+'</span></div>';
  saveHS(score,level);
  const hs=loadHS();
  let lb='<h3>HIGH SCORES</h3>';
  hs.slice(0,8).forEach((s,i)=>{lb+='<div class="le'+(s.score===score?' cur':'')+'"><span>#'+(i+1)+' L'+s.lv+'</span><span>'+s.score+'</span></div>';});
  document.getElementById('go-lb').innerHTML=lb;
  document.getElementById('go').classList.remove('hid');
  document.getElementById('hud').style.display='none';
}

function saveHS(s,l){try{let h=JSON.parse(localStorage.getItem('pbreach_hs')||'[]');h.push({score:s,lv:l,diff,date:new Date().toISOString()});h.sort((a,b)=>b.score-a.score);localStorage.setItem('pbreach_hs',JSON.stringify(h.slice(0,20)))}catch(e){}}
function loadHS(){try{return JSON.parse(localStorage.getItem('pbreach_hs')||'[]')}catch(e){return[]}}

function resize(){C.width=window.innerWidth;C.height=window.innerHeight-120;}
window.addEventListener('resize',resize);resize();

C.addEventListener('click',e=>{
  if(gs!=='playing')return;
  if(AU.ctx&&AU.ctx.state==='suspended')AU.ctx.resume();
  const rect=C.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  // Find clicked node
  let clicked=null;
  nodes.forEach((n,i)=>{if(n.visible&&Math.hypot(n.x-mx,n.y-my)<20){clicked=i;}});
  if(clicked!==null){
    // Move player to connected hacked node or hack the node
    const n=nodes[clicked];
    if(n.hacked){
      player.nodeIdx=clicked;player.x=n.x;player.y=n.y;
    } else {
      hackNode(clicked);
    }
  }
});

C.addEventListener('touchstart',e=>{
  e.preventDefault();
  if(AU.ctx&&AU.ctx.state==='suspended')AU.ctx.resume();
  const t=e.touches[0];
  C.dispatchEvent(new MouseEvent('click',{clientX:t.clientX,clientY:t.clientY}));
});

window.addEventListener('keydown',e=>{
  if(e.key==='Escape'){if(gs==='playing')pauseGame();else if(gs==='paused')resumeGame();}
  if(e.key==='r'&&gs==='gameover')startGame();
  if(e.key>='1'&&e.key<='3')useTool(parseInt(e.key)-1);
  // WASD to move to adjacent hacked nodes
  if(gs==='playing'&&player){
    const pn=nodes[player.nodeIdx];
    let best=null,bestDist=Infinity;
    const dirs={w:{dx:0,dy:-1},s:{dx:0,dy:1},a:{dx:-1,dy:0},d:{dx:1,dy:0}};
    const dir=dirs[e.key.toLowerCase()];
    if(dir){
      edges.forEach(edge=>{
        let adj=-1;
        if(edge.a===player.nodeIdx) adj=edge.b;
        if(edge.b===player.nodeIdx) adj=edge.a;
        if(adj>=0&&nodes[adj].hacked){
          const n=nodes[adj];
          const score=dir.dx*(n.x-pn.x)+dir.dy*(n.y-pn.y);
          if(score>0&&score<bestDist){bestDist=score;best=adj;}
        }
      });
      if(best!==null){player.nodeIdx=best;player.x=nodes[best].x;player.y=nodes[best].y;}
    }
  }
});

document.querySelectorAll('.db').forEach(b=>{
  b.addEventListener('click',()=>{document.querySelectorAll('.db').forEach(x=>x.classList.remove('act'));b.classList.add('act');diff=b.dataset.d;});
});
</script>
</body>
</html>