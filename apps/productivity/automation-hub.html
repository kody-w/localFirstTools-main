<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Automation Hub</title>
<meta name="rappterzoo:category" content="productivity">
<meta name="rappterzoo:type" content="interface">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:author" content="RappterZoo">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:tags" content="automation,rules,workflow,triggers">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:#0a0a0f;color:#e0e0e0;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:#111118}
::-webkit-scrollbar-thumb{background:#10b981;border-radius:3px}
header{background:linear-gradient(135deg,#0f1a15 0%,#0a0a0f 50%,#0a1020 100%);border-bottom:1px solid #1a2a1f;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
header h1{font-size:1.5rem;font-weight:700;color:#10b981;display:flex;align-items:center;gap:10px}
header h1 span{font-size:1.8rem}
.header-actions{display:flex;gap:8px;flex-wrap:wrap}
button{cursor:pointer;border:none;border-radius:6px;padding:8px 16px;font-size:.85rem;font-weight:600;transition:all .2s}
.btn-primary{background:#10b981;color:#0a0a0f}
.btn-primary:hover{background:#34d399;transform:translateY(-1px)}
.btn-secondary{background:#1a1a2e;color:#a0a0b0;border:1px solid #2a2a3e}
.btn-secondary:hover{background:#252540;color:#e0e0e0}
.btn-danger{background:#4a1525;color:#f87171;border:1px solid #7f1d1d}
.btn-danger:hover{background:#6b1e2e}
.btn-sm{padding:5px 10px;font-size:.75rem}
main{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;max-width:1400px;margin:0 auto}
@media(max-width:900px){main{grid-template-columns:1fr}}
.panel{background:#111118;border:1px solid #1e1e2e;border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
.panel-header{padding:14px 18px;border-bottom:1px solid #1e1e2e;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,#161622 0%,#111118 100%)}
.panel-header h2{font-size:1rem;font-weight:600;color:#c0c0d0;display:flex;align-items:center;gap:8px}
.panel-body{padding:16px;overflow-y:auto;max-height:calc(100vh - 180px);flex:1}
.rule-card{background:#0e0e1a;border:1px solid #1e1e2e;border-radius:8px;padding:14px;margin-bottom:12px;transition:all .25s;position:relative}
.rule-card:hover{border-color:#10b98140;box-shadow:0 0 20px #10b98110}
.rule-card.disabled{opacity:.5}
.rule-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.rule-name{font-weight:600;font-size:.95rem;color:#e8e8f0}
.rule-actions{display:flex;gap:6px;align-items:center}
.status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;flex-shrink:0}
.status-dot.active{background:#10b981;box-shadow:0 0 8px #10b98180}
.status-dot.disabled{background:#555}
.status-dot.error{background:#f87171;box-shadow:0 0 8px #f8717180}
.flow-visual{display:flex;align-items:center;gap:0;margin-top:8px;flex-wrap:wrap}
.flow-node{padding:6px 12px;border-radius:6px;font-size:.75rem;font-weight:600;white-space:nowrap}
.flow-trigger{background:#10b98120;color:#10b981;border:1px solid #10b98140}
.flow-condition{background:#3b82f620;color:#60a5fa;border:1px solid #3b82f640}
.flow-action{background:#f59e0b20;color:#fbbf24;border:1px solid #f59e0b40}
.flow-arrow{color:#444;font-size:.85rem;padding:0 4px}
.toggle{position:relative;width:36px;height:20px;cursor:pointer}
.toggle input{display:none}
.toggle-slider{position:absolute;inset:0;background:#333;border-radius:10px;transition:.3s}
.toggle-slider::before{content:'';position:absolute;width:16px;height:16px;left:2px;top:2px;background:#888;border-radius:50%;transition:.3s}
.toggle input:checked+.toggle-slider{background:#10b981}
.toggle input:checked+.toggle-slider::before{transform:translateX(16px);background:#fff}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:.8rem;color:#8888a0;margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:9px 12px;background:#0a0a14;border:1px solid #2a2a3e;border-radius:6px;color:#e0e0e0;font-size:.85rem;transition:border-color .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#10b981}
.form-group select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:600px){.form-row{grid-template-columns:1fr}}
.log-entry{padding:8px 12px;border-left:3px solid #10b981;background:#0a0a14;margin-bottom:6px;border-radius:0 6px 6px 0;font-size:.8rem;line-height:1.5}
.log-entry.error{border-left-color:#f87171}
.log-time{color:#666;font-size:.7rem;margin-right:8px}
.log-rule{color:#10b981;font-weight:600}
.log-msg{color:#b0b0c0}
.empty-state{text-align:center;padding:40px 20px;color:#555}
.empty-state span{font-size:2.5rem;display:block;margin-bottom:12px}
.section-divider{display:flex;align-items:center;gap:8px;margin:16px 0 12px;font-size:.75rem;color:#555;text-transform:uppercase;letter-spacing:1px;font-weight:700}
.section-divider::after{content:'';flex:1;height:1px;background:#1e1e2e}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.65rem;font-weight:700;text-transform:uppercase}
.badge-count{background:#10b98120;color:#10b981}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal{background:#151520;border:1px solid #2a2a3e;border-radius:12px;width:90%;max-width:520px;max-height:90vh;overflow-y:auto;padding:24px}
.modal h3{margin-bottom:18px;color:#10b981;font-size:1.1rem}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:18px}
.timer-badge{font-size:.65rem;color:#666;margin-left:6px}
</style>
</head>
<body>
<header>
  <h1><span>‚ö°</span> Automation Hub</h1>
  <div class="header-actions">
    <button class="btn-primary" onclick="openCreateForm()">+ New Rule</button>
    <button class="btn-secondary" onclick="runAllRules()">‚ñ∂ Run All</button>
    <button class="btn-secondary" onclick="exportRules()">‚Üì Export</button>
    <button class="btn-secondary" onclick="document.getElementById('importInput').click()">‚Üë Import</button>
    <input type="file" id="importInput" accept=".json" style="display:none" onchange="importRules(event)">
  </div>
</header>

<main>
  <div class="panel">
    <div class="panel-header">
      <h2>üìã Rules <span class="badge badge-count" id="ruleCount">0</span></h2>
      <button class="btn-sm btn-secondary" onclick="toggleAllTimers()" id="timerToggleBtn">‚è∏ Pause Timers</button>
    </div>
    <div class="panel-body" id="ruleList">
      <div class="empty-state"><span>‚öôÔ∏è</span>No rules yet. Create your first automation rule!</div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">
      <h2>üìú Execution Log <span class="badge badge-count" id="logCount">0</span></h2>
      <button class="btn-sm btn-danger" onclick="clearLog()">Clear</button>
    </div>
    <div class="panel-body" id="logPanel">
      <div class="empty-state"><span>üìù</span>No log entries yet. Run some rules to see history.</div>
    </div>
  </div>
</main>

<!-- Create/Edit Rule Modal -->
<div class="modal-overlay" id="ruleModal">
  <div class="modal">
    <h3 id="modalTitle">Create New Rule</h3>
    <input type="hidden" id="editingRuleId">

    <div class="form-group">
      <label>Rule Name</label>
      <input type="text" id="ruleName" placeholder="e.g. Auto-backup every 5 min">
    </div>

    <div class="section-divider">Trigger</div>
    <div class="form-row">
      <div class="form-group">
        <label>Trigger Type</label>
        <select id="triggerType" onchange="updateTriggerFields()">
          <option value="manual">Manual (Button Click)</option>
          <option value="timer">Timer (Interval)</option>
          <option value="datachange">Data Change (localStorage)</option>
        </select>
      </div>
      <div class="form-group" id="triggerValueGroup" style="display:none">
        <label id="triggerValueLabel">Value</label>
        <input type="text" id="triggerValue" placeholder="">
      </div>
    </div>
    <div class="form-group" id="triggerUnitGroup" style="display:none">
      <label>Interval Unit</label>
      <select id="triggerUnit">
        <option value="seconds">Seconds</option>
        <option value="minutes">Minutes</option>
      </select>
    </div>

    <div class="section-divider">Condition</div>
    <div class="form-row">
      <div class="form-group">
        <label>Condition Type</label>
        <select id="conditionType" onchange="updateConditionFields()">
          <option value="always">Always</option>
          <option value="equals">Value Equals</option>
          <option value="greater">Value Greater Than</option>
          <option value="less">Value Less Than</option>
          <option value="contains">Value Contains</option>
        </select>
      </div>
      <div class="form-group" id="condKeyGroup" style="display:none">
        <label>localStorage Key</label>
        <input type="text" id="conditionKey" placeholder="key name">
      </div>
    </div>
    <div class="form-group" id="condValGroup" style="display:none">
      <label>Compare Value</label>
      <input type="text" id="conditionValue" placeholder="value to compare">
    </div>

    <div class="section-divider">Action</div>
    <div class="form-group">
      <label>Action Type</label>
      <select id="actionType" onchange="updateActionFields()">
        <option value="notify">Show Notification</option>
        <option value="log">Log to History</option>
        <option value="transform">Transform Data</option>
        <option value="setkey">Set localStorage Key</option>
        <option value="sound">Play Sound (Beep)</option>
      </select>
    </div>
    <div class="form-group" id="actionMsgGroup">
      <label id="actionMsgLabel">Notification Message</label>
      <input type="text" id="actionMessage" placeholder="Hello from Automation Hub!">
    </div>
    <div class="form-group" id="actionKeyGroup" style="display:none">
      <label>Target localStorage Key</label>
      <input type="text" id="actionKey" placeholder="key name">
    </div>
    <div class="form-group" id="actionTransformGroup" style="display:none">
      <label>Transform Operation</label>
      <select id="actionTransform">
        <option value="uppercase">Uppercase</option>
        <option value="lowercase">Lowercase</option>
        <option value="reverse">Reverse</option>
      </select>
    </div>
    <div class="form-group" id="actionValGroup" style="display:none">
      <label>Value to Set</label>
      <input type="text" id="actionValue" placeholder="new value">
    </div>

    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" onclick="saveRule()">Save Rule</button>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY = 'automationhub_rules';
const LOG_KEY = 'automationhub_log';
let rules = [];
let logEntries = [];
let timerIntervals = {};
let timersPaused = false;
let audioCtx = null;

function uid() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
}

function loadData() {
  try {
    const r = localStorage.getItem(STORAGE_KEY);
    if (r) rules = JSON.parse(r);
  } catch (e) { rules = []; }
  try {
    const l = localStorage.getItem(LOG_KEY);
    if (l) logEntries = JSON.parse(l);
  } catch (e) { logEntries = []; }
}

function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rules));
  localStorage.setItem(LOG_KEY, JSON.stringify(logEntries));
}

function addLog(ruleName, message, isError) {
  const entry = {
    time: new Date().toISOString(),
    rule: ruleName,
    message: message,
    error: !!isError
  };
  logEntries.unshift(entry);
  if (logEntries.length > 200) logEntries.length = 200;
  saveData();
  renderLog();
}

function renderRules() {
  const container = document.getElementById('ruleList');
  document.getElementById('ruleCount').textContent = rules.length;
  if (rules.length === 0) {
    container.innerHTML = '<div class="empty-state"><span>‚öôÔ∏è</span>No rules yet. Create your first automation rule!</div>';
    return;
  }
  let html = '';
  rules.forEach(rule => {
    const statusClass = rule.error ? 'error' : (rule.enabled ? 'active' : 'disabled');
    const triggerLabel = getTriggerLabel(rule.trigger);
    const condLabel = getConditionLabel(rule.condition);
    const actionLabel = getActionLabel(rule.action);
    const timerInfo = rule.trigger.type === 'timer' && rule.enabled
      ? '<span class="timer-badge">‚è± running</span>' : '';
    html += `
      <div class="rule-card ${rule.enabled ? '' : 'disabled'}">
        <div class="rule-card-top">
          <div style="display:flex;align-items:center">
            <span class="status-dot ${statusClass}"></span>
            <span class="rule-name">${esc(rule.name)}</span>${timerInfo}
          </div>
          <div class="rule-actions">
            <label class="toggle" title="Enable / Disable">
              <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleRule('${rule.id}')">
              <span class="toggle-slider"></span>
            </label>
            <button class="btn-sm btn-secondary" onclick="editRule('${rule.id}')" title="Edit">‚úèÔ∏è</button>
            <button class="btn-sm btn-secondary" onclick="runSingleRule('${rule.id}')" title="Run now">‚ñ∂</button>
            <button class="btn-sm btn-danger" onclick="deleteRule('${rule.id}')" title="Delete">üóë</button>
          </div>
        </div>
        <div class="flow-visual">
          <span class="flow-node flow-trigger">‚ö° ${esc(triggerLabel)}</span>
          <span class="flow-arrow">‚Üí</span>
          <span class="flow-node flow-condition">üîç ${esc(condLabel)}</span>
          <span class="flow-arrow">‚Üí</span>
          <span class="flow-node flow-action">üéØ ${esc(actionLabel)}</span>
        </div>
      </div>`;
  });
  container.innerHTML = html;
}

function renderLog() {
  const container = document.getElementById('logPanel');
  document.getElementById('logCount').textContent = logEntries.length;
  if (logEntries.length === 0) {
    container.innerHTML = '<div class="empty-state"><span>üìù</span>No log entries yet. Run some rules to see history.</div>';
    return;
  }
  let html = '';
  logEntries.forEach(entry => {
    const t = new Date(entry.time);
    const ts = t.toLocaleTimeString();
    html += `<div class="log-entry ${entry.error ? 'error' : ''}">
      <span class="log-time">${ts}</span>
      <span class="log-rule">[${esc(entry.rule)}]</span>
      <span class="log-msg"> ${esc(entry.message)}</span>
    </div>`;
  });
  container.innerHTML = html;
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str || '';
  return d.innerHTML;
}

function getTriggerLabel(trigger) {
  if (trigger.type === 'manual') return 'Manual';
  if (trigger.type === 'timer') return `Timer: ${trigger.value}${trigger.unit === 'minutes' ? 'm' : 's'}`;
  if (trigger.type === 'datachange') return `Data Change: ${trigger.value}`;
  return trigger.type;
}

function getConditionLabel(cond) {
  if (cond.type === 'always') return 'Always';
  if (cond.type === 'equals') return `${cond.key} = ${cond.value}`;
  if (cond.type === 'greater') return `${cond.key} > ${cond.value}`;
  if (cond.type === 'less') return `${cond.key} < ${cond.value}`;
  if (cond.type === 'contains') return `${cond.key} ‚äÉ ${cond.value}`;
  return cond.type;
}

function getActionLabel(action) {
  if (action.type === 'notify') return `Notify: ${(action.message || '').slice(0, 25)}`;
  if (action.type === 'log') return `Log: ${(action.message || '').slice(0, 25)}`;
  if (action.type === 'transform') return `Transform ${action.key} (${action.transform})`;
  if (action.type === 'setkey') return `Set ${action.key}`;
  if (action.type === 'sound') return 'Play Sound';
  return action.type;
}

// --- Trigger / Condition / Action field visibility ---
function updateTriggerFields() {
  const type = document.getElementById('triggerType').value;
  const vg = document.getElementById('triggerValueGroup');
  const ug = document.getElementById('triggerUnitGroup');
  const vl = document.getElementById('triggerValueLabel');
  const vi = document.getElementById('triggerValue');
  if (type === 'timer') {
    vg.style.display = ''; vl.textContent = 'Interval'; vi.placeholder = 'e.g. 10';
    ug.style.display = '';
  } else if (type === 'datachange') {
    vg.style.display = ''; vl.textContent = 'localStorage Key'; vi.placeholder = 'key to watch';
    ug.style.display = 'none';
  } else {
    vg.style.display = 'none'; ug.style.display = 'none';
  }
}

function updateConditionFields() {
  const type = document.getElementById('conditionType').value;
  const kg = document.getElementById('condKeyGroup');
  const vg = document.getElementById('condValGroup');
  if (type === 'always') { kg.style.display = 'none'; vg.style.display = 'none'; }
  else { kg.style.display = ''; vg.style.display = ''; }
}

function updateActionFields() {
  const type = document.getElementById('actionType').value;
  const mg = document.getElementById('actionMsgGroup');
  const ml = document.getElementById('actionMsgLabel');
  const kg = document.getElementById('actionKeyGroup');
  const tg = document.getElementById('actionTransformGroup');
  const vg = document.getElementById('actionValGroup');
  mg.style.display = 'none'; kg.style.display = 'none';
  tg.style.display = 'none'; vg.style.display = 'none';
  if (type === 'notify') { mg.style.display = ''; ml.textContent = 'Notification Message'; }
  else if (type === 'log') { mg.style.display = ''; ml.textContent = 'Log Message'; }
  else if (type === 'transform') { kg.style.display = ''; tg.style.display = ''; }
  else if (type === 'setkey') { kg.style.display = ''; vg.style.display = ''; }
  // sound: no extra fields
}

// --- Modal ---
function openCreateForm() {
  document.getElementById('modalTitle').textContent = 'Create New Rule';
  document.getElementById('editingRuleId').value = '';
  document.getElementById('ruleName').value = '';
  document.getElementById('triggerType').value = 'manual';
  document.getElementById('triggerValue').value = '';
  document.getElementById('triggerUnit').value = 'seconds';
  document.getElementById('conditionType').value = 'always';
  document.getElementById('conditionKey').value = '';
  document.getElementById('conditionValue').value = '';
  document.getElementById('actionType').value = 'notify';
  document.getElementById('actionMessage').value = '';
  document.getElementById('actionKey').value = '';
  document.getElementById('actionTransform').value = 'uppercase';
  document.getElementById('actionValue').value = '';
  updateTriggerFields(); updateConditionFields(); updateActionFields();
  document.getElementById('ruleModal').classList.add('open');
}

function closeModal() {
  document.getElementById('ruleModal').classList.remove('open');
}

function editRule(id) {
  const rule = rules.find(r => r.id === id);
  if (!rule) return;
  document.getElementById('modalTitle').textContent = 'Edit Rule';
  document.getElementById('editingRuleId').value = id;
  document.getElementById('ruleName').value = rule.name;
  document.getElementById('triggerType').value = rule.trigger.type;
  document.getElementById('triggerValue').value = rule.trigger.value || '';
  document.getElementById('triggerUnit').value = rule.trigger.unit || 'seconds';
  document.getElementById('conditionType').value = rule.condition.type;
  document.getElementById('conditionKey').value = rule.condition.key || '';
  document.getElementById('conditionValue').value = rule.condition.value || '';
  document.getElementById('actionType').value = rule.action.type;
  document.getElementById('actionMessage').value = rule.action.message || '';
  document.getElementById('actionKey').value = rule.action.key || '';
  document.getElementById('actionTransform').value = rule.action.transform || 'uppercase';
  document.getElementById('actionValue').value = rule.action.value || '';
  updateTriggerFields(); updateConditionFields(); updateActionFields();
  document.getElementById('ruleModal').classList.add('open');
}

function saveRule() {
  const name = document.getElementById('ruleName').value.trim();
  if (!name) { alert('Please enter a rule name.'); return; }
  const editId = document.getElementById('editingRuleId').value;
  const triggerType = document.getElementById('triggerType').value;
  const triggerValue = document.getElementById('triggerValue').value.trim();
  const triggerUnit = document.getElementById('triggerUnit').value;
  if (triggerType === 'timer' && (!triggerValue || isNaN(Number(triggerValue)) || Number(triggerValue) <= 0)) {
    alert('Timer trigger requires a positive number.'); return;
  }
  if (triggerType === 'datachange' && !triggerValue) {
    alert('Data Change trigger requires a localStorage key.'); return;
  }
  const condType = document.getElementById('conditionType').value;
  const condKey = document.getElementById('conditionKey').value.trim();
  const condVal = document.getElementById('conditionValue').value.trim();
  const actType = document.getElementById('actionType').value;
  const actMsg = document.getElementById('actionMessage').value.trim();
  const actKey = document.getElementById('actionKey').value.trim();
  const actTransform = document.getElementById('actionTransform').value;
  const actVal = document.getElementById('actionValue').value.trim();

  const ruleData = {
    name,
    trigger: { type: triggerType, value: triggerValue, unit: triggerUnit },
    condition: { type: condType, key: condKey, value: condVal },
    action: { type: actType, message: actMsg, key: actKey, transform: actTransform, value: actVal }
  };

  if (editId) {
    const idx = rules.findIndex(r => r.id === editId);
    if (idx >= 0) {
      clearTimerForRule(editId);
      rules[idx] = { ...rules[idx], ...ruleData, error: false };
      setupTimerForRule(rules[idx]);
    }
  } else {
    const newRule = { id: uid(), enabled: true, error: false, ...ruleData };
    rules.push(newRule);
    setupTimerForRule(newRule);
  }
  saveData(); renderRules(); closeModal();
  addLog(name, editId ? 'Rule updated' : 'Rule created');
}

function deleteRule(id) {
  const rule = rules.find(r => r.id === id);
  if (!rule) return;
  if (!confirm(`Delete rule "${rule.name}"?`)) return;
  clearTimerForRule(id);
  rules = rules.filter(r => r.id !== id);
  saveData(); renderRules();
  addLog(rule.name, 'Rule deleted');
}

function toggleRule(id) {
  const rule = rules.find(r => r.id === id);
  if (!rule) return;
  rule.enabled = !rule.enabled;
  rule.error = false;
  if (rule.enabled) { setupTimerForRule(rule); }
  else { clearTimerForRule(id); }
  saveData(); renderRules();
  addLog(rule.name, rule.enabled ? 'Rule enabled' : 'Rule disabled');
}

// --- Rule Execution ---
function evaluateCondition(cond) {
  if (cond.type === 'always') return true;
  const stored = localStorage.getItem(cond.key);
  if (stored === null) return false;
  if (cond.type === 'equals') return stored === cond.value;
  if (cond.type === 'greater') return Number(stored) > Number(cond.value);
  if (cond.type === 'less') return Number(stored) < Number(cond.value);
  if (cond.type === 'contains') return stored.includes(cond.value);
  return false;
}

function executeAction(action, ruleName) {
  if (action.type === 'notify') {
    showToast(action.message || 'Automation triggered!');
    addLog(ruleName, 'Action: Notification shown ‚Äî ' + (action.message || ''));
  } else if (action.type === 'log') {
    addLog(ruleName, 'Action: Log ‚Äî ' + (action.message || ''));
  } else if (action.type === 'transform') {
    const val = localStorage.getItem(action.key);
    if (val === null) {
      addLog(ruleName, 'Action: Transform ‚Äî key not found: ' + action.key, true);
      return false;
    }
    let result = val;
    if (action.transform === 'uppercase') result = val.toUpperCase();
    else if (action.transform === 'lowercase') result = val.toLowerCase();
    else if (action.transform === 'reverse') result = val.split('').reverse().join('');
    localStorage.setItem(action.key, result);
    addLog(ruleName, `Action: Transformed "${action.key}" (${action.transform}): "${val}" ‚Üí "${result}"`);
  } else if (action.type === 'setkey') {
    localStorage.setItem(action.key, action.value || '');
    addLog(ruleName, `Action: Set "${action.key}" = "${action.value || ''}"`);
  } else if (action.type === 'sound') {
    playBeep();
    addLog(ruleName, 'Action: Sound played');
  }
  return true;
}

function executeRule(rule) {
  if (!rule.enabled) return;
  try {
    const condMet = evaluateCondition(rule.condition);
    if (!condMet) {
      addLog(rule.name, 'Condition not met ‚Äî skipped');
      return;
    }
    const ok = executeAction(rule.action, rule.name);
    if (ok === false) { rule.error = true; }
    else { rule.error = false; }
  } catch (e) {
    rule.error = true;
    addLog(rule.name, 'Error: ' + e.message, true);
  }
  saveData(); renderRules();
}

function runSingleRule(id) {
  const rule = rules.find(r => r.id === id);
  if (rule) {
    addLog(rule.name, 'Trigger: Manual execution');
    executeRule(rule);
  }
}

function runAllRules() {
  const enabled = rules.filter(r => r.enabled);
  if (enabled.length === 0) { showToast('No enabled rules to run.'); return; }
  addLog('System', `Run All: Executing ${enabled.length} enabled rule(s)`);
  enabled.forEach(rule => {
    addLog(rule.name, 'Trigger: Run All');
    executeRule(rule);
  });
}

// --- Timers ---
function setupTimerForRule(rule) {
  if (rule.trigger.type !== 'timer' || !rule.enabled || timersPaused) return;
  clearTimerForRule(rule.id);
  let ms = Number(rule.trigger.value) * 1000;
  if (rule.trigger.unit === 'minutes') ms *= 60;
  if (ms < 1000) ms = 1000;
  timerIntervals[rule.id] = setInterval(() => {
    addLog(rule.name, 'Trigger: Timer fired');
    executeRule(rule);
  }, ms);
}

function clearTimerForRule(id) {
  if (timerIntervals[id]) { clearInterval(timerIntervals[id]); delete timerIntervals[id]; }
}

function setupAllTimers() {
  rules.forEach(r => { clearTimerForRule(r.id); setupTimerForRule(r); });
}

function toggleAllTimers() {
  timersPaused = !timersPaused;
  const btn = document.getElementById('timerToggleBtn');
  if (timersPaused) {
    Object.keys(timerIntervals).forEach(id => clearTimerForRule(id));
    btn.textContent = '‚ñ∂ Resume Timers';
    addLog('System', 'All timers paused');
  } else {
    setupAllTimers();
    btn.textContent = '‚è∏ Pause Timers';
    addLog('System', 'All timers resumed');
  }
  renderRules();
}

// --- Data Change Watcher ---
(function watchStorage() {
  const origSet = localStorage.setItem.bind(localStorage);
  localStorage.setItem = function(key, value) {
    origSet(key, value);
    rules.forEach(rule => {
      if (rule.enabled && rule.trigger.type === 'datachange' && rule.trigger.value === key) {
        addLog(rule.name, `Trigger: Data changed ‚Äî "${key}"`);
        executeRule(rule);
      }
    });
  };
})();

// --- Sound ---
function playBeep() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.frequency.value = 660;
  osc.type = 'sine';
  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.3);
}

// --- Toast Notifications ---
function showToast(msg) {
  const el = document.createElement('div');
  el.textContent = msg;
  Object.assign(el.style, {
    position: 'fixed', top: '20px', right: '20px', background: '#10b981',
    color: '#0a0a0f', padding: '12px 20px', borderRadius: '8px', fontWeight: '600',
    fontSize: '.9rem', zIndex: '9999', boxShadow: '0 4px 20px #10b98140',
    animation: 'fadeIn .3s', maxWidth: '320px'
  });
  document.body.appendChild(el);
  setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity .3s'; }, 2500);
  setTimeout(() => el.remove(), 3000);
}

// --- Export / Import ---
function exportRules() {
  const data = JSON.stringify({ rules, log: logEntries }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'automation-hub-rules.json'; a.click();
  URL.revokeObjectURL(url);
  addLog('System', 'Rules exported to JSON');
}

function importRules(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.rules && Array.isArray(data.rules)) {
        Object.keys(timerIntervals).forEach(id => clearTimerForRule(id));
        rules = data.rules;
        if (data.log && Array.isArray(data.log)) logEntries = data.log;
        saveData(); renderRules(); renderLog(); setupAllTimers();
        addLog('System', `Imported ${rules.length} rule(s)`);
        showToast(`Imported ${rules.length} rule(s)`);
      } else {
        alert('Invalid file: no rules array found.');
      }
    } catch (err) {
      alert('Failed to parse JSON: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function clearLog() {
  if (!confirm('Clear all log entries?')) return;
  logEntries = [];
  saveData(); renderLog();
}

// --- Keyboard Shortcut ---
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
  if (e.key === 'n' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT'
      && document.activeElement.tagName !== 'SELECT' && document.activeElement.tagName !== 'TEXTAREA') {
    e.preventDefault(); openCreateForm();
  }
});

// Close modal on overlay click
document.getElementById('ruleModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});

// --- Init ---
loadData(); renderRules(); renderLog(); setupAllTimers();
</script>
</body>
</html>
