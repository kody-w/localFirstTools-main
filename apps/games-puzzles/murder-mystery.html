<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Murder at Ashworth Manor</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0d0d1a;color:#d4c9a8;font-family:Georgia,serif;overflow:hidden;user-select:none}
#game{width:100vw;height:100vh;display:flex;flex-direction:column}
#topbar{height:44px;background:#16162b;display:flex;align-items:center;padding:0 12px;gap:8px;border-bottom:1px solid #2a2a4a;flex-shrink:0}
#topbar .title{font-size:14px;color:#c4a265;flex:1;font-weight:bold}
#topbar button{background:#1e1e38;color:#d4c9a8;border:1px solid #3a3a5a;padding:4px 10px;font:12px Georgia,serif;cursor:pointer;border-radius:3px}
#topbar button:hover{background:#2a2a4a;color:#c4a265}
#middle{display:flex;flex:1;overflow:hidden}
#scene-wrap{flex:1;position:relative;background:#0a0a15}
canvas{display:block;width:100%;height:100%}
#sidebar{width:200px;background:#131325;border-left:1px solid #2a2a4a;display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}
.sb-section{padding:8px;border-bottom:1px solid #1e1e38}
.sb-title{font-size:11px;color:#887755;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.sb-btn{display:block;width:100%;text-align:left;background:none;border:1px solid transparent;color:#a09880;padding:4px 6px;font:12px Georgia,serif;cursor:pointer;border-radius:2px;margin:1px 0}
.sb-btn:hover,.sb-btn.active{background:#1e1e38;color:#c4a265;border-color:#3a3a5a}
.sb-btn.has-suspect::before{content:"üë§ ";font-size:10px}
#textbox{height:80px;background:#0f0f20;border-top:1px solid #2a2a4a;padding:10px 16px;font-size:13px;line-height:1.5;overflow-y:auto;flex-shrink:0}
#overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(5,5,15,0.92);z-index:100;overflow-y:auto}
#overlay.show{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:30px}
.panel{background:#151528;border:1px solid #2a2a4a;border-radius:6px;padding:20px;max-width:750px;width:100%;margin:10px 0}
.panel h2{color:#c4a265;font-size:18px;margin-bottom:12px;border-bottom:1px solid #2a2a4a;padding-bottom:8px}
.panel h3{color:#a08850;font-size:14px;margin:10px 0 6px}
.panel p,.panel li{font-size:13px;line-height:1.5;margin:4px 0}
.panel ul{list-style:none;padding:0}
.close-btn{position:fixed;top:10px;right:20px;background:#1e1e38;color:#c4a265;border:1px solid #3a3a5a;padding:6px 14px;font:14px Georgia,serif;cursor:pointer;border-radius:3px;z-index:101}
.clue-card{display:inline-block;background:#1a1a30;border:1px solid #3a3a5a;padding:6px 10px;margin:4px;border-radius:3px;font-size:12px;cursor:pointer}
.clue-card:hover,.clue-card.selected{border-color:#c4a265;color:#c4a265}
.clue-card.connected{border-color:#2a6e3f;color:#8fbc8f}
.dlg-opt{display:block;background:#1a1a30;border:1px solid #2a2a4a;padding:8px 12px;margin:4px 0;font:13px Georgia,serif;color:#d4c9a8;cursor:pointer;border-radius:3px;text-align:left;width:100%}
.dlg-opt:hover{border-color:#c4a265;color:#c4a265}
.dlg-opt:disabled{opacity:0.4;cursor:default;border-color:#1a1a2a}
.suspect-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.suspect-card{background:#1a1a30;border:2px solid #2a2a4a;padding:10px;text-align:center;cursor:pointer;border-radius:4px}
.suspect-card:hover,.suspect-card.sel{border-color:#c4a265}
.suspect-card canvas{display:block;margin:0 auto 6px}
.suspect-card .sname{font-size:13px;color:#c4a265}
.suspect-card .srole{font-size:11px;color:#887755}
.evidence-sel{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0}
.ev-pick{background:#1a1a30;border:2px solid #2a2a4a;padding:6px 10px;font:12px Georgia,serif;color:#a09880;cursor:pointer;border-radius:3px}
.ev-pick:hover{border-color:#c4a265}
.ev-pick.chosen{border-color:#c4a265;color:#c4a265;background:#1e1e38}
.result-box{text-align:center;padding:30px}
.result-box h1{font-size:28px;margin-bottom:10px}
.result-box .rating{font-size:20px;color:#c4a265;margin:10px 0}
.result-box button{background:#2a2a4a;color:#c4a265;border:1px solid #c4a265;padding:10px 24px;font:16px Georgia,serif;cursor:pointer;border-radius:4px;margin-top:16px}
#board-canvas{border:1px solid #2a2a4a;border-radius:4px;background:#0f0f1a;cursor:crosshair}
.nb-entry{font-size:12px;padding:3px 0;border-bottom:1px solid #1a1a2a;color:#a09880}
.nb-entry b{color:#c4a265}
#start-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#0a0a15;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
#start-screen h1{font-size:32px;color:#c4a265;margin-bottom:6px}
#start-screen h2{font-size:16px;color:#887755;font-weight:normal;margin-bottom:24px}
#start-screen p{font-size:13px;max-width:400px;margin-bottom:20px;line-height:1.6}
#start-screen button{background:#1e1e38;color:#c4a265;border:2px solid #c4a265;padding:12px 32px;font:18px Georgia,serif;cursor:pointer;border-radius:4px}
#start-screen button:hover{background:#2a2a4a}
</style>
</head>
<body>
<div id="start-screen">
<h1>üïµÔ∏è Murder at Ashworth Manor</h1>
<h2>A Detective Mystery</h2>
<p>Lord Ashworth has been found dead in his study. As the renowned detective summoned to the manor, you must explore the rooms, interrogate the suspects, gather clues, and unmask the killer.</p>
<button onclick="startGame()">Begin Investigation</button>
</div>
<div id="game" style="display:none">
<div id="topbar">
<span class="title" id="room-title">Grand Foyer</span>
<button onclick="showNotebook()">üìì Notes</button>
<button onclick="showBoard()">üîç Evidence (E)</button>
<button onclick="useHint()" id="hint-btn">üí° Hints (3)</button>
<button onclick="showAccuse()">‚öñÔ∏è Accuse</button>
</div>
<div id="middle">
<div id="scene-wrap"><canvas id="scene"></canvas></div>
<div id="sidebar">
<div class="sb-section"><div class="sb-title">Rooms</div><div id="room-nav"></div></div>
<div class="sb-section"><div class="sb-title">Suspects</div><div id="suspect-nav"></div></div>
<div class="sb-section"><div class="sb-title">Clues Found</div><div id="clue-count">0 / 0</div></div>
</div>
</div>
<div id="textbox"></div>
</div>
<div id="overlay"></div>
<script>
(()=>{
const $=id=>document.getElementById(id);
let W=800,H=500,ctx,canvas,audioCtx,state,twTimer=0,twText='',twDone='',hoveredHot=null;
const ROOM_NAMES={foyer:'Grand Foyer',study:'The Study',library:'The Library',kitchen:'The Kitchen',ballroom:'The Ballroom',greenhouse:'The Greenhouse',bedroom:'Master Bedroom',cellar:'Wine Cellar'};
const ROOM_CONNECTIONS={foyer:['study','library','kitchen','ballroom','bedroom'],study:['foyer','library'],library:['foyer','study'],kitchen:['foyer','cellar'],ballroom:['foyer','greenhouse'],greenhouse:['ballroom'],bedroom:['foyer'],cellar:['kitchen']};
const SUSPECTS=[
{id:'lady',name:'Lady Ashworth',role:'Wife of the Deceased',motive:'Stands to inherit the entire estate and fortune',room:'bedroom',hair:'#8B7355',dress:'#4a1a4a',skin:'#f0dcc0'},
{id:'gray',name:'Professor Gray',role:'Rival Academic',motive:'Long-standing academic rivalry and recent public humiliation',room:'library',hair:'#999',dress:'#2a3a4a',skin:'#e8d4b8'},
{id:'chen',name:'Miss Chen',role:'Personal Secretary',motive:'Holds a dangerous secret Lord Ashworth threatened to expose',room:'study',hair:'#1a1a2a',dress:'#1a3a3a',skin:'#f0dcc0'},
{id:'blackwell',name:'Dr. Blackwell',role:'Family Doctor',motive:'Lord Ashworth discovered a malpractice cover-up',room:'kitchen',hair:'#3a3020',dress:'#2a2a3a',skin:'#dcc8a8'},
{id:'james',name:'James the Butler',role:'Head Butler (30 years)',motive:'Recently learned he was to be dismissed after decades of loyal service',room:'foyer',hair:'#555',dress:'#1a1a2a',skin:'#d8c4a8'},
{id:'helena',name:'Helena Crane',role:'Portrait Artist',motive:'Owes massive gambling debts; Lord Ashworth refused further loans',room:'ballroom',hair:'#c45a30',dress:'#5a1a2a',skin:'#f0d8c0'}
];
const CLUE_DEFS=[
{id:'broken_clock',room:'study',x:0.72,y:0.22,name:'Broken Clock',base:'A mantel clock, shattered. Stopped at 11:47 PM ‚Äî the likely time of death.',universal:true},
{id:'blood_stain',room:'study',x:0.45,y:0.55,name:'Blood Stain',base:'A dark stain on the carpet near the mahogany desk. Still damp.',universal:true},
{id:'letter_opener',room:'study',x:0.5,y:0.38,name:'Bloodied Letter Opener',base:'The murder weapon. An ornate silver letter opener with blood on the blade.',universal:true},
{id:'fingerprints',room:'study',x:0.52,y:0.36,name:'Fingerprints on Weapon',dynamic:true,universal:true},
{id:'torn_letter',room:'study',x:0.35,y:0.32,name:'Torn Letter',dynamic:true},
{id:'guest_book',room:'foyer',x:0.55,y:0.52,name:'Guest Book',base:'All six suspects signed in between 7 and 9 PM. No one signed out.',universal:true},
{id:'muddy_prints',room:'foyer',x:0.3,y:0.7,name:'Muddy Footprints',dynamic:true},
{id:'poison_bottle',room:'kitchen',x:0.65,y:0.35,name:'Arsenic Bottle',base:'A small brown bottle labeled "Rat Poison" hidden behind the spice rack. Recently opened.',universal:true},
{id:'dirty_glass',room:'kitchen',x:0.4,y:0.42,name:'Dirty Wine Glass',base:'A wine glass with faint residue. Smells bitter ‚Äî possibly tainted.',universal:true},
{id:'diary_page',room:'bedroom',x:0.6,y:0.35,name:'Diary Pages',dynamic:true},
{id:'financial_records',room:'bedroom',x:0.3,y:0.45,name:'Financial Records',dynamic:true},
{id:'academic_paper',room:'library',x:0.55,y:0.3,name:'Annotated Research Paper',base:'A paper by Professor Gray with furious marginal notes in Lord Ashworth\'s hand: "FRAUD ‚Äî I will expose this."',universal:true},
{id:'earring',room:'ballroom',x:0.6,y:0.65,name:'Dropped Pearl Earring',base:'A pearl earring on the ballroom floor. Could belong to Lady Ashworth or Helena Crane.',universal:true},
{id:'art_supplies',room:'ballroom',x:0.25,y:0.4,name:'Paint-Stained Satchel',base:'Helena\'s bag. Contains paints, brushes, and a suspiciously empty vial.',universal:true},
{id:'plant_book',room:'greenhouse',x:0.4,y:0.3,name:'Toxic Plants Reference',base:'A book on poisonous plants, bookmarked at "Aconitum" (wolfsbane). Dog-eared recently.',universal:true},
{id:'muddy_boots',room:'greenhouse',x:0.7,y:0.65,name:'Muddy Boots',dynamic:true},
{id:'wine_inventory',room:'cellar',x:0.5,y:0.4,name:'Wine Inventory Ledger',base:'Several bottles marked as "missing." Dates align with the past month.',universal:true},
{id:'secret_passage',room:'cellar',x:0.2,y:0.5,name:'Hidden Passage',base:'A narrow passage behind a wine rack leads up toward the study. Fresh scuff marks on the floor.',universal:true},
{id:'resignation_letter',room:'foyer',x:0.72,y:0.45,name:'Butler\'s Resignation Draft',base:'A crumpled draft in James\'s handwriting: "After 30 years of faithful service, to be cast aside..."',universal:true},
{id:'medical_journal',room:'kitchen',x:0.25,y:0.5,name:'Medical Journal',base:'Dr. Blackwell\'s journal left open. An entry reads: "The dosage error must never come to light."',universal:true}
];
const KILLER_CLUE_TEXT={
lady:{fingerprints:'Partial prints ‚Äî slender fingers, traces of hand cream. Matches Lady Ashworth\'s profile.',torn_letter:'A letter from Lady Ashworth\'s solicitor discussing "accelerating the inheritance timeline." Torn in haste.',muddy_prints:'Size 6 prints in heeled boots, leading from the greenhouse side entrance to the study.',diary_page:'Lord Ashworth wrote: "Eleanor grows more impatient by the day. She asked Dr. Blackwell about my life insurance again."',financial_records:'Insurance documents showing Lady Ashworth recently doubled the life insurance policy. Beneficiary: herself.',muddy_boots:'Size 6 heeled boots caked in greenhouse mud. Lady Ashworth claimed she never left the bedroom.'},
gray:{fingerprints:'Large prints with ink stains on the fingertips. Consistent with an academic ‚Äî Professor Gray.',torn_letter:'A rejection letter from the Royal Academy, citing Lord Ashworth\'s damning review. Gray\'s name is circled.',muddy_prints:'Size 11 prints in Oxford shoes, tracking library dust toward the study.',diary_page:'Lord Ashworth wrote: "Gray confronted me tonight. His eyes were wild. He said I\'d destroyed his life\'s work."',financial_records:'Grant funding records. Lord Ashworth blocked Gray\'s research funding three times.',muddy_boots:'Large muddy Oxfords behind a potted fern. Gray said he stayed in the library all evening.'},
chen:{fingerprints:'Small precise prints with typewriter ribbon residue. Miss Chen uses a typewriter daily.',torn_letter:'A half-burned letter: Miss Chen\'s real identity ‚Äî she\'s Lord Ashworth\'s illegitimate daughter, written out of the will.',muddy_prints:'Size 7 prints in flat shoes, with a distinctive scuff mark on the right sole.',diary_page:'Lord Ashworth wrote: "Chen discovered the truth. She begged me to acknowledge her. I refused. She wept, then went silent."',financial_records:'DNA test results hidden in a locked drawer. Miss Chen is Lord Ashworth\'s biological daughter.',muddy_boots:'Flat shoes with garden soil. Miss Chen said she was filing papers in the study all night.'},
blackwell:{fingerprints:'Prints with traces of surgical glove powder. Dr. Blackwell wore gloves but they tore.',torn_letter:'A letter from the Medical Board regarding "Patient H. Ashworth ‚Äî lethal dosage error." Blackwell tried to destroy it.',muddy_prints:'Size 10 prints in leather shoes. A medical bag was dragged alongside.',diary_page:'Lord Ashworth wrote: "Blackwell killed my brother with his incompetence. I have the proof. Tomorrow I contact the Board."',financial_records:'Hospital settlement records. Blackwell paid ¬£50,000 to suppress a malpractice death ‚Äî Lord Ashworth\'s brother.',muddy_boots:'Leather shoes with cellar dust. Blackwell claimed he was in the kitchen all evening.'},
james:{fingerprints:'Prints match someone who polishes silver daily ‚Äî smooth whorls. The butler\'s hands.',torn_letter:'A termination letter drafted by Lord Ashworth: "After 30 years, your services are no longer required. Leave by month\'s end."',muddy_prints:'Size 9 prints in polished dress shoes. The butler\'s shoes, freshly scuffed.',diary_page:'Lord Ashworth wrote: "James overheard my plans. The look in his eyes chilled me. 30 years of loyalty ‚Äî what does that drive a man to?"',financial_records:'Lord Ashworth\'s new will: James cut from a ¬£100,000 bequest. Dated three days ago.',muddy_boots:'Polished shoes with hidden mud on the soles. James claimed he was in the foyer all night.'},
helena:{fingerprints:'Prints with traces of oil paint ‚Äî cadmium red and titanium white. An artist\'s hands.',torn_letter:'An IOU for ¬£200,000 signed by Helena. Lord Ashworth wrote "FINAL NOTICE" across it in red ink.',muddy_prints:'Size 7 prints in ankle boots with a distinctive worn heel pattern.',diary_page:'Lord Ashworth wrote: "Helena begged for more money. I refused. She said I\'d regret it. The desperation in her voice disturbed me."',financial_records:'Gambling debt records: Helena owes ¬£200,000 to dangerous people. Lord Ashworth was her last hope.',muddy_boots:'Paint-spattered ankle boots with fresh mud. Helena said she was dancing in the ballroom.'}
};
const KEY_EVIDENCE={
lady:['fingerprints','torn_letter','financial_records'],gray:['fingerprints','diary_page','academic_paper'],
chen:['fingerprints','torn_letter','diary_page'],blackwell:['fingerprints','torn_letter','medical_journal'],
james:['fingerprints','torn_letter','resignation_letter'],helena:['fingerprints','torn_letter','financial_records']
};
const VALID_CONNECTIONS=[
['broken_clock','blood_stain'],['letter_opener','fingerprints'],['fingerprints','torn_letter'],
['muddy_prints','muddy_boots'],['poison_bottle','dirty_glass'],['dirty_glass','medical_journal'],
['diary_page','financial_records'],['secret_passage','muddy_prints'],['torn_letter','financial_records'],
['art_supplies','earring'],['academic_paper','diary_page'],['resignation_letter','diary_page']
];
function initState(fresh){
if(!fresh){try{const s=localStorage.getItem('murder_save');if(s){state=JSON.parse(s);return true;}}catch(e){}}
const ki=SUSPECTS[(Math.random()*6)|0].id;
state={room:'foyer',clues:[],notebook:[],connections:[],killer:ki,hints:3,hintsUsed:0,accused:false,
dialogueUsed:{},phase:'explore',totalClues:CLUE_DEFS.length,suspectTalked:{}};
return false;
}
function save(){try{localStorage.setItem('murder_save',JSON.stringify(state));}catch(e){}}
function hasClue(id){return state.clues.indexOf(id)>=0}
function addClue(id){if(!hasClue(id)){state.clues.push(id);updateClueCount();save();}}
function addNote(txt){if(state.notebook.indexOf(txt)<0){state.notebook.push(txt);save();}}
function updateClueCount(){$('clue-count').textContent=state.clues.length+' / '+state.totalClues;}
function initAudio(){
try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();
const master=audioCtx.createGain();master.gain.value=0.15;master.connect(audioCtx.destination);
const tick=()=>{if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();
o.type='square';o.frequency.value=800;g.gain.setValueAtTime(0.08,audioCtx.currentTime);
g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.05);
o.connect(g);g.connect(master);o.start();o.stop(audioCtx.currentTime+0.05);
setTimeout(tick,1000+Math.random()*200);};tick();
const rain=()=>{if(!audioCtx)return;const bufSz=audioCtx.sampleRate*2,buf=audioCtx.createBuffer(1,bufSz,audioCtx.sampleRate),d=buf.getChannelData(0);
for(let i=0;i<bufSz;i++)d[i]=(Math.random()*2-1)*0.3;
const src=audioCtx.createBufferSource(),filt=audioCtx.createBiquadFilter(),g=audioCtx.createGain();
filt.type='lowpass';filt.frequency.value=400;g.gain.value=0.12;
src.buffer=buf;src.loop=true;src.connect(filt);filt.connect(g);g.connect(master);src.start();};rain();
const thunder=()=>{if(!audioCtx)return;const bufSz=audioCtx.sampleRate,buf=audioCtx.createBuffer(1,bufSz,audioCtx.sampleRate),d=buf.getChannelData(0);
for(let i=0;i<bufSz;i++)d[i]=(Math.random()*2-1);
const src=audioCtx.createBufferSource(),filt=audioCtx.createBiquadFilter(),g=audioCtx.createGain();
filt.type='lowpass';filt.frequency.value=80;g.gain.setValueAtTime(0.3,audioCtx.currentTime);
g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+1.5);
src.buffer=buf;src.connect(filt);filt.connect(g);g.connect(master);src.start();src.stop(audioCtx.currentTime+1.5);
setTimeout(thunder,15000+Math.random()*30000);};setTimeout(thunder,5000);
}catch(e){}}
function playClick(){
if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();
o.frequency.value=600;g.gain.setValueAtTime(0.1,audioCtx.currentTime);
g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.08);
o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.08);
}
function typewrite(text){twText=text;twDone='';twTimer=0;
const step=()=>{if(twTimer<twText.length){twDone+=twText[twTimer|0];twTimer++;
$('textbox').textContent=twDone;requestAnimationFrame(step);}};requestAnimationFrame(step);
}
function getClueDesc(clue){
if(clue.dynamic&&KILLER_CLUE_TEXT[state.killer]&&KILLER_CLUE_TEXT[state.killer][clue.id])
return KILLER_CLUE_TEXT[state.killer][clue.id];
return clue.base||'Nothing unusual here.';
}
const RC={
foyer:{ceil:'#1a1520',floor:'#2a1f15',wall:'#201828',side:'#181222',
feat:[{t:'r',x:.08,y:.18,w:.12,h:.45,c:'#2a2035',o:'#3a2a40'},{t:'r',x:.4,y:.05,w:.2,h:.55,c:'#251f18',o:'#352f28'},
{t:'r',x:.82,y:.25,w:.1,h:.35,c:'#302520',o:'#403530'},{t:'c',x:.5,y:.08,r:.06,c:'#c4a265',o:'#a08040'},
{t:'r',x:.02,y:.6,w:.96,h:.01,c:'#3a2a20'}]},
study:{ceil:'#1a1015',floor:'#2a1510',wall:'#281518',side:'#1e1015',
feat:[{t:'r',x:.3,y:.28,w:.35,h:.2,c:'#3a2018',o:'#4a3028'},{t:'r',x:.72,y:.15,w:.08,h:.3,c:'#2a2028',o:'#3a3038'},
{t:'r',x:.15,y:.2,w:.1,h:.35,c:'#352520',o:'#453530'},{t:'r',x:.42,y:.32,w:.03,h:.04,c:'#888',o:'#aaa'},
{t:'r',x:.35,y:.5,w:.25,h:.03,c:'#4a1515'}]},
library:{ceil:'#151a15',floor:'#1a2015',wall:'#182818',side:'#121e12',
feat:[{t:'r',x:.05,y:.12,w:.18,h:.48,c:'#2a3520',o:'#3a4530'},{t:'r',x:.78,y:.12,w:.16,h:.48,c:'#2a3520',o:'#3a4530'},
{t:'r',x:.35,y:.35,w:.25,h:.18,c:'#3a2a18',o:'#4a3a28'},{t:'r',x:.3,y:.12,w:.35,h:.08,c:'#352a20'}]},
kitchen:{ceil:'#181a1e',floor:'#202228',wall:'#1e2025',side:'#161820',
feat:[{t:'r',x:.1,y:.25,w:.3,h:.15,c:'#404550',o:'#505560'},{t:'r',x:.6,y:.2,w:.25,h:.35,c:'#353840',o:'#454850'},
{t:'r',x:.15,y:.42,w:.15,h:.2,c:'#2a2a30',o:'#3a3a40'},{t:'r',x:.45,y:.35,w:.1,h:.12,c:'#556060'}]},
ballroom:{ceil:'#1e1a18',floor:'#28201a',wall:'#251e1a',side:'#1e1815',
feat:[{t:'c',x:.5,y:.1,r:.08,c:'#c4a265',o:'#e8c880'},{t:'r',x:.1,y:.55,w:.15,h:.08,c:'#3a3028',o:'#4a4038'},
{t:'r',x:.75,y:.55,w:.15,h:.08,c:'#3a3028',o:'#4a4038'},{t:'r',x:.3,y:.15,w:.4,h:.02,c:'#4a3a28'}]},
greenhouse:{ceil:'#0a1a15',floor:'#152a20',wall:'#183028',side:'#102218',
feat:[{t:'r',x:.1,y:.15,w:.2,h:.4,c:'#1a3a25',o:'#2a4a35'},{t:'r',x:.7,y:.15,w:.2,h:.4,c:'#1a3a25',o:'#2a4a35'},
{t:'r',x:.35,y:.2,w:.3,h:.25,c:'#204030',o:'#305040'},{t:'c',x:.5,y:.12,r:.12,c:'rgba(100,140,120,0.2)'}]},
bedroom:{ceil:'#15152a',floor:'#1a1a30',wall:'#1a1a35',side:'#141428',
feat:[{t:'r',x:.2,y:.25,w:.35,h:.25,c:'#2a2040',o:'#3a3050'},{t:'r',x:.7,y:.2,w:.15,h:.35,c:'#282035',o:'#383045'},
{t:'r',x:.1,y:.3,w:.08,h:.25,c:'#25203a',o:'#35304a'},{t:'c',x:.77,y:.22,r:.03,c:'#c4a245',o:'#a08030'}]},
cellar:{ceil:'#121215',floor:'#1a1515',wall:'#181818',side:'#101012',
feat:[{t:'r',x:.05,y:.12,w:.12,h:.5,c:'#2a2020',o:'#3a3030'},{t:'r',x:.25,y:.12,w:.12,h:.5,c:'#2a2020',o:'#3a3030'},
{t:'r',x:.65,y:.12,w:.12,h:.5,c:'#2a2020',o:'#3a3030'},{t:'r',x:.85,y:.12,w:.12,h:.5,c:'#2a2020',o:'#3a3030'},
{t:'r',x:.18,y:.45,w:.07,h:.12,c:'#151520',o:'#252530'}]}
};
function drawRoom(rid){
const r=RC[rid];if(!r)return;
ctx.fillStyle=r.ceil;ctx.fillRect(0,0,W,H);
const fg=ctx.createLinearGradient(0,H*0.4,0,H);fg.addColorStop(0,r.floor);fg.addColorStop(1,'#0a0808');
ctx.fillStyle=fg;ctx.beginPath();ctx.moveTo(0,H*0.6);ctx.lineTo(W*0.15,H*0.45);ctx.lineTo(W*0.85,H*0.45);ctx.lineTo(W,H*0.6);ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.fill();
ctx.fillStyle=r.wall;ctx.beginPath();ctx.moveTo(W*0.15,H*0.08);ctx.lineTo(W*0.85,H*0.08);ctx.lineTo(W*0.85,H*0.45);ctx.lineTo(W*0.15,H*0.45);ctx.fill();
ctx.fillStyle=r.side;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(W*0.15,H*0.08);ctx.lineTo(W*0.15,H*0.45);ctx.lineTo(0,H*0.6);ctx.fill();
ctx.beginPath();ctx.moveTo(W,0);ctx.lineTo(W*0.85,H*0.08);ctx.lineTo(W*0.85,H*0.45);ctx.lineTo(W,H*0.6);ctx.fill();
ctx.strokeStyle='#2a2028';ctx.lineWidth=1;
ctx.strokeRect(W*0.15,H*0.08,W*0.7,H*0.37);
for(const f of r.feat){
if(f.t==='r'){ctx.fillStyle=f.c;ctx.fillRect(W*f.x,H*f.y,W*f.w,H*f.h);
if(f.o){ctx.strokeStyle=f.o;ctx.lineWidth=1;ctx.strokeRect(W*f.x,H*f.y,W*f.w,H*f.h);}}
else if(f.t==='c'){ctx.beginPath();ctx.arc(W*f.x,H*f.y,Math.min(W,H)*f.r,0,Math.PI*2);
ctx.fillStyle=f.c;ctx.fill();if(f.o){ctx.strokeStyle=f.o;ctx.lineWidth=1;ctx.stroke();}}}
const grad=ctx.createRadialGradient(W*0.5,H*0.3,0,W*0.5,H*0.3,W*0.5);
grad.addColorStop(0,'rgba(200,170,100,0.04)');grad.addColorStop(1,'rgba(0,0,0,0)');
ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);
drawHotspots(rid);
drawSuspectInRoom(rid);
}
function getHotspots(rid){
const spots=[];
CLUE_DEFS.forEach(c=>{if(c.room===rid&&!hasClue(c.id))spots.push({x:c.x,y:c.y,w:0.06,h:0.06,type:'clue',data:c});});
const s=SUSPECTS.find(s=>s.room===rid);
if(s)spots.push({x:0.88,y:0.5,w:0.1,h:0.2,type:'suspect',data:s});
return spots;
}
function drawHotspots(rid){
const spots=getHotspots(rid);
for(const h of spots){
const x=W*h.x,y=H*h.y,w=W*h.w,hh=H*h.h;
const isHov=hoveredHot&&hoveredHot.data&&h.data&&
((h.type==='clue'&&hoveredHot.data.id===h.data.id)||(h.type==='suspect'&&hoveredHot.data.id===h.data.id));
if(h.type==='clue'){
ctx.save();const glow=ctx.createRadialGradient(x+w/2,y+hh/2,0,x+w/2,y+hh/2,w);
glow.addColorStop(0,isHov?'rgba(200,170,100,0.5)':'rgba(200,170,100,0.2)');
glow.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=glow;ctx.fillRect(x-w/2,y-hh/2,w*2,hh*2);
ctx.fillStyle=isHov?'#c4a265':'#887755';ctx.font='16px Georgia';ctx.fillText('‚ú¶',x+w/2-5,y+hh/2+5);
ctx.restore();
if(isHov){ctx.fillStyle='#c4a265';ctx.font='11px Georgia';ctx.fillText(h.data.name,x-20,y-8);}
}
if(h.type==='suspect'){
drawMiniPortrait(h.data,W*0.88,H*0.35,W*0.08,H*0.25);
if(isHov){ctx.fillStyle='#c4a265';ctx.font='11px Georgia';ctx.fillText(h.data.name,W*0.82,H*0.32);}
else{ctx.fillStyle='#887755';ctx.font='10px Georgia';ctx.fillText(h.data.name,W*0.84,H*0.32);}
}}
}
function drawMiniPortrait(s,x,y,w,h){
ctx.fillStyle=s.dress;ctx.fillRect(x,y+h*0.55,w,h*0.45);
ctx.beginPath();ctx.arc(x+w/2,y+h*0.35,w*0.3,0,Math.PI*2);ctx.fillStyle=s.skin;ctx.fill();
ctx.beginPath();ctx.arc(x+w/2,y+h*0.2,w*0.35,Math.PI,0);ctx.fillStyle=s.hair;ctx.fill();
ctx.fillStyle='#222';ctx.fillRect(x+w*0.35,y+h*0.32,w*0.06,w*0.06);
ctx.fillRect(x+w*0.55,y+h*0.32,w*0.06,w*0.06);
ctx.strokeStyle='#442';ctx.lineWidth=1;ctx.beginPath();ctx.arc(x+w/2,y+h*0.42,w*0.08,0,Math.PI);ctx.stroke();
}
function drawSuspectInRoom(rid){
const s=SUSPECTS.find(s=>s.room===rid);if(!s)return;
}
function drawPortraitLarge(s,cvs){
const c=cvs.getContext('2d'),pw=cvs.width,ph=cvs.height;
c.fillStyle='#1a1a30';c.fillRect(0,0,pw,ph);
c.fillStyle=s.dress;c.beginPath();c.moveTo(pw*0.2,ph*0.65);c.quadraticCurveTo(pw*0.5,ph*0.55,pw*0.8,ph*0.65);
c.lineTo(pw*0.85,ph);c.lineTo(pw*0.15,ph);c.fill();
c.beginPath();c.arc(pw/2,ph*0.38,pw*0.22,0,Math.PI*2);c.fillStyle=s.skin;c.fill();
c.beginPath();c.ellipse(pw/2,ph*0.22,pw*0.26,ph*0.15,0,Math.PI,0);c.fillStyle=s.hair;c.fill();
c.fillStyle='#1a1a2a';
c.beginPath();c.arc(pw*0.42,ph*0.36,pw*0.035,0,Math.PI*2);c.fill();
c.beginPath();c.arc(pw*0.58,ph*0.36,pw*0.035,0,Math.PI*2);c.fill();
c.fillStyle='#fff';
c.beginPath();c.arc(pw*0.42,ph*0.355,pw*0.012,0,Math.PI*2);c.fill();
c.beginPath();c.arc(pw*0.58,ph*0.355,pw*0.012,0,Math.PI*2);c.fill();
c.strokeStyle='#5a4a3a';c.lineWidth=1.5;
c.beginPath();c.moveTo(pw*0.46,ph*0.42);c.lineTo(pw*0.5,ph*0.44);c.lineTo(pw*0.54,ph*0.42);c.stroke();
c.strokeStyle=s.id===state.killer?'#8a4a4a':'#6a5a4a';c.lineWidth=1.5;
c.beginPath();c.arc(pw/2,ph*0.5,pw*0.08,0.1,Math.PI-0.1);c.stroke();
if(s.id==='lady'){c.fillStyle='#f0f0e0';for(let i=0;i<7;i++){c.beginPath();c.arc(pw*0.35+i*pw*0.045,ph*0.58,pw*0.02,0,Math.PI*2);c.fill();}}
if(s.id==='gray'){c.strokeStyle='#8090a0';c.lineWidth=1.5;c.beginPath();c.ellipse(pw*0.42,ph*0.37,pw*0.06,ph*0.04,0,0,Math.PI*2);c.stroke();c.beginPath();c.ellipse(pw*0.58,ph*0.37,pw*0.06,ph*0.04,0,0,Math.PI*2);c.stroke();}
if(s.id==='blackwell'){c.strokeStyle='#5a4a3a';c.lineWidth=2;c.beginPath();c.moveTo(pw*0.42,ph*0.47);c.quadraticCurveTo(pw*0.5,ph*0.5,pw*0.58,ph*0.47);c.stroke();}
if(s.id==='james'){c.fillStyle='#fff';c.fillRect(pw*0.44,ph*0.56,pw*0.12,ph*0.02);}
if(s.id==='helena'){c.fillStyle='#c45a30';c.beginPath();c.moveTo(pw*0.3,ph*0.6);c.quadraticCurveTo(pw*0.5,ph*0.55,pw*0.7,ph*0.62);c.lineTo(pw*0.68,ph*0.65);c.quadraticCurveTo(pw*0.5,ph*0.58,pw*0.32,ph*0.63);c.fill();}
c.strokeStyle='#3a3a5a';c.lineWidth=2;c.strokeRect(0,0,pw,ph);
}
const BASE_QUESTIONS=[
{id:'alibi',text:'Where were you at 11:47 PM?',responses:{
lady:{i:'I was in my bedroom reading. James brought me chamomile tea around 11:30.',g:'I was... in my bedroom. I took a sleeping pill early. I heard nothing.'},
gray:{i:'In the library, reviewing my manuscript. The butler brought me brandy at 11:30.',g:'The library, of course. I was absorbed in my work. I don\'t recall seeing anyone.'},
chen:{i:'Organizing files in the study anteroom. I stepped out around 11:30 for tea.',g:'Filing papers in the anteroom. I stepped out briefly. When I came back, it was too late.'},
blackwell:{i:'In the kitchen having a nightcap. The cook had left so I helped myself.',g:'The kitchen. Having a nightcap. Alone, unfortunately.'},
james:{i:'In the foyer, sir. Securing the doors for the night, as is my final duty.',g:'Securing the house, as is my duty. I made my rounds... but may have missed the study.'},
helena:{i:'In the ballroom, sketching the chandelier by moonlight.',g:'In the ballroom. I was restless. Walking about. I went through the greenhouse for air.'}}},
{id:'relationship',text:'How did you know Lord Ashworth?',responses:{
lady:{i:'My husband of twenty years. We had troubles, but I cared for him.',g:'Twenty years of marriage. We were not always happy. But who is?'},
gray:{i:'Academic colleagues. We disagreed, but I respected his work. Mostly.',g:'Rivals. He sabotaged my career. But I wouldn\'t... I\'m not a violent man.'},
chen:{i:'His secretary for five years. Demanding but fair.',g:'Five years as his secretary. He trusted me with private affairs. Perhaps too much.'},
blackwell:{i:'Family physician for fifteen years. Gout and melancholy.',g:'Their doctor for years. He was a difficult, suspicious patient.'},
james:{i:'Thirty years of service. He was a complicated man.',g:'Thirty years. I gave this house my life. And received a dismissal letter.'},
helena:{i:'He commissioned a family portrait. I\'ve been here three weeks.',g:'He was my patron. Was. Until he decided I wasn\'t worth the investment.'}}},
{id:'unusual',text:'Did you notice anything unusual tonight?',responses:{
lady:{i:'The greenhouse door was open. I heard footsteps in the passage around 11.',g:'Nothing at all. A perfectly ordinary evening.'},
gray:{i:'Raised voices from the study around 11:30. Two people arguing.',g:'A door slammed somewhere. Around 11. I assumed it was the wind.'},
chen:{i:'Lord Ashworth seemed anxious at dinner. He kept glancing at someone.',g:'He received a letter that upset him greatly. I don\'t know the contents.'},
blackwell:{i:'The wine at dinner had an odd taste. I thought nothing of it then.',g:'Nothing out of the ordinary.'},
james:{i:'Someone used the servant\'s passage tonight. I found it unlatched.',g:'The house was quiet. I noticed nothing, detective.'},
helena:{i:'I saw a shadow near the study window from the ballroom.',g:'I was lost in my art. I notice very little when working.'}}}
];
const EVIDENCE_QUESTIONS={
torn_letter:{id:'ev_letter',text:'Can you explain this torn letter I found?',responses:{
lady:{i:'Estate planning letter from my solicitor. Perfectly normal.',g:'Where did you find that?! That was... I mean, I\'ve never seen it.'},
gray:{i:'That rejection from the Academy. Humiliating, but not worth killing over.',g:'That letter is out of context. Our disagreement was purely academic.'},
chen:{i:'I typed many of his letters. I can\'t account for every one.',g:'I don\'t know anything about that letter.'},
blackwell:{i:'Medical correspondence is confidential.',g:'That was supposed to be destroyed. How did he still have it?'},
james:{i:'I deliver mail, sir. I don\'t read it.',g:'A termination letter? Yes, I knew. But I would never harm the master.'},
helena:{i:'Everyone has debts. It doesn\'t make me a murderer.',g:'He promised to forgive the debt! He gave his word, then he...'}}},
fingerprints:{id:'ev_prints',text:'We found fingerprints on the murder weapon...',responses:{
lady:{i:'I\'ve never touched that letter opener. Check them.',g:'I may have handled it at some point. It\'s a household item.'},
gray:{i:'I haven\'t been in the study. My prints shouldn\'t be there.',g:'Many people must have touched that opener over the years.'},
chen:{i:'I use the opener for mail duties. My prints are routine.',g:'Of course my prints are there. I open mail daily. That proves nothing.'},
blackwell:{i:'I wear gloves out of habit. You won\'t find my prints.',g:'Gloves? Yes, I usually wear them. But one tore tonight.'},
james:{i:'I polish that opener weekly. My prints would be present.',g:'I polish everything in that study. The prints mean nothing.'},
helena:{i:'I\'ve never been to the study.',g:'Paint on my hands? I\'m an artist. It doesn\'t mean I...'}}},
diary_page:{id:'ev_diary',text:'Lord Ashworth wrote about you in his diary...',responses:{
lady:{i:'He wrote about everyone. I hope he said kind things.',g:'His diary? What did he write? I have a right to know.'},
gray:{i:'No doubt chronicling our debates. He enjoyed the sparring.',g:'He wrote about me? Our disagreement was professional, nothing more!'},
chen:{i:'I helped organize his journals. I can provide context.',g:'He had no right to write about my personal matters.'},
blackwell:{i:'Doctor-patient trust. I\'m sure his notes reflect that.',g:'What did he say about my practice? That\'s slander!'},
james:{i:'The master kept diaries. I never read them.',g:'He wrote about my dismissal? You understand why I was upset.'},
helena:{i:'I hope he captured my spirit on the page.',g:'Desperate? I wasn\'t desperate. I was explaining my situation.'}}},
financial_records:{id:'ev_finance',text:'These financial records are quite revealing...',responses:{
lady:{i:'Our finances are none of your concern.',g:'The insurance policy? Standard estate planning.'},
gray:{i:'I wouldn\'t know about family finances.',g:'He blocked my funding? That vindictive... but I didn\'t kill him.'},
chen:{i:'I manage household accounts. Everything is in order.',g:'Those records... I wasn\'t supposed to see those.'},
blackwell:{i:'I don\'t involve myself in financial affairs.',g:'That settlement was confidential! My career is finished if this gets out.'},
james:{i:'I\'m not privy to financial decisions.',g:'Cut from the will? After thirty years? He promised me that money.'},
helena:{i:'I owe money. Many artists do.',g:'Two hundred thousand pounds. To people who don\'t accept excuses.'}}},
muddy_prints:{id:'ev_mud',text:'Muddy footprints trail from the greenhouse...',responses:{
lady:{i:'I haven\'t been to the greenhouse. My shoes are clean.',g:'I may have stepped outside for air. It was stuffy.'},
gray:{i:'I went from library to foyer. Nowhere near the greenhouse.',g:'I took a brief walk through the garden. Is that a crime?'},
chen:{i:'I was in the study anteroom. No mud on my shoes.',g:'I may have gone to the greenhouse for air.'},
blackwell:{i:'Kitchen and greenhouse are on opposite ends.',g:'I checked medicinal herbs in the greenhouse. A doctor\'s habit.'},
james:{i:'I lock the greenhouse at 10 PM.',g:'I checked the greenhouse door. Part of my rounds.'},
helena:{i:'I was in the ballroom. I didn\'t go through it.',g:'I went through the greenhouse for air. Is walking a crime?'}}},
poison_bottle:{id:'ev_poison',text:'We found arsenic hidden in the kitchen...',responses:{
lady:{i:'We use it for rats in the cellar.',g:'That\'s rat poison. Every manor has it.'},
gray:{i:'I know nothing about poisons.',g:'Poison? I\'m a scholar, not a chemist.'},
chen:{i:'I ordered rat poison per Lord Ashworth\'s instructions.',g:'The poison was for rats. I ordered it. Hardly suspicious.'},
blackwell:{i:'As a physician, I recognize arsenic. Common for pest control.',g:'I\'m aware of its properties. Any doctor would be.'},
james:{i:'I store household chemicals. That bottle has been there months.',g:'It\'s pest control. Why is this relevant now?'},
helena:{i:'I wouldn\'t know arsenic from aspirin.',g:'I paint with cadmium and lead. I don\'t need... I know nothing about it.'}}}
};

function showDialogue(suspectId){
const s=SUSPECTS.find(x=>x.id===suspectId);if(!s)return;
state.phase='dialogue';state.currentSuspect=suspectId;
if(!state.suspectTalked[suspectId])state.suspectTalked[suspectId]=[];
const ov=$('overlay');ov.className='show';
let html='<button class="close-btn" onclick="closeOverlay()">X Close</button>';
html+='<div class="panel"><h2>Interrogating: '+s.name+'</h2>';
html+='<p style="color:#887755;margin-bottom:12px"><em>'+s.role+' ‚Äî Motive: '+s.motive+'</em></p>';
html+='<div style="display:flex;gap:16px"><div>';
const pcvs=document.createElement('canvas');pcvs.width=120;pcvs.height=160;
html+='<canvas id="dlg-portrait" width="120" height="160"></canvas></div><div id="dlg-content" style="flex:1">';
html+='<div id="dlg-response" style="min-height:60px;margin-bottom:12px;padding:10px;background:#0f0f1a;border-radius:4px;font-style:italic"></div>';
html+='<div id="dlg-questions"></div></div></div></div>';
ov.innerHTML=html;
const pc=document.getElementById('dlg-portrait');
if(pc)drawPortraitLarge(s,pc);
renderQuestions(suspectId);
}
function renderQuestions(sid){
const qDiv=document.getElementById('dlg-questions');if(!qDiv)return;
let html='<h3>Questions:</h3>';
BASE_QUESTIONS.forEach(q=>{
const used=state.dialogueUsed[sid+'_'+q.id];
html+='<button class="dlg-opt'+(used?' used':'')+'" onclick="askQuestion(\''+sid+'\',\''+q.id+'\',false)">'+q.text+'</button>';
});
const evKeys=Object.keys(EVIDENCE_QUESTIONS);
evKeys.forEach(ek=>{
if(hasClue(ek)){
const eq=EVIDENCE_QUESTIONS[ek];
const used=state.dialogueUsed[sid+'_'+eq.id];
html+='<button class="dlg-opt'+(used?' used':'')+'" style="border-left:3px solid #c4a265" onclick="askQuestion(\''+sid+'\',\''+ek+'\',true)">'+eq.text+'</button>';
}});
qDiv.innerHTML=html;
}
function askQuestion(sid,qid,isEvidence){
playClick();
const isKiller=sid===state.killer;
let response='';
if(isEvidence){
const eq=EVIDENCE_QUESTIONS[qid];
if(eq&&eq.responses[sid])response=isKiller?eq.responses[sid].g:eq.responses[sid].i;
state.dialogueUsed[sid+'_'+eq.id]=true;
addNote('Asked '+SUSPECTS.find(x=>x.id===sid).name+' about '+qid.replace(/_/g,' ')+': "'+response+'"');
}else{
const bq=BASE_QUESTIONS.find(q=>q.id===qid);
if(bq&&bq.responses[sid])response=isKiller?bq.responses[sid].g:bq.responses[sid].i;
state.dialogueUsed[sid+'_'+qid]=true;
addNote('Asked '+SUSPECTS.find(x=>x.id===sid).name+' '+bq.text.toLowerCase()+': "'+response+'"');
}
const rDiv=document.getElementById('dlg-response');
if(rDiv){rDiv.textContent='';let i=0;const typ=()=>{if(i<response.length){rDiv.textContent+=response[i|0];i++;setTimeout(typ,20);}};typ();}
if(!state.suspectTalked[sid])state.suspectTalked[sid]=[];
if(state.suspectTalked[sid].indexOf(qid)<0)state.suspectTalked[sid].push(qid);
save();
renderQuestions(sid);
}
function closeOverlay(){$('overlay').className='';state.phase='explore';render();}

function showNotebook(){
state.phase='notebook';
const ov=$('overlay');ov.className='show';
let html='<button class="close-btn" onclick="closeOverlay()">X Close</button>';
html+='<div class="panel"><h2>Detective\'s Notebook</h2>';
if(state.notebook.length===0)html+='<p style="color:#666">No notes yet. Examine clues and interrogate suspects.</p>';
else state.notebook.forEach((n,i)=>{html+='<div class="nb-entry"><b>#'+(i+1)+'</b> '+n+'</div>';});
html+='</div>';
html+='<div class="panel"><h2>Collected Evidence ('+state.clues.length+')</h2>';
if(state.clues.length===0)html+='<p style="color:#666">No clues found yet. Explore rooms and click on objects.</p>';
else state.clues.forEach(cid=>{
const c=CLUE_DEFS.find(x=>x.id===cid);
if(c)html+='<div style="padding:6px;margin:4px 0;background:#0f0f1a;border-radius:3px;border-left:3px solid #c4a265"><b>'+c.name+'</b><br><span style="font-size:12px;color:#887755">'+getClueDesc(c)+'</span></div>';
});
html+='</div>';
ov.innerHTML=html;
}
function showBoard(){
state.phase='board';
const ov=$('overlay');ov.className='show';
let html='<button class="close-btn" onclick="closeOverlay()">X Close</button>';
html+='<div class="panel"><h2>Evidence Board</h2>';
html+='<p style="font-size:12px;color:#887755;margin-bottom:10px">Click two clues to draw a connection. Correct connections glow green.</p>';
html+='<div id="board-clues" style="margin-bottom:10px">';
state.clues.forEach(cid=>{
const c=CLUE_DEFS.find(x=>x.id===cid);
const isConn=state.connections.some(cn=>cn[0]===cid||cn[1]===cid);
if(c)html+='<span class="clue-card'+(isConn?' connected':'')+'" data-cid="'+cid+'" onclick="boardSelect(\''+cid+'\')">'+c.name+'</span>';
});
html+='</div>';
html+='<div id="board-connections">';
if(state.connections.length>0){
html+='<h3>Connections:</h3>';
state.connections.forEach(cn=>{
const c1=CLUE_DEFS.find(x=>x.id===cn[0]),c2=CLUE_DEFS.find(x=>x.id===cn[1]);
const valid=isValidConnection(cn[0],cn[1]);
html+='<div style="padding:4px 8px;margin:2px 0;border-left:3px solid '+(valid?'#2a6e3f':'#555')+';color:'+(valid?'#8fbc8f':'#777')+';font-size:12px">'+
(c1?c1.name:'?')+' ‚Üî '+(c2?c2.name:'?')+(valid?' ‚úì Connected':'')+'</div>';
});
}
html+='</div></div>';
ov.innerHTML=html;
}
let boardSelection=null;
function boardSelect(cid){
playClick();
if(!boardSelection){boardSelection=cid;
document.querySelectorAll('.clue-card').forEach(el=>{if(el.dataset.cid===cid)el.classList.add('selected');});}
else{
if(boardSelection!==cid){
const exists=state.connections.some(cn=>(cn[0]===boardSelection&&cn[1]===cid)||(cn[0]===cid&&cn[1]===boardSelection));
if(!exists){state.connections.push([boardSelection,cid]);
const valid=isValidConnection(boardSelection,cid);
addNote('Connected: '+getClueNameById(boardSelection)+' ‚Üî '+getClueNameById(cid)+(valid?' (Significant!)':''));
save();}
}
boardSelection=null;showBoard();
}
}
function getClueNameById(id){const c=CLUE_DEFS.find(x=>x.id===id);return c?c.name:'Unknown';}
function isValidConnection(a,b){
return VALID_CONNECTIONS.some(vc=>(vc[0]===a&&vc[1]===b)||(vc[0]===b&&vc[1]===a));
}

function showAccuse(){
if(state.clues.length<3){typewrite('You need at least 3 pieces of evidence before making an accusation.');return;}
state.phase='accuse';
const ov=$('overlay');ov.className='show';
let html='<button class="close-btn" onclick="closeOverlay()">X Close</button>';
html+='<div class="panel"><h2>Make Your Accusation</h2>';
html+='<p>Choose the killer and present 3 key pieces of evidence.</p>';
html+='<h3>Select Suspect:</h3><div class="suspect-grid">';
SUSPECTS.forEach(s=>{
html+='<div class="suspect-card" id="ac-'+s.id+'" onclick="selectAccuseSuspect(\''+s.id+'\')">';
html+='<canvas width="80" height="100" id="ac-cvs-'+s.id+'"></canvas>';
html+='<div class="sname">'+s.name+'</div><div class="srole">'+s.role+'</div></div>';
});
html+='</div>';
html+='<h3>Select 3 Evidence Pieces:</h3><div class="evidence-sel" id="ev-sel">';
state.clues.forEach(cid=>{
const c=CLUE_DEFS.find(x=>x.id===cid);
if(c)html+='<div class="ev-pick" data-eid="'+cid+'" onclick="toggleEvidence(\''+cid+'\')">'+c.name+'</div>';
});
html+='</div>';
html+='<div style="text-align:center;margin-top:16px"><button onclick="submitAccusation()" style="background:#4a1a1a;color:#c4a265;border:2px solid #8a2020;padding:10px 24px;font:16px Georgia,serif;cursor:pointer;border-radius:4px">Submit Accusation</button></div>';
html+='</div>';
ov.innerHTML=html;
SUSPECTS.forEach(s=>{const c=document.getElementById('ac-cvs-'+s.id);if(c)drawPortraitLarge(s,c);});
state.accuseSuspect=null;state.accuseEvidence=[];
}
function selectAccuseSuspect(sid){
playClick();state.accuseSuspect=sid;
document.querySelectorAll('.suspect-card').forEach(el=>el.classList.remove('sel'));
const el=document.getElementById('ac-'+sid);if(el)el.classList.add('sel');
}
function toggleEvidence(eid){
playClick();
const idx=state.accuseEvidence.indexOf(eid);
if(idx>=0)state.accuseEvidence.splice(idx,1);
else if(state.accuseEvidence.length<3)state.accuseEvidence.push(eid);
document.querySelectorAll('.ev-pick').forEach(el=>{
el.classList.toggle('chosen',state.accuseEvidence.indexOf(el.dataset.eid)>=0);
});
}
function submitAccusation(){
if(!state.accuseSuspect){alert('Select a suspect!');return;}
if(state.accuseEvidence.length!==3){alert('Select exactly 3 pieces of evidence!');return;}
state.accused=true;
const correct=state.accuseSuspect===state.killer;
const keyEv=KEY_EVIDENCE[state.killer]||[];
const evMatch=state.accuseEvidence.filter(e=>keyEv.indexOf(e)>=0).length;
let rating='Failed Detective';let rColor='#8b2020';
if(correct){
if(state.clues.length>=state.totalClues-2&&state.hintsUsed===0){rating='Master Detective';rColor='#c4a265';}
else if(state.hintsUsed===0){rating='Inspector';rColor='#4a8a4a';}
else{rating='Amateur Sleuth';rColor='#8a8a4a';}
}
const killerS=SUSPECTS.find(x=>x.id===state.killer);
const ov=$('overlay');ov.className='show';
let html='<div class="panel result-box">';
if(correct){
html+='<h1 style="color:#4a8a4a">Case Solved!</h1>';
html+='<p>You correctly identified <b style="color:#c4a265">'+killerS.name+'</b> as the murderer.</p>';
html+='<p>'+killerS.name+' killed Lord Ashworth to '+killerS.motive.toLowerCase()+'.</p>';
html+='<p>Evidence matched: '+evMatch+'/3 key pieces</p>';
}else{
html+='<h1 style="color:#8b2020">Wrong Accusation!</h1>';
html+='<p>You accused the wrong person. The real killer was <b style="color:#c4a265">'+killerS.name+'</b>.</p>';
html+='<p>'+killerS.name+'\'s motive: '+killerS.motive+'</p>';
}
html+='<div class="rating" style="color:'+rColor+'">Rating: '+rating+'</div>';
html+='<p style="color:#666">Clues found: '+state.clues.length+'/'+state.totalClues+' | Hints used: '+state.hintsUsed+'</p>';
html+='<button onclick="newGame()">New Investigation</button>';
html+='</div>';
ov.innerHTML=html;
localStorage.removeItem('murder_save');
}
function newGame(){
localStorage.removeItem('murder_save');
initState(true);
closeOverlay();
buildSidebar();
goRoom('foyer');
typewrite('A new case begins. Lord Ashworth has been found dead in his study. Investigate the manor and find the killer.');
}

function useHint(){
if(state.hints<=0){typewrite('No hints remaining.');return;}
state.hints--;state.hintsUsed++;
$('hint-btn').textContent='Hints ('+state.hints+')';
const killer=SUSPECTS.find(x=>x.id===state.killer);
const innocents=SUSPECTS.filter(x=>x.id!==state.killer);
const uncollected=CLUE_DEFS.filter(c=>!hasClue(c.id));
let hint='';
if(state.hints===2){
const cleared=innocents[(Math.random()*innocents.length)|0];
hint='After careful analysis, you can rule out '+cleared.name+'. Their alibi checks out.';
addNote('HINT: '+cleared.name+' has been cleared.');
}else if(state.hints===1&&uncollected.length>0){
const missed=uncollected[(Math.random()*uncollected.length)|0];
hint='You sense something important in the '+ROOM_NAMES[missed.room]+'. Search more carefully there.';
addNote('HINT: Check the '+ROOM_NAMES[missed.room]+' more thoroughly.');
}else{
const keyEv=KEY_EVIDENCE[state.killer]||[];
const missing=keyEv.filter(e=>!hasClue(e));
if(missing.length>0){
const c=CLUE_DEFS.find(x=>x.id===missing[0]);
hint='A critical piece of evidence awaits in the '+ROOM_NAMES[c.room]+'.';
addNote('HINT: Key evidence in '+ROOM_NAMES[c.room]+'.');
}else{
hint='Review your evidence carefully. The killer\'s alibi has a significant gap.';
addNote('HINT: Focus on alibi inconsistencies.');
}
}
typewrite('HINT: '+hint);
save();
}
function goRoom(rid){
state.room=rid;
$('room-title').textContent=ROOM_NAMES[rid]||rid;
document.querySelectorAll('#room-nav .sb-btn').forEach(b=>{b.classList.toggle('active',b.dataset.room===rid);});
render();
const descs={foyer:'The grand foyer. A chandelier casts long shadows. Grandfather clock ticks steadily.',
study:'The study where Lord Ashworth was found. Blood on the carpet. The air is thick with dread.',
library:'Floor-to-ceiling bookshelves. The scent of old leather and pipe tobacco lingers.',
kitchen:'A large kitchen. Copper pots gleam. Something smells faintly of almonds.',
ballroom:'A vast ballroom. Moonlight streams through tall windows. The chandelier sways slightly.',
greenhouse:'Glass walls fogged with moisture. Exotic plants crowd the walkways. The door to the garden is ajar.',
bedroom:'The master bedroom. Silk curtains, a four-poster bed. A vanity with scattered papers.',
cellar:'Cool stone walls lined with wine racks. Cobwebs and dust. A draft from somewhere below.'};
typewrite(descs[rid]||'You enter the room.');
save();
}
function render(){
canvas=$('scene');ctx=canvas.getContext('2d');
const wrap=$('scene-wrap');
W=canvas.width=wrap.clientWidth;H=canvas.height=wrap.clientHeight;
drawRoom(state.room);
}
function buildSidebar(){
let rhtml='';
Object.keys(ROOM_NAMES).forEach(rid=>{
const hasS=SUSPECTS.find(s=>s.room===rid);
rhtml+='<button class="sb-btn'+(rid===state.room?' active':'')+(hasS?' has-suspect':'')+'" data-room="'+rid+'" onclick="goRoom(\''+rid+'\')">'+ROOM_NAMES[rid]+'</button>';
});
$('room-nav').innerHTML=rhtml;
let shtml='';
SUSPECTS.forEach(s=>{
shtml+='<button class="sb-btn" onclick="goRoom(\''+s.room+'\')" style="font-size:11px">'+s.name+'<br><span style="color:#666;font-size:10px">'+ROOM_NAMES[s.room]+'</span></button>';
});
$('suspect-nav').innerHTML=shtml;
updateClueCount();
$('hint-btn').textContent='Hints ('+state.hints+')';
}
function handleCanvasClick(e){
if(state.phase!=='explore')return;
const rect=canvas.getBoundingClientRect();
const mx=(e.clientX-rect.left)/rect.width;
const my=(e.clientY-rect.top)/rect.height;
const spots=getHotspots(state.room);
for(const h of spots){
if(mx>=h.x&&mx<=h.x+h.w&&my>=h.y&&my<=h.y+h.h){
playClick();
if(h.type==='clue'){
addClue(h.data.id);
const desc=getClueDesc(h.data);
typewrite('CLUE FOUND: '+h.data.name+' ‚Äî '+desc);
addNote('Found: '+h.data.name+' in '+ROOM_NAMES[state.room]+' ‚Äî '+desc);
render();
}else if(h.type==='suspect'){
showDialogue(h.data.id);
}
return;
}}
}
function handleCanvasMove(e){
const rect=canvas.getBoundingClientRect();
const mx=(e.clientX-rect.left)/rect.width;
const my=(e.clientY-rect.top)/rect.height;
const spots=getHotspots(state.room);
hoveredHot=null;
for(const h of spots){
if(mx>=h.x&&mx<=h.x+h.w&&my>=h.y&&my<=h.y+h.h){hoveredHot=h;break;}
}
canvas.style.cursor=hoveredHot?'pointer':'default';
render();
}

document.addEventListener('keydown',e=>{
if(e.key==='e'||e.key==='E'){if(state.phase==='explore')showBoard();}
if(e.key==='n'||e.key==='N'){if(state.phase==='explore')showNotebook();}
if(e.key==='Escape')closeOverlay();
});
window.addEventListener('resize',()=>{if(state&&state.room)render();});
window.startGame=function(){
$('start-screen').style.display='none';
$('game').style.display='flex';
const loaded=initState(false);
initAudio();
buildSidebar();
if(loaded){
goRoom(state.room);
typewrite('Investigation resumed. Continue exploring Ashworth Manor.');
}else{
goRoom('foyer');
typewrite('You arrive at Ashworth Manor on a stormy night. Lord Ashworth has been found dead in his study. The six guests are confined to the house. Begin your investigation.');
addNote('Case opened: Lord Ashworth found dead in the study. Time of death estimated around 11:47 PM.');
}
canvas=$('scene');
canvas.addEventListener('click',handleCanvasClick);
canvas.addEventListener('mousemove',handleCanvasMove);
save();
};
window.goRoom=goRoom;window.showDialogue=showDialogue;window.showNotebook=showNotebook;
window.showBoard=showBoard;window.showAccuse=showAccuse;window.useHint=useHint;
window.closeOverlay=closeOverlay;window.askQuestion=askQuestion;window.boardSelect=boardSelect;
window.selectAccuseSuspect=selectAccuseSuspect;window.toggleEvidence=toggleEvidence;
window.submitAccusation=submitAccusation;window.newGame=newGame;
})();
</script>
</body>
</html>
