<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Creature Arena</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a1a2e;color:#e0e0e0;font-family:'Segoe UI',sans-serif;overflow-x:hidden;min-height:100vh}
#app{max-width:800px;margin:0 auto;padding:8px}
h1{text-align:center;color:#e94560;font-size:1.5em;margin:8px 0;text-shadow:0 0 10px #e9456066}
.tabs{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;margin:8px 0}
.tab{padding:6px 12px;background:#16213e;border:1px solid #0f3460;border-radius:8px;cursor:pointer;font-size:.85em;color:#a0a0c0;transition:.2s}
.tab:hover,.tab.active{background:#0f3460;color:#e94560;border-color:#e94560}
.panel{display:none;animation:fadeIn .3s}
.panel.active{display:block}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
canvas{display:block;margin:0 auto;border-radius:12px;background:#0a0a1a;image-rendering:pixelated}
.stats-bar{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:8px 0}
.stat{background:#16213e;padding:4px 8px;border-radius:6px;font-size:.75em;text-align:center;min-width:70px}
.stat b{display:block;font-size:1.1em}
.stat .bar{height:4px;background:#333;border-radius:2px;margin-top:2px}
.stat .bar div{height:100%;border-radius:2px;transition:width .5s}
.food-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin:8px 0}
.food-btn{padding:10px 6px;border:2px solid #333;border-radius:8px;cursor:pointer;text-align:center;font-size:.8em;background:#16213e;color:#e0e0e0;transition:.2s}
.food-btn:hover{transform:scale(1.05);border-color:#e94560}
.food-btn:active{transform:scale(.95)}
.food-btn .emoji{font-size:1.5em;display:block}
.food-btn .count{font-size:.7em;color:#888}
.btn{padding:8px 16px;background:#e94560;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:.9em;transition:.2s;margin:4px}
.btn:hover{background:#c73e54;transform:scale(1.03)}
.btn:disabled{background:#444;cursor:default;transform:none}
.btn.sec{background:#0f3460}
.btn.sec:hover{background:#1a4a8a}
#battleCanvas{border:2px solid #e94560}
.hp-bar{height:12px;background:#333;border-radius:6px;overflow:hidden;margin:4px 0}
.hp-fill{height:100%;transition:width .4s;border-radius:6px}
.battle-log{background:#0a0a1a;border-radius:8px;padding:8px;max-height:120px;overflow-y:auto;font-size:.75em;margin:8px 0}
.battle-log p{margin:2px 0;padding:2px 4px;border-radius:4px}
.battle-log .dmg{color:#e94560}.battle-log .heal{color:#4ade80}.battle-log .info{color:#60a5fa}
.stable-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0}
.stable-slot{background:#16213e;border:2px solid #333;border-radius:10px;padding:8px;text-align:center;cursor:pointer;min-height:100px;transition:.2s}
.stable-slot:hover{border-color:#e94560}
.stable-slot.active{border-color:#4ade80;box-shadow:0 0 10px #4ade8044}
.stable-slot.empty{opacity:.4}
.catalog-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin:8px 0}
.cat-entry{background:#16213e;border-radius:6px;padding:4px;text-align:center;font-size:.65em}
.cat-entry.found{border:1px solid #4ade80}
.cat-entry.unknown{opacity:.3;filter:brightness(0)}
.mutation-list{display:flex;flex-wrap:wrap;gap:4px;margin:8px 0}
.mutation-tag{background:#2a1a3e;border:1px solid #8b5cf6;padding:2px 8px;border-radius:12px;font-size:.75em;color:#c4b5fd}
.flex-row{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
.tier-info{text-align:center;margin:8px 0;font-size:.9em;color:#fbbf24}
.reward-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a2e;border:2px solid #e94560;border-radius:16px;padding:24px;z-index:100;text-align:center;animation:popIn .3s}
@keyframes popIn{from{transform:translate(-50%,-50%) scale(0)}to{transform:translate(-50%,-50%) scale(1)}}
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#000a;z-index:99}
.breed-select{display:flex;gap:8px;justify-content:center;margin:8px 0}
.breed-slot{width:120px;height:120px;background:#16213e;border:2px dashed #555;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.8em;color:#666}
.breed-slot.sel{border-color:#e94560;border-style:solid}
.name-input{background:#16213e;border:1px solid #0f3460;color:#e0e0e0;padding:4px 8px;border-radius:6px;font-size:.9em;text-align:center;width:150px}
</style>
</head>
<body>
<div id="app">
<h1>üêâ Creature Arena</h1>
<div class="tabs" id="tabs"></div>
<div id="panels"></div>
</div>
<script>
(()=>{
"use strict";
const SAVE_KEY='creatureArena_v2';
const STAT_NAMES=['Speed','Strength','Defense','Intelligence','Luck'];
const STAT_COLORS=['#3b82f6','#ef4444','#22c55e','#a855f7','#eab308'];
const FOODS=[
{name:'Red Meat',emoji:'ü•©',stat:1,color:'#ef4444'},
{name:'Blue Fish',emoji:'üêü',stat:0,color:'#3b82f6'},
{name:'Green Herbs',emoji:'üåø',stat:2,color:'#22c55e'},
{name:'Golden Nectar',emoji:'üçØ',stat:3,color:'#eab308'},
{name:'Purple Shroom',emoji:'üçÑ',stat:4,color:'#a855f7'},
{name:'Rainbow Fruit',emoji:'üåà',stat:-1,color:'#ec4899'}
];
const MUTATIONS=[
{id:'fire',name:'Fire Breath',desc:'+3 ATK, burn chance',color:'#f97316',emoji:'üî•'},
{id:'ice',name:'Ice Armor',desc:'+3 DEF, freeze chance',color:'#38bdf8',emoji:'‚ùÑÔ∏è'},
{id:'tele',name:'Teleport',desc:'+3 SPD, dodge boost',color:'#c084fc',emoji:'‚ö°'},
{id:'regen',name:'Regeneration',desc:'Heal 5% HP/turn',color:'#4ade80',emoji:'üíö'},
{id:'poison',name:'Poison Touch',desc:'Poison on hit',color:'#a3e635',emoji:'‚ò†Ô∏è'},
{id:'psychic',name:'Psychic',desc:'+3 INT, confuse chance',color:'#e879f9',emoji:'üîÆ'},
{id:'lucky',name:'Lucky Star',desc:'+3 LCK, crit boost',color:'#fbbf24',emoji:'‚≠ê'},
{id:'shadow',name:'Shadow Cloak',desc:'Evasion boost',color:'#6b7280',emoji:'üåë'}
];
const TIER_NAMES=['Slime Pit','Grassy Field','Dark Cave','Frozen Lake','Volcano','Sky Temple','Deep Abyss','Crystal Peak','Shadow Realm','Dragon Throne'];
let G={stable:[],activeIdx:0,food:[5,5,5,5,5,5],tier:0,wins:0,catalog:{},prestige:0};
const AC=new(window.AudioContext||window.webkitAudioContext)();
function sfx(freq,dur,type,vol){
try{if(AC.state==='suspended')AC.resume();
const o=AC.createOscillator(),g=AC.createGain();
o.type=type||'square';o.frequency.setValueAtTime(freq,AC.currentTime);
g.gain.setValueAtTime((vol||.15),AC.currentTime);
g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+dur);
o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+dur);
}catch(e){}
}
function sfxEat(){sfx(400,.08,'sine');setTimeout(()=>sfx(600,.08,'sine'),80)}
function sfxHit(){sfx(150,.15,'sawtooth',.2);sfx(80,.1,'square',.1)}
function sfxLvl(){[523,659,784].forEach((f,i)=>setTimeout(()=>sfx(f,.2,'sine',.15),i*120))}
function sfxEvolve(){[392,523,659,784,1047].forEach((f,i)=>setTimeout(()=>sfx(f,.25,'sine',.12),i*150))}
function sfxWin(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>sfx(f,.3,'triangle',.15),i*150))}

function rng(a,b){return a+((Math.random()*(b-a+1))|0)}
function pick(arr){return arr[rng(0,arr.length-1)]}
function clamp(v,lo,hi){return v<lo?lo:v>hi?hi:v}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6)}

function makeCreature(name,stats,seed){
const s=seed||Math.random()*99999;
const hue=((s*137.5)%360)|0;
const bumps=3+((s*7)%5)|0;
const bodyW=.9+((s*3)%6)*.05;
const bodyH=.9+((s*11)%6)*.05;
const eyeSize=.06+((s*13)%5)*.01;
const mouthW=.1+((s*17)%4)*.03;
return{
id:uid(),name:name||'Blobby',
stats:stats||STAT_NAMES.map(()=>rng(3,8)),
seed:s,hue,bumps,bodyW,bodyH,eyeSize,mouthW,
mutations:[],generation:0,xp:0,wins:0,
parentA:null,parentB:null
};
}

function maxHP(c){return 50+c.stats[1]*3+c.stats[2]*4+(c.generation*5)}

function drawCreature(ctx,c,cx,cy,sz,anim){
anim=anim||{};
const t=anim.t||0;
const shake=anim.shake||0;
const glow=anim.glow||0;
const flash=anim.flash||0;
const sx=cx+(shake?Math.sin(t*30)*shake:0);
const sy=cy;
const s=c.stats;
const h=c.hue;
ctx.save();
ctx.translate(sx,sy);
if(glow>0){
ctx.shadowColor=`hsl(${h},80%,60%)`;
ctx.shadowBlur=glow*20;
}
// Luck aura
if(s[4]>8){
const pCount=s[4]>15?12:6;
for(let i=0;i<pCount;i++){
const a=(t*.5+i/pCount)*Math.PI*2;
const r=sz*.6+Math.sin(t*2+i)*sz*.1;
const px=Math.cos(a)*r,py=Math.sin(a)*r;
ctx.globalAlpha=.3+Math.sin(t*3+i)*.2;
ctx.fillStyle=s[4]>15?'#fbbf24':'#eab30088';
ctx.beginPath();
if(s[4]>15){drawStar(ctx,px,py,4,2);} 
else{ctx.arc(px,py,2,0,Math.PI*2);}
ctx.fill();
}
ctx.globalAlpha=1;
}
// Body
const bw=sz*c.bodyW*(s[1]>8?1+s[1]*.01:1);
const bh=sz*c.bodyH*(s[0]>15?.85:1);
// Defense shell
if(s[2]>8){
ctx.fillStyle=`hsl(${h},20%,35%)`;
ctx.beginPath();
ctx.ellipse(0,-bh*.05,bw*.55+4,bh*.55+4,0,0,Math.PI*2);
ctx.fill();
if(s[2]>15){
for(let i=0;i<8;i++){
const a=i/8*Math.PI*2;
const spx=Math.cos(a)*(bw*.55+6);
const spy=Math.sin(a)*(bh*.55+6);
ctx.fillStyle=`hsl(${h},25%,40%)`;
ctx.beginPath();
ctx.moveTo(spx,spy);
ctx.lineTo(spx+Math.cos(a)*8,spy+Math.sin(a)*8);
ctx.lineTo(spx+Math.cos(a+.3)*4,spy+Math.sin(a+.3)*4);
ctx.fill();
}
}
}
// Main body
const grad=ctx.createRadialGradient(0,-bh*.15,0,0,0,bw*.5);
grad.addColorStop(0,`hsl(${h},70%,55%)`);
grad.addColorStop(1,`hsl(${h},60%,35%)`);
ctx.fillStyle=flash>0?'#fff':grad;
ctx.beginPath();
for(let i=0;i<=60;i++){
const a=i/60*Math.PI*2;
let r=1+Math.sin(a*c.bumps)*.08;
ctx.lineTo(Math.cos(a)*bw*.45*r,Math.sin(a)*bh*.45*r);
}
ctx.closePath();ctx.fill();
// Pattern dots
for(let i=0;i<5;i++){
const px=(Math.sin(c.seed+i*2.5))*bw*.25;
const py=(Math.cos(c.seed+i*3.1))*bh*.2;
ctx.fillStyle=`hsla(${(h+30)%360},60%,50%,.3)`;
ctx.beginPath();ctx.arc(px,py,sz*.04,0,Math.PI*2);ctx.fill();
}
// Legs
const legLen=s[0]>8?sz*.2+(s[0]-8)*1.5:sz*.1;
const legW=s[1]>8?4:2;
ctx.strokeStyle=`hsl(${h},50%,40%)`;ctx.lineWidth=legW;
for(let side=-1;side<=1;side+=2){
const lx=side*bw*.25;
const bounce=Math.sin(t*4+side)*.05*sz;
ctx.beginPath();ctx.moveTo(lx,bh*.3);ctx.lineTo(lx+side*sz*.1,bh*.3+legLen+bounce);ctx.stroke();
}
// Arms (strength)
if(s[1]>8){
const armW=2+((s[1]-8)*.4)|0;
ctx.lineWidth=armW;
for(let side=-1;side<=1;side+=2){
const ax=side*bw*.4;
const armLen=sz*.15+s[1];
ctx.beginPath();ctx.moveTo(ax,-bh*.05);
ctx.lineTo(ax+side*armLen,-bh*.1+Math.sin(t*3)*5);ctx.stroke();
if(s[1]>15){
ctx.fillStyle=`hsl(${h},50%,40%)`;
ctx.beginPath();ctx.arc(ax+side*armLen,-bh*.1,4,0,Math.PI*2);ctx.fill();
}
}
}
// Wings (speed>15)
if(s[0]>15){
ctx.fillStyle=`hsla(${(h+60)%360},60%,60%,.5)`;
const wingFlap=Math.sin(t*6)*.3;
for(let side=-1;side<=1;side+=2){
ctx.save();ctx.scale(side,1);
ctx.beginPath();ctx.moveTo(bw*.2,-bh*.2);
ctx.quadraticCurveTo(bw*.6+10,-bh*.5-20-wingFlap*30,bw*.15,-bh*.35);
ctx.fill();ctx.restore();
}
}
// Horns (strength>15)
if(s[1]>15){
ctx.fillStyle=`hsl(${(h+180)%360},40%,50%)`;
for(let side=-1;side<=1;side+=2){
ctx.beginPath();
ctx.moveTo(side*bw*.15,-bh*.4);
ctx.lineTo(side*bw*.25,-bh*.65);
ctx.lineTo(side*bw*.05,-bh*.42);
ctx.fill();
}
}
// Head area
const headScale=s[3]>8?1+(s[3]-8)*.02:1;
ctx.save();ctx.scale(headScale,headScale);
// Eyes
const ey=-bh*.15;const ex=bw*.12;
const eSize=sz*c.eyeSize*(s[3]>8?1.3:1);
for(let side=-1;side<=1;side+=2){
// Eye white
ctx.fillStyle=s[3]>8?`hsl(${(h+120)%360},80%,70%)`:'#fff';
ctx.beginPath();ctx.arc(side*ex,ey,eSize,0,Math.PI*2);ctx.fill();
// Pupil
ctx.fillStyle='#111';
ctx.beginPath();ctx.arc(side*ex+1,ey+1,eSize*.5,0,Math.PI*2);ctx.fill();
ctx.fillStyle='#fff';
ctx.beginPath();ctx.arc(side*ex+eSize*.25,ey-eSize*.2,eSize*.2,0,Math.PI*2);ctx.fill();
}
// Third eye (int>15)
if(s[3]>15){
ctx.fillStyle='#e879f9';
ctx.beginPath();ctx.arc(0,ey-eSize*2.5,eSize*.8,0,Math.PI*2);ctx.fill();
ctx.fillStyle='#fff';
ctx.beginPath();ctx.arc(0,ey-eSize*2.5,eSize*.3,0,Math.PI*2);ctx.fill();
}
// Mouth
ctx.strokeStyle='#333';ctx.lineWidth=2;
const mw=sz*c.mouthW;
ctx.beginPath();
ctx.arc(0,ey+eSize*2.5,mw,0,Math.PI);
ctx.stroke();
ctx.restore();
// Mutation visuals
c.mutations.forEach(mid=>{
const m=MUTATIONS.find(x=>x.id===mid);
if(!m)return;
if(mid==='fire'){
ctx.fillStyle='#f9731688';
for(let i=0;i<3;i++){
const fx=bw*.15*Math.sin(t*5+i*2);
const fy=-bh*.5-10-i*5-Math.sin(t*8+i)*5;
ctx.beginPath();ctx.arc(fx,fy,4+i,0,Math.PI*2);ctx.fill();
}
}
if(mid==='ice'){
ctx.strokeStyle='#38bdf866';ctx.lineWidth=3;
ctx.beginPath();ctx.arc(0,0,bw*.5+8,0,Math.PI*2);ctx.stroke();
}
if(mid==='poison'){
ctx.fillStyle='#a3e63544';
for(let i=0;i<4;i++){
const a=t+i*1.5;
ctx.beginPath();ctx.arc(Math.cos(a)*bw*.4,bh*.35+Math.sin(a*2)*3,3,0,Math.PI*2);ctx.fill();
}
}
if(mid==='shadow'){ctx.globalAlpha=.7+Math.sin(t*4)*.15;}
});
// Luck golden glow
if(s[4]>15){
ctx.shadowColor='#fbbf24';ctx.shadowBlur=15+Math.sin(t*3)*5;
}
ctx.restore();
}

function drawStar(ctx,x,y,r1,r2){
ctx.beginPath();
for(let i=0;i<10;i++){
const a=i/10*Math.PI*2-Math.PI/2;
const r=i%2===0?r1:r2;
ctx.lineTo(x+Math.cos(a)*r,y+Math.sin(a)*r);
}
ctx.closePath();
}

// UI
const $=id=>document.getElementById(id);
const TAB_IDS=['home','feed','battle','stable','breed','catalog'];
const TAB_NAMES=['üè† Home','üçñ Feed','‚öîÔ∏è Battle','üè† Stable','üß¨ Breed','üìñ Catalog'];

function init(){
load();
if(!G.stable.length){
G.stable.push(makeCreature('Blobby'));
G.activeIdx=0;
}
buildUI();
save();
}

function buildUI(){
const tabs=$('tabs');const panels=$('panels');
tabs.innerHTML='';panels.innerHTML='';
TAB_IDS.forEach((id,i)=>{
const t=document.createElement('div');
t.className='tab'+(i===0?' active':'');
t.textContent=TAB_NAMES[i];
t.onclick=()=>switchTab(id);
t.id='tab_'+id;
tabs.appendChild(t);
const p=document.createElement('div');
p.className='panel'+(i===0?' active':'');
p.id='panel_'+id;
panels.appendChild(p);
});
renderHome();renderFeed();renderBattle();renderStable();renderBreed();renderCatalog();
}

function switchTab(id){
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
$('tab_'+id).classList.add('active');
$('panel_'+id).classList.add('active');
if(id==='home')renderHome();
if(id==='feed')renderFeed();
if(id==='stable')renderStable();
if(id==='breed')renderBreed();
if(id==='catalog')renderCatalog();
}

function active(){return G.stable[G.activeIdx]||null}

function renderHome(){
const p=$('panel_home');const c=active();
if(!c){p.innerHTML='<p>No creature! Go to Stable.</p>';return;}
p.innerHTML=`
<div style="text-align:center;margin:4px 0">
<input class="name-input" value="${c.name}" maxlength="16" id="cname">
<span style="font-size:.7em;color:#888">Gen ${c.generation} | Wins: ${c.wins} | Prestige: ${G.prestige}</span>
</div>
<canvas id="homeCanvas" width="240" height="240"></canvas>
<div class="stats-bar" id="homeStats"></div>
<div class="mutation-list" id="homeMuts"></div>`;
$('cname').onchange=e=>{c.name=e.target.value.slice(0,16);save()};
renderStats('homeStats',c);
renderMutations('homeMuts',c);
const cv=$('homeCanvas');const ctx=cv.getContext('2d');
let t=0;
const draw=()=>{ctx.clearRect(0,0,240,240);drawCreature(ctx,c,120,130,200,{t});t+=.016;requestAnimationFrame(draw)};
draw();
updateCatalog(c);
}

function renderStats(elId,c){
const el=$(elId);el.innerHTML='';
STAT_NAMES.forEach((n,i)=>{
const v=c.stats[i];
el.innerHTML+=`<div class="stat"><span style="color:${STAT_COLORS[i]}">${n}</span><b>${v}</b><div class="bar"><div style="width:${v*5}%;background:${STAT_COLORS[i]}"></div></div></div>`;
});
}

function renderMutations(elId,c){
const el=$(elId);el.innerHTML='';
if(!c.mutations.length){el.innerHTML='<span style="font-size:.75em;color:#666">No mutations yet</span>';return;}
c.mutations.forEach(mid=>{
const m=MUTATIONS.find(x=>x.id===mid);
if(m)el.innerHTML+=`<span class="mutation-tag">${m.emoji} ${m.name}</span>`;
});
}

function renderFeed(){
const p=$('panel_feed');const c=active();
if(!c){p.innerHTML='<p>No active creature</p>';return;}
p.innerHTML=`<canvas id="feedCanvas" width="200" height="200"></canvas>
<div class="stats-bar" id="feedStats"></div>
<div class="food-grid" id="foodGrid"></div>`;
renderStats('feedStats',c);
const fg=$('foodGrid');
FOODS.forEach((f,i)=>{
fg.innerHTML+=`<div class="food-btn" id="food_${i}" style="border-color:${f.color}40">
<span class="emoji">${f.emoji}</span>${f.name}<br><span class="count">x${G.food[i]}</span></div>`;
});
FOODS.forEach((f,i)=>{
$('food_'+i).onclick=()=>feedCreature(i);
});
const cv=$('feedCanvas');const ctx=cv.getContext('2d');
let t=0;
const draw=()=>{ctx.clearRect(0,0,200,200);drawCreature(ctx,c,100,110,160,{t});t+=.016;requestAnimationFrame(draw)};
draw();
}

function feedCreature(fi){
const c=active();if(!c||G.food[fi]<=0)return;
G.food[fi]--;
const f=FOODS[fi];
const si=f.stat===-1?rng(0,4):f.stat;
const oldVal=c.stats[si];
const amt=1;
c.stats[si]=clamp(c.stats[si]+amt,1,20);
sfxEat();
if((oldVal<=8&&c.stats[si]>8)||(oldVal<=15&&c.stats[si]>15)){
showEvolution(c,si);
}
c.xp+=1;
save();renderFeed();updateCatalog(c);
}

function showEvolution(c,si){
sfxEvolve();
const overlay=document.createElement('div');overlay.className='overlay';
const popup=document.createElement('div');popup.className='reward-popup';
popup.innerHTML=`<h3 style="color:#e94560">‚ú® EVOLUTION! ‚ú®</h3>
<p style="margin:8px 0">${c.name}'s ${STAT_NAMES[si]} reached ${c.stats[si]}!</p>
<canvas id="evoCanvas" width="200" height="200"></canvas>
<p style="font-size:.8em;color:#888;margin:4px 0">New features unlocked!</p>
<button class="btn" id="evoClose">Amazing!</button>`;
document.body.appendChild(overlay);document.body.appendChild(popup);
const cv=$('evoCanvas');const ctx=cv.getContext('2d');
let t=0;
const draw=()=>{
if(!document.body.contains(cv))return;
ctx.clearRect(0,0,200,200);
drawCreature(ctx,c,100,110,160,{t,glow:Math.sin(t*3)*.5+.5});
t+=.016;requestAnimationFrame(draw);
};draw();
$('evoClose').onclick=()=>{overlay.remove();popup.remove()};
}

// BATTLE
let battleState=null;
function renderBattle(){
const p=$('panel_battle');const c=active();
if(!c){p.innerHTML='<p>No active creature</p>';return;}
p.innerHTML=`<div class="tier-info">‚öîÔ∏è Tier ${G.tier+1}: ${TIER_NAMES[G.tier]} (Win ${G.wins}/${3+G.tier})</div>
<canvas id="battleCanvas" width="360" height="200"></canvas>
<div class="flex-row"><div style="flex:1"><b style="color:#4ade80">${c.name}</b><div class="hp-bar"><div class="hp-fill" id="hpA" style="width:100%;background:#4ade80"></div></div></div>
<div style="flex:1;text-align:right"><b style="color:#ef4444" id="enemyName">???</b><div class="hp-bar"><div class="hp-fill" id="hpB" style="width:100%;background:#ef4444"></div></div></div></div>
<div class="battle-log" id="battleLog"></div>
<div class="flex-row" id="battleBtns">
<button class="btn" onclick="window._startBattle()">‚öîÔ∏è Fight!</button></div>`;
}

window._startBattle=()=>{
const c=active();if(!c)return;
const diff=G.tier;
const eStats=STAT_NAMES.map(()=>clamp(rng(3+diff*2,8+diff*2),1,20));
const enemy=makeCreature(pick(['Gnarltooth','Venomaw','Darkscale','Ironhide','Swiftclaw','Blazefang','Frostbite','Stormwing','Shadowmane','Hexclaw']),eStats);
if(diff>=5)enemy.mutations.push(pick(MUTATIONS).id);
if(diff>=8)enemy.mutations.push(pick(MUTATIONS).id);
$('enemyName').textContent=enemy.name;
const aHP=maxHP(c),bHP=maxHP(enemy);
battleState={a:c,b:enemy,aHP,bHP,aMax:aHP,bMax:bHP,turn:0,done:false,log:[],anims:{aShake:0,bShake:0,aFlash:0,bFlash:0}};
$('battleBtns').innerHTML='<p style="font-size:.8em;color:#888">Battle in progress...</p>';
runBattle();
};

function runBattle(){
if(!battleState||battleState.done)return;
const bs=battleState;const a=bs.a,b=bs.b;
bs.turn++;
// Determine actions
const aAct=chooseAction(a);const bAct=chooseAction(b);
// Speed determines who goes first
const aFirst=a.stats[0]+(aAct==='quick'?5:0)+rng(0,3) >= b.stats[0]+(bAct==='quick'?5:0)+rng(0,3);
const order=aFirst?[['a','b',aAct],['b','a',bAct]]:[['b','a',bAct],['a','b',aAct]];
order.forEach(([atk,def,act])=>{
if(bs.done)return;
const attacker=atk==='a'?a:b;const defender=def==='a'?a:b;
const result=resolveAction(attacker,defender,act);
if(def==='a')bs.aHP=clamp(bs.aHP-result.dmg,0,bs.aMax);
else bs.bHP=clamp(bs.bHP-result.dmg,0,bs.bMax);
if(atk==='a')bs.aHP=clamp(bs.aHP+result.heal,0,bs.aMax);
else bs.bHP=clamp(bs.bHP+result.heal,0,bs.bMax);
if(result.dmg>0){
if(def==='a'){bs.anims.aShake=5;bs.anims.aFlash=3;}
else{bs.anims.bShake=5;bs.anims.bFlash=3;}
sfxHit();
}
bs.log.push({who:attacker.name,text:result.text,type:result.dmg>0?'dmg':result.heal>0?'heal':'info'});
if(bs.aHP<=0||bs.bHP<=0)bs.done=true;
});
// Regen mutation
if(a.mutations.includes('regen'))bs.aHP=clamp(bs.aHP+((bs.aMax*.05)|0),0,bs.aMax);
if(b.mutations.includes('regen'))bs.bHP=clamp(bs.bHP+((bs.bMax*.05)|0),0,bs.bMax);
updateBattleUI();
if(bs.done){
setTimeout(()=>endBattle(),600);
}else{
setTimeout(()=>runBattle(),900);
}
}

function chooseAction(c){
const r=Math.random();const s=c.stats;
const best=s.indexOf(Math.max(...s));
if(best===0&&r<.4)return'quick';
if(best===1&&r<.4)return'attack';
if(best===3&&r<.3)return'special';
if(best===4&&r<.3)return'dodge';
return pick(['attack','quick','special','dodge']);
}

function resolveAction(atk,def,act){
const aS=atk.stats,dS=def.stats;
let dmg=0,heal=0,text='';
const hasFire=atk.mutations.includes('fire');
const hasIce=def.mutations.includes('ice');
const hasPoison=atk.mutations.includes('poison');
const hasPsychic=atk.mutations.includes('psychic');
const hasShadow=def.mutations.includes('shadow');
const luckBonus=atk.mutations.includes('lucky')?2:0;
const crit=rng(1,20)<=aS[4]+luckBonus;
if(act==='attack'){
dmg=Math.max(1,aS[1]*2-dS[2]+rng(-2,2));
if(crit){dmg=((dmg*1.5)|0);text=`${atk.name} CRITS for ${dmg}!`;}
else text=`${atk.name} attacks for ${dmg}`;
if(hasFire){dmg+=3;text+=' üî•';}
if(hasIce)dmg=Math.max(1,dmg-2);
}else if(act==='quick'){
const evade=hasShadow?dS[4]+3:dS[4];
if(rng(1,20)<=evade){text=`${def.name} dodges ${atk.name}'s quick strike!`;dmg=0;}
else{dmg=Math.max(1,aS[0]+rng(0,aS[1])-((dS[2]*.5)|0));
text=`${atk.name} quick strikes for ${dmg}`;}
}else if(act==='special'){
const power=aS[3]*2+rng(0,5);
const eff=rng(0,2);
if(eff===0){dmg=Math.max(1,power-dS[2]);text=`${atk.name} mind blasts for ${dmg}`;}
else if(eff===1){heal=((power*.5)|0);text=`${atk.name} heals for ${heal}`;}
else{dmg=Math.max(1,((power*.7)|0));text=`${atk.name} confuses foe for ${dmg}`;
if(hasPsychic){dmg+=3;text+=' üîÆ';}}
}else{
if(rng(1,20)<=aS[4]+5+luckBonus){text=`${atk.name} dodges gracefully!`;dmg=0;}
else{text=`${atk.name} fails to dodge`;dmg=0;}
}
if(hasPoison&&dmg>0){dmg+=2;text+=' ‚ò†Ô∏è';}
return{dmg,heal,text};
}

function updateBattleUI(){
const bs=battleState;if(!bs)return;
$('hpA').style.width=(bs.aHP/bs.aMax*100)+'%';
$('hpB').style.width=(bs.bHP/bs.bMax*100)+'%';
const log=$('battleLog');
log.innerHTML='';
bs.log.slice(-8).forEach(l=>{
log.innerHTML+=`<p class="${l.type}">${l.text}</p>`;
});
log.scrollTop=log.scrollHeight;
// Battle canvas
const cv=$('battleCanvas');if(!cv)return;
const ctx=cv.getContext('2d');
let t=performance.now()/1000;
ctx.clearRect(0,0,360,200);
// Ground
ctx.fillStyle='#1a1a2e';ctx.fillRect(0,0,360,200);
ctx.fillStyle='#16213e';ctx.fillRect(0,150,360,50);
drawCreature(ctx,bs.a,100,120,140,{t,shake:bs.anims.aShake,flash:bs.anims.aFlash});
drawCreature(ctx,bs.b,260,120,140,{t,shake:bs.anims.bShake,flash:bs.anims.bFlash});
bs.anims.aShake*=.85;bs.anims.bShake*=.85;
bs.anims.aFlash*=.8;bs.anims.bFlash*=.8;
}

function endBattle(){
const bs=battleState;
const won=bs.aHP>0;
if(won){
sfxWin();
bs.a.wins++;G.wins++;
const foodReward=FOODS.map(()=>rng(0,2));
foodReward.forEach((v,i)=>G.food[i]+=v);
let mutReward=null;
if(Math.random()<.15+G.tier*.03){
const avail=MUTATIONS.filter(m=>!bs.a.mutations.includes(m.id));
if(avail.length){mutReward=pick(avail);bs.a.mutations.push(mutReward.id);}
}
if(G.wins>=(3+G.tier)){
if(G.tier<9){G.tier++;G.wins=0;}
else{G.prestige++;G.tier=0;G.wins=0;}
}
showReward(won,foodReward,mutReward);
}else{
G.food.forEach((v,i)=>G.food[i]+=1);
showReward(won,[1,1,1,1,1,1],null);
}
save();updateCatalog(bs.a);
}

function showReward(won,food,mut){
const overlay=document.createElement('div');overlay.className='overlay';
const popup=document.createElement('div');popup.className='reward-popup';
let html=`<h3 style="color:${won?'#4ade80':'#ef4444'}">${won?'üéâ Victory!':'üíÄ Defeated'}</h3>`;
html+='<p style="margin:8px 0">Rewards:</p><div class="food-grid" style="max-width:250px;margin:0 auto">';
FOODS.forEach((f,i)=>{if(food[i]>0)html+=`<div style="padding:4px;text-align:center">${f.emoji} x${food[i]}</div>`;});
html+='</div>';
if(mut)html+=`<p style="margin:8px 0;color:#c4b5fd">üß¨ Mutation: ${mut.emoji} ${mut.name}!</p>`;
html+=`<button class="btn" id="rewardClose">Continue</button>`;
popup.innerHTML=html;
document.body.appendChild(overlay);document.body.appendChild(popup);
$('rewardClose').onclick=()=>{overlay.remove();popup.remove();renderBattle()};
}

// STABLE
function renderStable(){
const p=$('panel_stable');
let html='<h3 style="text-align:center;margin:4px 0">Creature Stable</h3><div class="stable-grid">';
for(let i=0;i<6;i++){
const c=G.stable[i];
const isActive=i===G.activeIdx;
if(c){
html+=`<div class="stable-slot${isActive?' active':''}" id="slot_${i}">
<canvas width="80" height="80" id="slotC_${i}"></canvas>
<div style="font-size:.75em">${c.name}</div>
<div style="font-size:.6em;color:#888">Gen ${c.generation}</div>
</div>`;
}else{
html+=`<div class="stable-slot empty" id="slot_${i}"><span>Empty</span></div>`;
}
}
html+='</div><div class="flex-row"><button class="btn sec" id="newCreatureBtn">+ New Creature</button></div>';
p.innerHTML=html;
for(let i=0;i<6;i++){
const el=$('slot_'+i);
el.onclick=()=>{
if(G.stable[i]){G.activeIdx=i;save();renderStable();renderHome();}
};
const cv=$('slotC_'+i);
if(cv&&G.stable[i]){
const ctx=cv.getContext('2d');
drawCreature(ctx,G.stable[i],40,45,70,{t:0});
}
}
$('newCreatureBtn').onclick=()=>{
if(G.stable.length>=6){alert('Stable full!');return;}
const name='Creature'+(G.stable.length+1);
G.stable.push(makeCreature(name));
save();renderStable();
};
}

// BREED
function renderBreed(){
const p=$('panel_breed');
if(G.stable.length<2){p.innerHTML='<p style="text-align:center">Need 2+ creatures to breed</p>';return;}
let html='<h3 style="text-align:center;margin:4px 0">üß¨ Breeding Lab</h3>';
html+='<p style="text-align:center;font-size:.8em;color:#888">Select two parents</p>';
html+='<div class="breed-select" id="breedParents">';
G.stable.forEach((c,i)=>{
html+=`<div class="stable-slot" style="width:100px;min-height:80px;padding:4px" id="bp_${i}">
<canvas width="60" height="60" id="bpc_${i}"></canvas>
<div style="font-size:.65em">${c.name}</div></div>`;
});
html+='</div>';
html+='<div class="flex-row"><button class="btn" id="breedBtn" disabled>üß¨ Breed!</button></div>';
html+='<div id="breedResult"></div>';
p.innerHTML=html;
let sel=[];
G.stable.forEach((c,i)=>{
const cv=$('bpc_'+i);if(cv){drawCreature(cv.getContext('2d'),c,30,35,50,{t:0});}
$('bp_'+i).onclick=()=>{
if(sel.includes(i))sel=sel.filter(x=>x!==i);
else if(sel.length<2)sel.push(i);
G.stable.forEach((_,j)=>{$('bp_'+j).style.borderColor=sel.includes(j)?'#e94560':'#333';});
$('breedBtn').disabled=sel.length!==2;
};
});
$('breedBtn').onclick=()=>{
if(sel.length!==2||G.stable.length>=6)return;
const pA=G.stable[sel[0]],pB=G.stable[sel[1]];
const childStats=STAT_NAMES.map((_,i)=>{
const avg=((pA.stats[i]+pB.stats[i])/2)|0;
return clamp(avg+rng(-2,2),1,20);
});
const childSeed=(pA.seed+pB.seed)/2+Math.random()*100;
const child=makeCreature(pA.name.slice(0,4)+pB.name.slice(0,4),childStats,childSeed);
child.generation=Math.max(pA.generation,pB.generation)+1;
child.parentA=pA.id;child.parentB=pB.id;
// Inherit mutations
const allMuts=[...pA.mutations,...pB.mutations];
const uniq=[...new Set(allMuts)];
uniq.forEach(m=>{if(Math.random()<.5)child.mutations.push(m)});
if(Math.random()<.1){const nm=pick(MUTATIONS);if(!child.mutations.includes(nm.id))child.mutations.push(nm.id);}
G.stable.push(child);
sfxLvl();save();
$('breedResult').innerHTML=`<div style="text-align:center;margin:8px 0"><canvas id="breedChild" width="120" height="120"></canvas>
<p>${child.name} was born!</p></div>`;
drawCreature($('breedChild').getContext('2d'),child,60,65,100,{t:0});
updateCatalog(child);
setTimeout(()=>renderBreed(),2000);
};
}

// CATALOG
function updateCatalog(c){
if(!c)return;
const key=c.stats.map(s=>s>15?2:s>8?1:0).join('')+c.mutations.sort().join(',');
if(!G.catalog[key]){
G.catalog[key]={name:c.name,hue:c.hue,stats:c.stats.slice(),muts:c.mutations.slice(),time:Date.now()};
save();
}
}

function renderCatalog(){
const p=$('panel_catalog');
const entries=Object.values(G.catalog);
const total=entries.length;
let html=`<h3 style="text-align:center;margin:4px 0">üìñ Creature Catalog</h3>`;
html+=`<p style="text-align:center;font-size:.8em;color:#888">${total} forms discovered</p>`;
html+='<div class="catalog-grid">';
entries.slice(0,50).forEach(e=>{
html+=`<div class="cat-entry found"><canvas width="50" height="50" class="catCanvas"></canvas>
<div>${e.name}</div></div>`;
});
// Undiscovered silhouettes
for(let i=0;i<Math.max(0,20-total);i++){
html+=`<div class="cat-entry unknown"><canvas width="50" height="50"></canvas><div>???</div></div>`;
}
html+='</div>';
p.innerHTML=html;
const canvases=p.querySelectorAll('.catCanvas');
entries.slice(0,50).forEach((e,i)=>{
if(canvases[i]){
const c=makeCreature(e.name,e.stats,(e.hue*137.5)|0);
c.mutations=e.muts||[];c.hue=e.hue;
drawCreature(canvases[i].getContext('2d'),c,25,28,40,{t:0});
}
});
}

// SAVE/LOAD
function save(){
try{localStorage.setItem(SAVE_KEY,JSON.stringify(G));}catch(e){}
}
function load(){
try{const d=localStorage.getItem(SAVE_KEY);if(d){const p=JSON.parse(d);Object.assign(G,p);}}catch(e){}
}

init();
})();
</script>
</body>
</html>
