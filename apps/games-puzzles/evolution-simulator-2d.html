<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Genetic Car Evolution</title>
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="games_puzzles">
<meta name="rappterzoo:tags" content="canvas,simulation,evolution,physics,audio,game">
<meta name="rappterzoo:type" content="game">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2025-01-10">
<meta name="rappterzoo:generation" content="2">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#111;color:#0f0;font-family:'Courier New',monospace;overflow:hidden}
canvas{display:block;position:fixed;top:0;left:0}
#title-screen{position:fixed;inset:0;background:radial-gradient(ellipse at center,#0a1a0a 0%,#050a05 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity .5s}
#title-screen.hidden{opacity:0;pointer-events:none}
#title-screen h1{font-size:42px;color:#0f0;text-shadow:0 0 30px rgba(0,255,0,0.4);margin-bottom:8px;letter-spacing:3px}
#title-screen .sub{color:#0a0;font-size:14px;margin-bottom:30px}
.menu-btn{display:block;padding:12px 40px;margin:8px 0;font-size:15px;background:rgba(0,50,0,0.6);border:1px solid #0f0;color:#0f0;border-radius:4px;cursor:pointer;transition:all .2s;font-family:inherit;letter-spacing:2px;min-width:220px}
.menu-btn:hover{background:rgba(0,80,0,0.8);transform:scale(1.05);box-shadow:0 0 20px rgba(0,255,0,0.3)}
.diff-row{display:flex;gap:10px;margin:12px 0}
.diff-btn{padding:8px 20px;font-size:12px;background:#001a00;border:1px solid #060;color:#0a0;border-radius:4px;cursor:pointer;transition:all .2s}
.diff-btn:hover,.diff-btn.active{background:#003300;border-color:#0f0;color:#0f0}
#hud{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:8px 16px;background:rgba(0,0,0,0.8);border-bottom:1px solid #0a0;z-index:10;height:44px;font-size:12px}
#hud .title{color:#0f0;font-size:14px;letter-spacing:2px}
#hud .stats{display:flex;gap:16px}
#hud .stats span{color:#0a0}
#hud .stats .hl{color:#fff;font-weight:bold}
#controls{position:fixed;top:52px;right:12px;background:rgba(0,0,0,0.85);border:1px solid #0a0;border-radius:6px;padding:12px;z-index:10;font-size:11px;width:200px}
#controls button{display:block;width:100%;padding:6px;margin:4px 0;background:#001a00;border:1px solid #060;color:#0f0;cursor:pointer;border-radius:3px;font-family:inherit;font-size:11px}
#controls button:hover{background:#003300;border-color:#0f0}
#controls label{display:block;margin:6px 0 2px;color:#0a0;font-size:10px}
#controls input[type=range]{width:100%;accent-color:#0f0}
#leaderboard{position:fixed;bottom:12px;left:12px;background:rgba(0,0,0,0.85);border:1px solid #0a0;border-radius:6px;padding:12px;z-index:10;font-size:10px;max-height:200px;overflow-y:auto;width:220px}
#leaderboard h3{color:#0f0;margin-bottom:6px;font-size:12px}
.lb-entry{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid #0a0}
.lb-entry .rank{color:#0a0}
.lb-entry .dist{color:#fff}
#pause-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:900}
#pause-overlay.show{display:flex}
#pause-overlay h2{font-size:36px;color:#0f0;margin-bottom:24px}
#game-over{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:950}
#game-over.show{display:flex}
#game-over h2{font-size:36px;color:#f00;margin-bottom:12px}
#game-over .stats{color:#0a0;font-size:14px;text-align:center;line-height:2;margin-bottom:20px}
</style>
</head>
<body>
<div id="title-screen">
<h1>GENETIC CAR EVOLUTION</h1>
<div class="sub">Watch cars evolve to conquer procedural terrain</div>
<div class="diff-row">
<button class="diff-btn active" data-diff="easy">Easy Terrain</button>
<button class="diff-btn" data-diff="normal">Normal</button>
<button class="diff-btn" data-diff="hard">Extreme</button>
</div>
<button class="menu-btn" id="start-btn">START EVOLUTION</button>
<button class="menu-btn" id="load-btn">LOAD PROGRESS</button>
<div style="color:#060;font-size:10px;margin-top:20px">Space: Fast Forward | ESC: Pause | N: Next Gen | R: Reset</div>
</div>
<div id="pause-overlay">
<h2>PAUSED</h2>
<button class="menu-btn" id="resume-btn">RESUME</button>
<button class="menu-btn" id="save-btn2">SAVE PROGRESS</button>
<button class="menu-btn" id="quit-btn">QUIT TO MENU</button>
</div>
<div id="game-over">
<h2>EVOLUTION COMPLETE</h2>
<div class="stats" id="final-stats"></div>
<button class="menu-btn" id="retry-btn">EVOLVE AGAIN (R)</button>
<button class="menu-btn" id="menu-btn2">MAIN MENU</button>
</div>
<canvas id="c"></canvas>
<div id="hud" style="display:none">
<span class="title">GENETIC CARS</span>
<div class="stats">
<span>Gen: <span class="hl" id="gen-num">1</span></span>
<span>Alive: <span class="hl" id="alive-count">0</span>/<span id="pop-size">20</span></span>
<span>Best: <span class="hl" id="best-dist">0</span>m</span>
<span>Time: <span class="hl" id="timer">0.0</span>s</span>
<span>Score: <span class="hl" id="score-val">0</span></span>
</div>
</div>
<div id="controls" style="display:none">
<button id="fast-btn">Fast Forward (Space)</button>
<button id="next-btn">Force Next Gen (N)</button>
<button id="save-btn">Save Progress</button>
<label>Mutation Rate: <span id="mut-val">5</span>%</label>
<input type="range" id="mut-slider" min="1" max="20" value="5">
<label>Population: <span id="pop-val">20</span></label>
<input type="range" id="pop-slider" min="5" max="40" value="20">
</div>
<div id="leaderboard" style="display:none">
<h3>Hall of Fame</h3>
<div id="lb-list"></div>
</div>
<script>
// ===== AUDIO =====
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let actx = null;
function initAudio(){if(!actx)actx=new AudioCtx()}
function tone(f,d,t,v){if(!actx)return;const o=actx.createOscillator(),g=actx.createGain();o.type=t||'sine';o.frequency.value=f;g.gain.setValueAtTime(v||0.05,actx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+d);o.connect(g);g.connect(actx.destination);o.start();o.stop(actx.currentTime+d)}
function sfxBirth(){tone(440,0.1,'triangle',0.04);tone(660,0.08,'triangle',0.03)}
function sfxDeath(){tone(200,0.2,'sawtooth',0.03)}
function sfxNewGen(){tone(523,0.15,'sine',0.05);tone(659,0.12,'sine',0.04);tone(784,0.1,'sine',0.03)}
function sfxRecord(){tone(880,0.2,'sine',0.06);tone(1100,0.15,'sine',0.05);tone(1320,0.1,'sine',0.04)}
function sfxMenu(){tone(660,0.1,'sine',0.04)}

// ===== CONSTANTS =====
const GRAVITY = 0.4;
const ROUND_TIME = 20;
const TERRAIN_SEGMENTS = 300;

// ===== STATE =====
let state='menu', diff='normal', canvas, ctx, W, H;
let generation=1, timer=0, bestEverDist=0, score=0;
let cars=[], terrain=[], particles=[];
let camX=0, camY=0, isFast=false;
let mutationRate=0.05, popSize=20;
let keys={}, shakeX=0, shakeY=0, shakeMag=0;
let leaderboard=JSON.parse(localStorage.getItem('evo_lb')||'[]');
let highScore=parseInt(localStorage.getItem('evo_hs')||'0');

const DIFF_SETTINGS={
  easy:{roughness:30,gapChance:0,slopeMax:0.3},
  normal:{roughness:60,gapChance:0.02,slopeMax:0.5},
  hard:{roughness:100,gapChance:0.05,slopeMax:0.8}
};

// ===== TERRAIN =====
function generateTerrain(){
  terrain=[];
  const cfg=DIFF_SETTINGS[diff];
  let x=0, y=H*0.6;
  // Flat start
  terrain.push({x:0,y:y},{x:200,y:y});
  x=200;
  for(let i=0;i<TERRAIN_SEGMENTS;i++){
    const segW=60+Math.random()*100;
    const dy=(Math.random()-0.4)*cfg.roughness;
    y+=dy;
    y=Math.max(H*0.2,Math.min(H*0.85,y));
    if(Math.random()<cfg.gapChance){
      terrain.push({x:x,y:H+50});
      terrain.push({x:x+30,y:H+50});
      x+=30;
    }
    terrain.push({x:x+segW,y:y});
    x+=segW;
  }
}

function getTerrainY(px){
  for(let i=0;i<terrain.length-1;i++){
    if(px>=terrain[i].x&&px<terrain[i+1].x){
      const t=(px-terrain[i].x)/(terrain[i+1].x-terrain[i].x);
      return terrain[i].y+(terrain[i+1].y-terrain[i].y)*t;
    }
  }
  return H*0.6;
}

function getTerrainAngle(px){
  for(let i=0;i<terrain.length-1;i++){
    if(px>=terrain[i].x&&px<terrain[i+1].x){
      const dx=terrain[i+1].x-terrain[i].x;
      const dy=terrain[i+1].y-terrain[i].y;
      return Math.atan2(dy,dx);
    }
  }
  return 0;
}

// ===== CAR DNA =====
class Car{
  constructor(dna){
    this.dna=dna||this.randomDNA();
    this.x=150;this.y=0;
    this.vx=0;this.vy=0;
    this.angle=0;this.angVel=0;
    this.alive=true;this.maxDist=0;
    this.stuckTimer=0;this.lastX=150;
    this.wheelAngle1=0;this.wheelAngle2=0;
    this.color=`hsl(${Math.random()*360},70%,50%)`;
    this.trail=[];
    // Position on terrain
    this.y=getTerrainY(this.x)-this.dna.bodyH-this.dna.wheel1R;
  }
  randomDNA(){
    return{
      bodyW:30+Math.random()*40,
      bodyH:8+Math.random()*15,
      wheel1R:8+Math.random()*15,
      wheel2R:8+Math.random()*15,
      wheel1X:-0.3+Math.random()*0.2,
      wheel2X:0.1+Math.random()*0.3,
      enginePower:0.5+Math.random()*2,
      mass:1+Math.random()*2,
      friction:0.3+Math.random()*0.5,
      springiness:0.1+Math.random()*0.4
    };
  }
  update(dt){
    if(!this.alive)return;
    const d=this.dna;
    // Wheel positions in world
    const w1x=this.x+d.bodyW*d.wheel1X;
    const w2x=this.x+d.bodyW*d.wheel2X;
    const t1y=getTerrainY(w1x);
    const t2y=getTerrainY(w2x);
    const w1y=this.y+d.bodyH;
    const w2y=this.y+d.bodyH;
    // Gravity
    this.vy+=GRAVITY*dt;
    // Ground contact
    const ground1=w1y+d.wheel1R>=t1y;
    const ground2=w2y+d.wheel2R>=t2y;
    let onGround=ground1||ground2;
    if(ground1){
      const penetration=w1y+d.wheel1R-t1y;
      this.vy-=penetration*d.springiness;
      this.y=t1y-d.bodyH-d.wheel1R+2;
      // Friction and drive
      const angle=getTerrainAngle(w1x);
      this.vx+=Math.cos(angle)*d.enginePower*0.1*dt;
      this.vy+=Math.sin(angle)*d.enginePower*0.05*dt;
      this.vx*=(1-d.friction*0.01);
    }
    if(ground2){
      const penetration=w2y+d.wheel2R-t2y;
      this.vy-=penetration*d.springiness;
      const angle=getTerrainAngle(w2x);
      this.vx+=Math.cos(angle)*d.enginePower*0.08*dt;
      this.vx*=(1-d.friction*0.01);
    }
    // Apply velocity
    this.x+=this.vx*dt;
    this.y+=this.vy*dt;
    // Wheel rotation
    this.wheelAngle1+=this.vx*0.1;
    this.wheelAngle2+=this.vx*0.1;
    // Angle from terrain
    if(onGround){
      const targetAngle=Math.atan2(t2y-t1y,w2x-w1x);
      this.angle+=(targetAngle-this.angle)*0.1;
    }
    // Track distance
    this.maxDist=Math.max(this.maxDist,this.x-150);
    // Trail
    if(this.trail.length===0||Math.hypot(this.x-this.trail[this.trail.length-1].x,this.y-this.trail[this.trail.length-1].y)>5){
      this.trail.push({x:this.x,y:this.y+d.bodyH});
      if(this.trail.length>100)this.trail.shift();
    }
    // Stuck detection
    if(Math.abs(this.x-this.lastX)<0.5){
      this.stuckTimer+=dt;
      if(this.stuckTimer>120){this.alive=false;sfxDeath();spawnParticles(this.x,this.y,this.color,8)}
    }else{this.stuckTimer=0;this.lastX=this.x}
    // Off screen
    if(this.y>H+100){this.alive=false;sfxDeath();spawnParticles(this.x,this.y-100,this.color,6)}
    if(this.x<0){this.alive=false}
  }
  draw(ctx){
    if(!this.alive)return;
    const d=this.dna;
    const sx=this.x-camX;
    const sy=this.y-camY;
    if(sx<-100||sx>W+100)return;
    // Trail
    if(this.trail.length>1){
      ctx.beginPath();
      ctx.strokeStyle=this.color+'44';
      ctx.lineWidth=1;
      for(let i=0;i<this.trail.length;i++){
        const tx=this.trail[i].x-camX,ty=this.trail[i].y-camY;
        if(i===0)ctx.moveTo(tx,ty);else ctx.lineTo(tx,ty);
      }
      ctx.stroke();
    }
    ctx.save();
    ctx.translate(sx,sy+d.bodyH*0.5);
    ctx.rotate(this.angle);
    // Body
    ctx.fillStyle=this.color;
    ctx.fillRect(-d.bodyW*0.5,-d.bodyH*0.5,d.bodyW,d.bodyH);
    ctx.strokeStyle='rgba(255,255,255,0.3)';
    ctx.lineWidth=1;
    ctx.strokeRect(-d.bodyW*0.5,-d.bodyH*0.5,d.bodyW,d.bodyH);
    // Wheel 1
    const w1lx=d.bodyW*d.wheel1X;
    const w1ly=d.bodyH*0.5;
    ctx.save();ctx.translate(w1lx,w1ly);ctx.rotate(this.wheelAngle1);
    ctx.beginPath();ctx.arc(0,0,d.wheel1R,0,Math.PI*2);
    ctx.fillStyle='#333';ctx.fill();
    ctx.strokeStyle='#888';ctx.lineWidth=2;ctx.stroke();
    // Wheel spokes
    for(let i=0;i<4;i++){
      const a=(i/4)*Math.PI*2;
      ctx.beginPath();ctx.moveTo(0,0);
      ctx.lineTo(Math.cos(a)*d.wheel1R*0.8,Math.sin(a)*d.wheel1R*0.8);
      ctx.strokeStyle='#555';ctx.lineWidth=1;ctx.stroke();
    }
    ctx.restore();
    // Wheel 2
    const w2lx=d.bodyW*d.wheel2X;
    const w2ly=d.bodyH*0.5;
    ctx.save();ctx.translate(w2lx,w2ly);ctx.rotate(this.wheelAngle2);
    ctx.beginPath();ctx.arc(0,0,d.wheel2R,0,Math.PI*2);
    ctx.fillStyle='#333';ctx.fill();
    ctx.strokeStyle='#888';ctx.lineWidth=2;ctx.stroke();
    for(let i=0;i<4;i++){
      const a=(i/4)*Math.PI*2;
      ctx.beginPath();ctx.moveTo(0,0);
      ctx.lineTo(Math.cos(a)*d.wheel2R*0.8,Math.sin(a)*d.wheel2R*0.8);
      ctx.strokeStyle='#555';ctx.lineWidth=1;ctx.stroke();
    }
    ctx.restore();
    ctx.restore();
    // Distance label
    ctx.fillStyle=this.color;
    ctx.font='9px monospace';
    ctx.textAlign='center';
    ctx.fillText(Math.floor(this.maxDist)+'m',sx,sy-d.bodyH-8);
  }
}

// ===== GENETICS =====
function crossover(dna1,dna2){
  const child={};
  for(const key of Object.keys(dna1)){
    child[key]=Math.random()>0.5?dna1[key]:dna2[key];
  }
  return child;
}

function mutate(dna){
  const m={...dna};
  for(const key of Object.keys(m)){
    if(Math.random()<mutationRate){
      const range={bodyW:10,bodyH:5,wheel1R:5,wheel2R:5,wheel1X:0.1,wheel2X:0.1,enginePower:0.5,mass:0.5,friction:0.1,springiness:0.1};
      m[key]+=(Math.random()-0.5)*2*(range[key]||1);
      // Clamp
      if(key==='bodyW')m[key]=Math.max(20,Math.min(80,m[key]));
      if(key==='bodyH')m[key]=Math.max(5,Math.min(25,m[key]));
      if(key.includes('wheel')&&key.includes('R'))m[key]=Math.max(5,Math.min(30,m[key]));
      if(key==='enginePower')m[key]=Math.max(0.2,Math.min(4,m[key]));
      if(key==='mass')m[key]=Math.max(0.5,Math.min(4,m[key]));
    }
  }
  return m;
}

function nextGeneration(){
  sfxNewGen();
  // Sort by fitness
  cars.sort((a,b)=>b.maxDist-a.maxDist);
  const bestDist=cars[0].maxDist;
  score+=Math.floor(bestDist);
  if(bestDist>bestEverDist){
    bestEverDist=bestDist;
    sfxRecord();
    addShake(5);
    // Update leaderboard
    leaderboard.push({gen:generation,dist:Math.floor(bestEverDist),date:new Date().toLocaleDateString()});
    leaderboard.sort((a,b)=>b.dist-a.dist);
    leaderboard=leaderboard.slice(0,10);
    localStorage.setItem('evo_lb',JSON.stringify(leaderboard));
  }
  // Selection - top 50%
  const parents=cars.slice(0,Math.floor(popSize/2));
  const nextDNA=[];
  // Elitism - keep best unchanged
  nextDNA.push(JSON.parse(JSON.stringify(cars[0].dna)));
  while(nextDNA.length<popSize){
    const p1=parents[Math.floor(Math.random()*parents.length)];
    const p2=parents[Math.floor(Math.random()*parents.length)];
    const child=crossover(p1.dna,p2.dna);
    nextDNA.push(mutate(child));
  }
  // Create new cars
  cars=nextDNA.map(dna=>new Car(dna));
  generation++;
  timer=0;
  updateLeaderboard();
}

// ===== PARTICLES =====
class Particle{
  constructor(x,y,color){
    this.x=x;this.y=y;this.color=color;
    this.vx=(Math.random()-0.5)*4;this.vy=(Math.random()-0.5)*4-2;
    this.life=1;this.decay=0.02+Math.random()*0.03;
    this.size=2+Math.random()*3;
  }
  update(){this.x+=this.vx;this.y+=this.vy;this.vy+=0.1;this.life-=this.decay;return this.life>0}
  draw(ctx){
    const sx=this.x-camX,sy=this.y-camY;
    ctx.globalAlpha=this.life;ctx.fillStyle=this.color;
    ctx.fillRect(sx-this.size*0.5,sy-this.size*0.5,this.size,this.size);
    ctx.globalAlpha=1;
  }
}
function spawnParticles(x,y,color,n){for(let i=0;i<n;i++)particles.push(new Particle(x,y,color))}
function addShake(m){shakeMag=Math.max(shakeMag,m)}

// ===== INIT =====
function init(){
  canvas=document.getElementById('c');
  ctx=canvas.getContext('2d');
  resize();
  window.addEventListener('resize',resize);
  setupInput();
  setupUI();
}

function resize(){W=canvas.width=innerWidth;H=canvas.height=innerHeight}

function startGame(){
  state='playing';initAudio();sfxMenu();
  generateTerrain();
  cars=[];
  for(let i=0;i<popSize;i++)cars.push(new Car());
  particles=[];generation=1;timer=0;score=0;bestEverDist=0;
  document.getElementById('title-screen').classList.add('hidden');
  document.getElementById('hud').style.display='';
  document.getElementById('controls').style.display='';
  document.getElementById('leaderboard').style.display='';
  updateLeaderboard();
}

function setupInput(){
  window.addEventListener('keydown',e=>{
    keys[e.key.toLowerCase()]=true;
    if(e.key==='Escape')togglePause();
    if(e.key==='n'||e.key==='N')if(state==='playing')nextGeneration();
    if(e.key===' '){isFast=!isFast;e.preventDefault()}
    if(e.key==='r'||e.key==='R'){
      if(state==='gameover'){document.getElementById('game-over').classList.remove('show');startGame()}
    }
  });
  window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false});
}

function setupUI(){
  document.querySelectorAll('.diff-btn').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.diff-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');diff=b.dataset.diff;sfxMenu();
    });
  });
  document.getElementById('start-btn').addEventListener('click',startGame);
  document.getElementById('load-btn').addEventListener('click',()=>{
    const s=localStorage.getItem('evo_save');
    if(!s)return;
    try{
      const d=JSON.parse(s);generation=d.generation;bestEverDist=d.bestEverDist;score=d.score;diff=d.diff;
      popSize=d.popSize;mutationRate=d.mutationRate;
      generateTerrain();cars=[];for(let i=0;i<popSize;i++)cars.push(new Car());
      timer=0;state='playing';
      document.getElementById('title-screen').classList.add('hidden');
      document.getElementById('hud').style.display='';
      document.getElementById('controls').style.display='';
      document.getElementById('leaderboard').style.display='';
      updateLeaderboard();sfxMenu();
    }catch(e){}
  });
  document.getElementById('resume-btn').addEventListener('click',togglePause);
  document.getElementById('save-btn').addEventListener('click',saveProgress);
  document.getElementById('save-btn2').addEventListener('click',()=>{saveProgress();togglePause()});
  document.getElementById('quit-btn').addEventListener('click',()=>{
    state='menu';
    document.getElementById('pause-overlay').classList.remove('show');
    document.getElementById('title-screen').classList.remove('hidden');
    ['hud','controls','leaderboard'].forEach(id=>document.getElementById(id).style.display='none');
  });
  document.getElementById('retry-btn').addEventListener('click',()=>{document.getElementById('game-over').classList.remove('show');startGame()});
  document.getElementById('menu-btn2').addEventListener('click',()=>{
    state='menu';document.getElementById('game-over').classList.remove('show');
    document.getElementById('title-screen').classList.remove('hidden');
    ['hud','controls','leaderboard'].forEach(id=>document.getElementById(id).style.display='none');
  });
  document.getElementById('fast-btn').addEventListener('click',()=>{isFast=!isFast;sfxMenu()});
  document.getElementById('next-btn').addEventListener('click',()=>{if(state==='playing')nextGeneration()});
  document.getElementById('mut-slider').addEventListener('input',e=>{mutationRate=e.target.value/100;document.getElementById('mut-val').textContent=e.target.value});
  document.getElementById('pop-slider').addEventListener('input',e=>{popSize=parseInt(e.target.value);document.getElementById('pop-val').textContent=e.target.value});
}

function saveProgress(){
  localStorage.setItem('evo_save',JSON.stringify({generation,bestEverDist,score,diff,popSize,mutationRate}));
  if(score>highScore){highScore=score;localStorage.setItem('evo_hs',highScore.toString())}
  sfxMenu();
}

function togglePause(){
  if(state==='playing'){state='paused';document.getElementById('pause-overlay').classList.add('show');sfxMenu()}
  else if(state==='paused'){state='playing';document.getElementById('pause-overlay').classList.remove('show');sfxMenu()}
}

function updateLeaderboard(){
  const el=document.getElementById('lb-list');
  if(!el)return;
  el.innerHTML='';
  leaderboard.forEach((e,i)=>{
    el.innerHTML+='<div class="lb-entry"><span class="rank">#'+(i+1)+' Gen '+e.gen+'</span><span class="dist">'+e.dist+'m</span></div>';
  });
}

// ===== GAME LOOP =====
let lastTime=0;
function gameLoop(time){
  const rawDt=(time-lastTime)/16.67;
  lastTime=time;
  const dt=Math.min(rawDt,3);

  if(state==='playing'){
    const steps=isFast?5:1;
    for(let s=0;s<steps;s++){
      timer+=1/60;
      for(const car of cars)car.update(1);
      particles=particles.filter(p=>p.update());
      // Check if all dead or time up
      const alive=cars.filter(c=>c.alive).length;
      if(alive===0||timer>=ROUND_TIME){
        if(generation>=100){
          // Game over after 100 generations
          state='gameover';
          saveProgress();
          document.getElementById('final-stats').innerHTML='Generations: '+generation+'<br>Best Distance: '+Math.floor(bestEverDist)+'m<br>Total Score: '+score+'<br>High Score: '+highScore;
          document.getElementById('game-over').classList.add('show');
        }else{
          nextGeneration();
        }
      }
    }
    // Camera follow leader
    let leader=cars[0];
    for(const c of cars)if(c.alive&&c.x>leader.x)leader=c;
    if(leader)camX+=(leader.x-W*0.3-camX)*0.05;
    camY+=(leader.y-H*0.5-camY)*0.03;
  }
  // Shake
  if(shakeMag>0){
    shakeX=(Math.random()-0.5)*shakeMag;shakeY=(Math.random()-0.5)*shakeMag;
    shakeMag*=0.85;if(shakeMag<0.3){shakeMag=0;shakeX=0;shakeY=0}
  }

  draw();
  requestAnimationFrame(gameLoop);
}

function draw(){
  ctx.save();
  ctx.translate(shakeX,shakeY);
  // Background
  const grad=ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'#050a05');
  grad.addColorStop(1,'#0a150a');
  ctx.fillStyle=grad;
  ctx.fillRect(0,0,W,H);

  if(state==='menu'){
    // Ambient dots
    const t=performance.now()*0.001;
    for(let i=0;i<40;i++){
      const x=(Math.sin(i*2.1+t*0.2)*0.5+0.5)*W;
      const y=(Math.cos(i*1.7+t*0.15)*0.5+0.5)*H;
      ctx.beginPath();ctx.arc(x,y,1.5,0,Math.PI*2);
      ctx.fillStyle='rgba(0,255,0,'+(0.1+Math.sin(t+i)*0.05)+')';ctx.fill();
    }
    ctx.restore();requestAnimationFrame(gameLoop);return;
  }

  // Draw terrain
  ctx.beginPath();
  ctx.moveTo(terrain[0].x-camX,terrain[0].y-camY);
  for(let i=1;i<terrain.length;i++){
    ctx.lineTo(terrain[i].x-camX,terrain[i].y-camY);
  }
  ctx.lineTo(terrain[terrain.length-1].x-camX,H+50);
  ctx.lineTo(terrain[0].x-camX,H+50);
  ctx.closePath();
  const tGrad=ctx.createLinearGradient(0,H*0.3,0,H);
  tGrad.addColorStop(0,'#1a3a1a');
  tGrad.addColorStop(1,'#0a1a0a');
  ctx.fillStyle=tGrad;
  ctx.fill();
  ctx.strokeStyle='#0f0';
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(terrain[0].x-camX,terrain[0].y-camY);
  for(let i=1;i<terrain.length;i++)ctx.lineTo(terrain[i].x-camX,terrain[i].y-camY);
  ctx.stroke();

  // Draw cars
  for(const car of cars)car.draw(ctx);
  // Draw particles
  for(const p of particles)p.draw(ctx);

  // Distance markers
  ctx.font='10px monospace';ctx.fillStyle='#0a0';ctx.textAlign='center';
  for(let d=100;d<bestEverDist+500;d+=100){
    const mx=150+d-camX;
    if(mx>0&&mx<W){
      ctx.beginPath();ctx.moveTo(mx,0);ctx.lineTo(mx,H);
      ctx.strokeStyle='rgba(0,255,0,0.05)';ctx.lineWidth=1;ctx.stroke();
      ctx.fillText(d+'m',mx,20);
    }
  }
  // Best ever line
  if(bestEverDist>0){
    const bx=150+bestEverDist-camX;
    if(bx>0&&bx<W){
      ctx.beginPath();ctx.moveTo(bx,0);ctx.lineTo(bx,H);
      ctx.strokeStyle='rgba(255,255,0,0.3)';ctx.lineWidth=2;ctx.stroke();
      ctx.fillStyle='#ff0';ctx.fillText('BEST: '+Math.floor(bestEverDist)+'m',bx,35);
    }
  }

  ctx.restore();

  // Update HUD
  const alive=cars.filter(c=>c.alive).length;
  document.getElementById('gen-num').textContent=generation;
  document.getElementById('alive-count').textContent=alive;
  document.getElementById('pop-size').textContent=popSize;
  document.getElementById('best-dist').textContent=Math.floor(bestEverDist);
  document.getElementById('timer').textContent=timer.toFixed(1);
  document.getElementById('score-val').textContent=score;
}

// ===== START =====
init();
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
