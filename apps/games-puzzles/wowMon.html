<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="WoWmon - An accessible Warcraft-themed creature collection game inspired by Pokemon">
    <title>WoWmon - Pocket Creatures of Azeroth</title>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', monospace, system-ui;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            overflow: hidden;
            position: relative;
        }

        /* Animated background particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 51, 102, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(0, 242, 254, 0.1) 0%, transparent 50%);
            animation: floatParticles 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes floatParticles {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        /* Enhanced Color Palette */
        :root {
            --gb-darkest: #0f380f;
            --gb-dark: #306230;
            --gb-light: #8bac0f;
            --gb-lightest: #9bbc0f;
            --screen-width: 400px;
            --screen-height: 360px;
            --pixel-size: 2;

            /* New modern colors */
            --primary: #00f2fe;
            --secondary: #4facfe;
            --accent: #f093fb;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #ef4444;
            --dark: #1e293b;
            --darker: #0f172a;
        }

        /* Enhanced Main Container */
        .game-container {
            background: linear-gradient(145deg, #2d3748 0%, #1a202c 100%);
            padding: 30px;
            border-radius: 24px;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(79, 172, 254, 0.3);
            animation: containerGlow 3s ease-in-out infinite alternate;
        }

        @keyframes containerGlow {
            from { box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(79, 172, 254, 0.3),
                0 0 20px rgba(79, 172, 254, 0.2); }
            to { box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(240, 147, 251, 0.3),
                0 0 30px rgba(240, 147, 251, 0.3); }
        }

        /* Enhanced Screen */
        .game-screen {
            width: var(--screen-width);
            height: var(--screen-height);
            background: linear-gradient(180deg, #0a0e27 0%, #1a1f3a 100%);
            position: relative;
            border: 3px solid rgba(79, 172, 254, 0.5);
            border-radius: 16px;
            overflow: hidden;
            box-shadow:
                inset 0 0 40px rgba(0, 0, 0, 0.8),
                inset 0 0 80px rgba(79, 172, 254, 0.1),
                0 0 20px rgba(79, 172, 254, 0.3);
            position: relative;
        }

        /* Screen scanline effect */
        .game-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1) 0px,
                transparent 1px,
                transparent 2px,
                rgba(0, 0, 0, 0.1) 3px
            );
            pointer-events: none;
            z-index: 100;
            opacity: 0.3;
            animation: scanlines 8s linear infinite;
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        /* Screen glow effect */
        .game-screen::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            right: -50%;
            bottom: -50%;
            background: radial-gradient(circle, rgba(79, 172, 254, 0.1) 0%, transparent 70%);
            animation: screenPulse 4s ease-in-out infinite;
            pointer-events: none;
            z-index: 99;
        }

        @keyframes screenPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        /* Canvas */
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            image-rendering: pixelated;
        }

        /* UI Overlays */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .text-box {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--gb-lightest);
            border: 4px solid var(--gb-darkest);
            padding: 8px;
            font-size: 16px;
            color: var(--gb-darkest);
            min-height: 60px;
            display: none;
            font-family: monospace;
        }

        .text-box.active {
            display: block;
            pointer-events: all;
        }

        .menu {
            position: absolute;
            background: var(--gb-lightest);
            border: 4px solid var(--gb-darkest);
            padding: 8px;
            display: none;
            color: var(--gb-darkest);
            min-width: 120px;
        }

        .menu.active {
            display: block;
            pointer-events: all;
        }

        .menu-option {
            padding: 4px;
            cursor: pointer;
            font-family: monospace;
        }

        .menu-option.selected {
            background: var(--gb-darkest);
            color: var(--gb-lightest);
        }

        /* Controls */
        /* Enhanced Controls */
        .controls {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            gap: 40px;
            padding: 0 20px;
        }

        .control-label {
            font-size: 11px;
            font-weight: bold;
            color: #9bbc0f;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .keyboard-hint {
            font-size: 10px;
            color: #4facfe;
            text-align: center;
            margin-top: 5px;
            font-weight: 500;
            text-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }

        .button-hint {
            font-size: 9px;
            color: #9bbc0f;
            text-align: center;
            margin-top: 3px;
            opacity: 0.8;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            align-items: center;
        }

        /* Modern Gradient Buttons */
        .btn {
            background: linear-gradient(145deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: #fff;
            padding: 18px 24px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            box-shadow:
                0 6px 0 #0369a1,
                0 8px 20px rgba(79, 172, 254, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow:
                0 8px 0 #0369a1,
                0 12px 30px rgba(79, 172, 254, 0.6);
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow:
                0 2px 0 #0369a1,
                0 4px 10px rgba(79, 172, 254, 0.3);
        }

        /* Modern D-Pad */
        .dpad {
            display: grid;
            grid-template-columns: 48px 48px 48px;
            grid-template-rows: 48px 48px 48px;
            gap: 4px;
            padding: 8px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 16px;
            box-shadow:
                inset 0 2px 8px rgba(0, 0, 0, 0.3),
                0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .dpad-btn {
            background: linear-gradient(145deg, #334155 0%, #1e293b 100%);
            border: 2px solid rgba(79, 172, 254, 0.3);
            border-radius: 8px;
            cursor: pointer;
            box-shadow:
                0 4px 0 #0f172a,
                0 6px 12px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            user-select: none;
            transition: all 0.15s;
            position: relative;
            color: var(--primary);
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dpad-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 6px;
            background: radial-gradient(circle, rgba(79, 172, 254, 0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .dpad-btn:hover::after {
            opacity: 1;
        }

        .dpad-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow:
                0 6px 0 #0f172a,
                0 8px 20px rgba(79, 172, 254, 0.4);
        }

        .dpad-btn:active {
            transform: translateY(2px);
            box-shadow:
                0 2px 0 #0f172a,
                0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #up { grid-column: 2; grid-row: 1; }
        #left { grid-column: 1; grid-row: 2; }
        #right { grid-column: 3; grid-row: 2; }
        #down { grid-column: 2; grid-row: 3; }

        /* Enhanced Cartridge Controls */
        .cartridge-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .cartridge-btn {
            background: linear-gradient(145deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: #fff;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 10px;
            box-shadow:
                0 3px 0 #c41e3a,
                0 4px 12px rgba(245, 87, 108, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            font-family: 'Press Start 2P', monospace;
            transition: all 0.2s;
            user-select: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cartridge-btn:hover {
            transform: translateY(-2px);
            box-shadow:
                0 5px 0 #c41e3a,
                0 6px 18px rgba(245, 87, 108, 0.6);
        }

        .cartridge-btn:active {
            transform: translateY(2px);
            box-shadow:
                0 1px 0 #c41e3a,
                0 2px 6px rgba(245, 87, 108, 0.3);
        }

        /* Party Display - Shows active team */
        .party-display {
            position: absolute;
            bottom: 15px;
            left: 15px;
            display: flex;
            gap: 6px;
            z-index: 10;
            pointer-events: none;
        }

        .party-slot {
            width: 48px;
            height: 48px;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border: 2px solid rgba(79, 172, 254, 0.4);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow:
                0 4px 8px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .party-slot:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow:
                0 6px 16px rgba(79, 172, 254, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .party-slot.empty {
            opacity: 0.3;
            border-style: dashed;
        }

        .party-slot.active {
            border-color: var(--success);
            box-shadow:
                0 4px 8px rgba(74, 222, 128, 0.5),
                0 0 16px rgba(74, 222, 128, 0.3);
            animation: activePulse 2s ease-in-out infinite;
        }

        @keyframes activePulse {
            0%, 100% { border-color: var(--success); }
            50% { border-color: var(--primary); }
        }

        .party-slot.fainted {
            border-color: var(--danger);
            opacity: 0.5;
        }

        .party-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .party-hp-mini {
            width: 32px;
            height: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .party-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            transition: width 0.3s ease;
        }

        .party-hp-fill.low {
            background: linear-gradient(90deg, var(--warning) 0%, var(--danger) 100%);
        }

        .party-level {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 8px;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* File input hidden */
        #cartridgeInput, #saveInput {
            display: none;
        }

        /* Battle UI */
        .battle-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            pointer-events: none;
        }

        .battle-ui.active {
            display: block;
        }

        .creature-info {
            position: absolute;
            background: var(--gb-lightest);
            border: 2px solid var(--gb-darkest);
            padding: 4px;
            font-size: 12px;
            font-family: monospace;
        }

        .player-info {
            bottom: 60px;
            right: 10px;
        }

        .enemy-info {
            top: 10px;
            left: 10px;
        }

        .hp-bar {
            width: 100px;
            height: 4px;
            background: var(--gb-darkest);
            margin: 2px 0;
        }

        .hp-fill {
            height: 100%;
            background: var(--gb-dark);
            transition: width 0.3s;
        }

        .hp-fill.low {
            background: #8b0000;
        }

        /* Loading Screen */
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gb-darkest);
            color: var(--gb-lightest);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            font-family: monospace;
        }

        .loading-screen.hidden {
            display: none;
        }

        /* Move Selection Menu */
        .move-menu {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: var(--gb-lightest);
            border: 4px solid var(--gb-darkest);
            padding: 8px;
            display: none;
        }

        .move-menu.active {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            pointer-events: all;
        }

        .move-option {
            padding: 8px;
            border: 2px solid var(--gb-darkest);
            cursor: pointer;
            font-family: monospace;
            font-size: 12px;
            text-align: center;
        }

        .move-option.selected {
            background: var(--gb-darkest);
            color: var(--gb-lightest);
        }

        .move-option small {
            display: block;
            font-size: 10px;
            opacity: 0.8;
        }

        /* Accessibility Enhancements */

        /* Focus indicators for keyboard navigation */
        button:focus,
        .menu-option:focus,
        .move-option:focus,
        .dpad-btn:focus,
        .btn:focus,
        .cartridge-btn:focus {
            outline: 3px solid #ffcc00;
            outline-offset: 2px;
            z-index: 1000;
        }

        /* Skip to content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #000;
            color: #fff;
            padding: 8px;
            text-decoration: none;
            z-index: 10000;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Live region for screen reader announcements */
        .live-region {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        /* Accessibility Settings Panel */
        .accessibility-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #8b956d;
            border: 4px solid #2d3a1d;
            padding: 20px;
            border-radius: 10px;
            display: none;
            z-index: 10000;
            min-width: 300px;
            max-width: 90vw;
            color: #0f380f;
        }

        .accessibility-panel.active {
            display: block;
        }

        .accessibility-panel h2 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #0f380f;
        }

        .accessibility-option {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .accessibility-option label {
            cursor: pointer;
            font-size: 14px;
        }

        .accessibility-option input[type="checkbox"],
        .accessibility-option input[type="range"] {
            cursor: pointer;
        }

        .accessibility-option input[type="range"] {
            flex: 1;
        }

        /* High contrast mode */
        body.high-contrast {
            background: #000;
        }

        body.high-contrast .game-container {
            background: #fff;
            border: 4px solid #000;
        }

        body.high-contrast .game-screen {
            border-color: #000;
        }

        body.high-contrast .btn,
        body.high-contrast .dpad-btn,
        body.high-contrast .cartridge-btn {
            background: #000;
            color: #fff;
            border: 2px solid #fff;
        }

        body.high-contrast .text-box,
        body.high-contrast .menu {
            background: #fff;
            border-color: #000;
            color: #000;
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        body.reduced-motion * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }

        /* Large text mode */
        body.large-text {
            font-size: 120%;
        }

        body.large-text .text-box,
        body.large-text .menu-option,
        body.large-text .move-option {
            font-size: 18px;
        }

        body.large-text .btn,
        body.large-text .cartridge-btn {
            font-size: 16px;
            padding: 18px 24px;
        }

        /* Button with proper tabindex styling */
        [tabindex]:focus {
            outline: 3px solid #ffcc00;
            outline-offset: 2px;
        }

        /* Better focus for menu options */
        .menu-option[tabindex]:focus,
        .move-option[tabindex]:focus {
            outline: 3px solid #ffcc00;
            outline-offset: -2px;
        }

        .close-panel-btn {
            background: #4a5a3a;
            border: none;
            color: #8b956d;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
            box-shadow: 0 2px 0 #2d3a1d;
            font-family: monospace;
        }

        .close-panel-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 0 #2d3a1d;
        }

        /* Mobile Fullscreen Toggle */
        .fullscreen-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #4a5a3a;
            border: none;
            color: #8b956d;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 3px 0 #2d3a1d;
            z-index: 1000;
            display: none;
            user-select: none;
            font-family: monospace;
        }

        .fullscreen-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #2d3a1d;
        }

        /* Team Builder Styles */
        .team-slot {
            display: flex;
            align-items: center;
            padding: 6px;
            margin-bottom: 4px;
            background: var(--gb-lightest);
            border: 2px solid var(--gb-dark);
            cursor: pointer;
            min-height: 56px;
            font-size: 11px;
        }

        .team-slot:hover,
        .team-slot.selected {
            background: var(--gb-light);
            border-color: var(--gb-darkest);
        }

        .team-slot.empty {
            opacity: 0.5;
            font-style: italic;
        }

        .team-slot.fainted {
            opacity: 0.6;
            background: #8b0000;
            color: var(--gb-lightest);
        }

        .slot-number {
            font-weight: bold;
            margin-right: 8px;
            min-width: 24px;
            font-size: 12px;
        }

        .slot-info {
            flex: 1;
        }

        .slot-name {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .slot-stats {
            font-size: 9px;
            display: flex;
            gap: 8px;
        }

        .slot-hp-bar {
            width: 60px;
            height: 6px;
            background: var(--gb-dark);
            border: 1px solid var(--gb-darkest);
            position: relative;
            margin-top: 2px;
        }

        .slot-hp-fill {
            height: 100%;
            background: var(--gb-darkest);
            transition: width 0.3s ease;
        }

        .slot-hp-fill.low {
            background: #8b0000;
        }

        .slot-hp-fill.critical {
            background: #ff0000;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            body {
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
                align-items: flex-start;
                overflow-x: hidden;
            }

            .fullscreen-btn {
                display: block;
            }

            .game-container {
                padding: 15px;
                margin: 10px;
                width: calc(100% - 20px);
                max-width: 100%;
                border-radius: 10px;
            }

            .game-screen {
                width: 100%;
                max-width: 400px;
                height: auto;
                aspect-ratio: 10 / 9;
                border: 10px solid #556b2f;
            }

            #gameCanvas {
                touch-action: none;
            }

            .controls {
                margin-top: 20px;
                gap: 15px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .dpad {
                grid-template-columns: 48px 48px 48px;
                grid-template-rows: 48px 48px 48px;
                gap: 4px;
            }

            .dpad-btn {
                min-width: 48px;
                min-height: 48px;
                font-size: 18px;
                touch-action: manipulation;
            }

            .btn {
                min-width: 64px;
                min-height: 64px;
                padding: 20px 24px;
                font-size: 16px;
                touch-action: manipulation;
            }

            .cartridge-controls {
                position: relative;
                top: 0;
                right: 0;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 15px;
                width: 100%;
            }

            .cartridge-btn {
                min-height: 48px;
                padding: 12px 16px;
                font-size: 14px;
                width: 100%;
                touch-action: manipulation;
            }

            .menu-option {
                padding: 12px;
                font-size: 16px;
                min-height: 48px;
                display: flex;
                align-items: center;
            }

            .move-option {
                padding: 12px;
                font-size: 14px;
                min-height: 56px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .text-box {
                font-size: 14px;
                padding: 12px;
                min-height: 80px;
            }

            .creature-info {
                font-size: 11px;
                padding: 6px;
            }

            .hp-bar {
                width: 80px;
                height: 6px;
            }
        }

        @media (max-width: 768px) and (orientation: portrait) {
            body {
                align-items: flex-start;
                padding-top: max(10px, env(safe-area-inset-top));
            }

            .game-container {
                margin-top: 5px;
            }

            .controls {
                width: 100%;
            }

            .control-group {
                flex: 1;
                justify-content: center;
            }
        }

        @media (max-width: 932px) and (orientation: landscape) {
            body {
                padding: 5px;
                align-items: center;
            }

            .game-container {
                display: flex;
                flex-direction: row;
                gap: 15px;
                padding: 15px;
                margin: 5px;
                max-height: 95vh;
            }

            .game-screen {
                max-width: 60%;
                height: auto;
                max-height: 80vh;
            }

            .controls {
                flex-direction: column;
                margin-top: 0;
                gap: 10px;
                justify-content: center;
            }

            .cartridge-controls {
                position: absolute;
                top: 5px;
                right: 5px;
                flex-direction: row;
                flex-wrap: wrap;
                width: auto;
                max-width: 300px;
            }

            .cartridge-btn {
                width: auto;
                font-size: 11px;
                padding: 8px 10px;
                min-height: 36px;
            }
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 10px;
                margin: 5px;
            }

            .game-screen {
                border: 5px solid #556b2f;
            }

            .cartridge-btn {
                font-size: 12px;
                padding: 10px 12px;
            }

            .dpad {
                grid-template-columns: 44px 44px 44px;
                grid-template-rows: 44px 44px 44px;
            }

            .dpad-btn {
                min-width: 44px;
                min-height: 44px;
                font-size: 16px;
            }

            .btn {
                min-width: 56px;
                min-height: 56px;
                padding: 16px 20px;
                font-size: 14px;
            }

            .fullscreen-btn {
                padding: 10px 12px;
                font-size: 16px;
                top: 5px;
                left: 5px;
            }
        }

        body.fullscreen {
            padding: 0;
        }

        body.fullscreen .game-container {
            width: 100vw;
            height: 100vh;
            max-width: 100vw;
            max-height: 100vh;
            margin: 0;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        body.fullscreen .game-screen {
            max-width: 100%;
            flex: 1;
            height: auto;
            border-width: 5px;
        }

        body.fullscreen .fullscreen-btn {
            position: absolute;
            z-index: 2000;
        }

        .btn:active,
        .dpad-btn:active,
        .cartridge-btn:active,
        .menu-option:active,
        .move-option:active {
            opacity: 0.8;
        }

        .game-container,
        .controls,
        .btn,
        .dpad-btn,
        .menu-option,
        .move-option {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

    </style>
</head>
<body>
    <!-- Mobile Fullscreen Toggle -->
    <button class="fullscreen-btn" onclick="game.toggleFullscreen()" title="Toggle Fullscreen">‚õ∂</button>

    <!-- Accessibility Features -->
    <a href="#game-screen" class="skip-link">Skip to game content</a>

    <!-- Screen reader live region for announcements -->
    <div class="live-region" role="status" aria-live="polite" aria-atomic="true" id="liveRegion"></div>

    <!-- Accessibility Settings Panel -->
    <div class="accessibility-panel" id="accessibilityPanel" role="dialog" aria-labelledby="a11y-panel-title" aria-hidden="true">
        <h2 id="a11y-panel-title">Accessibility Settings</h2>
        <div class="accessibility-option">
            <input type="checkbox" id="highContrastToggle" aria-label="Enable high contrast mode">
            <label for="highContrastToggle">High Contrast Mode</label>
        </div>
        <div class="accessibility-option">
            <input type="checkbox" id="reducedMotionToggle" aria-label="Enable reduced motion">
            <label for="reducedMotionToggle">Reduced Motion</label>
        </div>
        <div class="accessibility-option">
            <input type="checkbox" id="largeTextToggle" aria-label="Enable large text">
            <label for="largeTextToggle">Large Text (120%)</label>
        </div>
        <div class="accessibility-option">
            <input type="checkbox" id="screenReaderMode" aria-label="Enable enhanced screen reader announcements">
            <label for="screenReaderMode">Enhanced Screen Reader</label>
        </div>
        <div class="accessibility-option">
            <label for="textSpeedRange">Text Speed:</label>
            <input type="range" id="textSpeedRange" min="1" max="5" value="3" aria-label="Adjust text display speed">
            <span id="textSpeedValue" aria-live="polite">3</span>
        </div>
        <button class="close-panel-btn" onclick="game.toggleAccessibilityPanel()" aria-label="Close accessibility settings">Close</button>
    </div>


    <div class="game-container">
        <!-- Cartridge Controls -->
        <div class="cartridge-controls">
            <button class="cartridge-btn" onclick="game.loadCartridge()" aria-label="Load game cartridge from file">Load Game</button>
            <button class="cartridge-btn" onclick="game.autoLoadWoWmon()" aria-label="Load WoWmon game automatically">Load WoWmon</button>
            <button class="cartridge-btn" onclick="game.exportSave()" aria-label="Export save game data to file">Export Save</button>
            <button class="cartridge-btn" onclick="game.importSave()" aria-label="Import save game data from file">Import Save</button>
            <button class="cartridge-btn" onclick="game.toggleMute()" aria-label="Toggle audio mute" id="muteBtn">Audio: ON</button>
            <input type="file" id="cartridgeInput" accept=".json" onchange="game.handleCartridgeLoad(event)">
            <input type="file" id="saveInput" accept=".json" onchange="game.handleSaveLoad(event)">
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="game-screen" role="application" aria-label="WoWmon game screen">
            <canvas id="gameCanvas" width="160" height="144" aria-label="Game canvas - visual game display" role="img"></canvas>
            
            <!-- Loading Screen -->
            <div class="loading-screen" id="loadingScreen">
                <h2>WoWmon</h2>
                <p>Pocket Creatures of Azeroth</p>
                <br>
                <p style="font-size: 12px;">Click "Load WoWmon" to start!</p>
            </div>
            
            <!-- UI Overlays -->
            <div class="ui-overlay">
                <!-- Text Box -->
                <div class="text-box" id="textBox" role="dialog" aria-live="polite" aria-label="Game dialogue">
                    <div id="textContent"></div>
                </div>

                <!-- Party Display - Shows active team -->
                <div class="party-display" id="partyDisplay" role="status" aria-label="Active party">
                    <div class="party-slot empty" id="partySlot0">
                        <span class="party-level">L1</span>
                        <span class="party-icon">‚óè</span>
                        <div class="party-hp-mini">
                            <div class="party-hp-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="party-slot empty" id="partySlot1">
                        <span class="party-icon">?</span>
                    </div>
                    <div class="party-slot empty" id="partySlot2">
                        <span class="party-icon">?</span>
                    </div>
                    <div class="party-slot empty" id="partySlot3">
                        <span class="party-icon">?</span>
                    </div>
                    <div class="party-slot empty" id="partySlot4">
                        <span class="party-icon">?</span>
                    </div>
                    <div class="party-slot empty" id="partySlot5">
                        <span class="party-icon">?</span>
                    </div>
                </div>

                <!-- Battle UI -->
                <div class="battle-ui" id="battleUI" role="complementary" aria-label="Battle status information">
                    <div class="creature-info enemy-info">
                        <div id="enemyName">ENEMY</div>
                        <div>Lv.<span id="enemyLevel">5</span></div>
                        <div class="hp-bar">
                            <div class="hp-fill" id="enemyHP" style="width: 100%"></div>
                        </div>
                        <div class="energy-bar" style="margin-top: 5px; background: #333; height: 6px; border-radius: 3px; overflow: hidden; opacity: 0.7;">
                            <div class="energy-fill" id="enemyEnergy" style="width: 0%; height: 100%; background: #ff5555; transition: width 0.1s linear;"></div>
                        </div>
                    </div>
                    <div class="creature-info player-info">
                        <div id="playerName">PLAYER</div>
                        <div>Lv.<span id="playerLevel">5</span></div>
                        <div class="hp-bar">
                            <div class="hp-fill" id="playerHP" style="width: 100%"></div>
                        </div>
                        <div>HP: <span id="playerHPText">20/20</span></div>
                        <div class="energy-bar" style="margin-top: 5px; background: #333; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div class="energy-fill" id="playerEnergy" style="width: 0%; height: 100%; background: #00f2fe; transition: width 0.1s linear;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Move HUD (Replaces Menu) -->
                <div class="move-hud" id="moveHUD" style="display: none; position: absolute; bottom: 10px; left: 10px; right: 10px; display: flex; gap: 10px;">
                    <!-- Generated by JS -->
                </div>

                <!-- Move Selection Menu (Hidden/Legacy) -->
                <div class="move-menu" id="moveMenu" role="menu" aria-label="Move selection menu" style="display: none;">
                    <div class="move-option selected" data-move-index="0">
                        <span id="move0Name">MOVE 1</span>
                        <small>PP: <span id="move0PP">10/10</span></small>
                    </div>
                    <div class="move-option" data-move-index="1">
                        <span id="move1Name">MOVE 2</span>
                        <small>PP: <span id="move1PP">10/10</span></small>
                    </div>
                    <div class="move-option" data-move-index="2">
                        <span id="move2Name">MOVE 3</span>
                        <small>PP: <span id="move2PP">10/10</span></small>
                    </div>
                    <div class="move-option" data-move-index="3">
                        <span id="move3Name">MOVE 4</span>
                        <small>PP: <span id="move3PP">10/10</span></small>
                    </div>
                </div>
                
                <!-- Menus -->
                <div class="menu" id="mainMenu" role="menu" aria-label="Main game menu" style="top: 10px; right: 10px;">
                    <div class="menu-option selected" role="menuitem" tabindex="0" aria-label="View creatures">CREATURES</div>
                    <div class="menu-option" role="menuitem" tabindex="-1" aria-label="Open bag">BAG</div>
                    <div class="menu-option" role="menuitem" tabindex="-1" aria-label="Save game">SAVE</div>
                    <div class="menu-option" role="menuitem" tabindex="-1" aria-label="Exit menu">EXIT</div>
                </div>
                
                <div class="menu" id="battleMenu" role="menu" aria-label="Battle menu" style="bottom: 70px; right: 10px;">
                    <div class="menu-option selected" role="menuitem" tabindex="0" aria-label="Choose fight action">FIGHT</div>
                
                <div class="menu" id="statsMenu" style="top: 10px; left: 10px; right: 10px; max-height: 250px; overflow-y: auto;">
                    <div id="statsContent" style="font-size: 10px; line-height: 1.4;">
                        <strong>STATS</strong><br>
                        Battles Won: <span id="statBattlesWon">0</span><br>
                        Creatures Caught: <span id="statCreaturesCaught">0</span><br>
                        Unique Species: <span id="statUniqueSpecies">0</span><br>
                        Highest Level: <span id="statHighestLevel">0</span><br>
                        Win Streak: <span id="statWinStreak">0</span><br>
                        Max Win Streak: <span id="statMaxWinStreak">0</span><br>
                        Play Time: <span id="statPlayTime">0:00:00</span><br>
                        <br><strong>ACHIEVEMENTS</strong><br>
                        <span id="achievementList">None unlocked</span>
                    </div>
                </div>

                <div class="menu" id="journalMenu" style="top: 10px; left: 10px; right: 10px; max-height: 250px; overflow-y: auto;">
                    <div id="journalContent" style="font-size: 10px; line-height: 1.4;">
                        <strong>JOURNAL</strong><br>
                        <div id="journalEntries">No entries yet</div>
                    </div>
                </div>
                    <div class="menu-option">CREATURES</div>
                    <div class="menu-option">RUN</div>
                </div>

                <!-- Team Builder Menu -->
                <div class="menu" id="teamBuilderMenu" role="menu" aria-label="Team Builder" style="display: none; top: 10px; left: 10px; right: 10px; bottom: 10px; max-height: none;">
                    <div style="background: var(--gb-darkest); color: var(--gb-lightest); padding: 8px; font-size: 14px; font-weight: bold;">
                        TEAM BUILDER
                    </div>
                    <div id="teamParty" style="padding: 8px; border-bottom: 2px solid var(--gb-dark);">
                        <div style="font-size: 12px; margin-bottom: 4px; font-weight: bold;">ACTIVE PARTY:</div>
                        <div id="partySlots"></div>
                    </div>
                    <div id="teamStorage" style="padding: 8px; max-height: 150px; overflow-y: auto;">
                        <div style="font-size: 12px; margin-bottom: 4px; font-weight: bold;">STORAGE:</div>
                        <div id="storageSlots"></div>
                    </div>
                    <div style="padding: 8px; font-size: 10px; border-top: 2px solid var(--gb-dark); background: var(--gb-light);">
                        ‚Üë‚Üì: Navigate | A: Select | B: Back
                    </div>
                </div>

                <!-- Battle Switch Menu -->
                <div class="menu" id="battleSwitchMenu" role="menu" aria-label="Switch Creature" style="display: none; bottom: 70px; right: 10px; max-height: 200px; overflow-y: auto;">
                    <div style="background: var(--gb-darkest); color: var(--gb-lightest); padding: 8px; font-size: 14px; font-weight: bold;">
                        SWITCH CREATURE
                    </div>
                    <div id="switchOptions" style="padding: 8px;"></div>
                    <div style="padding: 8px; font-size: 10px; border-top: 2px solid var(--gb-dark); background: var(--gb-light);">
                        ‚Üë‚Üì: Navigate | A: Switch | B: Cancel
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <div class="control-label">MOVE</div>
                <div class="dpad">
                    <button class="dpad-btn" id="up" data-key="ArrowUp" aria-label="Move up">‚ñ≤</button>
                    <button class="dpad-btn" id="left" data-key="ArrowLeft" aria-label="Move left">‚óÑ</button>
                    <button class="dpad-btn" id="right" data-key="ArrowRight" aria-label="Move right">‚ñ∫</button>
                    <button class="dpad-btn" id="down" data-key="ArrowDown" aria-label="Move down">‚ñº</button>
                </div>
                <div class="keyboard-hint">WASD / Arrow Keys</div>
            </div>
            <div class="control-group">
                <div class="control-label">ACTION</div>
                <div style="display: flex; gap: 20px; align-items: center;">
                    <div style="text-align: center;">
                        <button class="btn" data-key="z" aria-label="Action button A - Confirm and interact">A</button>
                        <div class="keyboard-hint">Z / Space</div>
                        <div class="button-hint">Confirm</div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn" data-key="x" aria-label="Action button B - Cancel and go back">B</button>
                        <div class="keyboard-hint">X / Esc</div>
                        <div class="button-hint">Cancel</div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">MENU</div>
                <div style="display: flex; gap: 20px; align-items: center;">
                    <div style="text-align: center;">
                        <button class="btn" data-key="Enter" aria-label="Start button - Open main menu">START</button>
                        <div class="keyboard-hint">Enter</div>
                        <div class="button-hint">Menu</div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn" data-key="Shift" aria-label="Select button - Open creature quick menu">SELECT</button>
                        <div class="keyboard-hint">Shift</div>
                        <div class="button-hint">Team</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Help -->
        <div style="text-align: center; margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 11px; color: #9bbc0f;">
            <div style="margin-bottom: 5px; font-weight: bold; color: #fff;">QUICK GUIDE:</div>
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <span>üéÆ Move: WASD</span>
                <span>‚úÖ Confirm: Z/Space</span>
                <span>‚ùå Cancel: X/Esc</span>
                <span>üìã Menu: Enter</span>
                <span>üë• Team: Shift</span>
            </div>
        </div>
    </div>

    <script>
        // WoWmon Game Engine
        // ==================================
        // GAME BOY STYLE AUDIO ENGINE
        // ==================================
        class AudioEngine {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.musicGain = null;
                this.sfxGain = null;
                this.settings = { masterVolume: 0.5, musicVolume: 0.7, sfxVolume: 0.8, muted: false };
                this.currentMusic = null;
                this.musicOscillators = [];
                this.musicTimeout = null;
                this.loadSettings();
            }
            init() {
                if (this.audioContext) return;
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.audioContext.createGain();
                    this.masterGain.connect(this.audioContext.destination);
                    this.masterGain.gain.value = this.settings.muted ? 0 : this.settings.masterVolume;
                    this.musicGain = this.audioContext.createGain();
                    this.musicGain.connect(this.masterGain);
                    this.musicGain.gain.value = this.settings.musicVolume;
                    this.sfxGain = this.audioContext.createGain();
                    this.sfxGain.connect(this.masterGain);
                    this.sfxGain.gain.value = this.settings.sfxVolume;
                } catch (e) { console.error('Audio init failed:', e); }
            }
            createPulseWave(frequency, duration, duty = 0.5) {
                if (!this.audioContext) return null;
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                const real = new Float32Array([0, 0, 0, 0]);
                const imag = new Float32Array([0, duty, 0, 0]);
                const wave = this.audioContext.createPeriodicWave(real, imag);
                osc.setPeriodicWave(wave);
                osc.frequency.value = frequency;
                osc.connect(gain);
                return { osc, gain, duration };
            }
            createTriangleWave(frequency, duration) {
                if (!this.audioContext) return null;
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                osc.type = 'triangle';
                osc.frequency.value = frequency;
                osc.connect(gain);
                return { osc, gain, duration };
            }
            createNoise(duration, frequency = 0) {
                if (!this.audioContext) return null;
                const bufferSize = this.audioContext.sampleRate * duration;
                const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.audioContext.createBufferSource();
                noise.buffer = buffer;
                const filter = this.audioContext.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = frequency || 1000;
                filter.Q.value = 1;
                const gain = this.audioContext.createGain();
                noise.connect(filter);
                filter.connect(gain);
                return { osc: noise, gain, duration };
            }
            playSFX(type) {
                if (!this.audioContext || this.settings.muted) return;
                this.init();
                const now = this.audioContext.currentTime;
                switch(type) {
                    case 'menu_move': this.playMenuMove(now); break;
                    case 'menu_select': this.playMenuSelect(now); break;
                    case 'menu_back': this.playMenuBack(now); break;
                    case 'battle_start': this.playBattleStart(now); break;
                    case 'attack': this.playAttack(now); break;
                    case 'damage': this.playDamage(now); break;
                    case 'heal': this.playHeal(now); break;
                    case 'level_up': this.playLevelUp(now); break;
                    case 'victory': this.playVictory(now); break;
                    case 'encounter': this.playEncounter(now); break;
                    case 'step': this.playStep(now); break;
                    case 'door': this.playDoor(now); break;
                }
            }
            playMenuMove(now) {
                const w = this.createPulseWave(800, 0.05);
                if (!w) return;
                w.gain.gain.setValueAtTime(0.1, now);
                w.gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                w.gain.connect(this.sfxGain);
                w.osc.start(now);
                w.osc.stop(now + 0.05);
            }
            playMenuSelect(now) {
                const w1 = this.createPulseWave(1200, 0.1);
                const w2 = this.createPulseWave(1600, 0.1);
                if (!w1 || !w2) return;
                w1.gain.gain.setValueAtTime(0.15, now);
                w1.gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                w1.gain.connect(this.sfxGain);
                w1.osc.start(now);
                w1.osc.stop(now + 0.1);
                w2.gain.gain.setValueAtTime(0.15, now + 0.05);
                w2.gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                w2.gain.connect(this.sfxGain);
                w2.osc.start(now + 0.05);
                w2.osc.stop(now + 0.15);
            }
            playMenuBack(now) {
                const w = this.createPulseWave(600, 0.1);
                if (!w) return;
                w.osc.frequency.exponentialRampToValueAtTime(400, now + 0.1);
                w.gain.gain.setValueAtTime(0.15, now);
                w.gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                w.gain.connect(this.sfxGain);
                w.osc.start(now);
                w.osc.stop(now + 0.1);
            }
            playBattleStart(now) {
                [523, 587, 659, 784].forEach((freq, i) => {
                    const w = this.createPulseWave(freq, 0.15);
                    if (!w) return;
                    w.gain.gain.setValueAtTime(0.2, now + i * 0.1);
                    w.gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.15);
                    w.gain.connect(this.sfxGain);
                    w.osc.start(now + i * 0.1);
                    w.osc.stop(now + i * 0.1 + 0.15);
                });
            }
            playAttack(now) {
                const w = this.createNoise(0.1, 2000);
                if (!w) return;
                w.gain.gain.setValueAtTime(0.3, now);
                w.gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                w.gain.connect(this.sfxGain);
                w.osc.start(now);
                w.osc.stop(now + 0.1);
            }
            playDamage(now) {
                const w = this.createPulseWave(200, 0.2);
                if (!w) return;
                w.osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                w.gain.gain.setValueAtTime(0.25, now);
                w.gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                w.gain.connect(this.sfxGain);
                w.osc.start(now);
                w.osc.stop(now + 0.2);
            }
            playHeal(now) {
                [523, 659, 784, 1047].forEach((freq, i) => {
                    const w = this.createPulseWave(freq, 0.1);
                    if (!w) return;
                    w.gain.gain.setValueAtTime(0.15, now + i * 0.08);
                    w.gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.08 + 0.1);
                    w.gain.connect(this.sfxGain);
                    w.osc.start(now + i * 0.08);
                    w.osc.stop(now + i * 0.08 + 0.1);
                });
            }
            playLevelUp(now) {
                [523, 659, 784, 1047, 1319, 1568].forEach((freq, i) => {
                    const w = this.createPulseWave(freq, 0.2);
                    if (!w) return;
                    w.gain.gain.setValueAtTime(0.2, now + i * 0.15);
                    w.gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.15 + 0.2);
                    w.gain.connect(this.sfxGain);
                    w.osc.start(now + i * 0.15);
                    w.osc.stop(now + i * 0.15 + 0.2);
                });
            }
            playVictory(now) {
                [523, 523, 523, 659, 784, 659, 784].forEach((freq, i) => {
                    const w = this.createPulseWave(freq, 0.25);
                    if (!w) return;
                    w.gain.gain.setValueAtTime(0.25, now + i * 0.2);
                    w.gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.2 + 0.25);
                    w.gain.connect(this.sfxGain);
                    w.osc.start(now + i * 0.2);
                    w.osc.stop(now + i * 0.2 + 0.25);
                });
            }
            playEncounter(now) {
                const w = this.createPulseWave(1000, 0.3);
                if (!w) return;
                w.osc.frequency.exponentialRampToValueAtTime(2000, now + 0.15);
                w.osc.frequency.exponentialRampToValueAtTime(500, now + 0.3);
                w.gain.gain.setValueAtTime(0.2, now);
                w.gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                w.gain.connect(this.sfxGain);
                w.osc.start(now);
                w.osc.stop(now + 0.3);
            }
            playStep(now) {
                const w = this.createNoise(0.05, 400);
                if (!w) return;
                w.gain.gain.setValueAtTime(0.05, now);
                w.gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                w.gain.connect(this.sfxGain);
                w.osc.start(now);
                w.osc.stop(now + 0.05);
            }
            playDoor(now) {
                const w = this.createPulseWave(400, 0.2);
                if (!w) return;
                w.osc.frequency.linearRampToValueAtTime(300, now + 0.2);
                w.gain.gain.setValueAtTime(0.15, now);
                w.gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                w.gain.connect(this.sfxGain);
                w.osc.start(now);
                w.osc.stop(now + 0.2);
            }
            playMusic(theme) {
                if (this.currentMusic === theme) return;
                this.stopMusic();
                this.currentMusic = theme;
                if (!this.audioContext || this.settings.muted) return;
                this.init();
                if (theme === 'overworld') this.playOverworldMusic();
                else if (theme === 'battle') this.playBattleMusic();
                else if (theme === 'victory') this.playVictoryMusic();
                else if (theme === 'title') this.playTitleMusic();
            }
            stopMusic() {
                this.musicOscillators.forEach(osc => { try { osc.stop(); } catch(e) {} });
                this.musicOscillators = [];
                if (this.musicTimeout) { clearTimeout(this.musicTimeout); this.musicTimeout = null; }
                this.currentMusic = null;
            }
            playOverworldMusic() {
                if (!this.audioContext) return;
                const bpm = 120, bd = 60 / bpm, now = this.audioContext.currentTime;
                const melody = [{freq:523,dur:0.5},{freq:659,dur:0.5},{freq:784,dur:0.5},{freq:659,dur:0.5},{freq:523,dur:0.5},{freq:392,dur:0.5},{freq:440,dur:1.0},{freq:494,dur:0.5},{freq:523,dur:0.5},{freq:587,dur:0.5},{freq:523,dur:0.5},{freq:494,dur:0.5},{freq:440,dur:0.5},{freq:523,dur:1.0}];
                const bass = [{freq:131,dur:1.0},{freq:165,dur:1.0},{freq:196,dur:1.0},{freq:147,dur:1.0},{freq:131,dur:1.0},{freq:165,dur:1.0},{freq:196,dur:1.0},{freq:147,dur:1.0}];
                let time = now;
                melody.forEach(n => {
                    const w = this.createPulseWave(n.freq, n.dur * bd, 0.25);
                    if (w) {
                        w.gain.gain.setValueAtTime(0.15, time);
                        w.gain.gain.exponentialRampToValueAtTime(0.01, time + n.dur * bd);
                        w.gain.connect(this.musicGain);
                        w.osc.start(time);
                        w.osc.stop(time + n.dur * bd);
                        this.musicOscillators.push(w.osc);
                    }
                    time += n.dur * bd;
                });
                time = now;
                bass.forEach(n => {
                    const w = this.createTriangleWave(n.freq, n.dur * bd);
                    if (w) {
                        w.gain.gain.setValueAtTime(0.1, time);
                        w.gain.gain.exponentialRampToValueAtTime(0.01, time + n.dur * bd);
                        w.gain.connect(this.musicGain);
                        w.osc.start(time);
                        w.osc.stop(time + n.dur * bd);
                        this.musicOscillators.push(w.osc);
                    }
                    time += n.dur * bd;
                });
                const totalDur = melody.reduce((sum, n) => sum + n.dur * bd, 0);
                this.musicTimeout = setTimeout(() => { if (this.currentMusic === 'overworld') this.playOverworldMusic(); }, totalDur * 1000);
            }
            playBattleMusic() {
                if (!this.audioContext) return;
                const bpm = 140, bd = 60 / bpm, now = this.audioContext.currentTime;
                const melody = [{freq:659,dur:0.25},{freq:659,dur:0.25},{freq:659,dur:0.25},{freq:523,dur:0.25},{freq:659,dur:0.25},{freq:784,dur:0.5},{freq:392,dur:0.5},{freq:523,dur:0.25},{freq:392,dur:0.5},{freq:330,dur:0.5},{freq:440,dur:0.25},{freq:494,dur:0.25},{freq:466,dur:0.25},{freq:440,dur:0.25},{freq:392,dur:0.33},{freq:659,dur:0.33},{freq:784,dur:0.33},{freq:880,dur:0.25},{freq:784,dur:0.25},{freq:659,dur:0.5}];
                const bass = [{freq:165,dur:0.5},{freq:165,dur:0.5},{freq:131,dur:0.5},{freq:131,dur:0.5},{freq:147,dur:0.5},{freq:147,dur:0.5},{freq:196,dur:0.5},{freq:196,dur:0.5}];
                let time = now;
                melody.forEach(n => {
                    const w = this.createPulseWave(n.freq, n.dur * bd, 0.5);
                    if (w) {
                        w.gain.gain.setValueAtTime(0.2, time);
                        w.gain.gain.exponentialRampToValueAtTime(0.01, time + n.dur * bd);
                        w.gain.connect(this.musicGain);
                        w.osc.start(time);
                        w.osc.stop(time + n.dur * bd);
                        this.musicOscillators.push(w.osc);
                    }
                    time += n.dur * bd;
                });
                time = now;
                bass.forEach(n => {
                    const w = this.createTriangleWave(n.freq, n.dur * bd);
                    if (w) {
                        w.gain.gain.setValueAtTime(0.15, time);
                        w.gain.gain.exponentialRampToValueAtTime(0.01, time + n.dur * bd);
                        w.gain.connect(this.musicGain);
                        w.osc.start(time);
                        w.osc.stop(time + n.dur * bd);
                        this.musicOscillators.push(w.osc);
                    }
                    time += n.dur * bd;
                });
                time = now;
                for (let i = 0; i < 16; i++) {
                    const w = this.createNoise(0.05, 800);
                    if (w) {
                        w.gain.gain.setValueAtTime(0.1, time);
                        w.gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
                        w.gain.connect(this.musicGain);
                        w.osc.start(time);
                        w.osc.stop(time + 0.05);
                        this.musicOscillators.push(w.osc);
                    }
                    time += bd * 0.5;
                }
                const totalDur = melody.reduce((sum, n) => sum + n.dur * bd, 0);
                this.musicTimeout = setTimeout(() => { if (this.currentMusic === 'battle') this.playBattleMusic(); }, totalDur * 1000);
            }
            playVictoryMusic() {
                if (!this.audioContext) return;
                const bpm = 120, bd = 60 / bpm, now = this.audioContext.currentTime;
                const melody = [{freq:523,dur:0.25},{freq:523,dur:0.25},{freq:523,dur:0.25},{freq:523,dur:0.25},{freq:659,dur:0.5},{freq:523,dur:0.5},{freq:784,dur:1.5}];
                let time = now;
                melody.forEach(n => {
                    const w = this.createPulseWave(n.freq, n.dur * bd, 0.25);
                    if (w) {
                        w.gain.gain.setValueAtTime(0.25, time);
                        w.gain.gain.exponentialRampToValueAtTime(0.01, time + n.dur * bd);
                        w.gain.connect(this.musicGain);
                        w.osc.start(time);
                        w.osc.stop(time + n.dur * bd);
                        this.musicOscillators.push(w.osc);
                    }
                    time += n.dur * bd;
                });
                this.currentMusic = null;
            }
            playTitleMusic() {
                if (!this.audioContext) return;
                const bpm = 100, bd = 60 / bpm, now = this.audioContext.currentTime;
                const melody = [{freq:392,dur:0.5},{freq:523,dur:0.5},{freq:659,dur:0.5},{freq:523,dur:0.5},{freq:587,dur:1.0},{freq:494,dur:1.0},{freq:440,dur:0.5},{freq:523,dur:0.5},{freq:587,dur:0.5},{freq:523,dur:0.5},{freq:494,dur:1.0},{freq:440,dur:1.0}];
                const bass = [{freq:131,dur:2.0},{freq:147,dur:2.0},{freq:110,dur:2.0},{freq:131,dur:2.0}];
                let time = now;
                melody.forEach(n => {
                    const w = this.createPulseWave(n.freq, n.dur * bd, 0.25);
                    if (w) {
                        w.gain.gain.setValueAtTime(0.18, time);
                        w.gain.gain.exponentialRampToValueAtTime(0.01, time + n.dur * bd);
                        w.gain.connect(this.musicGain);
                        w.osc.start(time);
                        w.osc.stop(time + n.dur * bd);
                        this.musicOscillators.push(w.osc);
                    }
                    time += n.dur * bd;
                });
                time = now;
                bass.forEach(n => {
                    const w = this.createTriangleWave(n.freq, n.dur * bd);
                    if (w) {
                        w.gain.gain.setValueAtTime(0.12, time);
                        w.gain.gain.exponentialRampToValueAtTime(0.01, time + n.dur * bd);
                        w.gain.connect(this.musicGain);
                        w.osc.start(time);
                        w.osc.stop(time + n.dur * bd);
                        this.musicOscillators.push(w.osc);
                    }
                    time += n.dur * bd;
                });
                const totalDur = melody.reduce((sum, n) => sum + n.dur * bd, 0);
                this.musicTimeout = setTimeout(() => { if (this.currentMusic === 'title') this.playTitleMusic(); }, totalDur * 1000);
            }
            setMasterVolume(value) {
                this.settings.masterVolume = Math.max(0, Math.min(1, value));
                if (this.masterGain && !this.settings.muted) this.masterGain.gain.value = this.settings.masterVolume;
                this.saveSettings();
            }
            setMusicVolume(value) {
                this.settings.musicVolume = Math.max(0, Math.min(1, value));
                if (this.musicGain) this.musicGain.gain.value = this.settings.musicVolume;
                this.saveSettings();
            }
            setSFXVolume(value) {
                this.settings.sfxVolume = Math.max(0, Math.min(1, value));
                if (this.sfxGain) this.sfxGain.gain.value = this.settings.sfxVolume;
                this.saveSettings();
            }
            toggleMute() {
                this.settings.muted = !this.settings.muted;
                if (this.masterGain) this.masterGain.gain.value = this.settings.muted ? 0 : this.settings.masterVolume;
                this.saveSettings();
                return this.settings.muted;
            }
            saveSettings() {
                localStorage.setItem('wowmon_audio_settings', JSON.stringify(this.settings));
            }
            loadSettings() {
                const saved = localStorage.getItem('wowmon_audio_settings');
                if (saved) {
                    try { this.settings = {...this.settings, ...JSON.parse(saved)}; }
                    catch(e) { console.error('Failed to load audio settings:', e); }
                }
            }
        }

        class GameEngine {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.ctx.imageSmoothingEnabled = false;

                this.cartridge = null;
                this.saveData = null;
                this.isRunning = false;

                this.state = 'LOADING';
                this.previousState = null;
                this.player = null;
                this.map = null;
                this.creatures = [];

                this.keys = {};
                this.lastFrame = 0;
                this.frameCount = 0;

                this.tileSize = 8;
                this.screenTilesX = 20;
                this.screenTilesY = 18;

                // Movement
                this.moveTimer = 0;
                this.moveDelay = 150; // ms between moves
                this.isMoving = false;

                // Battle state
                this.battle = null;
                this.battleMenuIndex = 0;
                this.moveMenuIndex = 0;
                this.showingMoves = false;

                // Menu state
                this.menuIndex = 0;

                // Text state
                this.textQueue = [];
                this.currentText = null;

                // Audio Engine
                this.audio = new AudioEngine();
                this.textTimer = 0;

                // Team System
                this.teamMenuIndex = 0;
                this.domCache = { initialized: false };
                this.dirtyFlags = { team: false, battle: false };

                this.init();
            }
            
            init() {
                this.setupInput();
                this.showLoadingScreen();
                this.initializeAccessibility();
                this.gameLoop();
            }
            
            setupInput() {
                // Keyboard input with key mapping
                document.addEventListener('keydown', (e) => {
                    let key = e.key;

                    // Map alternative keys
                    const keyMap = {
                        ' ': 'z',           // Space ‚Üí A button
                        'Escape': 'x',      // Escape ‚Üí B button
                        'w': 'ArrowUp',     // WASD support
                        'a': 'ArrowLeft',
                        's': 'ArrowDown',
                        'd': 'ArrowRight',
                        'W': 'ArrowUp',
                        'A': 'ArrowLeft',
                        'S': 'ArrowDown',
                        'D': 'ArrowRight'
                    };

                    if (keyMap[key]) {
                        key = keyMap[key];
                    }

                    if (!this.keys[key]) {
                        this.keys[key] = true;
                        this.handleKeyPress(key);
                    }
                    e.preventDefault();
                });

                document.addEventListener('keyup', (e) => {
                    let key = e.key;

                    // Map alternative keys
                    const keyMap = {
                        ' ': 'z',
                        'Escape': 'x',
                        'w': 'ArrowUp',
                        'a': 'ArrowLeft',
                        's': 'ArrowDown',
                        'd': 'ArrowRight',
                        'W': 'ArrowUp',
                        'A': 'ArrowLeft',
                        'S': 'ArrowDown',
                        'D': 'ArrowRight'
                    };

                    if (keyMap[key]) {
                        key = keyMap[key];
                    }

                    this.keys[key] = false;
                    e.preventDefault();
                });
                
                // Button input
                document.querySelectorAll('[data-key]').forEach(btn => {
                    btn.addEventListener('mousedown', () => {
                        if (!this.keys[btn.dataset.key]) {
                            this.keys[btn.dataset.key] = true;
                            this.handleKeyPress(btn.dataset.key);
                        }
                    });
                    btn.addEventListener('mouseup', () => {
                        this.keys[btn.dataset.key] = false;
                    });
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        if (!this.keys[btn.dataset.key]) {
                            this.keys[btn.dataset.key] = true;
                            this.handleKeyPress(btn.dataset.key);
                            this.vibrate(10);
                        }
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.keys[btn.dataset.key] = false;
                    });
                });

                // Canvas touch/swipe controls for mobile
                this.setupCanvasTouch();
            }

            vibrate(duration = 10) {
                if (navigator.vibrate) {
                    navigator.vibrate(duration);
                }
            }

            setupCanvasTouch() {
                const canvas = this.canvas;
                let touchStartX = 0;
                let touchStartY = 0;
                let touchStartTime = 0;
                const SWIPE_THRESHOLD = 30;
                const TAP_TIME_THRESHOLD = 200;
                const TAP_DISTANCE_THRESHOLD = 10;

                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        touchStartX = touch.clientX;
                        touchStartY = touch.clientY;
                        touchStartTime = Date.now();
                    }
                }, { passive: false });

                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                }, { passive: false });

                canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (e.changedTouches.length === 1) {
                        const touch = e.changedTouches[0];
                        const touchEndX = touch.clientX;
                        const touchEndY = touch.clientY;
                        const touchEndTime = Date.now();

                        const deltaX = touchEndX - touchStartX;
                        const deltaY = touchEndY - touchStartY;
                        const deltaTime = touchEndTime - touchStartTime;
                        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

                        // Detect tap
                        if (distance < TAP_DISTANCE_THRESHOLD && deltaTime < TAP_TIME_THRESHOLD) {
                            this.handleKeyPress('z');
                            this.vibrate(15);
                            return;
                        }

                        // Detect swipe
                        if (distance > SWIPE_THRESHOLD) {
                            const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;

                            if (angle > -45 && angle <= 45) {
                                this.handleKeyPress('ArrowRight');
                                this.vibrate(10);
                            } else if (angle > 45 && angle <= 135) {
                                this.handleKeyPress('ArrowDown');
                                this.vibrate(10);
                            } else if (angle > 135 || angle <= -135) {
                                this.handleKeyPress('ArrowLeft');
                                this.vibrate(10);
                            } else if (angle > -135 && angle <= -45) {
                                this.handleKeyPress('ArrowUp');
                                this.vibrate(10);
                            }
                        }
                    }
                }, { passive: false });

                // Two-finger tap for menu
                canvas.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        setTimeout(() => {
                            if (e.touches.length === 2) {
                                this.handleKeyPress('Enter');
                                this.vibrate(20);
                            }
                        }, 100);
                    }
                }, { passive: false });
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.body.requestFullscreen().then(() => {
                        document.body.classList.add('fullscreen');
                        this.vibrate(15);
                        const btn = document.querySelector('.fullscreen-btn');
                        if (btn) btn.textContent = '‚úï';
                    }).catch(err => {
                        console.log('Fullscreen error:', err);
                    });
                } else {
                    document.exitFullscreen().then(() => {
                        document.body.classList.remove('fullscreen');
                        this.vibrate(15);
                        const btn = document.querySelector('.fullscreen-btn');
                        if (btn) btn.textContent = '‚õ∂';
                    });
                }
            }

            handleKeyPress(key) {
                // Handle immediate actions based on state
                switch (this.state) {
                    case 'BATTLE':
                        this.handleBattleInput(key);
                        break;
                    case 'MENU':
                        this.handleMenuInput(key);
                        break;
                    case 'TEAM_BUILDER':
                        this.handleTeamBuilderInput(key);
                        break;
                    case 'BATTLE_SWITCH':
                        this.handleBattleSwitchInput(key);
                        break;
                    case 'TEXT':
                        if (key === 'z' || key === 'Enter') {
                            this.advanceText();
                        }
                        break;
                }
            }
            
            autoLoadWoWmon() {
                // Embed the WoWmon cartridge data directly
                this.cartridge = {
                    "name": "WoWmon",
                    "version": "1.0",
                    "author": "Blizzard & Nintendo",
                    "description": "Pocket Creatures of Azeroth - A Warcraft-themed creature collection game",
                    "startingMap": "goldshire",
                    "starters": ["murloc", "wisp", "imp"],
                    
                    "tiles": {
                        "0": { "id": 0, "name": "void", "walkable": false, "color": "#0f380f", "symbol": "" },
                        "1": { "id": 1, "name": "grass", "walkable": true, "color": "#8bac0f", "symbol": "," },
                        "2": { "id": 2, "name": "tree", "walkable": false, "color": "#306230", "symbol": "‚ô†" },
                        "3": { "id": 3, "name": "water", "walkable": false, "color": "#306230", "symbol": "‚âà" },
                        "4": { "id": 4, "name": "stone", "walkable": false, "color": "#556b2f", "symbol": "‚ñà" },
                        "5": { "id": 5, "name": "path", "walkable": true, "color": "#9bbc0f", "symbol": "." },
                        "6": { "id": 6, "name": "building", "walkable": false, "color": "#556b2f", "symbol": "‚åÇ" },
                        "7": { "id": 7, "name": "door", "walkable": true, "color": "#8b956d", "symbol": "‚ñ¢" },
                        "8": { "id": 8, "name": "sign", "walkable": false, "color": "#8b956d", "symbol": "!" },
                        "9": { "id": 9, "name": "tall_grass", "walkable": true, "encounter": true, "color": "#556b2f", "symbol": "w" },
                        "10": { "id": 10, "name": "flower", "walkable": true, "color": "#9bbc0f", "symbol": "‚úø" }
                    },
                    
                    "creatures": {
                        "murloc": {
                            "id": "murloc",
                            "name": "MURLOC",
                            "type": ["water", "beast"],
                            "baseHp": 45,
                            "baseAttack": 49,
                            "baseDefense": 49,
                            "baseSpeed": 45,
                            "evolveLevel": 16,
                            "evolveTo": "murloc_warrior",
                            "moves": ["tackle", "bubble", "water_gun", "bite"],
                            "description": "The amphibious Murloc makes strange gurgling sounds."
                        },
                        "murloc_warrior": {
                            "id": "murloc_warrior",
                            "name": "MURLOCWARRIOR",
                            "type": ["water", "beast"],
                            "baseHp": 60,
                            "baseAttack": 62,
                            "baseDefense": 63,
                            "baseSpeed": 60,
                            "evolveLevel": 32,
                            "evolveTo": "murloc_king",
                            "moves": ["tackle", "bubble", "water_gun", "bite"],
                            "description": "Armed with a spear, this Murloc has mastered combat."
                        },
                        "murloc_king": {
                            "id": "murloc_king",
                            "name": "MURLOCKING",
                            "type": ["water", "beast", "magic"],
                            "baseHp": 80,
                            "baseAttack": 82,
                            "baseDefense": 83,
                            "baseSpeed": 80,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["hydro_pump", "ice_beam", "thunderbolt", "recover"],
                            "description": "The ruler of all Murlocs, commanding both sea and magic."
                        },
                        "forest_wisp": {
                            "id": "forest_wisp",
                            "name": "FORESTWISP",
                            "type": ["nature", "spirit"],
                            "baseHp": 35,
                            "baseAttack": 30,
                            "baseDefense": 35,
                            "baseSpeed": 70,
                            "evolveLevel": 18,
                            "evolveTo": "ancient_wisp",
                            "moves": ["glow", "nature_power", "sleep_powder", "magical_leaf"],
                            "description": "A spirit of the forest that glows with ethereal light."
                        },
                        "ancient_wisp": {
                            "id": "ancient_wisp",
                            "name": "ANCIENTWISP",
                            "type": ["nature", "spirit"],
                            "baseHp": 65,
                            "baseAttack": 65,
                            "baseDefense": 65,
                            "baseSpeed": 90,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["solar_beam", "heal_pulse", "energy_ball", "psychic"],
                            "description": "An ancient forest spirit with immense natural power."
                        },
                        "imp": {
                            "id": "imp",
                            "name": "IMP",
                            "type": ["fire", "demon"],
                            "baseHp": 40,
                            "baseAttack": 55,
                            "baseDefense": 35,
                            "baseSpeed": 55,
                            "evolveLevel": 20,
                            "evolveTo": "felguard",
                            "moves": ["firebolt", "scratch", "ember", "confuse_ray"],
                            "description": "A mischievous demon that loves to cause chaos."
                        },
                        "felguard": {
                            "id": "felguard",
                            "name": "FELGUARD",
                            "type": ["fire", "demon"],
                            "baseHp": 70,
                            "baseAttack": 85,
                            "baseDefense": 65,
                            "baseSpeed": 65,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["inferno", "shadow_ball", "drain_life", "dark_pulse"],
                            "description": "A powerful demon warrior from the Burning Legion."
                        },
                        "gnoll": {
                            "id": "gnoll",
                            "name": "GNOLL",
                            "type": ["beast"],
                            "baseHp": 45,
                            "baseAttack": 60,
                            "baseDefense": 45,
                            "baseSpeed": 50,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["bite", "howl", "slash", "crunch"],
                            "description": "A hyena-like humanoid that hunts in packs."
                        },
                        "kobold": {
                            "id": "kobold",
                            "name": "KOBOLD",
                            "type": ["earth", "beast"],
                            "baseHp": 30,
                            "baseAttack": 40,
                            "baseDefense": 35,
                            "baseSpeed": 40,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["dig", "rock_throw", "candle_light", "tackle"],
                            "description": "You no take candle! A mining creature of the deep."
                        },
                        "wolf": {
                            "id": "wolf",
                            "name": "WOLF",
                            "type": ["beast"],
                            "baseHp": 50,
                            "baseAttack": 65,
                            "baseDefense": 50,
                            "baseSpeed": 65,
                            "evolveLevel": 30,
                            "evolveTo": "dire_wolf",
                            "moves": ["bite", "howl", "quick_attack", "tackle"],
                            "description": "A loyal predator of the wild."
                        },
                        "dire_wolf": {
                            "id": "dire_wolf",
                            "name": "DIREWOLF",
                            "type": ["beast", "shadow"],
                            "baseHp": 75,
                            "baseAttack": 90,
                            "baseDefense": 70,
                            "baseSpeed": 85,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["crunch", "shadow_claw", "ice_fang", "iron_tail"],
                            "description": "An alpha predator with supernatural strength."
                        },
                        "treant": {
                            "id": "treant",
                            "name": "TREANT",
                            "type": ["nature", "earth"],
                            "baseHp": 100,
                            "baseAttack": 85,
                            "baseDefense": 90,
                            "baseSpeed": 30,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["vine_whip", "root", "wood_hammer", "synthesis"],
                            "description": "An ancient tree given life by druidic magic."
                        },
                        "naga": {
                            "id": "naga",
                            "name": "NAGA",
                            "type": ["water", "magic"],
                            "baseHp": 65,
                            "baseAttack": 75,
                            "baseDefense": 65,
                            "baseSpeed": 75,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["water_pulse", "frost_shock", "lightning_bolt", "tidal_wave"],
                            "description": "Former night elves transformed by the sea."
                        },
                        "elemental": {
                            "id": "elemental",
                            "name": "ELEMENTAL",
                            "type": ["magic"],
                            "baseHp": 60,
                            "baseAttack": 65,
                            "baseDefense": 60,
                            "baseSpeed": 60,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["elemental_blast", "barrier", "explosion", "cosmic_power"],
                            "description": "Pure magical energy given form."
                        },
                        "whelp": {
                            "id": "whelp",
                            "name": "WHELP",
                            "type": ["dragon"],
                            "baseHp": 50,
                            "baseAttack": 60,
                            "baseDefense": 50,
                            "baseSpeed": 55,
                            "evolveLevel": 25,
                            "evolveTo": "drake",
                            "moves": ["dragon_breath", "tackle", "bite", "wing_attack"],
                            "description": "A young dragon still learning to control its power."
                        },
                        "drake": {
                            "id": "drake",
                            "name": "DRAKE",
                            "type": ["dragon", "fire"],
                            "baseHp": 75,
                            "baseAttack": 85,
                            "baseDefense": 75,
                            "baseSpeed": 75,
                            "evolveLevel": 45,
                            "evolveTo": "dragon",
                            "moves": ["dragon_claw", "flame_burst", "dragon_breath", "aerial_ace"],
                            "description": "An adolescent dragon with impressive aerial abilities."
                        },
                        "dragon": {
                            "id": "dragon",
                            "name": "DRAGON",
                            "type": ["dragon", "fire"],
                            "baseHp": 100,
                            "baseAttack": 110,
                            "baseDefense": 95,
                            "baseSpeed": 95,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["dragon_rage", "inferno", "outrage", "hyper_beam"],
                            "description": "A mighty dragon, apex predator of the skies."
                        },
                        "ghoul": {
                            "id": "ghoul",
                            "name": "GHOUL",
                            "type": ["undead", "shadow"],
                            "baseHp": 55,
                            "baseAttack": 65,
                            "baseDefense": 45,
                            "baseSpeed": 50,
                            "evolveLevel": 22,
                            "evolveTo": "abomination",
                            "moves": ["plague_strike", "shadow_claw", "bite", "leer"],
                            "description": "A reanimated corpse serving the Scourge."
                        },
                        "abomination": {
                            "id": "abomination",
                            "name": "ABOMINATION",
                            "type": ["undead", "shadow"],
                            "baseHp": 90,
                            "baseAttack": 95,
                            "baseDefense": 80,
                            "baseSpeed": 40,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["toxic_sludge", "body_slam", "plague_strike", "dark_pulse"],
                            "description": "A massive construct of stitched corpses and bile."
                        },
                        "skeleton": {
                            "id": "skeleton",
                            "name": "SKELETON",
                            "type": ["undead"],
                            "baseHp": 40,
                            "baseAttack": 50,
                            "baseDefense": 40,
                            "baseSpeed": 45,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["bone_club", "tackle", "leer", "curse"],
                            "description": "An animated skeleton warrior of the Scourge."
                        },
                        "orc_grunt": {
                            "id": "orc_grunt",
                            "name": "ORCGRUNT",
                            "type": ["beast", "warrior"],
                            "baseHp": 65,
                            "baseAttack": 75,
                            "baseDefense": 60,
                            "baseSpeed": 55,
                            "evolveLevel": 28,
                            "evolveTo": "orc_warlord",
                            "moves": ["battle_cry", "slash", "stomp", "rage"],
                            "description": "A fierce warrior of the Horde."
                        },
                        "orc_warlord": {
                            "id": "orc_warlord",
                            "name": "ORCWARLORD",
                            "type": ["beast", "warrior"],
                            "baseHp": 90,
                            "baseAttack": 105,
                            "baseDefense": 85,
                            "baseSpeed": 70,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["cleave", "bladestorm", "battle_shout", "execute"],
                            "description": "A legendary warrior who commands armies."
                        },
                        "banshee": {
                            "id": "banshee",
                            "name": "BANSHEE",
                            "type": ["undead", "spirit"],
                            "baseHp": 60,
                            "baseAttack": 70,
                            "baseDefense": 55,
                            "baseSpeed": 80,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["wail", "curse", "shadow_bolt", "possession"],
                            "description": "A tormented spirit that feeds on anguish."
                        },
                        "spider": {
                            "id": "spider",
                            "name": "SPIDER",
                            "type": ["beast", "poison"],
                            "baseHp": 45,
                            "baseAttack": 55,
                            "baseDefense": 50,
                            "baseSpeed": 65,
                            "evolveLevel": 20,
                            "evolveTo": "nerubian",
                            "moves": ["web_shot", "poison_sting", "bite", "trap"],
                            "description": "A giant arachnid lurking in dark places."
                        },
                        "nerubian": {
                            "id": "nerubian",
                            "name": "NERUBIAN",
                            "type": ["beast", "poison", "shadow"],
                            "baseHp": 70,
                            "baseAttack": 80,
                            "baseDefense": 75,
                            "baseSpeed": 85,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["crypt_fiend", "web_wrap", "toxic_bite", "burrow"],
                            "description": "An intelligent spider-being from Azjol-Nerub."
                        },
                        "phoenix": {
                            "id": "phoenix",
                            "name": "PHOENIX",
                            "type": ["fire", "spirit"],
                            "baseHp": 75,
                            "baseAttack": 85,
                            "baseDefense": 70,
                            "baseSpeed": 100,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["flame_strike", "rebirth", "aerial_ace", "sacred_fire"],
                            "description": "An immortal firebird that resurrects from ashes."
                        },
                        "quilboar": {
                            "id": "quilboar",
                            "name": "QUILBOAR",
                            "type": ["beast", "earth"],
                            "baseHp": 60,
                            "baseAttack": 65,
                            "baseDefense": 70,
                            "baseSpeed": 45,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["thorn_volley", "ram", "rock_throw", "intimidate"],
                            "description": "A boar-like humanoid covered in quills."
                        },
                        "felhound": {
                            "id": "felhound",
                            "name": "FELHOUND",
                            "type": ["demon", "magic"],
                            "baseHp": 55,
                            "baseAttack": 60,
                            "baseDefense": 60,
                            "baseSpeed": 70,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["mana_drain", "fel_bite", "devour_magic", "shadow_bolt"],
                            "description": "A demonic hound that feeds on magic."
                        },
                        "infernal": {
                            "id": "infernal",
                            "name": "INFERNAL",
                            "type": ["demon", "fire", "earth"],
                            "baseHp": 95,
                            "baseAttack": 100,
                            "baseDefense": 100,
                            "baseSpecialAttack": 110,
                            "baseSpecialDefense": 90,
                            "baseSpeed": 35,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["meteor_strike", "immolate", "earthquake", "stomp"],
                            "description": "A massive demon of living stone and flame."
                        },
                        "murloc": {
                            "id": "murloc",
                            "name": "MURLOC",
                            "type": ["water"],
                            "baseHp": 40,
                            "baseAttack": 45,
                            "baseDefense": 40,
                            "baseSpecialAttack": 50,
                            "baseSpecialDefense": 45,
                            "baseSpeed": 60,
                            "evolveLevel": 18,
                            "evolveTo": "murloc_warrior",
                            "moves": ["bubble", "tackle", "water_gun", "bite"],
                            "ability": "swift_swim",
                            "description": "An amphibious creature that lives near coastlines."
                        },
                        "murloc_warrior": {
                            "id": "murloc_warrior",
                            "name": "MURWARRIOR",
                            "type": ["water", "warrior"],
                            "baseHp": 70,
                            "baseAttack": 75,
                            "baseDefense": 65,
                            "baseSpecialAttack": 70,
                            "baseSpecialDefense": 60,
                            "baseSpeed": 85,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["water_pulse", "slash", "scald", "quick_attack"],
                            "ability": "swift_swim",
                            "description": "A battle-hardened murloc warrior with razor-sharp weapons."
                        },
                        "flameling": {
                            "id": "flameling",
                            "name": "FLAMELING",
                            "type": ["fire"],
                            "baseHp": 38,
                            "baseAttack": 42,
                            "baseDefense": 35,
                            "baseSpecialAttack": 65,
                            "baseSpecialDefense": 45,
                            "baseSpeed": 55,
                            "evolveLevel": 20,
                            "evolveTo": "pyroclasm",
                            "moves": ["ember", "firebolt", "will_o_wisp", "tackle"],
                            "ability": "flame_body",
                            "description": "A small elemental born from volcanic eruptions."
                        },
                        "pyroclasm": {
                            "id": "pyroclasm",
                            "name": "PYROCLASM",
                            "type": ["fire", "earth"],
                            "baseHp": 68,
                            "baseAttack": 72,
                            "baseDefense": 70,
                            "baseSpecialAttack": 105,
                            "baseSpecialDefense": 75,
                            "baseSpeed": 80,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["inferno", "earthquake", "sunny_day", "meteor_strike"],
                            "ability": "magma_armor",
                            "description": "An explosive elemental of pure volcanic fury."
                        },
                        "sprite": {
                            "id": "sprite",
                            "name": "SPRITE",
                            "type": ["nature"],
                            "baseHp": 35,
                            "baseAttack": 30,
                            "baseDefense": 35,
                            "baseSpecialAttack": 55,
                            "baseSpecialDefense": 50,
                            "baseSpeed": 70,
                            "evolveLevel": 16,
                            "evolveTo": "dryad",
                            "moves": ["glow", "magical_leaf", "nature_power", "sleep_powder"],
                            "ability": "natural_cure",
                            "description": "A tiny nature spirit that tends to forest groves."
                        },
                        "dryad": {
                            "id": "dryad",
                            "name": "DRYAD",
                            "type": ["nature", "magic"],
                            "baseHp": 60,
                            "baseAttack": 45,
                            "baseDefense": 60,
                            "baseSpecialAttack": 90,
                            "baseSpecialDefense": 85,
                            "baseSpeed": 95,
                            "evolveLevel": 36,
                            "evolveTo": "ancient_guardian",
                            "moves": ["energy_ball", "moonbeam", "heal_pulse", "synthesis"],
                            "ability": "regeneration",
                            "description": "A guardian of the forest with powerful nature magic."
                        },
                        "ancient_guardian": {
                            "id": "ancient_guardian",
                            "name": "ANCIENTGUARD",
                            "type": ["nature", "magic"],
                            "baseHp": 90,
                            "baseAttack": 65,
                            "baseDefense": 95,
                            "baseSpecialAttack": 120,
                            "baseSpecialDefense": 110,
                            "baseSpeed": 85,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["wood_hammer", "energy_ball", "moonbeam", "synthesis"],
                            "ability": "overgrow",
                            "description": "An ancient protector of nature with immense magical power."
                        },
                        "wisp": {
                            "id": "wisp",
                            "name": "WISP",
                            "type": ["electric", "spirit"],
                            "baseHp": 30,
                            "baseAttack": 25,
                            "baseDefense": 30,
                            "baseSpecialAttack": 70,
                            "baseSpecialDefense": 55,
                            "baseSpeed": 85,
                            "evolveLevel": 22,
                            "evolveTo": "storm_wisp",
                            "moves": ["spark", "confuse_ray", "thunder_wave", "quick_attack"],
                            "ability": "static",
                            "description": "A glowing spirit of pure electrical energy."
                        },
                        "storm_wisp": {
                            "id": "storm_wisp",
                            "name": "STORMWISP",
                            "type": ["electric", "spirit"],
                            "baseHp": 55,
                            "baseAttack": 40,
                            "baseDefense": 50,
                            "baseSpecialAttack": 110,
                            "baseSpecialDefense": 80,
                            "baseSpeed": 115,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["lightning_bolt", "discharge", "thunder_wave", "confuse_ray"],
                            "ability": "lightning_rod",
                            "description": "A powerful storm spirit that commands thunder and lightning."
                        },
                        "frostling": {
                            "id": "frostling",
                            "name": "FROSTLING",
                            "type": ["ice"],
                            "baseHp": 42,
                            "baseAttack": 48,
                            "baseDefense": 52,
                            "baseSpecialAttack": 58,
                            "baseSpecialDefense": 55,
                            "baseSpeed": 45,
                            "evolveLevel": 24,
                            "evolveTo": "frost_wyrm",
                            "moves": ["frost_shock", "ice_fang", "ice_shard", "bite"],
                            "ability": "ice_body",
                            "description": "A small creature born from eternal winter."
                        },
                        "frost_wyrm": {
                            "id": "frost_wyrm",
                            "name": "FROSTWYRM",
                            "type": ["ice", "dragon"],
                            "baseHp": 80,
                            "baseAttack": 85,
                            "baseDefense": 90,
                            "baseSpecialAttack": 100,
                            "baseSpecialDefense": 95,
                            "baseSpeed": 75,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["ice_beam", "blizzard", "dragon_breath", "hail"],
                            "ability": "snow_cloak",
                            "description": "An undead dragon reanimated by the Lich King's dark magic."
                        },
                        "viper": {
                            "id": "viper",
                            "name": "VIPER",
                            "type": ["poison", "beast"],
                            "baseHp": 48,
                            "baseAttack": 58,
                            "baseDefense": 50,
                            "baseSpecialAttack": 52,
                            "baseSpecialDefense": 48,
                            "baseSpeed": 70,
                            "evolveLevel": 26,
                            "evolveTo": "serpent",
                            "moves": ["poison_sting", "bite", "toxic", "poison_jab"],
                            "ability": "poison_point",
                            "description": "A venomous serpent that strikes with deadly precision."
                        },
                        "serpent": {
                            "id": "serpent",
                            "name": "SERPENT",
                            "type": ["poison", "beast"],
                            "baseHp": 75,
                            "baseAttack": 95,
                            "baseDefense": 78,
                            "baseSpecialAttack": 80,
                            "baseSpecialDefense": 75,
                            "baseSpeed": 100,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["sludge_bomb", "crunch", "toxic", "coil"],
                            "ability": "shed_skin",
                            "description": "A massive serpent whose venom can fell the mightiest warriors."
                        },
                        "shade": {
                            "id": "shade",
                            "name": "SHADE",
                            "type": ["shadow", "spirit"],
                            "baseHp": 45,
                            "baseAttack": 40,
                            "baseDefense": 45,
                            "baseSpecialAttack": 75,
                            "baseSpecialDefense": 70,
                            "baseSpeed": 80,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["shadow_ball", "dark_pulse", "confuse_ray", "curse"],
                            "ability": "levitate",
                            "description": "A restless spirit that haunts the shadows."
                        },
                        "footman": {
                            "id": "footman",
                            "name": "FOOTMAN",
                            "type": ["warrior"],
                            "baseHp": 52,
                            "baseAttack": 68,
                            "baseDefense": 58,
                            "baseSpecialAttack": 35,
                            "baseSpecialDefense": 50,
                            "baseSpeed": 55,
                            "evolveLevel": 28,
                            "evolveTo": "knight",
                            "moves": ["slash", "battle_cry", "stomp", "tackle"],
                            "ability": "steadfast",
                            "description": "A loyal soldier of the Alliance armies."
                        },
                        "knight": {
                            "id": "knight",
                            "name": "KNIGHT",
                            "type": ["warrior"],
                            "baseHp": 80,
                            "baseAttack": 105,
                            "baseDefense": 90,
                            "baseSpecialAttack": 50,
                            "baseSpecialDefense": 75,
                            "baseSpeed": 75,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["cleave", "battle_shout", "ram", "execute"],
                            "ability": "iron_fist",
                            "description": "An elite warrior clad in heavy armor and wielding righteous fury."
                        },
                        "imp": {
                            "id": "imp",
                            "name": "IMP",
                            "type": ["demon", "fire"],
                            "baseHp": 35,
                            "baseAttack": 38,
                            "baseDefense": 35,
                            "baseSpecialAttack": 72,
                            "baseSpecialDefense": 50,
                            "baseSpeed": 65,
                            "evolveLevel": 30,
                            "evolveTo": "felguard",
                            "moves": ["firebolt", "immolate", "curse", "will_o_wisp"],
                            "ability": "fiery_soul",
                            "description": "A mischievous demon servant of the Burning Legion."
                        },
                        "felguard": {
                            "id": "felguard",
                            "name": "FELGUARD",
                            "type": ["demon", "warrior"],
                            "baseHp": 75,
                            "baseAttack": 100,
                            "baseDefense": 85,
                            "baseSpecialAttack": 90,
                            "baseSpecialDefense": 75,
                            "baseSpeed": 70,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["fel_bite", "cleave", "immolate", "dark_pulse"],
                            "ability": "demonic_fury",
                            "description": "A heavily armored demon warrior wielding fel energy."
                        },
                        "mage_apprentice": {
                            "id": "mage_apprentice",
                            "name": "APPRENTICE",
                            "type": ["magic"],
                            "baseHp": 32,
                            "baseAttack": 25,
                            "baseDefense": 30,
                            "baseSpecialAttack": 75,
                            "baseSpecialDefense": 60,
                            "baseSpeed": 68,
                            "evolveLevel": 32,
                            "evolveTo": "archmage",
                            "moves": ["firebolt", "frost_shock", "barrier", "mana_drain"],
                            "ability": "spell_power",
                            "description": "A young mage learning the arcane arts."
                        },
                        "archmage": {
                            "id": "archmage",
                            "name": "ARCHMAGE",
                            "type": ["magic"],
                            "baseHp": 60,
                            "baseAttack": 40,
                            "baseDefense": 55,
                            "baseSpecialAttack": 130,
                            "baseSpecialDefense": 95,
                            "baseSpeed": 95,
                            "evolveLevel": null,
                            "evolveTo": null,
                            "moves": ["psychic", "elemental_blast", "cosmic_power", "blizzard"],
                            "ability": "arcane_mastery",
                            "description": "A master of the arcane with devastating magical power."
                        }
                    },
                    
                    "moves": {
                        "tackle": { "name": "Tackle", "power": 40, "accuracy": 100, "pp": 35, "type": "normal", "category": "physical", "energyCost": 20 },
                        "bubble": { "name": "Bubble", "power": 40, "accuracy": 100, "pp": 30, "type": "water", "category": "special", "energyCost": 25 },
                        "water_gun": { "name": "Water Gun", "power": 40, "accuracy": 100, "pp": 25, "type": "water", "category": "special", "energyCost": 25 },
                        "bite": { "name": "Bite", "power": 60, "accuracy": 100, "pp": 25, "type": "beast", "category": "physical", "energyCost": 35 },
                        "scratch": { "name": "Scratch", "power": 40, "accuracy": 100, "pp": 35, "type": "normal", "category": "physical", "energyCost": 20 },
                        "ember": { "name": "Ember", "power": 40, "accuracy": 100, "pp": 25, "type": "fire", "category": "special", "energyCost": 25 },
                        "firebolt": { "name": "Firebolt", "power": 50, "accuracy": 100, "pp": 20, "type": "fire", "category": "special", "energyCost": 30 },
                        "glow": { "name": "Glow", "power": 0, "accuracy": 100, "pp": 20, "type": "nature", "category": "status", "effect": "lower_accuracy", "energyCost": 15 },
                        "nature_power": { "name": "Nature Power", "power": 50, "accuracy": 100, "pp": 20, "type": "nature", "category": "special", "energyCost": 30 },
                        "howl": { "name": "Howl", "power": 0, "accuracy": 100, "pp": 40, "type": "beast", "category": "status", "effect": "raise_attack", "energyCost": 20 },
                        "dig": { "name": "Dig", "power": 80, "accuracy": 100, "pp": 10, "type": "earth", "category": "physical", "energyCost": 45 },
                        "rock_throw": { "name": "Rock Throw", "power": 50, "accuracy": 90, "pp": 15, "type": "earth", "category": "physical", "energyCost": 30 },
                        "vine_whip": { "name": "Vine Whip", "power": 45, "accuracy": 100, "pp": 25, "type": "nature", "category": "physical", "energyCost": 25 },
                        "hydro_pump": { "name": "Hydro Pump", "power": 110, "accuracy": 80, "pp": 5, "type": "water", "category": "special", "energyCost": 60 },
                        "ice_beam": { "name": "Ice Beam", "power": 90, "accuracy": 100, "pp": 10, "type": "ice", "category": "special", "energyCost": 50 },
                        "earthquake": { "name": "Earthquake", "power": 100, "accuracy": 100, "pp": 10, "type": "earth", "category": "physical", "energyCost": 55 },
                        "psychic": { "name": "Psychic", "power": 90, "accuracy": 100, "pp": 10, "type": "magic", "category": "special", "energyCost": 50 },
                        "moonbeam": { "name": "Moonbeam", "power": 95, "accuracy": 100, "pp": 15, "type": "nature", "category": "special", "energyCost": 55 },
                        "inferno": { "name": "Inferno", "power": 100, "accuracy": 50, "pp": 5, "type": "fire", "category": "special", "energyCost": 60 },
                        "shadow_ball": { "name": "Shadow Ball", "power": 80, "accuracy": 100, "pp": 15, "type": "shadow", "category": "special", "energyCost": 45 },
                        "candle_light": { "name": "Candle Light", "power": 40, "accuracy": 100, "pp": 20, "type": "fire", "category": "special", "energyCost": 25 },
                        "sleep_powder": { "name": "Sleep Powder", "power": 0, "accuracy": 75, "pp": 15, "type": "nature", "category": "status", "effect": "sleep", "energyCost": 40 },
                        "magical_leaf": { "name": "Magical Leaf", "power": 60, "accuracy": 100, "pp": 20, "type": "nature", "category": "special", "energyCost": 35 },
                        "heal_pulse": { "name": "Heal Pulse", "power": 0, "accuracy": 100, "pp": 10, "type": "nature", "category": "status", "effect": "heal", "energyCost": 50 },
                        "energy_ball": { "name": "Energy Ball", "power": 80, "accuracy": 100, "pp": 10, "type": "nature", "category": "special", "energyCost": 45 },
                        "confuse_ray": { "name": "Confuse Ray", "power": 0, "accuracy": 100, "pp": 10, "type": "magic", "category": "status", "effect": "confuse", "energyCost": 30 },
                        "dark_pulse": { "name": "Dark Pulse", "power": 80, "accuracy": 100, "pp": 15, "type": "shadow", "category": "special", "energyCost": 45 },
                        "slash": { "name": "Slash", "power": 70, "accuracy": 100, "pp": 20, "type": "normal", "category": "physical", "energyCost": 40 },
                        "crunch": { "name": "Crunch", "power": 80, "accuracy": 100, "pp": 15, "type": "beast", "category": "physical", "energyCost": 45 },
                        "quick_attack": { "name": "Quick Attack", "power": 40, "accuracy": 100, "pp": 30, "type": "normal", "category": "physical", "priority": 1, "energyCost": 15 },
                        "shadow_claw": { "name": "Shadow Claw", "power": 70, "accuracy": 100, "pp": 15, "type": "shadow", "category": "physical", "energyCost": 40 },
                        "ice_fang": { "name": "Ice Fang", "power": 65, "accuracy": 95, "pp": 15, "type": "ice", "category": "physical", "energyCost": 35 },
                        "hyper_fang": { "name": "Hyper Fang", "power": 80, "accuracy": 90, "pp": 15, "type": "normal", "category": "physical", "energyCost": 45 },
                        "root": { "name": "Root", "power": 0, "accuracy": 100, "pp": 20, "type": "nature", "category": "status", "effect": "trap", "energyCost": 25 },
                        "wood_hammer": { "name": "Wood Hammer", "power": 120, "accuracy": 100, "pp": 15, "type": "nature", "category": "physical", "energyCost": 65 },
                        "synthesis": { "name": "Synthesis", "power": 0, "accuracy": 100, "pp": 5, "type": "nature", "category": "status", "effect": "heal", "energyCost": 50 },
                        "water_pulse": { "name": "Water Pulse", "power": 60, "accuracy": 100, "pp": 20, "type": "water", "category": "special", "energyCost": 35 },
                        "frost_shock": { "name": "Frost Shock", "power": 40, "accuracy": 100, "pp": 30, "type": "ice", "category": "special", "energyCost": 25 },
                        "lightning_bolt": { "name": "Lightning Bolt", "power": 90, "accuracy": 100, "pp": 15, "type": "electric", "category": "special", "energyCost": 50 },
                        "tidal_wave": { "name": "Tidal Wave", "power": 90, "accuracy": 100, "pp": 10, "type": "water", "category": "special", "energyCost": 50 },
                        "elemental_blast": { "name": "Elemental Blast", "power": 90, "accuracy": 100, "pp": 10, "type": "magic", "category": "special", "energyCost": 50 },
                        "barrier": { "name": "Barrier", "power": 0, "accuracy": 100, "pp": 20, "type": "magic", "category": "status", "effect": "defense_up", "energyCost": 30 },
                        "explosion": { "name": "Explosion", "power": 250, "accuracy": 100, "pp": 5, "type": "fire", "category": "physical", "energyCost": 100 },
                        "cosmic_power": { "name": "Cosmic Power", "power": 0, "accuracy": 100, "pp": 20, "type": "magic", "category": "status", "effect": "stats_up", "energyCost": 40 },
                        "dragon_breath": { "name": "Dragon Breath", "power": 60, "accuracy": 100, "pp": 20, "type": "dragon", "category": "special", "energyCost": 35 },
                        "dragon_claw": { "name": "Dragon Claw", "power": 80, "accuracy": 100, "pp": 15, "type": "dragon", "category": "physical", "energyCost": 45 },
                        "dragon_rage": { "name": "Dragon Rage", "power": 90, "accuracy": 100, "pp": 10, "type": "dragon", "category": "special", "energyCost": 50 },
                        "wing_attack": { "name": "Wing Attack", "power": 60, "accuracy": 100, "pp": 35, "type": "flying", "category": "physical", "energyCost": 35 },
                        "flame_burst": { "name": "Flame Burst", "power": 70, "accuracy": 100, "pp": 15, "type": "fire", "category": "special", "energyCost": 40 },
                        "aerial_ace": { "name": "Aerial Ace", "power": 60, "accuracy": 999, "pp": 20, "type": "flying", "category": "physical", "energyCost": 35 },
                        "outrage": { "name": "Outrage", "power": 120, "accuracy": 100, "pp": 10, "type": "dragon", "category": "physical", "energyCost": 65 },
                        "hyper_beam": { "name": "Hyper Beam", "power": 150, "accuracy": 90, "pp": 5, "type": "normal", "category": "special", "energyCost": 80 },
                        "plague_strike": { "name": "Plague Strike", "power": 65, "accuracy": 100, "pp": 20, "type": "undead", "energyCost": 35 },
                        "leer": { "name": "Leer", "power": 0, "accuracy": 100, "pp": 30, "type": "normal", "energyCost": 15 },
                        "toxic_sludge": { "name": "Toxic Sludge", "power": 90, "accuracy": 100, "pp": 10, "type": "poison", "energyCost": 50 },
                        "body_slam": { "name": "Body Slam", "power": 85, "accuracy": 100, "pp": 15, "type": "normal", "energyCost": 45 },
                        "bone_club": { "name": "Bone Club", "power": 65, "accuracy": 85, "pp": 20, "type": "undead", "energyCost": 35 },
                        "battle_cry": { "name": "Battle Cry", "power": 0, "accuracy": 100, "pp": 20, "type": "warrior", "energyCost": 20 },
                        "stomp": { "name": "Stomp", "power": 65, "accuracy": 100, "pp": 20, "type": "normal", "energyCost": 35 },
                        "rage": { "name": "Rage", "power": 20, "accuracy": 100, "pp": 20, "type": "warrior", "energyCost": 15 },
                        "cleave": { "name": "Cleave", "power": 90, "accuracy": 100, "pp": 15, "type": "warrior", "energyCost": 50 },
                        "bladestorm": { "name": "Bladestorm", "power": 110, "accuracy": 80, "pp": 10, "type": "warrior", "energyCost": 60 },
                        "battle_shout": { "name": "Battle Shout", "power": 0, "accuracy": 100, "pp": 30, "type": "warrior", "energyCost": 25 },
                        "execute": { "name": "Execute", "power": 120, "accuracy": 100, "pp": 5, "type": "warrior", "energyCost": 70 },
                        "wail": { "name": "Wail", "power": 0, "accuracy": 100, "pp": 15, "type": "undead", "energyCost": 25 },
                        "possession": { "name": "Possession", "power": 90, "accuracy": 80, "pp": 5, "type": "spirit", "energyCost": 50 },
                        "web_shot": { "name": "Web Shot", "power": 0, "accuracy": 95, "pp": 20, "type": "beast", "energyCost": 20 },
                        "poison_sting": { "name": "Poison Sting", "power": 15, "accuracy": 100, "pp": 35, "type": "poison", "energyCost": 15 },
                        "trap": { "name": "Trap", "power": 0, "accuracy": 100, "pp": 20, "type": "beast", "energyCost": 25 },
                        "crypt_fiend": { "name": "Crypt Fiend", "power": 85, "accuracy": 100, "pp": 15, "type": "undead", "energyCost": 45 },
                        "web_wrap": { "name": "Web Wrap", "power": 0, "accuracy": 90, "pp": 10, "type": "beast", "energyCost": 30 },
                        "toxic_bite": { "name": "Toxic Bite", "power": 70, "accuracy": 100, "pp": 15, "type": "poison", "energyCost": 40 },
                        "burrow": { "name": "Burrow", "power": 80, "accuracy": 100, "pp": 10, "type": "earth", "energyCost": 45 },
                        "flame_strike": { "name": "Flame Strike", "power": 95, "accuracy": 100, "pp": 15, "type": "fire", "energyCost": 55 },
                        "rebirth": { "name": "Rebirth", "power": 0, "accuracy": 100, "pp": 5, "type": "spirit", "energyCost": 80 },
                        "sacred_fire": { "name": "Sacred Fire", "power": 100, "accuracy": 95, "pp": 5, "type": "fire", "energyCost": 60 },
                        "thorn_volley": { "name": "Thorn Volley", "power": 75, "accuracy": 100, "pp": 15, "type": "nature" },
                        "ram": { "name": "Ram", "power": 90, "accuracy": 100, "pp": 20, "type": "beast" },
                        "intimidate": { "name": "Intimidate", "power": 0, "accuracy": 100, "pp": 30, "type": "normal" },
                        "mana_drain": { "name": "Mana Drain", "power": 30, "accuracy": 100, "pp": 20, "type": "magic" },
                        "fel_bite": { "name": "Fel Bite", "power": 80, "accuracy": 100, "pp": 15, "type": "demon" },
                        "devour_magic": { "name": "Devour Magic", "power": 0, "accuracy": 100, "pp": 10, "type": "magic" },
                        "meteor_strike": { "name": "Meteor Strike", "power": 100, "accuracy": 85, "pp": 5, "type": "fire", "category": "special" },
                        "immolate": { "name": "Immolate", "power": 75, "accuracy": 100, "pp": 15, "type": "fire", "category": "special" },
                        "curse": { "name": "Curse", "power": 0, "accuracy": 100, "pp": 10, "type": "shadow", "category": "status" },
                        "will_o_wisp": { "name": "Will-O-Wisp", "power": 0, "accuracy": 85, "pp": 15, "type": "fire", "category": "status", "effect": "burn" },
                        "toxic": { "name": "Toxic", "power": 0, "accuracy": 90, "pp": 10, "type": "poison", "category": "status", "effect": "poison" },
                        "thunder_wave": { "name": "Thunder Wave", "power": 0, "accuracy": 90, "pp": 20, "type": "electric", "category": "status", "effect": "paralyze" },
                        "spore": { "name": "Spore", "power": 0, "accuracy": 100, "pp": 15, "type": "nature", "category": "status", "effect": "sleep" },
                        "ice_shard": { "name": "Ice Shard", "power": 0, "accuracy": 85, "pp": 10, "type": "ice", "category": "status", "effect": "freeze" },
                        "fire_fang": { "name": "Fire Fang", "power": 65, "accuracy": 95, "pp": 15, "type": "fire", "category": "physical", "secondaryEffect": { "chance": 30, "effect": "burn" } },
                        "poison_jab": { "name": "Poison Jab", "power": 80, "accuracy": 100, "pp": 20, "type": "poison", "category": "physical", "secondaryEffect": { "chance": 30, "effect": "poison" } },
                        "spark": { "name": "Spark", "power": 65, "accuracy": 100, "pp": 20, "type": "electric", "category": "physical", "secondaryEffect": { "chance": 30, "effect": "paralyze" } },
                        "ice_punch": { "name": "Ice Punch", "power": 75, "accuracy": 100, "pp": 15, "type": "ice", "category": "physical", "secondaryEffect": { "chance": 10, "effect": "freeze" } },
                        "sludge_bomb": { "name": "Sludge Bomb", "power": 90, "accuracy": 100, "pp": 10, "type": "poison", "category": "special", "secondaryEffect": { "chance": 30, "effect": "poison" } },
                        "discharge": { "name": "Discharge", "power": 80, "accuracy": 100, "pp": 15, "type": "electric", "category": "special", "secondaryEffect": { "chance": 30, "effect": "paralyze" } },
                        "scald": { "name": "Scald", "power": 80, "accuracy": 100, "pp": 15, "type": "water", "category": "special", "secondaryEffect": { "chance": 30, "effect": "burn" } },
                        "blizzard": { "name": "Blizzard", "power": 110, "accuracy": 70, "pp": 5, "type": "ice", "category": "special", "secondaryEffect": { "chance": 10, "effect": "freeze" } },
                        "sunny_day": { "name": "Sunny Day", "power": 0, "accuracy": 100, "pp": 5, "type": "fire", "category": "status", "effect": "weather_sun" },
                        "rain_dance": { "name": "Rain Dance", "power": 0, "accuracy": 100, "pp": 5, "type": "water", "category": "status", "effect": "weather_rain" },
                        "sandstorm": { "name": "Sandstorm", "power": 0, "accuracy": 100, "pp": 10, "type": "earth", "category": "status", "effect": "weather_sandstorm" },
                        "hail": { "name": "Hail", "power": 0, "accuracy": 100, "pp": 10, "type": "ice", "category": "status", "effect": "weather_hail" }
                    },
                    
                    "items": {
                        "health_potion": {
                            "name": "Health Potion",
                            "type": "medicine",
                            "price": 300,
                            "effect": "heal_20hp",
                            "description": "Restores 20 HP to one creature."
                        },
                        "greater_health_potion": {
                            "name": "Greater Health Potion",
                            "type": "medicine",
                            "price": 700,
                            "effect": "heal_50hp",
                            "description": "Restores 50 HP to one creature."
                        },
                        "soul_stone": {
                            "name": "Soul Stone",
                            "type": "capture",
                            "price": 200,
                            "catchRate": 1.0,
                            "description": "A magical stone used to capture creatures."
                        },
                        "greater_soul_stone": {
                            "name": "Greater Soul Stone",
                            "type": "capture",
                            "price": 600,
                            "catchRate": 1.5,
                            "description": "A higher quality stone for capturing creatures."
                        },
                        "hearthstone": {
                            "name": "Hearthstone",
                            "type": "key_item",
                            "price": 0,
                            "effect": "teleport_home",
                            "description": "Returns you to the last inn visited."
                        },
                        "fishing_rod": {
                            "name": "Fishing Rod",
                            "type": "key_item",
                            "price": 0,
                            "effect": "fish",
                            "description": "Allows you to fish for water creatures."
                        }
                    },
                    
                    "trainers": {
                        "gym1": {
                            "name": "MURADIN",
                            "title": "The Forge Master",
                            "sprite": 1,
                            "team": ["kobold", "kobold", "elemental"],
                            "reward": 1000,
                            "badge": "Forge Badge",
                            "dialogue": "By hammer and anvil! Let's see what ye're made of!"
                        },

                    "achievements": {
                        "first_catch": {
                            "id": "first_catch",
                            "name": "First Catch",
                            "description": "Capture your first creature",
                            "reward": { "type": "money", "amount": 500 },
                            "condition": { "type": "creatures_caught", "count": 1 }
                        },
                        "collector": {
                            "id": "collector",
                            "name": "Collector",
                            "description": "Capture 10 different creatures",
                            "reward": { "type": "item", "item": "greater_soul_stone", "count": 5 },
                            "condition": { "type": "unique_creatures", "count": 10 }
                        },
                        "master_collector": {
                            "id": "master_collector",
                            "name": "Master Collector",
                            "description": "Capture all 25 creatures",
                            "reward": { "type": "item", "item": "lucky_charm", "count": 1 },
                            "condition": { "type": "unique_creatures", "count": 25 }
                        },
                        "dragon_tamer": {
                            "id": "dragon_tamer",
                            "name": "Dragon Tamer",
                            "description": "Capture a fully evolved dragon",
                            "reward": { "type": "item", "item": "dragon_scale", "count": 1 },
                            "condition": { "type": "catch_species", "species": "dragon" }
                        },
                        "first_victory": {
                            "id": "first_victory",
                            "name": "First Victory",
                            "description": "Win your first battle",
                            "reward": { "type": "money", "amount": 300 },
                            "condition": { "type": "battles_won", "count": 1 }
                        },
                        "battle_veteran": {
                            "id": "battle_veteran",
                            "name": "Battle Veteran",
                            "description": "Win 50 battles",
                            "reward": { "type": "item", "item": "power_band", "count": 1 },
                            "condition": { "type": "battles_won", "count": 50 }
                        },
                        "gym_challenger": {
                            "id": "gym_challenger",
                            "name": "Gym Challenger",
                            "description": "Defeat your first gym leader",
                            "reward": { "type": "money", "amount": 1000 },
                            "condition": { "type": "badges", "count": 1 }
                        },
                        "gym_master": {
                            "id": "gym_master",
                            "name": "Gym Master",
                            "description": "Collect all 4 badges",
                            "reward": { "type": "item", "item": "focus_sash", "count": 1 },
                            "condition": { "type": "badges", "count": 4 }
                        },
                        "evolution_expert": {
                            "id": "evolution_expert",
                            "name": "Evolution Expert",
                            "description": "Evolve a creature for the first time",
                            "reward": { "type": "money", "amount": 750 },
                            "condition": { "type": "evolutions", "count": 1 }
                        },
                        "level_master": {
                            "id": "level_master",
                            "name": "Level Master",
                            "description": "Train a creature to level 50",
                            "reward": { "type": "item", "item": "full_restore", "count": 3 },
                            "condition": { "type": "max_level", "level": 50 }
                        },
                        "undead_hunter": {
                            "id": "undead_hunter",
                            "name": "Undead Hunter",
                            "description": "Defeat 20 undead type creatures",
                            "reward": { "type": "item", "item": "shadow_essence", "count": 1 },
                            "condition": { "type": "type_defeated", "creatureType": "undead", "count": 20 }
                        },
                        "champion": {
                            "id": "champion",
                            "name": "Champion",
                            "description": "Defeat the Elite Four",
                            "reward": { "type": "title", "title": "Champion" },
                            "condition": { "type": "elite_four_cleared", "count": 1 }
                        },
                        "legendary_trainer": {
                            "id": "legendary_trainer",
                            "name": "Legendary Trainer",
                            "description": "Win 100 battles without losing",
                            "reward": { "type": "money", "amount": 10000 },
                            "condition": { "type": "win_streak", "count": 100 }
                        },
                        "speed_runner": {
                            "id": "speed_runner",
                            "name": "Speed Runner",
                            "description": "Defeat all gym leaders in under 2 hours",
                            "reward": { "type": "item", "item": "lucky_charm", "count": 1 },
                            "condition": { "type": "time_challenge", "time": 7200 }
                        },
                        "wealthy": {
                            "id": "wealthy",
                            "name": "Wealthy",
                            "description": "Accumulate 50,000 gold",
                            "reward": { "type": "title", "title": "Tycoon" },
                            "condition": { "type": "money", "amount": 50000 }
                        }
                    },
                        "gym2": {
                            "name": "MALFURION",
                            "title": "The Archdruid",
                            "sprite": 2,
                            "team": ["wisp", "ancient_wisp", "treant"],
                            "reward": 2000,
                            "badge": "Nature Badge",
                            "dialogue": "Nature will test your resolve."
                        },
                        "gym3": {
                            "name": "JAINA",
                            "title": "The Frost Mage",
                            "sprite": 3,
                            "team": ["elemental", "naga", "naga"],
                            "reward": 3000,
                            "badge": "Frost Badge",
                            "dialogue": "Let's see if you can handle the cold!"
                        },
                        "gym4": {
                            "name": "THRALL",
                            "title": "The Warchief",
                            "sprite": 4,
                            "team": ["wolf", "dire_wolf", "elemental"],
                            "reward": 4000,
                            "badge": "Storm Badge",
                            "dialogue": "The elements will test you!"
                        }
                    },
                    
                    "maps": {
                        "goldshire": {
                            "name": "Goldshire",
                            "width": 20,
                            "height": 15,
                            "tiles": [
                                2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,1,10,10,1,1,1,1,1,5,5,1,1,1,1,10,10,1,1,2,
                                2,1,10,10,1,1,6,6,6,5,5,6,6,6,1,10,10,1,1,2,
                                2,1,1,1,1,1,6,8,6,5,5,6,7,6,1,1,1,1,1,2,
                                2,1,1,1,1,1,6,6,6,5,5,6,6,6,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,1,6,6,6,1,1,1,1,5,5,1,1,1,6,6,6,1,1,2,
                                2,1,6,7,6,1,1,1,1,5,5,1,1,1,6,7,6,1,1,2,
                                2,1,6,6,6,1,1,1,1,5,5,1,1,1,6,6,6,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,2,2,2,2,2,2,2,2,7,7,2,2,2,2,2,2,2,2,2,
                                0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
                            ],
                            "npcs": [
                                {
                                    "id": "professor",
                                    "x": 7,
                                    "y": 4,
                                    "sprite": 1,
                                    "dialogue": "Welcome to the world of WoWmon! Choose your starter wisely!"
                                },
                                {
                                    "id": "mom",
                                    "x": 14,
                                    "y": 10,
                                    "sprite": 2,
                                    "dialogue": "Be careful on your adventure! Come back if you need healing!"
                                }
                            ],
                            "warps": [
                                { "x": 9, "y": 13, "toMap": "route1", "toX": 10, "toY": 1 },
                                { "x": 10, "y": 13, "toMap": "route1", "toX": 10, "toY": 1 },
                                { "x": 3, "y": 10, "toMap": "house1", "toX": 3, "toY": 5 },
                                { "x": 15, "y": 10, "toMap": "house2", "toX": 3, "toY": 5 },
                                { "x": 12, "y": 4, "toMap": "lab", "toX": 5, "toY": 8 }
                            ],
                            "encounters": []
                        },
                        "route1": {
                            "name": "Route 1",
                            "width": 20,
                            "height": 30,
                            "tiles": [
                                2,2,2,2,2,2,2,2,2,5,5,2,2,2,2,2,2,2,2,2,
                                2,9,9,9,1,1,1,1,1,5,5,1,1,1,1,9,9,9,1,2,
                                2,9,9,9,1,1,1,1,1,5,5,1,1,1,1,9,9,9,1,2,
                                2,9,9,9,1,1,1,1,1,5,5,1,1,1,1,9,9,9,1,2,
                                2,1,1,1,1,1,2,1,1,5,5,1,1,2,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,9,9,9,1,1,1,1,1,5,5,1,1,1,1,9,9,9,1,2,
                                2,9,9,9,1,1,1,1,1,5,5,1,1,1,1,9,9,9,1,2,
                                2,9,9,9,1,1,1,1,1,5,5,1,1,1,1,9,9,9,1,2,
                                2,1,1,1,1,1,2,1,1,5,5,1,1,2,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,9,9,9,1,1,1,1,1,5,5,1,1,1,1,9,9,9,1,2,
                                2,9,9,9,1,1,1,1,1,5,5,1,1,1,1,9,9,9,1,2,
                                2,9,9,9,1,1,1,1,1,5,5,1,1,1,1,9,9,9,1,2,
                                2,1,1,1,1,1,2,1,1,5,5,1,1,2,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,2,
                                2,2,2,2,2,2,2,2,2,5,5,2,2,2,2,2,2,2,2,2,
                                0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
                            ],
                            "npcs": [
                                {
                                    "id": "youngster1",
                                    "x": 10,
                                    "y": 5,
                                    "sprite": 3,
                                    "dialogue": "My creatures are the best!",
                                    "trainer": true,
                                    "team": ["gnoll", "kobold"]
                                },
                                {
                                    "id": "lass1",
                                    "x": 10,
                                    "y": 15,
                                    "sprite": 4,
                                    "dialogue": "I love cute creatures!",
                                    "trainer": true,
                                    "team": ["wisp", "wisp"]
                                }
                            ],
                            "warps": [
                                { "x": 9, "y": 0, "toMap": "goldshire", "toX": 9, "toY": 12 },
                                { "x": 10, "y": 0, "toMap": "goldshire", "toX": 10, "toY": 12 },
                                { "x": 9, "y": 28, "toMap": "stormwind", "toX": 15, "toY": 1 },
                                { "x": 10, "y": 28, "toMap": "stormwind", "toX": 15, "toY": 1 }
                            ],
                            "encounters": ["gnoll", "kobold", "wolf", "wisp"]
                        },
                        "stormwind": {
                            "name": "Stormwind City",
                            "width": 30,
                            "height": 25,
                            "tiles": [
                                4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,6,6,6,6,5,5,6,6,6,6,5,5,5,5,5,5,6,6,6,6,5,5,6,6,6,6,5,4,
                                4,5,6,8,8,6,5,5,6,8,8,6,5,5,5,5,5,5,6,8,8,6,5,5,6,8,8,6,5,4,
                                4,5,6,7,7,6,5,5,6,7,7,6,5,5,5,5,5,5,6,7,7,6,5,5,6,7,7,6,5,4,
                                4,5,6,6,6,6,5,5,6,6,6,6,5,5,5,5,5,5,6,6,6,6,5,5,6,6,6,6,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,6,6,6,6,6,6,6,6,5,5,5,3,3,3,3,5,5,5,6,6,6,6,6,6,6,6,5,4,
                                4,5,6,8,8,8,8,8,8,6,5,5,3,3,3,3,3,3,5,5,6,8,8,8,8,8,8,6,5,4,
                                4,5,6,8,8,8,8,8,8,6,5,5,3,3,3,3,3,3,5,5,6,8,8,8,8,8,8,6,5,4,
                                4,5,6,8,8,7,8,8,8,6,5,5,3,3,3,3,3,3,5,5,6,8,8,7,8,8,8,6,5,4,
                                4,5,6,8,8,8,8,8,8,6,5,5,3,3,3,3,3,3,5,5,6,8,8,8,8,8,8,6,5,4,
                                4,5,6,6,6,6,6,6,6,6,5,5,5,3,3,3,3,5,5,5,6,6,6,6,6,6,6,6,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,6,6,6,6,5,5,6,6,6,6,5,5,5,5,5,5,6,6,6,6,5,5,6,6,6,6,5,4,
                                4,5,6,8,8,6,5,5,6,8,8,6,5,5,5,5,5,5,6,8,8,6,5,5,6,8,8,6,5,4,
                                4,5,6,7,7,6,5,5,6,7,7,6,5,5,5,5,5,5,6,7,7,6,5,5,6,7,7,6,5,4,
                                4,5,6,6,6,6,5,5,6,6,6,6,5,5,5,5,5,5,6,6,6,6,5,5,6,6,6,6,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4
                            ],
                            "npcs": [
                                {
                                    "id": "nurse",
                                    "x": 3,
                                    "y": 4,
                                    "sprite": 5,
                                    "dialogue": "Welcome to the Healing Center! We'll heal your creatures!"
                                },
                                {
                                    "id": "shopkeeper",
                                    "x": 9,
                                    "y": 4,
                                    "sprite": 6,
                                    "dialogue": "Welcome to the Item Shop! We have potions and soul stones!"
                                },
                                {
                                    "id": "gym_guide",
                                    "x": 5,
                                    "y": 12,
                                    "sprite": 7,
                                    "dialogue": "The Gym Leader uses Earth and Metal type creatures!"
                                }
                            ],
                            "warps": [
                                { "x": 14, "y": 0, "toMap": "route1", "toX": 9, "toY": 27 },
                                { "x": 15, "y": 0, "toMap": "route1", "toX": 10, "toY": 27 },
                                { "x": 3, "y": 4, "toMap": "pokemon_center", "toX": 3, "toY": 7 },
                                { "x": 4, "y": 4, "toMap": "pokemon_center", "toX": 4, "toY": 7 },
                                { "x": 9, "y": 4, "toMap": "item_shop", "toX": 3, "toY": 7 },
                                { "x": 10, "y": 4, "toMap": "item_shop", "toX": 4, "toY": 7 },
                                { "x": 5, "y": 12, "toMap": "gym1", "toX": 7, "toY": 14 },
                                { "x": 23, "y": 12, "toMap": "gym2", "toX": 7, "toY": 14 }
                            ],
                            "encounters": []
                        },
                        "pokemon_center": {
                            "name": "Healing Center",
                            "width": 8,
                            "height": 8,
                            "tiles": [
                                6,6,6,6,6,6,6,6,
                                6,5,5,5,5,5,5,6,
                                6,5,8,8,8,8,5,6,
                                6,5,8,8,8,8,5,6,
                                6,5,5,5,5,5,5,6,
                                6,5,5,5,5,5,5,6,
                                6,5,5,5,5,5,5,6,
                                6,6,6,7,7,6,6,6
                            ],
                            "npcs": [
                                {
                                    "id": "nurse_joy",
                                    "x": 3,
                                    "y": 2,
                                    "sprite": 5,
                                    "dialogue": "Your creatures have been healed to perfect health!"
                                }
                            ],
                            "warps": [
                                { "x": 3, "y": 7, "toMap": "stormwind", "toX": 3, "toY": 5 },
                                { "x": 4, "y": 7, "toMap": "stormwind", "toX": 4, "toY": 5 }
                            ],
                            "encounters": []
                        },
                        "item_shop": {
                            "name": "Item Shop",
                            "width": 8,
                            "height": 8,
                            "tiles": [
                                6,6,6,6,6,6,6,6,
                                6,5,5,5,5,5,5,6,
                                6,5,8,8,8,8,5,6,
                                6,5,5,5,5,5,5,6,
                                6,5,8,8,8,8,5,6,
                                6,5,8,8,8,8,5,6,
                                6,5,5,5,5,5,5,6,
                                6,6,6,7,7,6,6,6
                            ],
                            "npcs": [
                                {
                                    "id": "shopkeeper",
                                    "x": 3,
                                    "y": 2,
                                    "sprite": 6,
                                    "dialogue": "Welcome! What would you like to buy?"
                                }
                            ],
                            "warps": [
                                { "x": 3, "y": 7, "toMap": "stormwind", "toX": 9, "toY": 5 },
                                { "x": 4, "y": 7, "toMap": "stormwind", "toX": 10, "toY": 5 }
                            ],
                            "encounters": []
                        },
                        "gym1": {
                            "name": "Forge Gym",
                            "width": 15,
                            "height": 15,
                            "tiles": [
                                4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,4,4,4,5,5,5,5,5,4,4,4,5,4,
                                4,5,4,5,5,5,5,5,5,5,5,5,4,5,4,
                                4,5,4,5,4,4,4,5,4,4,4,5,4,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,4,5,4,5,5,5,5,5,4,5,4,5,4,
                                4,5,4,5,4,5,8,8,8,5,4,5,4,5,4,
                                4,5,4,5,4,5,8,8,8,5,4,5,4,5,4,
                                4,5,5,5,5,5,8,8,8,5,5,5,5,5,4,
                                4,5,4,4,4,5,5,5,5,5,4,4,4,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,4,4,4,4,4,4,7,4,4,4,4,4,4,4
                            ],
                            "npcs": [
                                {
                                    "id": "gym1_trainer1",
                                    "x": 3,
                                    "y": 3,
                                    "sprite": 3,
                                    "dialogue": "You'll never reach our leader!",
                                    "trainer": true,
                                    "team": ["kobold", "kobold"]
                                },
                                {
                                    "id": "gym1_trainer2",
                                    "x": 11,
                                    "y": 3,
                                    "sprite": 3,
                                    "dialogue": "My earth creatures are unbeatable!",
                                    "trainer": true,
                                    "team": ["kobold", "elemental"]
                                },
                                {
                                    "id": "gym1_leader",
                                    "x": 7,
                                    "y": 7,
                                    "sprite": 8,
                                    "dialogue": "I am Muradin! Show me your strength!",
                                    "trainer": true,
                                    "gymLeader": "gym1"
                                }
                            ],
                            "warps": [
                                { "x": 7, "y": 14, "toMap": "stormwind", "toX": 5, "toY": 13 }
                            ],
                            "encounters": []
                        },
                        "house1": {
                            "name": "Your House",
                            "width": 7,
                            "height": 7,
                            "tiles": [
                                6,6,6,6,6,6,6,
                                6,5,5,5,5,5,6,
                                6,5,8,8,8,5,6,
                                6,5,5,5,5,5,6,
                                6,5,8,8,8,5,6,
                                6,5,5,5,5,5,6,
                                6,6,6,7,6,6,6
                            ],
                            "npcs": [],
                            "warps": [
                                { "x": 3, "y": 6, "toMap": "goldshire", "toX": 3, "toY": 11 }
                            ],
                            "encounters": []
                        },
                        "house2": {
                            "name": "Rival's House",
                            "width": 7,
                            "height": 7,
                            "tiles": [
                                6,6,6,6,6,6,6,
                                6,5,5,5,5,5,6,
                                6,5,8,8,8,5,6,
                                6,5,5,5,5,5,6,
                                6,5,8,8,8,5,6,
                                6,5,5,5,5,5,6,
                                6,6,6,7,6,6,6
                            ],
                            "npcs": [
                                {
                                    "id": "rival_sister",
                                    "x": 3,
                                    "y": 2,
                                    "sprite": 4,
                                    "dialogue": "My brother went to challenge the gym leaders!"
                                }
                            ],
                            "warps": [
                                { "x": 3, "y": 6, "toMap": "goldshire", "toX": 15, "toY": 11 }
                            ],
                            "encounters": []
                        },
                        "lab": {
                            "name": "Professor's Lab",
                            "width": 10,
                            "height": 10,
                            "tiles": [
                                6,6,6,6,6,6,6,6,6,6,
                                6,5,5,5,5,5,5,5,5,6,
                                6,5,8,8,5,5,8,8,5,6,
                                6,5,8,8,5,5,8,8,5,6,
                                6,5,5,5,5,5,5,5,5,6,
                                6,5,8,8,8,8,8,8,5,6,
                                6,5,5,5,5,5,5,5,5,6,
                                6,5,5,5,5,5,5,5,5,6,
                                6,5,5,5,5,5,5,5,5,6,
                                6,6,6,6,6,7,6,6,6,6
                            ],
                            "npcs": [
                                {
                                    "id": "professor",
                                    "x": 5,
                                    "y": 2,
                                    "sprite": 1,
                                    "dialogue": "Study the creatures well! Here, take this encyclopedia!"
                                },
                                {
                                    "id": "assistant",
                                    "x": 2,
                                    "y": 5,
                                    "sprite": 3,
                                    "dialogue": "The professor studies creature evolution patterns."
                                }
                            ],
                            "warps": [
                                { "x": 5, "y": 9, "toMap": "goldshire", "toX": 12, "toY": 5 }
                            ],
                            "encounters": []
                        },
                        "gym2": {
                            "name": "Nature Gym",
                            "width": 15,
                            "height": 15,
                            "tiles": [
                                2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,2,2,2,1,1,1,1,1,2,2,2,1,2,
                                2,1,2,10,10,1,1,1,1,1,10,10,2,1,2,
                                2,1,2,10,10,1,1,1,1,1,10,10,2,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,2,1,2,1,1,1,1,1,2,1,2,1,2,
                                2,1,2,1,2,1,8,8,8,1,2,1,2,1,2,
                                2,1,2,1,2,1,8,8,8,1,2,1,2,1,2,
                                2,1,1,1,1,1,8,8,8,1,1,1,1,1,2,
                                2,1,2,2,2,1,1,1,1,1,2,2,2,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,2,2,2,2,2,2,7,2,2,2,2,2,2,2
                            ],
                            "npcs": [
                                {
                                    "id": "gym2_trainer1",
                                    "x": 3,
                                    "y": 3,
                                    "sprite": 4,
                                    "dialogue": "Nature's power flows through us!",
                                    "trainer": true,
                                    "team": ["wisp", "wisp"]
                                },
                                {
                                    "id": "gym2_leader",
                                    "x": 7,
                                    "y": 7,
                                    "sprite": 8,
                                    "dialogue": "I am Malfurion. Nature will test you!",
                                    "trainer": true,
                                    "gymLeader": "gym2"
                                }
                            ],
                            "warps": [
                                { "x": 7, "y": 14, "toMap": "stormwind", "toX": 23, "toY": 13 }
                            ],
                            "encounters": []
                        },
                        "dragonblight": {
                            "name": "Dragonblight",
                            "width": 25,
                            "height": 20,
                            "tiles": [
                                2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                                2,1,1,1,1,1,1,9,9,9,1,1,1,1,9,9,9,1,1,1,1,1,1,1,2,
                                2,1,10,10,1,1,1,9,9,9,1,1,1,1,9,9,9,1,1,10,10,1,1,1,2,
                                2,1,10,10,1,1,1,9,9,9,1,1,1,1,9,9,9,1,1,10,10,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,2,2,2,2,2,1,1,1,1,2,2,2,2,2,1,1,1,1,1,2,
                                2,1,9,9,1,2,4,4,4,2,1,1,1,1,2,4,4,4,2,1,9,9,1,1,2,
                                2,1,9,9,1,2,4,4,4,2,1,1,1,1,2,4,4,4,2,1,9,9,1,1,2,
                                2,1,9,9,1,2,4,4,4,2,1,1,1,1,2,4,4,4,2,1,9,9,1,1,2,
                                2,1,1,1,1,2,2,2,2,2,1,1,1,1,2,2,2,2,2,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,9,9,9,1,1,1,1,1,9,9,9,1,1,1,1,1,9,9,9,1,1,1,2,
                                2,1,9,9,9,1,1,1,1,1,9,9,9,1,1,1,1,1,9,9,9,1,1,1,2,
                                2,1,9,9,9,1,1,1,1,1,9,9,9,1,1,1,1,1,9,9,9,1,1,1,2,
                                2,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,2,
                                2,1,1,10,10,1,1,2,6,6,6,6,6,6,6,2,1,1,10,10,1,1,1,1,2,
                                2,1,1,10,10,1,1,2,6,5,5,5,5,5,6,2,1,1,10,10,1,1,1,1,2,
                                2,1,1,1,1,1,1,2,6,5,5,7,5,5,6,2,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,2,
                                2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2
                            ],
                            "npcs": [
                                {
                                    "id": "dragon_master",
                                    "x": 12,
                                    "y": 17,
                                    "sprite": 14,
                                    "dialogue": "The dragons here are powerful. Are you ready?",
                                    "trainer": true,
                                    "team": ["whelp", "drake", "dragon"]
                                }
                            ],
                            "warps": [
                                { "x": 12, "y": 17, "toMap": "stormwind", "toX": 15, "toY": 15 }
                            ],
                            "encounters": [
                                { "id": "whelp", "rate": 40 },
                                { "id": "drake", "rate": 25 },
                                { "id": "dragon", "rate": 5 },
                                { "id": "phoenix", "rate": 15 },
                                { "id": "elemental", "rate": 15 }
                            ]
                        },
                        "plaguelands": {
                            "name": "Eastern Plaguelands",
                            "width": 25,
                            "height": 20,
                            "tiles": [
                                2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                                2,9,9,9,9,9,9,1,1,1,1,1,1,1,1,1,9,9,9,9,9,9,9,9,2,
                                2,9,9,9,9,9,9,1,1,1,1,1,1,1,1,1,9,9,9,9,9,9,9,9,2,
                                2,9,9,9,9,9,9,1,1,6,6,6,6,6,1,1,9,9,9,9,9,9,9,9,2,
                                2,1,1,1,1,1,1,1,1,6,4,4,4,6,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,6,4,4,4,6,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,2,2,2,1,1,1,6,4,4,4,6,1,1,1,2,2,2,1,1,1,1,2,
                                2,1,1,2,4,2,1,1,1,6,6,7,6,6,1,1,1,2,4,2,1,1,1,1,2,
                                2,1,1,2,2,2,1,1,1,1,1,1,1,1,1,1,1,2,2,2,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,9,9,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,9,9,1,1,2,
                                2,9,9,9,1,1,6,6,6,6,6,1,1,6,6,6,6,6,1,9,9,9,1,1,2,
                                2,9,9,9,1,1,6,4,4,4,6,1,1,6,4,4,4,6,1,9,9,9,1,1,2,
                                2,1,1,1,1,1,6,4,4,4,6,1,1,6,4,4,4,6,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,6,4,4,4,6,1,1,6,4,4,4,6,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,6,6,6,6,6,1,1,6,6,6,6,6,1,1,1,1,1,1,2,
                                2,1,1,9,9,9,1,1,1,1,1,1,1,1,1,1,1,1,9,9,9,1,1,1,2,
                                2,1,1,9,9,9,1,1,1,1,1,1,1,1,1,1,1,1,9,9,9,1,1,1,2,
                                2,1,1,9,9,9,1,1,1,1,1,7,1,1,1,1,1,1,9,9,9,1,1,1,2,
                                2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2
                            ],
                            "npcs": [
                                {
                                    "id": "necromancer",
                                    "x": 12,
                                    "y": 7,
                                    "sprite": 15,
                                    "dialogue": "The undead shall rise!",
                                    "trainer": true,
                                    "team": ["skeleton", "skeleton", "ghoul", "abomination"]
                                }
                            ],
                            "warps": [
                                { "x": 12, "y": 19, "toMap": "stormwind", "toX": 18, "toY": 15 }
                            ],
                            "encounters": [
                                { "id": "skeleton", "rate": 35 },
                                { "id": "ghoul", "rate": 30 },
                                { "id": "abomination", "rate": 15 },
                                { "id": "banshee", "rate": 15 },
                                { "id": "spider", "rate": 5 }
                            ]
                        },
                        "silithus": {
                            "name": "Silithus Desert",
                            "width": 30,
                            "height": 20,
                            "tiles": [
                                2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,9,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,9,1,1,1,1,1,2,
                                2,1,1,1,9,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,9,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,4,4,4,4,4,4,4,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,4,4,4,4,4,4,4,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,9,9,1,1,1,1,1,1,4,4,4,4,4,4,4,1,1,1,1,1,1,1,1,9,9,1,1,2,
                                2,1,9,9,1,1,1,1,1,1,4,4,4,4,4,4,4,1,1,1,1,1,1,1,1,9,9,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,9,9,9,1,1,1,1,1,9,9,9,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,9,9,9,1,1,1,1,1,9,9,9,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,9,9,9,1,1,1,1,1,9,9,9,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,4,4,4,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,1,1,1,1,1,2,
                                2,1,1,4,4,4,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,1,1,1,1,1,2,
                                2,1,1,4,4,4,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,9,9,1,1,1,1,1,1,1,1,9,9,1,1,1,1,1,1,1,1,1,2,
                                2,1,1,1,1,1,1,1,9,9,1,1,1,1,7,1,1,1,9,9,1,1,1,1,1,1,1,1,1,2,
                                2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2
                            ],
                            "npcs": [
                                {
                                    "id": "qiraji_commander",
                                    "x": 15,
                                    "y": 10,
                                    "sprite": 16,
                                    "dialogue": "The silithid swarm awaits!",
                                    "trainer": true,
                                    "team": ["spider", "nerubian", "nerubian", "infernal"]
                                }
                            ],
                            "warps": [
                                { "x": 15, "y": 18, "toMap": "stormwind", "toX": 20, "toY": 15 }
                            ],
                            "encounters": [
                                { "id": "spider", "rate": 40 },
                                { "id": "nerubian", "rate": 25 },
                                { "id": "quilboar", "rate": 20 },
                                { "id": "infernal", "rate": 10 },
                                { "id": "felhound", "rate": 5 }
                            ]
                        },
                        "elite_four": {
                            "name": "Champion's Arena",
                            "width": 20,
                            "height": 20,
                            "tiles": [
                                4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,8,8,8,8,8,8,8,5,5,8,8,8,8,8,8,8,5,4,
                                4,5,8,6,6,6,6,6,8,5,5,8,6,6,6,6,6,8,5,4,
                                4,5,8,6,5,5,5,6,8,5,5,8,6,5,5,5,6,8,5,4,
                                4,5,8,6,5,5,5,6,8,5,5,8,6,5,5,5,6,8,5,4,
                                4,5,8,6,6,7,6,6,8,5,5,8,6,6,7,6,6,8,5,4,
                                4,5,8,8,8,8,8,8,8,5,5,8,8,8,8,8,8,8,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,5,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,5,4,
                                4,5,8,6,6,6,6,6,6,6,6,6,6,6,6,6,6,8,5,4,
                                4,5,8,6,5,5,5,5,5,5,5,5,5,5,5,5,6,8,5,4,
                                4,5,8,6,5,5,5,5,5,5,5,5,5,5,5,5,6,8,5,4,
                                4,5,8,6,5,5,5,5,5,5,5,5,5,5,5,5,6,8,5,4,
                                4,5,8,6,5,5,5,5,5,5,5,5,5,5,5,5,6,8,5,4,
                                4,5,8,6,6,6,6,6,6,7,7,6,6,6,6,6,6,8,5,4,
                                4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,
                                4,4,4,4,4,4,4,4,4,7,7,4,4,4,4,4,4,4,4,4
                            ],
                            "npcs": [
                                {
                                    "id": "elite_warrior",
                                    "x": 5,
                                    "y": 5,
                                    "sprite": 9,
                                    "dialogue": "I am Grom, master of warriors!",
                                    "trainer": true,
                                    "eliteFour": true,
                                    "team": ["orc_warlord", "orc_grunt", "wolf", "dire_wolf"]
                                },
                                {
                                    "id": "elite_mage",
                                    "x": 14,
                                    "y": 5,
                                    "sprite": 10,
                                    "dialogue": "I am Khadgar, archmage of Dalaran!",
                                    "trainer": true,
                                    "eliteFour": true,
                                    "team": ["elemental", "elemental", "phoenix", "dragon"]
                                },
                                {
                                    "id": "elite_necromancer",
                                    "x": 5,
                                    "y": 15,
                                    "sprite": 11,
                                    "dialogue": "I am Kel'Thuzad, lich of the Scourge!",
                                    "trainer": true,
                                    "eliteFour": true,
                                    "team": ["skeleton", "ghoul", "abomination", "banshee", "nerubian"]
                                },
                                {
                                    "id": "elite_ranger",
                                    "x": 14,
                                    "y": 15,
                                    "sprite": 12,
                                    "dialogue": "I am Sylvanas, Ranger-General!",
                                    "trainer": true,
                                    "eliteFour": true,
                                    "team": ["wolf", "dire_wolf", "phoenix", "banshee"]
                                },
                                {
                                    "id": "champion",
                                    "x": 10,
                                    "y": 10,
                                    "sprite": 13,
                                    "dialogue": "I am Arthas, the Lich King. Face your doom!",
                                    "trainer": true,
                                    "champion": true,
                                    "team": ["dragon", "infernal", "abomination", "phoenix", "nerubian", "dire_wolf"]
                                }
                            ],
                            "warps": [
                                { "x": 9, "y": 19, "toMap": "stormwind", "toX": 10, "toY": 10 },
                                { "x": 10, "y": 19, "toMap": "stormwind", "toX": 10, "toY": 10 }
                            ],
                            "encounters": []
                        }
                    }
                };
                
                this.startGame();
            }
            
            loadCartridge() {
                document.getElementById('cartridgeInput').click();
            }
            
            handleCartridgeLoad(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this.cartridge = JSON.parse(e.target.result);
                        this.startGame();
                    } catch (error) {
                        alert('Invalid cartridge file!');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            }
            
            exportSave() {
                if (!this.player) {
                    alert('No save data!');
                    return;
                }

                const saveData = {
                    version: '1.0',
                    timestamp: Date.now(),
                    player: this.player,
                    gameState: {
                        currentMap: this.currentMapId,
                        position: { x: this.player.x, y: this.player.y },
                        flags: this.flags || {},
                        defeatedTrainers: Array.from(this.defeatedTrainers || [])
                    }
                };

                const dataStr = JSON.stringify(saveData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${this.cartridge?.name || 'game'}-save.json`;
                link.click();
                URL.revokeObjectURL(url);
            }

            showSaveSlotMenu() {
                const slots = this.getSaveSlots();
                let menu = `SELECT SAVE SLOT:

`;
                for (let i = 1; i <= 3; i++) {
                    const slot = slots[`slot${i}`];
                    if (slot) {
                        menu += `SLOT ${i}: ${slot.player.name} - Badges: ${slot.player.badges.length}
`;
                    } else {
                        menu += `SLOT ${i}: [EMPTY]
`;
                    }
                }
                return menu;
            }

            getSaveSlots() {
                const saved = localStorage.getItem('wowmon_saves');
                return saved ? JSON.parse(saved) : {};
            }

            saveToSlot(slotNumber) {
                if (!this.player) {
                    alert('No game data to save!');
                    return;
                }

                const slots = this.getSaveSlots();
                slots[`slot${slotNumber}`] = {
                    version: '1.0',
                    timestamp: Date.now(),
                    player: this.player,
                    gameState: {
                        currentMap: this.currentMapId,
                        position: { x: this.player.x, y: this.player.y },
                        flags: this.flags || {},
                        defeatedTrainers: Array.from(this.defeatedTrainers || [])
                    }
                };

                localStorage.setItem('wowmon_saves', JSON.stringify(slots));
                this.showText(`Game saved to Slot ${slotNumber}!`);
            }

            loadFromSlot(slotNumber) {
                const slots = this.getSaveSlots();
                const slot = slots[`slot${slotNumber}`];

                if (!slot) {
                    alert('No save data in this slot!');
                    return;
                }

                this.loadSaveData(slot);
                this.showText(`Game loaded from Slot ${slotNumber}!`);
            }

            autoSave() {
                // Auto-save to current slot or slot 1
                const currentSlot = this.currentSaveSlot || 1;
                this.saveToSlot(currentSlot);
            }

            importSave() {
                document.getElementById('saveInput').click();
            }

            toggleMute() {
                const isMuted = this.audio.toggleMute();
                const btn = document.getElementById('muteBtn');
                if (btn) {
                    btn.textContent = isMuted ? 'Audio: OFF' : 'Audio: ON';
                }
                this.audio.playSFX('menu_select');
            }

            handleSaveLoad(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const saveData = JSON.parse(e.target.result);
                        this.loadSaveData(saveData);
                        this.showText('Save loaded successfully!');
                    } catch (error) {
                        alert('Invalid save file!');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            }
            
            loadSaveData(saveData) {
                if (!this.cartridge) {
                    alert('Load a game cartridge first!');
                    return;
                }
                
                this.player = saveData.player;
                this.currentMapId = saveData.gameState.currentMap;
                this.player.x = saveData.gameState.position.x;
                this.player.y = saveData.gameState.position.y;
                this.flags = saveData.gameState.flags || {};
                this.defeatedTrainers = new Set(saveData.gameState.defeatedTrainers || []);
                
                // Initialize creature PP if not present
                this.player.creatures.forEach(creature => {
                    if (!creature.pp) {
                        creature.pp = {};
                        creature.moves.forEach(moveId => {
                            const move = this.cartridge.moves[moveId];
                            if (move) {
                                creature.pp[moveId] = move.pp;
                            }
                        });
                    }
                });
                
                this.loadMap(this.currentMapId);
                this.state = 'OVERWORLD';
            }
            
            startGame() {
                if (!this.cartridge) return;

                document.getElementById('loadingScreen').classList.add('hidden');

                // Initialize game from cartridge
                this.initializeFromCartridge();

                // Start overworld music
                this.audio.init();
                this.audio.playMusic('overworld');

                // Start in overworld
                this.state = 'OVERWORLD';
                this.isRunning = true;
            }
            
            initializeFromCartridge() {
                // Create new player if none exists
                if (!this.player) {
                    this.player = {
                        name: 'PLAYER',
                        x: 10,
                        y: 10,
                        facing: 'down',
                        creatures: [],
                        bag: {
                            'health_potion': 5,
                            'soul_stone': 10
                        },
                        money: 3000,
                        badges: []
                    };

                    // Give starter creature
                    if (this.cartridge.starters && this.cartridge.starters.length > 0) {
                        const starterId = this.cartridge.starters[0];
                        const starter = this.cartridge.creatures[starterId];
                        const starterCreature = {
                            id: starter.id,
                            name: starter.name,
                            level: 5,
                            hp: starter.baseHp,
                            maxHp: starter.baseHp,
                            attack: starter.baseAttack,
                            defense: starter.baseDefense,
                            speed: starter.baseSpeed,
                            exp: 0,
                            moves: starter.moves.slice(0, 4),
                            pp: {},
                            energy: 0,
                            maxEnergy: 100
                        };

                        // Initialize PP for moves
                        starterCreature.moves.forEach(moveId => {
                            const move = this.cartridge.moves[moveId];
                            if (move) {
                                starterCreature.pp[moveId] = move.pp;
                            }
                        });

                        this.player.creatures.push(starterCreature);
                    }

                    // Initialize player stats tracking
                    if (!this.player.stats) {
                        this.player.stats = {
                            battlesWon: 0,
                            battlesLost: 0,
                            creaturesCaught: 0,
                            uniqueCreaturesCaught: [],
                            evolutions: 0,
                            stepsWalked: 0,
                            playTime: 0,
                            startTime: Date.now(),
                            typesDefeated: {},
                            highestLevel: 0,
                            moneyEarned: 0,
                            itemsUsed: 0,
                            winStreak: 0,
                            maxWinStreak: 0
                        };
                    }

                    // Initialize achievements
                    if (!this.player.achievements) {
                        this.player.achievements = {};
                    }

                    // Initialize journal
                    if (!this.player.journal) {
                        this.player.journal = {
                            entries: [],
                            discoveries: []
                        };
                    }

                    // Initialize trading data
                    if (!this.player.tradingData) {
                        this.player.tradingData = {
                            tradesCompleted: 0,
                            friendCode: this.generateFriendCode(),
                            offeredCreatures: []
                        };
                    }
                }

                // Load starting map
                this.currentMapId = this.cartridge.startingMap || 'goldshire';
                this.loadMap(this.currentMapId);

                // Initialize game state
                this.defeatedTrainers = new Set();
                this.flags = {};
            }

            checkAchievements() {
                if (!this.cartridge.achievements || !this.player) return;

                Object.values(this.cartridge.achievements).forEach(achievement => {
                    // Skip if already unlocked
                    if (this.player.achievements[achievement.id]) return;

                    let unlocked = false;
                    const cond = achievement.condition;

                    switch (cond.type) {
                        case 'creatures_caught':
                            unlocked = this.player.stats.creaturesCaught >= cond.count;
                            break;
                        case 'unique_creatures':
                            unlocked = this.player.stats.uniqueCreaturesCaught.length >= cond.count;
                            break;
                        case 'catch_species':
                            unlocked = this.player.creatures.some(c => c.id === cond.species);
                            break;
                        case 'battles_won':
                            unlocked = this.player.stats.battlesWon >= cond.count;
                            break;
                        case 'badges':
                            unlocked = this.player.badges.length >= cond.count;
                            break;
                        case 'evolutions':
                            unlocked = this.player.stats.evolutions >= cond.count;
                            break;
                        case 'max_level':
                            unlocked = this.player.creatures.some(c => c.level >= cond.level);
                            break;
                        case 'type_defeated':
                            const count = this.player.stats.typesDefeated[cond.creatureType] || 0;
                            unlocked = count >= cond.count;
                            break;
                        case 'win_streak':
                            unlocked = this.player.stats.winStreak >= cond.count;
                            break;
                        case 'money':
                            unlocked = this.player.money >= cond.amount;
                            break;
                    }

                    if (unlocked) {
                        this.unlockAchievement(achievement);
                    }
                });
            }

            unlockAchievement(achievement) {
                this.player.achievements[achievement.id] = {
                    unlocked: true,
                    timestamp: Date.now()
                };

                // Apply reward
                const reward = achievement.reward;
                if (reward.type === 'money') {
                    this.player.money += reward.amount;
                    this.showText(`Achievement Unlocked: ${achievement.name}!
Reward: ${reward.amount} gold`);
                } else if (reward.type === 'item') {
                    this.player.bag[reward.item] = (this.player.bag[reward.item] || 0) + reward.count;
                    this.showText(`Achievement Unlocked: ${achievement.name}!
Reward: ${reward.item} x${reward.count}`);
                } else if (reward.type === 'title') {
                    if (!this.player.titles) this.player.titles = [];
                    this.player.titles.push(reward.title);
                    this.showText(`Achievement Unlocked: ${achievement.name}!
Title Earned: ${reward.title}`);
                }

                // Add journal entry
                if (this.player.journal) {
                    this.player.journal.entries.push({
                        type: 'achievement',
                        achievement: achievement.name,
                        timestamp: Date.now()
                    });
                }

                // Auto-save after achievement
                this.autoSave();
            }

            loadMap(mapId) {
                const mapData = this.cartridge.maps[mapId];
                if (!mapData) {
                    console.error(`Map ${mapId} not found!`);
                    return;
                }

                this.map = {
                    id: mapId,
                    name: mapData.name,
                    width: mapData.width,
                    height: mapData.height,
                    tiles: mapData.tiles,
                    npcs: mapData.npcs || [],
                    warps: mapData.warps || [],
                    encounters: mapData.encounters || []
                };
            }

            generateFriendCode() {
                // Generate a 12-digit friend code for trading
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 12; i++) {
                    if (i > 0 && i % 4 === 0) code += '-';
                    code += chars[Math.floor(Math.random() * chars.length)];
                }
                return code;
            }
            
            showLoadingScreen() {
                this.ctx.fillStyle = '#0f380f';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.fillStyle = '#9bbc0f';
                this.ctx.font = '16px monospace';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('WOWMON', this.canvas.width/2, 60);
                this.ctx.font = '8px monospace';
                this.ctx.fillText('Pocket Creatures of Azeroth', this.canvas.width/2, 80);
            }
            
            gameLoop(timestamp = 0) {
                const deltaTime = timestamp - this.lastFrame;
                this.lastFrame = timestamp;
                this.frameCount++;
                
                if (this.isRunning) {
                    this.update(deltaTime);
                    this.render();
                }
                
                requestAnimationFrame((t) => this.gameLoop(t));
            }
            
            update(deltaTime) {
                // Update timers
                if (this.moveTimer > 0) {
                    this.moveTimer -= deltaTime;
                }
                
                switch (this.state) {
                    case 'OVERWORLD':
                        this.updateOverworld(deltaTime);
                        break;
                    case 'BATTLE':
                        this.updateBattle(deltaTime);
                        break;
                    case 'MENU':
                        this.updateMenu();
                        break;
                    case 'TEXT':
                        this.updateText();
                        break;
                }
            }
            
            updateOverworld(deltaTime) {
                // Player movement
                if (this.moveTimer <= 0) {
                    let dx = 0, dy = 0;
                    
                    if (this.keys['ArrowUp']) {
                        dy = -1;
                        this.player.facing = 'up';
                    } else if (this.keys['ArrowDown']) {
                        dy = 1;
                        this.player.facing = 'down';
                    } else if (this.keys['ArrowLeft']) {
                        dx = -1;
                        this.player.facing = 'left';
                    } else if (this.keys['ArrowRight']) {
                        dx = 1;
                        this.player.facing = 'right';
                    }
                    
                    if (dx || dy) {
                        const newX = this.player.x + dx;
                        const newY = this.player.y + dy;
                        
                        if (this.canMove(newX, newY)) {
                            this.player.x = newX;
                            this.player.y = newY;
                            this.moveTimer = this.moveDelay;
                            
                            // Check for encounters
                            this.checkEncounters();
                            
                            // Check for warps
                            this.checkWarps();
                        }
                    }
                }
                
                // Menu
                if (this.keys['Enter']) {
                    this.state = 'MENU';
                    this.menuIndex = 0;
                    this.keys['Enter'] = false;
                    document.getElementById('mainMenu').classList.add('active');
                }
                
                // Interact
                if (this.keys['z']) {
                    this.interact();
                    this.keys['z'] = false;
                }
            }
            
            canMove(x, y) {
                if (x < 0 || x >= this.map.width || y < 0 || y >= this.map.height) {
                    return false;
                }
                
                const tile = this.map.tiles[y * this.map.width + x];
                const tileData = this.cartridge.tiles[tile];
                
                // Check for NPC collision
                const npcCollision = this.map.npcs.some(npc => npc.x === x && npc.y === y);
                if (npcCollision) return false;
                
                return tileData && tileData.walkable;
            }
            
            checkEncounters() {
                const tile = this.map.tiles[this.player.y * this.map.width + this.player.x];
                const tileData = this.cartridge.tiles[tile];
                
                if (tileData && tileData.encounter && Math.random() < 0.1) {
                    const possibleCreatures = this.map.encounters;
                    if (possibleCreatures && possibleCreatures.length > 0) {
                        const encounterId = possibleCreatures[Math.floor(Math.random() * possibleCreatures.length)];
                        this.startBattle('wild', encounterId);
                    }
                }
            }
            
            checkWarps() {
                const warp = this.map.warps.find(w => 
                    w.x === this.player.x && w.y === this.player.y
                );
                
                if (warp) {
                    this.loadMap(warp.toMap);
                    this.player.x = warp.toX;
                    this.player.y = warp.toY;
                }
            }
            
            interact() {
                // Check for NPC in front of player
                const facingX = this.player.x + (this.player.facing === 'left' ? -1 : this.player.facing === 'right' ? 1 : 0);
                const facingY = this.player.y + (this.player.facing === 'up' ? -1 : this.player.facing === 'down' ? 1 : 0);
                
                const npc = this.map.npcs.find(n => n.x === facingX && n.y === facingY);
                if (npc) {
                    this.showText(npc.dialogue || 'Hello!');
                    
                    // Check for special NPCs
                    if (npc.id === 'nurse_joy') {
                        this.healParty();
                    } else if (npc.trainer && !this.defeatedTrainers.has(npc.id)) {
                        setTimeout(() => {
                            this.startTrainerBattle(npc);
                        }, 2000);
                    } else if (npc.gymLeader && !this.defeatedTrainers.has(npc.id)) {
                        const gymData = this.cartridge.trainers[npc.gymLeader];
                        if (gymData) {
                            setTimeout(() => {
                                this.startGymBattle(npc, gymData);
                            }, 2000);
                        }
                    }
                }
            }
            
            healParty() {
                this.player.creatures.forEach(creature => {
                    creature.hp = creature.maxHp;
                    // Restore PP
                    creature.moves.forEach(moveId => {
                        const move = this.cartridge.moves[moveId];
                        if (move) {
                            creature.pp[moveId] = move.pp;
                        }
                    });
                });
                setTimeout(() => {
                    this.showText('Your creatures are fully healed!');
                }, 1500);
            }
            
            showText(text) {
                // Store previous state so we can return to it
                if (this.state !== 'TEXT') {
                    this.previousState = this.state;
                }
                this.state = 'TEXT';
                this.currentText = text;
                const textBox = document.getElementById('textBox');
                const textContent = document.getElementById('textContent');
                textContent.textContent = text;
                textBox.classList.add('active');
            }

            advanceText() {
                const textBox = document.getElementById('textBox');
                textBox.classList.remove('active');
                // Return to previous state if we were in battle, otherwise go to overworld
                this.state = this.previousState === 'BATTLE' ? 'BATTLE' : 'OVERWORLD';
                this.currentText = null;
                this.previousState = null;
            }
            
            updateText() {
                // Text is handled through DOM
            }
            
            startBattle(type, enemyId) {
                // Find first healthy creature
                const healthyCreature = this.player.creatures.find(c => c.hp > 0);
                if (!healthyCreature) {
                    this.showText('All your creatures have fainted!');
                    return;
                }

                // Play encounter sound and switch to battle music
                this.audio.playSFX('encounter');
                setTimeout(() => {
                    this.audio.playSFX('battle_start');
                    this.audio.playMusic('battle');
                }, 300);

                this.state = 'BATTLE';
                this.battle = {
                    type: type,
                    enemyId: enemyId,
                    turn: 'player',
                    playerCreature: healthyCreature,
                    enemyCreature: this.createEnemyCreature(enemyId),
                    actionQueue: [],
                    waitingForInput: true
                };

                this.battleMenuIndex = 0;
                this.showingMoves = false;

                document.getElementById('battleUI').classList.add('active');
                // document.getElementById('battleMenu').classList.add('active'); // Disable old menu
                
                // Setup Move HUD
                const moveHUD = document.getElementById('moveHUD');
                moveHUD.style.display = 'flex';
                moveHUD.innerHTML = '';
                
                this.battle.playerCreature.moves.forEach((moveId, index) => {
                    const move = this.cartridge.moves[moveId];
                    const cost = move.energyCost || 30;
                    const slot = document.createElement('div');
                    slot.className = 'move-slot';
                    slot.style.cssText = `
                        flex: 1; background: #222; padding: 10px; border-radius: 8px; 
                        border: 2px solid #333; text-align: center; transition: all 0.2s;
                        opacity: 0.5;
                    `;
                    slot.innerHTML = `
                        <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">${index + 1}. ${move.name}</div>
                        <div style="color: #00f2fe; font-size: 10px;">${cost} EN</div>
                        <div style="color: #aaa; font-size: 10px;">${move.type}</div>
                    `;
                    moveHUD.appendChild(slot);
                });

                this.updateBattleUI();

                // Show battle start message
                this.showText(`Wild ${this.battle.enemyCreature.name} appeared!`);
                setTimeout(() => {
                    this.advanceText();
                }, 1500);
            }
            
            startTrainerBattle(npc) {
                const healthyCreature = this.player.creatures.find(c => c.hp > 0);
                if (!healthyCreature) {
                    this.showText('All your creatures have fainted!');
                    return;
                }
                
                this.state = 'BATTLE';
                this.battle = {
                    type: 'trainer',
                    trainerId: npc.id,
                    trainerTeam: npc.team || ['gnoll'],
                    currentEnemyIndex: 0,
                    turn: 'player',
                    playerCreature: healthyCreature,
                    enemyCreature: this.createEnemyCreature(npc.team[0]),
                    actionQueue: [],
                    waitingForInput: true
                };
                
                this.battleMenuIndex = 0;
                this.showingMoves = false;
                
                document.getElementById('battleUI').classList.add('active');
                // document.getElementById('battleMenu').classList.add('active');
                
                // Setup Move HUD
                const moveHUD = document.getElementById('moveHUD');
                moveHUD.style.display = 'flex';
                moveHUD.innerHTML = '';
                
                this.battle.playerCreature.moves.forEach((moveId, index) => {
                    const move = this.cartridge.moves[moveId];
                    const cost = move.energyCost || 30;
                    const slot = document.createElement('div');
                    slot.className = 'move-slot';
                    slot.style.cssText = `
                        flex: 1; background: #222; padding: 10px; border-radius: 8px; 
                        border: 2px solid #333; text-align: center; transition: all 0.2s;
                        opacity: 0.5;
                    `;
                    slot.innerHTML = `
                        <div style="font-weight: bold; font-size: 12px; margin-bottom: 5px;">${index + 1}. ${move.name}</div>
                        <div style="color: #00f2fe; font-size: 10px;">${cost} EN</div>
                        <div style="color: #aaa; font-size: 10px;">${move.type}</div>
                    `;
                    moveHUD.appendChild(slot);
                });

                this.updateBattleUI();
                
                this.showText(`Trainer wants to battle!`);
                setTimeout(() => {
                    this.advanceText();
                }, 1500);
            }
            
            startGymBattle(npc, gymData) {
                const healthyCreature = this.player.creatures.find(c => c.hp > 0);
                if (!healthyCreature) {
                    this.showText('All your creatures have fainted!');
                    return;
                }
                
                this.state = 'BATTLE';
                this.battle = {
                    type: 'gym',
                    trainerId: npc.id,
                    gymLeader: npc.gymLeader,
                    gymData: gymData,
                    trainerTeam: gymData.team,
                    currentEnemyIndex: 0,
                    turn: 'player',
                    playerCreature: healthyCreature,
                    enemyCreature: this.createEnemyCreature(gymData.team[0], 10 + (this.player.badges.length * 5)),
                    actionQueue: [],
                    waitingForInput: true
                };
                
                this.battleMenuIndex = 0;
                this.showingMoves = false;
                
                document.getElementById('battleUI').classList.add('active');
                document.getElementById('battleMenu').classList.add('active');
                this.updateBattleUI();
                
                this.showText(`${gymData.name} ${gymData.title} wants to battle!`);
                setTimeout(() => {
                    this.advanceText();
                }, 1500);
            }
            
            createEnemyCreature(id, baseLevel = 5) {
                const creatureData = this.cartridge.creatures[id] || this.cartridge.creatures['gnoll'];
                const level = baseLevel + Math.floor(Math.random() * 5) - 1;
                const creature = {
                    id: id,
                    name: creatureData.name,
                    level: level,
                    hp: Math.floor(creatureData.baseHp * (1 + level * 0.1)),
                    maxHp: Math.floor(creatureData.baseHp * (1 + level * 0.1)),
                    attack: Math.floor(creatureData.baseAttack * (1 + level * 0.1)),
                    defense: Math.floor(creatureData.baseDefense * (1 + level * 0.1)),
                    specialAttack: Math.floor((creatureData.baseSpecialAttack || creatureData.baseAttack) * (1 + level * 0.1)),
                    specialDefense: Math.floor((creatureData.baseSpecialDefense || creatureData.baseDefense) * (1 + level * 0.1)),
                    speed: Math.floor(creatureData.baseSpeed * (1 + level * 0.1)),
                    moves: creatureData.moves.slice(0, Math.min(4, 1 + Math.floor(level / 10))),
                    pp: {},
                    energy: 0,
                    maxEnergy: 100,
                    status: null, // For status conditions
                    ability: creatureData.ability || null
                };
                
                // Initialize PP
                creature.moves.forEach(moveId => {
                    const move = this.cartridge.moves[moveId];
                    if (move) {
                        creature.pp[moveId] = move.pp;
                    }
                });
                
                return creature;
            }
            
            handleBattleInput(key) {
                if (!this.battle || !this.battle.waitingForInput) return;

                // Number keys for moves
                if (['1', '2', '3', '4'].includes(key)) {
                    const index = parseInt(key) - 1;
                    const moveId = this.battle.playerCreature.moves[index];
                    if (moveId) {
                        const move = this.cartridge.moves[moveId];
                        const cost = move.energyCost || 30;
                        if (this.battle.playerCreature.energy >= cost) {
                            this.battle.playerCreature.energy -= cost;
                            this.useMove(this.battle.playerCreature, this.battle.enemyCreature, moveId);
                        } else {
                            this.audio.playSFX('menu_back'); // Error sound
                        }
                    }
                } else if (key === 'x' || key === 'Escape') {
                    // Run?
                    if (this.battle.type === 'wild') {
                        this.showText('Got away safely!');
                        setTimeout(() => {
                            this.endBattle();
                        }, 1000);
                    }
                }
            }
            
            selectBattleOption(index) {
                switch (index) {
                    case 0: // FIGHT
                        this.showMoveSelection();
                        break;
                    case 1: // CREATURES
                        document.getElementById('battleMenu').classList.remove('active');
                        this.openBattleSwitchMenu();
                        break;
                    case 2: // RUN
                        if (this.battle.type === 'wild') {
                            this.showText('Got away safely!');
                            setTimeout(() => {
                                this.endBattle();
                            }, 1000);
                        } else {
                            this.showText("Can't run from trainer battles!");
                            setTimeout(() => this.advanceText(), 1000);
                        }
                        break;
                }
            }
            
            showMoveSelection() {
                this.showingMoves = true;
                this.moveMenuIndex = 0;
                document.getElementById('battleMenu').classList.remove('active');
                document.getElementById('moveMenu').classList.add('active');
                
                // Update move display
                const creature = this.battle.playerCreature;
                creature.moves.forEach((moveId, index) => {
                    const move = this.cartridge.moves[moveId];
                    if (move) {
                        document.getElementById(`move${index}Name`).textContent = move.name.toUpperCase();
                        document.getElementById(`move${index}PP`).textContent = `${creature.pp[moveId]}/${move.pp}`;
                    }
                });
                
                // Update initial selection
                document.querySelectorAll('.move-option').forEach((option, index) => {
                    option.classList.toggle('selected', index === 0);
                });
            }
            
            selectMove(index) {
                const moveId = this.battle.playerCreature.moves[index];
                const move = this.cartridge.moves[moveId];
                
                if (!move || this.battle.playerCreature.pp[moveId] <= 0) {
                    this.showText('No PP left for this move!');
                    setTimeout(() => this.advanceText(), 1000);
                    return;
                }
                
                this.showingMoves = false;
                document.getElementById('moveMenu').classList.remove('active');
                
                // Execute battle turn
                this.executeTurn(moveId);
            }
            
            getTypeEffectiveness(moveType, defenderTypes) {
                const effectiveness = {
                    'water': { 'fire': 2.0, 'earth': 2.0, 'water': 0.5, 'nature': 0.5 },
                    'fire': { 'nature': 2.0, 'ice': 2.0, 'water': 0.5, 'fire': 0.5, 'earth': 0.5 },
                    'nature': { 'water': 2.0, 'earth': 2.0, 'fire': 0.5, 'beast': 0.5 },
                    'earth': { 'fire': 2.0, 'electric': 2.0, 'nature': 0.5, 'water': 0.5 },
                    'ice': { 'nature': 2.0, 'beast': 2.0, 'fire': 0.5, 'water': 0.5 },
                    'electric': { 'water': 2.0, 'beast': 2.0, 'earth': 0.0, 'electric': 0.5 },
                    'beast': { 'normal': 1.5, 'beast': 0.5, 'shadow': 0.5 },
                    'shadow': { 'spirit': 2.0, 'magic': 2.0, 'shadow': 0.5, 'normal': 0.5 },
                    'magic': { 'shadow': 2.0, 'demon': 2.0, 'magic': 0.5 },
                    'demon': { 'spirit': 2.0, 'nature': 1.5, 'demon': 0.5, 'magic': 0.5 },
                    'spirit': { 'demon': 2.0, 'shadow': 1.5, 'spirit': 0.5 },
                    'normal': { 'earth': 0.5 }
                };
                let multiplier = 1.0;
                for (const defenderType of defenderTypes) {
                    if (effectiveness[moveType] && effectiveness[moveType][defenderType] !== undefined) {
                        multiplier *= effectiveness[moveType][defenderType];
                    }
                }
                return multiplier;
            }

            hasSTAB(moveType, attackerTypes) {
                return attackerTypes.includes(moveType);
            }

            chooseEnemyMove(attacker, defender) {
                const availableMoves = attacker.moves.filter(moveId => attacker.pp[moveId] > 0);
                if (availableMoves.length === 0) return attacker.moves[0];
                if (Math.random() < 0.35) {
                    let bestMove = availableMoves[0];
                    let bestScore = 0;
                    for (const moveId of availableMoves) {
                        const move = this.cartridge.moves[moveId];
                        if (!move) continue;
                        const attackerData = this.cartridge.creatures[attacker.id];
                        const defenderData = this.cartridge.creatures[defender.id];
                        if (!attackerData || !defenderData) continue;
                        let score = move.power || 0;
                        score *= this.getTypeEffectiveness(move.type, defenderData.type);
                        if (this.hasSTAB(move.type, attackerData.type)) score *= 1.5;
                        if (move.effect === 'heal' && attacker.hp < attacker.maxHp * 0.3) score += 100;
                        if ((move.effect === 'raise_attack' || move.effect === 'defense_up') && (!attacker.statBoosts || attacker.statBoosts < 2)) score += 50;
                        if (score > bestScore) {
                            bestScore = score;
                            bestMove = moveId;
                        }
                    }
                    return bestMove;
                }
                return availableMoves[Math.floor(Math.random() * availableMoves.length)];
            }

            executeTurn(playerMoveId) {
                this.battle.waitingForInput = false;

                // Determine turn order based on speed (paralyze halves speed)
                const playerSpeed = this.battle.playerCreature.status === 'paralyze' ?
                    Math.floor(this.battle.playerCreature.speed / 2) : this.battle.playerCreature.speed;
                const enemySpeed = this.battle.enemyCreature.status === 'paralyze' ?
                    Math.floor(this.battle.enemyCreature.speed / 2) : this.battle.enemyCreature.speed;
                const playerFirst = playerSpeed >= enemySpeed;

                // Choose enemy move
                const enemyMoves = this.battle.enemyCreature.moves.filter(moveId =>
                    this.battle.enemyCreature.pp[moveId] > 0
                );
                const enemyMoveId = enemyMoves[Math.floor(Math.random() * enemyMoves.length)];

                if (playerFirst) {
                    // Check player status condition
                    const playerSkipsTurn = this.processStatusCondition(this.battle.playerCreature);
                    if (!playerSkipsTurn) {
                        this.executeMove(this.battle.playerCreature, this.battle.enemyCreature, playerMoveId, true);
                    }
                    setTimeout(() => {
                        if (this.battle && this.battle.enemyCreature.hp > 0) {
                            // Check enemy status condition
                            const enemySkipsTurn = this.processStatusCondition(this.battle.enemyCreature);
                            if (!enemySkipsTurn) {
                                this.executeMove(this.battle.enemyCreature, this.battle.playerCreature, enemyMoveId, false);
                            } else {
                                // Enemy skipped turn, return control to player
                                setTimeout(() => {
                                    if (this.battle) {
                                        this.battle.waitingForInput = true;
                                        document.getElementById('battleMenu').classList.add('active');
                                    }
                                }, 1000);
                            }
                        }
                    }, 2000);
                } else {
                    // Check enemy status condition
                    const enemySkipsTurn = this.processStatusCondition(this.battle.enemyCreature);
                    if (!enemySkipsTurn) {
                        this.executeMove(this.battle.enemyCreature, this.battle.playerCreature, enemyMoveId, false);
                    }
                    setTimeout(() => {
                        if (this.battle && this.battle.playerCreature.hp > 0) {
                            // Check player status condition
                            const playerSkipsTurn = this.processStatusCondition(this.battle.playerCreature);
                            if (!playerSkipsTurn) {
                                this.executeMove(this.battle.playerCreature, this.battle.enemyCreature, playerMoveId, true);
                            } else {
                                // Player skipped turn, return control to player
                                setTimeout(() => {
                                    if (this.battle) {
                                        this.battle.waitingForInput = true;
                                        document.getElementById('battleMenu').classList.add('active');
                                    }
                                }, 1000);
                            }
                        }
                    }, 2000);
                }
            }
            
            useMove(attacker, defender, moveId) {
                const move = this.cartridge.moves[moveId];
                if (!move) return;

                // Check status conditions that might prevent moving
                const skipsTurn = this.processStatusCondition(attacker);
                if (skipsTurn) return;

                this.executeMove(attacker, defender, moveId, attacker === this.battle.playerCreature);
            }

            executeMove(attacker, defender, moveId, isPlayer) {
                const move = this.cartridge.moves[moveId];
                if (!move) return;

                // Deduct PP
                attacker.pp[moveId]--;

                // Show move text (non-blocking for real-time feel)
                this.showText(`${attacker.name} used ${move.name}!`);
                
                // Play attack sound
                this.audio.playSFX('attack');

                // Calculate damage immediately
                if (move.power > 0) {
                    // Check accuracy
                    const accuracyRoll = Math.random() * 100;
                    if (accuracyRoll > move.accuracy) {
                        this.showText(`${attacker.name}'s attack missed!`);
                        return;
                    }

                    // Improved damage formula with Physical/Special split
                    const levelMod = (2 * attacker.level / 5 + 2);

                    // Determine move category and use appropriate stats
                    const category = move.category || 'physical'; // Default to physical for old moves
                    let attackValue, defenseValue;

                    if (category === 'special') {
                        attackValue = Math.max(1, attacker.specialAttack || attacker.attack || 1);
                        defenseValue = Math.max(1, defender.specialDefense || defender.defense || 1);
                    } else {
                        attackValue = Math.max(1, attacker.attack || 1);
                        // Burn halves physical attack damage
                        if (attacker.status === 'burn') {
                            attackValue = Math.floor(attackValue / 2);
                        }
                        defenseValue = Math.max(1, defender.defense || 1);
                    }

                    let baseDamage = (levelMod * move.power * attackValue / defenseValue / 50) + 2;

                    // Get creature type data
                    const attackerData = this.cartridge.creatures[attacker.id];
                    const defenderData = this.cartridge.creatures[defender.id];

                    // Apply STAB (Same Type Attack Bonus)
                    if (attackerData && this.hasSTAB && this.hasSTAB(move.type, attackerData.type)) {
                        baseDamage *= 1.5;
                    }

                        // Apply type effectiveness
                        let effectiveness = 1.0;
                        if (defenderData && this.getTypeEffectiveness) {
                            effectiveness = this.getTypeEffectiveness(move.type, defenderData.type);
                            baseDamage *= effectiveness;
                        }

                        // Apply weather effects
                        if (this.battle.weather) {
                            if (this.battle.weather === 'sun') {
                                if (move.type === 'fire') baseDamage *= 1.5;
                                if (move.type === 'water') baseDamage *= 0.5;
                            } else if (this.battle.weather === 'rain') {
                                if (move.type === 'water') baseDamage *= 1.5;
                                if (move.type === 'fire') baseDamage *= 0.5;
                            } else if (this.battle.weather === 'sandstorm') {
                                // Sandstorm boosts earth/rock moves
                                if (move.type === 'earth') baseDamage *= 1.2;
                            }
                        }

                        // Critical hit (6.25% chance)
                        let isCritical = false;
                        if (Math.random() < 0.0625) {
                            baseDamage *= 1.5;
                            isCritical = true;
                        }

                        // Random variance (85-100%)
                        const randomMod = (85 + Math.random() * 15) / 100;
                        const damage = Math.max(1, Math.floor(baseDamage * randomMod));

                        defender.hp = Math.max(0, defender.hp - damage);

                        // Play damage sound
                        this.audio.playSFX('damage');

                        // Show effectiveness and critical hit messages
                        if (isCritical) {
                            setTimeout(() => this.showText("A critical hit!"), 1200);
                        }
                        if (effectiveness > 1.5) {
                            setTimeout(() => this.showText("It's super effective!"), isCritical ? 1600 : 1200);
                        } else if (effectiveness < 0.75 && effectiveness > 0) {
                            setTimeout(() => this.showText("It's not very effective..."), isCritical ? 1600 : 1200);
                        } else if (effectiveness === 0) {
                            setTimeout(() => this.showText("It had no effect!"), isCritical ? 1600 : 1200);
                        }

                        this.updateBattleUI();

                        // Apply secondary status effects (if move has them)
                        if (move.secondaryEffect && Math.random() * 100 < move.secondaryEffect.chance) {
                            if (!defender.status) {
                                this.applyStatusCondition(defender, move.secondaryEffect.effect);
                            }
                        }

                        // Check for fainting
                        if (defender.hp === 0) {
                            setTimeout(() => {
                                this.handleFaint(isPlayer ? false : true);
                            }, 1000);
                        }
                    } else {
                        // Status move implementation
                        if (move.effect === 'burn' || move.effect === 'poison' || move.effect === 'paralyze' || move.effect === 'sleep' || move.effect === 'freeze') {
                            // Status-inflicting moves
                            if (defender.status) {
                                this.showText(`${defender.name} is already affected by a status condition!`);
                            } else {
                                this.applyStatusCondition(defender, move.effect);
                            }
                        } else if (move.effect === 'weather_sun') {
                            this.battle.weather = 'sun';
                            this.battle.weatherTurns = 5;
                            this.showText('The sunlight turned harsh!');
                        } else if (move.effect === 'weather_rain') {
                            this.battle.weather = 'rain';
                            this.battle.weatherTurns = 5;
                            this.showText('It started to rain!');
                        } else if (move.effect === 'weather_sandstorm') {
                            this.battle.weather = 'sandstorm';
                            this.battle.weatherTurns = 5;
                            this.showText('A sandstorm brewed!');
                        } else if (move.effect === 'heal') {
                            const healAmount = Math.floor(attacker.maxHp * 0.5);
                            attacker.hp = Math.min(attacker.maxHp, attacker.hp + healAmount);
                            this.showText(`${attacker.name} regained health!`);
                            this.audio.playSFX('heal');
                            this.updateBattleUI();
                        } else if (move.effect === 'raise_attack') {
                            attacker.statBoosts = (attacker.statBoosts || 0) + 1;
                            attacker.attack = Math.floor(attacker.attack * 1.5);
                            this.showText(`${attacker.name}'s attack rose!`);
                        } else if (move.effect === 'defense_up') {
                            attacker.defense = Math.floor(attacker.defense * 1.5);
                            this.showText(`${attacker.name}'s defense rose!`);
                        }
                    }
                }
            }



            
            // Weather System
            processWeather() {
                if (!this.battle.weather || !this.battle.weatherTurns) return;

                // Decrease weather duration
                this.battle.weatherTurns--;

                // Apply weather damage
                if (this.battle.weather === 'sandstorm') {
                    const playerData = this.cartridge.creatures[this.battle.playerCreature.id];
                    const enemyData = this.cartridge.creatures[this.battle.enemyCreature.id];

                    // Sandstorm damages non-earth/rock/steel types
                    if (!playerData.type.includes('earth') && !playerData.type.includes('warrior')) {
                        const damage = Math.max(1, Math.floor(this.battle.playerCreature.maxHp / 16));
                        this.battle.playerCreature.hp = Math.max(0, this.battle.playerCreature.hp - damage);
                        setTimeout(() => this.showText(`${this.battle.playerCreature.name} is buffeted by the sandstorm!`), 500);
                    }
                    if (!enemyData.type.includes('earth') && !enemyData.type.includes('warrior')) {
                        const damage = Math.max(1, Math.floor(this.battle.enemyCreature.maxHp / 16));
                        this.battle.enemyCreature.hp = Math.max(0, this.battle.enemyCreature.hp - damage);
                        setTimeout(() => this.showText(`${this.battle.enemyCreature.name} is buffeted by the sandstorm!`), 800);
                    }
                    this.updateBattleUI();
                } else if (this.battle.weather === 'hail') {
                    const playerData = this.cartridge.creatures[this.battle.playerCreature.id];
                    const enemyData = this.cartridge.creatures[this.battle.enemyCreature.id];

                    // Hail damages non-ice types
                    if (!playerData.type.includes('ice')) {
                        const damage = Math.max(1, Math.floor(this.battle.playerCreature.maxHp / 16));
                        this.battle.playerCreature.hp = Math.max(0, this.battle.playerCreature.hp - damage);
                        setTimeout(() => this.showText(`${this.battle.playerCreature.name} is pelted by hail!`), 500);
                    }
                    if (!enemyData.type.includes('ice')) {
                        const damage = Math.max(1, Math.floor(this.battle.enemyCreature.maxHp / 16));
                        this.battle.enemyCreature.hp = Math.max(0, this.battle.enemyCreature.hp - damage);
                        setTimeout(() => this.showText(`${this.battle.enemyCreature.name} is pelted by hail!`), 800);
                    }
                    this.updateBattleUI();
                }

                // End weather if duration expired
                if (this.battle.weatherTurns <= 0) {
                    const weatherEnd = {
                        'sun': 'The sunlight faded.',
                        'rain': 'The rain stopped.',
                        'sandstorm': 'The sandstorm subsided.',
                        'hail': 'The hail stopped.'
                    };
                    if (weatherEnd[this.battle.weather]) {
                        setTimeout(() => this.showText(weatherEnd[this.battle.weather]), 1200);
                    }
                    this.battle.weather = null;
                    this.battle.weatherTurns = 0;
                }
            }

            // Status Condition System
            applyStatusCondition(creature, status) {
                creature.status = status;
                const statusMessages = {
                    'burn': `${creature.name} was burned!`,
                    'poison': `${creature.name} was poisoned!`,
                    'paralyze': `${creature.name} was paralyzed!`,
                    'sleep': `${creature.name} fell asleep!`,
                    'freeze': `${creature.name} was frozen solid!`
                };
                if (statusMessages[status]) {
                    setTimeout(() => this.showText(statusMessages[status]), 1200);
                }
            }

            processStatusCondition(creature) {
                if (!creature.status) return false;

                switch (creature.status) {
                    case 'burn':
                        // Burn: 1/16 max HP damage per turn, halves physical attack
                        const burnDamage = Math.max(1, Math.floor(creature.maxHp / 16));
                        creature.hp = Math.max(0, creature.hp - burnDamage);
                        this.showText(`${creature.name} is hurt by its burn!`);
                        this.updateBattleUI();
                        return false;

                    case 'poison':
                        // Poison: 1/8 max HP damage per turn
                        const poisonDamage = Math.max(1, Math.floor(creature.maxHp / 8));
                        creature.hp = Math.max(0, creature.hp - poisonDamage);
                        this.showText(`${creature.name} is hurt by poison!`);
                        this.updateBattleUI();
                        return false;

                    case 'paralyze':
                        // Paralyze: 25% chance to be fully paralyzed, 50% speed
                        if (Math.random() < 0.25) {
                            this.showText(`${creature.name} is paralyzed! It can't move!`);
                            return true; // Skip turn
                        }
                        return false;

                    case 'sleep':
                        // Sleep: Cannot move for 1-3 turns
                        if (!creature.sleepTurns) {
                            creature.sleepTurns = 1 + Math.floor(Math.random() * 3);
                        }
                        creature.sleepTurns--;
                        if (creature.sleepTurns <= 0) {
                            creature.status = null;
                            creature.sleepTurns = null;
                            this.showText(`${creature.name} woke up!`);
                            return false;
                        }
                        this.showText(`${creature.name} is fast asleep!`);
                        return true; // Skip turn

                    case 'freeze':
                        // Freeze: 20% chance to thaw each turn
                        if (Math.random() < 0.2) {
                            creature.status = null;
                            this.showText(`${creature.name} thawed out!`);
                            return false;
                        }
                        this.showText(`${creature.name} is frozen solid!`);
                        return true; // Skip turn
                }
                return false;
            }

            handleFaint(playerFainted) {
                if (playerFainted) {
                    this.showText(`${this.battle.playerCreature.name} fainted!`);
                    
                    // Check for more creatures
                    const nextCreature = this.player.creatures.find(c => c.hp > 0 && c !== this.battle.playerCreature);
                    if (nextCreature) {
                        setTimeout(() => {
                            this.battle.playerCreature = nextCreature;
                            this.updateBattleUI();
                            this.showText(`Go, ${nextCreature.name}!`);
                            setTimeout(() => {
                                this.advanceText();
                                this.battle.waitingForInput = true;
                                document.getElementById('battleMenu').classList.add('active');
                            }, 1500);
                        }, 2000);
                    } else {
                        setTimeout(() => {
                            this.showText('You have no more creatures!');
                            setTimeout(() => {
                                this.endBattle(false);
                            }, 2000);
                        }, 2000);
                    }
                } else {
                    this.showText(`${this.battle.enemyCreature.name} fainted!`);
                    
                    // Award experience (improved formula based on level difference)
                    const baseExp = this.battle.enemyCreature.level * 15;
                    const levelDiff = this.battle.enemyCreature.level - this.battle.playerCreature.level;
                    const levelBonus = Math.max(0.5, 1 + (levelDiff * 0.1));
                    const expGained = Math.floor(baseExp * levelBonus);
                    this.battle.playerCreature.exp = (this.battle.playerCreature.exp || 0) + expGained;
                    
                    setTimeout(() => {
                        this.showText(`${this.battle.playerCreature.name} gained ${expGained} EXP!`);
                        
                        // Check for level up
                        const expNeeded = this.battle.playerCreature.level * 100;
                        if (this.battle.playerCreature.exp >= expNeeded) {
                            this.battle.playerCreature.level++;
                            this.battle.playerCreature.exp -= expNeeded;
                            
                            // Increase stats (improved scaling based on base stats)
                            const creatureData = this.cartridge.creatures[this.battle.playerCreature.id];
                            const hpGain = Math.floor(creatureData.baseHp * 0.12) + 3;
                            const atkGain = Math.floor(creatureData.baseAttack * 0.08) + 2;
                            const defGain = Math.floor(creatureData.baseDefense * 0.08) + 2;
                            const spAtkGain = Math.floor((creatureData.baseSpecialAttack || creatureData.baseAttack) * 0.08) + 2;
                            const spDefGain = Math.floor((creatureData.baseSpecialDefense || creatureData.baseDefense) * 0.08) + 2;
                            const spdGain = Math.floor(creatureData.baseSpeed * 0.08) + 1;

                            this.battle.playerCreature.maxHp += hpGain;
                            this.battle.playerCreature.hp += hpGain;
                            this.battle.playerCreature.attack += atkGain;
                            this.battle.playerCreature.defense += defGain;
                            this.battle.playerCreature.specialAttack = (this.battle.playerCreature.specialAttack || this.battle.playerCreature.attack) + spAtkGain;
                            this.battle.playerCreature.specialDefense = (this.battle.playerCreature.specialDefense || this.battle.playerCreature.defense) + spDefGain;
                            this.battle.playerCreature.speed += spdGain;
                            
                            setTimeout(() => {
                                this.showText(`${this.battle.playerCreature.name} grew to level ${this.battle.playerCreature.level}!`);
                                
                                // Check evolution
                                if (creatureData.evolveLevel && this.battle.playerCreature.level >= creatureData.evolveLevel) {
                                    setTimeout(() => {
                                        this.evolveCreature(this.battle.playerCreature, creatureData.evolveTo);
                                    }, 2000);
                                } else {
                                    setTimeout(() => {
                                        this.checkBattleEnd();
                                    }, 2000);
                                }
                            }, 2000);
                        } else {
                            setTimeout(() => {
                                this.checkBattleEnd();
                            }, 2000);
                        }
                    }, 2000);
                }
            }
            
            evolveCreature(creature, evolveToId) {
                const evolvedData = this.cartridge.creatures[evolveToId];
                if (!evolvedData) {
                    this.checkBattleEnd();
                    return;
                }
                
                this.showText(`What? ${creature.name} is evolving!`);
                
                setTimeout(() => {
                    creature.id = evolvedData.id;
                    creature.name = evolvedData.name;
                    creature.maxHp += 10;
                    creature.hp += 10;
                    creature.attack += 5;
                    creature.defense += 5;
                    creature.speed += 5;
                    
                    // Learn new moves
                    const newMoves = evolvedData.moves.filter(m => !creature.moves.includes(m));
                    if (newMoves.length > 0 && creature.moves.length < 4) {
                        const newMove = newMoves[0];
                        creature.moves.push(newMove);
                        const move = this.cartridge.moves[newMove];
                        if (move) {
                            creature.pp[newMove] = move.pp;
                        }
                    }
                    
                    this.updateBattleUI();
                    this.showText(`${creature.name} evolved into ${evolvedData.name}!`);
                    
                    setTimeout(() => {
                        this.checkBattleEnd();
                    }, 2000);
                }, 2000);
            }
            
            checkBattleEnd() {
                if (this.battle.type === 'trainer' || this.battle.type === 'gym') {
                    // Check for more enemy creatures
                    if (this.battle.currentEnemyIndex < this.battle.trainerTeam.length - 1) {
                        this.battle.currentEnemyIndex++;
                        const nextCreatureId = this.battle.trainerTeam[this.battle.currentEnemyIndex];
                        this.battle.enemyCreature = this.createEnemyCreature(
                            nextCreatureId,
                            this.battle.type === 'gym' ? 10 + (this.player.badges.length * 5) : 5
                        );
                        
                        this.updateBattleUI();
                        this.showText(`Trainer sent out ${this.battle.enemyCreature.name}!`);
                        
                        setTimeout(() => {
                            this.advanceText();
                            this.battle.waitingForInput = true;
                            document.getElementById('battleMenu').classList.add('active');
                        }, 2000);
                    } else {
                        // Trainer defeated
                        if (this.battle.type === 'gym') {
                            const gymData = this.battle.gymData;
                            this.player.badges.push(gymData.badge);
                            this.player.money += gymData.reward;
                            
                            this.showText(`You defeated ${gymData.name}!`);
                            setTimeout(() => {
                                this.showText(`You received the ${gymData.badge}!`);
                                setTimeout(() => {
                                    this.endBattle(true);
                                }, 2000);
                            }, 2000);
                        } else {
                            this.showText('You defeated the trainer!');
                            setTimeout(() => {
                                this.endBattle(true);
                            }, 2000);
                        }
                    }
                } else {
                    // Wild battle ended
                    this.endBattle(true);
                }
            }
            
            updateBattle(deltaTime) {
                if (!this.battle || this.battle.ended) return;

                // Energy Charging System
                const chargeRate = 20; // Base energy per second

                // Player Charge
                const player = this.battle.playerCreature;
                if (player.hp > 0) {
                    const speedFactor = player.speed / 50;
                    player.energy = Math.min(player.maxEnergy, player.energy + (chargeRate * speedFactor * (deltaTime / 1000)));
                }

                // Enemy Charge & AI
                const enemy = this.battle.enemyCreature;
                if (enemy.hp > 0) {
                    const speedFactor = enemy.speed / 50;
                    enemy.energy = Math.min(enemy.maxEnergy, enemy.energy + (chargeRate * speedFactor * (deltaTime / 1000)));

                    // Simple AI: Use random available move
                    if (enemy.energy >= 20) { // Check if we have enough for cheapest move
                        // Find usable moves
                        const availableMoves = enemy.moves.filter(m => {
                            const moveData = this.cartridge.moves[m];
                            return enemy.energy >= (moveData.energyCost || 30);
                        });
                        
                        if (availableMoves.length > 0 && Math.random() < 0.05) { // Random chance to attack when ready
                            const moveId = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                            const moveData = this.cartridge.moves[moveId];
                            enemy.energy -= (moveData.energyCost || 30);
                            this.useMove(enemy, player, moveId);
                        }
                    }
                }
                
                this.updateBattleUI();
            }
            
            updateBattleUI() {
                if (!this.battle) return;
                
                // Update enemy info
                document.getElementById('enemyName').textContent = this.battle.enemyCreature.name;
                document.getElementById('enemyLevel').textContent = this.battle.enemyCreature.level;
                const enemyHPPercent = (this.battle.enemyCreature.hp / this.battle.enemyCreature.maxHp) * 100;
                document.getElementById('enemyHP').style.width = `${enemyHPPercent}%`;
                document.getElementById('enemyHP').classList.toggle('low', enemyHPPercent < 25);
                
                // Update Enemy Energy Bar
                const enemyEnergyPercent = (this.battle.enemyCreature.energy / this.battle.enemyCreature.maxEnergy) * 100;
                const enemyEnergyBar = document.getElementById('enemyEnergy');
                if (enemyEnergyBar) enemyEnergyBar.style.width = `${enemyEnergyPercent}%`;

                // Update player info
                document.getElementById('playerName').textContent = this.battle.playerCreature.name;
                document.getElementById('playerLevel').textContent = this.battle.playerCreature.level;
                const playerHPPercent = (this.battle.playerCreature.hp / this.battle.playerCreature.maxHp) * 100;
                document.getElementById('playerHP').style.width = `${playerHPPercent}%`;
                document.getElementById('playerHP').classList.toggle('low', playerHPPercent < 25);
                document.getElementById('playerHPText').textContent = 
                    `${this.battle.playerCreature.hp}/${this.battle.playerCreature.maxHp}`;

                // Update Energy Bar
                const energyPercent = (this.battle.playerCreature.energy / this.battle.playerCreature.maxEnergy) * 100;
                const energyBar = document.getElementById('playerEnergy');
                if (energyBar) energyBar.style.width = `${energyPercent}%`;

                // Update Move HUD availability
                const moveSlots = document.querySelectorAll('.move-slot');
                moveSlots.forEach((slot, index) => {
                    const moveId = this.battle.playerCreature.moves[index];
                    if (moveId) {
                        const move = this.cartridge.moves[moveId];
                        const cost = move.energyCost || 30;
                        if (this.battle.playerCreature.energy >= cost) {
                            slot.classList.add('ready');
                            slot.style.borderColor = '#00f2fe';
                            slot.style.opacity = '1';
                        } else {
                            slot.classList.remove('ready');
                            slot.style.borderColor = '#333';
                            slot.style.opacity = '0.5';
                        }
                    }
                });
            }
            
            endBattle(won = false) {
                // Play victory music if won, otherwise return to overworld music
                if (won) {
                    this.audio.playSFX('victory');
                    this.audio.playMusic('victory');
                    setTimeout(() => {
                        this.audio.playMusic('overworld');
                    }, 3500);
                } else {
                    this.audio.playMusic('overworld');
                }

                this.state = 'OVERWORLD';
                document.getElementById('battleUI').classList.remove('active');
                document.getElementById('battleMenu').classList.remove('active');
                document.getElementById('moveMenu').classList.remove('active');

                if (won && this.battle) {
                    if (this.battle.trainerId) {
                        this.defeatedTrainers.add(this.battle.trainerId);
                    }
                }

                this.battle = null;
                this.advanceText();
            }
            
            handleMenuInput(key) {
                const menuOptions = document.querySelectorAll('#mainMenu .menu-option');

                if (key === 'ArrowUp') {
                    this.audio.playSFX('menu_move');
                    this.menuIndex = Math.max(0, this.menuIndex - 1);
                } else if (key === 'ArrowDown') {
                    this.audio.playSFX('menu_move');
                    this.menuIndex = Math.min(menuOptions.length - 1, this.menuIndex + 1);
                } else if (key === 'z' || key === 'Enter') {
                    this.audio.playSFX('menu_select');
                    this.selectMenuOption(this.menuIndex);
                } else if (key === 'x' || key === 'Escape') {
                    this.audio.playSFX('menu_back');
                    this.closeMenu();
                }

                // Update selection
                menuOptions.forEach((option, index) => {
                    option.classList.toggle('selected', index === this.menuIndex);
                });
            }

            // === PARTY DISPLAY UPDATER ===

            updatePartyDisplay() {
                if (!this.player || !this.player.team) return;

                for (let i = 0; i < 6; i++) {
                    const slot = document.getElementById(`partySlot${i}`);
                    if (!slot) continue;

                    const creature = this.player.team.active[i];

                    if (!creature) {
                        slot.className = 'party-slot empty';
                        slot.innerHTML = '<span class="party-icon">?</span>';
                        continue;
                    }

                    // Remove empty class
                    slot.classList.remove('empty');

                    // Add active class to currently battling creature
                    if (this.battle && this.battle.playerCreature === creature) {
                        slot.classList.add('active');
                    } else {
                        slot.classList.remove('active');
                    }

                    // Add fainted class if HP is 0
                    if (creature.hp <= 0) {
                        slot.classList.add('fainted');
                    } else {
                        slot.classList.remove('fainted');
                    }

                    // Calculate HP percentage
                    const hpPercent = Math.max(0, Math.min(100, (creature.hp / creature.maxHp) * 100));
                    const hpClass = hpPercent < 30 ? 'low' : '';

                    // Update slot content
                    slot.innerHTML = `
                        <span class="party-level">L${creature.level}</span>
                        <span class="party-icon">‚óè</span>
                        <div class="party-hp-mini">
                            <div class="party-hp-fill ${hpClass}" style="width: ${hpPercent}%"></div>
                        </div>
                    `;
                }
            }

            // === TEAM BUILDER SYSTEM ===

            initializePlayerTeam() {
                if (!this.player || !this.player.creatures) return;

                // Initialize team structure if needed
                if (!this.player.team) {
                    this.player.team = {
                        active: [],
                        storage: []
                    };
                }

                // Move first creature to active party (always have at least 1)
                if (this.player.team.active.length === 0 && this.player.creatures.length > 0) {
                    this.player.team.active.push(this.player.creatures[0]);
                }

                // Rest go to storage
                for (let i = 1; i < this.player.creatures.length; i++) {
                    if (!this.player.team.active.includes(this.player.creatures[i])) {
                        this.player.team.storage.push(this.player.creatures[i]);
                    }
                }

                // Update the party display
                this.updatePartyDisplay();
            }

            openTeamBuilder() {
                // Initialize team if needed
                this.initializePlayerTeam();

                this.state = 'TEAM_BUILDER';
                this.teamMenuIndex = 0;

                // Initialize DOM cache if needed
                if (!this.domCache.initialized) {
                    this.domCache.teamMenu = document.getElementById('teamBuilderMenu');
                    this.domCache.battleSwitchMenu = document.getElementById('battleSwitchMenu');
                    this.domCache.initialized = true;
                }

                // Show team builder menu
                if (this.domCache.teamMenu) {
                    this.domCache.teamMenu.style.display = 'block';
                }

                // Render team
                this.dirtyFlags.team = true;
                this.renderTeamBuilder();

                this.audio.playSFX('menu_open');
            }

            renderTeamBuilder() {
                if (!this.dirtyFlags.team) return;
                if (!this.player || !this.player.team) return;

                const partyContainer = document.getElementById('partySlots');
                const storageContainer = document.getElementById('storageSlots');

                if (!partyContainer || !storageContainer) return;

                // Render party slots (6 slots)
                partyContainer.innerHTML = '';
                for (let i = 0; i < 6; i++) {
                    const creature = this.player.team.active[i] || null;
                    const slot = this.createTeamSlot(i, creature, 'party');
                    partyContainer.appendChild(slot);
                }

                // Render storage
                storageContainer.innerHTML = '';
                this.player.team.storage.forEach((creature, index) => {
                    const slot = this.createTeamSlot(index + 6, creature, 'storage');
                    storageContainer.appendChild(slot);
                });

                // Clear dirty flag
                this.dirtyFlags.team = false;
            }

            createTeamSlot(index, creature, type) {
                const slot = document.createElement('div');
                slot.className = 'team-slot';
                slot.setAttribute('role', 'menuitem');
                slot.setAttribute('tabindex', index === this.teamMenuIndex ? '0' : '-1');

                if (!creature) {
                    slot.classList.add('empty');
                    slot.innerHTML = `
                        <span class="slot-number">${index < 6 ? (index + 1) : '‚Äî'}</span>
                        <span class="slot-info">[EMPTY]</span>
                    `;
                    slot.setAttribute('aria-label', 'Empty slot');
                    return slot;
                }

                // Check if fainted
                if (creature.hp <= 0) {
                    slot.classList.add('fainted');
                }

                if (index === this.teamMenuIndex) {
                    slot.classList.add('selected');
                }

                // HP percentage
                const hpPercent = (creature.hp / creature.maxHp) * 100;
                const hpClass = hpPercent < 25 ? 'critical' : hpPercent < 50 ? 'low' : '';

                // Build slot HTML
                slot.innerHTML = `
                    <span class="slot-number">${index < 6 ? (index + 1) : '‚Äî'}</span>
                    <div class="slot-info">
                        <div class="slot-name">${creature.name}</div>
                        <div class="slot-stats">
                            <span>Lv.${creature.level}</span>
                            <span>HP: ${creature.hp}/${creature.maxHp}</span>
                        </div>
                        <div class="slot-hp-bar">
                            <div class="slot-hp-fill ${hpClass}" style="width: ${hpPercent}%"></div>
                        </div>
                    </div>
                `;

                // ARIA label
                const status = creature.hp <= 0 ? 'fainted' :
                               hpPercent < 25 ? 'critically injured' :
                               hpPercent < 50 ? 'injured' : 'healthy';
                slot.setAttribute('aria-label',
                    `${type === 'party' ? 'Party' : 'Storage'} slot ${index + 1}: ${creature.name}, Level ${creature.level}, ${status}`
                );

                return slot;
            }

            handleTeamBuilderInput(key) {
                const totalSlots = 6 + (this.player.team.storage ? this.player.team.storage.length : 0);

                switch(key) {
                    case 'ArrowUp':
                    case 'w':
                        this.teamMenuIndex = Math.max(0, this.teamMenuIndex - 1);
                        this.dirtyFlags.team = true;
                        this.renderTeamBuilder();
                        this.audio.playSFX('menu_move');
                        break;

                    case 'ArrowDown':
                    case 's':
                        this.teamMenuIndex = Math.min(totalSlots - 1, this.teamMenuIndex + 1);
                        this.dirtyFlags.team = true;
                        this.renderTeamBuilder();
                        this.audio.playSFX('menu_move');
                        break;

                    case 'z':
                    case 'Enter':
                        this.handleTeamBuilderAction();
                        break;

                    case 'x':
                    case 'Escape':
                        this.closeTeamBuilder();
                        break;
                }
            }

            handleTeamBuilderAction() {
                const creature = this.teamMenuIndex < 6
                    ? this.player.team.active[this.teamMenuIndex]
                    : this.player.team.storage[this.teamMenuIndex - 6];

                if (!creature) {
                    this.audio.playSFX('menu_back');
                    return;
                }

                // Show creature details
                const creatureData = this.cartridge.creatures[creature.id];
                const moves = creature.moves.map(moveId => this.cartridge.moves[moveId].name).join(', ');
                this.showText(
                    `${creature.name} (Lv.${creature.level})\\nHP: ${creature.hp}/${creature.maxHp}\\nType: ${creatureData.type.join('/')}\\nATK: ${creature.attack} DEF: ${creature.defense} SPD: ${creature.speed}\\nMoves: ${moves}`
                );

                this.audio.playSFX('menu_select');
            }

            closeTeamBuilder() {
                if (this.domCache.teamMenu) {
                    this.domCache.teamMenu.style.display = 'none';
                }
                this.state = 'MENU';
                this.audio.playSFX('menu_back');
            }

            // === BATTLE CREATURE SWITCHING ===

            openBattleSwitchMenu() {
                if (!this.domCache.battleSwitchMenu) {
                    this.domCache.battleSwitchMenu = document.getElementById('battleSwitchMenu');
                }

                this.state = 'BATTLE_SWITCH';
                this.teamMenuIndex = 0;

                if (this.domCache.battleSwitchMenu) {
                    this.domCache.battleSwitchMenu.style.display = 'block';
                }

                // Render available creatures
                this.renderBattleSwitchMenu();

                this.audio.playSFX('menu_open');
            }

            renderBattleSwitchMenu() {
                const container = document.getElementById('switchOptions');
                if (!container) return;

                container.innerHTML = '';

                // Show only healthy creatures from party
                if (!this.player.team || !this.player.team.active) {
                    container.innerHTML = '<div style="padding: 12px; text-align: center;">No creatures available!</div>';
                    return;
                }

                let availableIndex = 0;
                this.player.team.active.forEach((creature, index) => {
                    if (!creature || creature.hp <= 0 || creature === this.battle.playerCreature) {
                        return;
                    }

                    const slot = this.createTeamSlot(availableIndex, creature, 'switch');
                    container.appendChild(slot);
                    availableIndex++;
                });

                if (container.children.length === 0) {
                    container.innerHTML = '<div style="padding: 12px; text-align: center;">No creatures available to switch!</div>';
                }
            }

            handleBattleSwitchInput(key) {
                const container = document.getElementById('switchOptions');
                const availableCreatures = [];

                if (this.player.team && this.player.team.active) {
                    this.player.team.active.forEach(c => {
                        if (c && c.hp > 0 && c !== this.battle.playerCreature) {
                            availableCreatures.push(c);
                        }
                    });
                }

                if (availableCreatures.length === 0) {
                    if (key === 'x' || key === 'Escape') {
                        this.closeBattleSwitchMenu();
                    }
                    return;
                }

                switch(key) {
                    case 'ArrowUp':
                    case 'w':
                        this.teamMenuIndex = Math.max(0, this.teamMenuIndex - 1);
                        this.updateBattleSwitchSelection();
                        this.audio.playSFX('menu_move');
                        break;

                    case 'ArrowDown':
                    case 's':
                        this.teamMenuIndex = Math.min(availableCreatures.length - 1, this.teamMenuIndex + 1);
                        this.updateBattleSwitchSelection();
                        this.audio.playSFX('menu_move');
                        break;

                    case 'z':
                    case 'Enter':
                        this.executeBattleSwitch(availableCreatures[this.teamMenuIndex]);
                        break;

                    case 'x':
                    case 'Escape':
                        this.closeBattleSwitchMenu();
                        break;
                }
            }

            updateBattleSwitchSelection() {
                const slots = document.querySelectorAll('#switchOptions .team-slot');
                slots.forEach((slot, index) => {
                    slot.classList.toggle('selected', index === this.teamMenuIndex);
                });
            }

            executeBattleSwitch(newCreature) {
                if (!newCreature || newCreature.hp <= 0) {
                    this.audio.playSFX('menu_back');
                    return;
                }

                // Show switch message
                this.showText(`Come back, ${this.battle.playerCreature.name}!`);

                setTimeout(() => {
                    this.advanceText();

                    // Switch creature
                    this.battle.playerCreature = newCreature;
                    this.updateBattleUI();

                    this.showText(`Go, ${newCreature.name}!`);

                    setTimeout(() => {
                        this.advanceText();

                        // Close switch menu
                        this.closeBattleSwitchMenu();

                        // Enemy gets a free turn
                        const enemyMoveId = this.chooseEnemyMove(this.battle.enemyCreature, this.battle.playerCreature);
                        this.executeMove(this.battle.enemyCreature, this.battle.playerCreature, enemyMoveId, false);
                    }, 1000);
                }, 1000);

                this.audio.playSFX('switch');
            }

            closeBattleSwitchMenu() {
                if (this.domCache.battleSwitchMenu) {
                    this.domCache.battleSwitchMenu.style.display = 'none';
                }
                this.state = 'BATTLE';
                this.battle.waitingForInput = true;
                document.getElementById('battleMenu').classList.add('active');
                this.audio.playSFX('menu_back');
            }

            selectMenuOption(index) {
                switch (index) {
                    case 0: // CREATURES
                        this.openTeamBuilder();
                        this.closeMenu();
                        break;
                    case 1: // BAG
                        this.showText('Bag not implemented yet!');
                        this.closeMenu();
                        break;
                    case 2: // SAVE
                        this.exportSave();
                        this.showText('Game saved!');
                        this.closeMenu();
                        break;
                    case 3: // EXIT
                        this.closeMenu();
                        break;
                }
            }
            
            closeMenu() {
                this.state = 'OVERWORLD';
                document.getElementById('mainMenu').classList.remove('active');
            }
            
            updateMenu() {
                // Menu is handled through event system
            }
            
            render() {
                // Clear screen
                this.ctx.fillStyle = '#9bbc0f';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                switch (this.state) {
                    case 'LOADING':
                        this.showLoadingScreen();
                        break;
                    case 'OVERWORLD':
                    case 'MENU':
                    case 'TEXT':
                    case 'TEAM_BUILDER':
                        this.renderOverworld();
                        break;
                    case 'BATTLE':
                    case 'BATTLE_SWITCH':
                        this.renderBattle();
                        break;
                }

                // Update party display every frame
                if (this.player && this.player.team) {
                    this.updatePartyDisplay();
                }
            }
            
            renderOverworld() {
                if (!this.map) return;
                
                // Calculate camera offset
                const cameraX = Math.max(0, Math.min(
                    this.player.x - Math.floor(this.screenTilesX / 2),
                    this.map.width - this.screenTilesX
                ));
                const cameraY = Math.max(0, Math.min(
                    this.player.y - Math.floor(this.screenTilesY / 2),
                    this.map.height - this.screenTilesY
                ));
                
                // Render tiles
                for (let y = 0; y < this.screenTilesY; y++) {
                    for (let x = 0; x < this.screenTilesX; x++) {
                        const worldX = x + cameraX;
                        const worldY = y + cameraY;
                        
                        if (worldX < this.map.width && worldY < this.map.height) {
                            const tileIndex = worldY * this.map.width + worldX;
                            const tile = this.map.tiles[tileIndex];
                            const tileData = this.cartridge.tiles[tile];
                            
                            if (tileData) {
                                // Draw tile background
                                this.ctx.fillStyle = tileData.color || '#8bac0f';
                                this.ctx.fillRect(
                                    x * this.tileSize,
                                    y * this.tileSize,
                                    this.tileSize,
                                    this.tileSize
                                );
                                
                                // Draw tile symbol
                                if (tileData.symbol) {
                                    this.ctx.fillStyle = '#0f380f';
                                    this.ctx.font = '8px monospace';
                                    this.ctx.textAlign = 'center';
                                    this.ctx.fillText(
                                        tileData.symbol,
                                        x * this.tileSize + 4,
                                        y * this.tileSize + 7
                                    );
                                }
                            }
                        }
                    }
                }
                
                // Render NPCs
                this.map.npcs.forEach(npc => {
                    const screenX = npc.x - cameraX;
                    const screenY = npc.y - cameraY;
                    
                    if (screenX >= 0 && screenX < this.screenTilesX && 
                        screenY >= 0 && screenY < this.screenTilesY) {
                        
                        // Draw NPC
                        this.ctx.fillStyle = '#306230';
                        this.ctx.fillRect(
                            screenX * this.tileSize + 1,
                            screenY * this.tileSize + 1,
                            this.tileSize - 2,
                            this.tileSize - 2
                        );
                        
                        // Draw sprite indicator
                        this.ctx.fillStyle = '#0f380f';
                        this.ctx.font = '6px monospace';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(
                            npc.trainer ? '!' : npc.gymLeader ? 'G' : 'N',
                            screenX * this.tileSize + 4,
                            screenY * this.tileSize + 6
                        );
                    }
                });
                
                // Render player
                const playerScreenX = this.player.x - cameraX;
                const playerScreenY = this.player.y - cameraY;
                
                if (playerScreenX >= 0 && playerScreenX < this.screenTilesX && 
                    playerScreenY >= 0 && playerScreenY < this.screenTilesY) {
                    
                    // Player shadow
                    this.ctx.fillStyle = 'rgba(0,0,0,0.3)';
                    this.ctx.fillRect(
                        playerScreenX * this.tileSize + 1,
                        playerScreenY * this.tileSize + 2,
                        this.tileSize - 2,
                        this.tileSize - 2
                    );
                    
                    // Player sprite
                    this.ctx.fillStyle = '#0f380f';
                    this.ctx.fillRect(
                        playerScreenX * this.tileSize + 1,
                        playerScreenY * this.tileSize + 1,
                        this.tileSize - 2,
                        this.tileSize - 2
                    );
                    
                    // Direction indicator
                    this.ctx.fillStyle = '#9bbc0f';
                    const dirX = playerScreenX * this.tileSize + 4;
                    const dirY = playerScreenY * this.tileSize + 4;
                    
                    switch (this.player.facing) {
                        case 'up':
                            this.ctx.fillRect(dirX - 1, dirY - 2, 2, 2);
                            break;
                        case 'down':
                            this.ctx.fillRect(dirX - 1, dirY + 2, 2, 2);
                            break;
                        case 'left':
                            this.ctx.fillRect(dirX - 3, dirY - 1, 2, 2);
                            break;
                        case 'right':
                            this.ctx.fillRect(dirX + 1, dirY - 1, 2, 2);
                            break;
                    }
                }
                
                // Render HUD
                this.renderHUD();
            }
            
            renderHUD() {
                // Map name
                this.ctx.fillStyle = 'rgba(15, 56, 15, 0.8)';
                this.ctx.fillRect(2, 2, this.map.name.length * 6 + 4, 12);
                this.ctx.fillStyle = '#9bbc0f';
                this.ctx.font = '8px monospace';
                this.ctx.textAlign = 'left';
                this.ctx.fillText(this.map.name, 4, 10);
                
                // Player info
                const infoText = `$${this.player.money} B:${this.player.badges.length}`;
                this.ctx.fillStyle = 'rgba(15, 56, 15, 0.8)';
                this.ctx.fillRect(this.canvas.width - infoText.length * 6 - 6, 2, infoText.length * 6 + 4, 12);
                this.ctx.fillStyle = '#9bbc0f';
                this.ctx.textAlign = 'right';
                this.ctx.fillText(infoText, this.canvas.width - 4, 10);
            }
            
            renderBattle() {
                // Battle background
                this.ctx.fillStyle = '#8bac0f';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Ground
                this.ctx.fillStyle = '#556b2f';
                this.ctx.fillRect(0, this.canvas.height * 0.6, this.canvas.width, this.canvas.height * 0.4);
                
                // Battle platforms
                // Enemy platform
                this.ctx.fillStyle = '#306230';
                this.ctx.beginPath();
                this.ctx.ellipse(this.canvas.width * 0.75, this.canvas.height * 0.4, 35, 15, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Player platform
                this.ctx.fillStyle = '#306230';
                this.ctx.beginPath();
                this.ctx.ellipse(this.canvas.width * 0.25, this.canvas.height * 0.75, 35, 15, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Creatures
                if (this.battle) {
                    // Enemy creature
                    this.renderCreature(
                        this.battle.enemyCreature,
                        this.canvas.width * 0.75,
                        this.canvas.height * 0.35,
                        false
                    );
                    
                    // Player creature
                    this.renderCreature(
                        this.battle.playerCreature,
                        this.canvas.width * 0.25,
                        this.canvas.height * 0.7,
                        true
                    );
                }
            }
            
            renderCreature(creature, x, y, isPlayer) {
                // Simple creature rendering
                const size = isPlayer ? 30 : 25;
                
                // Shadow
                this.ctx.fillStyle = 'rgba(0,0,0,0.3)';
                this.ctx.beginPath();
                this.ctx.ellipse(x, y + size/2, size/2, size/4, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Creature body (simple rectangle for now)
                this.ctx.fillStyle = '#0f380f';
                this.ctx.fillRect(x - size/2, y - size/2, size, size);
                
                // Creature details
                this.ctx.fillStyle = '#9bbc0f';
                this.ctx.font = '6px monospace';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(creature.name.substring(0, 3), x, y + 2);
                
                // Animation based on HP
                if (creature.hp < creature.maxHp * 0.25) {
                    // Shake effect for low HP
                    const shakeX = Math.sin(this.frameCount * 0.3) * 2;
                    this.ctx.translate(shakeX, 0);
                    this.ctx.fillRect(x - size/2, y - size/2, size, size);
                    this.ctx.translate(-shakeX, 0);
                }
            }

            // Accessibility Features
            announce(message, priority = 'polite') {
                // Announce to screen readers
                const liveRegion = document.getElementById('liveRegion');
                if (liveRegion) {
                    liveRegion.setAttribute('aria-live', priority);
                    liveRegion.textContent = message;

                    // Clear after announcement
                    setTimeout(() => {
                        liveRegion.textContent = '';
                    }, 100);
                }

                // Also log for debugging
                if (this.accessibilitySettings && this.accessibilitySettings.screenReaderMode) {
                    console.log('[Screen Reader]:', message);
                }
            }

            toggleAccessibilityPanel() {
                const panel = document.getElementById('accessibilityPanel');
                const isActive = panel.classList.contains('active');

                if (isActive) {
                    panel.classList.remove('active');
                    panel.setAttribute('aria-hidden', 'true');
                    this.announce('Accessibility settings closed');
                } else {
                    panel.classList.add('active');
                    panel.setAttribute('aria-hidden', 'false');
                    document.getElementById('highContrastToggle').focus();
                    this.announce('Accessibility settings opened');
                }
            }

            initializeAccessibility() {
                // Initialize accessibility settings
                this.accessibilitySettings = {
                    highContrast: false,
                    reducedMotion: false,
                    largeText: false,
                    screenReaderMode: false,
                    textSpeed: 3
                };

                // Load saved accessibility preferences
                const saved = localStorage.getItem('wowmon_accessibility');
                if (saved) {
                    try {
                        this.accessibilitySettings = JSON.parse(saved);
                        this.applyAccessibilitySettings();
                    } catch (e) {
                        console.error('Failed to load accessibility settings:', e);
                    }
                }

                // High Contrast Toggle
                const highContrastToggle = document.getElementById('highContrastToggle');
                if (highContrastToggle) {
                    highContrastToggle.checked = this.accessibilitySettings.highContrast;
                    highContrastToggle.addEventListener('change', (e) => {
                        this.accessibilitySettings.highContrast = e.target.checked;
                        document.body.classList.toggle('high-contrast', e.target.checked);
                        this.saveAccessibilitySettings();
                        this.announce(e.target.checked ? 'High contrast mode enabled' : 'High contrast mode disabled');
                    });
                }

                // Reduced Motion Toggle
                const reducedMotionToggle = document.getElementById('reducedMotionToggle');
                if (reducedMotionToggle) {
                    reducedMotionToggle.checked = this.accessibilitySettings.reducedMotion;
                    reducedMotionToggle.addEventListener('change', (e) => {
                        this.accessibilitySettings.reducedMotion = e.target.checked;
                        document.body.classList.toggle('reduced-motion', e.target.checked);
                        this.saveAccessibilitySettings();
                        this.announce(e.target.checked ? 'Reduced motion enabled' : 'Reduced motion disabled');
                    });
                }

                // Large Text Toggle
                const largeTextToggle = document.getElementById('largeTextToggle');
                if (largeTextToggle) {
                    largeTextToggle.checked = this.accessibilitySettings.largeText;
                    largeTextToggle.addEventListener('change', (e) => {
                        this.accessibilitySettings.largeText = e.target.checked;
                        document.body.classList.toggle('large-text', e.target.checked);
                        this.saveAccessibilitySettings();
                        this.announce(e.target.checked ? 'Large text enabled' : 'Large text disabled');
                    });
                }

                // Screen Reader Mode Toggle
                const screenReaderMode = document.getElementById('screenReaderMode');
                if (screenReaderMode) {
                    screenReaderMode.checked = this.accessibilitySettings.screenReaderMode;
                    screenReaderMode.addEventListener('change', (e) => {
                        this.accessibilitySettings.screenReaderMode = e.target.checked;
                        this.saveAccessibilitySettings();
                        this.announce(e.target.checked ? 'Enhanced screen reader mode enabled' : 'Enhanced screen reader mode disabled');
                    });
                }

                // Text Speed Range
                const textSpeedRange = document.getElementById('textSpeedRange');
                const textSpeedValue = document.getElementById('textSpeedValue');
                if (textSpeedRange && textSpeedValue) {
                    textSpeedRange.value = this.accessibilitySettings.textSpeed;
                    textSpeedValue.textContent = this.accessibilitySettings.textSpeed;
                    textSpeedRange.addEventListener('input', (e) => {
                        this.accessibilitySettings.textSpeed = parseInt(e.target.value);
                        textSpeedValue.textContent = e.target.value;
                        this.saveAccessibilitySettings();
                        this.announce('Text speed set to ' + e.target.value);
                    });
                }

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Alt+A opens accessibility panel
                    if (e.altKey && e.key.toLowerCase() === 'a') {
                        e.preventDefault();
                        this.toggleAccessibilityPanel();
                    }

                    // Escape closes accessibility panel
                    if (e.key === 'Escape') {
                        const panel = document.getElementById('accessibilityPanel');
                        if (panel && panel.classList.contains('active')) {
                            this.toggleAccessibilityPanel();
                        }
                    }
                });

                // Add focus management for menus
                this.setupMenuAccessibility();

                // Announce game state changes
                this.announceGameState();
            }

            setupMenuAccessibility() {
                // Add keyboard navigation to menu options
                const addMenuNavigation = (menuId) => {
                    const menu = document.getElementById(menuId);
                    if (!menu) return;

                    const options = menu.querySelectorAll('.menu-option, .move-option');
                    options.forEach((option, index) => {
                        option.setAttribute('tabindex', index === 0 ? '0' : '-1');
                        option.setAttribute('role', 'menuitem');

                        option.addEventListener('keydown', (e) => {
                            let newIndex = index;

                            if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                                e.preventDefault();
                                newIndex = (index + 1) % options.length;
                            } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                                e.preventDefault();
                                newIndex = (index - 1 + options.length) % options.length;
                            } else if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                option.click();
                                return;
                            }

                            if (newIndex !== index) {
                                options[newIndex].focus();
                                options[newIndex].setAttribute('tabindex', '0');
                                option.setAttribute('tabindex', '-1');

                                // Announce the focused option
                                this.announce(options[newIndex].textContent.trim());
                            }
                        });
                    });
                };

                addMenuNavigation('mainMenu');
                addMenuNavigation('battleMenu');
                addMenuNavigation('moveMenu');
            }

            announceGameState() {
                // Override state changes to announce them
                const originalState = this.state;
                Object.defineProperty(this, '_state', {
                    writable: true,
                    value: originalState
                });

                Object.defineProperty(this, 'state', {
                    get() {
                        return this._state;
                    },
                    set(newState) {
                        const oldState = this._state;
                        this._state = newState;

                        if (this.accessibilitySettings && this.accessibilitySettings.screenReaderMode && oldState !== newState) {
                            switch (newState) {
                                case 'WORLD':
                                    this.announce('Exploring the world');
                                    break;
                                case 'BATTLE':
                                    this.announce('Battle started');
                                    break;
                                case 'MENU':
                                    this.announce('Menu opened');
                                    break;
                                case 'TEXT':
                                    this.announce('Dialogue displayed');
                                    break;
                            }
                        }
                    }
                });
            }

            saveAccessibilitySettings() {
                localStorage.setItem('wowmon_accessibility', JSON.stringify(this.accessibilitySettings));
            }

            applyAccessibilitySettings() {
                if (this.accessibilitySettings.highContrast) {
                    document.body.classList.add('high-contrast');
                }
                if (this.accessibilitySettings.reducedMotion) {
                    document.body.classList.add('reduced-motion');
                }
                if (this.accessibilitySettings.largeText) {
                    document.body.classList.add('large-text');
                }
            }
        }

        // Initialize game engine
        const game = new GameEngine();
    </script>
</body>
</html>