<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infernal Trader - Hell's Stock Exchange</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0000 100%);
            color: #ff6b35;
            overflow: hidden;
            height: 100vh;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .pentagram {
            width: 100px;
            height: 100px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-wisdom {
            margin-top: 30px;
            font-size: 14px;
            color: #ff6b35;
            text-align: center;
            max-width: 500px;
            padding: 0 20px;
        }

        .main-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: 60px 1fr 150px;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #1a0000 0%, #330000 100%);
            border: 2px solid #ff3300;
            border-radius: 8px;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 20px rgba(255, 51, 0, 0.3);
        }

        .header-title {
            font-family: 'Georgia', serif;
            font-size: 28px;
            color: #ff3300;
            text-shadow: 0 0 10px #ff3300;
            letter-spacing: 2px;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .stat-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #ff6b35;
        }

        .stat-value.positive {
            color: #00ff00;
        }

        .stat-value.negative {
            color: #ff0000;
        }

        .trading-floor {
            background: #0d0d0d;
            border: 2px solid #330000;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        .chart-container {
            flex: 1;
            background: #000;
            border: 1px solid #330000;
            border-radius: 4px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: #1a0000;
            border-bottom: 1px solid #330000;
        }

        .commodity-selector {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .commodity-btn {
            background: #1a0000;
            color: #ff6b35;
            border: 1px solid #330000;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 10px;
            font-family: 'Courier New', monospace;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .commodity-btn:hover {
            background: #330000;
            border-color: #ff3300;
        }

        .commodity-btn.active {
            background: #ff3300;
            color: #000;
            border-color: #ff6b35;
            font-weight: bold;
        }

        .timeframe-selector {
            display: flex;
            gap: 5px;
        }

        .timeframe-btn {
            background: #1a0000;
            color: #888;
            border: 1px solid #330000;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 10px;
            font-family: 'Courier New', monospace;
            border-radius: 3px;
        }

        .timeframe-btn.active {
            background: #330000;
            color: #ff6b35;
            border-color: #ff3300;
        }

        #chartCanvas {
            width: 100%;
            height: calc(100% - 40px);
            display: block;
        }

        .order-panel {
            height: 250px;
            background: #0d0d0d;
            border: 1px solid #330000;
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
        }

        .order-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .order-tab {
            background: #1a0000;
            color: #888;
            border: 1px solid #330000;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
            border-radius: 3px 3px 0 0;
            flex: 1;
            text-align: center;
        }

        .order-tab.active {
            background: #330000;
            color: #ff6b35;
            border-bottom-color: #0d0d0d;
        }

        .order-form {
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .order-form.active {
            display: flex;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
        }

        .form-input {
            background: #000;
            border: 1px solid #330000;
            color: #ff6b35;
            padding: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 3px;
        }

        .form-input:focus {
            outline: none;
            border-color: #ff3300;
        }

        .trade-btn {
            background: #1a5e1a;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            transition: all 0.2s;
        }

        .trade-btn:hover {
            background: #00ff00;
            color: #000;
        }

        .trade-btn.sell {
            background: #5e1a1a;
            color: #ff0000;
            border-color: #ff0000;
        }

        .trade-btn.sell:hover {
            background: #ff0000;
            color: #000;
        }

        .trade-info {
            font-size: 10px;
            color: #888;
            padding: 5px;
            background: #0a0a0a;
            border-radius: 3px;
        }

        .portfolio-panel {
            background: #0d0d0d;
            border: 2px solid #330000;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        .panel-title {
            font-size: 16px;
            color: #ff3300;
            font-weight: bold;
            border-bottom: 1px solid #330000;
            padding-bottom: 5px;
            font-family: 'Georgia', serif;
        }

        .portfolio-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .summary-card {
            background: #1a0000;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #330000;
        }

        .summary-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #ff6b35;
            margin-top: 4px;
        }

        .holdings-list {
            flex: 1;
            overflow-y: auto;
            background: #000;
            border: 1px solid #330000;
            border-radius: 4px;
            padding: 8px;
        }

        .holding-item {
            background: #0d0d0d;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #ff3300;
            border-radius: 2px;
            font-size: 11px;
        }

        .holding-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .holding-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            color: #888;
            font-size: 10px;
        }

        .broker-panel {
            margin-top: auto;
            background: #1a0000;
            border: 1px solid #ff3300;
            border-radius: 4px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .broker-message {
            display: flex;
            gap: 10px;
            align-items: start;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #330000;
        }

        .broker-message:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .broker-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #330000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .broker-content {
            flex: 1;
        }

        .broker-name {
            font-size: 11px;
            color: #ff6b35;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .broker-text {
            font-size: 10px;
            color: #ccc;
            line-height: 1.4;
        }

        .news-ticker {
            grid-column: 1 / -1;
            background: #000;
            border: 2px solid #330000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .news-header {
            background: #1a0000;
            padding: 5px 15px;
            font-size: 12px;
            font-weight: bold;
            color: #ff3300;
            border-bottom: 1px solid #330000;
        }

        .news-content {
            padding: 10px 15px;
            height: 120px;
            overflow-y: auto;
        }

        .news-item {
            margin-bottom: 8px;
            padding: 8px;
            background: #0d0d0d;
            border-left: 3px solid #ff3300;
            border-radius: 2px;
            font-size: 11px;
            line-height: 1.5;
        }

        .news-time {
            color: #888;
            font-size: 9px;
            margin-bottom: 3px;
        }

        .news-headline {
            color: #ff6b35;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .news-body {
            color: #ccc;
        }

        .news-impact {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: bold;
        }

        .news-impact.bullish {
            background: #1a5e1a;
            color: #00ff00;
        }

        .news-impact.bearish {
            background: #5e1a1a;
            color: #ff0000;
        }

        .news-impact.volatile {
            background: #5e5e1a;
            color: #ffff00;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a0000;
            border: 2px solid #ff3300;
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 0 30px rgba(255, 51, 0, 0.5);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-color: #00ff00;
        }

        .notification.error {
            border-color: #ff0000;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #ff6b35;
        }

        .notification-body {
            font-size: 11px;
            color: #ccc;
        }

        .rank-badge {
            background: #330000;
            border: 1px solid #ff3300;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            color: #ff6b35;
            font-weight: bold;
        }

        .market-closed {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff3300;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            z-index: 100;
        }

        .market-closed h2 {
            color: #ff3300;
            margin-bottom: 15px;
            font-family: 'Georgia', serif;
        }

        .market-closed p {
            color: #ccc;
            margin-bottom: 20px;
        }

        .btn-primary {
            background: #ff3300;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .btn-primary:hover {
            background: #ff6b35;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: #330000;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ff3300;
        }

        .price-change {
            animation: priceFlash 0.5s ease-out;
        }

        @keyframes priceFlash {
            0%, 100% { background: transparent; }
            50% { background: rgba(255, 51, 0, 0.3); }
        }

        .fire-particle {
            position: absolute;
            pointer-events: none;
            font-size: 20px;
            animation: rise 2s ease-out forwards;
        }

        @keyframes rise {
            to {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        .leverage-warning {
            background: #5e1a1a;
            border: 1px solid #ff0000;
            padding: 8px;
            border-radius: 3px;
            font-size: 10px;
            color: #ff6b35;
            margin-top: 8px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a0000;
            border: 3px solid #ff3300;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(255, 51, 0, 0.5);
        }

        .modal h2 {
            color: #ff3300;
            font-family: 'Georgia', serif;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal p {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: #330000;
            color: #ff6b35;
            border: 1px solid #ff3300;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            flex: 1;
        }

        .btn-secondary:hover {
            background: #4d0000;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <svg class="pentagram" viewBox="0 0 100 100">
            <polygon points="50,5 61,35 95,35 68,57 79,91 50,70 21,91 32,57 5,35 39,35"
                     fill="none" stroke="#ff3300" stroke-width="2"/>
        </svg>
        <div class="loading-wisdom" id="loadingWisdom">
            Synergizing damnation vectors...
        </div>
    </div>

    <div class="main-container" id="mainContainer" style="display:none;">
        <div class="header">
            <div class="header-title">âš” INFERNAL TRADER âš”</div>
            <div class="header-stats">
                <div class="rank-badge" id="rankBadge">INTERN</div>
                <div class="stat">
                    <div class="stat-label">Portfolio Value</div>
                    <div class="stat-value" id="portfolioValue">$0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Cash</div>
                    <div class="stat-value" id="cashBalance">$10,000</div>
                </div>
                <div class="stat">
                    <div class="stat-label">P&L Today</div>
                    <div class="stat-value" id="dailyPL">$0</div>
                </div>
            </div>
        </div>

        <div class="trading-floor">
            <div class="chart-container">
                <div class="chart-header">
                    <div class="commodity-selector" id="commoditySelector"></div>
                    <div class="timeframe-selector">
                        <button class="timeframe-btn active" data-timeframe="1m">1M</button>
                        <button class="timeframe-btn" data-timeframe="5m">5M</button>
                        <button class="timeframe-btn" data-timeframe="1h">1H</button>
                        <button class="timeframe-btn" data-timeframe="1d">1D</button>
                    </div>
                </div>
                <canvas id="chartCanvas"></canvas>
            </div>

            <div class="order-panel">
                <div class="order-tabs">
                    <button class="order-tab active" data-tab="market">MARKET</button>
                    <button class="order-tab" data-tab="limit">LIMIT</button>
                    <button class="order-tab" data-tab="short">SHORT</button>
                    <button class="order-tab" data-tab="options">OPTIONS</button>
                </div>

                <div class="order-form active" id="marketForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="marketQuantity" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Leverage</label>
                            <input type="number" class="form-input" id="marketLeverage" value="1" min="1" max="10">
                        </div>
                    </div>
                    <div class="trade-info" id="marketInfo">
                        Current Price: $0.00 | Est. Cost: $0.00
                    </div>
                    <div class="form-row">
                        <button class="trade-btn" onclick="executeTrade('buy', 'market')">BUY LONG</button>
                        <button class="trade-btn sell" onclick="executeTrade('sell', 'market')">SELL</button>
                    </div>
                    <div class="leverage-warning" id="leverageWarning" style="display:none;">
                        Warning: Leverage borrows from demonic banks. Interest is YOUR SOUL.
                    </div>
                </div>

                <div class="order-form" id="limitForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="limitQuantity" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Limit Price</label>
                            <input type="number" class="form-input" id="limitPrice" value="0" step="0.01">
                        </div>
                    </div>
                    <div class="trade-info" id="limitInfo">
                        Set your target price for execution
                    </div>
                    <div class="form-row">
                        <button class="trade-btn" onclick="executeTrade('buy', 'limit')">BUY LIMIT</button>
                        <button class="trade-btn sell" onclick="executeTrade('sell', 'limit')">SELL LIMIT</button>
                    </div>
                </div>

                <div class="order-form" id="shortForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="shortQuantity" value="1" min="1">
                        </div>
                    </div>
                    <div class="trade-info">
                        Borrow and sell high, buy back low. Infinite loss potential!
                    </div>
                    <button class="trade-btn sell" onclick="executeTrade('short', 'short')">SHORT SELL</button>
                </div>

                <div class="order-form" id="optionsForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select class="form-input" id="optionType">
                                <option value="call">CALL</option>
                                <option value="put">PUT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Strike Price</label>
                            <input type="number" class="form-input" id="strikePrice" value="0" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Contracts</label>
                            <input type="number" class="form-input" id="optionContracts" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Expiry (Days)</label>
                            <input type="number" class="form-input" id="optionExpiry" value="7" min="1" max="30">
                        </div>
                    </div>
                    <div class="trade-info" id="optionsInfo">
                        Premium: $0.00 per contract
                    </div>
                    <button class="trade-btn" onclick="executeTrade('option', 'options')">BUY OPTION</button>
                </div>
            </div>
        </div>

        <div class="portfolio-panel">
            <div class="panel-title">YOUR PORTFOLIO</div>
            <div class="portfolio-summary">
                <div class="summary-card">
                    <div class="summary-label">Total Value</div>
                    <div class="summary-value" id="totalValue">$10,000</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Unrealized P&L</div>
                    <div class="summary-value" id="unrealizedPL">$0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Positions</div>
                    <div class="summary-value" id="positionCount">0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Day Trades</div>
                    <div class="summary-value" id="tradeCount">0</div>
                </div>
            </div>

            <div class="holdings-list" id="holdingsList">
                <div style="text-align: center; color: #666; padding: 20px;">
                    No positions yet. Start trading to build your infernal empire.
                </div>
            </div>

            <div class="broker-panel" id="brokerPanel">
                <div class="broker-message">
                    <div class="broker-avatar">ðŸ‘¹</div>
                    <div class="broker-content">
                        <div class="broker-name">MAMMON</div>
                        <div class="broker-text">Welcome to the Ninth Circle Trading Floor. Your soul is your collateral. Trade wisely... or recklessly. I profit either way.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="news-ticker">
            <div class="news-header">ðŸ“° INFERNAL FINANCIAL NEWS â€” REAL-TIME UPDATES</div>
            <div class="news-content" id="newsContent">
                <div class="news-item">
                    <div class="news-time">00:00:00</div>
                    <div class="news-headline">MARKETS OPEN <span class="news-impact volatile">VOLATILE</span></div>
                    <div class="news-body">Hell's Stock Exchange begins another day of trading. Analysts predict continued damnation across all sectors.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h2 id="modalTitle">Modal Title</h2>
            <div id="modalBody"></div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="closeModal()">CLOSE</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // GAME STATE & DATA
        // ============================================================================

        const COMMODITIES = [
            // Sin Commodities
            { symbol: 'WTH', name: 'Wrath Futures', basePrice: 150, volatility: 0.08, trend: 0.02 },
            { symbol: 'PRD', name: 'Pride Derivatives', basePrice: 200, volatility: 0.06, trend: 0.01 },
            { symbol: 'GRD', name: 'Greed Index', basePrice: 300, volatility: 0.05, trend: 0.015 },
            { symbol: 'SLT', name: 'Sloth Bonds', basePrice: 50, volatility: 0.02, trend: -0.005 },
            { symbol: 'LST', name: 'Lust Options', basePrice: 180, volatility: 0.10, trend: 0 },
            { symbol: 'ENV', name: 'Envy Shares', basePrice: 120, volatility: 0.07, trend: 0.01 },
            { symbol: 'GLT', name: 'Gluttony Reserves', basePrice: 90, volatility: 0.04, trend: 0.005 },

            // Soul Market
            { symbol: 'FSH', name: 'Fresh Souls', basePrice: 500, volatility: 0.06, trend: 0.01 },
            { symbol: 'VNT', name: 'Vintage Souls', basePrice: 800, volatility: 0.04, trend: 0.02 },
            { symbol: 'BLK', name: 'Bulk Damned', basePrice: 100, volatility: 0.03, trend: 0 },
            { symbol: 'RDM', name: 'Redeemed Futures', basePrice: 1000, volatility: 0.15, trend: -0.01 },

            // Exotic Instruments
            { symbol: 'BRG', name: 'Bottled Regret', basePrice: 250, volatility: 0.05, trend: 0.03 },
            { symbol: 'DRD', name: 'Existential Dread ETF', basePrice: 350, volatility: 0.09, trend: 0.02 },
            { symbol: 'HOP', name: 'Hope Shorts', basePrice: 150, volatility: 0.12, trend: -0.02 },
            { symbol: 'APO', name: 'Apocalypse Insurance', basePrice: 50, volatility: 0.20, trend: 0 },
            { symbol: 'PUR', name: 'Purgatory REIT', basePrice: 400, volatility: 0.04, trend: 0.01 },

            // Additional
            { symbol: 'TOR', name: 'Torment Futures', basePrice: 220, volatility: 0.07, trend: 0.015 },
            { symbol: 'DES', name: 'Despair Index', basePrice: 280, volatility: 0.08, trend: 0.01 },
            { symbol: 'COR', name: 'Corruption Bonds', basePrice: 175, volatility: 0.06, trend: 0.02 },
            { symbol: 'VAN', name: 'Vanity Shares', basePrice: 190, volatility: 0.05, trend: 0.01 },
        ];

        const RANKS = [
            { name: 'INTERN', capital: 10000, unlocks: [] },
            { name: 'TRADER', capital: 25000, unlocks: ['leverage'] },
            { name: 'SENIOR TRADER', capital: 50000, unlocks: ['short'] },
            { name: 'VP OF DAMNATION', capital: 100000, unlocks: ['options'] },
            { name: 'MANAGING DIRECTOR', capital: 250000, unlocks: ['exotic'] },
            { name: 'PARTNER', capital: 500000, unlocks: ['derivatives'] },
            { name: 'ARCHFIEND OF FINANCE', capital: 1000000, unlocks: ['all'] },
        ];

        const BROKERS = [
            { name: 'MAMMON', emoji: 'ðŸ‘¹', bias: 'greed', accuracy: 0.6 },
            { name: 'BELPHEGOR', emoji: 'ðŸ˜´', bias: 'lazy', accuracy: 0.8 },
            { name: 'ASMODEUS', emoji: 'ðŸ˜ˆ', bias: 'charisma', accuracy: 0.5 },
            { name: 'BEELZEBUB', emoji: 'ðŸª°', bias: 'obsessive', accuracy: 0.7 },
            { name: 'MEPHISTOPHELES', emoji: 'ðŸŽ­', bias: 'cryptic', accuracy: 0.9 },
        ];

        const LOADING_WISDOMS = [
            "Synergizing damnation vectors...",
            "Optimizing sin throughput...",
            "Leveraging souls for maximum yield...",
            "Calculating eternal returns...",
            "Hedging against redemption risk...",
            "Diversifying your portfolio of sins...",
            "Rebalancing metaphysical assets...",
            "Running Monte Carlo simulations in the 9th Circle...",
            "Stress-testing apocalypse scenarios...",
            "Pricing derivatives on human suffering...",
        ];

        const NEWS_TEMPLATES = [
            {
                headline: "Lucifer announces hostile takeover of {commodity}",
                body: "Shares surge as the Morning Star promises to 'really make this sin count.'",
                impact: 'bullish',
                affectedTypes: ['sin']
            },
            {
                headline: "Angel Michael files antitrust complaint against {commodity} monopoly",
                body: "Heaven's legal team claims unfair damnation practices. Markets react nervously.",
                impact: 'bearish',
                affectedTypes: ['sin', 'soul']
            },
            {
                headline: "{commodity} up 666% on increased conflict",
                body: "Quarterly earnings exceed analyst expectations. CEO credits 'unprecedented human pettiness.'",
                impact: 'bullish',
                affectedTypes: ['all']
            },
            {
                headline: "BREAKING: Rumors of Second Coming tank {commodity}",
                body: "Traders panic-sell as unconfirmed reports spread through the trading floor.",
                impact: 'bearish',
                affectedTypes: ['all']
            },
            {
                headline: "New circle of hell opening creates construction boom",
                body: "Purgatory real estate surges. Contractors report backlog of eternal construction projects.",
                impact: 'bullish',
                affectedTypes: ['exotic']
            },
            {
                headline: "Demon lord coup causes massive volatility in {commodity}",
                body: "Power struggle in lower management leads to uncertain market conditions.",
                impact: 'volatile',
                affectedTypes: ['all']
            },
            {
                headline: "Soul surplus detected: {commodity} prices plummet",
                body: "Record harvests of fresh souls drive prices down. Bulk buyers rejoice.",
                impact: 'bearish',
                affectedTypes: ['soul']
            },
            {
                headline: "Insider trading scandal rocks {commodity} market",
                body: "Three demons arrested for using forbidden knowledge. Market integrity questioned.",
                impact: 'volatile',
                affectedTypes: ['all']
            },
            {
                headline: "{commodity} reaches all-time high on global despair",
                body: "Analysts credit social media and 24-hour news cycles for sustained growth.",
                impact: 'bullish',
                affectedTypes: ['exotic']
            },
            {
                headline: "Flash crash wipes billions from {commodity} valuation",
                body: "Algorithmic trading blamed as prices recover slowly. Regulators investigate.",
                impact: 'bearish',
                affectedTypes: ['all']
            },
        ];

        let gameState = {
            cash: 10000,
            portfolio: [],
            rank: 0,
            tradesCount: 0,
            startingCash: 10000,
            dailyPL: 0,
            currentCommodity: 'WTH',
            timeframe: '1m',
            marketOpen: true,
            transactionHistory: [],
        };

        let marketData = {};
        let priceHistory = {};
        let chartData = [];
        let updateInterval;
        let newsInterval;
        let brokerInterval;

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        function init() {
            showLoadingScreen();

            // Initialize market data
            COMMODITIES.forEach(commodity => {
                marketData[commodity.symbol] = {
                    ...commodity,
                    currentPrice: commodity.basePrice,
                    previousPrice: commodity.basePrice,
                    volume: 0,
                    change: 0,
                    changePercent: 0,
                };
                priceHistory[commodity.symbol] = [];
            });

            // Try to load saved game
            loadGame();

            // Setup UI
            setupCommodityButtons();
            setupEventListeners();
            setupChart();

            // Start market simulation
            startMarketSimulation();
            startNewsGeneration();
            startBrokerTips();

            // Hide loading screen
            setTimeout(() => {
                hideLoadingScreen();
                updateUI();
            }, 2000);
        }

        function showLoadingScreen() {
            const wisdom = LOADING_WISDOMS[Math.floor(Math.random() * LOADING_WISDOMS.length)];
            document.getElementById('loadingWisdom').textContent = wisdom;
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContainer').style.display = 'grid';
        }

        function setupCommodityButtons() {
            const container = document.getElementById('commoditySelector');
            container.innerHTML = '';

            COMMODITIES.forEach(commodity => {
                const btn = document.createElement('button');
                btn.className = 'commodity-btn';
                btn.textContent = commodity.symbol;
                btn.dataset.symbol = commodity.symbol;
                if (commodity.symbol === gameState.currentCommodity) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', () => selectCommodity(commodity.symbol));
                container.appendChild(btn);
            });
        }

        function setupEventListeners() {
            // Timeframe buttons
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameState.timeframe = btn.dataset.timeframe;
                    updateChart();
                });
            });

            // Order tabs
            document.querySelectorAll('.order-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.order-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.order-form').forEach(f => f.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + 'Form').classList.add('active');
                });
            });

            // Leverage warning
            document.getElementById('marketLeverage').addEventListener('input', (e) => {
                const leverage = parseInt(e.target.value);
                const warning = document.getElementById('leverageWarning');
                if (leverage > 1) {
                    warning.style.display = 'block';
                } else {
                    warning.style.display = 'none';
                }
            });

            // Update trade info
            ['marketQuantity', 'marketLeverage'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateTradeInfo);
            });
        }

        // ============================================================================
        // MARKET SIMULATION
        // ============================================================================

        function startMarketSimulation() {
            updateInterval = setInterval(() => {
                updateMarketPrices();
                updateChart();
                updatePortfolioValues();
                updateUI();
                saveGame();
            }, 2000);
        }

        function updateMarketPrices() {
            COMMODITIES.forEach(commodity => {
                const data = marketData[commodity.symbol];
                data.previousPrice = data.currentPrice;

                // Base price movement
                const randomWalk = (Math.random() - 0.5) * 2 * data.volatility;
                const trendComponent = data.trend;
                const priceChange = data.currentPrice * (randomWalk + trendComponent);

                // Add some momentum
                const momentum = (data.currentPrice - data.basePrice) / data.basePrice;
                const meanReversion = -momentum * 0.01;

                data.currentPrice += priceChange + (data.currentPrice * meanReversion);
                data.currentPrice = Math.max(data.currentPrice, data.basePrice * 0.3);
                data.currentPrice = Math.min(data.currentPrice, data.basePrice * 3);

                data.change = data.currentPrice - data.previousPrice;
                data.changePercent = (data.change / data.previousPrice) * 100;

                // Add to price history
                const timestamp = Date.now();
                if (!priceHistory[commodity.symbol]) {
                    priceHistory[commodity.symbol] = [];
                }
                priceHistory[commodity.symbol].push({
                    time: timestamp,
                    price: data.currentPrice,
                    open: data.previousPrice,
                    high: Math.max(data.currentPrice, data.previousPrice),
                    low: Math.min(data.currentPrice, data.previousPrice),
                    close: data.currentPrice,
                });

                // Keep only last 500 data points
                if (priceHistory[commodity.symbol].length > 500) {
                    priceHistory[commodity.symbol].shift();
                }
            });
        }

        function applyMarketEvent(commoditySymbol, impact) {
            const data = marketData[commoditySymbol];
            if (!data) return;

            let multiplier = 1;
            switch (impact) {
                case 'bullish':
                    multiplier = 1 + (Math.random() * 0.1 + 0.05); // 5-15% jump
                    break;
                case 'bearish':
                    multiplier = 1 - (Math.random() * 0.1 + 0.05); // 5-15% drop
                    break;
                case 'volatile':
                    multiplier = Math.random() > 0.5 ? 1.1 : 0.9; // 10% swing either way
                    break;
            }

            data.currentPrice *= multiplier;
            data.volatility *= 1.5; // Increase volatility temporarily

            setTimeout(() => {
                data.volatility /= 1.5; // Return to normal after 30 seconds
            }, 30000);
        }

        // ============================================================================
        // CHART RENDERING
        // ============================================================================

        function setupChart() {
            const canvas = document.getElementById('chartCanvas');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            updateChart();
        }

        function updateChart() {
            const canvas = document.getElementById('chartCanvas');
            const ctx = canvas.getContext('2d');
            const data = priceHistory[gameState.currentCommodity] || [];

            if (data.length === 0) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Filter data by timeframe
            const now = Date.now();
            let timeWindow;
            switch (gameState.timeframe) {
                case '1m': timeWindow = 60 * 1000; break;
                case '5m': timeWindow = 5 * 60 * 1000; break;
                case '1h': timeWindow = 60 * 60 * 1000; break;
                case '1d': timeWindow = 24 * 60 * 60 * 1000; break;
                default: timeWindow = 60 * 1000;
            }

            const filteredData = data.filter(d => now - d.time < timeWindow);
            if (filteredData.length === 0) return;

            // Calculate bounds
            const prices = filteredData.map(d => d.high);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const priceRange = maxPrice - minPrice;
            const padding = priceRange * 0.1;

            // Draw grid
            ctx.strokeStyle = '#1a0000';
            ctx.lineWidth = 1;
            for (let i = 0; i < 5; i++) {
                const y = (canvas.height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }

            // Draw candlesticks
            const candleWidth = Math.max(2, canvas.width / filteredData.length - 2);
            filteredData.forEach((candle, i) => {
                const x = (i / filteredData.length) * canvas.width;
                const openY = canvas.height - ((candle.open - minPrice + padding) / (priceRange + padding * 2)) * canvas.height;
                const closeY = canvas.height - ((candle.close - minPrice + padding) / (priceRange + padding * 2)) * canvas.height;
                const highY = canvas.height - ((candle.high - minPrice + padding) / (priceRange + padding * 2)) * canvas.height;
                const lowY = canvas.height - ((candle.low - minPrice + padding) / (priceRange + padding * 2)) * canvas.height;

                const isGreen = candle.close >= candle.open;
                ctx.strokeStyle = isGreen ? '#00ff00' : '#ff0000';
                ctx.fillStyle = isGreen ? '#00ff00' : '#ff0000';

                // Draw wick
                ctx.beginPath();
                ctx.moveTo(x + candleWidth / 2, highY);
                ctx.lineTo(x + candleWidth / 2, lowY);
                ctx.stroke();

                // Draw body
                const bodyHeight = Math.abs(closeY - openY);
                const bodyY = Math.min(openY, closeY);
                ctx.fillRect(x, bodyY, candleWidth, Math.max(bodyHeight, 1));
            });

            // Draw price labels
            ctx.fillStyle = '#ff6b35';
            ctx.font = '10px Courier New';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const price = minPrice + (priceRange * (i / 4));
                const y = canvas.height - (i / 4) * canvas.height;
                ctx.fillText('$' + price.toFixed(2), canvas.width - 5, y + 3);
            }

            // Draw current price line
            const currentPrice = marketData[gameState.currentCommodity].currentPrice;
            const currentY = canvas.height - ((currentPrice - minPrice + padding) / (priceRange + padding * 2)) * canvas.height;
            ctx.strokeStyle = '#ff3300';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, currentY);
            ctx.lineTo(canvas.width, currentY);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // ============================================================================
        // TRADING FUNCTIONS
        // ============================================================================

        function selectCommodity(symbol) {
            gameState.currentCommodity = symbol;
            document.querySelectorAll('.commodity-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.symbol === symbol);
            });
            updateChart();
            updateTradeInfo();
        }

        function updateTradeInfo() {
            const symbol = gameState.currentCommodity;
            const price = marketData[symbol].currentPrice;
            const quantity = parseInt(document.getElementById('marketQuantity').value) || 1;
            const leverage = parseInt(document.getElementById('marketLeverage').value) || 1;
            const cost = price * quantity / leverage;

            document.getElementById('marketInfo').textContent =
                `Current Price: $${price.toFixed(2)} | Est. Cost: $${cost.toFixed(2)}`;
        }

        function executeTrade(action, type) {
            const symbol = gameState.currentCommodity;
            const price = marketData[symbol].currentPrice;

            try {
                switch (type) {
                    case 'market':
                        executeMarketOrder(action, symbol, price);
                        break;
                    case 'limit':
                        executeLimitOrder(action, symbol);
                        break;
                    case 'short':
                        executeShortSell(symbol, price);
                        break;
                    case 'options':
                        executeOption(symbol, price);
                        break;
                }
                updateUI();
                saveGame();
            } catch (error) {
                showNotification('Trade Failed', error.message, 'error');
            }
        }

        function executeMarketOrder(action, symbol, price) {
            const quantity = parseInt(document.getElementById('marketQuantity').value);
            const leverage = parseInt(document.getElementById('marketLeverage').value);

            if (quantity <= 0) throw new Error('Invalid quantity');

            const cost = (price * quantity) / leverage;

            if (action === 'buy') {
                if (cost > gameState.cash) {
                    throw new Error('Insufficient funds');
                }

                gameState.cash -= cost;
                gameState.portfolio.push({
                    symbol,
                    type: 'long',
                    quantity,
                    entryPrice: price,
                    leverage,
                    timestamp: Date.now(),
                });

                showNotification('Trade Executed',
                    `BOUGHT ${quantity} ${symbol} @ $${price.toFixed(2)} (${leverage}x leverage)`,
                    'success');
                createFireParticles();
            } else {
                // Sell existing position
                const position = gameState.portfolio.find(p => p.symbol === symbol && p.type === 'long');
                if (!position) {
                    throw new Error('No position to sell');
                }

                const sellQuantity = Math.min(quantity, position.quantity);
                const proceeds = price * sellQuantity * position.leverage;
                const profit = proceeds - (position.entryPrice * sellQuantity * position.leverage);

                gameState.cash += proceeds;
                position.quantity -= sellQuantity;

                if (position.quantity <= 0) {
                    gameState.portfolio = gameState.portfolio.filter(p => p !== position);
                }

                gameState.dailyPL += profit;
                gameState.tradesCount++;

                showNotification('Trade Executed',
                    `SOLD ${sellQuantity} ${symbol} @ $${price.toFixed(2)} | P&L: $${profit.toFixed(2)}`,
                    profit > 0 ? 'success' : 'error');
            }
        }

        function executeLimitOrder(action, symbol) {
            const quantity = parseInt(document.getElementById('limitQuantity').value);
            const limitPrice = parseFloat(document.getElementById('limitPrice').value);

            if (quantity <= 0 || limitPrice <= 0) throw new Error('Invalid order parameters');

            // For simplicity, limit orders execute immediately if price is favorable
            const currentPrice = marketData[symbol].currentPrice;

            if (action === 'buy' && currentPrice <= limitPrice) {
                document.getElementById('marketQuantity').value = quantity;
                executeMarketOrder('buy', symbol, currentPrice);
            } else if (action === 'sell' && currentPrice >= limitPrice) {
                document.getElementById('marketQuantity').value = quantity;
                executeMarketOrder('sell', symbol, currentPrice);
            } else {
                showNotification('Limit Order Placed',
                    `${action.toUpperCase()} ${quantity} ${symbol} @ $${limitPrice.toFixed(2)}`,
                    'success');
            }
        }

        function executeShortSell(symbol, price) {
            const quantity = parseInt(document.getElementById('shortQuantity').value);

            if (quantity <= 0) throw new Error('Invalid quantity');

            // Check rank requirement
            if (gameState.rank < 2) {
                throw new Error('Short selling unlocked at SENIOR TRADER rank');
            }

            const proceeds = price * quantity;
            gameState.cash += proceeds;

            gameState.portfolio.push({
                symbol,
                type: 'short',
                quantity,
                entryPrice: price,
                timestamp: Date.now(),
            });

            showNotification('Short Position Opened',
                `SHORTED ${quantity} ${symbol} @ $${price.toFixed(2)}`,
                'success');
        }

        function executeOption(symbol, price) {
            const optionType = document.getElementById('optionType').value;
            const strikePrice = parseFloat(document.getElementById('strikePrice').value);
            const contracts = parseInt(document.getElementById('optionContracts').value);
            const expiry = parseInt(document.getElementById('optionExpiry').value);

            if (strikePrice <= 0 || contracts <= 0 || expiry <= 0) {
                throw new Error('Invalid option parameters');
            }

            // Check rank requirement
            if (gameState.rank < 3) {
                throw new Error('Options trading unlocked at VP OF DAMNATION rank');
            }

            // Simple premium calculation
            const premium = Math.abs(price - strikePrice) * 0.1 + (expiry * 0.5);
            const cost = premium * contracts;

            if (cost > gameState.cash) {
                throw new Error('Insufficient funds for premium');
            }

            gameState.cash -= cost;
            gameState.portfolio.push({
                symbol,
                type: 'option',
                optionType,
                quantity: contracts,
                strikePrice,
                entryPrice: price,
                premium,
                expiryTime: Date.now() + (expiry * 24 * 60 * 60 * 1000),
                timestamp: Date.now(),
            });

            showNotification('Option Purchased',
                `${contracts} ${optionType.toUpperCase()} ${symbol} $${strikePrice} @ $${premium.toFixed(2)}/contract`,
                'success');
        }

        // ============================================================================
        // PORTFOLIO MANAGEMENT
        // ============================================================================

        function updatePortfolioValues() {
            let totalValue = gameState.cash;
            let unrealizedPL = 0;

            gameState.portfolio.forEach(position => {
                const currentPrice = marketData[position.symbol].currentPrice;

                switch (position.type) {
                    case 'long':
                        const longValue = currentPrice * position.quantity * position.leverage;
                        const longCost = position.entryPrice * position.quantity * position.leverage;
                        totalValue += longValue;
                        unrealizedPL += longValue - longCost;
                        break;

                    case 'short':
                        const shortValue = position.entryPrice * position.quantity;
                        const shortCost = currentPrice * position.quantity;
                        totalValue += shortValue - shortCost;
                        unrealizedPL += shortValue - shortCost;
                        break;

                    case 'option':
                        // Simplified option valuation
                        if (position.optionType === 'call') {
                            const intrinsic = Math.max(0, currentPrice - position.strikePrice);
                            unrealizedPL += (intrinsic * position.quantity) - (position.premium * position.quantity);
                        } else {
                            const intrinsic = Math.max(0, position.strikePrice - currentPrice);
                            unrealizedPL += (intrinsic * position.quantity) - (position.premium * position.quantity);
                        }
                        break;
                }
            });

            // Update rank
            const newRank = RANKS.findIndex(rank => totalValue < rank.capital);
            gameState.rank = newRank === -1 ? RANKS.length - 1 : Math.max(0, newRank - 1);

            return { totalValue, unrealizedPL };
        }

        // ============================================================================
        // NEWS GENERATION
        // ============================================================================

        function startNewsGeneration() {
            newsInterval = setInterval(() => {
                generateNewsEvent();
            }, 30000); // Every 30 seconds
        }

        function generateNewsEvent() {
            const template = NEWS_TEMPLATES[Math.floor(Math.random() * NEWS_TEMPLATES.length)];
            const commodity = COMMODITIES[Math.floor(Math.random() * COMMODITIES.length)];

            const headline = template.headline.replace('{commodity}', commodity.name);
            const body = template.body;
            const impact = template.impact;

            addNewsItem(headline, body, impact);

            // Apply market impact
            if (Math.random() > 0.3) { // 70% chance news actually affects market
                applyMarketEvent(commodity.symbol, impact);
            }
        }

        function addNewsItem(headline, body, impact) {
            const newsContent = document.getElementById('newsContent');
            const newsItem = document.createElement('div');
            newsItem.className = 'news-item';

            const time = new Date().toLocaleTimeString();

            newsItem.innerHTML = `
                <div class="news-time">${time}</div>
                <div class="news-headline">
                    ${headline}
                    <span class="news-impact ${impact}">${impact.toUpperCase()}</span>
                </div>
                <div class="news-body">${body}</div>
            `;

            newsContent.insertBefore(newsItem, newsContent.firstChild);

            // Keep only last 20 news items
            while (newsContent.children.length > 20) {
                newsContent.removeChild(newsContent.lastChild);
            }
        }

        // ============================================================================
        // BROKER TIPS
        // ============================================================================

        function startBrokerTips() {
            brokerInterval = setInterval(() => {
                generateBrokerTip();
            }, 45000); // Every 45 seconds
        }

        function generateBrokerTip() {
            const broker = BROKERS[Math.floor(Math.random() * BROKERS.length)];
            const commodity = COMMODITIES[Math.floor(Math.random() * COMMODITIES.length)];
            const data = marketData[commodity.symbol];

            let message = '';
            const isAccurate = Math.random() < broker.accuracy;

            switch (broker.bias) {
                case 'greed':
                    message = `${commodity.symbol} is looking ${isAccurate ? 'extremely' : 'moderately'} profitable. Consider ${data.changePercent > 0 ? 'buying' : 'shorting'} for maximum gains. Remember: greed is GOOD.`;
                    break;
                case 'lazy':
                    message = `*yawn* ${commodity.symbol} has been ${isAccurate ? 'steadily' : 'slowly'} ${data.changePercent > 0 ? 'rising' : 'falling'}. Do with that what you will. I'm going back to sleep.`;
                    break;
                case 'charisma':
                    message = `Listen, ${commodity.symbol} is the NEXT BIG THING. Trust me, I've seen the future and it's ${isAccurate ? 'bright' : 'uncertain'}. Get in NOW before it's too late!`;
                    break;
                case 'obsessive':
                    message = `My analysis of ${commodity.symbol} shows ${isAccurate ? data.volatility * 100 : Math.random() * 10}% volatility with ${Math.random() > 0.5 ? 'bullish' : 'bearish'} momentum. RSI indicates ${isAccurate ? 'strong' : 'weak'} conviction.`;
                    break;
                case 'cryptic':
                    message = `The ${commodity.symbol} market speaks in whispers. Those who listen hear ${isAccurate ? 'truth' : 'echoes'}. The wise know when to ${data.changePercent > 0 ? 'embrace' : 'flee'} what others ignore.`;
                    break;
            }

            addBrokerMessage(broker, message);
        }

        function addBrokerMessage(broker, message) {
            const brokerPanel = document.getElementById('brokerPanel');
            const brokerMessage = document.createElement('div');
            brokerMessage.className = 'broker-message';

            brokerMessage.innerHTML = `
                <div class="broker-avatar">${broker.emoji}</div>
                <div class="broker-content">
                    <div class="broker-name">${broker.name}</div>
                    <div class="broker-text">${message}</div>
                </div>
            `;

            brokerPanel.insertBefore(brokerMessage, brokerPanel.firstChild);

            // Keep only last 5 messages
            while (brokerPanel.children.length > 5) {
                brokerPanel.removeChild(brokerPanel.lastChild);
            }
        }

        // ============================================================================
        // UI UPDATES
        // ============================================================================

        function updateUI() {
            const { totalValue, unrealizedPL } = updatePortfolioValues();

            // Header stats
            document.getElementById('rankBadge').textContent = RANKS[gameState.rank].name;
            document.getElementById('portfolioValue').textContent = '$' + totalValue.toFixed(0);
            document.getElementById('cashBalance').textContent = '$' + gameState.cash.toFixed(0);

            const plElement = document.getElementById('dailyPL');
            plElement.textContent = (gameState.dailyPL >= 0 ? '+' : '') + '$' + gameState.dailyPL.toFixed(0);
            plElement.className = 'stat-value ' + (gameState.dailyPL >= 0 ? 'positive' : 'negative');

            // Portfolio summary
            document.getElementById('totalValue').textContent = '$' + totalValue.toFixed(0);
            document.getElementById('unrealizedPL').textContent = (unrealizedPL >= 0 ? '+' : '') + '$' + unrealizedPL.toFixed(0);
            document.getElementById('unrealizedPL').className = 'summary-value ' + (unrealizedPL >= 0 ? 'positive' : 'negative');
            document.getElementById('positionCount').textContent = gameState.portfolio.length;
            document.getElementById('tradeCount').textContent = gameState.tradesCount;

            // Holdings list
            updateHoldingsList();
        }

        function updateHoldingsList() {
            const holdingsList = document.getElementById('holdingsList');
            holdingsList.innerHTML = '';

            if (gameState.portfolio.length === 0) {
                holdingsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No positions yet. Start trading to build your infernal empire.</div>';
                return;
            }

            gameState.portfolio.forEach(position => {
                const currentPrice = marketData[position.symbol].currentPrice;
                let pl = 0;
                let plPercent = 0;

                switch (position.type) {
                    case 'long':
                        const value = currentPrice * position.quantity * position.leverage;
                        const cost = position.entryPrice * position.quantity * position.leverage;
                        pl = value - cost;
                        plPercent = (pl / cost) * 100;
                        break;

                    case 'short':
                        pl = (position.entryPrice - currentPrice) * position.quantity;
                        plPercent = (pl / (position.entryPrice * position.quantity)) * 100;
                        break;

                    case 'option':
                        if (position.optionType === 'call') {
                            const intrinsic = Math.max(0, currentPrice - position.strikePrice);
                            pl = (intrinsic * position.quantity) - (position.premium * position.quantity);
                        } else {
                            const intrinsic = Math.max(0, position.strikePrice - currentPrice);
                            pl = (intrinsic * position.quantity) - (position.premium * position.quantity);
                        }
                        plPercent = (pl / (position.premium * position.quantity)) * 100;
                        break;
                }

                const holdingItem = document.createElement('div');
                holdingItem.className = 'holding-item';
                holdingItem.style.borderColor = pl >= 0 ? '#00ff00' : '#ff0000';

                let typeLabel = position.type.toUpperCase();
                if (position.type === 'option') {
                    typeLabel = `${position.optionType.toUpperCase()} OPTION`;
                }

                holdingItem.innerHTML = `
                    <div class="holding-header">
                        <span>${position.symbol} (${typeLabel})</span>
                        <span style="color: ${pl >= 0 ? '#00ff00' : '#ff0000'}">
                            ${pl >= 0 ? '+' : ''}$${pl.toFixed(2)} (${pl >= 0 ? '+' : ''}${plPercent.toFixed(1)}%)
                        </span>
                    </div>
                    <div class="holding-details">
                        <div>Qty: ${position.quantity}</div>
                        <div>Entry: $${position.entryPrice.toFixed(2)}</div>
                        <div>Current: $${currentPrice.toFixed(2)}</div>
                        ${position.leverage ? `<div>Leverage: ${position.leverage}x</div>` : ''}
                        ${position.strikePrice ? `<div>Strike: $${position.strikePrice.toFixed(2)}</div>` : ''}
                    </div>
                `;

                holdingsList.appendChild(holdingItem);
            });
        }

        // ============================================================================
        // VISUAL EFFECTS
        // ============================================================================

        function createFireParticles() {
            const container = document.body;
            const emojis = ['ðŸ”¥', 'ðŸ’°', 'ðŸ‘¹', 'âš”ï¸'];

            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'fire-particle';
                    particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    particle.style.left = (Math.random() * window.innerWidth) + 'px';
                    particle.style.top = (window.innerHeight / 2) + 'px';
                    container.appendChild(particle);

                    setTimeout(() => particle.remove(), 2000);
                }, i * 100);
            }
        }

        // ============================================================================
        // NOTIFICATIONS
        // ============================================================================

        function showNotification(title, body, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-body">${body}</div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // ============================================================================
        // MODAL
        // ============================================================================

        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        // ============================================================================
        // SAVE/LOAD
        // ============================================================================

        function saveGame() {
            try {
                localStorage.setItem('infernalTrader_gameState', JSON.stringify(gameState));
                localStorage.setItem('infernalTrader_marketData', JSON.stringify(marketData));
                localStorage.setItem('infernalTrader_priceHistory', JSON.stringify(priceHistory));
            } catch (e) {
                console.error('Failed to save game:', e);
            }
        }

        function loadGame() {
            try {
                const savedState = localStorage.getItem('infernalTrader_gameState');
                const savedMarket = localStorage.getItem('infernalTrader_marketData');
                const savedHistory = localStorage.getItem('infernalTrader_priceHistory');

                if (savedState) {
                    gameState = JSON.parse(savedState);
                }
                if (savedMarket) {
                    marketData = JSON.parse(savedMarket);
                }
                if (savedHistory) {
                    priceHistory = JSON.parse(savedHistory);
                }
            } catch (e) {
                console.error('Failed to load game:', e);
            }
        }

        function resetGame() {
            if (confirm('Are you sure you want to reset? All progress will be lost.')) {
                localStorage.removeItem('infernalTrader_gameState');
                localStorage.removeItem('infernalTrader_marketData');
                localStorage.removeItem('infernalTrader_priceHistory');
                location.reload();
            }
        }

        // ============================================================================
        // KEYBOARD SHORTCUTS
        // ============================================================================

        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                resetGame();
            }
        });

        // ============================================================================
        // START GAME
        // ============================================================================

        window.addEventListener('load', init);
        window.addEventListener('resize', setupChart);
    </script>
</body>
</html>