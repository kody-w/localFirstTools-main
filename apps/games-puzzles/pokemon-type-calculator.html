<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Type Clash Arena</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#111;overflow:hidden;font-family:'Segoe UI',sans-serif;color:#fff;user-select:none}
canvas{display:block}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
// Type Clash Arena - Elemental Battle Quiz RPG
// Canvas-based game with full type chart, battle system, progression
const C=document.getElementById('c'),X=C.getContext('2d');
let W,H;
function resize(){W=C.width=innerWidth;H=C.height=innerHeight}
resize();
addEventListener('resize',resize);

// Audio
let audioCtx=null;
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)()}
function playSound(freq,dur,type='square',vol=0.15){
  if(!audioCtx)return;
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type=type;o.frequency.value=freq;
  g.gain.value=vol;g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
  o.connect(g);g.connect(audioCtx.destination);
  o.start();o.stop(audioCtx.currentTime+dur);
}
function sfxCorrect(){playSound(523,0.1,'square');setTimeout(()=>playSound(659,0.1,'square'),100);setTimeout(()=>playSound(784,0.15,'square'),200)}
function sfxWrong(){playSound(200,0.3,'sawtooth',0.1);setTimeout(()=>playSound(150,0.4,'sawtooth',0.08),150)}
function sfxHit(){playSound(120,0.15,'sawtooth',0.2);playSound(80,0.2,'square',0.1)}
function sfxHeal(){playSound(440,0.1,'sine');setTimeout(()=>playSound(554,0.1,'sine'),80);setTimeout(()=>playSound(659,0.15,'sine'),160)}
function sfxBoss(){playSound(80,0.5,'sawtooth',0.2);setTimeout(()=>playSound(60,0.6,'sawtooth',0.15),200)}
function sfxLevelUp(){for(let i=0;i<5;i++)setTimeout(()=>playSound(400+i*100,0.12,'square',0.1),i*80)}
function sfxMenu(){playSound(440,0.08,'sine',0.1)}
function sfxSelect(){playSound(600,0.06,'square',0.08)}
function sfxVictory(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>playSound(f,0.2,'square',0.12),i*150))}
function sfxDefeat(){[400,350,300,200].forEach((f,i)=>setTimeout(()=>playSound(f,0.3,'sawtooth',0.1),i*200))}

// Types
const TYPES=['Normal','Fire','Water','Grass','Electric','Ice','Fighting','Poison','Ground','Flying','Psychic','Bug','Rock','Ghost','Dragon','Dark','Steel','Fairy'];
const TYPE_COLORS={
  Normal:'#A8A878',Fire:'#F08030',Water:'#6890F0',Grass:'#78C850',Electric:'#F8D030',
  Ice:'#98D8D8',Fighting:'#C03028',Poison:'#A040A0',Ground:'#E0C068',Flying:'#A890F0',
  Psychic:'#F85888',Bug:'#A8B820',Rock:'#B8A038',Ghost:'#705898',Dragon:'#7038F8',
  Dark:'#705848',Steel:'#B8B8D0',Fairy:'#EE99AC'
};

// Full 18x18 type effectiveness chart
// 0=normal, 1=super effective (2x), -1=not very (0.5x), -2=immune (0x)
const CHART={};
function eff(atk,def,val){if(!CHART[atk])CHART[atk]={};CHART[atk][def]=val}
// Fire
eff('Fire','Grass',1);eff('Fire','Ice',1);eff('Fire','Bug',1);eff('Fire','Steel',1);
eff('Fire','Fire',-1);eff('Fire','Water',-1);eff('Fire','Rock',-1);eff('Fire','Dragon',-1);
// Water
eff('Water','Fire',1);eff('Water','Ground',1);eff('Water','Rock',1);
eff('Water','Water',-1);eff('Water','Grass',-1);eff('Water','Dragon',-1);
// Grass
eff('Grass','Water',1);eff('Grass','Ground',1);eff('Grass','Rock',1);
eff('Grass','Fire',-1);eff('Grass','Grass',-1);eff('Grass','Poison',-1);eff('Grass','Flying',-1);eff('Grass','Bug',-1);eff('Grass','Dragon',-1);eff('Grass','Steel',-1);
// Electric
eff('Electric','Water',1);eff('Electric','Flying',1);
eff('Electric','Grass',-1);eff('Electric','Electric',-1);eff('Electric','Dragon',-1);eff('Electric','Ground',-2);
// Ice
eff('Ice','Grass',1);eff('Ice','Ground',1);eff('Ice','Flying',1);eff('Ice','Dragon',1);
eff('Ice','Fire',-1);eff('Ice','Water',-1);eff('Ice','Ice',-1);eff('Ice','Steel',-1);
// Fighting
eff('Fighting','Normal',1);eff('Fighting','Ice',1);eff('Fighting','Rock',1);eff('Fighting','Dark',1);eff('Fighting','Steel',1);
eff('Fighting','Poison',-1);eff('Fighting','Flying',-1);eff('Fighting','Psychic',-1);eff('Fighting','Bug',-1);eff('Fighting','Fairy',-1);eff('Fighting','Ghost',-2);
// Poison
eff('Poison','Grass',1);eff('Poison','Fairy',1);
eff('Poison','Poison',-1);eff('Poison','Ground',-1);eff('Poison','Rock',-1);eff('Poison','Ghost',-1);eff('Poison','Steel',-2);
// Ground
eff('Ground','Fire',1);eff('Ground','Electric',1);eff('Ground','Poison',1);eff('Ground','Rock',1);eff('Ground','Steel',1);
eff('Ground','Grass',-1);eff('Ground','Bug',-1);eff('Ground','Flying',-2);
// Flying
eff('Flying','Grass',1);eff('Flying','Fighting',1);eff('Flying','Bug',1);
eff('Flying','Electric',-1);eff('Flying','Rock',-1);eff('Flying','Steel',-1);
// Psychic
eff('Psychic','Fighting',1);eff('Psychic','Poison',1);
eff('Psychic','Psychic',-1);eff('Psychic','Steel',-1);eff('Psychic','Dark',-2);
// Bug
eff('Bug','Grass',1);eff('Bug','Psychic',1);eff('Bug','Dark',1);
eff('Bug','Fire',-1);eff('Bug','Fighting',-1);eff('Bug','Poison',-1);eff('Bug','Flying',-1);eff('Bug','Ghost',-1);eff('Bug','Steel',-1);eff('Bug','Fairy',-1);
// Rock
eff('Rock','Fire',1);eff('Rock','Ice',1);eff('Rock','Flying',1);eff('Rock','Bug',1);
eff('Rock','Fighting',-1);eff('Rock','Ground',-1);eff('Rock','Steel',-1);
// Ghost
eff('Ghost','Psychic',1);eff('Ghost','Ghost',1);
eff('Ghost','Dark',-1);eff('Ghost','Normal',-2);
// Dragon
eff('Dragon','Dragon',1);
eff('Dragon','Steel',-1);eff('Dragon','Fairy',-2);
// Dark
eff('Dark','Psychic',1);eff('Dark','Ghost',1);
eff('Dark','Fighting',-1);eff('Dark','Dark',-1);eff('Dark','Fairy',-1);
// Steel
eff('Steel','Ice',1);eff('Steel','Rock',1);eff('Steel','Fairy',1);
eff('Steel','Fire',-1);eff('Steel','Water',-1);eff('Steel','Electric',-1);eff('Steel','Steel',-1);
// Fairy
eff('Fairy','Fighting',1);eff('Fairy','Dragon',1);eff('Fairy','Dark',1);
eff('Fairy','Fire',-1);eff('Fairy','Poison',-1);eff('Fairy','Steel',-1);
// Normal
eff('Normal','Rock',-1);eff('Normal','Steel',-1);eff('Normal','Ghost',-2);

function getEff(atk,def){return (CHART[atk]&&CHART[atk][def])||0}
function effLabel(v){return v===1?'Super Effective!':v===-1?'Not Very Effective':v===-2?'No Effect (Immune)':'Normal Damage'}
function effMult(v){return v===1?2:v===-1?0.5:v===-2?0:1}

// Creatures
const CREATURES=[
  {name:'Infernape',types:['Fire','Fighting'],hp:76,atk:104,spd:108,sprite:'fire'},
  {name:'Gyarados',types:['Water','Flying'],hp:95,atk:125,spd:81,sprite:'water'},
  {name:'Venusaur',types:['Grass','Poison'],hp:80,atk:82,spd:80,sprite:'grass'},
  {name:'Pikachu',types:['Electric'],hp:35,atk:55,spd:90,sprite:'electric'},
  {name:'Lapras',types:['Water','Ice'],hp:130,atk:85,spd:60,sprite:'ice'},
  {name:'Machamp',types:['Fighting'],hp:90,atk:130,spd:55,sprite:'fighting'},
  {name:'Gengar',types:['Ghost','Poison'],hp:60,atk:65,spd:110,sprite:'ghost'},
  {name:'Dragonite',types:['Dragon','Flying'],hp:91,atk:134,spd:80,sprite:'dragon'},
  {name:'Tyranitar',types:['Rock','Dark'],hp:100,atk:134,spd:61,sprite:'rock'},
  {name:'Metagross',types:['Steel','Psychic'],hp:80,atk:135,spd:70,sprite:'steel'},
  {name:'Gardevoir',types:['Psychic','Fairy'],hp:68,atk:65,spd:80,sprite:'psychic'},
  {name:'Scizor',types:['Bug','Steel'],hp:70,atk:130,spd:65,sprite:'bug'},
  {name:'Garchomp',types:['Dragon','Ground'],hp:108,atk:130,spd:102,sprite:'dragon'},
  {name:'Togekiss',types:['Fairy','Flying'],hp:85,atk:50,spd:80,sprite:'fairy'},
  {name:'Excadrill',types:['Ground','Steel'],hp:110,atk:135,spd:88,sprite:'ground'},
  {name:'Weavile',types:['Dark','Ice'],hp:70,atk:120,spd:125,sprite:'dark'},
  {name:'Toxicroak',types:['Poison','Fighting'],hp:83,atk:106,spd:85,sprite:'poison'},
  {name:'Staraptor',types:['Normal','Flying'],hp:85,atk:120,spd:100,sprite:'flying'},
  {name:'Lucario',types:['Fighting','Steel'],hp:70,atk:110,spd:90,sprite:'fighting'},
  {name:'Salamence',types:['Dragon','Flying'],hp:95,atk:135,spd:100,sprite:'dragon'},
  {name:'Aegislash',types:['Steel','Ghost'],hp:60,atk:50,spd:60,sprite:'steel'},
  {name:'Clefable',types:['Fairy'],hp:95,atk:70,spd:60,sprite:'fairy'},
  {name:'Nidoking',types:['Poison','Ground'],hp:81,atk:102,spd:85,sprite:'poison'},
  {name:'Steelix',types:['Steel','Ground'],hp:75,atk:85,spd:30,sprite:'steel'},
  {name:'Alakazam',types:['Psychic'],hp:55,atk:50,spd:120,sprite:'psychic'},
  {name:'Snorlax',types:['Normal'],hp:160,atk:110,spd:30,sprite:'normal'},
  {name:'Chandelure',types:['Ghost','Fire'],hp:60,atk:55,spd:80,sprite:'ghost'},
  {name:'Ferrothorn',types:['Grass','Steel'],hp:74,atk:94,spd:20,sprite:'grass'},
  {name:'Bisharp',types:['Dark','Steel'],hp:65,atk:125,spd:70,sprite:'dark'},
  {name:'Volcarona',types:['Bug','Fire'],hp:85,atk:60,spd:100,sprite:'fire'},
];

// Game state
let state='menu'; // menu, playing, quiz, battle, paused, gameover, roundover
let difficulty=1; // 0=easy, 1=normal, 2=hard
const DIFF_NAMES=['Easy','Normal','Hard'];
const DIFF_MULT=[0.7,1.0,1.4];
let menuSel=1;
let player={hp:100,maxHp:100,xp:0,level:1,streak:0,bestStreak:0,score:0,correct:0,wrong:0,battles:0,wins:0};
let round=0,maxRounds=20;
let quiz=null; // current quiz question
let battle=null; // current battle state
let particles=[];
let shakeX=0,shakeY=0,shakeDur=0;
let flashAlpha=0;
let hoverBtn=-1;
let bgParticles=[];
let comboTimer=0;
let comboMult=1;
let pauseMenuSel=0;
let gameoverSel=0;
let roundPhase=''; // 'quiz' or 'battle'
let bossRound=false;
let resultTimer=0;
let resultText='';
let resultColor='';
let showingResult=false;
let highScores=[];
let enemyCreature=null;
let playerCreature=null;
let battleAnim=0;
let enemyHp=0,enemyMaxHp=0;
let playerBattleHp=0,playerBattleMaxHp=0;
let battleTurn='player';
let battleLog=[];
let battleOver=false;
let attackOptions=[];
let attackSel=0;
let totalQuizzes=0;

// Keys
const keys={};
addEventListener('keydown',e=>{
  keys[e.key]=true;
  if(state==='menu')handleMenuKey(e.key);
  else if(state==='quiz')handleQuizKey(e.key);
  else if(state==='battle')handleBattleKey(e.key);
  else if(state==='paused')handlePauseKey(e.key);
  else if(state==='gameover')handleGameoverKey(e.key);
  else if(state==='roundover')handleRoundoverKey(e.key);
  if(e.key==='Escape'&&state==='playing'){state='paused';pauseMenuSel=0;sfxMenu()}
  else if(e.key==='Escape'&&state==='paused'){state='playing';sfxMenu()}
  e.preventDefault();
});
addEventListener('keyup',e=>{keys[e.key]=false});

// Touch
let touchStart=null;
addEventListener('touchstart',e=>{
  initAudio();
  const t=e.touches[0];
  touchStart={x:t.clientX,y:t.clientY};
  handleTouchTap(t.clientX,t.clientY);
  e.preventDefault();
},{passive:false});
addEventListener('touchend',e=>{touchStart=null;e.preventDefault()},{passive:false});
addEventListener('click',e=>{initAudio();handleTouchTap(e.clientX,e.clientY)});

function handleTouchTap(tx,ty){
  if(state==='menu'){
    // Check difficulty buttons
    const bw=160,bh=50,gap=20;
    const totalW=3*(bw+gap)-gap;
    const sx=W/2-totalW/2;
    const by=H*0.5;
    for(let i=0;i<3;i++){
      const bx=sx+i*(bw+gap);
      if(tx>=bx&&tx<=bx+bw&&ty>=by&&ty<=by+bh){
        difficulty=i;menuSel=i;sfxSelect();
      }
    }
    // Start button
    const startX=W/2-100,startY=H*0.65;
    if(tx>=startX&&tx<=startX+200&&ty>=startY&&ty<=startY+55){
      startGame();
    }
  } else if(state==='quiz'&&quiz){
    // Check answer buttons
    const aw=280,ah=50,gap=12;
    const sy=H*0.6;
    for(let i=0;i<quiz.options.length;i++){
      const ay=sy+i*(ah+gap);
      const ax=W/2-aw/2;
      if(tx>=ax&&tx<=ax+aw&&ty>=ay&&ty<=ay+ah){
        answerQuiz(i);
      }
    }
  } else if(state==='battle'&&!battleOver){
    const aw=200,ah=45,gap=10;
    const sy=H*0.7;
    for(let i=0;i<attackOptions.length;i++){
      const col=i%2,row=Math.floor(i/2);
      const ax=W/2-210+col*210;
      const ay=sy+row*(ah+gap);
      if(tx>=ax&&tx<=ax+aw&&ty>=ay&&ty<=ay+ah){
        attackSel=i;
        playerAttack(i);
      }
    }
  } else if(state==='battle'&&battleOver){
    advanceRound();
  } else if(state==='roundover'){
    advanceRound();
  } else if(state==='gameover'){
    const bw=180,bh=50;
    const bx=W/2-bw/2,by=H*0.78;
    if(tx>=bx&&tx<=bx+bw&&ty>=by&&ty<=by+bh){
      state='menu';sfxMenu();
    }
  } else if(state==='paused'){
    const bw=200,bh=50;
    const items=['Resume','Restart','Quit'];
    const sy=H/2-40;
    for(let i=0;i<items.length;i++){
      const iy=sy+i*60;
      if(tx>=W/2-bw/2&&tx<=W/2+bw/2&&ty>=iy&&ty<=iy+bh){
        if(i===0){state='playing';sfxMenu()}
        else if(i===1){startGame()}
        else{state='menu';sfxMenu()}
      }
    }
  }
}

// Load high scores
function loadScores(){
  try{highScores=JSON.parse(localStorage.getItem('typeClashScores'))||[]}catch(e){highScores=[]}
}
function saveScore(){
  highScores.push({score:player.score,level:player.level,date:new Date().toISOString().slice(0,10),diff:DIFF_NAMES[difficulty]});
  highScores.sort((a,b)=>b.score-a.score);
  highScores=highScores.slice(0,10);
  localStorage.setItem('typeClashScores',JSON.stringify(highScores));
}
loadScores();

// Settings persistence
function loadSettings(){
  try{
    const s=JSON.parse(localStorage.getItem('typeClashSettings'));
    if(s){difficulty=s.difficulty||1}
  }catch(e){}
}
function saveSettings(){
  localStorage.setItem('typeClashSettings',JSON.stringify({difficulty}));
}
loadSettings();

// Init BG particles
function initBgParticles(){
  bgParticles=[];
  for(let i=0;i<40;i++){
    bgParticles.push({
      x:Math.random()*W,y:Math.random()*H,
      vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.5,
      r:Math.random()*3+1,
      type:TYPES[Math.floor(Math.random()*TYPES.length)],
      alpha:Math.random()*0.3+0.1
    });
  }
}
initBgParticles();

function handleMenuKey(key){
  if(key==='ArrowLeft'||key==='a'){menuSel=Math.max(0,menuSel-1);sfxSelect()}
  if(key==='ArrowRight'||key==='d'){menuSel=Math.min(2,menuSel+1);sfxSelect()}
  if(key==='Enter'||key===' '){
    difficulty=menuSel;
    startGame();
  }
  if(key>='1'&&key<='3'){menuSel=parseInt(key)-1;difficulty=menuSel;sfxSelect()}
}

function handleQuizKey(key){
  if(showingResult){
    if(key==='Enter'||key===' '){advanceRound()}
    return;
  }
  if(!quiz)return;
  if(key==='1')answerQuiz(0);
  if(key==='2')answerQuiz(1);
  if(key==='3')answerQuiz(2);
  if(key==='4'&&quiz.options.length>3)answerQuiz(3);
}

function handleBattleKey(key){
  if(battleOver){
    if(key==='Enter'||key===' ')advanceRound();
    return;
  }
  if(battleTurn!=='player')return;
  if(key==='ArrowLeft'||key==='a')attackSel=Math.max(0,attackSel-1);
  if(key==='ArrowRight'||key==='d')attackSel=Math.min(attackOptions.length-1,attackSel+1);
  if(key==='ArrowUp'||key==='w')attackSel=Math.max(0,attackSel-2);
  if(key==='ArrowDown'||key==='s')attackSel=Math.min(attackOptions.length-1,attackSel+2);
  if(key==='Enter'||key===' ')playerAttack(attackSel);
}

function handlePauseKey(key){
  if(key==='ArrowUp'||key==='w')pauseMenuSel=Math.max(0,pauseMenuSel-1);
  if(key==='ArrowDown'||key==='s')pauseMenuSel=Math.min(2,pauseMenuSel+1);
  if(key==='Enter'||key===' '){
    if(pauseMenuSel===0){state='playing';sfxMenu()}
    else if(pauseMenuSel===1){startGame()}
    else{state='menu';sfxMenu()}
  }
}

function handleGameoverKey(key){
  if(key==='Enter'||key===' '||key==='r'){state='menu';sfxMenu()}
}

function handleRoundoverKey(key){
  if(key==='Enter'||key===' ')advanceRound();
}

function startGame(){
  initAudio();
  player={hp:100,maxHp:100,xp:0,level:1,streak:0,bestStreak:0,score:0,correct:0,wrong:0,battles:0,wins:0};
  round=0;maxRounds=20;
  quiz=null;battle=null;particles=[];
  comboTimer=0;comboMult=1;
  totalQuizzes=0;
  state='playing';
  saveSettings();
  sfxSelect();
  nextRound();
}

function nextRound(){
  round++;
  if(round>maxRounds){
    endGame();
    return;
  }
  bossRound=(round%5===0);
  showingResult=false;
  resultTimer=0;
  // Alternate quiz and battle phases
  if(round%2===1||bossRound){
    roundPhase='quiz';
    generateQuiz();
    state='quiz';
  } else {
    roundPhase='battle';
    generateBattle();
    state='battle';
  }
}

function generateQuiz(){
  totalQuizzes++;
  const qType=Math.floor(Math.random()*4);
  const atkType=TYPES[Math.floor(Math.random()*TYPES.length)];
  let defType=TYPES[Math.floor(Math.random()*TYPES.length)];
  while(defType===atkType)defType=TYPES[Math.floor(Math.random()*TYPES.length)];

  if(qType===0){
    // "What is X vs Y?"
    const correct=getEff(atkType,defType);
    const correctLabel=effLabel(correct);
    let options=[correctLabel];
    const allLabels=['Super Effective!','Not Very Effective','No Effect (Immune)','Normal Damage'];
    for(const l of allLabels){if(l!==correctLabel)options.push(l)}
    const correctIdx=0;
    // Shuffle
    const shuffled=shuffleWithAnswer(options,correctIdx);
    quiz={
      question:`${atkType} attacks ${defType}. What's the effectiveness?`,
      atkType,defType,
      options:shuffled.options,
      correct:shuffled.answerIdx,
      explanation:`${atkType} vs ${defType} = ${effMult(correct)}x (${correctLabel})`
    };
  } else if(qType===1){
    // "Which type is super effective against X?"
    const target=TYPES[Math.floor(Math.random()*TYPES.length)];
    const superEffective=TYPES.filter(t=>getEff(t,target)===1);
    if(superEffective.length===0){generateQuiz();return}
    const answer=superEffective[Math.floor(Math.random()*superEffective.length)];
    let options=[answer];
    const others=TYPES.filter(t=>!superEffective.includes(t));
    while(options.length<4&&others.length>0){
      const idx=Math.floor(Math.random()*others.length);
      options.push(others.splice(idx,1)[0]);
    }
    const shuffled=shuffleWithAnswer(options,0);
    quiz={
      question:`Which type is SUPER EFFECTIVE against ${target}?`,
      atkType:answer,defType:target,
      options:shuffled.options,
      correct:shuffled.answerIdx,
      explanation:`${answer} is super effective against ${target} (2x damage)`
    };
  } else if(qType===2){
    // "Which type resists X?"
    const atkT=TYPES[Math.floor(Math.random()*TYPES.length)];
    const resists=TYPES.filter(t=>getEff(atkT,t)===-1);
    if(resists.length===0){generateQuiz();return}
    const answer=resists[Math.floor(Math.random()*resists.length)];
    let options=[answer];
    const others=TYPES.filter(t=>!resists.includes(t)&&getEff(atkT,t)!==-2);
    while(options.length<4&&others.length>0){
      const idx=Math.floor(Math.random()*others.length);
      options.push(others.splice(idx,1)[0]);
    }
    const shuffled=shuffleWithAnswer(options,0);
    quiz={
      question:`Which type RESISTS ${atkT} attacks?`,
      atkType:atkT,defType:answer,
      options:shuffled.options,
      correct:shuffled.answerIdx,
      explanation:`${answer} resists ${atkT} (0.5x damage)`
    };
  } else {
    // "Which type is X immune to?"
    const defT=TYPES[Math.floor(Math.random()*TYPES.length)];
    const immune=TYPES.filter(t=>getEff(t,defT)===-2);
    if(immune.length===0){generateQuiz();return}
    const answer=immune[Math.floor(Math.random()*immune.length)];
    let options=[answer];
    const others=TYPES.filter(t=>!immune.includes(t));
    while(options.length<4&&others.length>0){
      const idx=Math.floor(Math.random()*others.length);
      options.push(others.splice(idx,1)[0]);
    }
    const shuffled=shuffleWithAnswer(options,0);
    quiz={
      question:`${defT} is IMMUNE to which type's attacks?`,
      atkType:answer,defType:defT,
      options:shuffled.options,
      correct:shuffled.answerIdx,
      explanation:`${defT} is immune to ${answer} (0x damage)`
    };
  }
}

function shuffleWithAnswer(options,answerIdx){
  const answer=options[answerIdx];
  for(let i=options.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [options[i],options[j]]=[options[j],options[i]];
  }
  return{options,answerIdx:options.indexOf(answer)};
}

function answerQuiz(idx){
  if(showingResult||!quiz)return;
  showingResult=true;
  const correct=idx===quiz.correct;
  if(correct){
    sfxCorrect();
    player.correct++;
    player.streak++;
    if(player.streak>player.bestStreak)player.bestStreak=player.streak;
    comboMult=player.streak>=10?4:player.streak>=5?3:player.streak>=3?2:1;
    const pts=Math.floor((100+round*10)*comboMult*DIFF_MULT[difficulty]);
    player.score+=pts;
    player.xp+=20*comboMult;
    resultText=`CORRECT! +${pts} pts (x${comboMult})`;
    resultColor='#4f4';
    spawnParticles(W/2,H/2,20,'#4f4');
    // Level up check
    if(player.xp>=player.level*100){
      player.level++;
      player.maxHp=Math.min(200,player.maxHp+10);
      player.hp=player.maxHp;
      sfxLevelUp();
      resultText+=` LEVEL UP! Lv.${player.level}`;
    }
  } else {
    sfxWrong();
    player.wrong++;
    player.streak=0;
    comboMult=1;
    const dmg=Math.floor(15*DIFF_MULT[difficulty]);
    player.hp-=dmg;
    resultText=`WRONG! -${dmg} HP. ${quiz.explanation}`;
    resultColor='#f44';
    triggerShake(8);
    flashAlpha=0.4;
    spawnParticles(W/2,H/2,15,'#f44');
    if(player.hp<=0){
      player.hp=0;
      endGame();
      return;
    }
  }
  resultTimer=180; // 3 seconds to show result
}

function generateBattle(){
  // Pick enemy creature
  const pool=CREATURES.filter(c=>true);
  const idx=Math.floor(Math.random()*pool.length);
  enemyCreature=JSON.parse(JSON.stringify(pool[idx]));
  // Scale with difficulty and round
  const scale=1+round*0.05*DIFF_MULT[difficulty];
  if(bossRound){
    enemyCreature.name='BOSS '+enemyCreature.name;
    enemyCreature.hp=Math.floor(enemyCreature.hp*2*scale);
    enemyCreature.atk=Math.floor(enemyCreature.atk*1.5*scale);
    sfxBoss();
  } else {
    enemyCreature.hp=Math.floor(enemyCreature.hp*scale);
    enemyCreature.atk=Math.floor(enemyCreature.atk*scale);
  }
  enemyHp=enemyCreature.hp;
  enemyMaxHp=enemyCreature.hp;

  // Player creature
  const pIdx=Math.floor(Math.random()*pool.length);
  playerCreature=JSON.parse(JSON.stringify(pool[pIdx]));
  playerCreature.hp=Math.floor(playerCreature.hp*(1+player.level*0.1));
  playerCreature.atk=Math.floor(playerCreature.atk*(1+player.level*0.08));
  playerBattleHp=playerCreature.hp;
  playerBattleMaxHp=playerCreature.hp;

  // Generate attack options (4 types)
  attackOptions=[];
  // Always include player creature's own types
  for(const t of playerCreature.types)attackOptions.push(t);
  // Fill with random types
  const available=TYPES.filter(t=>!attackOptions.includes(t));
  while(attackOptions.length<4&&available.length>0){
    const ri=Math.floor(Math.random()*available.length);
    attackOptions.push(available.splice(ri,1)[0]);
  }
  // Shuffle
  for(let i=attackOptions.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [attackOptions[i],attackOptions[j]]=[attackOptions[j],attackOptions[i]];
  }
  attackSel=0;
  battleTurn='player';
  battleLog=[];
  battleOver=false;
  battleAnim=0;
  player.battles++;
}

function playerAttack(idx){
  if(battleTurn!=='player'||battleOver)return;
  const atkType=attackOptions[idx];
  // Calculate effectiveness against enemy
  let totalEff=0;
  for(const dt of enemyCreature.types)totalEff+=getEff(atkType,dt);
  const mult=totalEff>=2?4:totalEff===1?2:totalEff===0?1:totalEff===-1?0.5:totalEff<=-2?0:1;
  const baseDmg=Math.floor(playerCreature.atk*0.3*(1+player.level*0.05));
  const dmg=Math.max(0,Math.floor(baseDmg*mult));

  enemyHp=Math.max(0,enemyHp-dmg);
  let msg=`${atkType} attack deals ${dmg} damage!`;
  if(mult>=2){msg+=' Super Effective!';sfxCorrect();spawnParticles(W*0.65,H*0.35,15,'#ff0')}
  else if(mult===0){msg+=' No Effect!';sfxWrong()}
  else if(mult<1){msg+=' Not Very Effective...';sfxHit()}
  else{sfxHit();spawnParticles(W*0.65,H*0.35,8,'#fff')}
  battleLog.unshift(msg);
  if(battleLog.length>4)battleLog.pop();

  if(mult>=2){
    triggerShake(6);
    player.streak++;
    if(player.streak>player.bestStreak)player.bestStreak=player.streak;
  }

  if(enemyHp<=0){
    battleOver=true;
    player.wins++;
    const pts=Math.floor((200+round*20)*(bossRound?3:1)*DIFF_MULT[difficulty]*comboMult);
    player.score+=pts;
    player.xp+=50*(bossRound?3:1);
    battleLog.unshift(`Victory! +${pts} pts!`);
    sfxVictory();
    spawnParticles(W*0.65,H*0.35,30,'#ff0');
    // Level up
    if(player.xp>=player.level*100){
      player.level++;player.maxHp=Math.min(200,player.maxHp+10);player.hp=player.maxHp;
      sfxLevelUp();battleLog.unshift(`LEVEL UP! Lv.${player.level}!`);
    }
    return;
  }

  // Enemy turn
  battleTurn='enemy';
  setTimeout(()=>{
    if(state!=='battle')return;
    enemyAttack();
  },800);
}

function enemyAttack(){
  // AI picks best type
  const atkType=enemyCreature.types[Math.floor(Math.random()*enemyCreature.types.length)];
  let totalEff=0;
  for(const dt of playerCreature.types)totalEff+=getEff(atkType,dt);
  const mult=totalEff>=2?4:totalEff===1?2:totalEff===0?1:totalEff===-1?0.5:totalEff<=-2?0:1;
  const baseDmg=Math.floor(enemyCreature.atk*0.25*DIFF_MULT[difficulty]);
  const dmg=Math.max(0,Math.floor(baseDmg*mult));

  playerBattleHp=Math.max(0,playerBattleHp-dmg);
  let msg=`Enemy ${atkType} deals ${dmg}!`;
  if(mult>=2){msg+=' Super Effective!';triggerShake(8);flashAlpha=0.3}
  sfxHit();
  battleLog.unshift(msg);
  if(battleLog.length>4)battleLog.pop();
  spawnParticles(W*0.3,H*0.55,8,'#f66');

  if(playerBattleHp<=0){
    battleOver=true;
    const hpLoss=Math.floor(20*DIFF_MULT[difficulty]);
    player.hp=Math.max(0,player.hp-hpLoss);
    player.streak=0;comboMult=1;
    battleLog.unshift(`Defeated! -${hpLoss} HP`);
    sfxDefeat();
    if(player.hp<=0){endGame();return}
  }
  battleTurn='player';
}

function advanceRound(){
  if(showingResult)showingResult=false;
  state='playing';
  nextRound();
}

function endGame(){
  state='gameover';
  saveScore();
  if(player.score>0)sfxVictory();
  else sfxDefeat();
}

function getEnding(){
  const pct=player.correct/(totalQuizzes||1);
  const wr=player.wins/(player.battles||1);
  const s=player.score;
  if(s>=8000&&pct>=0.9)return{name:'Type Master',desc:'You have achieved total mastery over the type chart. Legendary!',color:'#ff0'};
  if(s>=5000&&pct>=0.75)return{name:'Type Champion',desc:'Your elemental knowledge is formidable. Champions bow before you.',color:'#f80'};
  if(s>=3000)return{name:'Type Expert',desc:'Strong understanding of type matchups. Keep battling!',color:'#4af'};
  if(s>=1500)return{name:'Type Student',desc:'You\'re learning the type chart well. Practice makes perfect.',color:'#4f4'};
  return{name:'Type Novice',desc:'The type chart is vast. Study and try again!',color:'#aaa'};
}

// Particles
function spawnParticles(px,py,count,color){
  for(let i=0;i<count;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=Math.random()*4+1;
    particles.push({
      x:px,y:py,
      vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,
      life:60+Math.random()*30,
      maxLife:90,
      r:Math.random()*4+2,
      color
    });
  }
}

function triggerShake(intensity){shakeDur=12;shakeX=(Math.random()-0.5)*intensity;shakeY=(Math.random()-0.5)*intensity}

// Draw helpers
function drawRoundedRect(x,y,w,h,r){
  X.beginPath();
  X.moveTo(x+r,y);X.lineTo(x+w-r,y);X.arcTo(x+w,y,x+w,y+r,r);
  X.lineTo(x+w,y+h-r);X.arcTo(x+w,y+h,x+w-r,y+h,r);
  X.lineTo(x+r,y+h);X.arcTo(x,y+h,x,y+h-r,r);
  X.lineTo(x,y+r);X.arcTo(x,y,x+r,y,r);
  X.closePath();
}

function drawTypeIcon(x,y,type,size){
  const c=TYPE_COLORS[type]||'#888';
  X.save();
  X.fillStyle=c;
  X.shadowColor=c;
  X.shadowBlur=size*0.4;
  X.beginPath();
  X.arc(x,y,size,0,Math.PI*2);
  X.fill();
  X.shadowBlur=0;
  X.fillStyle='#fff';
  X.font=`bold ${Math.floor(size*0.8)}px sans-serif`;
  X.textAlign='center';X.textBaseline='middle';
  X.fillText(type.charAt(0),x,y);
  X.restore();
}

function drawCreature(x,y,creature,hp,maxHp,size,flipX){
  const c=TYPE_COLORS[creature.types[0]]||'#888';
  X.save();
  X.translate(x,y);
  if(flipX)X.scale(-1,1);

  // Body
  X.fillStyle=c;
  X.shadowColor=c;X.shadowBlur=15;
  X.beginPath();
  // Creature shape based on sprite type
  const s=size;
  if(creature.sprite==='fire'||creature.sprite==='dragon'){
    // Spiky shape
    X.moveTo(0,-s);X.lineTo(s*0.6,-s*0.3);X.lineTo(s*0.8,s*0.2);
    X.lineTo(s*0.4,s);X.lineTo(-s*0.4,s);X.lineTo(-s*0.8,s*0.2);
    X.lineTo(-s*0.6,-s*0.3);
  } else if(creature.sprite==='water'||creature.sprite==='ice'){
    // Rounded shape
    X.ellipse(0,0,s*0.7,s,0,0,Math.PI*2);
  } else if(creature.sprite==='grass'||creature.sprite==='bug'){
    // Leaf shape
    X.moveTo(0,-s);X.quadraticCurveTo(s,0,0,s);X.quadraticCurveTo(-s,0,0,-s);
  } else if(creature.sprite==='ghost'||creature.sprite==='psychic'){
    // Ghost shape
    X.moveTo(-s*0.6,-s);X.quadraticCurveTo(0,-s*1.3,s*0.6,-s);
    X.lineTo(s*0.6,s*0.5);X.quadraticCurveTo(s*0.3,s,0,s*0.5);
    X.quadraticCurveTo(-s*0.3,s,-s*0.6,s*0.5);
  } else if(creature.sprite==='fighting'||creature.sprite==='rock'||creature.sprite==='ground'){
    // Bulky shape
    X.moveTo(0,-s);X.lineTo(s*0.8,-s*0.5);X.lineTo(s,s*0.3);
    X.lineTo(s*0.5,s);X.lineTo(-s*0.5,s);X.lineTo(-s,s*0.3);
    X.lineTo(-s*0.8,-s*0.5);
  } else if(creature.sprite==='steel'||creature.sprite==='dark'){
    // Angular shape
    X.moveTo(0,-s);X.lineTo(s,-s*0.3);X.lineTo(s*0.7,s);
    X.lineTo(-s*0.7,s);X.lineTo(-s,-s*0.3);
  } else {
    // Default circle
    X.arc(0,0,s*0.8,0,Math.PI*2);
  }
  X.closePath();
  X.fill();
  X.shadowBlur=0;

  // Eyes
  X.fillStyle='#fff';
  X.beginPath();X.arc(-s*0.2,-s*0.3,s*0.15,0,Math.PI*2);X.fill();
  X.beginPath();X.arc(s*0.2,-s*0.3,s*0.15,0,Math.PI*2);X.fill();
  X.fillStyle='#111';
  X.beginPath();X.arc(-s*0.15,-s*0.28,s*0.07,0,Math.PI*2);X.fill();
  X.beginPath();X.arc(s*0.25,-s*0.28,s*0.07,0,Math.PI*2);X.fill();

  X.restore();

  // HP bar
  const barW=size*2;
  const barH=8;
  const barX=x-barW/2;
  const barY=y-size-20;
  X.fillStyle='#333';
  drawRoundedRect(barX,barY,barW,barH,4);X.fill();
  const hpPct=hp/maxHp;
  X.fillStyle=hpPct>0.5?'#4f4':hpPct>0.25?'#ff0':'#f44';
  drawRoundedRect(barX,barY,barW*hpPct,barH,4);X.fill();

  // Name
  X.fillStyle='#fff';
  X.font='bold 14px sans-serif';
  X.textAlign='center';
  X.fillText(creature.name,x,barY-8);

  // Types
  const tw=creature.types.length*30;
  creature.types.forEach((t,i)=>{
    drawTypeIcon(x-tw/2+15+i*30,y+size+20,t,12);
  });
}

function drawHpBar(x,y,w,h,hp,maxHp,label){
  X.fillStyle='#222';
  drawRoundedRect(x,y,w,h,h/2);X.fill();
  const pct=hp/maxHp;
  const col=pct>0.6?'#4f4':pct>0.3?'#ff0':'#f44';
  X.fillStyle=col;
  drawRoundedRect(x,y,w*pct,h,h/2);X.fill();
  X.strokeStyle='#555';X.lineWidth=1;
  drawRoundedRect(x,y,w,h,h/2);X.stroke();
  X.fillStyle='#fff';X.font='bold 12px sans-serif';X.textAlign='left';
  X.fillText(`${label}: ${hp}/${maxHp}`,x+8,y+h/2+4);
}

// Main loop
let lastTime=0;
function gameLoop(ts){
  const dt=Math.min((ts-lastTime)/16.67,3);
  lastTime=ts;

  // Update
  update(dt);

  // Draw
  X.save();
  if(shakeDur>0){
    X.translate(shakeX,shakeY);
    shakeDur--;
    shakeX*=-0.8;shakeY*=-0.8;
  }
  draw();
  X.restore();

  requestAnimationFrame(gameLoop);
}

function update(dt){
  // BG particles
  for(const p of bgParticles){
    p.x+=p.vx*dt;p.y+=p.vy*dt;
    if(p.x<0)p.x=W;if(p.x>W)p.x=0;
    if(p.y<0)p.y=H;if(p.y>H)p.y=0;
  }
  // Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx*dt;p.y+=p.vy*dt;
    p.vy+=0.1*dt;
    p.life-=dt;
    if(p.life<=0)particles.splice(i,1);
  }
  // Flash
  if(flashAlpha>0)flashAlpha-=0.02*dt;
  // Combo timer
  if(comboTimer>0)comboTimer-=dt;
  // Battle anim
  if(state==='battle')battleAnim+=0.03*dt;
  // Result timer
  if(showingResult&&resultTimer>0){resultTimer-=dt;if(resultTimer<=0)resultTimer=0}
}

function draw(){
  // Background
  const grad=X.createLinearGradient(0,0,W,H);
  grad.addColorStop(0,'#0a0a1a');
  grad.addColorStop(0.5,'#1a0a2a');
  grad.addColorStop(1,'#0a1a2a');
  X.fillStyle=grad;
  X.fillRect(0,0,W,H);

  // BG particles
  for(const p of bgParticles){
    X.globalAlpha=p.alpha;
    X.fillStyle=TYPE_COLORS[p.type]||'#fff';
    X.beginPath();X.arc(p.x,p.y,p.r,0,Math.PI*2);X.fill();
  }
  X.globalAlpha=1;

  if(state==='menu')drawMenu();
  else if(state==='quiz')drawQuiz();
  else if(state==='battle')drawBattle();
  else if(state==='paused')drawPause();
  else if(state==='gameover')drawGameover();

  // Particles
  for(const p of particles){
    const alpha=p.life/p.maxLife;
    X.globalAlpha=alpha;
    X.fillStyle=p.color;
    X.beginPath();X.arc(p.x,p.y,p.r*alpha,0,Math.PI*2);X.fill();
  }
  X.globalAlpha=1;

  // Flash overlay
  if(flashAlpha>0){
    X.fillStyle=`rgba(255,0,0,${flashAlpha})`;
    X.fillRect(0,0,W,H);
  }

  // HUD (during gameplay)
  if(state==='quiz'||state==='battle'){
    drawHUD();
  }
}

function drawMenu(){
  // Title
  X.fillStyle='#fff';
  X.font=`bold ${Math.min(W*0.08,60)}px sans-serif`;
  X.textAlign='center';
  X.fillText('TYPE CLASH ARENA',W/2,H*0.2);

  // Subtitle
  X.font=`${Math.min(W*0.03,20)}px sans-serif`;
  X.fillStyle='#aaa';
  X.fillText('Master the elemental type chart through quiz and battle!',W/2,H*0.28);

  // Rotating type icons
  const t=Date.now()*0.001;
  for(let i=0;i<18;i++){
    const angle=(i/18)*Math.PI*2+t*0.3;
    const rx=Math.min(W,H)*0.15;
    const tx=W/2+Math.cos(angle)*rx;
    const ty=H*0.38+Math.sin(angle)*rx*0.5;
    drawTypeIcon(tx,ty,TYPES[i],10);
  }

  // Difficulty selection
  X.fillStyle='#ccc';
  X.font='bold 18px sans-serif';
  X.fillText('SELECT DIFFICULTY',W/2,H*0.47);

  const bw=160,bh=50,gap=20;
  const totalBW=3*(bw+gap)-gap;
  const sx=W/2-totalBW/2;
  const by=H*0.5;
  const diffColors=['#4f4','#ff0','#f44'];
  for(let i=0;i<3;i++){
    const bx=sx+i*(bw+gap);
    const sel=menuSel===i;
    X.fillStyle=sel?diffColors[i]:'#333';
    drawRoundedRect(bx,by,bw,bh,10);X.fill();
    if(sel){X.strokeStyle='#fff';X.lineWidth=2;drawRoundedRect(bx,by,bw,bh,10);X.stroke()}
    X.fillStyle=sel?'#000':'#888';
    X.font=`bold 18px sans-serif`;
    X.textAlign='center';
    X.fillText(DIFF_NAMES[i],bx+bw/2,by+bh/2+6);
  }

  // Start
  const startX=W/2-100,startY=H*0.65;
  X.fillStyle='#4af';
  drawRoundedRect(startX,startY,200,55,12);X.fill();
  X.fillStyle='#fff';X.font='bold 22px sans-serif';
  X.fillText('START GAME',W/2,startY+33);

  X.font='14px sans-serif';X.fillStyle='#666';
  X.fillText('Arrow keys to select, Enter to start',W/2,H*0.76);
  X.fillText('ESC to pause during game',W/2,H*0.80);

  // High scores
  if(highScores.length>0){
    X.fillStyle='#888';X.font='bold 16px sans-serif';
    X.fillText('HIGH SCORES',W/2,H*0.86);
    X.font='13px monospace';
    for(let i=0;i<Math.min(3,highScores.length);i++){
      const hs=highScores[i];
      X.fillStyle='#666';
      X.fillText(`${i+1}. ${hs.score} pts (Lv.${hs.level}) [${hs.diff}] ${hs.date}`,W/2,H*0.90+i*18);
    }
  }
}

function drawHUD(){
  // Top bar
  X.fillStyle='rgba(0,0,0,0.7)';
  X.fillRect(0,0,W,50);

  // HP
  drawHpBar(10,10,200,25,player.hp,player.maxHp,'HP');

  // Level & XP
  X.fillStyle='#fff';X.font='bold 14px sans-serif';X.textAlign='left';
  X.fillText(`Lv.${player.level}`,220,28);
  const xpNeeded=player.level*100;
  const xpPct=player.xp/xpNeeded;
  X.fillStyle='#333';
  drawRoundedRect(270,15,80,16,8);X.fill();
  X.fillStyle='#a4f';
  drawRoundedRect(270,15,80*xpPct,16,8);X.fill();
  X.fillStyle='#fff';X.font='10px sans-serif';
  X.fillText(`XP:${player.xp}/${xpNeeded}`,275,27);

  // Score
  X.textAlign='center';X.font='bold 18px sans-serif';
  X.fillStyle='#ff0';
  X.fillText(`Score: ${player.score}`,W/2,32);

  // Streak & combo
  if(player.streak>=3){
    X.fillStyle=comboMult>=4?'#f0f':comboMult>=3?'#ff0':comboMult>=2?'#4f4':'#fff';
    X.font='bold 14px sans-serif';
    X.fillText(`Streak: ${player.streak} (x${comboMult})`,W/2,47);
  }

  // Round
  X.textAlign='right';X.font='bold 14px sans-serif';X.fillStyle='#aaa';
  X.fillText(`Round ${round}/${maxRounds}`,W-20,20);
  X.fillText(`${player.correct}/${totalQuizzes} correct`,W-20,38);
  if(bossRound){
    X.fillStyle='#f44';X.font='bold 16px sans-serif';
    X.fillText('BOSS ROUND!',W-20,55);
  }
}

function drawQuiz(){
  if(!quiz)return;
  // Question box
  const qBoxY=H*0.15;
  const qBoxH=H*0.35;
  X.fillStyle='rgba(20,20,40,0.9)';
  drawRoundedRect(W*0.1,qBoxY,W*0.8,qBoxH,15);X.fill();
  X.strokeStyle='#4af';X.lineWidth=2;
  drawRoundedRect(W*0.1,qBoxY,W*0.8,qBoxH,15);X.stroke();

  // Round label
  X.fillStyle=bossRound?'#f44':'#4af';
  X.font=`bold 16px sans-serif`;X.textAlign='center';
  X.fillText(bossRound?'BOSS QUIZ':'TYPE QUIZ',W/2,qBoxY+30);

  // Question
  X.fillStyle='#fff';
  X.font=`bold ${Math.min(W*0.035,22)}px sans-serif`;
  // Word wrap
  const words=quiz.question.split(' ');
  let line='';const lines=[];const maxW=W*0.7;
  for(const w of words){
    const test=line+w+' ';
    if(X.measureText(test).width>maxW&&line){lines.push(line.trim());line=w+' '}
    else line=test;
  }
  if(line)lines.push(line.trim());
  lines.forEach((l,i)=>X.fillText(l,W/2,qBoxY+70+i*28));

  // Type icons for the question
  if(quiz.atkType&&quiz.defType){
    const iconY=qBoxY+qBoxH-50;
    drawTypeIcon(W/2-60,iconY,quiz.atkType,20);
    X.fillStyle='#fff';X.font='bold 24px sans-serif';
    X.fillText('vs',W/2,iconY+5);
    drawTypeIcon(W/2+60,iconY,quiz.defType,20);
  }

  // Answer buttons
  const aw=Math.min(W*0.5,300),ah=50,gap=12;
  const sy=H*0.58;
  for(let i=0;i<quiz.options.length;i++){
    const ay=sy+i*(ah+gap);
    const ax=W/2-aw/2;
    let bgCol='rgba(40,40,80,0.9)';
    let txtCol='#fff';
    if(showingResult){
      if(i===quiz.correct){bgCol='rgba(0,180,0,0.8)';txtCol='#fff'}
      else{bgCol='rgba(80,30,30,0.6)';txtCol='#888'}
    }
    X.fillStyle=bgCol;
    drawRoundedRect(ax,ay,aw,ah,10);X.fill();
    X.strokeStyle=showingResult&&i===quiz.correct?'#4f4':'#555';X.lineWidth=1;
    drawRoundedRect(ax,ay,aw,ah,10);X.stroke();

    // Option label with type icon if it's a type name
    X.fillStyle=txtCol;X.font='bold 16px sans-serif';X.textAlign='center';
    const label=`${i+1}. ${quiz.options[i]}`;
    if(TYPE_COLORS[quiz.options[i]]){
      drawTypeIcon(ax+25,ay+ah/2,quiz.options[i],14);
      X.fillStyle=txtCol;X.font='bold 16px sans-serif';X.textAlign='left';
      X.fillText(label,ax+50,ay+ah/2+5);
    } else {
      X.fillText(label,W/2,ay+ah/2+5);
    }
  }

  // Result display
  if(showingResult){
    const ry=sy+quiz.options.length*(ah+gap)+10;
    X.fillStyle=resultColor;
    X.font=`bold ${Math.min(W*0.035,20)}px sans-serif`;
    X.textAlign='center';
    // Word wrap result
    const rWords=resultText.split(' ');
    let rLine='';const rLines=[];
    for(const rw of rWords){
      const test=rLine+rw+' ';
      if(X.measureText(test).width>W*0.8&&rLine){rLines.push(rLine.trim());rLine=rw+' '}
      else rLine=test;
    }
    if(rLine)rLines.push(rLine.trim());
    rLines.forEach((l,i)=>X.fillText(l,W/2,ry+i*22));

    X.fillStyle='#888';X.font='14px sans-serif';
    X.fillText('Press ENTER or tap to continue',W/2,ry+rLines.length*22+20);
  }
}

function drawBattle(){
  if(!enemyCreature||!playerCreature)return;

  // Battle arena
  X.fillStyle='rgba(20,20,40,0.5)';
  X.fillRect(0,50,W,H-50);

  // Arena floor
  const floorY=H*0.6;
  X.fillStyle='rgba(100,100,200,0.1)';
  X.beginPath();X.ellipse(W/2,floorY,W*0.4,60,0,0,Math.PI*2);X.fill();

  // Enemy creature
  const enemyBob=Math.sin(battleAnim*2)*5;
  drawCreature(W*0.65,H*0.3+enemyBob,enemyCreature,enemyHp,enemyMaxHp,40,false);

  // Player creature
  const playerBob=Math.sin(battleAnim*2+1)*4;
  drawCreature(W*0.3,H*0.5+playerBob,playerCreature,playerBattleHp,playerBattleMaxHp,45,true);

  // VS text
  X.fillStyle='rgba(255,255,255,0.2)';
  X.font='bold 40px sans-serif';X.textAlign='center';
  X.fillText('VS',W/2,H*0.4);

  // Battle log
  X.fillStyle='rgba(0,0,0,0.7)';
  drawRoundedRect(W*0.1,H*0.62,W*0.8,80,8);X.fill();
  X.font='14px sans-serif';X.textAlign='left';
  battleLog.forEach((msg,i)=>{
    X.fillStyle=i===0?'#fff':'#888';
    X.fillText(msg,W*0.13,H*0.65+15+i*18);
  });

  if(!battleOver){
    // Attack options
    X.fillStyle='#ccc';X.font='bold 14px sans-serif';X.textAlign='center';
    X.fillText(battleTurn==='player'?'Choose your attack type:':'Enemy attacking...',W/2,H*0.72-5);

    if(battleTurn==='player'){
      const aw=200,ah=45,gap=10;
      const sy=H*0.73;
      for(let i=0;i<attackOptions.length;i++){
        const col=i%2,row=Math.floor(i/2);
        const ax=W/2-210+col*210;
        const ay=sy+row*(ah+gap);
        const sel=attackSel===i;
        const tc=TYPE_COLORS[attackOptions[i]]||'#888';
        X.fillStyle=sel?tc:'rgba(40,40,60,0.9)';
        drawRoundedRect(ax,ay,aw,ah,8);X.fill();
        if(sel){X.strokeStyle='#fff';X.lineWidth=2;drawRoundedRect(ax,ay,aw,ah,8);X.stroke()}

        drawTypeIcon(ax+25,ay+ah/2,attackOptions[i],14);
        X.fillStyle=sel?'#fff':'#aaa';X.font='bold 15px sans-serif';X.textAlign='left';
        X.fillText(attackOptions[i],ax+50,ay+ah/2+5);

        // Show effectiveness hint
        let totalE=0;
        for(const dt of enemyCreature.types)totalE+=getEff(attackOptions[i],dt);
        const effC=totalE>0?'#4f4':totalE<0?'#f66':'#888';
        X.fillStyle=effC;X.font='11px sans-serif';
        const effT=totalE>0?'Super!':totalE<-1?'Immune':totalE<0?'Resist':'Normal';
        X.fillText(effT,ax+aw-50,ay+ah/2+5);
      }
    }
  } else {
    // Battle over message
    X.fillStyle='rgba(0,0,0,0.5)';
    X.fillRect(0,H*0.72,W,60);
    X.fillStyle=enemyHp<=0?'#4f4':'#f44';
    X.font='bold 24px sans-serif';X.textAlign='center';
    X.fillText(enemyHp<=0?'VICTORY!':'DEFEATED!',W/2,H*0.72+35);
    X.fillStyle='#aaa';X.font='14px sans-serif';
    X.fillText('Press ENTER or tap to continue',W/2,H*0.72+55);
  }
}

function drawPause(){
  // Draw game behind
  if(roundPhase==='quiz')drawQuiz();
  else if(roundPhase==='battle')drawBattle();
  drawHUD();

  // Overlay
  X.fillStyle='rgba(0,0,0,0.7)';
  X.fillRect(0,0,W,H);

  X.fillStyle='#fff';X.font='bold 36px sans-serif';X.textAlign='center';
  X.fillText('PAUSED',W/2,H/2-80);

  const items=['Resume','Restart','Quit'];
  const bw=200,bh=50;
  const sy=H/2-40;
  items.forEach((item,i)=>{
    const iy=sy+i*60;
    const sel=pauseMenuSel===i;
    X.fillStyle=sel?'#4af':'#333';
    drawRoundedRect(W/2-bw/2,iy,bw,bh,10);X.fill();
    X.fillStyle=sel?'#fff':'#888';
    X.font='bold 18px sans-serif';
    X.fillText(item,W/2,iy+bh/2+6);
  });

  X.fillStyle='#666';X.font='14px sans-serif';
  X.fillText('Arrow keys + Enter, or tap',W/2,sy+items.length*60+20);
}

function drawGameover(){
  X.fillStyle='rgba(0,0,0,0.85)';
  X.fillRect(0,0,W,H);

  const ending=getEnding();

  // Title
  X.fillStyle=ending.color;
  X.font=`bold ${Math.min(W*0.07,48)}px sans-serif`;
  X.textAlign='center';
  X.fillText(ending.name,W/2,H*0.15);

  X.fillStyle='#ccc';X.font='18px sans-serif';
  X.fillText(ending.desc,W/2,H*0.22);

  // Stats box
  X.fillStyle='rgba(30,30,60,0.9)';
  drawRoundedRect(W/2-200,H*0.28,400,H*0.42,15);X.fill();
  X.strokeStyle='#4af';X.lineWidth=1;
  drawRoundedRect(W/2-200,H*0.28,400,H*0.42,15);X.stroke();

  const stats=[
    ['Final Score',player.score.toString(),'#ff0'],
    ['Level',player.level.toString(),'#a4f'],
    ['Rounds Survived',`${round}/${maxRounds}`,'#4af'],
    ['Quiz Accuracy',`${player.correct}/${totalQuizzes} (${totalQuizzes>0?Math.floor(player.correct/totalQuizzes*100):0}%)`,'#4f4'],
    ['Battle Record',`${player.wins}/${player.battles}`,'#f80'],
    ['Best Streak',player.bestStreak.toString(),'#ff0'],
    ['Difficulty',DIFF_NAMES[difficulty],['#4f4','#ff0','#f44'][difficulty]],
  ];
  const sStartY=H*0.33;
  stats.forEach((s,i)=>{
    X.fillStyle='#888';X.font='14px sans-serif';X.textAlign='left';
    X.fillText(s[0],W/2-180,sStartY+i*28);
    X.fillStyle=s[2];X.font='bold 16px sans-serif';X.textAlign='right';
    X.fillText(s[1],W/2+180,sStartY+i*28);
  });

  // Button
  const bw=180,bh=50;
  const bx=W/2-bw/2,by=H*0.78;
  X.fillStyle='#4af';
  drawRoundedRect(bx,by,bw,bh,10);X.fill();
  X.fillStyle='#fff';X.font='bold 18px sans-serif';X.textAlign='center';
  X.fillText('MAIN MENU',W/2,by+bh/2+6);

  X.fillStyle='#666';X.font='14px sans-serif';
  X.fillText('Press ENTER or R to return',W/2,H*0.90);
}

// Start
requestAnimationFrame(gameLoop);
</script>
</body>
</html>