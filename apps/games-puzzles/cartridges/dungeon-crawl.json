{
  "console": "dungeon-crawl",
  "name": "Dungeon Crawl",
  "year": 2026,
  "icon": "üó°Ô∏è",
  "theme": {
    "bg": "#0a0a12",
    "accent": "#ff9944"
  },
  "render": {
    "width": 256,
    "height": 224,
    "scanlines": false,
    "scanlineAlpha": 0.02
  },
  "audio": {
    "type": "synth",
    "channels": 4
  },
  "games": [
    {
      "id": "dungeon-crawl",
      "name": "Dungeon Crawl: Depths of Ruin",
      "icon": "üó°Ô∏è",
      "desc": "Procedural roguelike dungeon crawler with permadeath, loot, and monsters. Descend as deep as you dare.",
      "code": "if (mode === 'init') {\nG.T_WALL = 0; G.T_FLOOR = 1; G.T_DOOR = 2; G.T_STAIR = 3;\nG.T_CHEST = 4; G.T_TRAP = 5;\nG.MW = 32; G.MH = 28; G.TS = 8;\nG.floor = 1;\nG.turn = 0;\nG.phase = 'play';\nG.msg = 'You descend into the depths...';\nG.msgTimer = 120;\nG.shake = 0;\nG.flash = 0;\nG.flashC = '#fff';\nG.kcd = 0;\nG.particles = [];\nG.fov = [];\nG.seen = [];\nG.selIdx = 0;\nG.p = {\nx: 0, y: 0,\nhp: 30, maxHp: 30,\natk: 5, def: 1,\nxp: 0, lvl: 1, xpNext: 12,\ngold: 0,\ninv: [],\nweapon: null,\narmor: null,\nkills: 0,\nmaxFloor: 1\n};\nG.weapons = [\n{ name: 'Rusty Dagger', stat: 2, icon: '/' },\n{ name: 'Short Sword', stat: 4, icon: '‚Ä†' },\n{ name: 'Battle Axe', stat: 6, icon: 'P' },\n{ name: 'War Hammer', stat: 8, icon: 'T' },\n{ name: 'Flame Blade', stat: 11, icon: '!' },\n{ name: 'Doom Cleaver', stat: 14, icon: 'X' }\n];\nG.armors = [\n{ name: 'Leather', stat: 1, icon: '[' },\n{ name: 'Chain Mail', stat: 2, icon: '{' },\n{ name: 'Plate Armor', stat: 4, icon: '#' },\n{ name: 'Dragon Scale', stat: 6, icon: '&' },\n{ name: 'Void Armor', stat: 9, icon: '@' }\n];\nG.potions = [\n{ name: 'Heal Potion', type: 'heal', stat: 15, icon: '!' },\n{ name: 'Greater Heal', type: 'heal', stat: 30, icon: '!' },\n{ name: 'Str Potion', type: 'buff_atk', stat: 2, icon: '!' },\n{ name: 'Iron Skin', type: 'buff_def', stat: 2, icon: '!' }\n];\nG.monsterTable = [\n{ name: 'Rat', icon: 'r', hp: 6, atk: 2, def: 0, xp: 3, gold: 1, color: '#886644' },\n{ name: 'Bat', icon: 'b', hp: 4, atk: 3, def: 0, xp: 2, gold: 1, color: '#8866aa' },\n{ name: 'Goblin', icon: 'g', hp: 10, atk: 4, def: 1, xp: 5, gold: 3, color: '#44aa44' },\n{ name: 'Skeleton', icon: 's', hp: 14, atk: 5, def: 2, xp: 7, gold: 4, color: '#ccccaa' },\n{ name: 'Orc', icon: 'o', hp: 20, atk: 7, def: 3, xp: 10, gold: 6, color: '#448844' },\n{ name: 'Wraith', icon: 'w', hp: 16, atk: 9, def: 1, xp: 12, gold: 5, color: '#6666cc' },\n{ name: 'Troll', icon: 'T', hp: 35, atk: 10, def: 4, xp: 18, gold: 10, color: '#668844' },\n{ name: 'Dragon', icon: 'D', hp: 60, atk: 15, def: 6, xp: 40, gold: 25, color: '#ff4444' }\n];\nG.map = [];\nG.monsters = [];\nG.items = [];\nG.genFloor = function(floor) {\nG.map = [];\nG.monsters = [];\nG.items = [];\nG.fov = [];\nG.seen = [];\nfor (var y = 0; y < G.MH; y++) {\nG.map[y] = [];\nG.fov[y] = [];\nG.seen[y] = [];\nfor (var x = 0; x < G.MW; x++) {\nG.map[y][x] = G.T_WALL;\nG.fov[y][x] = false;\nG.seen[y][x] = false;\n}\n}\nvar rooms = [];\nvar numRooms = 6 + Math.floor(Math.random() * 4) + Math.floor(floor * 0.5);\nvar attempts = 0;\nwhile (rooms.length < numRooms && attempts < 200) {\nattempts++;\nvar rw = 3 + Math.floor(Math.random() * 5);\nvar rh = 3 + Math.floor(Math.random() * 4);\nvar rx = 1 + Math.floor(Math.random() * (G.MW - rw - 2));\nvar ry = 1 + Math.floor(Math.random() * (G.MH - rh - 2));\nvar overlap = false;\nfor (var i = 0; i < rooms.length; i++) {\nvar r = rooms[i];\nif (rx - 1 < r.x + r.w && rx + rw + 1 > r.x && ry - 1 < r.y + r.h && ry + rh + 1 > r.y) {\noverlap = true; break;\n}\n}\nif (!overlap) {\nrooms.push({ x: rx, y: ry, w: rw, h: rh, cx: Math.floor(rx + rw / 2), cy: Math.floor(ry + rh / 2) });\nfor (var dy = 0; dy < rh; dy++) {\nfor (var dx = 0; dx < rw; dx++) {\nG.map[ry + dy][rx + dx] = G.T_FLOOR;\n}\n}\n}\n}\nfor (var i = 1; i < rooms.length; i++) {\nvar a = rooms[i - 1], b = rooms[i];\nvar cx = a.cx, cy = a.cy;\nvar tx = b.cx, ty = b.cy;\nif (Math.random() < 0.5) {\nvar sx = cx < tx ? 1 : -1;\nwhile (cx !== tx) { G.map[cy][cx] = G.T_FLOOR; cx += sx; }\nvar sy = cy < ty ? 1 : -1;\nwhile (cy !== ty) { G.map[cy][cx] = G.T_FLOOR; cy += sy; }\n} else {\nvar sy = cy < ty ? 1 : -1;\nwhile (cy !== ty) { G.map[cy][cx] = G.T_FLOOR; cy += sy; }\nvar sx = cx < tx ? 1 : -1;\nwhile (cx !== tx) { G.map[cy][cx] = G.T_FLOOR; cx += sx; }\n}\nG.map[ty][tx] = G.T_FLOOR;\n}\nfor (var y = 1; y < G.MH - 1; y++) {\nfor (var x = 1; x < G.MW - 1; x++) {\nif (G.map[y][x] !== G.T_FLOOR) continue;\nif (G.map[y-1][x] === G.T_WALL && G.map[y+1][x] === G.T_WALL &&\nG.map[y][x-1] === G.T_FLOOR && G.map[y][x+1] === G.T_FLOOR) {\nif (Math.random() < 0.25) G.map[y][x] = G.T_DOOR;\n}\nif (G.map[y][x-1] === G.T_WALL && G.map[y][x+1] === G.T_WALL &&\nG.map[y-1][x] === G.T_FLOOR && G.map[y+1][x] === G.T_FLOOR) {\nif (Math.random() < 0.25) G.map[y][x] = G.T_DOOR;\n}\n}\n}\nG.p.x = rooms[0].cx;\nG.p.y = rooms[0].cy;\nvar lastRoom = rooms[rooms.length - 1];\nG.map[lastRoom.cy][lastRoom.cx] = G.T_STAIR;\nvar numChests = 1 + Math.floor(Math.random() * 2) + (floor % 3 === 0 ? 1 : 0);\nfor (var c = 0; c < numChests; c++) {\nvar rIdx = 1 + Math.floor(Math.random() * (rooms.length - 2));\nvar rm = rooms[rIdx];\nvar cx = rm.x + Math.floor(Math.random() * rm.w);\nvar cy = rm.y + Math.floor(Math.random() * rm.h);\nif (G.map[cy][cx] === G.T_FLOOR) G.map[cy][cx] = G.T_CHEST;\n}\nif (floor >= 3) {\nvar numTraps = Math.floor(floor / 2);\nfor (var t = 0; t < numTraps; t++) {\nvar rIdx = 1 + Math.floor(Math.random() * (rooms.length - 1));\nvar rm = rooms[rIdx];\nvar tx = rm.x + Math.floor(Math.random() * rm.w);\nvar ty = rm.y + Math.floor(Math.random() * rm.h);\nif (G.map[ty][tx] === G.T_FLOOR) G.map[ty][tx] = G.T_TRAP;\n}\n}\nvar numMons = 4 + floor * 2 + Math.floor(Math.random() * 3);\nvar maxTier = Math.min(G.monsterTable.length - 1, Math.floor(floor / 2) + 1);\nfor (var m = 0; m < numMons; m++) {\nvar rIdx = 1 + Math.floor(Math.random() * (rooms.length - 1));\nvar rm = rooms[rIdx];\nvar mx = rm.x + Math.floor(Math.random() * rm.w);\nvar my = rm.y + Math.floor(Math.random() * rm.h);\nif (mx === G.p.x && my === G.p.y) continue;\nif (G.map[my][mx] === G.T_WALL) continue;\nvar tier = Math.floor(Math.random() * (maxTier + 1));\nif (Math.random() < 0.3) tier = Math.min(tier + 1, maxTier);\nvar tmpl = G.monsterTable[tier];\nvar scale = 1 + (floor - 1) * 0.15;\nG.monsters.push({\nx: mx, y: my,\nname: tmpl.name, icon: tmpl.icon, color: tmpl.color,\nhp: Math.ceil(tmpl.hp * scale), maxHp: Math.ceil(tmpl.hp * scale),\natk: Math.ceil(tmpl.atk * scale), def: Math.floor(tmpl.def * scale),\nxp: Math.ceil(tmpl.xp * scale), gold: Math.ceil(tmpl.gold * scale),\nawake: false,\nlastSawX: -1, lastSawY: -1\n});\n}\nvar numDrops = 1 + Math.floor(Math.random() * 2);\nfor (var d = 0; d < numDrops; d++) {\nvar rIdx = 1 + Math.floor(Math.random() * (rooms.length - 1));\nvar rm = rooms[rIdx];\nvar ix = rm.x + Math.floor(Math.random() * rm.w);\nvar iy = rm.y + Math.floor(Math.random() * rm.h);\nif (G.map[iy][ix] === G.T_FLOOR) {\nvar item = G.genLoot(floor);\nG.items.push({ x: ix, y: iy, item: item });\n}\n}\n};\nG.genLoot = function(floor) {\nvar r = Math.random();\nif (r < 0.35) {\nvar p = G.potions[Math.floor(Math.random() * Math.min(G.potions.length, 2 + Math.floor(floor / 3)))];\nreturn { name: p.name, type: p.type, stat: p.stat, icon: p.icon, category: 'potion' };\n} else if (r < 0.65) {\nvar maxW = Math.min(G.weapons.length, 1 + Math.floor(floor / 2));\nvar w = G.weapons[Math.floor(Math.random() * maxW)];\nreturn { name: w.name, type: 'weapon', stat: w.stat, icon: w.icon, category: 'weapon' };\n} else if (r < 0.9) {\nvar maxA = Math.min(G.armors.length, 1 + Math.floor(floor / 2));\nvar a = G.armors[Math.floor(Math.random() * maxA)];\nreturn { name: a.name, type: 'armor', stat: a.stat, icon: a.icon, category: 'armor' };\n} else {\nvar amt = 5 + Math.floor(Math.random() * floor * 5);\nreturn { name: amt + ' Gold', type: 'gold', stat: amt, icon: '$', category: 'gold' };\n}\n};\nG.calcFOV = function() {\nfor (var y = 0; y < G.MH; y++)\nfor (var x = 0; x < G.MW; x++) G.fov[y][x] = false;\nvar radius = 6;\nvar steps = 72;\nfor (var i = 0; i < steps; i++) {\nvar angle = (i / steps) * Math.PI * 2;\nvar dx = Math.cos(angle);\nvar dy = Math.sin(angle);\nvar cx = G.p.x + 0.5;\nvar cy = G.p.y + 0.5;\nfor (var d = 0; d < radius; d++) {\nvar tx = Math.floor(cx);\nvar ty = Math.floor(cy);\nif (tx < 0 || tx >= G.MW || ty < 0 || ty >= G.MH) break;\nG.fov[ty][tx] = true;\nG.seen[ty][tx] = true;\nif (G.map[ty][tx] === G.T_WALL) break;\ncx += dx;\ncy += dy;\n}\n}\n};\nG.levelUp = function() {\nG.p.lvl++;\nG.p.maxHp += 5 + G.p.lvl;\nG.p.hp = G.p.maxHp;\nG.p.atk += 1;\nG.p.def += (G.p.lvl % 2 === 0) ? 1 : 0;\nG.p.xpNext = Math.ceil(G.p.xpNext * 1.6);\nG.p.xp = 0;\nG.msg = 'Level up! You are now level ' + G.p.lvl;\nG.msgTimer = 120;\nG.flash = 15; G.flashC = '#ffcc00';\nsnd.win();\nfor (var i = 0; i < 16; i++)\nG.particles.push({ x: G.p.x * G.TS + G.TS/2, y: G.p.y * G.TS + G.TS/2, vx: (Math.random()-0.5)*4, vy: (Math.random()-0.5)*4, life: 25, c: '#ffcc00', s: 2 });\n};\nG.genFloor(1);\nG.calcFOV();\n}\nif (mode === 'update') {\nG.kcd = Math.max(0, G.kcd - 1);\nG.shake = Math.max(0, G.shake - 0.5);\nG.flash = Math.max(0, G.flash - 1);\nG.msgTimer = Math.max(0, G.msgTimer - 1);\nG.particles = G.particles.filter(function(p) {\np.x += p.vx; p.y += p.vy; p.life--;\nreturn p.life > 0;\n});\nif (G.phase === 'dead') {\nif ((K(' ') || K('Enter')) && G.kcd <= 0) {\nG.floor = 1; G.turn = 0;\nG.p.hp = 30; G.p.maxHp = 30; G.p.atk = 5; G.p.def = 1;\nG.p.xp = 0; G.p.lvl = 1; G.p.xpNext = 12;\nG.p.gold = 0; G.p.inv = []; G.p.weapon = null; G.p.armor = null;\nG.p.kills = 0; G.p.maxFloor = 1;\nG.phase = 'play';\nG.genFloor(1);\nG.calcFOV();\nG.msg = 'You descend once more...';\nG.msgTimer = 120;\nG.kcd = 15;\n}\nreturn;\n}\nif (G.phase === 'victory') {\nif ((K(' ') || K('Enter')) && G.kcd <= 0) {\nG.floor = 1; G.turn = 0;\nG.p.hp = 30; G.p.maxHp = 30; G.p.atk = 5; G.p.def = 1;\nG.p.xp = 0; G.p.lvl = 1; G.p.xpNext = 12;\nG.p.gold = 0; G.p.inv = []; G.p.weapon = null; G.p.armor = null;\nG.p.kills = 0; G.p.maxFloor = 1;\nG.phase = 'play';\nG.genFloor(1);\nG.calcFOV();\nG.msg = 'A new adventure begins...';\nG.msgTimer = 120;\nG.kcd = 15;\n}\nreturn;\n}\nif (G.phase === 'inventory') {\nif ((K('i') || K('Escape')) && G.kcd <= 0) {\nG.phase = 'play'; G.kcd = 12; return;\n}\nif (G.p.inv.length === 0) return;\nif ((K('w') || K('ArrowUp')) && G.kcd <= 0) {\nG.selIdx = (G.selIdx + G.p.inv.length - 1) % G.p.inv.length; G.kcd = 8; snd.beep();\n}\nif ((K('s') || K('ArrowDown')) && G.kcd <= 0) {\nG.selIdx = (G.selIdx + 1) % G.p.inv.length; G.kcd = 8; snd.beep();\n}\nif ((K(' ') || K('Enter')) && G.kcd <= 0) {\nvar item = G.p.inv[G.selIdx];\nif (item.category === 'potion') {\nif (item.type === 'heal') {\nG.p.hp = Math.min(G.p.maxHp, G.p.hp + item.stat);\nG.msg = 'Healed ' + item.stat + ' HP';\n} else if (item.type === 'buff_atk') {\nG.p.atk += item.stat;\nG.msg = 'Attack +' + item.stat + '!';\n} else if (item.type === 'buff_def') {\nG.p.def += item.stat;\nG.msg = 'Defense +' + item.stat + '!';\n}\nG.p.inv.splice(G.selIdx, 1);\nG.flash = 8; G.flashC = '#44ff88';\nsnd.pickup();\n} else if (item.category === 'weapon') {\nif (G.p.weapon) G.p.inv.push(G.p.weapon);\nG.p.weapon = item;\nG.p.inv.splice(G.selIdx, 1);\nG.msg = 'Equipped ' + item.name;\nsnd.score();\n} else if (item.category === 'armor') {\nif (G.p.armor) G.p.inv.push(G.p.armor);\nG.p.armor = item;\nG.p.inv.splice(G.selIdx, 1);\nG.msg = 'Equipped ' + item.name;\nsnd.score();\n}\nG.msgTimer = 90;\nif (G.selIdx >= G.p.inv.length) G.selIdx = Math.max(0, G.p.inv.length - 1);\nG.kcd = 12;\n}\nif (K('d') && G.kcd <= 0 && G.p.inv.length > 0) {\nvar dropped = G.p.inv.splice(G.selIdx, 1)[0];\nG.items.push({ x: G.p.x, y: G.p.y, item: dropped });\nG.msg = 'Dropped ' + dropped.name;\nG.msgTimer = 60;\nif (G.selIdx >= G.p.inv.length) G.selIdx = Math.max(0, G.p.inv.length - 1);\nG.kcd = 12;\nsnd.beep();\n}\nreturn;\n}\nif (G.phase !== 'play') return;\nif (K('i') && G.kcd <= 0) {\nG.phase = 'inventory'; G.selIdx = 0; G.kcd = 12; snd.beep(); return;\n}\nvar moved = false;\nvar dx = 0, dy = 0;\nif ((K('w') || K('ArrowUp')) && G.kcd <= 0) { dy = -1; moved = true; }\nif ((K('s') || K('ArrowDown')) && G.kcd <= 0) { dy = 1; moved = true; }\nif ((K('a') || K('ArrowLeft')) && G.kcd <= 0) { dx = -1; moved = true; }\nif ((K('d') || K('ArrowRight')) && G.kcd <= 0) { dx = 1; moved = true; }\nif (K('.') && G.kcd <= 0) { moved = true; }\nif (!moved) return;\nG.kcd = 8;\nvar nx = G.p.x + dx;\nvar ny = G.p.y + dy;\nif (nx < 0 || nx >= G.MW || ny < 0 || ny >= G.MH) return;\nif (G.map[ny][nx] === G.T_WALL) return;\nvar target = null;\nfor (var i = 0; i < G.monsters.length; i++) {\nif (G.monsters[i].x === nx && G.monsters[i].y === ny) { target = G.monsters[i]; break; }\n}\nif (target) {\nvar pAtk = G.p.atk + (G.p.weapon ? G.p.weapon.stat : 0);\nvar dmg = Math.max(1, pAtk - target.def + Math.floor(Math.random() * 3) - 1);\ntarget.hp -= dmg;\nG.msg = 'Hit ' + target.name + ' for ' + dmg + ' dmg';\nG.msgTimer = 60;\nsnd.hit();\nG.shake = 3;\nfor (var i = 0; i < 6; i++)\nG.particles.push({ x: nx * G.TS + G.TS/2, y: ny * G.TS + G.TS/2, vx: (Math.random()-0.5)*3, vy: (Math.random()-0.5)*3, life: 15, c: '#cc2222', s: 2 });\nif (target.hp <= 0) {\nG.p.xp += target.xp;\nG.p.gold += target.gold;\nG.p.kills++;\nG.msg = target.name + ' slain! +' + target.xp + 'xp +' + target.gold + 'g';\nG.msgTimer = 90;\nsnd.explode();\nfor (var i = 0; i < 12; i++)\nG.particles.push({ x: nx * G.TS + G.TS/2, y: ny * G.TS + G.TS/2, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, life: 20, c: target.color, s: 2 });\nG.monsters = G.monsters.filter(function(m) { return m !== target; });\nif (Math.random() < 0.25) {\nvar loot = G.genLoot(G.floor);\nG.items.push({ x: nx, y: ny, item: loot });\n}\nif (G.p.xp >= G.p.xpNext) G.levelUp();\n}\n} else {\nG.p.x = nx;\nG.p.y = ny;\nvar tile = G.map[ny][nx];\nif (tile === G.T_STAIR) {\nif (K(' ') || K('Enter')) {\n}\nG.msg = 'Stairs down. Press > to descend';\nG.msgTimer = 60;\n}\nif (tile === G.T_CHEST) {\nG.map[ny][nx] = G.T_FLOOR;\nvar loot = G.genLoot(G.floor);\nif (loot.category === 'gold') {\nG.p.gold += loot.stat;\nG.msg = 'Found ' + loot.name + '!';\n} else {\nG.p.inv.push(loot);\nG.msg = 'Found ' + loot.name + '!';\n}\nG.msgTimer = 90;\nG.flash = 8; G.flashC = '#ffcc00';\nsnd.score();\nfor (var i = 0; i < 8; i++)\nG.particles.push({ x: nx * G.TS + G.TS/2, y: ny * G.TS + G.TS/2, vx: (Math.random()-0.5)*3, vy: (Math.random()-0.5)*3, life: 18, c: '#ffcc00', s: 2 });\n}\nif (tile === G.T_TRAP) {\nG.map[ny][nx] = G.T_FLOOR;\nvar trapDmg = 3 + Math.floor(G.floor * 1.5);\nvar defReduce = (G.p.armor ? G.p.armor.stat : 0);\ntrapDmg = Math.max(1, trapDmg - Math.floor(defReduce / 2));\nG.p.hp -= trapDmg;\nG.msg = 'Trap! Took ' + trapDmg + ' damage!';\nG.msgTimer = 90;\nG.shake = 6; G.flash = 10; G.flashC = '#ff4444';\nsnd.tone(200, 0.08, 0.06, 'sawtooth');\n}\nfor (var i = G.items.length - 1; i >= 0; i--) {\nvar gi = G.items[i];\nif (gi.x === nx && gi.y === ny) {\nif (gi.item.category === 'gold') {\nG.p.gold += gi.item.stat;\nG.msg = 'Picked up ' + gi.item.name;\n} else if (G.p.inv.length < 8) {\nG.p.inv.push(gi.item);\nG.msg = 'Picked up ' + gi.item.name;\n} else {\nG.msg = 'Inventory full!';\nG.msgTimer = 60;\ncontinue;\n}\nG.items.splice(i, 1);\nG.msgTimer = 60;\nsnd.pickup();\n}\n}\n}\nif (K('>') || K('.')) {\nif (G.map[G.p.y][G.p.x] === G.T_STAIR) {\nG.floor++;\nif (G.floor > G.p.maxFloor) G.p.maxFloor = G.floor;\nif (G.floor > 12) {\nG.phase = 'victory';\nG.msg = 'You escaped the dungeon!';\nsnd.win();\nG.kcd = 30;\nreturn;\n}\nG.genFloor(G.floor);\nG.calcFOV();\nG.msg = 'Descended to floor ' + G.floor;\nG.msgTimer = 90;\nG.flash = 12; G.flashC = '#4488ff';\nsnd.tone(300, 0.06, 0.04);\nG.kcd = 15;\nreturn;\n}\n}\nG.turn++;\nG.calcFOV();\nfor (var i = 0; i < G.monsters.length; i++) {\nvar m = G.monsters[i];\nif (G.fov[m.y] && G.fov[m.y][m.x]) {\nm.awake = true;\nm.lastSawX = G.p.x;\nm.lastSawY = G.p.y;\n}\nif (!m.awake) continue;\nvar goalX = G.fov[m.y] && G.fov[m.y][m.x] ? G.p.x : m.lastSawX;\nvar goalY = G.fov[m.y] && G.fov[m.y][m.x] ? G.p.y : m.lastSawY;\nif (goalX < 0) continue;\nvar mdx = 0, mdy = 0;\nvar ddx = goalX - m.x;\nvar ddy = goalY - m.y;\nif (Math.abs(ddx) >= Math.abs(ddy)) {\nmdx = ddx > 0 ? 1 : (ddx < 0 ? -1 : 0);\n} else {\nmdy = ddy > 0 ? 1 : (ddy < 0 ? -1 : 0);\n}\nvar mnx = m.x + mdx;\nvar mny = m.y + mdy;\nif (mnx === G.p.x && mny === G.p.y) {\nvar mDmg = Math.max(1, m.atk - G.p.def - (G.p.armor ? G.p.armor.stat : 0) + Math.floor(Math.random() * 2));\nG.p.hp -= mDmg;\nG.msg = m.name + ' hits you for ' + mDmg + '!';\nG.msgTimer = 60;\nG.shake = 4;\nsnd.tone(150, 0.06, 0.05, 'sawtooth');\nfor (var j = 0; j < 4; j++)\nG.particles.push({ x: G.p.x * G.TS + G.TS/2, y: G.p.y * G.TS + G.TS/2, vx: (Math.random()-0.5)*3, vy: (Math.random()-0.5)*3, life: 12, c: '#ff4444', s: 2 });\nif (G.p.hp <= 0) {\nG.phase = 'dead';\nG.msg = 'Slain by ' + m.name + ' on floor ' + G.floor;\nG.msgTimer = 9999;\nsnd.die();\nG.kcd = 30;\nreturn;\n}\ncontinue;\n}\nif (mnx >= 0 && mnx < G.MW && mny >= 0 && mny < G.MH &&\nG.map[mny][mnx] !== G.T_WALL) {\nvar blocked = false;\nfor (var j = 0; j < G.monsters.length; j++) {\nif (j !== i && G.monsters[j].x === mnx && G.monsters[j].y === mny) { blocked = true; break; }\n}\nif (!blocked) {\nm.x = mnx;\nm.y = mny;\n}\n}\nif (m.x === m.lastSawX && m.y === m.lastSawY && !(G.fov[m.y] && G.fov[m.y][m.x])) {\nm.awake = false;\nm.lastSawX = -1; m.lastSawY = -1;\n}\n}\n}\nif (mode === 'draw') {\nvar sx = G.shake > 0 ? (Math.random()-0.5) * G.shake * 2 : 0;\nvar sy = G.shake > 0 ? (Math.random()-0.5) * G.shake * 2 : 0;\nO.save();\nO.translate(sx, sy);\ncls('#0a0a12');\nvar camX = G.p.x * G.TS - RW / 2 + G.TS / 2;\nvar camY = G.p.y * G.TS - RH / 2 + G.TS / 2;\ncamX = Math.max(0, Math.min(G.MW * G.TS - RW, camX));\ncamY = Math.max(0, Math.min(G.MH * G.TS - RH, camY));\nO.save();\nO.translate(-camX, -camY);\nvar wallC = '#1a1a2e';\nvar wallHL = '#222244';\nvar floorC = '#2a2a3a';\nvar doorC = '#886644';\nvar stairC = '#44aaff';\nvar chestC = '#ffaa00';\nvar trapC = '#663333';\nfor (var y = 0; y < G.MH; y++) {\nfor (var x = 0; x < G.MW; x++) {\nvar px = x * G.TS;\nvar py = y * G.TS;\nif (px + G.TS < camX || px > camX + RW || py + G.TS < camY || py > camY + RH) continue;\nvar visible = G.fov[y] && G.fov[y][x];\nvar explored = G.seen[y] && G.seen[y][x];\nif (!explored) continue;\nvar tile = G.map[y][x];\nvar alpha = visible ? 1.0 : 0.35;\nif (tile === G.T_WALL) {\nvar shade = ((x * 7 + y * 13) % 3 === 0) ? wallHL : wallC;\nO.fillStyle = shade;\nO.globalAlpha = alpha;\nO.fillRect(px, py, G.TS, G.TS);\nif (y + 1 < G.MH && G.map[y+1][x] !== G.T_WALL) {\nO.fillStyle = '#333355';\nO.fillRect(px, py + G.TS - 1, G.TS, 1);\n}\n} else if (tile === G.T_FLOOR) {\nO.fillStyle = floorC;\nO.globalAlpha = alpha;\nO.fillRect(px, py, G.TS, G.TS);\nif ((x + y) % 5 === 0) {\nO.fillStyle = '#333348';\nO.fillRect(px + 3, py + 3, 1, 1);\n}\n} else if (tile === G.T_DOOR) {\nO.fillStyle = floorC;\nO.globalAlpha = alpha;\nO.fillRect(px, py, G.TS, G.TS);\nO.fillStyle = doorC;\nO.fillRect(px + 1, py + 1, G.TS - 2, G.TS - 2);\nO.fillStyle = '#aa8855';\nO.fillRect(px + 3, py + 3, 2, 2);\n} else if (tile === G.T_STAIR) {\nO.fillStyle = floorC;\nO.globalAlpha = alpha;\nO.fillRect(px, py, G.TS, G.TS);\nO.fillStyle = stairC;\nO.fillRect(px + 1, py + 5, 6, 2);\nO.fillRect(px + 2, py + 3, 5, 2);\nO.fillRect(px + 3, py + 1, 4, 2);\n} else if (tile === G.T_CHEST) {\nO.fillStyle = floorC;\nO.globalAlpha = alpha;\nO.fillRect(px, py, G.TS, G.TS);\nif (visible) {\nO.fillStyle = chestC;\nO.fillRect(px + 1, py + 2, 6, 4);\nO.fillStyle = '#cc8800';\nO.fillRect(px + 1, py + 2, 6, 1);\nO.fillStyle = '#ffdd44';\nO.fillRect(px + 3, py + 3, 2, 2);\n}\n} else if (tile === G.T_TRAP) {\nO.fillStyle = floorC;\nO.globalAlpha = alpha;\nO.fillRect(px, py, G.TS, G.TS);\nif (visible) {\nO.fillStyle = trapC;\nO.fillRect(px + 2, py + 2, 1, 1);\nO.fillRect(px + 5, py + 5, 1, 1);\nO.fillRect(px + 2, py + 5, 1, 1);\nO.fillRect(px + 5, py + 2, 1, 1);\n}\n}\nO.globalAlpha = 1.0;\n}\n}\nG.items.forEach(function(gi) {\nif (!G.fov[gi.y] || !G.fov[gi.y][gi.x]) return;\nvar px = gi.x * G.TS;\nvar py = gi.y * G.TS;\nvar ic = gi.item.category === 'weapon' ? '#aaddff' :\ngi.item.category === 'armor' ? '#88aacc' :\ngi.item.category === 'potion' ? '#44ff88' : '#ffcc00';\nO.fillStyle = ic;\nO.fillRect(px + 2, py + 2, 4, 4);\nO.fillStyle = 'rgba(255,255,255,0.3)';\nO.fillRect(px + 3, py + 2, 1, 1);\n});\nG.monsters.forEach(function(m) {\nif (!G.fov[m.y] || !G.fov[m.y][m.x]) return;\nvar px = m.x * G.TS;\nvar py = m.y * G.TS;\nO.fillStyle = m.color;\nO.fillRect(px + 1, py + 1, G.TS - 2, G.TS - 2);\nO.fillStyle = '#fff';\nO.font = '6px monospace';\nO.textAlign = 'center';\nO.fillText(m.icon, px + G.TS / 2, py + G.TS - 1);\nif (m.hp < m.maxHp) {\nvar barW = G.TS - 2;\nO.fillStyle = '#333';\nO.fillRect(px + 1, py - 2, barW, 2);\nO.fillStyle = m.hp > m.maxHp * 0.5 ? '#44ff44' : m.hp > m.maxHp * 0.25 ? '#ffaa00' : '#ff4444';\nO.fillRect(px + 1, py - 2, Math.floor(barW * m.hp / m.maxHp), 2);\n}\n});\nvar ppx = G.p.x * G.TS;\nvar ppy = G.p.y * G.TS;\nO.fillStyle = 'rgba(255,153,68,0.15)';\nO.beginPath();\nO.arc(ppx + G.TS/2, ppy + G.TS/2, G.TS, 0, Math.PI*2);\nO.fill();\nO.fillStyle = '#ff9944';\nO.fillRect(ppx + 1, ppy + 1, G.TS - 2, G.TS - 2);\nO.fillStyle = '#fff';\nO.fillRect(ppx + 2, ppy + 2, 1, 1);\nO.fillRect(ppx + 5, ppy + 2, 1, 1);\nif (G.p.weapon) {\nO.fillStyle = '#aaddff';\nO.fillRect(ppx + G.TS, ppy + 2, 2, 4);\n}\nif (G.p.armor) {\nO.strokeStyle = '#88aacc';\nO.lineWidth = 1;\nO.strokeRect(ppx, ppy, G.TS, G.TS);\n}\nG.particles.forEach(function(p) {\nO.fillStyle = p.c || '#fff';\nO.fillRect(p.x - (p.s||1)/2, p.y - (p.s||1)/2, p.s || 1, p.s || 1);\n});\nO.restore();\nrect(0, 0, RW, 14, 'rgba(0,0,0,0.75)');\nrect(2, 3, 50, 4, '#331111');\nrect(2, 3, Math.max(0, Math.floor(50 * G.p.hp / G.p.maxHp)), 4, G.p.hp > G.p.maxHp * 0.3 ? '#cc3333' : '#ff2222');\ntxt(G.p.hp + '/' + G.p.maxHp, 27, 8, 5, '#ff9999');\nrect(2, 9, 50, 2, '#111133');\nrect(2, 9, Math.floor(50 * G.p.xp / G.p.xpNext), 2, '#4444cc');\ntxt('Lv' + G.p.lvl, 60, 5, 5, '#ffcc44', 'left');\ntxt('Atk:' + (G.p.atk + (G.p.weapon ? G.p.weapon.stat : 0)), 85, 5, 5, '#ff8844', 'left');\ntxt('Def:' + (G.p.def + (G.p.armor ? G.p.armor.stat : 0)), 120, 5, 5, '#4488ff', 'left');\ntxt('$' + G.p.gold, 155, 5, 5, '#ffcc00', 'left');\ntxt('F' + G.floor, 180, 5, 5, '#4488ff', 'left');\ntxt('T' + G.turn, 200, 5, 5, '#888', 'left');\nif (G.p.weapon) txt(G.p.weapon.icon, 230, 5, 5, '#aaddff', 'left');\nif (G.p.armor) txt(G.p.armor.icon, 240, 5, 5, '#88aacc', 'left');\nif (G.msgTimer > 0) {\nvar msgAlpha = G.msgTimer > 30 ? 1 : G.msgTimer / 30;\nrect(0, RH - 14, RW, 14, 'rgba(0,0,0,' + (0.7 * msgAlpha) + ')');\ntxt(G.msg, RW / 2, RH - 7, 6, 'rgba(200,200,200,' + msgAlpha + ')');\n}\nif (G.flash > 0) {\nO.fillStyle = G.flashC;\nO.globalAlpha = G.flash / 20;\nO.fillRect(0, 0, RW, RH);\nO.globalAlpha = 1.0;\n}\nif (G.phase === 'inventory') {\nO.fillStyle = 'rgba(0,0,0,0.85)';\nO.fillRect(0, 0, RW, RH);\ntxt('INVENTORY', RW/2, 16, 10, '#ff9944');\ntxt('‚îÄ‚îÄ Equipped ‚îÄ‚îÄ', RW/2, 32, 6, '#888');\nvar wName = G.p.weapon ? G.p.weapon.name + ' (+' + G.p.weapon.stat + ' atk)' : '(none)';\nvar aName = G.p.armor ? G.p.armor.name + ' (+' + G.p.armor.stat + ' def)' : '(none)';\ntxt('Weapon: ' + wName, RW/2, 42, 6, '#aaddff');\ntxt('Armor:  ' + aName, RW/2, 52, 6, '#88aacc');\ntxt('‚îÄ‚îÄ Bag (' + G.p.inv.length + '/8) ‚îÄ‚îÄ', RW/2, 68, 6, '#888');\nif (G.p.inv.length === 0) {\ntxt('Empty', RW/2, 82, 6, '#555');\n} else {\nfor (var i = 0; i < G.p.inv.length; i++) {\nvar item = G.p.inv[i];\nvar y = 80 + i * 14;\nvar sel = i === G.selIdx;\nvar ic = item.category === 'weapon' ? '#aaddff' :\nitem.category === 'armor' ? '#88aacc' :\nitem.category === 'potion' ? '#44ff88' : '#ffcc00';\ntxt((sel ? '> ' : '  ') + item.icon + ' ' + item.name, 80, y, 6, sel ? '#ffcc00' : ic, 'left');\nif (item.category === 'weapon') txt('+' + item.stat + ' atk', 210, y, 5, '#888', 'left');\nelse if (item.category === 'armor') txt('+' + item.stat + ' def', 210, y, 5, '#888', 'left');\nelse if (item.category === 'potion') txt('+' + item.stat, 210, y, 5, '#888', 'left');\n}\n}\ntxt('Enter=Use/Equip  D=Drop  I=Close', RW/2, RH - 10, 5, '#666');\n}\nif (G.phase === 'dead') {\nO.fillStyle = 'rgba(0,0,0,0.8)';\nO.fillRect(0, 0, RW, RH);\ntxt('YOU HAVE PERISHED', RW/2, RH/2 - 40, 14, '#cc2222');\ntxt(G.msg, RW/2, RH/2 - 15, 7, '#aaa');\ntxt('‚îÅ‚îÅ‚îÅ EPITAPH ‚îÅ‚îÅ‚îÅ', RW/2, RH/2 + 5, 6, '#666');\ntxt('Level ' + G.p.lvl + ' Adventurer', RW/2, RH/2 + 18, 7, '#ffcc44');\ntxt('Deepest Floor: ' + G.p.maxFloor, RW/2, RH/2 + 30, 6, '#4488ff');\ntxt('Monsters Slain: ' + G.p.kills, RW/2, RH/2 + 40, 6, '#cc4444');\ntxt('Gold Hoarded: ' + G.p.gold, RW/2, RH/2 + 50, 6, '#ffcc00');\ntxt('Turns Survived: ' + G.turn, RW/2, RH/2 + 60, 6, '#888');\ntxt('Press Enter to try again', RW/2, RH/2 + 80, 6, '#666');\n}\nif (G.phase === 'victory') {\nO.fillStyle = 'rgba(0,0,0,0.85)';\nO.fillRect(0, 0, RW, RH);\ntxt('DUNGEON CONQUERED', RW/2, 30, 14, '#ffcc00');\ntxt('You escaped the Depths of Ruin!', RW/2, 50, 7, '#aaa');\ntxt('‚îÅ‚îÅ‚îÅ LEGEND ‚îÅ‚îÅ‚îÅ', RW/2, 70, 6, '#888');\ntxt('Level ' + G.p.lvl + ' Adventurer', RW/2, 86, 8, '#ffcc44');\ntxt('All ' + G.p.maxFloor + ' Floors Cleared', RW/2, 100, 6, '#4488ff');\ntxt('Monsters Slain: ' + G.p.kills, RW/2, 114, 6, '#cc4444');\ntxt('Gold Hoarded: ' + G.p.gold, RW/2, 126, 6, '#ffcc00');\ntxt('Turns Taken: ' + G.turn, RW/2, 138, 6, '#888');\nif (G.p.weapon) txt('Weapon: ' + G.p.weapon.name, RW/2, 156, 6, '#aaddff');\nif (G.p.armor) txt('Armor: ' + G.p.armor.name, RW/2, 168, 6, '#88aacc');\ntxt('Press Enter to play again', RW/2, 195, 6, '#666');\n}\nO.restore();\nhud('Floor ' + G.floor + ' | Lv' + G.p.lvl + ' | HP:' + G.p.hp + '/' + G.p.maxHp + ' | Kills:' + G.p.kills + ' | $' + G.p.gold);\ncontrols('WASD Move ¬∑ I Inventory ¬∑ . Wait ¬∑ > Descend');\n}"
    }
  ]
}