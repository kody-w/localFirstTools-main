<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONOSCAPE - Time Loop Mystery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #0f0;
            overflow: hidden;
            user-select: none;
        }

        #gameContainer {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #mainCanvas {
            flex: 1;
            background: #000;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        #timer {
            font-size: 48px;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 10px #0f0, 0 0 20px #0f0;
            transition: color 0.3s;
            font-family: 'Courier New', monospace;
        }

        #timer.critical {
            color: #f00;
            text-shadow: 0 0 10px #f00, 0 0 20px #f00;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        #loopCounter {
            font-size: 18px;
            color: #0af;
            text-shadow: 0 0 5px #0af;
        }

        #roomInfo {
            position: absolute;
            bottom: 120px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border: 2px solid #0f0;
            max-width: 300px;
        }

        #roomName {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #0ff;
        }

        #roomDesc {
            font-size: 14px;
            line-height: 1.4;
        }

        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }

        .btn {
            padding: 10px 20px;
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #0f0;
            color: #0f0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .btn:hover {
            background: rgba(0, 255, 0, 0.4);
            box-shadow: 0 0 10px #0f0;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        #minimap {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 200px;
            height: 200px;
            background: rgba(0,0,0,0.8);
            border: 2px solid #0f0;
            pointer-events: none;
        }

        #journal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 800px;
            height: 80%;
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #0f0;
            display: none;
            flex-direction: column;
            pointer-events: auto;
            z-index: 100;
        }

        #journal.visible {
            display: flex;
        }

        #journalHeader {
            padding: 20px;
            border-bottom: 2px solid #0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #journalTitle {
            font-size: 24px;
            color: #0ff;
        }

        #journalClose {
            cursor: pointer;
            font-size: 24px;
            color: #f00;
        }

        #journalTabs {
            display: flex;
            border-bottom: 2px solid #0f0;
        }

        .journalTab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-right: 1px solid #0f0;
            background: rgba(0, 255, 0, 0.1);
            transition: background 0.2s;
        }

        .journalTab:last-child {
            border-right: none;
        }

        .journalTab.active {
            background: rgba(0, 255, 0, 0.3);
            color: #0ff;
        }

        .journalTab:hover {
            background: rgba(0, 255, 0, 0.2);
        }

        #journalContent {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .clue {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 255, 0, 0.05);
            border-left: 3px solid #0f0;
        }

        .clueTitle {
            font-size: 16px;
            font-weight: bold;
            color: #0ff;
            margin-bottom: 5px;
        }

        .clueText {
            font-size: 14px;
            line-height: 1.4;
        }

        .clueTime {
            font-size: 12px;
            color: #0af;
            margin-top: 5px;
        }

        #dialogue {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 700px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #0ff;
            display: none;
            flex-direction: column;
            pointer-events: auto;
            z-index: 50;
        }

        #dialogue.visible {
            display: flex;
        }

        #dialogueSpeaker {
            padding: 10px;
            background: rgba(0, 255, 255, 0.2);
            border-bottom: 1px solid #0ff;
            font-weight: bold;
            color: #0ff;
        }

        #dialogueText {
            padding: 15px;
            font-size: 14px;
            line-height: 1.6;
            min-height: 60px;
        }

        #dialogueOptions {
            border-top: 1px solid #0ff;
            display: flex;
            flex-direction: column;
        }

        .dialogueOption {
            padding: 12px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            cursor: pointer;
            transition: background 0.2s;
        }

        .dialogueOption:last-child {
            border-bottom: none;
        }

        .dialogueOption:hover {
            background: rgba(0, 255, 255, 0.2);
        }

        .dialogueOption.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        #notification {
            position: absolute;
            top: 80px;
            right: 10px;
            padding: 15px;
            background: rgba(0, 255, 0, 0.9);
            color: #000;
            border: 2px solid #0f0;
            font-weight: bold;
            display: none;
            max-width: 300px;
            pointer-events: none;
            animation: slideIn 0.3s;
        }

        #notification.visible {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            pointer-events: auto;
        }

        #overlay.visible {
            display: flex;
        }

        #overlayContent {
            background: #000;
            border: 3px solid #0f0;
            padding: 40px;
            max-width: 600px;
            text-align: center;
        }

        #overlayTitle {
            font-size: 36px;
            color: #0ff;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #0ff;
        }

        #overlayText {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        #overlayButtons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        #titleScreen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }

        #titleScreen.hidden {
            display: none;
        }

        #gameTitle {
            font-size: 72px;
            color: #0ff;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #0ff, 0 0 40px #0ff;
            animation: flicker 2s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        #gameSubtitle {
            font-size: 24px;
            color: #0f0;
            margin-bottom: 50px;
        }

        #startButton {
            padding: 20px 40px;
            font-size: 24px;
        }

        .hidden {
            display: none !important;
        }

        #actionPrompt {
            position: absolute;
            background: rgba(0, 255, 255, 0.9);
            color: #000;
            padding: 8px 12px;
            border: 2px solid #0ff;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 10;
        }

        #actionPrompt.visible {
            display: block;
        }

        #keyHints {
            position: absolute;
            bottom: 70px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border: 2px solid #0f0;
            font-size: 12px;
            pointer-events: none;
        }

        .keyHint {
            margin: 3px 0;
        }

        .key {
            display: inline-block;
            padding: 2px 6px;
            background: rgba(0, 255, 0, 0.3);
            border: 1px solid #0f0;
            margin-right: 5px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: #0f0;
            border: 1px solid #000;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0ff;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="mainCanvas"></canvas>
        <canvas id="minimap"></canvas>

        <div id="hud">
            <div id="loopCounter">LOOP: 1</div>
            <div id="timer">10:00</div>
        </div>

        <div id="roomInfo">
            <div id="roomName">BRIDGE</div>
            <div id="roomDesc">The command center of Station Erebus. Status monitors line the walls.</div>
        </div>

        <div id="controls">
            <button class="btn" id="journalBtn" onclick="game.toggleJournal()">JOURNAL (J)</button>
            <button class="btn" id="talkBtn" onclick="game.interact('talk')">TALK (T)</button>
            <button class="btn" id="examineBtn" onclick="game.interact('examine')">EXAMINE (E)</button>
            <button class="btn" id="useBtn" onclick="game.interact('use')">USE (U)</button>
        </div>

        <div id="keyHints">
            <div class="keyHint"><span class="key">WASD</span> Move</div>
            <div class="keyHint"><span class="key">J</span> Journal</div>
            <div class="keyHint"><span class="key">T</span> Talk</div>
            <div class="keyHint"><span class="key">E</span> Examine</div>
            <div class="keyHint"><span class="key">ESC</span> Close</div>
        </div>

        <div id="journal">
            <div id="journalHeader">
                <div id="journalTitle">CLUE JOURNAL</div>
                <div id="journalClose" onclick="game.toggleJournal()">âœ•</div>
            </div>
            <div id="journalTabs">
                <div class="journalTab active" data-category="all" onclick="game.filterJournal('all')">ALL</div>
                <div class="journalTab" data-category="people" onclick="game.filterJournal('people')">PEOPLE</div>
                <div class="journalTab" data-category="locations" onclick="game.filterJournal('locations')">LOCATIONS</div>
                <div class="journalTab" data-category="events" onclick="game.filterJournal('events')">EVENTS</div>
                <div class="journalTab" data-category="codes" onclick="game.filterJournal('codes')">CODES</div>
                <div class="journalTab" data-category="evidence" onclick="game.filterJournal('evidence')">EVIDENCE</div>
            </div>
            <div id="journalContent"></div>
        </div>

        <div id="dialogue">
            <div id="dialogueSpeaker"></div>
            <div id="dialogueText"></div>
            <div id="dialogueOptions"></div>
        </div>

        <div id="notification"></div>
        <div id="actionPrompt"></div>

        <div id="overlay">
            <div id="overlayContent">
                <div id="overlayTitle"></div>
                <div id="overlayText"></div>
                <div id="overlayButtons"></div>
            </div>
        </div>

        <div id="titleScreen">
            <div id="gameTitle">CHRONOSCAPE</div>
            <div id="gameSubtitle">A Time Loop Mystery</div>
            <button class="btn" id="startButton" onclick="game.startGame()">START MISSION</button>
        </div>
    </div>

    <script>
        // GAME STATE AND CONSTANTS
        const LOOP_DURATION = 600; // 10 minutes in seconds
        const PLAYER_SPEED = 100; // pixels per second
        const NPC_SPEED = 80;

        // Room definitions with coordinates and connections
        const ROOMS = {
            bridge: {
                name: 'BRIDGE',
                desc: 'The command center of Station Erebus. Status monitors line the walls.',
                x: 400, y: 100, width: 200, height: 150,
                color: '#003366',
                connections: ['engineering', 'crewQuarters1'],
                objects: ['console', 'captain_chair', 'status_monitor']
            },
            engineering: {
                name: 'ENGINEERING',
                desc: 'The heart of the station. Maintenance panels and diagnostic terminals everywhere.',
                x: 400, y: 300, width: 200, height: 150,
                color: '#663300',
                connections: ['bridge', 'reactor', 'serverRoom'],
                objects: ['engineering_manual', 'diagnostic_terminal', 'toolkit']
            },
            reactor: {
                name: 'REACTOR ROOM',
                desc: 'The station\'s power core. A low hum fills the air. Something feels wrong.',
                x: 650, y: 300, width: 150, height: 150,
                color: '#660000',
                connections: ['engineering', 'cargo'],
                objects: ['reactor_console', 'coolant_system', 'access_panel']
            },
            medbay: {
                name: 'MEDBAY',
                desc: 'Medical facilities with examination beds and supply cabinets.',
                x: 150, y: 100, width: 150, height: 120,
                color: '#006633',
                connections: ['lab', 'crewQuarters2'],
                objects: ['medical_records', 'medicine_cabinet', 'examination_bed']
            },
            lab: {
                name: 'LABORATORY',
                desc: 'Research equipment and specimen containers. A data terminal blinks.',
                x: 150, y: 270, width: 150, height: 130,
                color: '#003366',
                connections: ['medbay', 'crewQuarters2'],
                objects: ['data_core', 'research_notes', 'specimen_container']
            },
            crewQuarters1: {
                name: 'CREW QUARTERS A',
                desc: 'Captain Vasquez\'s quarters. Neat and organized.',
                x: 350, y: 500, width: 130, height: 100,
                color: '#333366',
                connections: ['bridge', 'messHall', 'crewQuarters2'],
                objects: ['captain_desk', 'personal_terminal', 'locked_drawer']
            },
            crewQuarters2: {
                name: 'CREW QUARTERS B',
                desc: 'Shared living space for crew members. Personal belongings scattered around.',
                x: 530, y: 500, width: 130, height: 100,
                color: '#333366',
                connections: ['crewQuarters1', 'crewQuarters3', 'medbay', 'lab'],
                objects: ['personal_locker', 'bunk_beds', 'photo_frame']
            },
            crewQuarters3: {
                name: 'CREW QUARTERS C',
                desc: 'Technician Reeves\' quarters. Tools and technical manuals everywhere.',
                x: 710, y: 500, width: 130, height: 100,
                color: '#333366',
                connections: ['crewQuarters2', 'cargo'],
                objects: ['tech_workbench', 'component_box', 'personal_pad']
            },
            cargo: {
                name: 'CARGO BAY',
                desc: 'Large storage area filled with supply crates and equipment.',
                x: 850, y: 300, width: 150, height: 200,
                color: '#663333',
                connections: ['reactor', 'crewQuarters3', 'airlock'],
                objects: ['supply_crates', 'cargo_manifest', 'loading_equipment']
            },
            airlock: {
                name: 'AIRLOCK',
                desc: 'The station\'s emergency exit. Red warning lights illuminate the chamber.',
                x: 850, y: 100, width: 150, height: 150,
                color: '#660033',
                connections: ['cargo', 'serverRoom'],
                objects: ['airlock_controls', 'emergency_suits', 'evacuation_protocol']
            },
            messHall: {
                name: 'MESS HALL',
                desc: 'The crew dining area. Tables and food dispensers. A coffee maker gurgles.',
                x: 150, y: 450, width: 150, height: 130,
                color: '#336633',
                connections: ['crewQuarters1'],
                objects: ['coffee_maker', 'food_dispenser', 'bulletin_board']
            },
            serverRoom: {
                name: 'SERVER ROOM',
                desc: 'Banks of humming servers. Security camera feeds flicker on monitors.',
                x: 650, y: 100, width: 150, height: 150,
                color: '#330066',
                connections: ['engineering', 'airlock'],
                objects: ['security_terminal', 'server_racks', 'camera_feeds'],
                locked: true
            }
        };

        // NPC schedules (timestamp in seconds: action)
        const NPC_SCHEDULES = {
            vasquez: {
                name: 'Captain Vasquez',
                title: 'CAPTAIN',
                color: '#FFD700',
                startRoom: 'bridge',
                trust: 50,
                schedule: [
                    {time: 0, room: 'bridge', action: 'monitoring'},
                    {time: 180, room: 'engineering', action: 'inspection'},
                    {time: 420, room: 'reactor', action: 'investigating'},
                    {time: 600, room: 'reactor', action: 'dead'}
                ],
                dialogue: {
                    default: ["Captain Vasquez nods curtly. 'Report?'"],
                    knows_warning: ["'Reactor warning? Show me the evidence.'"],
                    has_evidence: ["'My God... Reeves did this? We need to act NOW.'"]
                }
            },
            chen: {
                name: 'Dr. Chen',
                title: 'MEDICAL OFFICER',
                color: '#00FF88',
                startRoom: 'medbay',
                trust: 50,
                schedule: [
                    {time: 0, room: 'medbay', action: 'working'},
                    {time: 120, room: 'lab', action: 'research'},
                    {time: 300, room: 'medbay', action: 'patient_care'},
                    {time: 330, room: 'medbay', action: 'password_mention'},
                    {time: 480, room: 'crewQuarters2', action: 'resting'},
                    {time: 600, room: 'crewQuarters2', action: 'dead'}
                ],
                dialogue: {
                    default: ["Dr. Chen looks up from her work. 'Do you need medical attention?'"],
                    at_password_mention: ["'The server room password? It's PROMETHEUS-7. Don't tell anyone I told you.'"],
                    warned: ["'Time loop? That's... medically impossible. But you seem sincere.'"]
                }
            },
            kowalski: {
                name: 'Engineer Kowalski',
                title: 'CHIEF ENGINEER',
                color: '#FF8800',
                startRoom: 'engineering',
                trust: 50,
                schedule: [
                    {time: 0, room: 'engineering', action: 'maintenance'},
                    {time: 240, room: 'engineering', action: 'discovers_warning'},
                    {time: 300, room: 'reactor', action: 'investigating'},
                    {time: 360, room: 'serverRoom', action: 'locked_in'},
                    {time: 600, room: 'serverRoom', action: 'dead'}
                ],
                dialogue: {
                    default: ["Kowalski wipes grease from his hands. 'What do you need?'"],
                    found_warning: ["'The reactor diagnostics are showing anomalies. This isn't right...'"],
                    about_manual: ["'The emergency shutdown procedure? It's in the manual on my desk. Takes time to do it right though.'"]
                }
            },
            drake: {
                name: 'Officer Drake',
                title: 'SECURITY',
                color: '#FF0088',
                startRoom: 'bridge',
                trust: 50,
                schedule: [
                    {time: 0, room: 'bridge', action: 'patrol_start'},
                    {time: 60, room: 'cargo', action: 'patrolling'},
                    {time: 120, room: 'airlock', action: 'patrolling'},
                    {time: 180, room: 'crewQuarters2', action: 'patrolling'},
                    {time: 240, room: 'bridge', action: 'patrolling'},
                    {time: 300, room: 'cargo', action: 'patrolling'},
                    {time: 360, room: 'airlock', action: 'patrolling'},
                    {time: 420, room: 'crewQuarters2', action: 'patrolling'},
                    {time: 480, room: 'bridge', action: 'emergency_response'},
                    {time: 600, room: 'bridge', action: 'dead'}
                ],
                dialogue: {
                    default: ["Drake eyes you suspiciously. 'Everything alright?'"],
                    accused: ["'You're accusing ME? I've been on patrol the whole time!'"],
                    evidence_shown: ["'Reeves... I'll help you apprehend him. Let's go.'"]
                }
            },
            patel: {
                name: 'Dr. Patel',
                title: 'SCIENTIST',
                color: '#00FFFF',
                startRoom: 'lab',
                trust: 50,
                schedule: [
                    {time: 0, room: 'lab', action: 'research'},
                    {time: 360, room: 'lab', action: 'discovers_evidence'},
                    {time: 540, room: 'airlock', action: 'evacuation_attempt'},
                    {time: 600, room: 'airlock', action: 'dead'}
                ],
                dialogue: {
                    default: ["Dr. Patel adjusts her glasses. 'The research must continue.'"],
                    found_evidence: ["'I found something in the data core... Reeves has been accessing restricted files. Financial records. He's been embezzling!'"],
                    about_loops: ["'Quantum causality... fascinating. If you're telling the truth, you're experiencing a temporal anomaly.'"]
                }
            },
            reeves: {
                name: 'Technician Reeves',
                title: 'TECHNICIAN',
                color: '#888888',
                startRoom: 'crewQuarters3',
                trust: 50,
                isSaboteur: true,
                schedule: [
                    {time: 0, room: 'crewQuarters3', action: 'waiting'},
                    {time: 180, room: 'crewQuarters3', action: 'preparing'},
                    {time: 210, room: 'reactor', action: 'planting_bomb'},
                    {time: 240, room: 'messHall', action: 'acting_normal'},
                    {time: 480, room: 'messHall', action: 'nervous'},
                    {time: 540, room: 'crewQuarters3', action: 'packing'},
                    {time: 600, room: 'crewQuarters3', action: 'dead'}
                ],
                dialogue: {
                    default: ["Reeves looks up. 'Hey there. Just doing some work.'"],
                    accused_no_evidence: ["'What?! You're crazy! I would never!'"],
                    accused_with_evidence: ["Reeves' face goes pale. '...How did you know? The company left me no choice. They were going to fire everyone anyway. The insurance payout... I needed it. I'm sorry.'"],
                    confronted_early: ["'You... you can't know that. Unless... are you some kind of inspector? No matter. It's too late to stop it now!'"]
                }
            }
        };

        // Clue database
        const CLUES = {
            captain_override: {
                id: 'captain_override',
                title: 'Captain\'s Override Code',
                text: 'Found in Captain Vasquez\'s locked drawer: Emergency Override Code: EREBUS-OMEGA-9',
                category: 'codes',
                location: 'crewQuarters1',
                requires: []
            },
            server_password: {
                id: 'server_password',
                title: 'Server Room Password',
                text: 'Dr. Chen mentioned the server room password: PROMETHEUS-7',
                category: 'codes',
                location: 'medbay',
                requires: []
            },
            reactor_shutdown: {
                id: 'reactor_shutdown',
                title: 'Reactor Shutdown Procedure',
                text: 'Emergency Shutdown: 1) Enter override code 2) Disable coolant lockout 3) Initiate manual scram 4) Vent excess heat. Requires 120 seconds to complete safely.',
                category: 'codes',
                location: 'engineering',
                requires: []
            },
            camera_footage: {
                id: 'camera_footage',
                title: 'Security Camera Footage',
                text: 'Footage shows Technician Reeves at reactor console at 03:30, placing a device under the main control panel.',
                category: 'evidence',
                location: 'serverRoom',
                requires: ['server_password']
            },
            reeves_motive: {
                id: 'reeves_motive',
                title: 'Reeves\' Financial Records',
                text: 'Data core shows Reeves has been embezzling funds. Facing criminal charges. Station destruction would trigger insurance payout and destroy evidence.',
                category: 'evidence',
                location: 'lab',
                requires: []
            },
            bomb_location: {
                id: 'bomb_location',
                title: 'Bomb Location',
                text: 'The explosive device is hidden under the reactor console, accessible via the maintenance access panel. Can be disarmed with the right code.',
                category: 'evidence',
                location: 'reactor',
                requires: ['camera_footage']
            },
            vasquez_schedule: {
                id: 'vasquez_schedule',
                title: 'Captain\'s Schedule',
                text: 'Captain Vasquez follows a routine: Bridge (0:00-3:00), Engineering inspection (3:00-7:00), Reactor investigation (7:00-10:00).',
                category: 'people',
                location: 'bridge',
                requires: []
            },
            kowalski_locked: {
                id: 'kowalski_locked',
                title: 'Kowalski Gets Locked In',
                text: 'At 6:00, Engineer Kowalski becomes trapped in the Server Room. The door lock malfunctions - or was it sabotaged?',
                category: 'events',
                location: 'serverRoom',
                requires: []
            },
            tremor_event: {
                id: 'tremor_event',
                title: 'Minor Tremor',
                text: 'At 4:00, a minor tremor shakes the station. This is the first sign of reactor instability.',
                category: 'events',
                location: 'all',
                requires: []
            },
            evacuation_protocol: {
                id: 'evacuation_protocol',
                title: 'Emergency Evacuation',
                text: 'The airlock can fit all 6 crew members in the escape pods. Requires captain\'s authorization to launch.',
                category: 'codes',
                location: 'airlock',
                requires: []
            },
            previous_looper: {
                id: 'previous_looper',
                title: 'Message from the Past',
                text: 'Hidden in the data core: "If you\'re reading this, you\'re stuck too. Loop 847. I couldn\'t save them. The bomb is real. Reeves did it. Good luck. - A.K."',
                category: 'evidence',
                location: 'lab',
                requires: ['reeves_motive']
            },
            bomb_code: {
                id: 'bomb_code',
                title: 'Bomb Disarm Code',
                text: 'Found on Reeves\' personal pad: Disarm code is his daughter\'s birthday: 0415',
                category: 'codes',
                location: 'crewQuarters3',
                requires: []
            }
        };

        // Game class
        class Game {
            constructor() {
                this.canvas = document.getElementById('mainCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.minimap = document.getElementById('minimap');
                this.minimapCtx = this.minimap.getContext('2d');

                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());

                this.player = {
                    x: 500,
                    y: 175,
                    width: 20,
                    height: 20,
                    currentRoom: 'bridge',
                    moving: false,
                    targetX: 500,
                    targetY: 175
                };

                this.npcs = {};
                this.initializeNPCs();

                this.loopTime = 0;
                this.loopCount = 1;
                this.loopStartTime = null;
                this.gameRunning = false;

                this.discoveredClues = this.loadClues();
                this.journalFilter = 'all';

                this.keys = {};
                this.setupInput();

                this.currentDialogue = null;
                this.dialogueOpen = false;

                this.nearestInteractable = null;
                this.interactables = [];

                this.gameEvents = [];
                this.triggeredEvents = new Set();

                this.cameraX = 0;
                this.cameraY = 0;

                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.sounds = {};

                this.endings = this.loadEndings();

                this.lastTime = 0;
                this.animationId = null;

                this.setupEventTriggers();
            }

            resizeCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.minimap.width = 200;
                this.minimap.height = 200;
            }

            initializeNPCs() {
                for (let id in NPC_SCHEDULES) {
                    const npcData = NPC_SCHEDULES[id];
                    const startRoom = ROOMS[npcData.startRoom];
                    this.npcs[id] = {
                        ...npcData,
                        id: id,
                        x: startRoom.x + startRoom.width / 2,
                        y: startRoom.y + startRoom.height / 2,
                        currentRoom: npcData.startRoom,
                        currentScheduleIndex: 0,
                        trust: npcData.trust || 50,
                        warned: false,
                        accused: false,
                        conversationState: {}
                    };
                }
            }

            setupInput() {
                window.addEventListener('keydown', (e) => {
                    this.keys[e.key.toLowerCase()] = true;

                    if (e.key.toLowerCase() === 'j') {
                        this.toggleJournal();
                    } else if (e.key.toLowerCase() === 't') {
                        this.interact('talk');
                    } else if (e.key.toLowerCase() === 'e') {
                        this.interact('examine');
                    } else if (e.key.toLowerCase() === 'u') {
                        this.interact('use');
                    } else if (e.key === 'Escape') {
                        this.closeAllPanels();
                    }
                });

                window.addEventListener('keyup', (e) => {
                    this.keys[e.key.toLowerCase()] = false;
                });

                this.canvas.addEventListener('click', (e) => {
                    if (!this.gameRunning || this.dialogueOpen) return;

                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left + this.cameraX;
                    const y = e.clientY - rect.top + this.cameraY;

                    this.player.targetX = x;
                    this.player.targetY = y;
                    this.player.moving = true;
                });
            }

            setupEventTriggers() {
                this.gameEvents = [
                    {time: 240, id: 'tremor', triggered: false, action: () => this.triggerTremor()},
                    {time: 240, id: 'kowalski_warning', triggered: false, action: () => this.kowalskiFindsWarning()},
                    {time: 360, id: 'kowalski_locked', triggered: false, action: () => this.kowalskiGetLocked()},
                    {time: 360, id: 'patel_evidence', triggered: false, action: () => this.patelFindsEvidence()},
                    {time: 480, id: 'evacuation_alarm', triggered: false, action: () => this.evacuationAlarm()},
                    {time: 540, id: 'panic', triggered: false, action: () => this.panicMode()}
                ];
            }

            startGame() {
                document.getElementById('titleScreen').classList.add('hidden');
                this.gameRunning = true;
                this.loopStartTime = Date.now();
                this.lastTime = performance.now();
                this.gameLoop(this.lastTime);
                this.playSound('start');
            }

            gameLoop(currentTime) {
                if (!this.gameRunning) return;

                const deltaTime = (currentTime - this.lastTime) / 1000;
                this.lastTime = currentTime;

                this.update(deltaTime);
                this.render();

                this.animationId = requestAnimationFrame((time) => this.gameLoop(time));
            }

            update(deltaTime) {
                // Update loop timer
                this.loopTime = (Date.now() - this.loopStartTime) / 1000;

                if (this.loopTime >= LOOP_DURATION) {
                    this.resetLoop();
                    return;
                }

                this.updateTimer();

                // Update player movement
                if (!this.dialogueOpen) {
                    this.updatePlayerMovement(deltaTime);
                    this.updatePlayerKeyboard(deltaTime);
                }

                // Update NPCs
                this.updateNPCs(deltaTime);

                // Update camera
                this.updateCamera();

                // Check for interactables
                this.updateInteractables();

                // Trigger time-based events
                this.checkEventTriggers();

                // Update UI
                this.updateRoomInfo();
            }

            updateTimer() {
                const remaining = LOOP_DURATION - this.loopTime;
                const minutes = Math.floor(remaining / 60);
                const seconds = Math.floor(remaining % 60);
                const timerText = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                const timerEl = document.getElementById('timer');
                timerEl.textContent = timerText;

                if (remaining <= 120) {
                    timerEl.classList.add('critical');
                } else {
                    timerEl.classList.remove('critical');
                }
            }

            updatePlayerMovement(deltaTime) {
                if (!this.player.moving) return;

                const dx = this.player.targetX - this.player.x;
                const dy = this.player.targetY - this.player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < 5) {
                    this.player.moving = false;
                    this.player.x = this.player.targetX;
                    this.player.y = this.player.targetY;
                    this.updatePlayerRoom();
                    return;
                }

                const moveDistance = PLAYER_SPEED * deltaTime;
                const ratio = Math.min(moveDistance / distance, 1);

                this.player.x += dx * ratio;
                this.player.y += dy * ratio;

                this.updatePlayerRoom();
            }

            updatePlayerKeyboard(deltaTime) {
                let dx = 0;
                let dy = 0;

                if (this.keys['w'] || this.keys['arrowup']) dy = -1;
                if (this.keys['s'] || this.keys['arrowdown']) dy = 1;
                if (this.keys['a'] || this.keys['arrowleft']) dx = -1;
                if (this.keys['d'] || this.keys['arrowright']) dx = 1;

                if (dx !== 0 || dy !== 0) {
                    const length = Math.sqrt(dx * dx + dy * dy);
                    dx /= length;
                    dy /= length;

                    this.player.x += dx * PLAYER_SPEED * deltaTime;
                    this.player.y += dy * PLAYER_SPEED * deltaTime;
                    this.player.moving = false;

                    this.updatePlayerRoom();
                }
            }

            updatePlayerRoom() {
                for (let roomId in ROOMS) {
                    const room = ROOMS[roomId];
                    if (this.player.x >= room.x && this.player.x <= room.x + room.width &&
                        this.player.y >= room.y && this.player.y <= room.y + room.height) {
                        if (this.player.currentRoom !== roomId) {
                            if (room.locked && !this.hasClue('server_password')) {
                                this.showNotification('DOOR LOCKED - Password Required');
                                return;
                            }
                            this.player.currentRoom = roomId;
                        }
                        break;
                    }
                }
            }

            updateNPCs(deltaTime) {
                for (let id in this.npcs) {
                    const npc = this.npcs[id];
                    const schedule = npc.schedule;

                    // Find current schedule entry
                    let targetSchedule = schedule[0];
                    for (let i = schedule.length - 1; i >= 0; i--) {
                        if (this.loopTime >= schedule[i].time) {
                            targetSchedule = schedule[i];
                            npc.currentScheduleIndex = i;
                            break;
                        }
                    }

                    // Move NPC to scheduled room
                    if (npc.currentRoom !== targetSchedule.room) {
                        const targetRoom = ROOMS[targetSchedule.room];
                        const targetX = targetRoom.x + targetRoom.width / 2;
                        const targetY = targetRoom.y + targetRoom.height / 2;

                        const dx = targetX - npc.x;
                        const dy = targetY - npc.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance > 5) {
                            const moveDistance = NPC_SPEED * deltaTime;
                            const ratio = Math.min(moveDistance / distance, 1);
                            npc.x += dx * ratio;
                            npc.y += dy * ratio;
                        } else {
                            npc.currentRoom = targetSchedule.room;
                        }
                    }

                    npc.currentAction = targetSchedule.action;
                }
            }

            updateCamera() {
                const targetX = this.player.x - this.canvas.width / 2;
                const targetY = this.player.y - this.canvas.height / 2;

                this.cameraX = targetX;
                this.cameraY = targetY;

                // Clamp camera
                const maxX = 1200 - this.canvas.width;
                const maxY = 800 - this.canvas.height;
                this.cameraX = Math.max(0, Math.min(this.cameraX, maxX));
                this.cameraY = Math.max(0, Math.min(this.cameraY, maxY));
            }

            updateInteractables() {
                this.interactables = [];

                // Check NPCs
                for (let id in this.npcs) {
                    const npc = this.npcs[id];
                    if (npc.currentRoom === this.player.currentRoom) {
                        const distance = this.getDistance(this.player, npc);
                        if (distance < 60) {
                            this.interactables.push({type: 'npc', id: id, distance: distance});
                        }
                    }
                }

                // Check room objects
                const room = ROOMS[this.player.currentRoom];
                if (room && room.objects) {
                    room.objects.forEach(obj => {
                        this.interactables.push({type: 'object', id: obj, room: this.player.currentRoom});
                    });
                }

                // Find nearest
                this.nearestInteractable = null;
                if (this.interactables.length > 0) {
                    this.interactables.sort((a, b) => (a.distance || 0) - (b.distance || 0));
                    this.nearestInteractable = this.interactables[0];
                }

                // Update button states
                const canTalk = this.nearestInteractable && this.nearestInteractable.type === 'npc';
                const canExamine = this.nearestInteractable !== null;

                document.getElementById('talkBtn').classList.toggle('disabled', !canTalk);
                document.getElementById('examineBtn').classList.toggle('disabled', !canExamine);
            }

            checkEventTriggers() {
                this.gameEvents.forEach(event => {
                    if (!event.triggered && this.loopTime >= event.time) {
                        event.triggered = true;
                        event.action();
                    }
                });
            }

            render() {
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                this.ctx.save();
                this.ctx.translate(-this.cameraX, -this.cameraY);

                // Render rooms
                for (let roomId in ROOMS) {
                    const room = ROOMS[roomId];
                    this.ctx.fillStyle = room.color;
                    this.ctx.fillRect(room.x, room.y, room.width, room.height);

                    this.ctx.strokeStyle = room.locked ? '#f00' : '#0f0';
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeRect(room.x, room.y, room.width, room.height);

                    // Room name
                    this.ctx.fillStyle = '#0ff';
                    this.ctx.font = '14px Courier New';
                    this.ctx.fillText(room.name, room.x + 10, room.y + 25);
                }

                // Render NPCs
                for (let id in this.npcs) {
                    const npc = this.npcs[id];

                    this.ctx.fillStyle = npc.color;
                    this.ctx.beginPath();
                    this.ctx.arc(npc.x, npc.y, 15, 0, Math.PI * 2);
                    this.ctx.fill();

                    this.ctx.strokeStyle = '#000';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();

                    // Name label
                    this.ctx.fillStyle = npc.color;
                    this.ctx.font = 'bold 12px Courier New';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(npc.title, npc.x, npc.y - 25);
                    this.ctx.textAlign = 'left';
                }

                // Render player
                this.ctx.fillStyle = '#0f0';
                this.ctx.fillRect(this.player.x - 10, this.player.y - 10, 20, 20);
                this.ctx.strokeStyle = '#fff';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(this.player.x - 10, this.player.y - 10, 20, 20);

                // Render interactable highlight
                if (this.nearestInteractable && this.nearestInteractable.type === 'npc') {
                    const npc = this.npcs[this.nearestInteractable.id];
                    this.ctx.strokeStyle = '#ff0';
                    this.ctx.lineWidth = 3;
                    this.ctx.beginPath();
                    this.ctx.arc(npc.x, npc.y, 20, 0, Math.PI * 2);
                    this.ctx.stroke();
                }

                this.ctx.restore();

                // Render minimap
                this.renderMinimap();
            }

            renderMinimap() {
                const ctx = this.minimapCtx;
                const scale = 0.15;

                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 200, 200);

                // Rooms
                for (let roomId in ROOMS) {
                    const room = ROOMS[roomId];
                    ctx.fillStyle = room.color;
                    ctx.fillRect(room.x * scale, room.y * scale, room.width * scale, room.height * scale);
                    ctx.strokeStyle = '#0f0';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(room.x * scale, room.y * scale, room.width * scale, room.height * scale);
                }

                // NPCs
                for (let id in this.npcs) {
                    const npc = this.npcs[id];
                    ctx.fillStyle = npc.color;
                    ctx.beginPath();
                    ctx.arc(npc.x * scale, npc.y * scale, 3, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Player
                ctx.fillStyle = '#0f0';
                ctx.fillRect(this.player.x * scale - 2, this.player.y * scale - 2, 4, 4);
            }

            interact(type) {
                if (!this.nearestInteractable) return;

                if (type === 'talk' && this.nearestInteractable.type === 'npc') {
                    this.startDialogue(this.nearestInteractable.id);
                } else if (type === 'examine') {
                    this.examineInteractable();
                }
            }

            startDialogue(npcId) {
                const npc = this.npcs[npcId];
                this.currentDialogue = {npcId: npcId, state: 'greeting'};
                this.dialogueOpen = true;

                document.getElementById('dialogueSpeaker').textContent = npc.name.toUpperCase();

                // Determine dialogue based on state and clues
                let dialogueOptions = this.getDialogueOptions(npc);

                this.showDialogue(dialogueOptions.text, dialogueOptions.options);
            }

            getDialogueOptions(npc) {
                const options = [
                    {text: 'Tell me about yourself', action: () => this.dialogueAbout(npc)},
                    {text: '[ASK ABOUT REACTOR]', action: () => this.dialogueReactor(npc), requires: ['tremor_event']},
                    {text: '[WARN ABOUT DANGER]', action: () => this.dialogueWarn(npc)},
                    {text: '[ACCUSE OF SABOTAGE]', action: () => this.dialogueAccuse(npc), requires: ['camera_footage']},
                    {text: 'Nevermind', action: () => this.closeDialogue()}
                ];

                let text = npc.dialogue.default[0];

                // Context-specific dialogue
                if (npc.id === 'chen' && this.loopTime >= 330 && this.loopTime < 350 && !this.hasClue('server_password')) {
                    text = npc.dialogue.at_password_mention[0];
                }

                if (npc.id === 'patel' && this.loopTime >= 360 && !this.hasClue('reeves_motive')) {
                    text = npc.dialogue.found_evidence[0];
                }

                if (npc.warned) {
                    text = "I'll be careful. Thank you for the warning.";
                }

                if (npc.id === 'reeves' && this.hasClue('camera_footage') && this.hasClue('reeves_motive')) {
                    text = "You... you know something. I can see it in your eyes.";
                }

                return {text: text, options: options};
            }

            showDialogue(text, options) {
                document.getElementById('dialogueText').textContent = text;

                const optionsContainer = document.getElementById('dialogueOptions');
                optionsContainer.innerHTML = '';

                options.forEach(option => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'dialogueOption';
                    optionEl.textContent = option.text;

                    if (option.requires) {
                        const hasRequired = option.requires.every(clue => this.hasClue(clue));
                        if (!hasRequired) {
                            optionEl.classList.add('disabled');
                            return;
                        }
                    }

                    optionEl.addEventListener('click', () => option.action());
                    optionsContainer.appendChild(optionEl);
                });

                document.getElementById('dialogue').classList.add('visible');
            }

            dialogueAbout(npc) {
                let text = '';

                switch(npc.id) {
                    case 'vasquez':
                        text = "I'm Captain Vasquez. I've commanded Erebus for 3 years. Everything was fine until today.";
                        this.addClue('vasquez_schedule');
                        break;
                    case 'chen':
                        text = "I'm the medical officer. I also help with biological research in the lab.";
                        break;
                    case 'kowalski':
                        text = "Chief Engineer. I keep this bucket of bolts running. The reactor's been acting strange lately.";
                        break;
                    case 'drake':
                        text = "Security Officer Drake. I maintain order and safety. Nothing gets past me.";
                        break;
                    case 'patel':
                        text = "I study quantum phenomena. Fascinating field. The universe is stranger than you think.";
                        break;
                    case 'reeves':
                        text = "Just a technician. I fix things, maintain systems. Nothing special.";
                        break;
                }

                this.showDialogue(text, [{text: 'Back', action: () => this.startDialogue(npc.id)}]);
            }

            dialogueReactor(npc) {
                let text = '';

                if (npc.id === 'kowalski' && this.loopTime >= 240) {
                    text = "The diagnostics are showing critical anomalies. Something's wrong with the reactor core. I need to investigate.";
                    this.addClue('kowalski_locked');
                } else if (npc.id === 'vasquez') {
                    text = "The reactor? Kowalski would know more. Have you talked to him?";
                } else {
                    text = "I'm not the right person to ask about that.";
                }

                this.showDialogue(text, [{text: 'Back', action: () => this.startDialogue(npc.id)}]);
            }

            dialogueWarn(npc) {
                npc.warned = true;
                npc.trust += 10;

                let text = "A time loop? That's... hard to believe. But I'll be careful.";

                if (npc.trust > 70) {
                    text = "You've been right about other things. I trust you. What should I do?";
                }

                this.showDialogue(text, [{text: 'Stay safe', action: () => this.closeDialogue()}]);
            }

            dialogueAccuse(npc) {
                npc.accused = true;

                let text = '';

                if (npc.isSaboteur) {
                    if (this.hasClue('reeves_motive') && this.hasClue('camera_footage')) {
                        text = npc.dialogue.accused_with_evidence[0];
                        this.addClue('bomb_location');

                        // Win condition possible
                        const options = [
                            {text: '[DEMAND DISARM CODE]', action: () => this.reevesSurrender()},
                            {text: '[DETAIN HIM]', action: () => this.detainReeves()},
                            {text: 'Why?!', action: () => this.reevesMotive()}
                        ];

                        this.showDialogue(text, options);
                        return;
                    } else {
                        text = npc.dialogue.accused_no_evidence[0];
                    }
                } else {
                    text = npc.dialogue.accused[0] || "What?! How dare you accuse me!";
                    npc.trust -= 30;
                }

                this.showDialogue(text, [{text: 'Sorry...', action: () => this.closeDialogue()}]);
            }

            reevesSurrender() {
                this.addClue('bomb_code');
                this.showDialogue(
                    "Fine! The code is 0415. My daughter's birthday. Just... don't hurt me.",
                    [{text: 'Get out of my sight', action: () => this.closeDialogue()}]
                );
            }

            detainReeves() {
                this.npcs.reeves.detained = true;
                this.showDialogue(
                    "You restrain Reeves. He won't be going anywhere.",
                    [{text: 'Good', action: () => this.closeDialogue()}]
                );
            }

            reevesMotive() {
                this.showDialogue(
                    "They were going to shut down the station anyway! Everyone would lose their jobs! The insurance money... my family needs it. I'm sorry, but I had no choice!",
                    [{text: "There's always a choice", action: () => this.closeDialogue()}]
                );
            }

            examineInteractable() {
                if (!this.nearestInteractable) return;

                if (this.nearestInteractable.type === 'object') {
                    this.examineObject(this.nearestInteractable.id, this.nearestInteractable.room);
                }
            }

            examineObject(objectId, roomId) {
                let clueId = null;
                let message = '';

                switch(objectId) {
                    case 'locked_drawer':
                        if (this.hasClue('captain_override')) {
                            message = 'You already found the override code.';
                        } else {
                            message = 'You find a data chip with emergency codes!';
                            clueId = 'captain_override';
                        }
                        break;
                    case 'engineering_manual':
                        message = 'You spend time reading the reactor shutdown procedure...';
                        clueId = 'reactor_shutdown';
                        break;
                    case 'security_terminal':
                        if (!this.hasClue('server_password')) {
                            message = 'LOCKED - Password required.';
                        } else if (this.hasClue('camera_footage')) {
                            message = 'You already reviewed the footage.';
                        } else {
                            message = 'You access the camera feeds and review footage from 03:30...';
                            clueId = 'camera_footage';
                        }
                        break;
                    case 'data_core':
                        if (this.loopTime >= 360) {
                            message = 'You examine the financial records Dr. Patel found...';
                            clueId = 'reeves_motive';

                            if (this.hasClue('reeves_motive') && !this.hasClue('previous_looper')) {
                                message += ' Wait... there\'s a hidden message in the system logs!';
                                this.addClue('previous_looper');
                            }
                        } else {
                            message = 'Complex research data. Nothing stands out yet.';
                        }
                        break;
                    case 'personal_pad':
                        if (roomId === 'crewQuarters3') {
                            message = 'Reeves\' personal notes. You find a birthday reminder: 0415';
                            clueId = 'bomb_code';
                        } else {
                            message = 'Personal notes and photos. Nothing useful.';
                        }
                        break;
                    case 'reactor_console':
                        if (this.hasClue('bomb_location')) {
                            message = 'You can see the bomb hidden in the access panel.';

                            if (this.hasClue('bomb_code')) {
                                this.showBombDisarmPrompt();
                                return;
                            }
                        } else {
                            message = 'The reactor console shows increasing temperature readings.';
                        }
                        break;
                    case 'airlock_controls':
                        message = 'Emergency evacuation system. Requires captain\'s authorization.';
                        clueId = 'evacuation_protocol';
                        break;
                    default:
                        message = 'Nothing particularly interesting.';
                }

                if (clueId) {
                    this.addClue(clueId);
                }

                this.showNotification(message);
            }

            showBombDisarmPrompt() {
                this.showOverlay(
                    'DISARM BOMB',
                    'You can see the explosive device. Enter the disarm code:',
                    [
                        {text: 'Enter 0415', action: () => this.disarmBomb()},
                        {text: 'Cancel', action: () => this.closeOverlay()}
                    ]
                );
            }

            disarmBomb() {
                this.closeOverlay();
                this.showNotification('BOMB DISARMED! The reactor is safe!');
                this.playSound('success');

                // Check for best ending
                setTimeout(() => {
                    this.checkBestEnding();
                }, 2000);
            }

            checkBestEnding() {
                const allAlive = true; // In this implementation, we're assuming they survive if bomb is disarmed
                const hasEvidence = this.hasClue('camera_footage') && this.hasClue('reeves_motive');
                const confrontedReeves = this.npcs.reeves.accused;

                if (allAlive && hasEvidence && confrontedReeves) {
                    this.triggerEnding('best');
                } else {
                    this.triggerEnding('good');
                }
            }

            closeDialogue() {
                this.dialogueOpen = false;
                this.currentDialogue = null;
                document.getElementById('dialogue').classList.remove('visible');
            }

            addClue(clueId) {
                if (this.discoveredClues.has(clueId)) return;

                const clue = CLUES[clueId];
                if (!clue) return;

                // Check requirements
                if (clue.requires && clue.requires.length > 0) {
                    const hasRequired = clue.requires.every(req => this.hasClue(req));
                    if (!hasRequired) return;
                }

                this.discoveredClues.add(clueId);
                this.saveClues();
                this.showNotification(`NEW CLUE: ${clue.title}`);
                this.playSound('clue');
                this.updateJournal();
            }

            hasClue(clueId) {
                return this.discoveredClues.has(clueId);
            }

            toggleJournal() {
                const journal = document.getElementById('journal');
                journal.classList.toggle('visible');

                if (journal.classList.contains('visible')) {
                    this.updateJournal();
                }
            }

            filterJournal(category) {
                this.journalFilter = category;

                document.querySelectorAll('.journalTab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.category === category) {
                        tab.classList.add('active');
                    }
                });

                this.updateJournal();
            }

            updateJournal() {
                const content = document.getElementById('journalContent');
                content.innerHTML = '';

                const clues = Array.from(this.discoveredClues).map(id => CLUES[id]).filter(c => c);

                const filtered = this.journalFilter === 'all'
                    ? clues
                    : clues.filter(c => c.category === this.journalFilter);

                if (filtered.length === 0) {
                    content.innerHTML = '<div class="clue"><div class="clueText">No clues discovered yet in this category.</div></div>';
                    return;
                }

                filtered.forEach(clue => {
                    const clueEl = document.createElement('div');
                    clueEl.className = 'clue';
                    clueEl.innerHTML = `
                        <div class="clueTitle">${clue.title}</div>
                        <div class="clueText">${clue.text}</div>
                        <div class="clueTime">Loop ${this.loopCount} - ${clue.category.toUpperCase()}</div>
                    `;
                    content.appendChild(clueEl);
                });
            }

            closeAllPanels() {
                document.getElementById('journal').classList.remove('visible');
                this.closeDialogue();
                this.closeOverlay();
            }

            showOverlay(title, text, buttons) {
                document.getElementById('overlayTitle').textContent = title;
                document.getElementById('overlayText').textContent = text;

                const buttonsContainer = document.getElementById('overlayButtons');
                buttonsContainer.innerHTML = '';

                buttons.forEach(btn => {
                    const btnEl = document.createElement('button');
                    btnEl.className = 'btn';
                    btnEl.textContent = btn.text;
                    btnEl.addEventListener('click', btn.action);
                    buttonsContainer.appendChild(btnEl);
                });

                document.getElementById('overlay').classList.add('visible');
            }

            closeOverlay() {
                document.getElementById('overlay').classList.remove('visible');
            }

            showNotification(text) {
                const notif = document.getElementById('notification');
                notif.textContent = text;
                notif.classList.add('visible');

                setTimeout(() => {
                    notif.classList.remove('visible');
                }, 3000);
            }

            updateRoomInfo() {
                const room = ROOMS[this.player.currentRoom];
                document.getElementById('roomName').textContent = room.name;
                document.getElementById('roomDesc').textContent = room.desc;
            }

            triggerTremor() {
                this.addClue('tremor_event');
                this.showNotification('The station shakes! A minor tremor!');
                this.playSound('tremor');
            }

            kowalskiFindsWarning() {
                if (this.player.currentRoom === 'engineering') {
                    this.showNotification('Kowalski: "The reactor readings are all wrong!"');
                }
            }

            kowalskiGetLocked() {
                this.showNotification('You hear distant shouting from the Server Room!');
            }

            patelFindsEvidence() {
                if (this.player.currentRoom === 'lab') {
                    this.showNotification('Dr. Patel: "I found something strange in the financial records..."');
                }
            }

            evacuationAlarm() {
                this.showNotification('EVACUATION ALARM! WARNING: REACTOR CRITICAL!');
                this.playSound('alarm');
            }

            panicMode() {
                this.showNotification('Crew members are panicking!');
            }

            resetLoop() {
                this.loopCount++;
                document.getElementById('loopCounter').textContent = `LOOP: ${this.loopCount}`;

                this.playSound('loop_reset');

                // Flash effect
                this.ctx.fillStyle = '#fff';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Reset state
                this.loopStartTime = Date.now();
                this.loopTime = 0;

                // Reset player position
                const bridge = ROOMS.bridge;
                this.player.x = bridge.x + bridge.width / 2;
                this.player.y = bridge.y + bridge.height / 2;
                this.player.currentRoom = 'bridge';
                this.player.moving = false;

                // Reset NPCs
                this.initializeNPCs();

                // Reset events
                this.gameEvents.forEach(e => e.triggered = false);

                // Close all panels
                this.closeAllPanels();

                this.showNotification('TIME RESET - LOOP ' + this.loopCount);
            }

            triggerEnding(type) {
                this.gameRunning = false;
                cancelAnimationFrame(this.animationId);

                let title = '';
                let text = '';

                switch(type) {
                    case 'best':
                        title = 'PERFECT ENDING';
                        text = `You disarmed the bomb and exposed Reeves with irrefutable evidence. Captain Vasquez takes him into custody. The station is saved, and all crew members survive. You finally break free from the loop.\n\nLoops completed: ${this.loopCount}\n\nYou are free.`;
                        break;
                    case 'good':
                        title = 'GOOD ENDING';
                        text = `You managed to prevent the explosion and save the station. While some questions remain unanswered, everyone survives.\n\nLoops completed: ${this.loopCount}\n\nThe loop is broken.`;
                        break;
                    case 'neutral':
                        title = 'ESCAPE ENDING';
                        text = `You escaped through the airlock before the explosion. You survived, but the others... didn't make it. The loop is broken, but at what cost?\n\nLoops completed: ${this.loopCount}`;
                        break;
                    case 'bad':
                        title = 'BAD ENDING';
                        text = `Your accusations caused chaos and panic. In the confusion, nobody could prevent the disaster. Everyone died.\n\nLoops completed: ${this.loopCount}\n\nTry again?`;
                        break;
                }

                this.endings.add(type);
                this.saveEndings();

                this.showOverlay(title, text, [
                    {text: 'Return to Title', action: () => this.returnToTitle()},
                    {text: 'Continue Loop', action: () => this.continueAfterEnding()}
                ]);
            }

            returnToTitle() {
                this.closeOverlay();
                location.reload();
            }

            continueAfterEnding() {
                this.closeOverlay();
                this.gameRunning = true;
                this.resetLoop();
                this.gameLoop(performance.now());
            }

            getDistance(obj1, obj2) {
                const dx = obj1.x - obj2.x;
                const dy = obj1.y - obj2.y;
                return Math.sqrt(dx * dx + dy * dy);
            }

            playSound(type) {
                // Simple Web Audio API sound generation
                const ctx = this.audioContext;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                switch(type) {
                    case 'start':
                        oscillator.frequency.value = 440;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.5);
                        break;
                    case 'clue':
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.3);
                        break;
                    case 'loop_reset':
                        oscillator.frequency.value = 200;
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.4, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 1);
                        break;
                    case 'tremor':
                        oscillator.frequency.value = 100;
                        oscillator.type = 'triangle';
                        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.8);
                        break;
                    case 'alarm':
                        oscillator.frequency.value = 1000;
                        oscillator.type = 'square';
                        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.5);
                        break;
                    case 'success':
                        oscillator.frequency.value = 600;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.7);
                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.7);
                        break;
                }
            }

            loadClues() {
                const saved = localStorage.getItem('chronoscape_clues');
                return saved ? new Set(JSON.parse(saved)) : new Set();
            }

            saveClues() {
                localStorage.setItem('chronoscape_clues', JSON.stringify(Array.from(this.discoveredClues)));
            }

            loadEndings() {
                const saved = localStorage.getItem('chronoscape_endings');
                return saved ? new Set(JSON.parse(saved)) : new Set();
            }

            saveEndings() {
                localStorage.setItem('chronoscape_endings', JSON.stringify(Array.from(this.endings)));
            }
        }

        // Initialize game
        let game;
        window.addEventListener('load', () => {
            game = new Game();
        });
    </script>
</body>
</html>