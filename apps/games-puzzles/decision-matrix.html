<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decision Arena - Strategic Choice Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0d1117; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; touch-action: none; }
        canvas { display: block; }
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #ui > * { pointer-events: auto; }
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.88);
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        .box {
            background: linear-gradient(145deg, #161b22, #0d1117);
            border: 2px solid #3b82f6;
            border-radius: 20px; padding: 35px;
            text-align: center; max-width: 550px; width: 92%;
            box-shadow: 0 0 50px rgba(59,130,246,0.3);
            max-height: 90vh; overflow-y: auto;
        }
        .box h1 { color: #58a6ff; font-size: 2rem; margin-bottom: 8px; text-shadow: 0 0 15px rgba(88,166,255,0.5); }
        .box h2 { color: #8b949e; font-size: 1.1rem; margin-bottom: 20px; font-weight: normal; }
        .box p { color: #6e7681; font-size: 0.85rem; margin-bottom: 15px; line-height: 1.5; }
        .mbtn {
            display: block; width: 100%; padding: 13px; margin: 8px 0;
            font-size: 1rem; font-weight: bold;
            border: 2px solid #3b82f6; border-radius: 12px;
            background: linear-gradient(135deg, #161b22, #1f2937);
            color: #58a6ff; cursor: pointer; transition: all 0.2s;
            letter-spacing: 1px;
        }
        .mbtn:hover { background: linear-gradient(135deg, #1f2937, #2d3748); border-color: #58a6ff; transform: translateY(-2px); box-shadow: 0 4px 20px rgba(59,130,246,0.4); }
        .mbtn.sm { padding: 10px; font-size: 0.85rem; }
        .drow { display: flex; gap: 8px; margin: 12px 0; }
        .dbtn { flex: 1; padding: 10px; font-size: 0.85rem; border: 2px solid #30363d; border-radius: 10px; background: #0d1117; color: #6e7681; cursor: pointer; transition: all 0.2s; }
        .dbtn.on { border-color: #3b82f6; color: #58a6ff; background: #161b22; box-shadow: 0 0 12px rgba(59,130,246,0.2); }
        .stat { display: flex; justify-content: space-between; padding: 5px 0; color: #8b949e; font-size: 0.88rem; border-bottom: 1px solid #21262d; }
        .stat span:last-child { color: #58a6ff; font-weight: bold; }
        .choice-card {
            background: #161b22; border: 2px solid #30363d; border-radius: 12px;
            padding: 15px; margin: 8px 0; cursor: pointer; transition: all 0.2s; text-align: left;
        }
        .choice-card:hover { border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(59,130,246,0.2); }
        .choice-card h3 { color: #58a6ff; font-size: 1rem; margin-bottom: 6px; }
        .choice-card p { color: #8b949e; font-size: 0.8rem; margin: 0; }
        .bar-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
        .bar-label { color: #6e7681; font-size: 0.7rem; width: 60px; text-align: right; }
        .bar-bg { flex: 1; height: 8px; background: #21262d; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .hint { position: fixed; top: 8px; right: 12px; color: rgba(88,166,255,0.25); font-size: 0.7rem; pointer-events: none; z-index: 5; }
    </style>
</head>
<body>
<canvas id="c"></canvas>
<div class="hint">ESC = Pause | R = Restart</div>
<div id="ui"></div>
<script>
// === AUDIO ===
let AC = null;
function initA() { if (!AC) AC = new (window.AudioContext || window.webkitAudioContext)(); }
function snd(t,f,d,v) {
    if (!AC) return;
    const o=AC.createOscillator(),g=AC.createGain();
    o.type=t; o.frequency.value=f;
    g.gain.setValueAtTime(v||0.12,AC.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,AC.currentTime+d);
    o.connect(g); g.connect(AC.destination); o.start(); o.stop(AC.currentTime+d);
}
function sfxClick() { snd('triangle',600,0.05); }
function sfxGood() { snd('sine',660,0.1); setTimeout(()=>snd('sine',880,0.12),80); setTimeout(()=>snd('sine',1100,0.15),160); }
function sfxGreat() { [523,659,784,1047].forEach((f,i)=>setTimeout(()=>snd('square',f,0.1),i*80)); }
function sfxBad() { snd('sawtooth',250,0.15); setTimeout(()=>snd('sawtooth',180,0.2),100); }
function sfxCritical() { snd('sawtooth',100,0.3,0.15); setTimeout(()=>snd('sawtooth',60,0.4),150); }
function sfxBoss() { for(let i=0;i<5;i++) setTimeout(()=>snd('sawtooth',100+i*25,0.1,0.12),i*60); }
function sfxVictory() { [523,587,659,784,880,1047].forEach((f,i)=>setTimeout(()=>snd('square',f,0.12),i*100)); }
function sfxDefeat() { [440,415,392,370,349,330].forEach((f,i)=>setTimeout(()=>snd('sawtooth',f,0.2),i*130)); }
function sfxLevelUp() { [440,554,660,880].forEach((f,i)=>setTimeout(()=>snd('sine',f,0.12),i*60)); }

// === CANVAS ===
const cv=document.getElementById('c'),cx=cv.getContext('2d');
let W,H;
function resize(){W=cv.width=innerWidth;H=cv.height=innerHeight;}
addEventListener('resize',resize); resize();

// === SCENARIOS ===
const SCENARIO_THEMES = [
    { name: 'Kingdom Management', icon: 'crown', color: '#ffd700',
      resources: ['Gold','Army','People','Faith','Knowledge'],
      intro: 'As ruler of the realm, each decision shapes your kingdom.' },
    { name: 'Space Colony', icon: 'rocket', color: '#00ccff',
      resources: ['Fuel','Crew','Hull','Research','Morale'],
      intro: 'Your colony ship drifts through deep space. Resources dwindle.' },
    { name: 'Startup CEO', icon: 'chart', color: '#44ff88',
      resources: ['Capital','Talent','Users','Tech','Reputation'],
      intro: 'Your startup has one year of runway. Every quarter matters.' },
    { name: 'Dungeon Master', icon: 'sword', color: '#ff6644',
      resources: ['HP','Mana','Loot','Reputation','Party'],
      intro: 'You lead an adventuring party through perilous dungeons.' },
    { name: 'Apocalypse Survivor', icon: 'skull', color: '#ff4466',
      resources: ['Food','Water','Shelter','Weapons','Hope'],
      intro: 'The world has ended. Your settlement depends on you.' },
];

function generateScenario(theme, round, diff) {
    const templates = [
        { title: 'Resource Crisis', desc: `Your ${theme.resources[0]} reserves are critically low.`,
          choices: [
            { name: 'Conservative Approach', desc: 'Reduce spending, tighten belts', effects: [15,-5,5,-5,10], risk: 0.1 },
            { name: 'Bold Investment', desc: 'Spend big now to earn later', effects: [-20,10,-5,15,-5], risk: 0.3 },
            { name: 'Diplomatic Solution', desc: 'Negotiate with allies for aid', effects: [10,0,10,5,-10], risk: 0.2 },
          ]},
        { title: 'Internal Conflict', desc: `Factions within your ${theme.resources[4]} are divided.`,
          choices: [
            { name: 'Side with Majority', desc: 'Support the popular faction', effects: [-5,-5,15,-5,10], risk: 0.15 },
            { name: 'Side with Minority', desc: 'The underdogs have a bold plan', effects: [-10,10,-10,20,-5], risk: 0.35 },
            { name: 'Remain Neutral', desc: 'Let them work it out themselves', effects: [0,0,-5,0,5], risk: 0.05 },
            { name: 'Create New Faction', desc: 'Merge the best of both', effects: [-15,5,5,15,15], risk: 0.4 },
          ]},
        { title: 'Opportunity Knocks', desc: `A rare chance to boost your ${theme.resources[3]}.`,
          choices: [
            { name: 'Seize It', desc: 'All in on this opportunity', effects: [-25,5,-10,30,10], risk: 0.25 },
            { name: 'Partial Commitment', desc: 'Invest some resources cautiously', effects: [-10,0,-5,15,5], risk: 0.1 },
            { name: 'Decline', desc: 'Too risky right now', effects: [5,0,5,-5,-5], risk: 0 },
          ]},
        { title: 'External Threat', desc: `${theme.resources[1]} forces detect an incoming danger.`,
          choices: [
            { name: 'Fortify Defenses', desc: 'Hunker down and prepare', effects: [-15,15,5,0,10], risk: 0.1 },
            { name: 'Preemptive Strike', desc: 'Attack before they arrive', effects: [-10,10,-5,5,-5], risk: 0.3 },
            { name: 'Evacuate', desc: 'Retreat to safety', effects: [-20,-10,15,-5,5], risk: 0.15 },
            { name: 'Negotiate', desc: 'Try to find common ground', effects: [-5,-5,10,10,5], risk: 0.2 },
          ]},
        { title: 'Discovery', desc: `Your scouts found something that could change everything.`,
          choices: [
            { name: 'Full Expedition', desc: 'Send your best team to investigate', effects: [-20,-10,-5,25,15], risk: 0.3 },
            { name: 'Small Recon', desc: 'Send scouts for more info first', effects: [-5,-5,0,10,5], risk: 0.1 },
            { name: 'Sell the Info', desc: 'Trade the discovery for immediate gains', effects: [20,0,5,-10,-5], risk: 0.05 },
          ]},
        { title: 'Moral Dilemma', desc: `Your ${theme.resources[2]} face an ethical crossroads.`,
          choices: [
            { name: 'The Righteous Path', desc: 'Do what is ethical, regardless of cost', effects: [-15,-5,20,-5,15], risk: 0.05 },
            { name: 'The Pragmatic Path', desc: 'Practical wins over ideals', effects: [15,5,-10,10,-10], risk: 0.15 },
            { name: 'The Middle Ground', desc: 'Compromise where possible', effects: [0,0,5,5,5], risk: 0.1 },
          ]},
        { title: 'Power Surge', desc: `A sudden abundance of ${theme.resources[Math.floor(Math.random()*5)]}.`,
          choices: [
            { name: 'Stockpile', desc: 'Save it for a rainy day', effects: [20,5,5,0,5], risk: 0 },
            { name: 'Distribute', desc: 'Share the wealth evenly', effects: [5,5,15,5,10], risk: 0.05 },
            { name: 'Invest Aggressively', desc: 'Multiply through bold action', effects: [-10,10,0,20,0], risk: 0.35 },
            { name: 'Sell to Outsiders', desc: 'Trade for something you need more', effects: [10,-5,-5,15,-5], risk: 0.15 },
          ]},
    ];

    const scenario = templates[Math.floor(Math.random() * templates.length)];
    // Scale effects by difficulty and round
    const scale = 1 + round * 0.1 + diff * 0.15;
    const scaled = JSON.parse(JSON.stringify(scenario));
    for (const c of scaled.choices) {
        c.effects = c.effects.map(e => Math.round(e * scale));
        c.risk = Math.min(0.8, c.risk + diff * 0.05 + round * 0.01);
    }
    return scaled;
}

function generateBossScenario(theme, round) {
    return {
        title: 'CRISIS EVENT',
        desc: 'Everything hangs in the balance. This decision will define your legacy.',
        boss: true,
        choices: [
            { name: 'Sacrifice Resources', desc: 'Give up what you have for future gain', effects: [-30,-20,-15,25,20], risk: 0.2 },
            { name: 'Rally Everything', desc: 'All resources, all energy, one final push', effects: [-15,20,-10,20,30], risk: 0.4 },
            { name: 'Strategic Retreat', desc: 'Lose ground now, position for later', effects: [10,-15,15,10,-10], risk: 0.1 },
            { name: 'Wildcard Gamble', desc: 'Trust fate. Double or nothing.', effects: [0,0,0,0,0], risk: 0.5, wildcard: true },
        ]
    };
}

// === STATE ===
let state = 'menu';
let diff = 1;
const DIFF_NAMES = ['Easy','Normal','Hard'];
let themeIdx = 0;
let resources = [50,50,50,50,50]; // Each resource 0-100
let round = 0, score = 0, streak = 0, maxStreak = 0;
let currentScenario = null;
let showingResult = false;
let resultText = '';
let resultColor = '';
let gameHistory = [];
let particles = [];
let shakeX = 0, shakeY = 0, shakeDur = 0;
let bgNodes = [];
let resourceBars = []; // animation targets

// Persistence
let highScores = [], gamesPlayed = 0, totalWins = 0, bestRound = 0;
function loadSave() {
    try {
        const d = JSON.parse(localStorage.getItem('decision-arena-save'));
        if (d) { highScores = d.hs||[]; gamesPlayed = d.gp||0; totalWins = d.tw||0; bestRound = d.br||0; }
    } catch(e) {}
}
function saveSave() {
    localStorage.setItem('decision-arena-save', JSON.stringify({ hs: highScores, gp: gamesPlayed, tw: totalWins, br: bestRound }));
}
loadSave();

// Background nodes
for (let i = 0; i < 40; i++) {
    bgNodes.push({
        x: Math.random()*2000, y: Math.random()*2000,
        vx: (Math.random()-0.5)*0.3, vy: (Math.random()-0.5)*0.3,
        size: 2+Math.random()*3, alpha: 0.1+Math.random()*0.2
    });
}

// === PARTICLES ===
function spawn(x,y,n,color,spd) {
    for (let i=0;i<n;i++) {
        const a=Math.random()*Math.PI*2, s=(0.5+Math.random())*(spd||3);
        particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,decay:0.01+Math.random()*0.02,size:2+Math.random()*3,color});
    }
}
function shake(intensity,dur) { shakeX=(Math.random()-0.5)*intensity; shakeY=(Math.random()-0.5)*intensity; shakeDur=dur; }

// === GAME LOGIC ===
function startGame() {
    initA();
    resources = diff===0 ? [60,60,60,60,60] : diff===1 ? [50,50,50,50,50] : [40,40,40,40,40];
    round = 0; score = 0; streak = 0; maxStreak = 0;
    gameHistory = [];
    showingResult = false;
    currentScenario = null;
    state = 'playing';
    sfxClick();
    nextRound();
}

function nextRound() {
    round++;
    if (round > bestRound) bestRound = round;
    const theme = SCENARIO_THEMES[themeIdx];

    if (round % 5 === 0) {
        currentScenario = generateBossScenario(theme, round);
        sfxBoss();
    } else {
        currentScenario = generateScenario(theme, round, diff);
    }

    showScenario();
}

function makeChoice(choiceIdx) {
    if (showingResult || state !== 'playing') return;
    const theme = SCENARIO_THEMES[themeIdx];
    const choice = currentScenario.choices[choiceIdx];
    sfxClick();

    // Apply effects
    let effects = [...choice.effects];

    // Wildcard: random effects
    if (choice.wildcard) {
        if (Math.random() < 0.5) {
            effects = effects.map(() => Math.round((Math.random()-0.3) * 40));
        } else {
            effects = effects.map(() => Math.round(Math.random() * 30));
        }
    }

    // Risk check
    const risked = Math.random() < choice.risk;
    if (risked) {
        // Risk triggered: effects are halved and partially inverted
        effects = effects.map(e => e > 0 ? Math.round(e * -0.3) : Math.round(e * 1.5));
    }

    // Apply
    let totalGain = 0;
    for (let i = 0; i < 5; i++) {
        resources[i] = Math.max(0, Math.min(100, resources[i] + effects[i]));
        totalGain += effects[i];
    }

    // Scoring
    const avgResource = resources.reduce((a,b)=>a+b,0) / 5;
    const balance = 100 - (Math.max(...resources) - Math.min(...resources)); // Higher = more balanced
    const roundScore = Math.round(avgResource * 2 + balance + totalGain * 0.5);
    score += Math.max(0, roundScore);

    // Streak
    if (totalGain > 0 && !risked) {
        streak++;
        if (streak > maxStreak) maxStreak = streak;
        if (streak >= 3) score += streak * 10;
    } else {
        streak = 0;
    }

    // Visual feedback
    if (risked) {
        shake(12, 10);
        spawn(W/2, H/2, 30, '#ff4466', 5);
        sfxBad();
        resultText = 'RISK TRIGGERED! Effects partially inverted.';
        resultColor = '#ff4466';
    } else if (totalGain > 15) {
        shake(5, 4);
        spawn(W/2, H/2, 25, '#44ff88', 4);
        sfxGreat();
        resultText = 'Excellent decision! Resources boosted significantly.';
        resultColor = '#44ff88';
    } else if (totalGain > 0) {
        sfxGood();
        spawn(W/2, H/2, 15, '#58a6ff', 3);
        resultText = 'Good choice. Steady progress.';
        resultColor = '#58a6ff';
    } else {
        shake(3, 3);
        sfxBad();
        resultText = 'That cost you. Resources depleted.';
        resultColor = '#ff8844';
    }

    gameHistory.push({
        round, title: currentScenario.title,
        choice: choice.name, risked,
        effects, totalGain, score: roundScore
    });

    // Check game over
    const dead = resources.filter(r => r <= 0).length;
    const allLow = resources.filter(r => r < 10).length;
    if (dead >= 2 || (diff === 2 && dead >= 1) || allLow >= 4) {
        showingResult = true;
        setTimeout(() => endGame(false), 1500);
        showResult();
        return;
    }

    // Win condition: survive 20 rounds
    if (round >= 20) {
        showingResult = true;
        setTimeout(() => endGame(true), 1500);
        showResult();
        return;
    }

    showingResult = true;
    showResult();
    setTimeout(() => {
        showingResult = false;
        nextRound();
    }, 2000);
}

function endGame(won) {
    state = 'gameover';
    gamesPlayed++;
    if (won) { totalWins++; sfxVictory(); }
    else sfxDefeat();

    let ending = '';
    const avg = resources.reduce((a,b)=>a+b,0)/5;
    if (won && avg >= 70) ending = 'Master Strategist';
    else if (won && maxStreak >= 8) ending = 'Streak Legend';
    else if (won) ending = 'Survivor';
    else if (round >= 15) ending = 'Almost There';
    else if (round >= 10) ending = 'Halfway Hero';
    else ending = 'Quick Collapse';

    highScores.push({ score, round, streak: maxStreak, diff: DIFF_NAMES[diff], ending, theme: SCENARIO_THEMES[themeIdx].name, date: new Date().toLocaleDateString() });
    highScores.sort((a,b) => b.score - a.score);
    highScores = highScores.slice(0, 10);
    saveSave();
    showGameOver(won, ending);
}

// === DRAW ===
function drawBg(t) {
    const grad = cx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0,'#080c14');
    grad.addColorStop(0.5,'#0d1117');
    grad.addColorStop(1,'#0a0e16');
    cx.fillStyle = grad;
    cx.fillRect(0,0,W,H);

    // Network nodes
    for (const n of bgNodes) {
        n.x = (n.x + n.vx + W) % W;
        n.y = (n.y + n.vy + H) % H;
        cx.globalAlpha = n.alpha;
        cx.fillStyle = '#3b82f6';
        cx.beginPath();
        cx.arc(n.x, n.y, n.size, 0, Math.PI*2);
        cx.fill();
    }
    // Draw connections
    cx.strokeStyle = 'rgba(59,130,246,0.05)';
    cx.lineWidth = 1;
    for (let i = 0; i < bgNodes.length; i++) {
        for (let j = i+1; j < bgNodes.length; j++) {
            const dx = bgNodes[i].x - bgNodes[j].x;
            const dy = bgNodes[i].y - bgNodes[j].y;
            if (dx*dx+dy*dy < 15000) {
                cx.beginPath();
                cx.moveTo(bgNodes[i].x, bgNodes[i].y);
                cx.lineTo(bgNodes[j].x, bgNodes[j].y);
                cx.stroke();
            }
        }
    }
    cx.globalAlpha = 1;

    // Resource bars at top
    if (state === 'playing' || state === 'gameover') {
        const theme = SCENARIO_THEMES[themeIdx];
        const barW = Math.min(120, (W - 100) / 5);
        const barH = 12;
        const startX = (W - barW * 5 - 40) / 2;
        const barY = 15;

        for (let i = 0; i < 5; i++) {
            const x = startX + i * (barW + 10);
            const val = resources[i];
            const color = val > 60 ? '#44ff88' : val > 30 ? '#ffaa44' : '#ff4466';

            cx.fillStyle = 'rgba(0,0,0,0.5)';
            cx.fillRect(x, barY, barW, barH);
            cx.fillStyle = color;
            cx.fillRect(x, barY, barW * (val / 100), barH);
            cx.strokeStyle = '#30363d';
            cx.lineWidth = 1;
            cx.strokeRect(x, barY, barW, barH);

            cx.fillStyle = '#8b949e';
            cx.font = '10px sans-serif';
            cx.textAlign = 'center';
            cx.fillText(`${theme.resources[i]}: ${val}`, x + barW/2, barY + barH + 14);
        }

        // Score and round
        cx.fillStyle = '#58a6ff';
        cx.font = 'bold 16px sans-serif';
        cx.textAlign = 'left';
        cx.fillText(`Score: ${score}`, 15, H - 25);

        if (streak > 1) {
            cx.fillStyle = '#ffd700';
            cx.font = 'bold 14px sans-serif';
            cx.fillText(`Streak: ${streak}`, 15, H - 45);
        }

        cx.fillStyle = '#8b949e';
        cx.font = '13px sans-serif';
        cx.textAlign = 'right';
        cx.fillText(`Round ${round}/20`, W - 15, H - 25);
        cx.fillText(DIFF_NAMES[diff], W - 15, H - 45);
    }

    // Particles
    for (let i = particles.length-1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx; p.y += p.vy; p.vy += 0.04; p.life -= p.decay;
        if (p.life <= 0) { particles.splice(i,1); continue; }
        cx.globalAlpha = p.life;
        cx.fillStyle = p.color;
        cx.beginPath();
        cx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        cx.fill();
    }
    cx.globalAlpha = 1;

    // Shake
    if (shakeDur > 0) { shakeDur--; shakeX=(Math.random()-0.5)*shakeDur*1.5; shakeY=(Math.random()-0.5)*shakeDur*1.5; }
    else { shakeX=0; shakeY=0; }
}

function draw(t) {
    resize();
    cx.save();
    cx.translate(shakeX, shakeY);
    drawBg(t);
    cx.restore();
}

// === MENUS ===
function showMenu() {
    const ui = document.getElementById('ui');
    let hsHTML = '';
    if (highScores.length > 0) {
        hsHTML = '<div style="margin-top:10px;">';
        for (let i = 0; i < Math.min(5, highScores.length); i++) {
            const h = highScores[i];
            hsHTML += `<div class="stat"><span>#${i+1} ${h.ending} (${h.theme})</span><span>${h.score}</span></div>`;
        }
        hsHTML += '</div>';
    }
    ui.innerHTML = `<div class="overlay" id="mm"><div class="box">
        <h1>DECISION ARENA</h1>
        <h2>Strategic Choice Game</h2>
        <p>Manage 5 resources across 20 rounds of tough decisions. Each choice has risks and rewards. Balance your resources, build streaks, and survive.</p>
        <div style="margin-bottom:12px;">
            <div style="color:#8b949e;font-size:0.85rem;margin-bottom:6px;">Theme:</div>
            <div class="drow">
                ${SCENARIO_THEMES.map((t,i) => `<button class="dbtn ${themeIdx===i?'on':''}" onclick="themeIdx=${i};showMenu();" style="font-size:0.7rem;">${t.name}</button>`).join('')}
            </div>
        </div>
        <div style="margin-bottom:12px;">
            <div style="color:#8b949e;font-size:0.85rem;margin-bottom:6px;">Difficulty:</div>
            <div class="drow">
                <button class="dbtn ${diff===0?'on':''}" onclick="diff=0;showMenu();">Easy</button>
                <button class="dbtn ${diff===1?'on':''}" onclick="diff=1;showMenu();">Normal</button>
                <button class="dbtn ${diff===2?'on':''}" onclick="diff=2;showMenu();">Hard</button>
            </div>
            <div style="color:#6e7681;font-size:0.7rem;">
                ${diff===0?'Start 60/100, lower risk':diff===1?'Start 50/100, moderate risk':'Start 40/100, higher risk, 1 depleted = game over'}
            </div>
        </div>
        <button class="mbtn" onclick="document.getElementById('mm').remove();startGame();">Begin</button>
        ${hsHTML ? '<div style="color:#8b949e;font-size:0.85rem;margin-top:10px;">High Scores:</div>' + hsHTML : ''}
    </div></div>`;
}

function showScenario() {
    const ui = document.getElementById('ui');
    const s = currentScenario;
    const theme = SCENARIO_THEMES[themeIdx];
    const isBoss = s.boss || false;

    let choicesHTML = '';
    for (let i = 0; i < s.choices.length; i++) {
        const c = s.choices[i];
        let barsHTML = '';
        for (let j = 0; j < 5; j++) {
            const e = c.effects[j];
            const color = e > 0 ? '#44ff88' : e < 0 ? '#ff4466' : '#6e7681';
            const width = Math.abs(e);
            barsHTML += `<div class="bar-row">
                <span class="bar-label">${theme.resources[j]}</span>
                <div class="bar-bg"><div class="bar-fill" style="width:${Math.min(width,100)}%;background:${color};"></div></div>
                <span style="color:${color};font-size:0.7rem;width:30px;">${e>0?'+':''}${e}</span>
            </div>`;
        }
        const riskColor = c.risk < 0.15 ? '#44ff88' : c.risk < 0.3 ? '#ffaa44' : '#ff4466';
        choicesHTML += `<div class="choice-card" onclick="makeChoice(${i})">
            <h3>${c.name} ${c.wildcard?'[WILDCARD]':''}</h3>
            <p>${c.desc}</p>
            ${barsHTML}
            <div style="margin-top:6px;color:${riskColor};font-size:0.7rem;">Risk: ${Math.round(c.risk*100)}%</div>
        </div>`;
    }

    ui.innerHTML = `<div class="overlay" id="scenario"><div class="box" style="max-width:600px;">
        <div style="color:${isBoss ? '#ff4466' : '#8b949e'};font-size:0.8rem;margin-bottom:5px;">
            ${isBoss ? 'BOSS EVENT' : `Round ${round}/20`} | ${theme.name}
        </div>
        <h1 style="font-size:1.5rem;${isBoss?'color:#ff4466;':''}">${s.title}</h1>
        <p style="font-size:0.9rem;margin-bottom:15px;">${s.desc}</p>
        ${choicesHTML}
    </div></div>`;
}

function showResult() {
    // The result is shown via the scenario overlay update
    const ui = document.getElementById('ui');
    ui.innerHTML = `<div class="overlay" id="result"><div class="box">
        <h2 style="color:${resultColor};font-size:1.3rem;margin-bottom:10px;">${resultText}</h2>
        <div style="color:#8b949e;font-size:0.85rem;">Round ${round}/20 complete</div>
        <div style="color:#58a6ff;font-size:0.9rem;margin-top:5px;">Score: ${score}</div>
    </div></div>`;
}

function showPause() {
    const ui = document.getElementById('ui');
    const theme = SCENARIO_THEMES[themeIdx];
    let resHTML = '';
    for (let i = 0; i < 5; i++) {
        const color = resources[i] > 60 ? '#44ff88' : resources[i] > 30 ? '#ffaa44' : '#ff4466';
        resHTML += `<div class="stat"><span>${theme.resources[i]}</span><span style="color:${color};">${resources[i]}/100</span></div>`;
    }
    ui.innerHTML = `<div class="overlay" id="pause"><div class="box">
        <h1>PAUSED</h1>
        <div style="margin:12px 0;padding:8px;border:1px solid #21262d;border-radius:8px;">
            ${resHTML}
            <div class="stat"><span>Score</span><span>${score}</span></div>
            <div class="stat"><span>Round</span><span>${round}/20</span></div>
            <div class="stat"><span>Streak</span><span>${streak} (best: ${maxStreak})</span></div>
        </div>
        <button class="mbtn" onclick="document.getElementById('pause').remove();state='playing';showScenario();">Resume</button>
        <button class="mbtn sm" onclick="document.getElementById('pause').remove();state='menu';showMenu();">Quit</button>
    </div></div>`;
}

function showGameOver(won, ending) {
    const ui = document.getElementById('ui');
    const theme = SCENARIO_THEMES[themeIdx];
    const eColor = won ? '#44ff88' : '#ff4466';
    let resHTML = '';
    for (let i = 0; i < 5; i++) {
        resHTML += `<div class="stat"><span>${theme.resources[i]}</span><span>${resources[i]}/100</span></div>`;
    }
    ui.innerHTML = `<div class="overlay" id="go"><div class="box">
        <h1 style="color:${eColor};">${won?'VICTORY':'DEFEAT'}</h1>
        <h2 style="color:${eColor};font-size:1.3rem;">${ending}</h2>
        <div style="margin:12px 0;padding:8px;border:1px solid #21262d;border-radius:8px;">
            <div class="stat"><span>Final Score</span><span style="color:#ffd700;">${score}</span></div>
            <div class="stat"><span>Rounds</span><span>${round}</span></div>
            <div class="stat"><span>Best Streak</span><span>${maxStreak}</span></div>
            ${resHTML}
        </div>
        <button class="mbtn" onclick="document.getElementById('go').remove();startGame();">Play Again</button>
        <button class="mbtn sm" onclick="document.getElementById('go').remove();state='menu';showMenu();">Main Menu</button>
    </div></div>`;
}

// === INPUT ===
document.addEventListener('keydown', (e) => {
    initA();
    if (e.key === 'Escape') {
        if (state === 'playing' && !showingResult) { state = 'paused'; showPause(); }
        else if (state === 'paused') { document.getElementById('pause')?.remove(); state = 'playing'; showScenario(); }
    }
    if ((e.key === 'r' || e.key === 'R') && (state === 'playing' || state === 'gameover')) {
        document.querySelectorAll('.overlay').forEach(m => m.remove());
        startGame();
    }
    if (state === 'playing' && !showingResult && currentScenario) {
        const idx = parseInt(e.key) - 1;
        if (idx >= 0 && idx < currentScenario.choices.length) {
            makeChoice(idx);
        }
    }
    if (state === 'menu' && (e.key === ' ' || e.key === 'Enter')) {
        document.getElementById('mm')?.remove();
        startGame();
    }
});

cv.addEventListener('click', () => initA());
cv.addEventListener('touchstart', (e) => { e.preventDefault(); initA(); });

// === MAIN LOOP ===
function loop(t) { draw(t); requestAnimationFrame(loop); }
showMenu();
requestAnimationFrame(loop);
</script>
</body>
</html>