<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Motion Architect</title>
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="games-puzzles">
<meta name="rappterzoo:tags" content="canvas,game,audio,physics,puzzle">
<meta name="rappterzoo:type" content="game">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="2">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0014;color:#c084fc;font-family:'Segoe UI',sans-serif;overflow:hidden;height:100vh;width:100vw}
canvas{display:block;position:absolute;top:0;left:0}
#hud{position:absolute;top:10px;left:10px;pointer-events:none;z-index:10;font-size:13px;text-shadow:0 0 6px #c084fc}
#hud div{margin:3px 0}
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20;background:rgba(10,0,20,0.93)}
.overlay h1{font-size:46px;color:#c084fc;text-shadow:0 0 30px #c084fc,0 0 60px #7c3aed;margin-bottom:15px;letter-spacing:3px}
.overlay h2{font-size:22px;color:#a78bfa;margin-bottom:25px}
.overlay p{color:#a0a0c0;font-size:14px;margin:5px 0;max-width:480px;text-align:center;line-height:1.6}
.overlay button{margin:6px;padding:12px 36px;font-family:inherit;font-size:16px;background:transparent;color:#c084fc;border:2px solid #c084fc;cursor:pointer;letter-spacing:2px;transition:all 0.3s;border-radius:6px}
.overlay button:hover{background:#c084fc;color:#0a0014;box-shadow:0 0 25px #c084fc}
.diff-row{display:flex;gap:8px;margin:12px 0}
.diff-row button{font-size:13px;padding:8px 20px}
.diff-row button.sel{background:#c084fc;color:#0a0014}
.stats-box{text-align:left;background:rgba(40,0,80,0.5);padding:12px 16px;border:1px solid #c084fc;border-radius:8px;margin:12px;min-width:280px;font-size:13px}
.stats-box div{margin:3px 0}
#toolbar{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:10}
#toolbar button{padding:8px 16px;background:rgba(40,0,80,0.7);color:#c084fc;border:1px solid #7c3aed;border-radius:6px;cursor:pointer;font-size:12px;transition:all 0.2s}
#toolbar button:hover{background:#7c3aed;color:#fff}
#toolbar button.active{background:#c084fc;color:#0a0014;box-shadow:0 0 10px #c084fc}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="hud">
<div id="score-display">SCORE: 0</div>
<div id="level-display">LEVEL: 1</div>
<div id="orbs-display">ORBS: 0/5</div>
<div id="combo-display"></div>
<div id="time-display">TIME: 60</div>
</div>

<div id="toolbar" style="display:none">
<button id="tb-spring" class="active" onclick="setTool('spring')">Spring</button>
<button id="tb-gravity" onclick="setTool('gravity')">Gravity Well</button>
<button id="tb-bounce" onclick="setTool('bounce')">Bouncer</button>
<button id="tb-portal" onclick="setTool('portal')">Portal</button>
<button id="tb-fan" onclick="setTool('fan')">Fan</button>
</div>

<div id="title-screen" class="overlay">
<h1>MOTION ARCHITECT</h1>
<h2>Physics Puzzle Game</h2>
<p>Place physics objects to guide the ball to collect all orbs. Use springs, gravity wells, bouncers, portals, and fans. Think fast -- you are on the clock!</p>
<p style="color:#a78bfa;margin-top:10px">Click to place objects | WASD to pan | Scroll to zoom | ESC to pause</p>
<div class="diff-row">
<button onclick="setDiff(0)" id="d0">CASUAL</button>
<button onclick="setDiff(1)" id="d1" class="sel">STANDARD</button>
<button onclick="setDiff(2)" id="d2">EXPERT</button>
</div>
<button onclick="startGame()">BUILD</button>
</div>

<div id="pause-screen" class="overlay" style="display:none">
<h1>PAUSED</h1>
<button onclick="togglePause()">RESUME</button>
<button onclick="showTitle()">QUIT</button>
</div>

<div id="gameover-screen" class="overlay" style="display:none">
<h1 id="go-title">TIME UP</h1>
<h2 id="go-sub"></h2>
<div class="stats-box" id="go-stats"></div>
<button onclick="startGame()">RETRY (R)</button>
<button onclick="showTitle()">MENU</button>
</div>

<script>
const C=document.getElementById('c'),X=C.getContext('2d');
let W,H;function resize(){W=C.width=innerWidth;H=C.height=innerHeight}
resize();addEventListener('resize',resize);

const AC=new(window.AudioContext||window.webkitAudioContext)();
function sfx(type){
if(AC.state==='suspended')AC.resume();
const o=AC.createOscillator(),g=AC.createGain(),t=AC.currentTime;
g.connect(AC.destination);o.connect(g);
switch(type){
case'collect':o.type='sine';o.frequency.setValueAtTime(600,t);o.frequency.exponentialRampToValueAtTime(1200,t+0.1);g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.15);o.start(t);o.stop(t+0.15);break;
case'bounce':o.type='triangle';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(500,t+0.08);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);o.start(t);o.stop(t+0.1);break;
case'portal':o.type='sine';o.frequency.setValueAtTime(800,t);o.frequency.exponentialRampToValueAtTime(200,t+0.2);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.25);o.start(t);o.stop(t+0.25);break;
case'place':o.type='sine';o.frequency.setValueAtTime(500,t);g.gain.setValueAtTime(0.06,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.08);o.start(t);o.stop(t+0.08);break;
case'levelup':o.type='sine';o.frequency.setValueAtTime(400,t);o.frequency.setValueAtTime(500,t+0.1);o.frequency.setValueAtTime(600,t+0.2);o.frequency.setValueAtTime(800,t+0.3);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.5);o.start(t);o.stop(t+0.5);break;
case'death':o.type='sawtooth';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(40,t+0.6);g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.7);o.start(t);o.stop(t+0.7);break;
case'spring':o.type='sine';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(600,t+0.1);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.15);o.start(t);o.stop(t+0.15);break;
case'fan':o.type='sawtooth';o.frequency.setValueAtTime(100,t);g.gain.setValueAtTime(0.04,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.2);o.start(t);o.stop(t+0.2);break;
case'menu':o.type='sine';o.frequency.setValueAtTime(500,t);g.gain.setValueAtTime(0.04,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.06);o.start(t);o.stop(t+0.06);break;
}
}

let difficulty=1,gstate='title',score=0,combo=0,maxCombo=0,level=1;
let orbsCollected=0,totalOrbs=0,levelsCleared=0,objectsPlaced=0;
let timeLeft=60,timer=0;
let shakeX=0,shakeY=0,shakeDur=0;
let particles=[];
let tool='spring';

const DIFF=[{name:'Casual',timeMult:1.5,orbMult:0.7},{name:'Standard',timeMult:1,orbMult:1},{name:'Expert',timeMult:0.7,orbMult:1.3}];

// Physics objects
let ball={x:0,y:0,vx:0,vy:0,radius:10};
let walls=[],orbs=[],gadgets=[];
let cam={x:0,y:0,zoom:1};
const GRAVITY=0.15;

let keys={},mouse={x:0,y:0,down:false};
addEventListener('keydown',e=>{
keys[e.key.toLowerCase()]=true;
if(e.key==='Escape'){if(gstate==='playing')togglePause();else if(gstate==='paused')togglePause()}
if(gstate==='gameover'&&e.key.toLowerCase()==='r')startGame();
});
addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false});
C.addEventListener('mousemove',e=>{mouse.x=e.clientX;mouse.y=e.clientY});
C.addEventListener('mousedown',e=>{mouse.down=true;if(gstate==='playing')placeTool(e.clientX,e.clientY)});
C.addEventListener('mouseup',()=>{mouse.down=false});
C.addEventListener('wheel',e=>{cam.zoom=Math.max(0.3,Math.min(3,cam.zoom-e.deltaY*0.001))},{passive:true});

let touchStart=null;
C.addEventListener('touchstart',e=>{e.preventDefault();touchStart={x:e.touches[0].clientX,y:e.touches[0].clientY};
if(gstate==='playing')placeTool(e.touches[0].clientX,e.touches[0].clientY)},{passive:false});
C.addEventListener('touchmove',e=>{e.preventDefault()},{passive:false});

function setDiff(d){difficulty=d;document.querySelectorAll('.diff-row button').forEach((b,i)=>b.classList.toggle('sel',i===d));sfx('menu')}
function setTool(t){tool=t;document.querySelectorAll('#toolbar button').forEach(b=>b.classList.remove('active'));
document.getElementById('tb-'+t).classList.add('active');sfx('menu')}

function screenToWorld(sx,sy){
return{x:(sx-W/2)/cam.zoom+cam.x,y:(sy-H/2)/cam.zoom+cam.y};
}

function placeTool(sx,sy){
const wp=screenToWorld(sx,sy);
const g={x:wp.x,y:wp.y,type:tool,radius:20,strength:5,angle:0,
portalPair:null,active:true};
switch(tool){
case'spring':g.radius=15;g.strength=8;break;
case'gravity':g.radius=60;g.strength=0.5;break;
case'bounce':g.radius=25;g.strength=12;break;
case'portal':
const existing=gadgets.filter(g2=>g2.type==='portal'&&!g2.portalPair);
if(existing.length>0){
g.portalPair=existing[existing.length-1];
existing[existing.length-1].portalPair=g;
}
g.radius=18;break;
case'fan':g.radius=30;g.strength=0.3;g.angle=Math.atan2(ball.y-wp.y,ball.x-wp.x);break;
}
gadgets.push(g);objectsPlaced++;sfx('place');
}

function generateLevel(){
walls=[];orbs=[];gadgets=[];
const d=DIFF[difficulty];

// Boundaries
const bw=800+level*100,bh=600+level*80;
walls.push({x1:-bw/2,y1:-bh/2,x2:bw/2,y2:-bh/2});
walls.push({x1:bw/2,y1:-bh/2,x2:bw/2,y2:bh/2});
walls.push({x1:bw/2,y1:bh/2,x2:-bw/2,y2:bh/2});
walls.push({x1:-bw/2,y1:bh/2,x2:-bw/2,y2:-bh/2});

// Interior walls
const wallCount=3+level*2;
for(let i=0;i<wallCount;i++){
const cx=(Math.random()-0.5)*bw*0.7;
const cy=(Math.random()-0.5)*bh*0.7;
const len=50+Math.random()*150;
const ang=Math.random()*Math.PI;
walls.push({
x1:cx-Math.cos(ang)*len/2,y1:cy-Math.sin(ang)*len/2,
x2:cx+Math.cos(ang)*len/2,y2:cy+Math.sin(ang)*len/2
});
}

// Platform shelves
for(let i=0;i<2+level;i++){
const px=(Math.random()-0.5)*bw*0.6;
const py=(Math.random()-0.5)*bh*0.6;
const pw=80+Math.random()*120;
walls.push({x1:px-pw/2,y1:py,x2:px+pw/2,y2:py});
}

// Orbs
const orbCount=Math.floor((5+level*2)*d.orbMult);
totalOrbs=orbCount;
for(let i=0;i<orbCount;i++){
orbs.push({
x:(Math.random()-0.5)*bw*0.7,
y:(Math.random()-0.5)*bh*0.7,
collected:false,radius:8,pulse:Math.random()*6.28
});
}

// Ball start
ball.x=-bw/3;ball.y=-bh/3;ball.vx=0;ball.vy=0;

// Time
timeLeft=Math.floor((60+level*10)*d.timeMult);
timer=0;

cam.x=ball.x;cam.y=ball.y;cam.zoom=1;
}

function startGame(){
gstate='playing';score=0;combo=0;maxCombo=0;level=1;
orbsCollected=0;levelsCleared=0;objectsPlaced=0;
particles=[];
generateLevel();
document.getElementById('title-screen').style.display='none';
document.getElementById('gameover-screen').style.display='none';
document.getElementById('pause-screen').style.display='none';
document.getElementById('toolbar').style.display='flex';
sfx('menu');
}

function togglePause(){
if(gstate==='playing'){gstate='paused';document.getElementById('pause-screen').style.display='flex';sfx('menu')}
else if(gstate==='paused'){gstate='playing';document.getElementById('pause-screen').style.display='none';sfx('menu')}
}
function showTitle(){
gstate='title';document.getElementById('title-screen').style.display='flex';
document.getElementById('pause-screen').style.display='none';
document.getElementById('gameover-screen').style.display='none';
document.getElementById('toolbar').style.display='none';
}

function gameOver(won){
gstate='gameover';
document.getElementById('gameover-screen').style.display='flex';
document.getElementById('toolbar').style.display='none';
document.getElementById('go-title').textContent=won?'ALL LEVELS CLEAR!':'TIME UP';
document.getElementById('go-sub').textContent=won?'Master Architect!':'The ball could not reach all orbs in time';
document.getElementById('go-stats').innerHTML=
'<div>SCORE: '+score+'</div><div>MAX COMBO: '+maxCombo+'x</div>'+
'<div>ORBS COLLECTED: '+orbsCollected+'</div><div>LEVELS CLEARED: '+levelsCleared+'</div>'+
'<div>OBJECTS PLACED: '+objectsPlaced+'</div><div>DIFFICULTY: '+DIFF[difficulty].name+'</div>';
sfx(won?'levelup':'death');
const hs=JSON.parse(localStorage.getItem('motionarch_hs')||'[]');
hs.push({score,level,combo:maxCombo,diff:difficulty,date:Date.now()});
hs.sort((a,b)=>b.score-a.score);while(hs.length>10)hs.pop();
localStorage.setItem('motionarch_hs',JSON.stringify(hs));
}

function nextLevel(){
level++;levelsCleared++;
if(level>15){gameOver(true);return}
generateLevel();sfx('levelup');
}

function shake(a,d){shakeX=a;shakeY=a;shakeDur=d}
function spawnParticles(x,y,color,count){
for(let i=0;i<count;i++){
const a=Math.random()*6.28,s=1+Math.random()*3;
particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,
life:20+Math.random()*20,maxLife:40,color,radius:2+Math.random()*2});
}}

function lineCircle(x1,y1,x2,y2,cx,cy,cr){
const dx=x2-x1,dy=y2-y1;
const fx=x1-cx,fy=y1-cy;
const a=dx*dx+dy*dy,b=2*(fx*dx+fy*dy),c2=fx*fx+fy*fy-cr*cr;
let disc=b*b-4*a*c2;
if(disc<0)return null;
disc=Math.sqrt(disc);
const t1=(-b-disc)/(2*a);
if(t1>=0&&t1<=1){
const hx=x1+t1*dx,hy=y1+t1*dy;
const nx=cx-hx,ny=cy-hy;
const nl=Math.sqrt(nx*nx+ny*ny);
return{x:hx,y:hy,nx:nx/nl,ny:ny/nl,t:t1};
}
return null;
}

function update(){
if(gstate!=='playing')return;

// Timer
timer++;
if(timer%60===0){timeLeft--;if(timeLeft<=0)gameOver(false)}

// Camera pan
if(keys['a']||keys['arrowleft'])cam.x-=5/cam.zoom;
if(keys['d']||keys['arrowright'])cam.x+=5/cam.zoom;
if(keys['w']||keys['arrowup'])cam.y-=5/cam.zoom;
if(keys['s']||keys['arrowdown'])cam.y+=5/cam.zoom;

// Physics - gravity
ball.vy+=GRAVITY;

// Gadget forces
gadgets.forEach(g=>{
if(!g.active)return;
const dx=g.x-ball.x,dy=g.y-ball.y;
const dist=Math.sqrt(dx*dx+dy*dy);
switch(g.type){
case'gravity':
if(dist<g.radius*3&&dist>5){
const force=g.strength/Math.max(10,dist);
ball.vx+=dx/dist*force;ball.vy+=dy/dist*force;
}break;
case'spring':
if(dist<g.radius+ball.radius){
const nx=dx/dist,ny=dy/dist;
ball.vx-=nx*g.strength;ball.vy-=ny*g.strength;
sfx('spring');spawnParticles(ball.x,ball.y,'#a78bfa',5);shake(3,4);
}break;
case'bounce':
if(dist<g.radius+ball.radius){
const nx=-dx/dist,ny=-dy/dist;
ball.vx=nx*g.strength;ball.vy=ny*g.strength;
sfx('bounce');spawnParticles(ball.x,ball.y,'#f0abfc',6);shake(4,5);
}break;
case'portal':
if(dist<g.radius&&g.portalPair){
ball.x=g.portalPair.x;ball.y=g.portalPair.y-30;
sfx('portal');spawnParticles(g.x,g.y,'#818cf8',8);
spawnParticles(g.portalPair.x,g.portalPair.y,'#818cf8',8);
}break;
case'fan':
if(dist<g.radius*3){
ball.vx+=Math.cos(g.angle)*g.strength;
ball.vy+=Math.sin(g.angle)*g.strength;
if(timer%30===0)sfx('fan');
}break;
}
});

// Move ball
ball.x+=ball.vx;ball.y+=ball.vy;

// Wall collision
walls.forEach(w=>{
const hit=lineCircle(w.x1,w.y1,w.x2,w.y2,ball.x,ball.y,ball.radius);
if(hit){
ball.x=hit.x+hit.nx*(ball.radius+1);
ball.y=hit.y+hit.ny*(ball.radius+1);
const dot=ball.vx*hit.nx+ball.vy*hit.ny;
ball.vx-=2*dot*hit.nx;ball.vy-=2*dot*hit.ny;
ball.vx*=0.8;ball.vy*=0.8;
sfx('bounce');
}
});

// Friction
ball.vx*=0.998;ball.vy*=0.998;

// Speed limit
const spd=Math.sqrt(ball.vx**2+ball.vy**2);
if(spd>15){ball.vx=ball.vx/spd*15;ball.vy=ball.vy/spd*15}

// Orb collection
let allCollected=true;
orbs.forEach(o=>{
if(o.collected)return;
allCollected=false;
o.pulse+=0.05;
const dist=Math.sqrt((o.x-ball.x)**2+(o.y-ball.y)**2);
if(dist<o.radius+ball.radius){
o.collected=true;orbsCollected++;combo++;
if(combo>maxCombo)maxCombo=combo;
score+=100*combo;
sfx('collect');spawnParticles(o.x,o.y,'#c084fc',10);shake(3,5);
}
});
if(allCollected)nextLevel();

// Particles
particles=particles.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=0.96;p.vy*=0.96;p.life--;return p.life>0});
if(shakeDur>0){shakeDur--;shakeX*=0.9;shakeY*=0.9}else{shakeX=0;shakeY=0}

// Combo decay
if(combo>0&&timer%300===0)combo=Math.max(0,combo-1);

// Smooth camera follow ball
cam.x+=(ball.x-cam.x)*0.02;
cam.y+=(ball.y-cam.y)*0.02;
}

function draw(){
X.save();
const sx=shakeDur>0?(Math.random()-0.5)*shakeX:0;
const sy=shakeDur>0?(Math.random()-0.5)*shakeY:0;
X.translate(sx,sy);

// Background
const bgGrad=X.createLinearGradient(0,0,0,H);
bgGrad.addColorStop(0,'#0a0014');bgGrad.addColorStop(1,'#1a0030');
X.fillStyle=bgGrad;X.fillRect(0,0,W,H);

// Grid pattern
X.save();
X.translate(W/2,H/2);X.scale(cam.zoom,cam.zoom);X.translate(-cam.x,-cam.y);
const gridSize=50;
const startGX=Math.floor((cam.x-W/2/cam.zoom)/gridSize)*gridSize;
const startGY=Math.floor((cam.y-H/2/cam.zoom)/gridSize)*gridSize;
X.strokeStyle='rgba(100,50,200,0.1)';X.lineWidth=1;
for(let gx=startGX;gx<cam.x+W/cam.zoom;gx+=gridSize){
X.beginPath();X.moveTo(gx,cam.y-H/cam.zoom);X.lineTo(gx,cam.y+H/cam.zoom);X.stroke();
}
for(let gy=startGY;gy<cam.y+H/cam.zoom;gy+=gridSize){
X.beginPath();X.moveTo(cam.x-W/cam.zoom,gy);X.lineTo(cam.x+W/cam.zoom,gy);X.stroke();
}

// Walls
X.strokeStyle='#7c3aed';X.lineWidth=3;X.shadowBlur=8;X.shadowColor='#7c3aed';
walls.forEach(w=>{X.beginPath();X.moveTo(w.x1,w.y1);X.lineTo(w.x2,w.y2);X.stroke()});
X.shadowBlur=0;

// Gadgets
gadgets.forEach(g=>{
X.beginPath();
switch(g.type){
case'spring':
X.arc(g.x,g.y,g.radius,0,Math.PI*2);
X.fillStyle='rgba(167,139,250,0.4)';X.fill();
X.strokeStyle='#a78bfa';X.lineWidth=2;X.stroke();
// Coil lines
for(let i=0;i<3;i++){
const a=timer*0.05+i*2.1;
X.beginPath();X.arc(g.x,g.y,g.radius*0.6,a,a+1);X.stroke();
}break;
case'gravity':
X.arc(g.x,g.y,g.radius,0,Math.PI*2);
const gg=X.createRadialGradient(g.x,g.y,0,g.x,g.y,g.radius);
gg.addColorStop(0,'rgba(124,58,237,0.5)');gg.addColorStop(1,'rgba(124,58,237,0)');
X.fillStyle=gg;X.fill();
X.strokeStyle='#7c3aed';X.lineWidth=1;X.setLineDash([4,4]);X.stroke();X.setLineDash([]);
// Spiral
for(let i=0;i<20;i++){
const a=i*0.3+timer*0.02;const r2=g.radius*(i/20);
X.fillStyle='rgba(167,139,250,'+(1-i/20)*0.5+')';
X.fillRect(g.x+Math.cos(a)*r2-1,g.y+Math.sin(a)*r2-1,2,2);
}break;
case'bounce':
X.arc(g.x,g.y,g.radius+Math.sin(timer*0.1)*3,0,Math.PI*2);
X.fillStyle='rgba(240,171,252,0.5)';X.fill();
X.strokeStyle='#f0abfc';X.lineWidth=3;X.stroke();break;
case'portal':
X.arc(g.x,g.y,g.radius,0,Math.PI*2);
const pg=X.createRadialGradient(g.x,g.y,0,g.x,g.y,g.radius);
pg.addColorStop(0,'rgba(129,140,248,0.7)');pg.addColorStop(1,'rgba(129,140,248,0)');
X.fillStyle=pg;X.fill();
// Swirl
for(let i=0;i<8;i++){
const a=i*0.785+timer*0.05;
X.fillStyle='rgba(129,140,248,0.6)';
X.fillRect(g.x+Math.cos(a)*g.radius*0.7-1,g.y+Math.sin(a)*g.radius*0.7-1,3,3);
}
if(g.portalPair){
X.strokeStyle='rgba(129,140,248,0.2)';X.lineWidth=1;
X.beginPath();X.moveTo(g.x,g.y);X.lineTo(g.portalPair.x,g.portalPair.y);X.stroke();
}break;
case'fan':
X.arc(g.x,g.y,10,0,Math.PI*2);
X.fillStyle='rgba(96,165,250,0.6)';X.fill();
// Wind lines
X.strokeStyle='rgba(96,165,250,0.4)';X.lineWidth=1;
for(let i=0;i<5;i++){
const offset=(timer*2+i*20)%100;
const fx=g.x+Math.cos(g.angle)*offset;
const fy=g.y+Math.sin(g.angle)*offset;
X.beginPath();X.moveTo(fx,fy);X.lineTo(fx+Math.cos(g.angle)*15,fy+Math.sin(g.angle)*15);X.stroke();
}break;
}
});

// Orbs
orbs.forEach(o=>{
if(o.collected)return;
const p=Math.sin(o.pulse)*3;
X.beginPath();X.arc(o.x,o.y,o.radius+p,0,Math.PI*2);
X.fillStyle='rgba(192,132,252,0.7)';X.fill();
X.shadowBlur=15;X.shadowColor='#c084fc';
X.beginPath();X.arc(o.x,o.y,o.radius/2,0,Math.PI*2);X.fill();
X.shadowBlur=0;
X.strokeStyle='#e9d5ff';X.lineWidth=1.5;
X.beginPath();X.arc(o.x,o.y,o.radius+p,0,Math.PI*2);X.stroke();
});

// Ball
X.beginPath();X.arc(ball.x,ball.y,ball.radius,0,Math.PI*2);
const bGrad=X.createRadialGradient(ball.x,ball.y,0,ball.x,ball.y,ball.radius);
bGrad.addColorStop(0,'#fff');bGrad.addColorStop(0.5,'#e9d5ff');bGrad.addColorStop(1,'#c084fc');
X.fillStyle=bGrad;X.fill();
X.shadowBlur=12;X.shadowColor='#c084fc';
X.beginPath();X.arc(ball.x,ball.y,ball.radius*0.5,0,Math.PI*2);X.fill();
X.shadowBlur=0;
// Velocity trail
if(Math.abs(ball.vx)>0.5||Math.abs(ball.vy)>0.5){
X.strokeStyle='rgba(192,132,252,0.3)';X.lineWidth=2;
X.beginPath();X.moveTo(ball.x,ball.y);
X.lineTo(ball.x-ball.vx*5,ball.y-ball.vy*5);X.stroke();
}

// Particles
particles.forEach(p=>{
X.globalAlpha=p.life/p.maxLife;
X.beginPath();X.arc(p.x,p.y,p.radius*(p.life/p.maxLife),0,Math.PI*2);
X.fillStyle=p.color;X.fill();
});
X.globalAlpha=1;

// Tool preview on cursor
if(gstate==='playing'){
const wp=screenToWorld(mouse.x,mouse.y);
X.globalAlpha=0.3;X.beginPath();
const pr=tool==='gravity'?60:tool==='bounce'?25:tool==='fan'?30:tool==='portal'?18:15;
X.arc(wp.x,wp.y,pr,0,Math.PI*2);
X.strokeStyle='#c084fc';X.lineWidth=1;X.setLineDash([4,4]);X.stroke();X.setLineDash([]);
X.globalAlpha=1;
}

X.restore();

// HUD
const collectedCount=orbs.filter(o=>o.collected).length;
document.getElementById('score-display').textContent='SCORE: '+score;
document.getElementById('level-display').textContent='LEVEL: '+level;
document.getElementById('orbs-display').textContent='ORBS: '+collectedCount+'/'+totalOrbs;
document.getElementById('combo-display').textContent=combo>1?'COMBO: x'+combo:'';
document.getElementById('time-display').textContent='TIME: '+timeLeft;

X.restore();
}

function loop(){update();draw();requestAnimationFrame(loop)}
loop();
</script>
</body>
</html>
