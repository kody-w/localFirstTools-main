<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thousand Suns - A Living MMORPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
            image-rendering: pixelated;
        }

        #gameContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
        }

        #worldCanvas {
            position: absolute;
            top: 0;
            left: 0;
            background: #2d4a3e;
            image-rendering: pixelated;
        }

        .ui-panel {
            position: absolute;
            background: rgba(20, 20, 40, 0.95);
            border: 2px solid #4a4a6a;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        #characterPanel {
            top: 10px;
            left: 10px;
            width: 240px;
        }

        .portrait {
            width: 60px;
            height: 60px;
            border: 2px solid #666;
            border-radius: 50%;
            display: inline-block;
            vertical-align: top;
            margin-right: 10px;
        }

        .char-info {
            display: inline-block;
            width: calc(100% - 80px);
        }

        .char-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .char-level {
            color: #aaa;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .stat-bar {
            width: 100%;
            height: 18px;
            background: #222;
            border: 1px solid #444;
            border-radius: 2px;
            margin-bottom: 3px;
            position: relative;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .hp-fill { background: linear-gradient(to bottom, #e74c3c, #c0392b); }
        .mp-fill { background: linear-gradient(to bottom, #3498db, #2980b9); }
        .xp-fill { background: linear-gradient(to bottom, #f1c40f, #f39c12); }

        .stat-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 10px;
            line-height: 18px;
            color: white;
            text-shadow: 1px 1px 2px black;
            font-weight: bold;
        }

        #hotbar {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            padding: 12px;
        }

        .hotbar-slot {
            width: 50px;
            height: 50px;
            background: rgba(40, 40, 60, 0.9);
            border: 2px solid #555;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hotbar-slot:hover {
            border-color: #ffd700;
            transform: scale(1.05);
        }

        .hotbar-slot.on-cooldown {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hotbar-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .hotbar-key {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 10px;
            color: #aaa;
        }

        .cooldown-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            transition: height 0.1s linear;
        }

        #chatWindow {
            bottom: 90px;
            left: 10px;
            width: 450px;
            height: 280px;
            display: flex;
            flex-direction: column;
        }

        #chatMessages {
            flex: 1;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 8px;
            padding-right: 5px;
        }

        #chatMessages::-webkit-scrollbar {
            width: 8px;
        }

        #chatMessages::-webkit-scrollbar-track {
            background: #222;
        }

        #chatMessages::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .chat-message {
            margin-bottom: 3px;
            word-wrap: break-word;
        }

        .chat-global { color: #ecf0f1; }
        .chat-trade { color: #f39c12; }
        .chat-group { color: #3498db; }
        .chat-whisper { color: #e91e63; }
        .chat-system { color: #2ecc71; font-style: italic; }
        .chat-error { color: #e74c3c; }

        #chatInput {
            width: 100%;
            padding: 6px;
            background: rgba(30, 30, 50, 0.9);
            border: 1px solid #555;
            color: #eee;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 3px;
        }

        #chatInput:focus {
            outline: none;
            border-color: #ffd700;
        }

        #minimap {
            top: 10px;
            right: 10px;
            width: 180px;
            height: 180px;
        }

        #minimapCanvas {
            width: 100%;
            height: 100%;
            border: 1px solid #444;
            background: rgba(0,0,0,0.5);
        }

        .zone-name {
            text-align: center;
            font-size: 11px;
            color: #aaa;
            margin-top: 5px;
        }

        #targetFrame {
            top: 10px;
            right: 210px;
            width: 260px;
            display: none;
        }

        #targetFrame.active {
            display: block;
        }

        .target-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 5px;
        }

        .target-level {
            font-size: 11px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #ffd700;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .modal-title {
            font-size: 24px;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: rgba(30, 30, 50, 0.8);
            border: 2px solid #555;
            color: #eee;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-radius: 4px;
        }

        .form-input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .class-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .class-option {
            padding: 15px;
            background: rgba(40, 40, 60, 0.8);
            border: 2px solid #555;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .class-option:hover {
            border-color: #ffd700;
            transform: scale(1.02);
        }

        .class-option.selected {
            border-color: #ffd700;
            background: rgba(60, 60, 80, 0.9);
        }

        .class-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .class-desc {
            font-size: 11px;
            color: #aaa;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(to bottom, #f39c12, #e67e22);
            border: 2px solid #d68910;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 10px 5px;
        }

        .btn:hover {
            background: linear-gradient(to bottom, #ffd700, #f39c12);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        #inventoryModal .modal-content,
        #characterModal .modal-content,
        #questModal .modal-content {
            max-width: 700px;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(30, 30, 50, 0.8);
            border: 2px solid #444;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .inventory-slot:hover {
            border-color: #ffd700;
        }

        .inventory-slot.has-item {
            background: rgba(50, 50, 70, 0.9);
        }

        .item-icon {
            font-size: 24px;
        }

        .item-count {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 10px;
            color: #fff;
            text-shadow: 1px 1px 2px black;
        }

        .equipment-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .equipment-slot {
            padding: 15px;
            background: rgba(30, 30, 50, 0.8);
            border: 2px solid #444;
            border-radius: 4px;
        }

        .slot-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .slot-item {
            color: #ffd700;
            font-size: 13px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(30, 30, 50, 0.6);
            border-radius: 3px;
        }

        .stat-label {
            color: #aaa;
        }

        .stat-value {
            color: #ffd700;
            font-weight: bold;
        }

        .quest-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .quest-item {
            padding: 15px;
            background: rgba(30, 30, 50, 0.8);
            border: 2px solid #444;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .quest-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .quest-desc {
            color: #ccc;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .quest-progress {
            color: #3498db;
            font-size: 11px;
        }

        .quest-reward {
            color: #2ecc71;
            font-size: 11px;
            margin-top: 5px;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border: 3px solid #555;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        #deathScreen {
            background: rgba(0,0,0,0.95);
        }

        .death-text {
            font-size: 48px;
            color: #e74c3c;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
        }

        .death-info {
            text-align: center;
            color: #aaa;
            margin-bottom: 30px;
        }

        .floating-damage {
            position: absolute;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 2px 2px 4px black;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-title {
            font-size: 48px;
            color: #ffd700;
            margin-bottom: 30px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .loading-subtitle {
            font-size: 18px;
            color: #aaa;
            margin-bottom: 40px;
        }

        .loading-bar {
            width: 400px;
            height: 30px;
            background: #222;
            border: 2px solid #444;
            border-radius: 15px;
            overflow: hidden;
        }

        .loading-fill {
            height: 100%;
            background: linear-gradient(to right, #f39c12, #ffd700);
            width: 0%;
            transition: width 0.3s;
        }

        .help-text {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #666;
            font-size: 11px;
            text-align: center;
        }

        .ability-tooltip {
            position: absolute;
            background: rgba(20, 20, 40, 0.98);
            border: 2px solid #ffd700;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            min-width: 200px;
            display: none;
        }

        .tooltip-name {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .tooltip-desc {
            color: #ccc;
            margin-bottom: 5px;
        }

        .tooltip-stats {
            color: #3498db;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-title">THOUSAND SUNS</div>
        <div class="loading-subtitle">Connecting to server...</div>
        <div class="loading-bar">
            <div class="loading-fill" id="loadingFill"></div>
        </div>
        <div class="help-text">
            WASD/Arrow Keys: Move | 1-4: Abilities | I: Inventory | C: Character | L: Quests | Enter: Chat
        </div>
    </div>

    <div id="gameContainer">
        <canvas id="worldCanvas"></canvas>

        <div id="characterPanel" class="ui-panel">
            <div class="portrait" id="charPortrait"></div>
            <div class="char-info">
                <div class="char-name" id="charName">Hero</div>
                <div class="char-level" id="charLevel">Level 1 Warrior</div>
            </div>
            <div class="stat-bar">
                <div class="stat-fill hp-fill" id="hpBar" style="width: 100%"></div>
                <div class="stat-text" id="hpText">100 / 100</div>
            </div>
            <div class="stat-bar">
                <div class="stat-fill mp-fill" id="mpBar" style="width: 100%"></div>
                <div class="stat-text" id="mpText">50 / 50</div>
            </div>
            <div class="stat-bar">
                <div class="stat-fill xp-fill" id="xpBar" style="width: 0%"></div>
                <div class="stat-text" id="xpText">0 / 100 XP</div>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: #ffd700; text-align: center;">
                <span id="goldAmount">0</span> ü™ô
            </div>
        </div>

        <div id="targetFrame" class="ui-panel">
            <div class="target-name" id="targetName">Target</div>
            <div class="target-level" id="targetLevel">Level 1</div>
            <div class="stat-bar">
                <div class="stat-fill hp-fill" id="targetHpBar" style="width: 100%"></div>
                <div class="stat-text" id="targetHpText">100 / 100</div>
            </div>
        </div>

        <div id="minimap" class="ui-panel">
            <canvas id="minimapCanvas" width="160" height="160"></canvas>
            <div class="zone-name" id="zoneName">Starter Village</div>
        </div>

        <div id="hotbar" class="ui-panel">
            <div class="hotbar-slot" data-slot="0">
                <div class="hotbar-icon" id="ability0">‚öîÔ∏è</div>
                <div class="hotbar-key">1</div>
                <div class="cooldown-overlay" id="cooldown0"></div>
            </div>
            <div class="hotbar-slot" data-slot="1">
                <div class="hotbar-icon" id="ability1">üõ°Ô∏è</div>
                <div class="hotbar-key">2</div>
                <div class="cooldown-overlay" id="cooldown1"></div>
            </div>
            <div class="hotbar-slot" data-slot="2">
                <div class="hotbar-icon" id="ability2">üåÄ</div>
                <div class="hotbar-key">3</div>
                <div class="cooldown-overlay" id="cooldown2"></div>
            </div>
            <div class="hotbar-slot" data-slot="3">
                <div class="hotbar-icon" id="ability3">üì¢</div>
                <div class="hotbar-key">4</div>
                <div class="cooldown-overlay" id="cooldown3"></div>
            </div>
            <div class="hotbar-slot" data-slot="4">
                <div class="hotbar-icon">üß™</div>
                <div class="hotbar-key">5</div>
                <div class="cooldown-overlay" id="cooldown4"></div>
            </div>
        </div>

        <div id="chatWindow" class="ui-panel">
            <div id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Press Enter to chat..." maxlength="100">
        </div>
    </div>

    <div id="characterCreation" class="modal active">
        <div class="modal-content">
            <div class="modal-title">Create Your Hero</div>
            <div class="form-group">
                <label class="form-label">Character Name</label>
                <input type="text" id="charNameInput" class="form-input" placeholder="Enter your name" maxlength="20">
            </div>
            <div class="form-group">
                <label class="form-label">Choose Your Class</label>
                <div class="class-selection" id="classSelection">
                    <div class="class-option" data-class="Warrior">
                        <div class="class-name">‚öîÔ∏è Warrior</div>
                        <div class="class-desc">Melee fighter with high HP and defense</div>
                    </div>
                    <div class="class-option" data-class="Mage">
                        <div class="class-name">üîÆ Mage</div>
                        <div class="class-desc">Powerful spells, low HP, high MP</div>
                    </div>
                    <div class="class-option" data-class="Ranger">
                        <div class="class-name">üèπ Ranger</div>
                        <div class="class-desc">Ranged attacks with high speed</div>
                    </div>
                    <div class="class-option" data-class="Healer">
                        <div class="class-name">‚ú® Healer</div>
                        <div class="class-desc">Support class with healing abilities</div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Character Color</label>
                <div class="color-picker" id="colorPicker"></div>
            </div>
            <div style="text-align: center;">
                <button class="btn" id="startGameBtn">Enter the World</button>
            </div>
        </div>
    </div>

    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Inventory</div>
            <div class="equipment-slots" id="equipmentSlots"></div>
            <div class="inventory-grid" id="inventoryGrid"></div>
            <div style="text-align: center;">
                <button class="btn" id="closeInventory">Close</button>
            </div>
        </div>
    </div>

    <div id="characterModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Character Stats</div>
            <div class="stats-grid" id="statsGrid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" id="closeCharacter">Close</button>
            </div>
        </div>
    </div>

    <div id="questModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Quest Log</div>
            <div class="quest-list" id="questList"></div>
            <div style="text-align: center;">
                <button class="btn" id="closeQuests">Close</button>
            </div>
        </div>
    </div>

    <div id="deathScreen" class="modal">
        <div class="modal-content">
            <div class="death-text">YOU DIED</div>
            <div class="death-info" id="deathInfo">You lost 50 gold</div>
            <div style="text-align: center;">
                <button class="btn" id="respawnBtn">Respawn at Town</button>
            </div>
        </div>
    </div>

    <div class="ability-tooltip" id="abilityTooltip">
        <div class="tooltip-name" id="tooltipName"></div>
        <div class="tooltip-desc" id="tooltipDesc"></div>
        <div class="tooltip-stats" id="tooltipStats"></div>
    </div>

    <script>
        // ========== GAME STATE ==========
        const WORLD_WIDTH = 3200;
        const WORLD_HEIGHT = 3200;
        const TILE_SIZE = 32;
        const CAMERA_SMOOTH = 0.1;

        let canvas, ctx, minimapCanvas, minimapCtx;
        let camera = { x: 0, y: 0 };
        let keys = {};
        let mousePos = { x: 0, y: 0 };
        let selectedClass = null;
        let selectedColor = '#4a9eff';

        // Player state
        let player = {
            x: 1600,
            y: 1600,
            width: 24,
            height: 24,
            speed: 3,
            name: 'Hero',
            class: 'Warrior',
            level: 1,
            xp: 0,
            xpToNext: 100,
            hp: 100,
            maxHp: 100,
            mp: 50,
            maxMp: 50,
            atk: 10,
            def: 5,
            spd: 3,
            gold: 0,
            color: '#4a9eff',
            inventory: [],
            equipment: { weapon: null, armor: null, ring: null, trinket: null },
            abilities: [],
            target: null,
            inCombat: false,
            attackCooldown: 0,
            quests: [],
            zone: 'Starter Village'
        };

        // Zones
        const zones = {
            'Starter Village': { x: 1400, y: 1400, width: 400, height: 400, color: '#6b8e23', level: 0 },
            'Greenwood Forest': { x: 200, y: 200, width: 1000, height: 1000, color: '#2d5016', level: 5 },
            'Crystal Caves': { x: 1800, y: 200, width: 1200, height: 1000, color: '#4a4a6a', level: 15 },
            'Scorched Wastes': { x: 200, y: 1800, width: 1200, height: 1200, color: '#8b4513', level: 25 },
            'Shadow Citadel': { x: 1800, y: 1800, width: 800, height: 800, color: '#1a1a2e', level: 35 },
            'Dragon\'s Peak': { x: 2600, y: 2600, width: 500, height: 500, color: '#660000', level: 45 }
        };

        // AI Players
        let aiPlayers = [];
        const NUM_AI_PLAYERS = 200;

        // Mobs
        let mobs = [];
        const MAX_MOBS = 150;

        // Particles and effects
        let particles = [];
        let floatingTexts = [];

        // Game state
        let gameTime = 0;
        let lastFrameTime = Date.now();
        let chatMessages = [];

        // Class definitions
        const classData = {
            Warrior: {
                icon: '‚öîÔ∏è',
                hpMult: 1.5,
                mpMult: 0.8,
                atkMult: 1.2,
                defMult: 1.3,
                spdMult: 0.9,
                abilities: [
                    { name: 'Slash', icon: '‚öîÔ∏è', damage: 15, manaCost: 0, cooldown: 1000, range: 50, desc: 'Basic melee attack' },
                    { name: 'Shield Bash', icon: 'üõ°Ô∏è', damage: 25, manaCost: 15, cooldown: 5000, range: 50, desc: 'Stun enemy for 2s' },
                    { name: 'Whirlwind', icon: 'üåÄ', damage: 40, manaCost: 30, cooldown: 10000, range: 80, desc: 'AOE spin attack' },
                    { name: 'Battlecry', icon: 'üì¢', damage: 0, manaCost: 20, cooldown: 15000, range: 0, desc: 'Buff ATK +50% for 10s' }
                ]
            },
            Mage: {
                icon: 'üîÆ',
                hpMult: 0.7,
                mpMult: 1.8,
                atkMult: 1.5,
                defMult: 0.6,
                spdMult: 1.0,
                abilities: [
                    { name: 'Fireball', icon: 'üî•', damage: 30, manaCost: 15, cooldown: 2000, range: 200, desc: 'Ranged fire spell' },
                    { name: 'Ice Blast', icon: '‚ùÑÔ∏è', damage: 35, manaCost: 20, cooldown: 4000, range: 180, desc: 'Freeze enemy' },
                    { name: 'Teleport', icon: '‚ú®', damage: 0, manaCost: 40, cooldown: 8000, range: 150, desc: 'Instant blink' },
                    { name: 'Meteor', icon: '‚òÑÔ∏è', damage: 100, manaCost: 80, cooldown: 30000, range: 250, desc: 'Ultimate AOE' }
                ]
            },
            Ranger: {
                icon: 'üèπ',
                hpMult: 1.0,
                mpMult: 1.0,
                atkMult: 1.3,
                defMult: 0.8,
                spdMult: 1.3,
                abilities: [
                    { name: 'Arrow Shot', icon: 'üèπ', damage: 20, manaCost: 5, cooldown: 1500, range: 250, desc: 'Quick ranged shot' },
                    { name: 'Multi-Shot', icon: 'üéØ', damage: 15, manaCost: 20, cooldown: 5000, range: 200, desc: 'Hit 3 targets' },
                    { name: 'Trap', icon: 'ü™§', damage: 30, manaCost: 25, cooldown: 8000, range: 100, desc: 'Place damaging trap' },
                    { name: 'Snipe', icon: 'üé™', damage: 80, manaCost: 40, cooldown: 15000, range: 400, desc: 'Long range crit' }
                ]
            },
            Healer: {
                icon: '‚ú®',
                hpMult: 1.1,
                mpMult: 1.5,
                atkMult: 0.7,
                defMult: 1.0,
                spdMult: 1.0,
                abilities: [
                    { name: 'Heal', icon: 'üíö', damage: -40, manaCost: 25, cooldown: 3000, range: 150, desc: 'Restore HP' },
                    { name: 'Holy Light', icon: 'üåü', damage: 25, manaCost: 20, cooldown: 4000, range: 180, desc: 'Damage undead' },
                    { name: 'Resurrect', icon: '‚ö∞Ô∏è', damage: 0, manaCost: 100, cooldown: 60000, range: 100, desc: 'Revive ally' },
                    { name: 'Divine Shield', icon: 'üõ°Ô∏è', damage: 0, manaCost: 50, cooldown: 20000, range: 0, desc: 'Immune for 5s' }
                ]
            }
        };

        // AI personality types
        const personalities = [
            'Grinder', 'Social', 'Tryhard', 'Noob', 'Troll', 'Helper', 'AFK', 'RPer'
        ];

        // Fantasy name generator
        const namePrefix = ['Dark', 'Shadow', 'Frost', 'Fire', 'Holy', 'Blood', 'Night', 'Death', 'Moon', 'Sun', 'Star', 'Dragon', 'Wolf', 'Bear', 'Eagle', 'Lion'];
        const nameSuffix = ['Blade', 'Slayer', 'Mage', 'Lord', 'Knight', 'Rogue', 'Priest', 'Hunter', 'Ranger', 'Wizard', 'Warrior', 'Assassin', 'Paladin'];
        const nameDecorators = ['xX', 'Xx', '420', '69', '77', '99', 'Pro', 'Noob', 'Epic', 'Legendary'];

        function generateAIName() {
            const rand = Math.random();
            if (rand < 0.3) {
                return namePrefix[Math.floor(Math.random() * namePrefix.length)] +
                       nameSuffix[Math.floor(Math.random() * nameSuffix.length)] +
                       Math.floor(Math.random() * 999);
            } else if (rand < 0.6) {
                return 'xX' + namePrefix[Math.floor(Math.random() * namePrefix.length)] +
                       nameSuffix[Math.floor(Math.random() * nameSuffix.length)] + 'Xx';
            } else {
                return namePrefix[Math.floor(Math.random() * namePrefix.length)] +
                       nameSuffix[Math.floor(Math.random() * nameSuffix.length)];
            }
        }

        // Initialize AI players
        function initAIPlayers() {
            for (let i = 0; i < NUM_AI_PLAYERS; i++) {
                const className = ['Warrior', 'Mage', 'Ranger', 'Healer'][Math.floor(Math.random() * 4)];
                const level = Math.max(1, Math.min(50, Math.floor(Math.random() * Math.random() * 60)));

                aiPlayers.push({
                    name: generateAIName(),
                    class: className,
                    level: level,
                    x: Math.random() * WORLD_WIDTH,
                    y: Math.random() * WORLD_HEIGHT,
                    targetX: 0,
                    targetY: 0,
                    speed: 2,
                    personality: personalities[Math.floor(Math.random() * personalities.length)],
                    color: `hsl(${Math.random() * 360}, 70%, 60%)`,
                    lastChat: 0,
                    chatCooldown: Math.random() * 30000 + 10000,
                    inGroup: false,
                    groupMembers: [],
                    activity: 'idle',
                    target: null,
                    hp: 100,
                    maxHp: 100
                });
            }
        }

        // Mob types
        const mobTypes = {
            'Slime': { level: 1, hp: 30, atk: 3, xp: 10, gold: 5, color: '#90ee90', zones: ['Greenwood Forest'] },
            'Wolf': { level: 3, hp: 50, atk: 7, xp: 20, gold: 8, color: '#8b7355', zones: ['Greenwood Forest'] },
            'Goblin': { level: 5, hp: 80, atk: 12, xp: 35, gold: 15, color: '#9acd32', zones: ['Greenwood Forest'] },
            'Bat': { level: 12, hp: 60, atk: 18, xp: 60, gold: 20, color: '#4a4a4a', zones: ['Crystal Caves'] },
            'Spider': { level: 15, hp: 120, atk: 25, xp: 90, gold: 30, color: '#8b008b', zones: ['Crystal Caves'] },
            'Rock Golem': { level: 18, hp: 250, atk: 35, xp: 150, gold: 50, color: '#696969', zones: ['Crystal Caves'] },
            'Fire Elemental': { level: 22, hp: 180, atk: 45, xp: 200, gold: 60, color: '#ff4500', zones: ['Scorched Wastes'] },
            'Scorpion': { level: 25, hp: 200, atk: 50, xp: 250, gold: 70, color: '#daa520', zones: ['Scorched Wastes'] },
            'Sand Wyrm': { level: 28, hp: 350, atk: 60, xp: 350, gold: 100, color: '#f4a460', zones: ['Scorched Wastes'] },
            'Undead': { level: 32, hp: 300, atk: 70, xp: 450, gold: 120, color: '#778899', zones: ['Shadow Citadel'] },
            'Wraith': { level: 35, hp: 250, atk: 85, xp: 550, gold: 150, color: '#483d8b', zones: ['Shadow Citadel'] },
            'Dark Knight': { level: 38, hp: 500, atk: 95, xp: 700, gold: 200, color: '#2f4f4f', zones: ['Shadow Citadel'] },
            'Drake': { level: 42, hp: 600, atk: 110, xp: 900, gold: 250, color: '#8b0000', zones: ['Dragon\'s Peak'] },
            'Elder Dragon': { level: 50, hp: 2000, atk: 150, xp: 2000, gold: 1000, color: '#b22222', zones: ['Dragon\'s Peak'], boss: true }
        };

        // Spawn mobs
        function spawnMobs() {
            while (mobs.length < MAX_MOBS) {
                const type = Object.keys(mobTypes)[Math.floor(Math.random() * Object.keys(mobTypes).length)];
                const data = mobTypes[type];
                if (data.boss && mobs.some(m => m.type === type)) continue;

                const zone = data.zones[Math.floor(Math.random() * data.zones.length)];
                const zoneData = zones[zone];

                mobs.push({
                    type: type,
                    x: zoneData.x + Math.random() * zoneData.width,
                    y: zoneData.y + Math.random() * zoneData.height,
                    width: data.boss ? 40 : 20,
                    height: data.boss ? 40 : 20,
                    hp: data.hp,
                    maxHp: data.hp,
                    level: data.level,
                    atk: data.atk,
                    xp: data.xp,
                    gold: data.gold,
                    color: data.color,
                    respawnTimer: 0,
                    zone: zone,
                    boss: data.boss || false
                });
            }
        }

        // Chat system
        function addChatMessage(type, sender, message) {
            const prefix = type === 'global' ? '[Global]' :
                          type === 'trade' ? '[Trade]' :
                          type === 'group' ? '[Group]' :
                          type === 'whisper' ? '[Whisper]' :
                          type === 'system' ? '[System]' : '';

            chatMessages.push({
                type: type,
                sender: sender,
                message: message,
                prefix: prefix,
                time: Date.now()
            });

            if (chatMessages.length > 100) {
                chatMessages.shift();
            }

            updateChatUI();
        }

        function updateChatUI() {
            const chatDiv = document.getElementById('chatMessages');
            chatDiv.innerHTML = '';

            chatMessages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `chat-message chat-${msg.type}`;
                const senderText = msg.sender ? `<strong>${msg.sender}:</strong> ` : '';
                div.innerHTML = `${msg.prefix} ${senderText}${msg.message}`;
                chatDiv.appendChild(div);
            });

            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        // AI chat generator
        const chatTemplates = {
            Grinder: [
                'grinding {zone} mobs',
                'lvl {level} now',
                'got {item}',
                '...'
            ],
            Social: [
                'hey everyone!',
                'anyone want to party?',
                'LFG {zone}',
                'whats up chat',
                'hows everyone doing?',
                'anyone online?',
                'looking for friends to play with'
            ],
            Tryhard: [
                'LFG {zone} need healer',
                'wtb good weapon',
                'need better gear',
                'anyone want to do dragon?',
                'forming raid group for dragon',
                'need tank and heals',
                'DPS LFG',
                'whats the best class?'
            ],
            Noob: [
                'how do i level up?',
                'where do i go?',
                'im lost help',
                'how do i use abilities?',
                'can someone help me?',
                'this is my first time',
                'what do i do?',
                'died again lol'
            ],
            Troll: [
                'this game sucks',
                'lol noob',
                'git gud',
                'ez',
                '1v1 me',
                'youre all trash',
                'lmao',
                'imagine dying to {mob}'
            ],
            Helper: [
                'need help? ask me',
                'happy to help new players',
                'let me know if you need anything',
                'i can help with quests',
                'anyone need items? i can spare some',
                'tips: {tip}'
            ],
            AFK: [
                'brb',
                'afk',
                'back',
                'gotta go',
                '...'
            ],
            RPer: [
                '*draws sword*',
                '*looks around*',
                'Greetings, traveler',
                '*casts spell*',
                'The darkness grows...',
                '*bows*',
                'May the light guide you'
            ]
        };

        function generateAIChat(ai) {
            const templates = chatTemplates[ai.personality];
            if (!templates || templates.length === 0) return;

            let template = templates[Math.floor(Math.random() * templates.length)];
            template = template.replace('{zone}', ai.activity === 'combat' ? 'here' : 'zones');
            template = template.replace('{level}', ai.level);
            template = template.replace('{item}', 'loot');
            template = template.replace('{mob}', 'mob');
            template = template.replace('{tip}', 'save your gold');

            addChatMessage('global', ai.name, template);
        }

        // Update AI
        function updateAI(deltaTime) {
            aiPlayers.forEach(ai => {
                // Chat behavior
                if (Date.now() - ai.lastChat > ai.chatCooldown) {
                    if (Math.random() < 0.1) {
                        generateAIChat(ai);
                        ai.lastChat = Date.now();
                        ai.chatCooldown = Math.random() * 40000 + 20000;
                    }
                }

                // Movement and activity
                const distToTarget = Math.hypot(ai.targetX - ai.x, ai.targetY - ai.y);

                if (distToTarget < 10 || Math.random() < 0.01) {
                    // Pick new destination
                    ai.targetX = Math.random() * WORLD_WIDTH;
                    ai.targetY = Math.random() * WORLD_HEIGHT;

                    // Decide activity
                    const rand = Math.random();
                    if (ai.personality === 'Grinder' && rand < 0.7) {
                        ai.activity = 'combat';
                    } else if (ai.personality === 'Social' && rand < 0.5) {
                        ai.activity = 'social';
                        ai.targetX = 1600;
                        ai.targetY = 1600;
                    } else {
                        ai.activity = 'wandering';
                    }
                }

                // Move toward target
                const dx = ai.targetX - ai.x;
                const dy = ai.targetY - ai.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist > 5) {
                    ai.x += (dx / dist) * ai.speed;
                    ai.y += (dy / dist) * ai.speed;
                }
            });
        }

        // Initialize game
        function init() {
            canvas = document.getElementById('worldCanvas');
            ctx = canvas.getContext('2d');
            minimapCanvas = document.getElementById('minimapCanvas');
            minimapCtx = minimapCanvas.getContext('2d');

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // Setup event listeners
            document.addEventListener('keydown', e => {
                keys[e.key.toLowerCase()] = true;

                if (e.key === 'i' || e.key === 'I') {
                    toggleInventory();
                } else if (e.key === 'c' || e.key === 'C') {
                    toggleCharacter();
                } else if (e.key === 'l' || e.key === 'L') {
                    toggleQuests();
                } else if (e.key >= '1' && e.key <= '5') {
                    useAbility(parseInt(e.key) - 1);
                } else if (e.key === 'Enter') {
                    document.getElementById('chatInput').focus();
                } else if (e.key === 'Escape') {
                    closeAllModals();
                }
            });

            document.addEventListener('keyup', e => {
                keys[e.key.toLowerCase()] = false;
            });

            canvas.addEventListener('click', e => {
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left + camera.x;
                const clickY = e.clientY - rect.top + camera.y;

                // Check for mob clicks
                for (let mob of mobs) {
                    if (mob.hp > 0 &&
                        clickX >= mob.x - mob.width/2 &&
                        clickX <= mob.x + mob.width/2 &&
                        clickY >= mob.y - mob.height/2 &&
                        clickY <= mob.y + mob.height/2) {
                        player.target = mob;
                        updateTargetFrame();
                        return;
                    }
                }

                player.target = null;
                document.getElementById('targetFrame').classList.remove('active');
            });

            // Color picker setup
            const colors = ['#4a9eff', '#ff4a4a', '#4aff4a', '#ff4aff', '#ffff4a', '#4affff', '#ff8c4a', '#8c4aff'];
            const picker = document.getElementById('colorPicker');
            colors.forEach(color => {
                const div = document.createElement('div');
                div.className = 'color-option';
                div.style.backgroundColor = color;
                if (color === selectedColor) div.classList.add('selected');
                div.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedColor = color;
                });
                picker.appendChild(div);
            });

            // Class selection
            document.querySelectorAll('.class-option').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.class-option').forEach(e => e.classList.remove('selected'));
                    el.classList.add('selected');
                    selectedClass = el.dataset.class;
                });
            });

            // Start game button
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('closeInventory').addEventListener('click', () => {
                document.getElementById('inventoryModal').classList.remove('active');
            });
            document.getElementById('closeCharacter').addEventListener('click', () => {
                document.getElementById('characterModal').classList.remove('active');
            });
            document.getElementById('closeQuests').addEventListener('click', () => {
                document.getElementById('questModal').classList.remove('active');
            });
            document.getElementById('respawnBtn').addEventListener('click', respawn);

            // Chat input
            document.getElementById('chatInput').addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    const msg = e.target.value.trim();
                    if (msg) {
                        addChatMessage('global', player.name, msg);

                        // Sometimes AI responds
                        if (Math.random() < 0.3) {
                            setTimeout(() => {
                                const randomAI = aiPlayers[Math.floor(Math.random() * aiPlayers.length)];
                                const responses = ['lol', 'nice', 'cool', 'ok', 'same', 'ikr', 'gg', 'agreed'];
                                addChatMessage('global', randomAI.name, responses[Math.floor(Math.random() * responses.length)]);
                            }, 1000 + Math.random() * 2000);
                        }
                    }
                    e.target.value = '';
                    e.target.blur();
                }
            });

            // Loading screen
            let loadProgress = 0;
            const loadInterval = setInterval(() => {
                loadProgress += 10;
                document.getElementById('loadingFill').style.width = loadProgress + '%';

                if (loadProgress >= 100) {
                    clearInterval(loadInterval);
                }
            }, 100);
        }

        function startGame() {
            const name = document.getElementById('charNameInput').value.trim();
            if (!name || !selectedClass) {
                alert('Please enter a name and select a class');
                return;
            }

            player.name = name;
            player.class = selectedClass;
            player.color = selectedColor;

            // Set class stats
            const classInfo = classData[selectedClass];
            player.maxHp = Math.floor(100 * classInfo.hpMult);
            player.hp = player.maxHp;
            player.maxMp = Math.floor(50 * classInfo.mpMult);
            player.mp = player.maxMp;
            player.atk = Math.floor(10 * classInfo.atkMult);
            player.def = Math.floor(5 * classInfo.defMult);
            player.speed = 3 * classInfo.spdMult;
            player.abilities = classInfo.abilities;

            // Update ability icons
            for (let i = 0; i < 4; i++) {
                if (player.abilities[i]) {
                    document.getElementById(`ability${i}`).textContent = player.abilities[i].icon;
                }
            }

            // Initialize world
            initAIPlayers();
            spawnMobs();

            // Hide character creation
            document.getElementById('characterCreation').classList.remove('active');
            document.getElementById('loadingScreen').style.display = 'none';

            // Welcome message
            addChatMessage('system', null, 'Welcome to Thousand Suns!');
            addChatMessage('system', null, `${NUM_AI_PLAYERS} players online`);

            // AI welcome spam
            setTimeout(() => {
                const welcomers = aiPlayers.filter(ai => ai.personality === 'Social' || ai.personality === 'Helper').slice(0, 3);
                welcomers.forEach((ai, i) => {
                    setTimeout(() => {
                        addChatMessage('global', ai.name, `welcome ${player.name}!`);
                    }, i * 800);
                });
            }, 1000);

            updateUI();
            gameLoop();
        }

        // Game loop
        function gameLoop() {
            const now = Date.now();
            const deltaTime = (now - lastFrameTime) / 1000;
            lastFrameTime = now;
            gameTime += deltaTime;

            update(deltaTime);
            render();

            requestAnimationFrame(gameLoop);
        }

        function update(deltaTime) {
            // Player movement
            let dx = 0, dy = 0;
            if (keys['w'] || keys['arrowup']) dy -= 1;
            if (keys['s'] || keys['arrowdown']) dy += 1;
            if (keys['a'] || keys['arrowleft']) dx -= 1;
            if (keys['d'] || keys['arrowright']) dx += 1;

            if (dx !== 0 || dy !== 0) {
                const len = Math.sqrt(dx * dx + dy * dy);
                player.x += (dx / len) * player.speed;
                player.y += (dy / len) * player.speed;

                // Clamp to world
                player.x = Math.max(player.width/2, Math.min(WORLD_WIDTH - player.width/2, player.x));
                player.y = Math.max(player.height/2, Math.min(WORLD_HEIGHT - player.height/2, player.y));

                // Update zone
                updatePlayerZone();
            }

            // Camera follow
            camera.x += (player.x - canvas.width/2 - camera.x) * CAMERA_SMOOTH;
            camera.y += (player.y - canvas.height/2 - camera.y) * CAMERA_SMOOTH;
            camera.x = Math.max(0, Math.min(WORLD_WIDTH - canvas.width, camera.x));
            camera.y = Math.max(0, Math.min(WORLD_HEIGHT - canvas.height, camera.y));

            // Update AI
            updateAI(deltaTime);

            // Auto attack
            if (player.target && player.target.hp > 0) {
                const dist = Math.hypot(player.target.x - player.x, player.target.y - player.y);
                if (dist < 60 && player.attackCooldown <= 0) {
                    attackTarget(player.target);
                    player.attackCooldown = 1000;
                }
            }

            if (player.attackCooldown > 0) {
                player.attackCooldown -= deltaTime * 1000;
            }

            // Update mobs
            mobs.forEach(mob => {
                if (mob.hp <= 0) {
                    mob.respawnTimer += deltaTime * 1000;
                    if (mob.respawnTimer > 30000) {
                        mob.hp = mob.maxHp;
                        mob.respawnTimer = 0;
                    }
                }
            });

            // Update particles
            particles = particles.filter(p => {
                p.life -= deltaTime;
                p.x += p.vx * deltaTime * 60;
                p.y += p.vy * deltaTime * 60;
                p.alpha = Math.max(0, p.life / p.maxLife);
                return p.life > 0;
            });

            // Update floating texts
            floatingTexts = floatingTexts.filter(t => {
                t.life -= deltaTime;
                t.y -= 50 * deltaTime;
                t.alpha = Math.max(0, t.life);
                return t.life > 0;
            });

            // Update cooldowns UI
            player.abilities.forEach((ability, i) => {
                if (ability.lastUsed) {
                    const elapsed = Date.now() - ability.lastUsed;
                    const remaining = Math.max(0, ability.cooldown - elapsed);
                    const percent = remaining / ability.cooldown;
                    const cdEl = document.getElementById(`cooldown${i}`);
                    if (cdEl) {
                        cdEl.style.height = (percent * 100) + '%';
                    }
                }
            });

            updateUI();
        }

        function render() {
            // Clear
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw zones
            for (let zoneName in zones) {
                const zone = zones[zoneName];
                ctx.fillStyle = zone.color;
                ctx.fillRect(zone.x - camera.x, zone.y - camera.y, zone.width, zone.height);
            }

            // Grid
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            for (let x = 0; x < WORLD_WIDTH; x += TILE_SIZE) {
                ctx.beginPath();
                ctx.moveTo(x - camera.x, -camera.y);
                ctx.lineTo(x - camera.x, WORLD_HEIGHT - camera.y);
                ctx.stroke();
            }
            for (let y = 0; y < WORLD_HEIGHT; y += TILE_SIZE) {
                ctx.beginPath();
                ctx.moveTo(-camera.x, y - camera.y);
                ctx.lineTo(WORLD_WIDTH - camera.x, y - camera.y);
                ctx.stroke();
            }

            // Draw mobs
            mobs.forEach(mob => {
                if (mob.hp <= 0) return;

                const screenX = mob.x - camera.x;
                const screenY = mob.y - camera.y;

                // Mob body
                ctx.fillStyle = mob.color;
                ctx.fillRect(screenX - mob.width/2, screenY - mob.height/2, mob.width, mob.height);

                // Name
                ctx.fillStyle = mob.boss ? '#ff0000' : '#ffaaaa';
                ctx.font = mob.boss ? 'bold 12px monospace' : '10px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(`${mob.type} (${mob.level})`, screenX, screenY - mob.height/2 - 15);

                // HP bar
                const barWidth = mob.width;
                const hpPercent = mob.hp / mob.maxHp;
                ctx.fillStyle = '#333';
                ctx.fillRect(screenX - barWidth/2, screenY - mob.height/2 - 8, barWidth, 4);
                ctx.fillStyle = hpPercent > 0.5 ? '#4caf50' : hpPercent > 0.25 ? '#ff9800' : '#f44336';
                ctx.fillRect(screenX - barWidth/2, screenY - mob.height/2 - 8, barWidth * hpPercent, 4);
            });

            // Draw AI players
            aiPlayers.forEach(ai => {
                const screenX = ai.x - camera.x;
                const screenY = ai.y - camera.y;

                // Body
                ctx.fillStyle = ai.color;
                ctx.fillRect(screenX - 12, screenY - 12, 24, 24);

                // Name
                ctx.fillStyle = '#ffffff';
                ctx.font = '9px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(`${ai.name} (${ai.level})`, screenX, screenY - 18);
            });

            // Draw player
            const screenX = player.x - camera.x;
            const screenY = player.y - camera.y;

            ctx.fillStyle = player.color;
            ctx.fillRect(screenX - player.width/2, screenY - player.height/2, player.width, player.height);

            // Player name
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 11px monospace';
            ctx.textAlign = 'center';
            ctx.fillText(player.name, screenX, screenY - player.height/2 - 20);

            // Target indicator
            if (player.target && player.target.hp > 0) {
                const tx = player.target.x - camera.x;
                const ty = player.target.y - camera.y;
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 2;
                ctx.strokeRect(tx - player.target.width/2 - 2, ty - player.target.height/2 - 2,
                              player.target.width + 4, player.target.height + 4);
            }

            // Particles
            particles.forEach(p => {
                ctx.globalAlpha = p.alpha;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - camera.x - 2, p.y - camera.y - 2, 4, 4);
            });
            ctx.globalAlpha = 1;

            // Floating text
            floatingTexts.forEach(t => {
                ctx.globalAlpha = t.alpha;
                ctx.fillStyle = t.color;
                ctx.font = 'bold 14px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(t.text, t.x - camera.x, t.y - camera.y);
            });
            ctx.globalAlpha = 1;

            // Minimap
            renderMinimap();
        }

        function renderMinimap() {
            minimapCtx.fillStyle = '#000';
            minimapCtx.fillRect(0, 0, 160, 160);

            const scale = 160 / WORLD_WIDTH;

            // Zones
            for (let zoneName in zones) {
                const zone = zones[zoneName];
                minimapCtx.fillStyle = zone.color;
                minimapCtx.fillRect(zone.x * scale, zone.y * scale, zone.width * scale, zone.height * scale);
            }

            // Mobs (red)
            minimapCtx.fillStyle = '#ff0000';
            mobs.forEach(mob => {
                if (mob.hp > 0) {
                    minimapCtx.fillRect(mob.x * scale - 1, mob.y * scale - 1, 3, 3);
                }
            });

            // AI players (white)
            minimapCtx.fillStyle = '#ffffff';
            aiPlayers.forEach(ai => {
                minimapCtx.fillRect(ai.x * scale - 1, ai.y * scale - 1, 2, 2);
            });

            // Player (yellow)
            minimapCtx.fillStyle = '#ffd700';
            minimapCtx.fillRect(player.x * scale - 2, player.y * scale - 2, 4, 4);

            // Camera bounds
            minimapCtx.strokeStyle = '#fff';
            minimapCtx.lineWidth = 1;
            minimapCtx.strokeRect(camera.x * scale, camera.y * scale, canvas.width * scale, canvas.height * scale);
        }

        function updatePlayerZone() {
            for (let zoneName in zones) {
                const zone = zones[zoneName];
                if (player.x >= zone.x && player.x <= zone.x + zone.width &&
                    player.y >= zone.y && player.y <= zone.y + zone.height) {
                    if (player.zone !== zoneName) {
                        player.zone = zoneName;
                        document.getElementById('zoneName').textContent = zoneName;
                        addChatMessage('system', null, `Entered ${zoneName}`);
                    }
                    return;
                }
            }
        }

        function updateUI() {
            document.getElementById('charName').textContent = player.name;
            document.getElementById('charLevel').textContent = `Level ${player.level} ${player.class}`;

            document.getElementById('hpBar').style.width = (player.hp / player.maxHp * 100) + '%';
            document.getElementById('hpText').textContent = `${Math.floor(player.hp)} / ${player.maxHp}`;

            document.getElementById('mpBar').style.width = (player.mp / player.maxMp * 100) + '%';
            document.getElementById('mpText').textContent = `${Math.floor(player.mp)} / ${player.maxMp}`;

            document.getElementById('xpBar').style.width = (player.xp / player.xpToNext * 100) + '%';
            document.getElementById('xpText').textContent = `${player.xp} / ${player.xpToNext} XP`;

            document.getElementById('goldAmount').textContent = player.gold;

            // Portrait
            document.getElementById('charPortrait').style.backgroundColor = player.color;
        }

        function updateTargetFrame() {
            if (!player.target) {
                document.getElementById('targetFrame').classList.remove('active');
                return;
            }

            document.getElementById('targetFrame').classList.add('active');
            document.getElementById('targetName').textContent = player.target.type;
            document.getElementById('targetLevel').textContent = `Level ${player.target.level}`;

            const hpPercent = player.target.hp / player.target.maxHp * 100;
            document.getElementById('targetHpBar').style.width = hpPercent + '%';
            document.getElementById('targetHpText').textContent =
                `${Math.floor(player.target.hp)} / ${player.target.maxHp}`;
        }

        function useAbility(index) {
            const ability = player.abilities[index];
            if (!ability) return;

            const now = Date.now();
            if (ability.lastUsed && now - ability.lastUsed < ability.cooldown) {
                addChatMessage('error', null, 'Ability on cooldown');
                return;
            }

            if (player.mp < ability.manaCost) {
                addChatMessage('error', null, 'Not enough mana');
                return;
            }

            if (ability.damage > 0 && !player.target) {
                addChatMessage('error', null, 'No target selected');
                return;
            }

            if (player.target) {
                const dist = Math.hypot(player.target.x - player.x, player.target.y - player.y);
                if (dist > ability.range) {
                    addChatMessage('error', null, 'Target out of range');
                    return;
                }
            }

            // Use ability
            player.mp -= ability.manaCost;
            ability.lastUsed = now;

            if (ability.damage > 0 && player.target) {
                dealDamage(player.target, ability.damage * (player.atk / 10));
                createParticles(player.target.x, player.target.y, ability.icon);
            } else if (ability.damage < 0) {
                // Heal
                player.hp = Math.min(player.maxHp, player.hp - ability.damage);
                createParticles(player.x, player.y, 'üíö');
            }

            addChatMessage('system', null, `Used ${ability.name}`);
        }

        function attackTarget(target) {
            const damage = Math.max(1, player.atk - (target.level * 0.5));
            dealDamage(target, damage);
        }

        function dealDamage(target, amount) {
            const damage = Math.floor(amount);
            target.hp -= damage;

            floatingTexts.push({
                x: target.x,
                y: target.y,
                text: `-${damage}`,
                color: '#ff6b6b',
                life: 1,
                alpha: 1
            });

            if (target.hp <= 0) {
                killMob(target);
            }

            updateTargetFrame();
        }

        function killMob(mob) {
            player.xp += mob.xp;
            player.gold += mob.gold;

            floatingTexts.push({
                x: mob.x,
                y: mob.y - 20,
                text: `+${mob.xp} XP`,
                color: '#ffd700',
                life: 1.5,
                alpha: 1
            });

            floatingTexts.push({
                x: mob.x,
                y: mob.y - 40,
                text: `+${mob.gold} Gold`,
                color: '#ffd700',
                life: 1.5,
                alpha: 1
            });

            // Level up check
            while (player.xp >= player.xpToNext) {
                levelUp();
            }

            createParticles(mob.x, mob.y, 'üíÄ');

            if (player.target === mob) {
                player.target = null;
                document.getElementById('targetFrame').classList.remove('active');
            }
        }

        function levelUp() {
            player.level++;
            player.xp -= player.xpToNext;
            player.xpToNext = Math.floor(player.xpToNext * 1.5);

            const classInfo = classData[player.class];
            player.maxHp = Math.floor(100 * classInfo.hpMult * (1 + player.level * 0.1));
            player.maxMp = Math.floor(50 * classInfo.mpMult * (1 + player.level * 0.1));
            player.atk = Math.floor(10 * classInfo.atkMult * (1 + player.level * 0.15));
            player.def = Math.floor(5 * classInfo.defMult * (1 + player.level * 0.1));

            player.hp = player.maxHp;
            player.mp = player.maxMp;

            createParticles(player.x, player.y, '‚≠ê');
            addChatMessage('system', null, `LEVEL UP! You are now level ${player.level}`);

            floatingTexts.push({
                x: player.x,
                y: player.y,
                text: 'LEVEL UP!',
                color: '#ffd700',
                life: 2,
                alpha: 1
            });
        }

        function createParticles(x, y, emoji) {
            for (let i = 0; i < 10; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 3,
                    vy: (Math.random() - 0.5) * 3,
                    color: `hsl(${Math.random() * 360}, 70%, 60%)`,
                    life: 0.5 + Math.random() * 0.5,
                    maxLife: 1,
                    alpha: 1
                });
            }
        }

        function toggleInventory() {
            const modal = document.getElementById('inventoryModal');
            modal.classList.toggle('active');

            if (modal.classList.contains('active')) {
                renderInventory();
            }
        }

        function renderInventory() {
            // Equipment
            const equipDiv = document.getElementById('equipmentSlots');
            equipDiv.innerHTML = '';

            ['weapon', 'armor', 'ring', 'trinket'].forEach(slot => {
                const div = document.createElement('div');
                div.className = 'equipment-slot';
                div.innerHTML = `
                    <div class="slot-label">${slot.toUpperCase()}</div>
                    <div class="slot-item">${player.equipment[slot] || 'Empty'}</div>
                `;
                equipDiv.appendChild(div);
            });

            // Inventory grid
            const invDiv = document.getElementById('inventoryGrid');
            invDiv.innerHTML = '';

            for (let i = 0; i < 20; i++) {
                const div = document.createElement('div');
                div.className = 'inventory-slot';
                if (player.inventory[i]) {
                    div.classList.add('has-item');
                    div.innerHTML = `
                        <div class="item-icon">${player.inventory[i].icon || 'üì¶'}</div>
                        ${player.inventory[i].count > 1 ? `<div class="item-count">${player.inventory[i].count}</div>` : ''}
                    `;
                }
                invDiv.appendChild(div);
            }
        }

        function toggleCharacter() {
            const modal = document.getElementById('characterModal');
            modal.classList.toggle('active');

            if (modal.classList.contains('active')) {
                renderCharacterStats();
            }
        }

        function renderCharacterStats() {
            const statsDiv = document.getElementById('statsGrid');
            statsDiv.innerHTML = '';

            const stats = [
                { label: 'Level', value: player.level },
                { label: 'Class', value: player.class },
                { label: 'HP', value: `${player.maxHp}` },
                { label: 'MP', value: `${player.maxMp}` },
                { label: 'ATK', value: player.atk },
                { label: 'DEF', value: player.def },
                { label: 'SPD', value: player.speed.toFixed(1) },
                { label: 'Gold', value: player.gold }
            ];

            stats.forEach(stat => {
                const div = document.createElement('div');
                div.className = 'stat-row';
                div.innerHTML = `
                    <span class="stat-label">${stat.label}</span>
                    <span class="stat-value">${stat.value}</span>
                `;
                statsDiv.appendChild(div);
            });
        }

        function toggleQuests() {
            const modal = document.getElementById('questModal');
            modal.classList.toggle('active');

            if (modal.classList.contains('active')) {
                renderQuests();
            }
        }

        function renderQuests() {
            const questDiv = document.getElementById('questList');
            questDiv.innerHTML = '';

            if (player.quests.length === 0) {
                questDiv.innerHTML = '<div style="text-align: center; color: #888; padding: 40px;">No active quests</div>';
                return;
            }

            player.quests.forEach(quest => {
                const div = document.createElement('div');
                div.className = 'quest-item';
                div.innerHTML = `
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-desc">${quest.description}</div>
                    <div class="quest-progress">Progress: ${quest.progress}/${quest.goal}</div>
                    <div class="quest-reward">Reward: ${quest.reward}</div>
                `;
                questDiv.appendChild(div);
            });
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }

        function respawn() {
            player.hp = player.maxHp;
            player.mp = player.maxMp;
            player.x = 1600;
            player.y = 1600;
            player.target = null;

            document.getElementById('deathScreen').classList.remove('active');
            addChatMessage('system', null, 'You have respawned');
        }

        // Start initialization
        window.addEventListener('load', init);
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>