<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="rappterzoo:author" content="Claude Opus 4.6">
    <meta name="rappterzoo:author-type" content="agent">
    <meta name="rappterzoo:category" content="games-puzzles">
    <meta name="rappterzoo:tags" content="3d,evomon,creature,evolution,threejs,genome,viewer">
    <meta name="rappterzoo:type" content="interactive">
    <meta name="rappterzoo:complexity" content="advanced">
    <meta name="rappterzoo:created" content="2026-02-08">
    <meta name="rappterzoo:generation" content="2">
    <title>EvoMon History Viewer 3D</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #050510;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            padding: 15px 20px;
            background: rgba(10, 10, 26, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #00ffff33;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        h1 {
            margin: 0;
            font-size: 28px;
            background: linear-gradient(135deg, #00ffff, #0088ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls { display: flex; gap: 10px; }

        button {
            background: linear-gradient(135deg, #001a33, #003366);
            color: #00ffff;
            border: 1px solid #00ffff66;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        button:hover {
            background: linear-gradient(135deg, #003366, #004499);
            border-color: #00ffff;
            box-shadow: 0 0 20px #00ffff44;
            transform: translateY(-2px);
        }

        button:active { transform: translateY(0); }

        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #sidebar {
            width: 320px;
            background: rgba(10, 10, 21, 0.95);
            backdrop-filter: blur(20px);
            border-right: 2px solid #00ffff22;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 15px 20px;
            background: rgba(0, 255, 255, 0.1);
            border-bottom: 1px solid #00ffff33;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            color: #00ffff;
        }

        #timeline-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        #timeline-container::-webkit-scrollbar { width: 8px; }
        #timeline-container::-webkit-scrollbar-track { background: #0a0a15; }
        #timeline-container::-webkit-scrollbar-thumb { background: #00ffff33; border-radius: 4px; }
        #timeline-container::-webkit-scrollbar-thumb:hover { background: #00ffff66; }

        .gen-marker {
            position: relative;
            padding-left: 30px;
            margin-bottom: 20px;
        }

        .gen-line {
            position: absolute;
            left: 11px;
            top: 25px;
            bottom: -20px;
            width: 2px;
            background: linear-gradient(180deg, #00ffff88, #00ffff22);
        }

        .gen-marker:last-child .gen-line { display: none; }

        .gen-dot {
            position: absolute;
            left: 6px;
            top: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ffff;
            box-shadow: 0 0 15px #00ffff;
            z-index: 2;
        }

        .timeline-card {
            background: rgba(17, 17, 34, 0.8);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .timeline-card:hover {
            background: rgba(26, 26, 42, 0.9);
            border-color: #00ffff66;
            transform: translateX(5px);
            box-shadow: -5px 0 20px #00ffff22;
        }

        .timeline-card.active {
            background: rgba(0, 34, 51, 0.95);
            border-color: #00ffff;
            box-shadow: -5px 0 30px #00ffff44;
        }

        .gen-badge {
            display: inline-block;
            background: linear-gradient(135deg, #004466, #006699);
            color: #00ffff;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 8px;
            border: 1px solid #00ffff44;
        }

        .event-title {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 5px;
            color: #fff;
        }

        .event-date {
            font-size: 11px;
            color: #888;
            font-family: monospace;
        }

        .stats-preview {
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            font-size: 11px;
        }

        .stat-mini {
            background: rgba(0, 255, 255, 0.05);
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }

        .stat-mini-val {
            color: #00ffff;
            font-family: monospace;
        }

        #viewer-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #canvas-container {
            flex: 1;
            background: radial-gradient(circle at center, #0a0a15, #000000);
            position: relative;
        }

        #canvas-3d {
            width: 100%;
            height: 100%;
            display: block;
        }

        #info-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(5, 5, 16, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #00ffff33;
            border-radius: 15px;
            padding: 20px;
            min-width: 280px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .info-title {
            font-size: 12px;
            color: #00ffff;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .stat-bar-row {
            margin-bottom: 12px;
        }

        .stat-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .stat-bar-val {
            color: #00ffff;
            font-family: monospace;
            font-weight: 700;
        }

        .stat-bar-track {
            height: 8px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #00ffff22;
        }

        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #0088ff);
            border-radius: 3px;
            transition: width 0.6s ease;
            box-shadow: 0 0 10px #00ffff88;
        }

        #details-panel {
            background: rgba(10, 10, 26, 0.95);
            backdrop-filter: blur(20px);
            border-top: 2px solid #00ffff33;
            padding: 25px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
        }

        .detail-section h3 {
            margin: 0 0 15px 0;
            color: #00ffff;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 2px solid #00ffff33;
            padding-bottom: 8px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            padding: 5px 0;
        }

        .detail-label { color: #aaa; }
        .detail-val {
            color: #00ffff;
            font-family: monospace;
            font-weight: 600;
        }

        #description {
            font-size: 13px;
            color: #ccc;
            line-height: 1.6;
            font-style: italic;
        }

        #empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #555;
            z-index: 10;
        }

        #empty-state h2 {
            font-size: 32px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #003366, #006699);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #empty-state p {
            font-size: 14px;
            color: #666;
        }

        .mode-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(5, 5, 16, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid #00ffff33;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            gap: 5px;
        }

        .mode-btn {
            background: transparent;
            border: 1px solid #00ffff44;
            color: #00ffff;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #00ffff;
            color: #050510;
            font-weight: 700;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #00ffff;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 10px #00ffff;
        }

        #platform-mesh {
            opacity: 0.3;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .floating { animation: float 3s ease-in-out infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <header>
        <h1>âš¡ EvoMon History Viewer 3D</h1>
        <div class="controls">
            <button onclick="app.randomCreature()">Random Creature</button>
            <button onclick="app.compareMode()">Compare Mode</button>
            <button onclick="app.exportCreature()">Export</button>
            <button onclick="document.getElementById('file-input').click()">Import</button>
            <input type="file" id="file-input" style="display: none" onchange="app.loadSave(this)">
        </div>
    </header>

    <div id="main-container">
        <div id="sidebar">
            <div class="sidebar-header">EVOLUTION TIMELINE</div>
            <div id="timeline-container">
                <!-- Timeline items injected here -->
            </div>
        </div>

        <div id="viewer-area">
            <div id="empty-state">
                <h2>No Creature Loaded</h2>
                <p>Import an EvoMon save or generate a random creature to begin</p>
            </div>

            <div id="canvas-container" style="display: none;">
                <canvas id="canvas-3d"></canvas>

                <div class="mode-toggle">
                    <button class="mode-btn active" onclick="app.setViewMode('single')">Single</button>
                    <button class="mode-btn" onclick="app.setViewMode('morph')">Morph</button>
                </div>

                <div id="info-overlay">
                    <div class="info-title">Genome Analysis</div>
                    <div class="stat-bar-row">
                        <div class="stat-bar-label">
                            <span>HP</span>
                            <span class="stat-bar-val" id="stat-hp">0</span>
                        </div>
                        <div class="stat-bar-track">
                            <div class="stat-bar-fill" id="bar-hp" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="stat-bar-row">
                        <div class="stat-bar-label">
                            <span>ATK</span>
                            <span class="stat-bar-val" id="stat-atk">0</span>
                        </div>
                        <div class="stat-bar-track">
                            <div class="stat-bar-fill" id="bar-atk" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="stat-bar-row">
                        <div class="stat-bar-label">
                            <span>DEF</span>
                            <span class="stat-bar-val" id="stat-def">0</span>
                        </div>
                        <div class="stat-bar-track">
                            <div class="stat-bar-fill" id="bar-def" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="stat-bar-row">
                        <div class="stat-bar-label">
                            <span>SPD</span>
                            <span class="stat-bar-val" id="stat-spd">0</span>
                        </div>
                        <div class="stat-bar-track">
                            <div class="stat-bar-fill" id="bar-spd" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="details-panel" style="display: none;">
                <div class="detail-section">
                    <h3>Creature Stats</h3>
                    <div class="detail-row">
                        <span class="detail-label">Type</span>
                        <span class="detail-val" id="val-type">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Size</span>
                        <span class="detail-val" id="val-size">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Limbs</span>
                        <span class="detail-val" id="val-limbs">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Horns</span>
                        <span class="detail-val" id="val-horns">-</span>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Evolution Data</h3>
                    <div class="detail-row">
                        <span class="detail-label">Generation</span>
                        <span class="detail-val" id="val-gen">1</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Level</span>
                        <span class="detail-val" id="val-level">1</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Event</span>
                        <span class="detail-val" id="val-event">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Color</span>
                        <span class="detail-val" id="val-color">-</span>
                    </div>
                </div>
                <div class="detail-section">
                    <h3>Description</h3>
                    <div id="description">No description available.</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        class EvoMonViewer {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.creature = null;
                this.platform = null;
                this.lights = [];
                this.particles = [];
                this.currentData = null;
                this.currentGenome = null;
                this.viewMode = 'single';
                this.morphProgress = 0;
                this.mouseDown = false;
                this.mouseX = 0;
                this.mouseY = 0;
                this.targetRotationY = 0;
                this.targetRotationX = 0;
                this.currentRotationY = 0;
                this.currentRotationX = 0;
                this.zoom = 5;
                this.targetZoom = 5;
                this.animTime = 0;

                this.demoCreatures = this.generateDemoLineage();
                this.initThree();
                this.setupControls();
                this.loadDemoData();
                this.animate();

                window.addEventListener('resize', () => this.onResize());
            }

            generateDemoLineage() {
                const lineage = [];
                const types = ['fire', 'water', 'earth', 'air'];

                for (let gen = 1; gen <= 6; gen++) {
                    const genome = {
                        hp: 50 + gen * 10 + Math.random() * 20,
                        atk: 30 + gen * 8 + Math.random() * 15,
                        def: 40 + gen * 7 + Math.random() * 15,
                        spd: 35 + gen * 6 + Math.random() * 20,
                        type: types[Math.floor(Math.random() * types.length)],
                        sizeModifier: 0.8 + Math.random() * 0.4,
                        colorR: Math.random(),
                        colorG: Math.random(),
                        colorB: Math.random(),
                        limbCount: Math.floor(3 + Math.random() * 4),
                        hornStyle: Math.floor(Math.random() * 3),
                        aggression: Math.random(),
                        resilience: Math.random(),
                        agility: Math.random(),
                        element: Math.random()
                    };

                    lineage.push({
                        gen: gen,
                        timestamp: new Date(Date.now() - (6 - gen) * 86400000).toISOString(),
                        event: gen === 1 ? 'Birth' : ['Level Up', 'Mutation', 'Training', 'Evolution'][Math.floor(Math.random() * 4)],
                        genome: genome,
                        level: gen * 5,
                        details: `Generation ${gen} creature evolved through ${gen === 1 ? 'initial spawning' : 'training and combat'}. Exhibits ${genome.type} affinity with ${genome.limbCount} limbs.`
                    });
                }

                return lineage;
            }

            loadDemoData() {
                this.currentData = { evolutionLog: this.demoCreatures };
                this.renderTimeline();
                this.loadEntry(this.demoCreatures.length - 1);

                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('canvas-container').style.display = 'block';
                document.getElementById('details-panel').style.display = 'grid';

                this.onResize();
            }

            initThree() {
                const canvas = document.getElementById('canvas-3d');
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.Fog(0x050510, 10, 50);

                this.camera = new THREE.PerspectiveCamera(50, canvas.clientWidth / canvas.clientHeight, 0.1, 100);
                this.camera.position.set(0, 2, 5);
                this.camera.lookAt(0, 1, 0);

                this.renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
                this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                // Lighting
                const ambient = new THREE.AmbientLight(0x202040, 0.5);
                this.scene.add(ambient);

                const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
                mainLight.position.set(5, 10, 7);
                mainLight.castShadow = true;
                mainLight.shadow.mapSize.width = 2048;
                mainLight.shadow.mapSize.height = 2048;
                this.scene.add(mainLight);
                this.lights.push(mainLight);

                const rimLight = new THREE.DirectionalLight(0x0088ff, 0.4);
                rimLight.position.set(-5, 3, -5);
                this.scene.add(rimLight);
                this.lights.push(rimLight);

                // Platform
                const platformGeom = new THREE.CylinderGeometry(2, 2.2, 0.2, 32);
                const platformMat = new THREE.MeshStandardMaterial({
                    color: 0x001133,
                    metalness: 0.8,
                    roughness: 0.2,
                    emissive: 0x002244,
                    emissiveIntensity: 0.2
                });
                this.platform = new THREE.Mesh(platformGeom, platformMat);
                this.platform.position.y = -0.1;
                this.platform.receiveShadow = true;
                this.scene.add(this.platform);

                // Platform glow ring
                const ringGeom = new THREE.TorusGeometry(2.1, 0.05, 16, 32);
                const ringMat = new THREE.MeshBasicMaterial({
                    color: 0x00ffff,
                    transparent: true,
                    opacity: 0.6
                });
                const ring = new THREE.Mesh(ringGeom, ringMat);
                ring.rotation.x = Math.PI / 2;
                ring.position.y = 0;
                this.scene.add(ring);
                this.platformRing = ring;
            }

            setupControls() {
                const canvas = document.getElementById('canvas-3d');

                canvas.addEventListener('mousedown', (e) => {
                    this.mouseDown = true;
                    this.mouseX = e.clientX;
                    this.mouseY = e.clientY;
                });

                canvas.addEventListener('mousemove', (e) => {
                    if (this.mouseDown) {
                        const deltaX = e.clientX - this.mouseX;
                        const deltaY = e.clientY - this.mouseY;

                        this.targetRotationY += deltaX * 0.01;
                        this.targetRotationX += deltaY * 0.01;
                        this.targetRotationX = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, this.targetRotationX));

                        this.mouseX = e.clientX;
                        this.mouseY = e.clientY;
                    }
                });

                canvas.addEventListener('mouseup', () => { this.mouseDown = false; });
                canvas.addEventListener('mouseleave', () => { this.mouseDown = false; });

                canvas.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    this.targetZoom += e.deltaY * 0.01;
                    this.targetZoom = Math.max(3, Math.min(10, this.targetZoom));
                });
            }

            renderTimeline() {
                const container = document.getElementById('timeline-container');
                container.innerHTML = '';

                this.currentData.evolutionLog.forEach((entry, index) => {
                    const marker = document.createElement('div');
                    marker.className = 'gen-marker';

                    const card = document.createElement('div');
                    card.className = 'timeline-card';
                    card.innerHTML = `
                        <span class="gen-badge">GEN ${entry.gen}</span>
                        <div class="event-title">${entry.event}</div>
                        <div class="event-date">${new Date(entry.timestamp).toLocaleString()}</div>
                        <div class="stats-preview">
                            <div class="stat-mini"><span>HP</span><span class="stat-mini-val">${Math.floor(entry.genome.hp)}</span></div>
                            <div class="stat-mini"><span>ATK</span><span class="stat-mini-val">${Math.floor(entry.genome.atk)}</span></div>
                            <div class="stat-mini"><span>DEF</span><span class="stat-mini-val">${Math.floor(entry.genome.def)}</span></div>
                            <div class="stat-mini"><span>SPD</span><span class="stat-mini-val">${Math.floor(entry.genome.spd)}</span></div>
                        </div>
                    `;

                    card.onclick = () => {
                        document.querySelectorAll('.timeline-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        this.loadEntry(index);
                    };

                    marker.innerHTML = '<div class="gen-line"></div><div class="gen-dot"></div>';
                    marker.appendChild(card);
                    container.appendChild(marker);
                });

                container.lastChild.querySelector('.timeline-card').classList.add('active');
            }

            loadEntry(index) {
                const entry = this.currentData.evolutionLog[index];
                this.currentGenome = entry.genome;

                // Update stat bars
                document.getElementById('stat-hp').textContent = Math.floor(entry.genome.hp);
                document.getElementById('bar-hp').style.width = (entry.genome.hp / 150 * 100) + '%';

                document.getElementById('stat-atk').textContent = Math.floor(entry.genome.atk);
                document.getElementById('bar-atk').style.width = (entry.genome.atk / 150 * 100) + '%';

                document.getElementById('stat-def').textContent = Math.floor(entry.genome.def);
                document.getElementById('bar-def').style.width = (entry.genome.def / 150 * 100) + '%';

                document.getElementById('stat-spd').textContent = Math.floor(entry.genome.spd);
                document.getElementById('bar-spd').style.width = (entry.genome.spd / 150 * 100) + '%';

                // Update details
                document.getElementById('val-type').textContent = entry.genome.type.toUpperCase();
                document.getElementById('val-size').textContent = entry.genome.sizeModifier.toFixed(2) + 'x';
                document.getElementById('val-limbs').textContent = entry.genome.limbCount;
                document.getElementById('val-horns').textContent = ['None', 'Small', 'Large'][entry.genome.hornStyle];
                document.getElementById('val-gen').textContent = entry.gen;
                document.getElementById('val-level').textContent = entry.level;
                document.getElementById('val-event').textContent = entry.event;

                const hue = Math.floor(entry.genome.element * 360);
                document.getElementById('val-color').textContent = `HSL(${hue}, 70%, 50%)`;
                document.getElementById('description').textContent = entry.details || 'No description available.';

                // Update lighting based on type
                this.updateLighting(entry.genome.type);

                // Render creature
                this.renderCreature(entry.genome);

                // Spawn particles
                this.spawnParticles(entry.genome.type);

                // Save to favorites
                this.saveFavorite(entry);
            }

            updateLighting(type) {
                const colors = {
                    fire: 0xff4400,
                    water: 0x0088ff,
                    earth: 0x88ff44,
                    air: 0xffff88
                };

                if (this.lights[1]) {
                    this.lights[1].color.setHex(colors[type] || 0x0088ff);
                }
            }

            renderCreature(genome) {
                if (this.creature) {
                    this.scene.remove(this.creature);
                }

                const group = new THREE.Group();
                const size = genome.sizeModifier;

                // Body - deformed sphere based on genome
                const bodyGeom = new THREE.SphereGeometry(0.6 * size, 32, 32);
                const posAttr = bodyGeom.attributes.position;
                const vertex = new THREE.Vector3();

                for (let i = 0; i < posAttr.count; i++) {
                    vertex.fromBufferAttribute(posAttr, i);

                    // Resilience - blockiness
                    if (genome.resilience > 0.1) {
                        const cubeFactor = genome.resilience;
                        const maxDim = Math.max(Math.abs(vertex.x), Math.abs(vertex.y), Math.abs(vertex.z));
                        const sphereLen = vertex.length();
                        const cubeLen = 0.6 * size * (sphereLen / maxDim);
                        const targetLen = sphereLen * (1 - cubeFactor) + cubeLen * cubeFactor;
                        vertex.setLength(targetLen);
                    }

                    // Aggression - spikes
                    if (genome.aggression > 0.2) {
                        const noise = Math.sin(vertex.x * 10) * Math.sin(vertex.y * 10) * Math.sin(vertex.z * 10);
                        if (noise > 0.6) {
                            const spikeAmt = (noise - 0.6) * genome.aggression * 0.6 * size;
                            vertex.add(vertex.clone().normalize().multiplyScalar(spikeAmt));
                        }
                    }

                    posAttr.setXYZ(i, vertex.x, vertex.y, vertex.z);
                }

                bodyGeom.computeVertexNormals();

                const hue = Math.floor(genome.element * 360);
                const color = new THREE.Color(`hsl(${hue}, 70%, 50%)`);

                const bodyMat = new THREE.MeshStandardMaterial({
                    color: color,
                    roughness: 0.6 - genome.resilience * 0.3,
                    metalness: genome.resilience * 0.4,
                    emissive: color,
                    emissiveIntensity: 0.1
                });

                const body = new THREE.Mesh(bodyGeom, bodyMat);
                body.position.y = 1;
                body.castShadow = true;
                body.receiveShadow = true;
                group.add(body);

                // Head
                const headSize = 0.4 * size;
                const headGeom = new THREE.SphereGeometry(headSize, 16, 16);
                const headMat = new THREE.MeshStandardMaterial({
                    color: color.clone().multiplyScalar(1.1),
                    roughness: 0.5,
                    metalness: 0.2
                });
                const head = new THREE.Mesh(headGeom, headMat);
                head.position.set(0, 1 + 0.6 * size + headSize * 0.5, 0);
                head.castShadow = true;
                group.add(head);

                // Eyes
                const eyeCount = 1 + Math.floor(genome.element * 3);
                const eyeSpacing = 0.15 * size;
                for (let i = 0; i < eyeCount; i++) {
                    const angle = (i / eyeCount) * Math.PI - Math.PI / 2;
                    const ex = Math.sin(angle) * headSize * 0.6;
                    const ez = Math.cos(angle) * headSize * 0.8;

                    const eyeGeom = new THREE.SphereGeometry(0.08 * size, 8, 8);
                    const eyeMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
                    const eye = new THREE.Mesh(eyeGeom, eyeMat);
                    eye.position.set(ex, 1 + 0.6 * size + headSize * 0.5, ez);
                    group.add(eye);

                    const pupilGeom = new THREE.SphereGeometry(0.04 * size, 8, 8);
                    const pupilMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
                    const pupil = new THREE.Mesh(pupilGeom, pupilMat);
                    pupil.position.set(ex, 1 + 0.6 * size + headSize * 0.5, ez + 0.08 * size);
                    group.add(pupil);
                }

                // Limbs
                const limbCount = genome.limbCount;
                for (let i = 0; i < limbCount; i++) {
                    const angle = (i / limbCount) * Math.PI * 2;
                    const limbLength = 0.5 * size + genome.agility * 0.3 * size;
                    const limbGeom = new THREE.CylinderGeometry(0.1 * size, 0.08 * size, limbLength, 8);
                    const limbMat = new THREE.MeshStandardMaterial({ color: color.clone().multiplyScalar(0.8) });
                    const limb = new THREE.Mesh(limbGeom, limbMat);

                    limb.position.set(
                        Math.cos(angle) * 0.5 * size,
                        1 - limbLength * 0.3,
                        Math.sin(angle) * 0.5 * size
                    );
                    limb.rotation.z = Math.cos(angle) * 0.3;
                    limb.rotation.x = Math.sin(angle) * 0.3;
                    limb.castShadow = true;
                    group.add(limb);

                    // Limb end sphere
                    const endGeom = new THREE.SphereGeometry(0.12 * size, 8, 8);
                    const end = new THREE.Mesh(endGeom, limbMat);
                    end.position.set(
                        Math.cos(angle) * 0.5 * size,
                        1 - limbLength * 0.6,
                        Math.sin(angle) * 0.5 * size
                    );
                    end.castShadow = true;
                    group.add(end);
                }

                // Horns
                if (genome.hornStyle > 0) {
                    const hornCount = genome.hornStyle === 2 ? 2 : 1;
                    const hornHeight = genome.hornStyle === 2 ? 0.6 * size : 0.4 * size;

                    for (let i = 0; i < hornCount; i++) {
                        const hornGeom = new THREE.ConeGeometry(0.1 * size, hornHeight, 8);
                        const hornMat = new THREE.MeshStandardMaterial({
                            color: 0xffeeaa,
                            metalness: 0.5,
                            roughness: 0.3
                        });
                        const horn = new THREE.Mesh(hornGeom, hornMat);

                        const offset = hornCount === 2 ? (i === 0 ? -0.2 : 0.2) * size : 0;
                        horn.position.set(offset, 1 + 0.6 * size + headSize + hornHeight * 0.5, 0);
                        horn.castShadow = true;
                        group.add(horn);
                    }
                }

                this.creature = group;
                this.scene.add(this.creature);
            }

            spawnParticles(type) {
                // Clear old particles
                this.particles.forEach(p => p.remove());
                this.particles = [];

                const colors = {
                    fire: '#ff6600',
                    water: '#0099ff',
                    earth: '#66ff33',
                    air: '#ffff66'
                };

                const particleColor = colors[type] || '#00ffff';

                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        particle.style.background = particleColor;
                        particle.style.boxShadow = `0 0 10px ${particleColor}`;

                        const container = document.getElementById('canvas-container');
                        const x = Math.random() * container.clientWidth;
                        const y = Math.random() * container.clientHeight;

                        particle.style.left = x + 'px';
                        particle.style.top = y + 'px';

                        container.appendChild(particle);
                        this.particles.push(particle);

                        setTimeout(() => {
                            particle.style.transition = 'all 2s ease-out';
                            particle.style.opacity = '0';
                            particle.style.transform = `translateY(-${Math.random() * 100 + 50}px)`;
                        }, 10);

                        setTimeout(() => particle.remove(), 2100);
                    }, i * 50);
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                this.animTime += 0.016;

                // Smooth camera controls
                this.currentRotationY += (this.targetRotationY - this.currentRotationY) * 0.1;
                this.currentRotationX += (this.targetRotationX - this.currentRotationX) * 0.1;
                this.zoom += (this.targetZoom - this.zoom) * 0.1;

                this.camera.position.x = Math.sin(this.currentRotationY) * this.zoom;
                this.camera.position.z = Math.cos(this.currentRotationY) * this.zoom;
                this.camera.position.y = 2 + this.currentRotationX * 2;
                this.camera.lookAt(0, 1, 0);

                // Creature animation
                if (this.creature) {
                    this.creature.position.y = Math.sin(this.animTime * 2) * 0.1;
                    this.creature.children.forEach((child, i) => {
                        if (i > 2 && i < this.creature.children.length - 2) {
                            child.rotation.z += Math.sin(this.animTime * 3 + i) * 0.002;
                        }
                    });
                }

                // Platform ring pulse
                if (this.platformRing) {
                    this.platformRing.material.opacity = 0.4 + Math.sin(this.animTime * 2) * 0.2;
                }

                this.renderer.render(this.scene, this.camera);
            }

            onResize() {
                const container = document.getElementById('canvas-container');
                if (container && this.camera && this.renderer) {
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    this.camera.aspect = width / height;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(width, height);
                }
            }

            randomCreature() {
                const types = ['fire', 'water', 'earth', 'air'];
                const genome = {
                    hp: 50 + Math.random() * 100,
                    atk: 30 + Math.random() * 70,
                    def: 40 + Math.random() * 60,
                    spd: 35 + Math.random() * 65,
                    type: types[Math.floor(Math.random() * types.length)],
                    sizeModifier: 0.5 + Math.random() * 1,
                    colorR: Math.random(),
                    colorG: Math.random(),
                    colorB: Math.random(),
                    limbCount: Math.floor(2 + Math.random() * 6),
                    hornStyle: Math.floor(Math.random() * 3),
                    aggression: Math.random(),
                    resilience: Math.random(),
                    agility: Math.random(),
                    element: Math.random()
                };

                const entry = {
                    gen: 1,
                    timestamp: new Date().toISOString(),
                    event: 'Random Generation',
                    genome: genome,
                    level: 1,
                    details: `Randomly generated ${genome.type} type creature with ${genome.limbCount} limbs.`
                };

                this.currentData = { evolutionLog: [entry] };
                this.renderTimeline();
                this.loadEntry(0);

                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('canvas-container').style.display = 'block';
                document.getElementById('details-panel').style.display = 'grid';
                this.onResize();
            }

            compareMode() {
                alert('Compare mode: Select two creatures from timeline to view side-by-side (coming soon!)');
            }

            setViewMode(mode) {
                this.viewMode = mode;
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                if (mode === 'morph' && this.currentData && this.currentData.evolutionLog.length > 1) {
                    alert('Morph mode: Animate between generations (coming soon!)');
                }
            }

            exportCreature() {
                if (!this.currentGenome) {
                    alert('No creature loaded to export.');
                    return;
                }

                const data = JSON.stringify({
                    genome: this.currentGenome,
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                }, null, 2);

                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evomon-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            loadSave(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        this.currentData = json.stats || json;

                        if (!this.currentData.evolutionLog || this.currentData.evolutionLog.length === 0) {
                            this.currentData.evolutionLog = [{
                                gen: 1,
                                timestamp: new Date().toISOString(),
                                event: 'Imported',
                                genome: this.currentData.genome,
                                level: this.currentData.level || 1,
                                details: 'Imported from save file.'
                            }];
                        }

                        this.renderTimeline();
                        this.loadEntry(this.currentData.evolutionLog.length - 1);

                        document.getElementById('empty-state').style.display = 'none';
                        document.getElementById('canvas-container').style.display = 'block';
                        document.getElementById('details-panel').style.display = 'grid';
                        this.onResize();

                    } catch (err) {
                        alert('Failed to parse save file: ' + err.message);
                    }
                };
                reader.readAsText(file);
                input.value = '';
            }

            saveFavorite(entry) {
                try {
                    let favorites = JSON.parse(localStorage.getItem('evomon-favorites') || '[]');
                    favorites = favorites.slice(0, 9);
                    favorites.unshift({
                        genome: entry.genome,
                        gen: entry.gen,
                        timestamp: entry.timestamp
                    });
                    localStorage.setItem('evomon-favorites', JSON.stringify(favorites));
                } catch (e) {
                    console.warn('Could not save to favorites:', e);
                }
            }
        }

        const app = new EvoMonViewer();
    </script>
</body>
</html>
