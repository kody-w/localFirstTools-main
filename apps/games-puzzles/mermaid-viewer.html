<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flow Architect — Logic Routing Puzzle</title>
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="games_puzzles">
<meta name="rappterzoo:tags" content="puzzle,logic,flowchart,routing,canvas,game,strategy,particles,audio">
<meta name="rappterzoo:type" content="game">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="3">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#080818;font-family:'Segoe UI',system-ui,sans-serif;color:#e0e8f0}
canvas{display:block;width:100%;height:100%;position:absolute;top:0;left:0}
.overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(4,4,20,0.92);z-index:100;opacity:0;pointer-events:none;transition:opacity 0.4s ease}
.overlay.active{opacity:1;pointer-events:all}
.menu-box{background:linear-gradient(135deg,#0c0c2a 0%,#14143a 100%);border:2px solid #00e5ff44;border-radius:16px;padding:40px 48px;text-align:center;box-shadow:0 0 60px rgba(0,229,255,0.1),0 0 120px rgba(255,0,200,0.06);max-width:520px;width:90%;transform:scale(0.95);transition:transform 0.4s ease}
.overlay.active .menu-box{transform:scale(1)}
.menu-box h1{font-size:42px;background:linear-gradient(90deg,#00e5ff,#ff00c8,#ffe500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px;letter-spacing:2px;text-shadow:0 0 30px rgba(0,229,255,0.3)}
.menu-box h2{font-size:28px;color:#00e5ff;margin-bottom:12px;text-shadow:0 0 20px rgba(0,229,255,0.3)}
.menu-box p{color:#8899aa;font-size:14px;margin-bottom:24px;line-height:1.6}
.menu-box .subtitle{font-size:16px;color:#667788;margin-bottom:20px;font-style:italic}
.btn{display:inline-block;padding:14px 36px;margin:8px;font-size:16px;font-weight:700;color:#fff;background:linear-gradient(135deg,#1a1a4a,#2a1a5a);border:2px solid #00e5ff66;border-radius:10px;cursor:pointer;transition:all 0.25s ease;text-transform:uppercase;letter-spacing:1px;box-shadow:0 4px 20px rgba(0,229,255,0.15)}
.btn:hover{background:linear-gradient(135deg,#2a2a6a,#3a2a7a);border-color:#00e5ff;transform:translateY(-2px);box-shadow:0 6px 30px rgba(0,229,255,0.3)}
.btn.sm{padding:10px 24px;font-size:13px;margin:5px}
.btn.accent{border-color:#ff00c866;box-shadow:0 4px 20px rgba(255,0,200,0.15)}
.btn.accent:hover{border-color:#ff00c8;box-shadow:0 6px 30px rgba(255,0,200,0.3)}
.btn.warn{border-color:#ffe50066;box-shadow:0 4px 20px rgba(255,229,0,0.1)}
.btn.warn:hover{border-color:#ffe500;box-shadow:0 6px 30px rgba(255,229,0,0.2)}
.diff-row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:12px 0}
.diff-btn{flex:1;min-width:100px;max-width:160px}
.score-display{font-size:64px;font-weight:900;background:linear-gradient(90deg,#00e5ff,#ffe500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:12px 0}
.stats-row{display:flex;gap:20px;justify-content:center;margin:16px 0;flex-wrap:wrap}
.stat-item{text-align:center}
.stat-item .val{font-size:24px;font-weight:700;color:#00e5ff}
.stat-item .lbl{font-size:11px;color:#667788;text-transform:uppercase;letter-spacing:1px}
.hs-list{text-align:left;margin:12px auto;max-width:300px}
.hs-entry{display:flex;justify-content:space-between;padding:6px 12px;border-bottom:1px solid #1a1a3a;font-size:13px}
.hs-entry .rank{color:#ffe500;width:30px}
.hs-entry .name{color:#aabbcc;flex:1}
.hs-entry .pts{color:#00e5ff;font-weight:700}
.tutorial-text{background:rgba(0,229,255,0.08);border:1px solid #00e5ff33;border-radius:8px;padding:16px;margin:12px 0;text-align:left;font-size:13px;color:#99aabb;line-height:1.7}
.tutorial-text strong{color:#00e5ff}
.palette-info{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:8px 0}
.node-badge{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid}
@media(max-width:600px){.menu-box{padding:24px 20px}.menu-box h1{font-size:28px}.btn{padding:10px 20px;font-size:14px}}
</style>
</head>
<body>
<canvas id="gc"></canvas>

<div class="overlay active" id="menu-main">
<div class="menu-box">
<h1>FLOW ARCHITECT</h1>
<p class="subtitle">Logic Routing Puzzle</p>
<p>Route data packets from sources to targets using logic nodes. Build efficient flowcharts, chain combos, and master 25 levels of increasing complexity.</p>
<div><button class="btn" onclick="game.startGame()">START GAME</button></div>
<div class="diff-row">
<button class="btn sm diff-btn" onclick="game.setDifficulty(0)" id="diff-0">CASUAL</button>
<button class="btn sm diff-btn accent" onclick="game.setDifficulty(1)" id="diff-1">NORMAL</button>
<button class="btn sm diff-btn warn" onclick="game.setDifficulty(2)" id="diff-2">EXPERT</button>
</div>
<div><button class="btn sm" onclick="game.showHighScores()">HIGH SCORES</button>
<button class="btn sm" onclick="game.showHelp()">HOW TO PLAY</button></div>
</div>
</div>

<div class="overlay" id="menu-pause">
<div class="menu-box">
<h2>PAUSED</h2>
<p>Take a breather. Your routing network awaits.</p>
<div><button class="btn" onclick="game.resume()">RESUME</button></div>
<div><button class="btn sm" onclick="game.restart()">RESTART LEVEL</button>
<button class="btn sm accent" onclick="game.quitToMenu()">QUIT</button></div>
</div>
</div>

<div class="overlay" id="menu-levelcomplete">
<div class="menu-box">
<h2>LEVEL COMPLETE!</h2>
<div class="score-display" id="lc-score">0</div>
<div class="stats-row">
<div class="stat-item"><div class="val" id="lc-efficiency">0%</div><div class="lbl">Efficiency</div></div>
<div class="stat-item"><div class="val" id="lc-time">0s</div><div class="lbl">Time</div></div>
<div class="stat-item"><div class="val" id="lc-combo">x1</div><div class="lbl">Best Combo</div></div>
<div class="stat-item"><div class="val" id="lc-grade">B</div><div class="lbl">Grade</div></div>
</div>
<div><button class="btn" onclick="game.nextLevel()">NEXT LEVEL</button></div>
<div><button class="btn sm" onclick="game.restart()">RETRY</button>
<button class="btn sm accent" onclick="game.quitToMenu()">MENU</button></div>
</div>
</div>

<div class="overlay" id="menu-gameover">
<div class="menu-box">
<h2>GAME OVER</h2>
<p>Your network couldn't handle the load.</p>
<div class="score-display" id="go-score">0</div>
<div class="stats-row">
<div class="stat-item"><div class="val" id="go-level">1</div><div class="lbl">Level Reached</div></div>
<div class="stat-item"><div class="val" id="go-total">0</div><div class="lbl">Total Score</div></div>
</div>
<div><button class="btn" onclick="game.restart()">TRY AGAIN</button></div>
<div><button class="btn sm accent" onclick="game.quitToMenu()">MENU</button></div>
</div>
</div>

<div class="overlay" id="menu-help">
<div class="menu-box">
<h2>HOW TO PLAY</h2>
<div class="tutorial-text">
<strong>Goal:</strong> Route colored data packets from INPUT sources (left) to matching OUTPUT targets (right).<br><br>
<strong>Controls:</strong><br>
• Click palette node → click grid to place<br>
• Click node output port → drag to input port to connect<br>
• Right-click or DEL to remove a node<br>
• SPACE to start/stop simulation<br>
• ESC to pause &bull; R to restart &bull; Z to undo<br>
• 1-6 keys select node types &bull; H for hint<br>
• T to activate slow-time ability<br><br>
<strong>Node Types:</strong>
</div>
<div class="palette-info">
<span class="node-badge" style="color:#00e5ff;border-color:#00e5ff44">⬦ Splitter</span>
<span class="node-badge" style="color:#ff00c8;border-color:#ff00c844">⬡ Merger</span>
<span class="node-badge" style="color:#ffe500;border-color:#ffe50044">◈ Filter</span>
<span class="node-badge" style="color:#00ff88;border-color:#00ff8844">◇ Router</span>
<span class="node-badge" style="color:#ff6622;border-color:#ff662244">◎ Switch</span>
<span class="node-badge" style="color:#aa66ff;border-color:#aa66ff44">◐ Amplifier</span>
</div>
<div><button class="btn sm" onclick="game.hideHelp()">GOT IT</button></div>
</div>
</div>

<div class="overlay" id="menu-highscores">
<div class="menu-box">
<h2>HIGH SCORES</h2>
<div class="hs-list" id="hs-list"></div>
<div><button class="btn sm" onclick="game.hideHighScores()">BACK</button></div>
</div>
</div>

<script>
// __OLD_PART1_REMOVED__

// __OLD_PART2_REMOVED__

// ===== TOOLS =====
function setTool(t){S.tool=t;document.querySelectorAll('.tb').forEach(b=>b.classList.toggle('active',b.dataset.tool===t));
cv.style.cursor=t==='select'?'default':t==='connect'?'crosshair':'crosshair'}

function setDefaultShape(s){S.defaultShape=s;document.querySelectorAll('.sp-btn').forEach(b=>b.classList.remove('active'));
document.querySelectorAll('.sp-btn').forEach(b=>{if(b.textContent.toLowerCase().startsWith(s.substring(0,3)))b.classList.add('active')})}

// ===== HISTORY =====
function pushHistory(){
  const snap={nodes:S.nodes.map(n=>({...n})),connections:S.connections.map(c=>({...c}))};
  S.history=S.history.slice(0,S.historyIdx+1);S.history.push(snap);
  if(S.history.length>S.maxHistory)S.history.shift();S.historyIdx=S.history.length-1;
}
function undo(){if(S.historyIdx<=0)return;S.historyIdx--;restore();sfx.click()}
function redo(){if(S.historyIdx>=S.history.length-1)return;S.historyIdx++;restore();sfx.click()}
function restore(){const s=S.history[S.historyIdx];S.nodes=s.nodes.map(n=>({...n}));S.connections=s.connections.map(c=>({...c}));S.selected=null;S.selectedConn=null;showProps();render()}

// ===== PROPERTIES =====
function showProps(){
  if(S.selected){
    document.getElementById('props').style.display='block';document.getElementById('props-empty').style.display='none';
    document.getElementById('p-label').value=S.selected.label;
    document.getElementById('p-fill').value=S.selected.fill;
    document.getElementById('p-stroke').value=S.selected.stroke;
    document.getElementById('p-textcol').value=S.selected.textColor;
    document.getElementById('p-w').value=S.selected.w;
    document.getElementById('p-h').value=S.selected.h;
  }else{
    document.getElementById('props').style.display='none';document.getElementById('props-empty').style.display='block';
  }
}
function updateProp(key,val){if(!S.selected)return;S.selected[key]=val;render()}

// ===== INPUT =====
cv.addEventListener('mousedown',e=>{
  sfx.init();
  const rect=cv.getBoundingClientRect();const ex=e.clientX-rect.left,ey=e.clientY-rect.top;
  if(e.button===1||(e.button===0&&e.altKey)){S.panning=true;S.panStartX=ex;S.panStartY=ey;S.panStartPanX=S.panX;S.panStartPanY=S.panY;return}
  const node=hitTestNode(ex,ey);
  if(S.tool==='select'){
    if(node){S.selected=node;S.selectedConn=null;S.dragging=true;S.dragStartX=ex;S.dragStartY=ey;S.dragNodeOX=node.x;S.dragNodeOY=node.y;pushHistory();showProps()}
    else{const conn=hitTestConnection(ex,ey);if(conn){S.selectedConn=conn;S.selected=null;showProps()}else{S.selected=null;S.selectedConn=null;showProps();S.panning=true;S.panStartX=ex;S.panStartY=ey;S.panStartPanX=S.panX;S.panStartPanY=S.panY}}
  }else if(S.tool==='connect'){
    if(node){S.connecting=true;S.connectFrom=node.id;S.dragStartX=ex;S.dragStartY=ey}
  }else if(['rect','diamond','circle','pill','text'].includes(S.tool)){
    const wx=snap((ex-S.panX)/S.zoom);const wy=snap((ey-S.panY)/S.zoom);
    pushHistory();
    const shape=S.tool==='text'?'rect':S.tool;
    const label=S.tool==='text'?'Text':undefined;
    const n=createNode(wx,wy,shape,label);
    S.nodes.push(n);S.selected=n;showProps();sfx.place();
  }
  render();
});

cv.addEventListener('mousemove',e=>{
  const rect=cv.getBoundingClientRect();const ex=e.clientX-rect.left,ey=e.clientY-rect.top;
  if(S.panning){S.panX=S.panStartPanX+(ex-S.panStartX);S.panY=S.panStartPanY+(ey-S.panStartY);render();return}
  if(S.dragging&&S.selected){
    const dx=(ex-S.dragStartX)/S.zoom;const dy=(ey-S.dragStartY)/S.zoom;
    S.selected.x=snap(S.dragNodeOX+dx);S.selected.y=snap(S.dragNodeOY+dy);render();return}
  if(S.connecting){S.dragStartX=ex;S.dragStartY=ey;render()}
});

cv.addEventListener('mouseup',e=>{
  const rect=cv.getBoundingClientRect();const ex=e.clientX-rect.left,ey=e.clientY-rect.top;
  if(S.connecting){
    const target=hitTestNode(ex,ey);
    if(target&&target.id!==S.connectFrom){
      const exists=S.connections.some(c=>c.from===S.connectFrom&&c.to===target.id);
      if(!exists){pushHistory();S.connections.push({from:S.connectFrom,to:target.id,label:''});sfx.connect()}
    }
    S.connecting=false;S.connectFrom=null;
  }
  S.dragging=false;S.panning=false;render();autoSave();
});

// Touch
cv.addEventListener('touchstart',e=>{
  const t=e.touches[0];const rect=cv.getBoundingClientRect();
  const fake={clientX:t.clientX,clientY:t.clientY,button:0,altKey:false,preventDefault:()=>{}};
  cv.dispatchEvent(new MouseEvent('mousedown',fake));
},{passive:true});
cv.addEventListener('touchmove',e=>{
  const t=e.touches[0];cv.dispatchEvent(new MouseEvent('mousemove',{clientX:t.clientX,clientY:t.clientY}));
},{passive:true});
cv.addEventListener('touchend',e=>{cv.dispatchEvent(new MouseEvent('mouseup',{clientX:0,clientY:0}))},{passive:true});

// Keyboard
addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT')return;
  if(e.key==='v'||e.key==='V')setTool('select');
  if(e.key==='r'&&!e.ctrlKey)setTool('rect');
  if(e.key==='d')setTool('diamond');
  if(e.key==='c'&&!e.ctrlKey)setTool('circle');
  if(e.key==='p')setTool('pill');
  if(e.key==='t')setTool('text');
  if(e.key==='l')setTool('connect');
  if(e.key==='Delete'||e.key==='Backspace'){
    if(S.selected){pushHistory();S.nodes=S.nodes.filter(n=>n!==S.selected);S.connections=S.connections.filter(c=>c.from!==S.selected.id&&c.to!==S.selected.id);S.selected=null;showProps();sfx.del();render()}
    else if(S.selectedConn){pushHistory();S.connections=S.connections.filter(c=>c!==S.selectedConn);S.selectedConn=null;sfx.del();render()}
  }
  if(e.ctrlKey&&e.key==='z'){e.preventDefault();undo()}
  if(e.ctrlKey&&(e.key==='y'||e.key==='Z')){e.preventDefault();redo()}
});

// Wheel zoom
cv.addEventListener('wheel',e=>{
  e.preventDefault();
  const rect=cv.getBoundingClientRect();const mx2=e.clientX-rect.left,my2=e.clientY-rect.top;
  const oldZoom=S.zoom;
  if(e.deltaY<0)S.zoom=Math.min(3,S.zoom*1.1);else S.zoom=Math.max(0.2,S.zoom/1.1);
  S.panX=mx2-(mx2-S.panX)*S.zoom/oldZoom;
  S.panY=my2-(my2-S.panY)*S.zoom/oldZoom;
  render();
},{passive:false});

// ===== ZOOM =====
function zoomIn(){S.zoom=Math.min(3,S.zoom*1.2);render()}
function zoomOut(){S.zoom=Math.max(0.2,S.zoom/1.2);render()}
function zoomFit(){
  if(!S.nodes.length)return;
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  S.nodes.forEach(n=>{minX=Math.min(minX,n.x-n.w);minY=Math.min(minY,n.y-n.h);maxX=Math.max(maxX,n.x+n.w);maxY=Math.max(maxY,n.y+n.h)});
  const w=maxX-minX;const h=maxY-minY;
  S.zoom=Math.min(2,Math.min((cv.width-80)/w,(cv.height-80)/h));
  S.panX=cv.width/2-(minX+w/2)*S.zoom;S.panY=cv.height/2-(minY+h/2)*S.zoom;
  render();
}

// ===== TEMPLATES =====
function loadTemplate(name){
  pushHistory();clearAll();
  if(name==='basic'){
    S.nodes=[createNode(300,100,'pill','Start'),createNode(300,220,'rect','Process'),createNode(300,340,'diamond','Decision?'),createNode(180,460,'rect','Option A'),createNode(420,460,'rect','Option B'),createNode(300,580,'pill','End')];
    S.connections=[{from:1,to:2,label:''},{from:2,to:3,label:''},{from:3,to:4,label:'Yes'},{from:3,to:5,label:'No'},{from:4,to:6,label:''},{from:5,to:6,label:''}];
    S.nextId=7;
  }else if(name==='decision'){
    S.nodes=[createNode(300,80,'rect','Input'),createNode(300,200,'diamond','Valid?'),createNode(150,320,'rect','Process A'),createNode(450,320,'rect','Process B'),createNode(150,440,'diamond','Check'),createNode(300,560,'rect','Output')];
    S.connections=[{from:1,to:2,label:''},{from:2,to:3,label:'Yes'},{from:2,to:4,label:'No'},{from:3,to:5,label:''},{from:4,to:6,label:''},{from:5,to:6,label:'Pass'}];
    S.nextId=7;
  }else if(name==='process'){
    S.nodes=[createNode(300,80,'pill','Begin'),createNode(300,180,'rect','Step 1'),createNode(300,280,'rect','Step 2'),createNode(300,380,'rect','Step 3'),createNode(300,480,'circle','Review'),createNode(300,580,'pill','Done')];
    S.connections=[{from:1,to:2,label:''},{from:2,to:3,label:''},{from:3,to:4,label:''},{from:4,to:5,label:''},{from:5,to:6,label:'OK'}];
    S.nextId=7;
  }
  showProps();render();zoomFit();
}

function clearAll(){S.nodes=[];S.connections=[];S.selected=null;S.selectedConn=null;S.nextId=1;showProps();render()}

// ===== EXPORT/IMPORT =====
function exportPNG(){
  const ec=document.createElement('canvas');const ectx=ec.getContext('2d');
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  S.nodes.forEach(n=>{minX=Math.min(minX,n.x-n.w);minY=Math.min(minY,n.y-n.h);maxX=Math.max(maxX,n.x+n.w);maxY=Math.max(maxY,n.y+n.h)});
  const pad=40;ec.width=maxX-minX+pad*2;ec.height=maxY-minY+pad*2;
  ectx.fillStyle='#0f0f1a';ectx.fillRect(0,0,ec.width,ec.height);
  ectx.translate(pad-minX,pad-minY);
  // Simplified render to export canvas
  S.connections.forEach(c=>{const a=S.nodes.find(n=>n.id===c.from);const b=S.nodes.find(n=>n.id===c.to);if(!a||!b)return;ectx.strokeStyle='#6495ed';ectx.lineWidth=2;ectx.beginPath();ectx.moveTo(a.x,a.y);ectx.lineTo(b.x,b.y);ectx.stroke()});
  S.nodes.forEach(n=>{ectx.fillStyle=n.fill;ectx.strokeStyle=n.stroke;ectx.lineWidth=2;
  if(n.shape==='rect'||n.shape==='pill'){ectx.fillRect(n.x-n.w/2,n.y-n.h/2,n.w,n.h);ectx.strokeRect(n.x-n.w/2,n.y-n.h/2,n.w,n.h)}
  else if(n.shape==='circle'){ectx.beginPath();ectx.arc(n.x,n.y,n.w/2,0,Math.PI*2);ectx.fill();ectx.stroke()}
  else if(n.shape==='diamond'){ectx.beginPath();ectx.moveTo(n.x,n.y-n.h/2);ectx.lineTo(n.x+n.w/2,n.y);ectx.lineTo(n.x,n.y+n.h/2);ectx.lineTo(n.x-n.w/2,n.y);ectx.closePath();ectx.fill();ectx.stroke()}
  ectx.fillStyle=n.textColor;ectx.font=n.fontSize+'px sans-serif';ectx.textAlign='center';ectx.textBaseline='middle';ectx.fillText(n.label,n.x,n.y)});
  const a=document.createElement('a');a.download='flowchart-'+Date.now()+'.png';a.href=ec.toDataURL();a.click();
}

function exportJSON(){
  const data={nodes:S.nodes,connections:S.connections,nextId:S.nextId};
  const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.download='flowchart-'+Date.now()+'.json';a.href=URL.createObjectURL(b);a.click();
}

function importJSON(){
  const input=prompt('Paste JSON:');if(!input)return;
  try{const d=JSON.parse(input);S.nodes=d.nodes;S.connections=d.connections;S.nextId=d.nextId||S.nodes.length+1;pushHistory();render();zoomFit()}catch(e){alert('Invalid JSON')}
}

function saveProject(){try{localStorage.setItem('flowcraft_project',JSON.stringify({nodes:S.nodes,connections:S.connections,nextId:S.nextId,zoom:S.zoom,panX:S.panX,panY:S.panY}))}catch(e){}}
function loadProject(){try{const d=localStorage.getItem('flowcraft_project');if(d){const p=JSON.parse(d);S.nodes=p.nodes||[];S.connections=p.connections||[];S.nextId=p.nextId||1;S.zoom=p.zoom||1;S.panX=p.panX||0;S.panY=p.panY||0;pushHistory()}}catch(e){}}
function autoSave(){saveProject()}

// ===== INIT =====
loadProject();pushHistory();showProps();render();
if(!S.nodes.length)loadTemplate('basic');
</script>
</body>
</html>