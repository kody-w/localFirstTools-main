<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flowcraft - Visual Flowchart Builder</title>
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="creative_tools">
<meta name="rappterzoo:tags" content="flowchart,diagram,editor,canvas,interactive,creative,tool">
<meta name="rappterzoo:type" content="interactive">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="2">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0f0f1a;color:#e0e0e0;font-family:'Segoe UI',sans-serif;height:100vh;overflow:hidden;display:flex}
#toolbar{width:50px;background:#151528;border-right:1px solid #2a2a4a;display:flex;flex-direction:column;align-items:center;padding:8px 0;gap:4px;z-index:20}
.tb{width:38px;height:38px;background:rgba(255,255,255,0.04);border:1px solid #2a2a4a;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#888;font-size:14px;transition:all 0.15s;position:relative}
.tb:hover{background:rgba(100,149,237,0.1);border-color:#555;color:#ddd}
.tb.active{background:rgba(100,149,237,0.2);border-color:#6495ed;color:#6495ed}
.tb .tip{position:absolute;left:46px;background:#222;color:#ddd;padding:3px 7px;border-radius:3px;font-size:10px;white-space:nowrap;display:none;z-index:100}
.tb:hover .tip{display:block}
.tsep{width:28px;height:1px;background:#2a2a4a;margin:3px 0}
#canvas-area{flex:1;position:relative;overflow:hidden;background:#0a0a15;cursor:default}
canvas{position:absolute;top:0;left:0}
#sidebar{width:240px;background:#151528;border-left:1px solid #2a2a4a;display:flex;flex-direction:column;overflow-y:auto;z-index:20}
.panel{padding:12px;border-bottom:1px solid #1e1e38}
.pt{font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.prop-row{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.prop-label{font-size:11px;color:#888;width:50px;flex-shrink:0}
.prop-input{flex:1;background:#0f0f1a;color:#e0e0e0;border:1px solid #2a2a4a;border-radius:3px;padding:4px 6px;font-size:11px;outline:none}
.prop-input:focus{border-color:#6495ed}
input[type=color]{width:30px;height:24px;border:1px solid #2a2a4a;border-radius:3px;background:none;cursor:pointer;padding:0}
.shape-picker{display:flex;gap:4px;flex-wrap:wrap}
.sp-btn{width:36px;height:30px;background:rgba(255,255,255,0.04);border:1px solid #2a2a4a;border-radius:4px;cursor:pointer;color:#888;font-size:10px;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.sp-btn:hover{background:rgba(100,149,237,0.1);color:#ddd}
.sp-btn.active{background:rgba(100,149,237,0.2);border-color:#6495ed;color:#6495ed}
.abtn{width:100%;background:rgba(100,149,237,0.1);border:1px solid rgba(100,149,237,0.25);border-radius:4px;padding:6px;color:#6495ed;font-size:11px;cursor:pointer;transition:all 0.15s;margin-top:4px}
.abtn:hover{background:rgba(100,149,237,0.2);transform:translateY(-1px)}
#status{position:absolute;bottom:8px;left:58px;background:rgba(15,15,26,0.9);border:1px solid #2a2a4a;border-radius:4px;padding:4px 10px;font-size:10px;color:#666;z-index:10}
#status span{color:#6495ed}
#minimap{position:absolute;bottom:8px;right:250px;width:120px;height:80px;background:rgba(15,15,26,0.9);border:1px solid #2a2a4a;border-radius:4px;z-index:10;overflow:hidden}
@media(max-width:768px){#sidebar{width:180px}.tb{width:32px;height:32px;font-size:12px}#toolbar{width:42px}}
</style>
</head>
<body>
<div id="toolbar">
  <div class="tb active" data-tool="select" onclick="setTool('select')"><span>V</span><span class="tip">Select (V)</span></div>
  <div class="tb" data-tool="rect" onclick="setTool('rect')"><span>[]</span><span class="tip">Rectangle (R)</span></div>
  <div class="tb" data-tool="diamond" onclick="setTool('diamond')"><span>&lt;&gt;</span><span class="tip">Diamond (D)</span></div>
  <div class="tb" data-tool="circle" onclick="setTool('circle')"><span>O</span><span class="tip">Circle (C)</span></div>
  <div class="tb" data-tool="pill" onclick="setTool('pill')"><span>()</span><span class="tip">Pill (P)</span></div>
  <div class="tb" data-tool="text" onclick="setTool('text')"><span>T</span><span class="tip">Text (T)</span></div>
  <div class="tsep"></div>
  <div class="tb" data-tool="connect" onclick="setTool('connect')"><span>-></span><span class="tip">Connect (L)</span></div>
  <div class="tsep"></div>
  <div class="tb" onclick="undo()"><span>&lt;</span><span class="tip">Undo (Ctrl+Z)</span></div>
  <div class="tb" onclick="redo()"><span>&gt;</span><span class="tip">Redo (Ctrl+Y)</span></div>
  <div class="tsep"></div>
  <div class="tb" onclick="zoomIn()"><span>+</span><span class="tip">Zoom In</span></div>
  <div class="tb" onclick="zoomOut()"><span>-</span><span class="tip">Zoom Out</span></div>
  <div class="tb" onclick="zoomFit()"><span>F</span><span class="tip">Fit All</span></div>
</div>
<div id="canvas-area">
  <canvas id="main-canvas"></canvas>
  <div id="status">Nodes: <span id="st-nodes">0</span> | Connections: <span id="st-conns">0</span> | Zoom: <span id="st-zoom">100%</span></div>
  <canvas id="minimap" width="120" height="80"></canvas>
</div>
<div id="sidebar">
  <div class="panel">
    <div class="pt">Properties</div>
    <div id="props-empty" style="color:#555;font-size:11px">Select a node to edit</div>
    <div id="props" style="display:none">
      <div class="prop-row"><span class="prop-label">Label</span><input class="prop-input" id="p-label" oninput="updateProp('label',this.value)"></div>
      <div class="prop-row"><span class="prop-label">Fill</span><input type="color" id="p-fill" value="#2a4a8a" oninput="updateProp('fill',this.value)"></div>
      <div class="prop-row"><span class="prop-label">Stroke</span><input type="color" id="p-stroke" value="#6495ed" oninput="updateProp('stroke',this.value)"></div>
      <div class="prop-row"><span class="prop-label">Text</span><input type="color" id="p-textcol" value="#ffffff" oninput="updateProp('textColor',this.value)"></div>
      <div class="prop-row"><span class="prop-label">Width</span><input type="number" class="prop-input" id="p-w" min="40" max="400" oninput="updateProp('w',+this.value)"></div>
      <div class="prop-row"><span class="prop-label">Height</span><input type="number" class="prop-input" id="p-h" min="30" max="300" oninput="updateProp('h',+this.value)"></div>
    </div>
  </div>
  <div class="panel">
    <div class="pt">Default Style</div>
    <div class="shape-picker">
      <div class="sp-btn active" onclick="setDefaultShape('rect')">Rect</div>
      <div class="sp-btn" onclick="setDefaultShape('diamond')">Dia</div>
      <div class="sp-btn" onclick="setDefaultShape('circle')">Circ</div>
      <div class="sp-btn" onclick="setDefaultShape('pill')">Pill</div>
    </div>
    <div class="prop-row" style="margin-top:6px"><span class="prop-label">Fill</span><input type="color" id="d-fill" value="#2a4a8a" oninput="S.defaultFill=this.value"></div>
    <div class="prop-row"><span class="prop-label">Stroke</span><input type="color" id="d-stroke" value="#6495ed" oninput="S.defaultStroke=this.value"></div>
  </div>
  <div class="panel">
    <div class="pt">Templates</div>
    <button class="abtn" onclick="loadTemplate('basic')">Basic Flow</button>
    <button class="abtn" onclick="loadTemplate('decision')">Decision Tree</button>
    <button class="abtn" onclick="loadTemplate('process')">Process Flow</button>
    <button class="abtn" onclick="clearAll()">Clear All</button>
  </div>
  <div class="panel">
    <div class="pt">Actions</div>
    <button class="abtn" onclick="exportPNG()">Export PNG</button>
    <button class="abtn" onclick="exportJSON()">Export JSON</button>
    <button class="abtn" onclick="importJSON()">Import JSON</button>
    <button class="abtn" onclick="saveProject()">Save (Auto)</button>
  </div>
</div>

<script>
// ===== AUDIO =====
class SFX{constructor(){this.c=null;this.r=false}init(){if(this.r)return;try{this.c=new(window.AudioContext||window.webkitAudioContext)();this.r=true}catch(e){}}
t(f,d,v,w){if(!this.c)return;try{const o=this.c.createOscillator(),g=this.c.createGain();o.type=w||'sine';o.frequency.setValueAtTime(f,this.c.currentTime);g.gain.setValueAtTime(v||0.02,this.c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,this.c.currentTime+d);o.connect(g);g.connect(this.c.destination);o.start();o.stop(this.c.currentTime+d)}catch(e){}}
place(){this.t(600,0.06,0.03)}connect(){this.t(400,0.08,0.03,'triangle');this.t(600,0.06,0.02)}del(){this.t(200,0.1,0.03,'sawtooth')}click(){this.t(800,0.03,0.02)}}
const sfx=new SFX();

// ===== STATE =====
const S={
  tool:'select',nodes:[],connections:[],selected:null,selectedConn:null,
  zoom:1,panX:0,panY:0,
  dragging:false,dragStartX:0,dragStartY:0,dragNodeOX:0,dragNodeOY:0,
  connecting:false,connectFrom:null,
  panning:false,panStartX:0,panStartY:0,panStartPanX:0,panStartPanY:0,
  creating:false,createStartX:0,createStartY:0,
  defaultShape:'rect',defaultFill:'#2a4a8a',defaultStroke:'#6495ed',
  history:[],historyIdx:-1,maxHistory:40,
  nextId:1,gridSize:20,snapToGrid:true
};

// ===== CANVAS =====
const cv=document.getElementById('main-canvas');
const cx=cv.getContext('2d');
const mm=document.getElementById('minimap');
const mx=mm.getContext('2d');

function resize(){cv.width=cv.parentElement.clientWidth;cv.height=cv.parentElement.clientHeight;render()}
addEventListener('resize',resize);resize();

// ===== NODE =====
function createNode(x,y,shape,label){
  const id=S.nextId++;
  const node={
    id,x,y,w:shape==='circle'?80:120,h:shape==='circle'?80:60,
    shape:shape||S.defaultShape,
    label:label||'Node '+id,
    fill:S.defaultFill,stroke:S.defaultStroke,textColor:'#ffffff',
    fontSize:12
  };
  if(shape==='diamond'){node.w=100;node.h=80}
  if(shape==='pill'){node.w=140;node.h=50}
  return node;
}

// ===== SNAP =====
function snap(v){return S.snapToGrid?Math.round(v/S.gridSize)*S.gridSize:v}

// ===== HIT TEST =====
function hitTestNode(mx,my){
  const wx=(mx-S.panX)/S.zoom;const wy=(my-S.panY)/S.zoom;
  for(let i=S.nodes.length-1;i>=0;i--){
    const n=S.nodes[i];
    switch(n.shape){
      case 'rect':case 'pill':if(wx>=n.x-n.w/2&&wx<=n.x+n.w/2&&wy>=n.y-n.h/2&&wy<=n.y+n.h/2)return n;break;
      case 'circle':const d=Math.sqrt((wx-n.x)**2+(wy-n.y)**2);if(d<=n.w/2)return n;break;
      case 'diamond':const dx=Math.abs(wx-n.x)/(n.w/2),dy=Math.abs(wy-n.y)/(n.h/2);if(dx+dy<=1)return n;break;
    }
  }
  return null;
}

function hitTestConnection(mx,my){
  const wx=(mx-S.panX)/S.zoom;const wy=(my-S.panY)/S.zoom;
  for(const c of S.connections){
    const a=S.nodes.find(n=>n.id===c.from);const b=S.nodes.find(n=>n.id===c.to);
    if(!a||!b)continue;
    // Simple line distance check
    const dx=b.x-a.x,dy=b.y-a.y;const len=Math.sqrt(dx*dx+dy*dy);if(len===0)continue;
    const t=Math.max(0,Math.min(1,((wx-a.x)*dx+(wy-a.y)*dy)/(len*len)));
    const px=a.x+t*dx,py=a.y+t*dy;
    const dist=Math.sqrt((wx-px)**2+(wy-py)**2);
    if(dist<8)return c;
  }
  return null;
}

// ===== RENDER =====
function render(){
  cx.clearRect(0,0,cv.width,cv.height);
  cx.save();cx.translate(S.panX,S.panY);cx.scale(S.zoom,S.zoom);
  // Grid
  const gs=S.gridSize;
  const startX=Math.floor(-S.panX/S.zoom/gs)*gs;
  const startY=Math.floor(-S.panY/S.zoom/gs)*gs;
  const endX=startX+cv.width/S.zoom+gs*2;
  const endY=startY+cv.height/S.zoom+gs*2;
  cx.strokeStyle='rgba(100,149,237,0.05)';cx.lineWidth=0.5;
  for(let x=startX;x<endX;x+=gs){cx.beginPath();cx.moveTo(x,startY);cx.lineTo(x,endY);cx.stroke()}
  for(let y=startY;y<endY;y+=gs){cx.beginPath();cx.moveTo(startX,y);cx.lineTo(endX,y);cx.stroke()}
  // Connections
  for(const c of S.connections){
    const a=S.nodes.find(n=>n.id===c.from);const b=S.nodes.find(n=>n.id===c.to);
    if(!a||!b)continue;
    cx.strokeStyle=c===S.selectedConn?'#ff8844':'#6495ed';cx.lineWidth=c===S.selectedConn?3:2;
    cx.beginPath();cx.moveTo(a.x,a.y);cx.lineTo(b.x,b.y);cx.stroke();
    // Arrow
    const angle=Math.atan2(b.y-a.y,b.x-a.x);
    const aw=10;const midX=(a.x+b.x)/2,midY=(a.y+b.y)/2;
    cx.fillStyle=cx.strokeStyle;cx.beginPath();
    cx.moveTo(midX+Math.cos(angle)*aw,midY+Math.sin(angle)*aw);
    cx.lineTo(midX+Math.cos(angle+2.5)*aw*0.6,midY+Math.sin(angle+2.5)*aw*0.6);
    cx.lineTo(midX+Math.cos(angle-2.5)*aw*0.6,midY+Math.sin(angle-2.5)*aw*0.6);
    cx.fill();
    // Label
    if(c.label){cx.fillStyle='#aaa';cx.font='10px sans-serif';cx.textAlign='center';cx.fillText(c.label,midX,midY-8)}
  }
  // Nodes
  for(const n of S.nodes){
    const sel=n===S.selected;
    cx.fillStyle=n.fill;cx.strokeStyle=sel?'#ff8844':n.stroke;cx.lineWidth=sel?3:2;
    switch(n.shape){
      case 'rect':
        cx.beginPath();
        const rr=6;
        cx.moveTo(n.x-n.w/2+rr,n.y-n.h/2);
        cx.lineTo(n.x+n.w/2-rr,n.y-n.h/2);cx.quadraticCurveTo(n.x+n.w/2,n.y-n.h/2,n.x+n.w/2,n.y-n.h/2+rr);
        cx.lineTo(n.x+n.w/2,n.y+n.h/2-rr);cx.quadraticCurveTo(n.x+n.w/2,n.y+n.h/2,n.x+n.w/2-rr,n.y+n.h/2);
        cx.lineTo(n.x-n.w/2+rr,n.y+n.h/2);cx.quadraticCurveTo(n.x-n.w/2,n.y+n.h/2,n.x-n.w/2,n.y+n.h/2-rr);
        cx.lineTo(n.x-n.w/2,n.y-n.h/2+rr);cx.quadraticCurveTo(n.x-n.w/2,n.y-n.h/2,n.x-n.w/2+rr,n.y-n.h/2);
        cx.closePath();cx.fill();cx.stroke();break;
      case 'diamond':
        cx.beginPath();cx.moveTo(n.x,n.y-n.h/2);cx.lineTo(n.x+n.w/2,n.y);cx.lineTo(n.x,n.y+n.h/2);cx.lineTo(n.x-n.w/2,n.y);cx.closePath();cx.fill();cx.stroke();break;
      case 'circle':
        cx.beginPath();cx.arc(n.x,n.y,n.w/2,0,Math.PI*2);cx.fill();cx.stroke();break;
      case 'pill':
        cx.beginPath();const pr=n.h/2;
        cx.moveTo(n.x-n.w/2+pr,n.y-n.h/2);cx.lineTo(n.x+n.w/2-pr,n.y-n.h/2);
        cx.arc(n.x+n.w/2-pr,n.y,pr,-Math.PI/2,Math.PI/2);
        cx.lineTo(n.x-n.w/2+pr,n.y+n.h/2);
        cx.arc(n.x-n.w/2+pr,n.y,pr,Math.PI/2,-Math.PI/2);
        cx.closePath();cx.fill();cx.stroke();break;
    }
    // Label
    cx.fillStyle=n.textColor;cx.font=n.fontSize+'px sans-serif';cx.textAlign='center';cx.textBaseline='middle';
    // Word wrap
    const words=n.label.split(' ');let lines=[];let line='';const maxW=n.w-16;
    for(const w of words){const test=line?line+' '+w:w;if(cx.measureText(test).width>maxW&&line){lines.push(line);line=w}else{line=test}}
    if(line)lines.push(line);
    const lh=n.fontSize+2;const startY=n.y-(lines.length-1)*lh/2;
    lines.forEach((l,i)=>cx.fillText(l,n.x,startY+i*lh));
    // Selection handles
    if(sel){
      cx.fillStyle='#ff8844';
      const corners=[[n.x-n.w/2,n.y-n.h/2],[n.x+n.w/2,n.y-n.h/2],[n.x+n.w/2,n.y+n.h/2],[n.x-n.w/2,n.y+n.h/2]];
      corners.forEach(([cx2,cy2])=>{cx.beginPath();cx.arc(cx2,cy2,4,0,Math.PI*2);cx.fill()});
    }
  }
  // Connecting preview
  if(S.connecting&&S.connectFrom){
    const from=S.nodes.find(n=>n.id===S.connectFrom);
    if(from){
      const mx2=(S.dragStartX-S.panX)/S.zoom;const my2=(S.dragStartY-S.panY)/S.zoom;
      cx.strokeStyle='rgba(100,149,237,0.5)';cx.lineWidth=2;cx.setLineDash([5,5]);
      cx.beginPath();cx.moveTo(from.x,from.y);cx.lineTo(mx2,my2);cx.stroke();
      cx.setLineDash([]);
    }
  }
  cx.restore();
  // Status
  document.getElementById('st-nodes').textContent=S.nodes.length;
  document.getElementById('st-conns').textContent=S.connections.length;
  document.getElementById('st-zoom').textContent=Math.round(S.zoom*100)+'%';
  // Minimap
  renderMinimap();
}

function renderMinimap(){
  mx.fillStyle='rgba(15,15,26,0.9)';mx.fillRect(0,0,120,80);
  if(!S.nodes.length)return;
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  S.nodes.forEach(n=>{minX=Math.min(minX,n.x-n.w);minY=Math.min(minY,n.y-n.h);maxX=Math.max(maxX,n.x+n.w);maxY=Math.max(maxY,n.y+n.h)});
  const w=maxX-minX||1;const h=maxY-minY||1;
  const scale=Math.min(110/w,70/h);const ox=(120-w*scale)/2;const oy=(80-h*scale)/2;
  S.connections.forEach(c=>{
    const a=S.nodes.find(n=>n.id===c.from);const b=S.nodes.find(n=>n.id===c.to);
    if(!a||!b)return;
    mx.strokeStyle='#334';mx.lineWidth=1;mx.beginPath();
    mx.moveTo(ox+(a.x-minX)*scale,oy+(a.y-minY)*scale);
    mx.lineTo(ox+(b.x-minX)*scale,oy+(b.y-minY)*scale);mx.stroke();
  });
  S.nodes.forEach(n=>{mx.fillStyle=n===S.selected?'#ff8844':'#6495ed';mx.fillRect(ox+(n.x-minX)*scale-2,oy+(n.y-minY)*scale-2,4,4)});
}

// ===== TOOLS =====
function setTool(t){S.tool=t;document.querySelectorAll('.tb').forEach(b=>b.classList.toggle('active',b.dataset.tool===t));
cv.style.cursor=t==='select'?'default':t==='connect'?'crosshair':'crosshair'}

function setDefaultShape(s){S.defaultShape=s;document.querySelectorAll('.sp-btn').forEach(b=>b.classList.remove('active'));
document.querySelectorAll('.sp-btn').forEach(b=>{if(b.textContent.toLowerCase().startsWith(s.substring(0,3)))b.classList.add('active')})}

// ===== HISTORY =====
function pushHistory(){
  const snap={nodes:S.nodes.map(n=>({...n})),connections:S.connections.map(c=>({...c}))};
  S.history=S.history.slice(0,S.historyIdx+1);S.history.push(snap);
  if(S.history.length>S.maxHistory)S.history.shift();S.historyIdx=S.history.length-1;
}
function undo(){if(S.historyIdx<=0)return;S.historyIdx--;restore();sfx.click()}
function redo(){if(S.historyIdx>=S.history.length-1)return;S.historyIdx++;restore();sfx.click()}
function restore(){const s=S.history[S.historyIdx];S.nodes=s.nodes.map(n=>({...n}));S.connections=s.connections.map(c=>({...c}));S.selected=null;S.selectedConn=null;showProps();render()}

// ===== PROPERTIES =====
function showProps(){
  if(S.selected){
    document.getElementById('props').style.display='block';document.getElementById('props-empty').style.display='none';
    document.getElementById('p-label').value=S.selected.label;
    document.getElementById('p-fill').value=S.selected.fill;
    document.getElementById('p-stroke').value=S.selected.stroke;
    document.getElementById('p-textcol').value=S.selected.textColor;
    document.getElementById('p-w').value=S.selected.w;
    document.getElementById('p-h').value=S.selected.h;
  }else{
    document.getElementById('props').style.display='none';document.getElementById('props-empty').style.display='block';
  }
}
function updateProp(key,val){if(!S.selected)return;S.selected[key]=val;render()}

// ===== INPUT =====
cv.addEventListener('mousedown',e=>{
  sfx.init();
  const rect=cv.getBoundingClientRect();const ex=e.clientX-rect.left,ey=e.clientY-rect.top;
  if(e.button===1||(e.button===0&&e.altKey)){S.panning=true;S.panStartX=ex;S.panStartY=ey;S.panStartPanX=S.panX;S.panStartPanY=S.panY;return}
  const node=hitTestNode(ex,ey);
  if(S.tool==='select'){
    if(node){S.selected=node;S.selectedConn=null;S.dragging=true;S.dragStartX=ex;S.dragStartY=ey;S.dragNodeOX=node.x;S.dragNodeOY=node.y;pushHistory();showProps()}
    else{const conn=hitTestConnection(ex,ey);if(conn){S.selectedConn=conn;S.selected=null;showProps()}else{S.selected=null;S.selectedConn=null;showProps();S.panning=true;S.panStartX=ex;S.panStartY=ey;S.panStartPanX=S.panX;S.panStartPanY=S.panY}}
  }else if(S.tool==='connect'){
    if(node){S.connecting=true;S.connectFrom=node.id;S.dragStartX=ex;S.dragStartY=ey}
  }else if(['rect','diamond','circle','pill','text'].includes(S.tool)){
    const wx=snap((ex-S.panX)/S.zoom);const wy=snap((ey-S.panY)/S.zoom);
    pushHistory();
    const shape=S.tool==='text'?'rect':S.tool;
    const label=S.tool==='text'?'Text':undefined;
    const n=createNode(wx,wy,shape,label);
    S.nodes.push(n);S.selected=n;showProps();sfx.place();
  }
  render();
});

cv.addEventListener('mousemove',e=>{
  const rect=cv.getBoundingClientRect();const ex=e.clientX-rect.left,ey=e.clientY-rect.top;
  if(S.panning){S.panX=S.panStartPanX+(ex-S.panStartX);S.panY=S.panStartPanY+(ey-S.panStartY);render();return}
  if(S.dragging&&S.selected){
    const dx=(ex-S.dragStartX)/S.zoom;const dy=(ey-S.dragStartY)/S.zoom;
    S.selected.x=snap(S.dragNodeOX+dx);S.selected.y=snap(S.dragNodeOY+dy);render();return}
  if(S.connecting){S.dragStartX=ex;S.dragStartY=ey;render()}
});

cv.addEventListener('mouseup',e=>{
  const rect=cv.getBoundingClientRect();const ex=e.clientX-rect.left,ey=e.clientY-rect.top;
  if(S.connecting){
    const target=hitTestNode(ex,ey);
    if(target&&target.id!==S.connectFrom){
      const exists=S.connections.some(c=>c.from===S.connectFrom&&c.to===target.id);
      if(!exists){pushHistory();S.connections.push({from:S.connectFrom,to:target.id,label:''});sfx.connect()}
    }
    S.connecting=false;S.connectFrom=null;
  }
  S.dragging=false;S.panning=false;render();autoSave();
});

// Touch
cv.addEventListener('touchstart',e=>{
  const t=e.touches[0];const rect=cv.getBoundingClientRect();
  const fake={clientX:t.clientX,clientY:t.clientY,button:0,altKey:false,preventDefault:()=>{}};
  cv.dispatchEvent(new MouseEvent('mousedown',fake));
},{passive:true});
cv.addEventListener('touchmove',e=>{
  const t=e.touches[0];cv.dispatchEvent(new MouseEvent('mousemove',{clientX:t.clientX,clientY:t.clientY}));
},{passive:true});
cv.addEventListener('touchend',e=>{cv.dispatchEvent(new MouseEvent('mouseup',{clientX:0,clientY:0}))},{passive:true});

// Keyboard
addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT')return;
  if(e.key==='v'||e.key==='V')setTool('select');
  if(e.key==='r'&&!e.ctrlKey)setTool('rect');
  if(e.key==='d')setTool('diamond');
  if(e.key==='c'&&!e.ctrlKey)setTool('circle');
  if(e.key==='p')setTool('pill');
  if(e.key==='t')setTool('text');
  if(e.key==='l')setTool('connect');
  if(e.key==='Delete'||e.key==='Backspace'){
    if(S.selected){pushHistory();S.nodes=S.nodes.filter(n=>n!==S.selected);S.connections=S.connections.filter(c=>c.from!==S.selected.id&&c.to!==S.selected.id);S.selected=null;showProps();sfx.del();render()}
    else if(S.selectedConn){pushHistory();S.connections=S.connections.filter(c=>c!==S.selectedConn);S.selectedConn=null;sfx.del();render()}
  }
  if(e.ctrlKey&&e.key==='z'){e.preventDefault();undo()}
  if(e.ctrlKey&&(e.key==='y'||e.key==='Z')){e.preventDefault();redo()}
});

// Wheel zoom
cv.addEventListener('wheel',e=>{
  e.preventDefault();
  const rect=cv.getBoundingClientRect();const mx2=e.clientX-rect.left,my2=e.clientY-rect.top;
  const oldZoom=S.zoom;
  if(e.deltaY<0)S.zoom=Math.min(3,S.zoom*1.1);else S.zoom=Math.max(0.2,S.zoom/1.1);
  S.panX=mx2-(mx2-S.panX)*S.zoom/oldZoom;
  S.panY=my2-(my2-S.panY)*S.zoom/oldZoom;
  render();
},{passive:false});

// ===== ZOOM =====
function zoomIn(){S.zoom=Math.min(3,S.zoom*1.2);render()}
function zoomOut(){S.zoom=Math.max(0.2,S.zoom/1.2);render()}
function zoomFit(){
  if(!S.nodes.length)return;
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  S.nodes.forEach(n=>{minX=Math.min(minX,n.x-n.w);minY=Math.min(minY,n.y-n.h);maxX=Math.max(maxX,n.x+n.w);maxY=Math.max(maxY,n.y+n.h)});
  const w=maxX-minX;const h=maxY-minY;
  S.zoom=Math.min(2,Math.min((cv.width-80)/w,(cv.height-80)/h));
  S.panX=cv.width/2-(minX+w/2)*S.zoom;S.panY=cv.height/2-(minY+h/2)*S.zoom;
  render();
}

// ===== TEMPLATES =====
function loadTemplate(name){
  pushHistory();clearAll();
  if(name==='basic'){
    S.nodes=[createNode(300,100,'pill','Start'),createNode(300,220,'rect','Process'),createNode(300,340,'diamond','Decision?'),createNode(180,460,'rect','Option A'),createNode(420,460,'rect','Option B'),createNode(300,580,'pill','End')];
    S.connections=[{from:1,to:2,label:''},{from:2,to:3,label:''},{from:3,to:4,label:'Yes'},{from:3,to:5,label:'No'},{from:4,to:6,label:''},{from:5,to:6,label:''}];
    S.nextId=7;
  }else if(name==='decision'){
    S.nodes=[createNode(300,80,'rect','Input'),createNode(300,200,'diamond','Valid?'),createNode(150,320,'rect','Process A'),createNode(450,320,'rect','Process B'),createNode(150,440,'diamond','Check'),createNode(300,560,'rect','Output')];
    S.connections=[{from:1,to:2,label:''},{from:2,to:3,label:'Yes'},{from:2,to:4,label:'No'},{from:3,to:5,label:''},{from:4,to:6,label:''},{from:5,to:6,label:'Pass'}];
    S.nextId=7;
  }else if(name==='process'){
    S.nodes=[createNode(300,80,'pill','Begin'),createNode(300,180,'rect','Step 1'),createNode(300,280,'rect','Step 2'),createNode(300,380,'rect','Step 3'),createNode(300,480,'circle','Review'),createNode(300,580,'pill','Done')];
    S.connections=[{from:1,to:2,label:''},{from:2,to:3,label:''},{from:3,to:4,label:''},{from:4,to:5,label:''},{from:5,to:6,label:'OK'}];
    S.nextId=7;
  }
  showProps();render();zoomFit();
}

function clearAll(){S.nodes=[];S.connections=[];S.selected=null;S.selectedConn=null;S.nextId=1;showProps();render()}

// ===== EXPORT/IMPORT =====
function exportPNG(){
  const ec=document.createElement('canvas');const ectx=ec.getContext('2d');
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  S.nodes.forEach(n=>{minX=Math.min(minX,n.x-n.w);minY=Math.min(minY,n.y-n.h);maxX=Math.max(maxX,n.x+n.w);maxY=Math.max(maxY,n.y+n.h)});
  const pad=40;ec.width=maxX-minX+pad*2;ec.height=maxY-minY+pad*2;
  ectx.fillStyle='#0f0f1a';ectx.fillRect(0,0,ec.width,ec.height);
  ectx.translate(pad-minX,pad-minY);
  // Simplified render to export canvas
  S.connections.forEach(c=>{const a=S.nodes.find(n=>n.id===c.from);const b=S.nodes.find(n=>n.id===c.to);if(!a||!b)return;ectx.strokeStyle='#6495ed';ectx.lineWidth=2;ectx.beginPath();ectx.moveTo(a.x,a.y);ectx.lineTo(b.x,b.y);ectx.stroke()});
  S.nodes.forEach(n=>{ectx.fillStyle=n.fill;ectx.strokeStyle=n.stroke;ectx.lineWidth=2;
  if(n.shape==='rect'||n.shape==='pill'){ectx.fillRect(n.x-n.w/2,n.y-n.h/2,n.w,n.h);ectx.strokeRect(n.x-n.w/2,n.y-n.h/2,n.w,n.h)}
  else if(n.shape==='circle'){ectx.beginPath();ectx.arc(n.x,n.y,n.w/2,0,Math.PI*2);ectx.fill();ectx.stroke()}
  else if(n.shape==='diamond'){ectx.beginPath();ectx.moveTo(n.x,n.y-n.h/2);ectx.lineTo(n.x+n.w/2,n.y);ectx.lineTo(n.x,n.y+n.h/2);ectx.lineTo(n.x-n.w/2,n.y);ectx.closePath();ectx.fill();ectx.stroke()}
  ectx.fillStyle=n.textColor;ectx.font=n.fontSize+'px sans-serif';ectx.textAlign='center';ectx.textBaseline='middle';ectx.fillText(n.label,n.x,n.y)});
  const a=document.createElement('a');a.download='flowchart-'+Date.now()+'.png';a.href=ec.toDataURL();a.click();
}

function exportJSON(){
  const data={nodes:S.nodes,connections:S.connections,nextId:S.nextId};
  const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.download='flowchart-'+Date.now()+'.json';a.href=URL.createObjectURL(b);a.click();
}

function importJSON(){
  const input=prompt('Paste JSON:');if(!input)return;
  try{const d=JSON.parse(input);S.nodes=d.nodes;S.connections=d.connections;S.nextId=d.nextId||S.nodes.length+1;pushHistory();render();zoomFit()}catch(e){alert('Invalid JSON')}
}

function saveProject(){try{localStorage.setItem('flowcraft_project',JSON.stringify({nodes:S.nodes,connections:S.connections,nextId:S.nextId,zoom:S.zoom,panX:S.panX,panY:S.panY}))}catch(e){}}
function loadProject(){try{const d=localStorage.getItem('flowcraft_project');if(d){const p=JSON.parse(d);S.nodes=p.nodes||[];S.connections=p.connections||[];S.nextId=p.nextId||1;S.zoom=p.zoom||1;S.panX=p.panX||0;S.panY=p.panY||0;pushHistory()}}catch(e){}}
function autoSave(){saveProject()}

// ===== INIT =====
loadProject();pushHistory();showProps();render();
if(!S.nodes.length)loadTemplate('basic');
</script>
</body>
</html>