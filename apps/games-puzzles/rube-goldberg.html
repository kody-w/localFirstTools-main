<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Rube Goldberg Machine</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a1a2e;color:#eee;font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden;height:100vh;user-select:none}
#menu{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:16px}
#menu h1{font-size:2.8em;background:linear-gradient(135deg,#f9d423,#ff4e50);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#menu h2{color:#888;font-weight:300;font-size:1.1em}
.lg{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;max-width:660px;padding:8px}
.lb{width:76px;height:76px;border:2px solid #333;border-radius:10px;background:#16213e;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:.2s;font-size:.68em;color:#aaa;line-height:1.3}
.lb:hover{border-color:#f9d423;transform:scale(1.07);background:#1a1a3e}
.lb .n{font-size:1.6em;font-weight:700;color:#fff}
.lb .s{color:#f9d423;font-size:1em;letter-spacing:1px}
.sb{padding:12px 32px;font-size:1.1em;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:10px;color:#fff;cursor:pointer;margin-top:8px;font-weight:600}
.sb:hover{transform:scale(1.04);filter:brightness(1.1)}
#game{display:none;height:100vh;flex-direction:column}
#tb{height:44px;background:#16213e;display:flex;align-items:center;padding:0 10px;gap:6px;border-bottom:1px solid #333;flex-shrink:0}
#tb button{padding:4px 12px;border:1px solid #444;border-radius:5px;background:#1a1a2e;color:#ccc;cursor:pointer;font-size:.82em;white-space:nowrap}
#tb button:hover{border-color:#f9d423;color:#fff}
#tb button.ac{background:#f9d423;color:#111;border-color:#f9d423;font-weight:600}
#tb .sp{width:1px;height:26px;background:#333;flex-shrink:0}
#ln{font-weight:600;color:#f9d423;font-size:.9em;min-width:80px}
#pc{color:#888;font-size:.78em}
#ma{display:flex;flex:1;overflow:hidden}
#tools{width:68px;background:#0f0f23;border-right:1px solid #333;overflow-y:auto;flex-shrink:0;padding:3px}
.tl{width:62px;height:56px;margin:2px 0;border:2px solid #333;border-radius:7px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.55em;color:#888;background:#16213e;transition:.12s;gap:0}
.tl:hover{border-color:#667eea;color:#ddd}
.tl.sel{border-color:#f9d423;background:#1a1a3e;color:#f9d423}
.tl.dis{opacity:.25;pointer-events:none}
.tl .ic{font-size:1.6em;line-height:1}
.tl .ct{font-size:.95em;color:#f9d423;font-weight:700}
canvas{flex:1;display:block}
#ov{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:99}
#ov.sh{display:flex}
#ob{background:#16213e;border:2px solid #f9d423;border-radius:14px;padding:32px 40px;text-align:center;max-width:380px}
#ob h2{font-size:1.8em;margin-bottom:8px}
#ob .bs{font-size:2.8em;color:#f9d423;margin:8px 0}
#ob p{color:#aaa;margin:4px 0}
#ob button{padding:8px 24px;margin:6px;border:none;border-radius:7px;cursor:pointer;font-size:.95em;font-weight:600}
.bn{background:#f9d423;color:#111}.br{background:#444;color:#fff}.bm{background:#333;color:#fff}
#hl{position:fixed;bottom:6px;right:8px;color:#555;font-size:.62em;pointer-events:none;z-index:40;text-align:right;line-height:1.5}
</style>
</head>
<body>
<div id="menu">
<h1>&#9881;&#65039; Rube Goldberg Machine</h1>
<h2>Build incredible chain reactions!</h2>
<div class="lg" id="lg"></div>
<button class="sb" id="sbb">&#127959;&#65039; Sandbox Mode</button>
</div>
<div id="game">
<div id="tb">
<button id="mbtn">&#9776;</button>
<span id="ln"></span>
<div class="sp"></div>
<button id="pbtn">&#9654; Play</button>
<button id="sbtn">&#128012; 1x</button>
<div class="sp"></div>
<button id="ubtn">&#8617;</button>
<button id="rbtn">&#8618;</button>
<button id="cbtn">&#128465;&#65039;</button>
<div class="sp"></div>
<span id="pc"></span>
</div>
<div id="ma">
<div id="tools"></div>
<canvas id="cv"></canvas>
</div>
</div>
<div id="ov"><div id="ob"></div></div>
<div id="hl"></div>
<script>
(()=>{
"use strict";
const cv=document.getElementById('cv'),cx=cv.getContext('2d');
let W=800,H=600;
const GR=0.32,FR=0.986,BN=0.5,MXV=15;
let playing=0,spd=1,st=0,lvi=-1,sandbox=0;
let pl=[],sim=[],pts=[],us=[],rs=[];
let tool=null,dobj=null,doff={x:0,y:0},ghost=null;
let mx=0,my=0;
let stars=new Array(20).fill(0);
try{const s=localStorage.getItem('rg_s3');if(s){const p=JSON.parse(s);if(Array.isArray(p))stars=p}}catch(e){}
let rcnt=0,tdist=0,pused=0,won=0;
let ax=null;
function ia(){if(!ax)ax=new(window.AudioContext||window.webkitAudioContext)();if(ax.state==='suspended')ax.resume()}
function sn(tp){if(!ax)return;try{
const o=ax.createOscillator(),g=ax.createGain();o.connect(g);g.connect(ax.destination);const t=ax.currentTime;
if(tp==='thud'){o.type='sine';o.frequency.value=55+Math.random()*35;g.gain.setValueAtTime(.22,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12)}
else if(tp==='spring'){o.type='sine';o.frequency.setValueAtTime(280,t);o.frequency.exponentialRampToValueAtTime(880,t+.1);g.gain.setValueAtTime(.18,t);g.gain.exponentialRampToValueAtTime(.001,t+.13);o.start(t);o.stop(t+.13)}
else if(tp==='whoosh'){o.type='sawtooth';o.frequency.setValueAtTime(180,t);o.frequency.exponentialRampToValueAtTime(40,t+.25);g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);o.start(t);o.stop(t+.25)}
else if(tp==='pop'){o.type='square';o.frequency.setValueAtTime(500,t);o.frequency.exponentialRampToValueAtTime(80,t+.04);g.gain.setValueAtTime(.12,t);g.gain.exponentialRampToValueAtTime(.001,t+.06);o.start(t);o.stop(t+.06)}
else if(tp==='boom'){o.type='sawtooth';o.frequency.setValueAtTime(80,t);o.frequency.exponentialRampToValueAtTime(15,t+.35);g.gain.setValueAtTime(.25,t);g.gain.exponentialRampToValueAtTime(.001,t+.35);o.start(t);o.stop(t+.35)}
else if(tp==='win'){o.type='triangle';o.frequency.setValueAtTime(523,t);o.frequency.setValueAtTime(659,t+.08);o.frequency.setValueAtTime(784,t+.16);o.frequency.setValueAtTime(1047,t+.24);g.gain.setValueAtTime(.18,t);g.gain.exponentialRampToValueAtTime(.001,t+.45);o.start(t);o.stop(t+.45)}
else if(tp==='clk'){o.type='sine';o.frequency.value=1200;g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.02);o.start(t);o.stop(t+.02)}
else if(tp==='dom'){o.type='sine';o.frequency.value=180+Math.random()*120;g.gain.setValueAtTime(.13,t);g.gain.exponentialRampToValueAtTime(.001,t+.09);o.start(t);o.stop(t+.09)}
}catch(e){}}

const PC=['#f9d423','#ff4e50','#667eea','#43e97b','#fa709a','#4facfe','#fff'];
function ap(x,y,tp,n){for(let i=0;i<(n||5);i++){
let vx=(Math.random()-.5)*4,vy=(Math.random()-.5)*4,l=25+Math.random()*25,
c=PC[Math.floor(Math.random()*PC.length)|0],r=2;
if(tp==='s'){vx*=2.5;vy*=2.5;l=12+Math.random()*12;c=['#f9d423','#ff6b35','#fff'][Math.floor(Math.random()*3)|0]}
else if(tp==='k'){vx*=.3;vy=-1-Math.random();l=35+Math.random()*25;c='#666';r=2.5}
else if(tp==='c'){vx=(Math.random()-.5)*7;vy=-2.5-Math.random()*4.5;l=50+Math.random()*50}
pts.push({x,y,vx,vy,l,ml:l,c,r})}}
function upP(){for(let i=pts.length-1;i>=0;i--){const p=pts[i];p.x+=p.vx;p.y+=p.vy;p.vy+=.06;p.l--;if(p.l<=0)pts.splice(i,1)}}
function drP(){for(let i=0;i<pts.length;i++){const p=pts[i],a=p.l/p.ml;cx.globalAlpha=a;cx.fillStyle=p.c;cx.beginPath();cx.arc(p.x,p.y,p.r*(.5+a*.5),0,6.283);cx.fill()}cx.globalAlpha=1}

const TL=[
{id:'ball',nm:'Ball',ic:'\u{1F534}',w:20,h:20},
{id:'bball',nm:'Big Ball',ic:'\u{1F7E0}',w:30,h:30},
{id:'plank',nm:'Plank',ic:'\u{1F4CF}',w:120,h:12},
{id:'spring',nm:'Spring',ic:'\u{1F7E9}',w:40,h:14},
{id:'domino',nm:'Domino',ic:'\u25AE',w:8,h:36},
{id:'fan',nm:'Fan',ic:'\u{1F4A8}',w:30,h:30},
{id:'conv',nm:'Conveyor',ic:'\u23E9',w:100,h:10},
{id:'bumper',nm:'Bumper',ic:'\u2B55',w:24,h:24},
{id:'balloon',nm:'Balloon',ic:'\u{1F388}',w:20,h:20},
{id:'rocket',nm:'Rocket',ic:'\u{1F680}',w:40,h:14},
{id:'portal',nm:'Portal',ic:'\u{1F300}',w:28,h:28},
{id:'button',nm:'Button',ic:'\u{1F518}',w:26,h:12},
{id:'spike',nm:'Spike',ic:'\u25B2',w:30,h:22},
{id:'ramp',nm:'Ramp',ic:'\u25E2',w:100,h:50}
];
function fi(id){return TL.find(t=>t.id===id)}
function mk(tid,x,y,a){const t=fi(tid);if(!t)return null;
return{tp:tid,x:x||0,y:y||0,w:t.w,h:t.h,a:a||0,vx:0,vy:0,av:0,dyn:0,fell:0,
pair:null,trig:0,ig:-1,m:tid==='bball'?2.5:1,r:tid==='ball'?10:tid==='bball'?15:tid==='balloon'?11:tid==='bumper'?12:0}}

const LV=[
{nm:"First Roll",sx:120,sy:155,fx:680,fy:465,
tr:[{t:'plank',x:120,y:200,w:160,h:14,a:0},{t:'plank',x:600,y:490,w:260,h:14,a:0}],
tl:{plank:2},par:1},
{nm:"Bridge the Gap",sx:100,sy:255,fx:700,fy:275,
tr:[{t:'plank',x:150,y:300,w:200,h:14,a:0},{t:'plank',x:650,y:300,w:200,h:14,a:0}],
tl:{plank:1},par:1},
{nm:"Bounce Up",sx:400,sy:450,fx:400,fy:95,
tr:[{t:'plank',x:400,y:490,w:300,h:14,a:0},{t:'plank',x:400,y:140,w:220,h:14,a:0}],
tl:{spring:2},par:1},
{nm:"Domino Effect",sx:100,sy:245,fx:680,fy:265,
tr:[{t:'plank',x:400,y:290,w:700,h:14,a:0}],
tl:{domino:12},par:6},
{nm:"Wind Tunnel",sx:100,sy:265,fx:700,fy:265,
tr:[{t:'plank',x:400,y:300,w:700,h:14,a:0}],
tl:{fan:3},par:1},
{nm:"Up and Over",sx:100,sy:255,fx:700,fy:455,
tr:[{t:'plank',x:150,y:300,w:200,h:14,a:0},{t:'plank',x:400,y:200,w:30,h:260,a:0},{t:'plank',x:650,y:490,w:200,h:14,a:0}],
tl:{spring:2,plank:2},par:2},
{nm:"Conveyor Belt",sx:100,sy:255,fx:700,fy:255,
tr:[{t:'plank',x:400,y:290,w:700,h:14,a:0}],
tl:{conv:3},par:2},
{nm:"Bumper Bounce",sx:100,sy:155,fx:700,fy:455,
tr:[{t:'plank',x:100,y:200,w:130,h:14,a:0},{t:'plank',x:700,y:490,w:130,h:14,a:0}],
tl:{bumper:5,plank:2},par:4},
{nm:"Balloon Lift",sx:400,sy:475,fx:400,fy:85,
tr:[{t:'plank',x:400,y:510,w:200,h:14,a:0},{t:'plank',x:400,y:130,w:200,h:14,a:0}],
tl:{balloon:3,plank:1},par:2},
{nm:"Rocket Ride",sx:100,sy:265,fx:700,fy:105,
tr:[{t:'plank',x:160,y:300,w:220,h:14,a:0},{t:'plank',x:660,y:150,w:200,h:14,a:0}],
tl:{rocket:1,plank:2,button:1},par:2},
{nm:"Portal Warp",sx:100,sy:255,fx:700,fy:455,
tr:[{t:'plank',x:150,y:300,w:200,h:14,a:0},{t:'plank',x:650,y:490,w:200,h:14,a:0},{t:'plank',x:400,y:250,w:30,h:300,a:0}],
tl:{portal:2},par:2},
{nm:"Chain Reaction",sx:80,sy:135,fx:720,fy:465,
tr:[{t:'plank',x:200,y:180,w:300,h:14,a:0},{t:'plank',x:560,y:340,w:300,h:14,a:0},{t:'plank',x:660,y:500,w:200,h:14,a:0}],
tl:{domino:8,plank:2,spring:1},par:5},
{nm:"The Maze",sx:80,sy:85,fx:720,fy:475,
tr:[{t:'plank',x:400,y:130,w:500,h:14,a:0},{t:'plank',x:260,y:250,w:400,h:14,a:0},{t:'plank',x:520,y:370,w:400,h:14,a:0},{t:'plank',x:300,y:490,w:500,h:14,a:0}],
tl:{plank:4,spring:2},par:3},
{nm:"Fan & Spring",sx:100,sy:435,fx:700,fy:105,
tr:[{t:'plank',x:400,y:470,w:700,h:14,a:0},{t:'plank',x:660,y:150,w:200,h:14,a:0}],
tl:{fan:2,spring:2,plank:1},par:3},
{nm:"Spike Dodge",sx:100,sy:265,fx:700,fy:265,
tr:[{t:'plank',x:400,y:300,w:700,h:14,a:0},{t:'spike',x:340,y:278,w:30,h:22,a:0},{t:'spike',x:500,y:278,w:30,h:22,a:0}],
tl:{plank:2,spring:1,bumper:2},par:3},
{nm:"Sky Bridge",sx:80,sy:85,fx:720,fy:85,
tr:[{t:'plank',x:80,y:130,w:120,h:14,a:0},{t:'plank',x:720,y:130,w:120,h:14,a:0}],
tl:{plank:5,spring:2,balloon:2},par:4},
{nm:"The Factory",sx:80,sy:135,fx:720,fy:455,
tr:[{t:'plank',x:200,y:180,w:300,h:14,a:0},{t:'plank',x:600,y:320,w:300,h:14,a:0},{t:'plank',x:660,y:490,w:200,h:14,a:0}],
tl:{conv:3,spring:2,plank:2},par:4},
{nm:"Domino Rally",sx:80,sy:245,fx:720,fy:245,
tr:[{t:'plank',x:400,y:290,w:750,h:14,a:0}],
tl:{domino:16,bumper:2},par:10},
{nm:"Everything Goes",sx:80,sy:85,fx:720,fy:475,
tr:[{t:'plank',x:200,y:130,w:300,h:14,a:0},{t:'plank',x:400,y:290,w:200,h:14,a:0},{t:'plank',x:660,y:510,w:200,h:14,a:0}],
tl:{plank:3,spring:2,fan:1,domino:5,bumper:2,portal:2},par:5},
{nm:"Grand Finale",sx:80,sy:85,fx:720,fy:515,
tr:[{t:'plank',x:200,y:130,w:260,h:14,a:0},{t:'plank',x:520,y:250,w:200,h:14,a:0},{t:'plank',x:260,y:380,w:300,h:14,a:0},{t:'plank',x:660,y:550,w:200,h:14,a:0}],
tl:{plank:4,spring:3,fan:2,domino:8,bumper:3,balloon:2,rocket:1,conv:2,portal:2,button:1},par:7}
];

function bldMenu(){const g=document.getElementById('lg');g.innerHTML='';
for(let i=0;i<20;i++){const b=document.createElement('div');b.className='lb';
b.innerHTML='<span class="n">'+(i+1)+'</span><span class="s">'+'\u2605'.repeat(stars[i])+'\u2606'.repeat(3-stars[i])+'</span><span>'+LV[i].nm+'</span>';
b.onclick=(function(idx){return function(){stLv(idx)}})(i);g.appendChild(b)}}

function stLv(i){ia();lvi=i;sandbox=0;won=0;
document.getElementById('menu').style.display='none';
document.getElementById('game').style.display='flex';
document.getElementById('ln').textContent=(i+1)+'. '+LV[i].nm;
pl=[];us=[];rs=[];tool=null;playing=0;spd=1;
bldTb();rsz();upc();
document.getElementById('hl').innerHTML='Scroll=rotate \u2022 Right-click=delete \u2022 X=delete \u2022 Space=play/stop \u2022 Ctrl+Z=undo'}

document.getElementById('sbb').onclick=function(){ia();lvi=-1;sandbox=1;won=0;
document.getElementById('menu').style.display='none';
document.getElementById('game').style.display='flex';
document.getElementById('ln').textContent='\u{1F3D7}\uFE0F Sandbox';
pl=[];us=[];rs=[];tool=null;playing=0;spd=1;
bldTb();rsz();upc();
document.getElementById('hl').innerHTML='Scroll=rotate \u2022 Right-click=delete \u2022 Space=play/stop'};

document.getElementById('mbtn').onclick=function(){playing=0;sim=[];pts=[];
document.getElementById('game').style.display='none';
document.getElementById('menu').style.display='flex';
document.getElementById('hl').innerHTML='';bldMenu()};

function bldTb(){const tb=document.getElementById('tools');tb.innerHTML='';
const av=sandbox?null:(lvi>=0?LV[lvi].tl:{});
TL.forEach(t=>{const cnt=av?av[t.id]:undefined;
if(!sandbox&&cnt===undefined)return;
const u=pl.filter(p=>p.tp===t.id).length;
const rem=sandbox?99:(cnt-u);
const d=document.createElement('div');
d.className='tl'+(tool===t.id?' sel':'')+(rem<=0&&!sandbox?' dis':'');
d.innerHTML='<span class="ic">'+t.ic+'</span><span>'+t.nm+'</span><span class="ct">'+(sandbox?'\u221E':rem)+'</span>';
d.onclick=(function(tid){return function(){if(!playing&&(sandbox||rem>0)){tool=tid;bldTb();sn('clk')}}})(t.id);
tb.appendChild(d)})}

function upc(){const n=pl.length;
document.getElementById('pc').textContent=sandbox?n+' parts':n+' / par '+(lvi>=0?LV[lvi].par:0)}

function su(){us.push(JSON.stringify(pl));rs=[];if(us.length>40)us.shift()}

document.getElementById('ubtn').onclick=function(){if(playing||us.length===0)return;rs.push(JSON.stringify(pl));pl=JSON.parse(us.pop());bldTb();upc()};
document.getElementById('rbtn').onclick=function(){if(playing||rs.length===0)return;us.push(JSON.stringify(pl));pl=JSON.parse(rs.pop());bldTb();upc()};
document.getElementById('cbtn').onclick=function(){if(playing)return;su();pl=[];bldTb();upc()};
document.getElementById('pbtn').onclick=function(){ia();if(!playing)goPlay();else goStop()};
document.getElementById('sbtn').onclick=function(){spd=spd===1?.25:1;
document.getElementById('sbtn').textContent=spd===1?'\u{1F40C} 1x':'\u{1F40C} .25x';
document.getElementById('sbtn').className=spd<1?'ac':''};

function goPlay(){
playing=1;st=0;rcnt=0;tdist=0;pused=pl.length;won=0;
document.getElementById('pbtn').textContent='\u23F9 Stop';
document.getElementById('pbtn').className='ac';
sim=[];pts=[];
if(lvi>=0){const lv=LV[lvi];
const b=mk('ball',lv.sx,lv.sy,0);b.dyn=1;b.r=10;sim.push(b);
lv.tr.forEach(o=>{const s=mk(o.t==='plank'?'plank':o.t==='spike'?'spike':'plank',o.x,o.y,o.a||0);
s.tp=o.t;s.w=o.w;s.h=o.h;s.dyn=0;sim.push(s)})}
pl.forEach(o=>{const s=JSON.parse(JSON.stringify(o));
if(s.tp==='ball'||s.tp==='bball'){s.dyn=1;s.r=s.tp==='bball'?15:10}
else if(s.tp==='domino'){s.dyn=1;s.oa=s.a;s.fell=0;s.av=0}
else if(s.tp==='balloon'){s.dyn=1;s.r=11}
else if(s.tp==='rocket'){s.ig=-1}
else{s.dyn=0}
sim.push(s)});
linkP()}

function linkP(){const ps=sim.filter(b=>b.tp==='portal');
for(let i=0;i<ps.length-1;i+=2){ps[i].pair=ps[i+1];ps[i+1].pair=ps[i]}}

function goStop(){playing=0;sim=[];pts=[];won=0;
document.getElementById('pbtn').textContent='\u25B6 Play';
document.getElementById('pbtn').className='';
spd=1;document.getElementById('sbtn').textContent='\u{1F40C} 1x';document.getElementById('sbtn').className=''}

function crC(bx,by,br,rx,ry,rw,rh,ra){
const c=Math.cos(-ra),s=Math.sin(-ra),dx=bx-rx,dy=by-ry;
const lx=dx*c-dy*s,ly=dx*s+dy*c;
const hw=rw/2,hh=rh/2;
const px=Math.max(-hw,Math.min(hw,lx)),py=Math.max(-hh,Math.min(hh,ly));
const ddx=lx-px,ddy=ly-py,d2=ddx*ddx+ddy*ddy;
if(d2>=br*br)return null;
const d=Math.sqrt(d2);let nx,ny;
if(d<.001){const ex=hw-Math.abs(lx),ey=hh-Math.abs(ly);
if(ex<ey){nx=lx>0?1:-1;ny=0}else{nx=0;ny=ly>0?1:-1}}
else{nx=ddx/d;ny=ddy/d}
const c2=Math.cos(ra),s2=Math.sin(ra);
return{nx:nx*c2-ny*s2,ny:nx*s2+ny*c2,d:br-d}}

function ccC(ax,ay,ar,bx,by,br){
const dx=ax-bx,dy=ay-by,d=Math.sqrt(dx*dx+dy*dy),md=ar+br;
if(d>=md||d<.001)return null;
return{nx:dx/d,ny:dy/d,d:md-d}}

function rC(b,c,bn,fr){
b.x+=c.nx*c.d*1.02;b.y+=c.ny*c.d*1.02;
const dt=b.vx*c.nx+b.vy*c.ny;
if(dt<0){b.vx-=(1+bn)*dt*c.nx;b.vy-=(1+bn)*dt*c.ny;
const tx=-c.ny,ty=c.nx,td=b.vx*tx+b.vy*ty;
b.vx-=td*fr;b.vy-=td*fr}}

function cl(v,mn,mx){return v<mn?mn:v>mx?mx:v}

function phys(dt){
const bd=sim;const d6=dt*60;
for(let i=0;i<bd.length;i++){const b=bd[i];
if(!b.dyn)continue;
if(b.tp==='balloon'){b.vy-=GR*2.3*d6;b.vy+=GR*d6*.25}
else{b.vy+=GR*d6}
if(b.tp==='domino'&&!b.fell){
b.av+=GR*.045*Math.sin(b.a-(b.oa||0))*d6;
b.a+=b.av*d6;b.av*=.996;
if(Math.abs(b.a-(b.oa||0))>1.15){b.fell=1;b.a=(b.oa||0)+(b.a>(b.oa||0)?1.35:-1.35);sn('dom');ap(b.x,b.y-b.h/2,'s',3);rcnt++}}
b.x+=b.vx*d6;b.y+=b.vy*d6;
b.vx=cl(b.vx*FR,-MXV,MXV);b.vy=cl(b.vy*FR,-MXV,MXV);
if(b.r)tdist+=Math.sqrt(b.vx*b.vx+b.vy*b.vy)*d6*.1;
if(b.y>H+80){if(b.tp==='balloon'){bd.splice(i,1);i--;continue}b.vy=-Math.abs(b.vy)*.3;b.y=H+79}
if(b.y<-150)b.vy=.5;if(b.x<-100)b.vx=.5;if(b.x>W+100)b.vx=-.5}

for(let i=0;i<bd.length;i++){const a=bd[i];
if(!a.dyn||!a.r)continue;
for(let j=0;j<bd.length;j++){if(i===j)continue;
const b=bd[j];
if((b.tp==='ball'||b.tp==='bball')&&b.r&&b.dyn){
if(i<j){const c=ccC(a.x,a.y,a.r,b.x,b.y,b.r);
if(c){rC(a,c,BN,.04);b.vx-=c.nx*c.d*.5;b.vy-=c.ny*c.d*.5;
sn('thud');ap((a.x+b.x)/2,(a.y+b.y)/2,'s',2)}}continue}
if(b.tp==='balloon'&&b.dyn)continue;
if(b.tp==='spring'){const c=crC(a.x,a.y,a.r,b.x,b.y,b.w,b.h,b.a||0);
if(c){rC(a,c,.85,.02);a.vy-=9;sn('spring');ap(b.x,b.y-b.h/2,'s',5);rcnt++}continue}
if(b.tp==='bumper'){const c=ccC(a.x,a.y,a.r,b.x,b.y,b.w/2);
if(c){rC(a,c,1.4,.01);sn('spring');ap(a.x,a.y,'s',6);rcnt++}continue}
if(b.tp==='fan'){const dx=a.x-b.x,dy=a.y-b.y,di=Math.sqrt(dx*dx+dy*dy);
if(di<160){const fa=b.a||0,sr=3.5*(1-di/160);
a.vx+=Math.cos(fa)*sr*dt*60;a.vy+=Math.sin(fa)*sr*dt*60;
if(Math.random()<.15)ap(b.x+Math.cos(fa)*18,b.y+Math.sin(fa)*18,'k',1)}continue}
if(b.tp==='conv'){const c=crC(a.x,a.y,a.r,b.x,b.y,b.w,b.h,b.a||0);
if(c){rC(a,c,.15,0);a.vx+=2.5*dt*60}continue}
if(b.tp==='portal'&&b.pair&&!(b._cd>0)){const dx=a.x-b.x,dy=a.y-b.y;
if(dx*dx+dy*dy<(b.w/2+a.r)*(b.w/2+a.r)*.6){a.x=b.pair.x;a.y=b.pair.y-22;
sn('whoosh');ap(b.x,b.y,'s',7);ap(b.pair.x,b.pair.y,'s',7);rcnt++;
b._cd=40;b.pair._cd=40}continue}
if(b.tp==='button'&&!b.trig){const c=crC(a.x,a.y,a.r,b.x,b.y,b.w,b.h,b.a||0);
if(c){b.trig=1;sn('clk');ap(b.x,b.y,'s',4);rcnt++;
bd.forEach(r=>{if(r.tp==='rocket'&&r.ig<0)r.ig=st})}continue}
if(b.tp==='spike'){const c=crC(a.x,a.y,a.r,b.x,b.y,b.w,b.h,b.a||0);
if(c){if(a.tp==='balloon'){ap(a.x,a.y,'s',10);sn('pop');bd.splice(i,1);i--;rcnt++;break}
rC(a,c,.05,.4);a.vx*=.4;a.vy*=.4}continue}
if(b.tp==='rocket'&&b.ig>=0&&st-b.ig>.4){
const dx=a.x-b.x,dy=a.y-b.y;
if(Math.abs(dx)<55&&Math.abs(dy)<28){const ra=b.a||0;
a.vx+=Math.cos(ra)*7*dt*60;a.vy+=Math.sin(ra)*7*dt*60}continue}
if(b.tp==='domino'){
const c=crC(a.x,a.y,a.r,b.x,b.y,b.w,b.h,b.a);
if(c){if(!b.fell&&b.dyn){const side=a.x>b.x?1:-1;
b.av+=side*.07*(Math.abs(a.vx)+Math.abs(a.vy)+.5);rcnt++}
rC(a,c,BN*.4,.08);const sp=Math.sqrt(a.vx*a.vx+a.vy*a.vy);
if(sp>.3){sn('thud');ap(a.x,a.y,'s',2)}}continue}
if(b.tp==='ramp'){const c=crC(a.x,a.y,a.r,b.x,b.y,b.w,b.h,b.a||0);
if(c){rC(a,c,BN*.7,.03);const sp=Math.sqrt(a.vx*a.vx+a.vy*a.vy);
if(sp>1)sn('thud')}continue}
const c=crC(a.x,a.y,a.r,b.x,b.y,b.w,b.h,b.a||0);
if(c){rC(a,c,BN,.04);
const sp=Math.sqrt(a.vx*a.vx+a.vy*a.vy);
if(sp>.8){sn('thud');if(sp>2.5)ap(a.x+c.nx*a.r,a.y+c.ny*a.r,'s',2)}}}}

for(let i=0;i<bd.length;i++){const a=bd[i];
if(a.tp!=='domino'||a.fell||!a.dyn)continue;
for(let j=0;j<bd.length;j++){if(i===j)continue;const b=bd[j];
if(b.tp!=='domino'||b.fell||!b.dyn)continue;
const tx=a.x+Math.sin(a.a)*(a.h/2),ty=a.y-Math.cos(a.a)*(a.h/2);
const dx=tx-b.x,dy=ty-(b.y-b.h/4);
if(Math.abs(dx)<b.w*3&&Math.abs(dy)<b.h*.45){
const s=a.a>(a.oa||0)?1:-1;
b.av+=s*.045*(Math.abs(a.av)+.4)}}}

for(let i=0;i<bd.length;i++){const b=bd[i];
if(b.tp==='rocket'&&b.ig>=0){const t=st-b.ig;
if(t>.3&&Math.random()<.5){const ra=b.a||0;
ap(b.x-Math.cos(ra)*22,b.y-Math.sin(ra)*22,'k',1);
if(Math.random()<.4)ap(b.x-Math.cos(ra)*20,b.y-Math.sin(ra)*20,'s',1)}}
if(b._cd>0)b._cd--}

if(lvi>=0&&!won){const lv=LV[lvi];
for(let i=0;i<bd.length;i++){const b=bd[i];
if((b.tp==='ball'||b.tp==='bball')&&b.dyn&&b.r){
const dx=b.x-lv.fx,dy=b.y-lv.fy;
if(dx*dx+dy*dy<1024){winLv();return}}}
if(st>30){won=2}}}

function winLv(){
won=1;playing=0;sn('win');
for(let k=0;k<45;k++)ap(LV[lvi].fx,LV[lvi].fy,'c',3);
const par=LV[lvi].par;
let s=1;if(pused<=par)s=2;if(pused<=par&&(rcnt>=5||tdist>150))s=3;
if(s>stars[lvi])stars[lvi]=s;
try{localStorage.setItem('rg_s3',JSON.stringify(stars))}catch(e){}
const ob=document.getElementById('ob');
ob.innerHTML='<h2>\u{1F389} Level Complete!</h2><div class="bs">'+'\u2605'.repeat(s)+'\u2606'.repeat(3-s)+'</div>'+
'<p>Parts used: '+pused+(pused<=par?' \u2728':'')+'</p><p>Chain reactions: '+rcnt+'</p>'+
(lvi<19?'<button class="bn" id="nxb">Next \u2192</button>':'')+
'<button class="br" id="rtb">Retry</button><button class="bm" id="mnb">Menu</button>';
document.getElementById('ov').classList.add('sh');
setTimeout(function(){
if(document.getElementById('nxb'))document.getElementById('nxb').onclick=function(){clOv();goStop();stLv(lvi+1)};
document.getElementById('rtb').onclick=function(){clOv();goStop();pl=[];us=[];rs=[];bldTb();upc()};
document.getElementById('mnb').onclick=function(){clOv();document.getElementById('mbtn').onclick()}},0)}

function clOv(){document.getElementById('ov').classList.remove('sh')}

function rsz(){W=cv.parentElement.clientWidth;H=cv.parentElement.clientHeight;cv.width=W;cv.height=H}

function drO(o,al){
cx.save();cx.translate(o.x,o.y);cx.rotate(o.a||0);cx.globalAlpha=al||1;
const tp=o.tp||o.t;
if(tp==='ball'){const g=cx.createRadialGradient(-3,-3,1,0,0,10);g.addColorStop(0,'#ff7675');g.addColorStop(1,'#d63031');cx.fillStyle=g;cx.beginPath();cx.arc(0,0,10,0,6.283);cx.fill();cx.fillStyle='rgba(255,255,255,.3)';cx.beginPath();cx.arc(-3,-3,3,0,6.283);cx.fill()}
else if(tp==='bball'){const g=cx.createRadialGradient(-4,-4,1,0,0,15);g.addColorStop(0,'#ffa502');g.addColorStop(1,'#e67e22');cx.fillStyle=g;cx.beginPath();cx.arc(0,0,15,0,6.283);cx.fill();cx.fillStyle='rgba(255,255,255,.2)';cx.beginPath();cx.arc(-5,-5,5,0,6.283);cx.fill()}
else if(tp==='plank'){const g=cx.createLinearGradient(0,-o.h/2,0,o.h/2);g.addColorStop(0,'#a07830');g.addColorStop(1,'#7c5e20');cx.fillStyle=g;cx.fillRect(-o.w/2,-o.h/2,o.w,o.h);cx.strokeStyle='#604818';cx.lineWidth=.8;cx.strokeRect(-o.w/2,-o.h/2,o.w,o.h);cx.strokeStyle='rgba(96,72,24,.2)';for(let k=10;k<o.w;k+=18){cx.beginPath();cx.moveTo(-o.w/2+k,-o.h/2);cx.lineTo(-o.w/2+k,o.h/2);cx.stroke()}}
else if(tp==='spring'){const g=cx.createLinearGradient(0,-o.h/2,0,o.h/2);g.addColorStop(0,'#55efc4');g.addColorStop(1,'#00b894');cx.fillStyle=g;cx.fillRect(-o.w/2,-o.h/2,o.w,o.h);cx.strokeStyle='#00886a';cx.lineWidth=2;for(let k=0;k<5;k++){const sx=-o.w/2+k*(o.w/5);cx.beginPath();cx.moveTo(sx,-o.h/2);cx.lineTo(sx+o.w/10,o.h/2);cx.lineTo(sx+o.w/5,-o.h/2);cx.stroke()}}
else if(tp==='domino'){cx.fillStyle=o.fell?'#636e72':'#dfe6e9';cx.fillRect(-o.w/2,-o.h/2,o.w,o.h);cx.strokeStyle='#2d3436';cx.lineWidth=1;cx.strokeRect(-o.w/2,-o.h/2,o.w,o.h);cx.fillStyle='#2d3436';cx.beginPath();cx.arc(0,-o.h*.28,1.8,0,6.283);cx.fill();cx.beginPath();cx.arc(0,o.h*.28,1.8,0,6.283);cx.fill()}
else if(tp==='fan'){cx.fillStyle='#74b9ff';cx.beginPath();cx.arc(0,0,15,0,6.283);cx.fill();cx.strokeStyle='#fff';cx.lineWidth=2.5;const ft=playing?st*8:0;for(let k=0;k<4;k++){const fa=ft+k*1.5708;cx.beginPath();cx.moveTo(0,0);cx.lineTo(Math.cos(fa)*12,Math.sin(fa)*12);cx.stroke()}cx.strokeStyle='rgba(116,185,255,.3)';cx.lineWidth=1;cx.setLineDash([3,5]);for(let k=0;k<3;k++){const ox=20+k*15;cx.beginPath();cx.moveTo(ox,-8);cx.lineTo(ox,8);cx.stroke()}cx.setLineDash([])}
else if(tp==='conv'){cx.fillStyle='#636e72';cx.fillRect(-o.w/2,-o.h/2,o.w,o.h);cx.fillStyle='#b2bec3';const ct=playing?st*50:0;for(let k=0;k<Math.floor(o.w/12)|0;k++){const xx=((k*12+ct)%o.w)-o.w/2;cx.beginPath();cx.arc(xx,0,2,0,6.283);cx.fill()}cx.strokeStyle='#2d3436';cx.lineWidth=1;cx.strokeRect(-o.w/2,-o.h/2,o.w,o.h)}
else if(tp==='bumper'){const g=cx.createRadialGradient(0,0,2,0,0,o.w/2);g.addColorStop(0,'#fd79a8');g.addColorStop(1,'#e84393');cx.fillStyle=g;cx.beginPath();cx.arc(0,0,o.w/2,0,6.283);cx.fill();cx.strokeStyle='#fff';cx.lineWidth=2;cx.beginPath();cx.arc(0,0,o.w/2-2,0,6.283);cx.stroke()}
else if(tp==='balloon'){cx.fillStyle='#e17055';cx.beginPath();cx.ellipse(0,-2,11,13,0,0,6.283);cx.fill();cx.fillStyle='rgba(255,255,255,.25)';cx.beginPath();cx.arc(-3,-6,4,0,6.283);cx.fill();cx.strokeStyle='#999';cx.lineWidth=.8;cx.beginPath();cx.moveTo(0,11);cx.quadraticCurveTo(3,18,0,26);cx.stroke()}
else if(tp==='rocket'){const lit=o.ig>=0&&st-o.ig>.3;cx.fillStyle=lit?'#d63031':'#636e72';cx.fillRect(-o.w/2,-o.h/2,o.w,o.h);cx.fillStyle='#e17055';cx.beginPath();cx.moveTo(o.w/2,-o.h/2-1);cx.lineTo(o.w/2+10,0);cx.lineTo(o.w/2,o.h/2+1);cx.fill();if(lit){cx.fillStyle='#fdcb6e';const fl=8+Math.random()*12;cx.beginPath();cx.moveTo(-o.w/2,-o.h/4);cx.lineTo(-o.w/2-fl,(Math.random()-.5)*4);cx.lineTo(-o.w/2,o.h/4);cx.fill()}}
else if(tp==='portal'){const pg=playing?st*3:0;cx.strokeStyle='#a29bfe';cx.lineWidth=3;cx.beginPath();cx.arc(0,0,o.w/2,pg,pg+4.712);cx.stroke();cx.strokeStyle='#6c5ce7';cx.lineWidth=2;cx.beginPath();cx.arc(0,0,o.w/2-5,pg+1,pg+4.14);cx.stroke();cx.fillStyle='rgba(108,92,231,.15)';cx.beginPath();cx.arc(0,0,o.w/2-2,0,6.283);cx.fill()}
else if(tp==='button'){cx.fillStyle=o.trig?'#00b894':'#d63031';cx.fillRect(-o.w/2,-o.h/2,o.w,o.h);cx.fillStyle='#dfe6e9';cx.fillRect(-o.w/4,-2,o.w/2,4);cx.strokeStyle='#2d3436';cx.lineWidth=1;cx.strokeRect(-o.w/2,-o.h/2,o.w,o.h)}
else if(tp==='spike'){cx.fillStyle='#b2bec3';cx.beginPath();cx.moveTo(-o.w/2,o.h/2);cx.lineTo(-o.w/6,-o.h/2);cx.lineTo(0,o.h/4);cx.lineTo(o.w/6,-o.h/2);cx.lineTo(o.w/2,o.h/2);cx.closePath();cx.fill();cx.strokeStyle='#636e72';cx.lineWidth=1;cx.stroke()}
else if(tp==='ramp'){cx.fillStyle='#8B7355';cx.beginPath();cx.moveTo(-o.w/2,o.h/2);cx.lineTo(o.w/2,o.h/2);cx.lineTo(o.w/2,-o.h/2);cx.closePath();cx.fill();cx.strokeStyle='#6B5340';cx.lineWidth=1;cx.stroke()}
cx.restore()}

function drFlag(x,y){cx.save();cx.translate(x,y);
cx.strokeStyle='#b2bec3';cx.lineWidth=3;cx.beginPath();cx.moveTo(0,5);cx.lineTo(0,-35);cx.stroke();
cx.fillStyle='#00b894';cx.beginPath();cx.moveTo(1,-35);cx.lineTo(24,-28);cx.lineTo(1,-21);cx.fill();
const pulse=.5+Math.sin(Date.now()*.004)*.5;cx.globalAlpha=.12+pulse*.08;
cx.fillStyle='#00b894';cx.beginPath();cx.arc(0,-5,22,0,6.283);cx.fill();cx.globalAlpha=1;
cx.fillStyle='#fff';cx.font='bold 11px sans-serif';cx.textAlign='center';cx.fillText('GOAL',0,18);
cx.restore()}

function drSt(x,y){cx.save();cx.translate(x,y);
cx.strokeStyle='#fdcb6e';cx.lineWidth=2;cx.setLineDash([4,4]);cx.beginPath();cx.arc(0,0,14,0,6.283);cx.stroke();cx.setLineDash([]);
cx.fillStyle='#fdcb6e';cx.font='bold 9px sans-serif';cx.textAlign='center';cx.fillText('START',0,26);cx.restore()}

function drGrid(){cx.strokeStyle='rgba(255,255,255,.03)';cx.lineWidth=1;
for(let x=0;x<W;x+=40){cx.beginPath();cx.moveTo(x,0);cx.lineTo(x,H);cx.stroke()}
for(let y=0;y<H;y+=40){cx.beginPath();cx.moveTo(0,y);cx.lineTo(W,y);cx.stroke()}}

function render(){
cx.fillStyle='#1a1a2e';cx.fillRect(0,0,W,H);drGrid();
if(lvi>=0){const lv=LV[lvi];drSt(lv.sx,lv.sy);drFlag(lv.fx,lv.fy);
if(!playing)lv.tr.forEach(o=>{drO({tp:o.t,x:o.x,y:o.y,w:o.w,h:o.h,a:o.a||0,fell:0,trig:0,ig:-1},.55)})}
if(!playing){pl.forEach(o=>drO(o,1));if(ghost)drO(ghost,.35)}
else{sim.forEach(o=>drO(o,1))}
drP();
if(playing){cx.fillStyle='rgba(249,212,35,.8)';cx.font='bold 13px sans-serif';cx.textAlign='left';
cx.fillText('\u23F1 '+st.toFixed(1)+'s',8,H-10);
cx.fillText('\u26A1 '+rcnt+' reactions',110,H-10);
if(won===2){cx.fillStyle='rgba(0,0,0,.5)';cx.fillRect(0,H/2-25,W,50);
cx.fillStyle='#e17055';cx.font='bold 20px sans-serif';cx.textAlign='center';cx.fillText("Time's up! Press Stop to try again.",W/2,H/2+7)}}
if(!playing&&tool){cx.fillStyle='rgba(249,212,35,.5)';cx.font='11px sans-serif';cx.textAlign='center';
cx.fillText('Click canvas to place '+tool,W/2,H-10)}}

let lt=0;
function loop(t){const dt=Math.min((t-lt)/1000,.04);lt=t;
if(playing&&!won){const steps=Math.max(1,Math.ceil(4*spd)|0);const sd=dt*spd/steps;
for(let i=0;i<steps;i++){phys(sd);st+=sd}}
upP();render();requestAnimationFrame(loop)}

function hitT(x,y){for(let i=pl.length-1;i>=0;i--){const o=pl[i];
const dx=x-o.x,dy=y-o.y,c=Math.cos(-(o.a||0)),s=Math.sin(-(o.a||0));
const lx=dx*c-dy*s,ly=dx*s+dy*c;
const hw=(o.r||o.w/2)+5,hh=(o.r||o.h/2)+5;
if(Math.abs(lx)<hw&&Math.abs(ly)<hh)return i}return-1}

cv.addEventListener('mousedown',function(e){if(playing)return;ia();
const r=cv.getBoundingClientRect();mx=e.clientX-r.left;my=e.clientY-r.top;
if(e.button===2){const i=hitT(mx,my);if(i>=0){su();pl.splice(i,1);bldTb();upc();sn('pop')}return}
if(e.button!==0)return;
const i=hitT(mx,my);
if(i>=0){dobj=pl[i];doff={x:mx-dobj.x,y:my-dobj.y};su();return}
if(tool){const av=sandbox?99:(lvi>=0?(LV[lvi].tl[tool]||0):99);
const u=pl.filter(p=>p.tp===tool).length;
if(sandbox||u<av){su();const o=mk(tool,mx,my,0);pl.push(o);dobj=o;doff={x:0,y:0};bldTb();upc();sn('clk')}}});
cv.addEventListener('mousemove',function(e){const r=cv.getBoundingClientRect();mx=e.clientX-r.left;my=e.clientY-r.top;
if(dobj&&!playing){dobj.x=mx-doff.x;dobj.y=my-doff.y}
ghost=(!dobj&&tool&&!playing)?mk(tool,mx,my,0):null});
cv.addEventListener('mouseup',function(){dobj=null});
cv.addEventListener('contextmenu',function(e){e.preventDefault()});
cv.addEventListener('wheel',function(e){if(playing)return;
const i=hitT(mx,my);if(i>=0){e.preventDefault();su();pl[i].a=(pl[i].a||0)+e.deltaY*.004}},{passive:false});
document.addEventListener('keydown',function(e){
if((e.key==='x'||e.key==='Delete')&&!playing){const i=hitT(mx,my);if(i>=0){su();pl.splice(i,1);bldTb();upc();sn('pop')}}
if(e.key==='z'&&(e.ctrlKey||e.metaKey)){e.preventDefault();document.getElementById('ubtn').onclick()}
if(e.key==='y'&&(e.ctrlKey||e.metaKey)){e.preventDefault();document.getElementById('rbtn').onclick()}
if(e.key===' '){e.preventDefault();document.getElementById('pbtn').onclick()}
if(e.key==='Escape'){tool=null;bldTb()}});
window.addEventListener('resize',rsz);
rsz();bldMenu();requestAnimationFrame(loop);
})();
</script>
</body>
</html>
