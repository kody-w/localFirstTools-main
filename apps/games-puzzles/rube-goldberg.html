<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Rube Goldberg Machine</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a1a2e;color:#eee;font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden;height:100vh;user-select:none}
#menu{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:20px}
#menu h1{font-size:3em;background:linear-gradient(135deg,#f9d423,#ff4e50);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none}
#menu h2{color:#aaa;font-weight:300;margin-bottom:20px}
.lvl-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;max-width:700px;padding:10px}
.lvl-btn{width:80px;height:80px;border:2px solid #333;border-radius:12px;background:#16213e;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:.2s;font-size:.75em;color:#ccc}
.lvl-btn:hover{border-color:#f9d423;transform:scale(1.08);background:#1a1a3e}
.lvl-btn .num{font-size:1.6em;font-weight:700;color:#fff}
.lvl-btn .stars{color:#f9d423;font-size:1.1em}
.sandbox-btn{padding:14px 36px;font-size:1.2em;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:12px;color:#fff;cursor:pointer;margin-top:10px;font-weight:600}
.sandbox-btn:hover{transform:scale(1.05)}
#game{display:none;height:100vh;flex-direction:column}
#topbar{height:48px;background:#16213e;display:flex;align-items:center;padding:0 12px;gap:8px;border-bottom:1px solid #333;flex-shrink:0}
#topbar button{padding:5px 14px;border:1px solid #444;border-radius:6px;background:#1a1a2e;color:#ddd;cursor:pointer;font-size:.85em}
#topbar button:hover{border-color:#f9d423;color:#fff}
#topbar button.active{background:#f9d423;color:#111;border-color:#f9d423}
#topbar .sep{width:1px;height:28px;background:#333}
#lvlname{font-weight:600;color:#f9d423;margin-right:8px;font-size:.95em;min-width:100px}
#partcount{color:#aaa;font-size:.8em}
#main-area{display:flex;flex:1;overflow:hidden}
#toolbox{width:72px;background:#0f0f23;border-right:1px solid #333;overflow-y:auto;flex-shrink:0;padding:4px 0}
.tool{width:64px;height:64px;margin:4px;border:2px solid #333;border-radius:8px;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.6em;color:#aaa;background:#16213e;transition:.15s}
.tool:hover{border-color:#667eea;color:#fff}
.tool.selected{border-color:#f9d423;background:#1a1a3e;color:#f9d423}
.tool.disabled{opacity:.3;pointer-events:none}
.tool .ico{font-size:1.8em;line-height:1}
.tool .cnt{font-size:1.1em;color:#f9d423;font-weight:700}
canvas{flex:1;display:block;cursor:crosshair}
#overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:99}
#overlay.show{display:flex}
#overlay-box{background:#16213e;border:2px solid #f9d423;border-radius:16px;padding:40px;text-align:center;max-width:400px}
#overlay-box h2{font-size:2em;margin-bottom:10px}
#overlay-box .big-stars{font-size:3em;color:#f9d423;margin:10px 0}
#overlay-box button{padding:10px 28px;margin:8px;border:none;border-radius:8px;cursor:pointer;font-size:1em;font-weight:600}
.btn-next{background:#f9d423;color:#111}.btn-retry{background:#444;color:#fff}.btn-menu{background:#333;color:#fff}
#toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:#f9d423;color:#111;padding:8px 20px;border-radius:8px;font-weight:600;display:none;z-index:50}
</style>
</head>
<body>
<div id="menu">
<h1>‚öôÔ∏è Rube Goldberg Machine</h1>
<h2>Build incredible chain reactions!</h2>
<div class="lvl-grid" id="lvlgrid"></div>
<button class="sandbox-btn" onclick="startSandbox()">üèóÔ∏è Sandbox Mode</button>
</div>
<div id="game">
<div id="topbar">
<button onclick="goMenu()">‚ò∞</button>
<span id="lvlname"></span>
<div class="sep"></div>
<button id="playBtn" onclick="togglePlay()">‚ñ∂ Play</button>
<button id="slowBtn" onclick="toggleSlow()">üêå 1x</button>
<div class="sep"></div>
<button onclick="doUndo()">‚Ü©</button>
<button onclick="doRedo()">‚Ü™</button>
<button onclick="clearAll()">üóëÔ∏è</button>
<div class="sep"></div>
<span id="partcount"></span>
</div>
<div id="main-area">
<div id="toolbox" id="toolbox"></div>
<canvas id="canvas"></canvas>
</div>
</div>
<div id="overlay"><div id="overlay-box"></div></div>
<div id="toast"></div>
<script>
(()=>{
"use strict";
const C=document.getElementById('canvas'),X=C.getContext('2d');
let CW=800,CH=600;
const G=0.35,FRIC=0.985,BOUNCE=0.55,SUB=4,DT=1/60;
let mode='menu',playing=false,simSpeed=1,simTime=0;
let curLevel=-1,isSandbox=false;
let placed=[],simBodies=[],particles=[];
let undoStack=[],redoStack=[];
let selTool=null,dragObj=null,dragOff={x:0,y:0},ghostObj=null;
let mouseX=0,mouseY=0,mouseDown=false;
let levelStars=new Array(20).fill(0);
try{const s=localStorage.getItem('rg_stars');if(s)levelStars=JSON.parse(s)}catch(e){}
let reactionCount=0,totalDist=0,partsUsed=0;
let actx=null;
function initAudio(){if(!actx)actx=new(window.AudioContext||window.webkitAudioContext)();if(actx.state==='suspended')actx.resume()}
function snd(type){
if(!actx)return;try{
const o=actx.createOscillator(),g=actx.createGain();
o.connect(g);g.connect(actx.destination);
const t=actx.currentTime;
switch(type){
case'thud':o.type='sine';o.frequency.value=60+Math.random()*40;g.gain.setValueAtTime(.25,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15);break;
case'spring':o.type='sine';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(900,t+.12);g.gain.setValueAtTime(.2,t);g.gain.exponentialRampToValueAtTime(.001,t+.15);o.start(t);o.stop(t+.15);break;
case'whoosh':o.type='sawtooth';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(50,t+.3);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.3);o.start(t);o.stop(t+.3);break;
case'ding':o.type='sine';o.frequency.value=880;g.gain.setValueAtTime(.2,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4);break;
case'pop':o.type='square';o.frequency.setValueAtTime(600,t);o.frequency.exponentialRampToValueAtTime(100,t+.05);g.gain.setValueAtTime(.15,t);g.gain.exponentialRampToValueAtTime(.001,t+.08);o.start(t);o.stop(t+.08);break;
case'boom':o.type='sawtooth';o.frequency.setValueAtTime(100,t);o.frequency.exponentialRampToValueAtTime(20,t+.4);g.gain.setValueAtTime(.3,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4);break;
case'win':o.type='sine';o.frequency.setValueAtTime(523,t);o.frequency.setValueAtTime(659,t+.1);o.frequency.setValueAtTime(784,t+.2);o.frequency.setValueAtTime(1047,t+.3);g.gain.setValueAtTime(.2,t);g.gain.exponentialRampToValueAtTime(.001,t+.5);o.start(t);o.stop(t+.5);break;
case'click':o.type='sine';o.frequency.value=1000;g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.03);o.start(t);o.stop(t+.03);break;
}}catch(e){}}
function addP(x,y,type,n){
n=n||5;
for(let i=0;i<n;i++){
let vx=(Math.random()-.5)*4,vy=(Math.random()-.5)*4,life=30+Math.random()*30,col='#f9d423';
if(type==='spark'){vx*=2;vy*=2;life=15+Math.random()*15;col=['#f9d423','#ff6b35','#fff'][Math.floor(Math.random()*3)]}
if(type==='smoke'){vx*=.3;vy=-1-Math.random();life=40+Math.random()*30;col='#666'}
if(type==='confetti'){vx=(Math.random()-.5)*8;vy=-3-Math.random()*5;life=60+Math.random()*60;col=['#f9d423','#ff4e50','#667eea','#43e97b','#fa709a'][Math.floor(Math.random()*5)]}
particles.push({x,y,vx,vy,life,maxLife:life,col,r:type==='smoke'?3:2})
}}
function updateParticles(){
for(let i=particles.length-1;i>=0;i--){
const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=.05;p.life--;
if(p.life<=0)particles.splice(i,1)
}}
function drawParticles(){
for(let i=0;i<particles.length;i++){
const p=particles[i],a=p.life/p.maxLife;
X.globalAlpha=a;X.fillStyle=p.col;
X.beginPath();X.arc(p.x,p.y,p.r*a,0,Math.PI*2);X.fill()
}X.globalAlpha=1}
const TOOLS=[
{id:'ball',name:'Ball',ico:'üî¥',w:20,h:20},
{id:'ball_lg',name:'Big Ball',ico:'üü†',w:30,h:30},
{id:'plank',name:'Plank',ico:'üìè',w:120,h:12},
{id:'spring',name:'Spring',ico:'üü©',w:40,h:16},
{id:'domino',name:'Domino',ico:'‚ñÆ',w:8,h:36},
{id:'fan',name:'Fan',ico:'üí®',w:30,h:30},
{id:'conveyor',name:'Conveyor',ico:'‚è©',w:100,h:10},
{id:'bumper',name:'Bumper',ico:'‚≠ï',w:24,h:24},
{id:'balloon',name:'Balloon',ico:'üéà',w:20,h:20},
{id:'rocket',name:'Rocket',ico:'üöÄ',w:40,h:14},
{id:'portal',name:'Portal',ico:'üåÄ',w:28,h:28},
{id:'button',name:'Button',ico:'üîò',w:24,h:10},
{id:'spike',name:'Spike',ico:'‚ñ≤',w:30,h:20},
{id:'ramp',name:'Ramp',ico:'‚ó¢',w:100,h:50}
];
function makeTool(id){return TOOLS.find(t=>t.id===id)}
function newObj(tid,x,y,a){
const t=makeTool(tid);if(!t)return null;
return{type:tid,x:x||0,y:y||0,w:t.w,h:t.h,a:a||0,
vx:0,vy:0,angVel:0,dynamic:false,fallen:false,
active:false,paired:null,triggered:false,mass:tid==='ball_lg'?2:1}
}
const LEVELS=[
{name:"First Roll",sx:120,sy:150,fx:680,fy:480,
ter:[{t:'plank',x:100,y:200,w:160,h:14,a:0},{t:'plank',x:600,y:500,w:250,h:14,a:0}],
tools:{plank:2},par:1},
{name:"Bridge the Gap",sx:100,sy:250,fx:700,fy:280,
ter:[{t:'plank',x:150,y:300,w:200,h:14,a:0},{t:'plank',x:650,y:300,w:200,h:14,a:0}],
tools:{plank:1},par:1},
{name:"Bounce Up",sx:400,sy:450,fx:400,fy:100,
ter:[{t:'plank',x:400,y:500,w:300,h:14,a:0},{t:'plank',x:400,y:150,w:200,h:14,a:0}],
tools:{spring:2},par:1},
{name:"Domino Effect",sx:100,sy:240,fx:700,fy:280,
ter:[{t:'plank',x:400,y:300,w:700,h:14,a:0}],
tools:{domino:10},par:6},
{name:"Wind Tunnel",sx:100,sy:260,fx:700,fy:260,
ter:[{t:'plank',x:400,y:300,w:700,h:14,a:0}],
tools:{fan:2},par:1},
{name:"Up and Over",sx:100,sy:250,fx:700,fy:450,
ter:[{t:'plank',x:150,y:300,w:200,h:14,a:0},{t:'plank',x:400,y:200,w:40,h:250,a:0},{t:'plank',x:650,y:500,w:200,h:14,a:0}],
tools:{spring:2,plank:2},par:2},
{name:"Conveyor Belt",sx:100,sy:250,fx:700,fy:250,
ter:[{t:'plank',x:400,y:300,w:700,h:14,a:0}],
tools:{conveyor:3},par:2},
{name:"Bumper Bounce",sx:100,sy:150,fx:700,fy:450,
ter:[{t:'plank',x:100,y:200,w:120,h:14,a:0},{t:'plank',x:700,y:500,w:120,h:14,a:0}],
tools:{bumper:5,plank:2},par:4},
{name:"Balloon Lift",sx:400,sy:480,fx:400,fy:80,
ter:[{t:'plank',x:400,y:520,w:200,h:14,a:0},{t:'plank',x:400,y:120,w:200,h:14,a:0}],
tools:{balloon:3,plank:1},par:2},
{name:"Rocket Ride",sx:100,sy:260,fx:700,fy:100,
ter:[{t:'plank',x:150,y:300,w:200,h:14,a:0},{t:'plank',x:650,y:150,w:200,h:14,a:0}],
tools:{rocket:1,plank:2},par:2},
{name:"Portal Warp",sx:100,sy:260,fx:700,fy:460,
ter:[{t:'plank',x:150,y:300,w:200,h:14,a:0},{t:'plank',x:650,y:500,w:200,h:14,a:0},{t:'plank',x:400,y:250,w:40,h:300,a:0}],
tools:{portal:2},par:2},
{name:"Chain Reaction",sx:80,sy:130,fx:720,fy:470,
ter:[{t:'plank',x:200,y:180,w:300,h:14,a:0},{t:'plank',x:550,y:350,w:300,h:14,a:0},{t:'plank',x:650,y:510,w:200,h:14,a:0}],
tools:{domino:8,plank:2,spring:1},par:5},
{name:"The Maze",sx:80,sy:80,fx:720,fy:480,
ter:[{t:'plank',x:400,y:130,w:500,h:14,a:0},{t:'plank',x:250,y:250,w:400,h:14,a:0},{t:'plank',x:500,y:370,w:400,h:14,a:0},{t:'plank',x:300,y:500,w:500,h:14,a:0}],
tools:{plank:4,spring:2},par:3},
{name:"Fan & Spring",sx:100,sy:430,fx:700,fy:100,
ter:[{t:'plank',x:400,y:480,w:700,h:14,a:0},{t:'plank',x:650,y:150,w:200,h:14,a:0}],
tools:{fan:2,spring:2,plank:1},par:3},
{name:"Spike Dodge",sx:100,sy:260,fx:700,fy:260,
ter:[{t:'plank',x:400,y:300,w:700,h:14,a:0},{t:'spike',x:350,y:280,w:30,h:20},{t:'spike',x:500,y:280,w:30,h:20}],
tools:{plank:2,spring:1,bumper:2},par:3},
{name:"Sky Bridge",sx:80,sy:80,fx:720,fy:80,
ter:[{t:'plank',x:80,y:130,w:120,h:14,a:0},{t:'plank',x:720,y:130,w:120,h:14,a:0}],
tools:{plank:4,spring:2,balloon:2},par:4},
{name:"The Factory",sx:80,sy:130,fx:720,fy:450,
ter:[{t:'plank',x:200,y:180,w:300,h:14,a:0},{t:'plank',x:600,y:330,w:300,h:14,a:0},{t:'plank',x:650,y:500,w:200,h:14,a:0}],
tools:{conveyor:3,spring:2,plank:2},par:4},
{name:"Domino Rally",sx:80,sy:240,fx:720,fy:240,
ter:[{t:'plank',x:400,y:290,w:750,h:14,a:0}],
tools:{domino:15,bumper:2},par:10},
{name:"Everything Goes",sx:80,sy:80,fx:720,fy:480,
ter:[{t:'plank',x:200,y:130,w:300,h:14,a:0},{t:'plank',x:400,y:300,w:200,h:14,a:0},{t:'plank',x:650,y:520,w:200,h:14,a:0}],
tools:{plank:3,spring:2,fan:1,domino:5,bumper:2,portal:2},par:5},
{name:"Grand Finale",sx:80,sy:80,fx:720,fy:520,
ter:[{t:'plank',x:200,y:130,w:250,h:14,a:0},{t:'plank',x:500,y:250,w:200,h:14,a:0},{t:'plank',x:250,y:380,w:300,h:14,a:0},{t:'plank',x:650,y:560,w:200,h:14,a:0}],
tools:{plank:4,spring:3,fan:2,domino:8,bumper:3,balloon:2,rocket:1,conveyor:2,portal:2},par:7}
];
function buildMenu(){
const g=document.getElementById('lvlgrid');g.innerHTML='';
for(let i=0;i<20;i++){
const b=document.createElement('div');b.className='lvl-btn';
const stars='‚òÖ'.repeat(levelStars[i])+'‚òÜ'.repeat(3-levelStars[i]);
b.innerHTML='<span class="num">'+(i+1)+'</span><span class="stars">'+stars+'</span><span>'+LEVELS[i].name+'</span>';
b.onclick=()=>startLevel(i);g.appendChild(b)
}}
function startLevel(idx){
initAudio();curLevel=idx;isSandbox=false;
document.getElementById('menu').style.display='none';
document.getElementById('game').style.display='flex';
document.getElementById('lvlname').textContent=(idx+1)+'. '+LEVELS[idx].name;
placed=[];undoStack=[];redoStack=[];
selTool=null;playing=false;simSpeed=1;
buildToolbox();resize();updatePartCount()
}
window.startSandbox=function(){
initAudio();curLevel=-1;isSandbox=true;
document.getElementById('menu').style.display='none';
document.getElementById('game').style.display='flex';
document.getElementById('lvlname').textContent='üèóÔ∏è Sandbox';
placed=[];undoStack=[];redoStack=[];
selTool=null;playing=false;simSpeed=1;
buildToolbox();resize();updatePartCount()
};
window.goMenu=function(){
playing=false;
document.getElementById('game').style.display='none';
document.getElementById('menu').style.display='flex';
buildMenu()
};
function buildToolbox(){
const tb=document.getElementById('toolbox');tb.innerHTML='';
const avail=isSandbox?null:(curLevel>=0?LEVELS[curLevel].tools:{});
TOOLS.forEach(t=>{
const cnt=avail?avail[t.id]:undefined;
if(!isSandbox&&cnt===undefined)return;
const used=placed.filter(p=>p.type===t.id).length;
const remaining=isSandbox?99:(cnt-used);
const d=document.createElement('div');
d.className='tool'+(selTool===t.id?' selected':'')+(remaining<=0&&!isSandbox?' disabled':'');
d.innerHTML='<span class="ico">'+t.ico+'</span><span class="cnt">'+(isSandbox?'‚àû':remaining)+'</span>';
d.onclick=()=>{if(!playing&&(isSandbox||remaining>0)){selTool=t.id;buildToolbox();snd('click')}};
tb.appendChild(d)
})}
function updatePartCount(){
const n=placed.length;
const par=curLevel>=0?LEVELS[curLevel].par:0;
document.getElementById('partcount').textContent=isSandbox?n+' parts':n+' / par '+par
}
function saveUndo(){undoStack.push(JSON.stringify(placed));redoStack=[];if(undoStack.length>50)undoStack.shift()}
window.doUndo=function(){if(playing||undoStack.length===0)return;redoStack.push(JSON.stringify(placed));placed=JSON.parse(undoStack.pop());buildToolbox();updatePartCount()};
window.doRedo=function(){if(playing||redoStack.length===0)return;undoStack.push(JSON.stringify(placed));placed=JSON.parse(redoStack.pop());buildToolbox();updatePartCount()};
window.clearAll=function(){if(playing)return;saveUndo();placed=[];buildToolbox();updatePartCount()};
window.togglePlay=function(){
initAudio();
if(!playing){startSim()}else{stopSim()}
};
window.toggleSlow=function(){
simSpeed=simSpeed===1?.25:1;
document.getElementById('slowBtn').textContent=simSpeed===1?'üêå 1x':'üêå .25x';
document.getElementById('slowBtn').className=simSpeed<1?'active':''
};
function startSim(){
playing=true;simTime=0;reactionCount=0;totalDist=0;partsUsed=placed.length;
document.getElementById('playBtn').textContent='‚èπ Stop';
document.getElementById('playBtn').className='active';
simBodies=[];
const lv=curLevel>=0?LEVELS[curLevel]:null;
if(lv){
const b=newObj('ball',lv.sx,lv.sy,0);b.dynamic=true;b.r=10;b.startX=lv.sx;b.startY=lv.sy;simBodies.push(b)
}
if(lv){lv.ter.forEach(o=>{
const s={type:o.t,x:o.x,y:o.y,w:o.w,h:o.h,a:o.a||0,dynamic:false,fallen:false,active:false,triggered:false,vx:0,vy:0,angVel:0,mass:1};
simBodies.push(s)
})}
placed.forEach(o=>{
const s=JSON.parse(JSON.stringify(o));
if(s.type==='ball'||s.type==='ball_lg'){s.dynamic=true;s.r=s.type==='ball_lg'?15:10;s.startX=s.x;s.startY=s.y}
else if(s.type==='domino'){s.dynamic=true;s.origAngle=s.a;s.fallen=false}
else if(s.type==='balloon'){s.dynamic=true;s.r=10}
else if(s.type==='rocket'){s.igniteTime=-1}
else{s.dynamic=false}
simBodies.push(s)
});
linkPortals()
}
function linkPortals(){
const ps=simBodies.filter(b=>b.type==='portal');
for(let i=0;i<ps.length-1;i+=2){
ps[i].paired=ps[i+1];ps[i+1].paired=ps[i]
}}
function stopSim(){
playing=false;simBodies=[];particles=[];
document.getElementById('playBtn').textContent='‚ñ∂ Play';
document.getElementById('playBtn').className='';
simSpeed=1;document.getElementById('slowBtn').textContent='üêå 1x';document.getElementById('slowBtn').className=''
}
function circRectCol(cx,cy,cr,rx,ry,rw,rh,ra){
const cs=Math.cos(-ra),sn=Math.sin(-ra);
const dx=cx-rx,dy=cy-ry;
const lx=dx*cs-dy*sn,ly=dx*sn+dy*cs;
const hw=rw/2,hh=rh/2;
const clx=Math.max(-hw,Math.min(hw,lx));
const cly=Math.max(-hh,Math.min(hh,ly));
const ddx=lx-clx,ddy=ly-cly;
const d2=ddx*ddx+ddy*ddy;
if(d2>=cr*cr)return null;
const d=Math.sqrt(d2);
let nx,ny;
if(d<.001){
const px=hw-Math.abs(lx),py=hh-Math.abs(ly);
if(px<py){nx=lx>0?1:-1;ny=0}else{nx=0;ny=ly>0?1:-1}
}else{nx=ddx/d;ny=ddy/d}
const cs2=Math.cos(ra),sn2=Math.sin(ra);
return{nx:nx*cs2-ny*sn2,ny:nx*sn2+ny*cs2,depth:cr-d}
}
function circCircCol(ax,ay,ar,bx,by,br){
const dx=ax-bx,dy=ay-by,d=Math.sqrt(dx*dx+dy*dy),minD=ar+br;
if(d>=minD||d<.001)return null;
return{nx:dx/d,ny:dy/d,depth:minD-d}
}
function resolveCol(b,col,bounce,fric){
b.x+=col.nx*col.depth*1.01;b.y+=col.ny*col.depth*1.01;
const dot=b.vx*col.nx+b.vy*col.ny;
if(dot<0){
b.vx-=(1+bounce)*dot*col.nx;b.vy-=(1+bounce)*dot*col.ny;
const tx=-col.ny,ty=col.nx;
const td=b.vx*tx+b.vy*ty;
b.vx-=td*fric;b.vy-=td*fric
}}
function physStep(dt){
const bodies=simBodies;
for(let i=0;i<bodies.length;i++){
const b=bodies[i];
if(!b.dynamic)continue;
if(b.type==='balloon'){b.vy-=G*2.2*dt*60;b.vy+=G*dt*60*.3}
else{b.vy+=G*dt*60}
if(b.type==='domino'&&!b.fallen){
b.angVel+=G*.04*Math.sin(b.a)*dt*60;
b.a+=b.angVel*dt*60;
b.angVel*=.995;
if(Math.abs(b.a-(b.origAngle||0))>1.2){b.fallen=true;b.a=b.origAngle+(b.a>b.origAngle?1.4:-1.4);snd('thud');addP(b.x,b.y-b.h/2,'spark',3);reactionCount++}
}
b.x+=b.vx*dt*60;b.y+=b.vy*dt*60;
b.vx*=FRIC;b.vy*=FRIC;
if(b.type==='ball'||b.type==='ball_lg'){
totalDist+=Math.sqrt(b.vx*b.vx+b.vy*b.vy)*dt*60
}
if(b.y>CH+50||b.y<-200||b.x<-200||b.x>CW+200){
if(b.type==='balloon'){bodies.splice(i,1);i--;continue}
b.y=Math.min(b.y,CH+49);b.vy=0
}}
for(let i=0;i<bodies.length;i++){
const a=bodies[i];
if(!a.dynamic)continue;
const ar=a.r||5;
for(let j=0;j<bodies.length;j++){
if(i===j)continue;
const b=bodies[j];
if(b.type==='ball'||b.type==='ball_lg'){
if(a.r&&b.r){
const col=circCircCol(a.x,a.y,a.r,b.x,b.y,b.r||10);
if(col){resolveCol(a,col,BOUNCE,.05);snd('thud');addP((a.x+b.x)/2,(a.y+b.y)/2,'spark',2)}
}continue
}
if(b.type==='balloon')continue;
if(b.type==='spring'){
const col=circRectCol(a.x,a.y,ar,b.x,b.y,b.w,b.h,b.a||0);
if(col){resolveCol(a,col,.9,.02);a.vy-=8;snd('spring');addP(a.x,a.y+ar,'spark',4);reactionCount++}
continue
}
if(b.type==='bumper'){
const col=circCircCol(a.x,a.y,ar,b.x,b.y,b.w/2);
if(col){resolveCol(a,col,1.3,.01);snd('spring');addP(a.x,a.y,'spark',5);reactionCount++}
continue
}
if(b.type==='fan'){
const dx=a.x-b.x,dy=a.y-b.y,dist=Math.sqrt(dx*dx+dy*dy);
if(dist<150){
const fa=b.a||0;a.vx+=Math.cos(fa)*3*dt*60*(1-dist/150);
a.vy+=Math.sin(fa)*3*dt*60*(1-dist/150);
if(Math.random()<.1)addP(b.x+Math.cos(fa)*20,b.y+Math.sin(fa)*20,'smoke',1)
}continue
}
if(b.type==='conveyor'){
const col=circRectCol(a.x,a.y,ar,b.x,b.y,b.w,b.h,b.a||0);
if(col){resolveCol(a,col,.2,.0);a.vx+=2*dt*60;reactionCount++}
continue
}
if(b.type==='portal'&&b.paired){
const dx=a.x-b.x,dy=a.y-b.y;
if(dx*dx+dy*dy<(b.w/2)*(b.w/2)){
a.x=b.paired.x;a.y=b.paired.y-20;snd('whoosh');addP(b.x,b.y,'spark',6);addP(b.paired.x,b.paired.y,'spark',6);reactionCount++
}continue
}
if(b.type==='button'&&!b.triggered){
const col=circRectCol(a.x,a.y,ar,b.x,b.y,b.w,b.h,b.a||0);
if(col){b.triggered=true;snd('click');addP(b.x,b.y,'spark',3);reactionCount++;
const rockets=bodies.filter(r=>r.type==='rocket');
rockets.forEach(r=>{if(r.igniteTime<0)r.igniteTime=simTime})
}continue
}
if(b.type==='spike'){
const col=circRectCol(a.x,a.y,ar,b.x,b.y,b.w,b.h,b.a||0);
if(col){
if(a.type==='balloon'){addP(a.x,a.y,'spark',8);snd('pop');bodies.splice(i,1);i--;reactionCount++;break}
a.vx*=.3;a.vy*=.3;resolveCol(a,col,.1,.3)
}continue
}
if(b.type==='rocket'){
if(b.igniteTime>=0&&simTime-b.igniteTime>.5){
const dx=a.x-b.x,dy=a.y-b.y;
if(Math.abs(dx)<60&&Math.abs(dy)<30){
const ra=b.a||0;a.vx+=Math.cos(ra)*6*dt*60;a.vy+=Math.sin(ra)*6*dt*60;
if(Math.random()<.3)addP(b.x-Math.cos(ra)*20,b.y-Math.sin(ra)*20,'smoke',1)
}}continue
}
if(b.type==='domino'){
const tipX=b.x+Math.sin(b.a)*(b.h/2);
const tipY=b.y-Math.cos(b.a)*(b.h/2);
const baseX=b.x-Math.sin(b.a)*(b.h/2);
const baseY=b.y+Math.cos(b.a)*(b.h/2);
const col=circRectCol(a.x,a.y,ar,b.x,b.y,b.w,b.h,b.a);
if(col){
if(!b.fallen){
const hitSide=a.x>b.x?1:-1;
b.angVel+=hitSide*.05*(Math.abs(a.vx)+Math.abs(a.vy));
reactionCount++
}
resolveCol(a,col,BOUNCE*.5,.1);snd('thud');addP(a.x,a.y,'spark',2)
}continue
}
const col=circRectCol(a.x,a.y,ar,b.x,b.y,b.w,b.h,b.a||0);
if(col){resolveCol(a,col,BOUNCE,.05);
const spd=Math.sqrt(a.vx*a.vx+a.vy*a.vy);
if(spd>.5){snd('thud');if(spd>2)addP(a.x,a.y+ar,'spark',2)}
}}}
for(let i=0;i<bodies.length;i++){
const a=bodies[i];
if(a.type!=='domino'||a.fallen||!a.dynamic)continue;
for(let j=0;j<bodies.length;j++){
if(i===j)continue;
const b=bodies[j];
if(b.type!=='domino'||b.fallen||!b.dynamic)continue;
const tipX=a.x+Math.sin(a.a)*(a.h/2);
const tipY=a.y-Math.cos(a.a)*(a.h/2);
const dx=tipX-b.x,dy=tipY-b.y;
if(Math.abs(dx)<b.w*2&&Math.abs(dy)<b.h/2+5){
const side=a.a>(a.origAngle||0)?1:-1;
b.angVel+=side*.03*(Math.abs(a.angVel)+.5)
}}}
for(let i=0;i<bodies.length;i++){
const b=bodies[i];
if(b.type==='rocket'&&b.igniteTime>=0){
const t=simTime-b.igniteTime;
if(t>.3){
const ra=b.a||0;
if(Math.random()<.4)addP(b.x-Math.cos(ra)*22,b.y-Math.sin(ra)*22,'smoke',1);
if(Math.random()<.3)addP(b.x-Math.cos(ra)*20,b.y-Math.sin(ra)*20,'spark',1)
}}}
if(curLevel>=0){
const lv=LEVELS[curLevel];
const flag={x:lv.fx,y:lv.fy};
for(let i=0;i<bodies.length;i++){
const b=bodies[i];
if((b.type==='ball'||b.type==='ball_lg')&&b.dynamic){
const dx=b.x-flag.x,dy=b.y-flag.y;
if(dx*dx+dy*dy<900){winLevel();return}
}}}}
function winLevel(){
playing=false;snd('win');
for(let i=0;i<30;i++)addP(LEVELS[curLevel].fx,LEVELS[curLevel].fy,'confetti',3);
const par=LEVELS[curLevel].par;
let stars=1;
if(partsUsed<=par)stars=2;
if(partsUsed<=par&&(reactionCount>=5||totalDist>2000))stars=3;
if(stars>levelStars[curLevel])levelStars[curLevel]=stars;
try{localStorage.setItem('rg_stars',JSON.stringify(levelStars))}catch(e){}
const ob=document.getElementById('overlay-box');
ob.innerHTML='<h2>üéâ Level Complete!</h2><div class="big-stars">'+'‚òÖ'.repeat(stars)+'‚òÜ'.repeat(3-stars)+'</div><p>Parts: '+partsUsed+(partsUsed<=par?' ‚ú®':'')+'</p><p>Reactions: '+reactionCount+'</p>'+
(curLevel<19?'<button class="btn-next" onclick="nextLevel()">Next Level ‚Üí</button>':'')+
'<button class="btn-retry" onclick="retryLevel()">Retry</button> <button class="btn-menu" onclick="closeOverlay();goMenu()">Menu</button>';
document.getElementById('overlay').classList.add('show')
}
window.nextLevel=function(){closeOverlay();stopSim();startLevel(curLevel+1)};
window.retryLevel=function(){closeOverlay();stopSim();placed=[];undoStack=[];redoStack=[];buildToolbox();updatePartCount()};
window.closeOverlay=function(){document.getElementById('overlay').classList.remove('show')};
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',1500)}
function resize(){
CW=C.parentElement.clientWidth;CH=C.parentElement.clientHeight;
C.width=CW;C.height=CH
}
function drawObj(o,alpha){
X.save();X.translate(o.x,o.y);X.rotate(o.a||0);X.globalAlpha=alpha||1;
switch(o.type||o.t){
case'ball':X.fillStyle='#ff4e50';X.beginPath();X.arc(0,0,10,0,Math.PI*2);X.fill();X.fillStyle='rgba(255,255,255,.3)';X.beginPath();X.arc(-3,-3,4,0,Math.PI*2);X.fill();break;
case'ball_lg':X.fillStyle='#ff8c00';X.beginPath();X.arc(0,0,15,0,Math.PI*2);X.fill();X.fillStyle='rgba(255,255,255,.3)';X.beginPath();X.arc(-5,-5,5,0,Math.PI*2);X.fill();break;
case'plank':X.fillStyle='#8B6914';X.fillRect(-o.w/2,-o.h/2,o.w,o.h);X.strokeStyle='#6B4F14';X.lineWidth=1;X.strokeRect(-o.w/2,-o.h/2,o.w,o.h);
for(let i=0;i<o.w;i+=20){X.strokeStyle='rgba(107,79,20,.3)';X.beginPath();X.moveTo(-o.w/2+i,-o.h/2);X.lineTo(-o.w/2+i,o.h/2);X.stroke()}break;
case'spring':X.fillStyle='#43e97b';X.fillRect(-o.w/2,-o.h/2,o.w,o.h);X.strokeStyle='#2d8f55';X.lineWidth=2;
for(let i=0;i<6;i++){const sx=-o.w/2+i*(o.w/6);X.beginPath();X.moveTo(sx,-o.h/2);X.lineTo(sx+o.w/12,o.h/2);X.lineTo(sx+o.w/6,-o.h/2);X.stroke()}break;
case'domino':X.fillStyle=o.fallen?'#666':'#eee';X.fillRect(-o.w/2,-o.h/2,o.w,o.h);X.strokeStyle='#333';X.lineWidth=1;X.strokeRect(-o.w/2,-o.h/2,o.w,o.h);X.fillStyle='#333';X.beginPath();X.arc(0,-o.h/4,2,0,Math.PI*2);X.fill();X.beginPath();X.arc(0,o.h/4,2,0,Math.PI*2);X.fill();break;
case'fan':X.fillStyle='#4facfe';X.fillRect(-15,-15,30,30);X.strokeStyle='#fff';X.lineWidth=2;
const ft=playing?simTime*10:0;
for(let i=0;i<3;i++){const fa=ft+i*Math.PI*2/3;X.beginPath();X.moveTo(0,0);X.lineTo(Math.cos(fa)*12,Math.sin(fa)*12);X.stroke()}break;
case'conveyor':X.fillStyle='#555';X.fillRect(-o.w/2,-o.h/2,o.w,o.h);X.strokeStyle='#888';X.lineWidth=1;
const ct=playing?simTime*60:0;
for(let i=0;i<o.w;i+=15){const cx=(-o.w/2+i+ct)%o.w-o.w/2;X.beginPath();X.arc(cx,0,2,0,Math.PI*2);X.stroke()}break;
case'bumper':X.fillStyle='#fa709a';X.beginPath();X.arc(0,0,o.w/2,0,Math.PI*2);X.fill();X.strokeStyle='#fff';X.lineWidth=2;X.beginPath();X.arc(0,0,o.w/2-3,0,Math.PI*2);X.stroke();break;
case'balloon':X.fillStyle='#ff6b6b';X.beginPath();X.arc(0,0,12,0,Math.PI*2);X.fill();X.fillStyle='rgba(255,255,255,.3)';X.beginPath();X.arc(-3,-4,4,0,Math.PI*2);X.fill();X.strokeStyle='#aaa';X.lineWidth=1;X.beginPath();X.moveTo(0,12);X.lineTo(0,25);X.stroke();break;
case'rocket':X.fillStyle=o.igniteTime>=0&&simTime-o.igniteTime>.3?'#ff4e50':'#888';X.fillRect(-o.w/2,-o.h/2,o.w,o.h);X.fillStyle='#ff8c00';X.beginPath();X.moveTo(o.w/2,-o.h/2);X.lineTo(o.w/2+10,0);X.lineTo(o.w/2,o.h/2);X.fill();
if(o.igniteTime>=0&&simTime-o.igniteTime>.3){X.fillStyle='#f9d423';X.beginPath();X.moveTo(-o.w/2,0);X.lineTo(-o.w/2-12-Math.random()*8,-5);X.lineTo(-o.w/2-12-Math.random()*8,5);X.fill()}break;
case'portal':const pg=playing?simTime*3:0;X.strokeStyle='#a855f7';X.lineWidth=3;X.beginPath();X.arc(0,0,o.w/2,pg,pg+Math.PI*1.5);X.stroke();X.strokeStyle='#c084fc';X.beginPath();X.arc(0,0,o.w/2-5,pg+1,pg+1+Math.PI);X.stroke();break;
case'button':X.fillStyle=o.triggered?'#43e97b':'#e74c3c';X.fillRect(-o.w/2,-o.h/2,o.w,o.h);X.fillStyle='#fff';X.fillRect(-o.w/4,-o.h/4,o.w/2,o.h/2);break;
case'spike':X.fillStyle='#bbb';X.beginPath();X.moveTo(-o.w/2,o.h/2);X.lineTo(0,-o.h/2);X.lineTo(o.w/2,o.h/2);X.closePath();X.fill();X.strokeStyle='#888';X.lineWidth=1;X.stroke();break;
case'ramp':X.fillStyle='#7c5e3c';X.beginPath();X.moveTo(-o.w/2,o.h/2);X.lineTo(o.w/2,o.h/2);X.lineTo(o.w/2,-o.h/2);X.closePath();X.fill();X.strokeStyle='#5a3e1c';X.lineWidth=1;X.stroke();break;
}X.restore()
}
function drawFlag(x,y){
X.save();X.translate(x,y);
X.strokeStyle='#ccc';X.lineWidth=3;X.beginPath();X.moveTo(0,0);X.lineTo(0,-40);X.stroke();
X.fillStyle='#43e97b';X.beginPath();X.moveTo(0,-40);X.lineTo(25,-32);X.lineTo(0,-24);X.fill();
X.fillStyle='#fff';X.font='bold 14px sans-serif';X.fillText('üèÅ',-7,15);
X.restore()
}
function drawStart(x,y){
X.save();X.translate(x,y);
X.strokeStyle='#f9d423';X.lineWidth=2;X.setLineDash([4,4]);
X.beginPath();X.arc(0,0,14,0,Math.PI*2);X.stroke();
X.setLineDash([]);
X.fillStyle='#f9d423';X.font='10px sans-serif';X.textAlign='center';X.fillText('START',0,25);
X.restore()
}
function drawGrid(){
X.strokeStyle='rgba(255,255,255,.04)';X.lineWidth=1;
for(let gx=0;gx<CW;gx+=40){X.beginPath();X.moveTo(gx,0);X.lineTo(gx,CH);X.stroke()}
for(let gy=0;gy<CH;gy+=40){X.beginPath();X.moveTo(0,gy);X.lineTo(CW,gy);X.stroke()}
}
function render(){
X.fillStyle='#1a1a2e';X.fillRect(0,0,CW,CH);
drawGrid();
if(curLevel>=0){
const lv=LEVELS[curLevel];
drawStart(lv.sx,lv.sy);drawFlag(lv.fx,lv.fy);
if(!playing){lv.ter.forEach(o=>{
const obj={type:o.t,x:o.x,y:o.y,w:o.w,h:o.h,a:o.a||0,fallen:false,triggered:false};
drawObj(obj,.6)
})}}
if(!playing){
placed.forEach(o=>drawObj(o,1));
if(ghostObj){drawObj(ghostObj,.4)}
}else{
simBodies.forEach(o=>drawObj(o,1))
}
drawParticles();
if(playing){
X.fillStyle='#f9d423';X.font='bold 14px sans-serif';X.textAlign='left';
X.fillText('‚è± '+simTime.toFixed(1)+'s',10,CH-10);
X.fillText('‚ö° '+reactionCount+' reactions',120,CH-10)
}}
let lastTime=0;
function gameLoop(t){
const dt=Math.min((t-lastTime)/1000,.05);lastTime=t;
if(playing){
const steps=Math.ceil(SUB*simSpeed);
const sdt=dt*simSpeed/steps;
for(let s=0;s<steps;s++){physStep(sdt);simTime+=sdt}
}
updateParticles();render();
requestAnimationFrame(gameLoop)
}
function getObjAt(mx,my){
for(let i=placed.length-1;i>=0;i--){
const o=placed[i];
const dx=mx-o.x,dy=my-o.y;
const cs=Math.cos(-(o.a||0)),sn=Math.sin(-(o.a||0));
const lx=dx*cs-dy*sn,ly=dx*sn+dy*cs;
const hw=(o.type==='ball'?12:o.type==='ball_lg'?17:o.w/2)+4;
const hh=(o.type==='ball'?12:o.type==='ball_lg'?17:o.h/2)+4;
if(Math.abs(lx)<hw&&Math.abs(ly)<hh)return i
}return-1
}
C.addEventListener('mousedown',e=>{
if(playing)return;initAudio();
const r=C.getBoundingClientRect();
mouseX=e.clientX-r.left;mouseY=e.clientY-r.top;mouseDown=true;
if(e.button===2){
const idx=getObjAt(mouseX,mouseY);
if(idx>=0){saveUndo();placed.splice(idx,1);buildToolbox();updatePartCount();snd('pop')}
return
}
const idx=getObjAt(mouseX,mouseY);
if(idx>=0){
dragObj=placed[idx];dragOff={x:mouseX-dragObj.x,y:mouseY-dragObj.y};
saveUndo();return
}
if(selTool){
const avail=isSandbox?99:(curLevel>=0?(LEVELS[curLevel].tools[selTool]||0):99);
const used=placed.filter(p=>p.type===selTool).length;
if(isSandbox||used<avail){
saveUndo();
const o=newObj(selTool,mouseX,mouseY,0);
placed.push(o);dragObj=o;dragOff={x:0,y:0};
buildToolbox();updatePartCount();snd('click')
}}
});
C.addEventListener('mousemove',e=>{
const r=C.getBoundingClientRect();
mouseX=e.clientX-r.left;mouseY=e.clientY-r.top;
if(dragObj&&!playing){dragObj.x=mouseX-dragOff.x;dragObj.y=mouseY-dragOff.y}
if(!dragObj&&selTool&&!playing){
ghostObj=newObj(selTool,mouseX,mouseY,0)
}else{ghostObj=null}
});
C.addEventListener('mouseup',()=>{mouseDown=false;dragObj=null});
C.addEventListener('contextmenu',e=>e.preventDefault());
C.addEventListener('wheel',e=>{
if(playing)return;
const idx=getObjAt(mouseX,mouseY);
if(idx>=0){
e.preventDefault();saveUndo();
placed[idx].a=(placed[idx].a||0)+e.deltaY*.003
}},{passive:false});
document.addEventListener('keydown',e=>{
if(e.key==='x'||e.key==='Delete'){
if(playing)return;
const idx=getObjAt(mouseX,mouseY);
if(idx>=0){saveUndo();placed.splice(idx,1);buildToolbox();updatePartCount();snd('pop')}
}
if(e.key==='z'&&(e.ctrlKey||e.metaKey)){e.preventDefault();doUndo()}
if(e.key==='y'&&(e.ctrlKey||e.metaKey)){e.preventDefault();doRedo()}
if(e.key===' '){e.preventDefault();togglePlay()}
if(e.key==='Escape'){selTool=null;buildToolbox()}
});
window.addEventListener('resize',resize);
resize();buildMenu();
requestAnimationFrame(gameLoop);
})();
</script>
</body>
</html>
