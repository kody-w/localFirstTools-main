<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudOS - Multiplayer Browser Operating System</title>
    <meta name="description" content="Full operating system in the browser with desktop, file system, terminal, app store, and WebRTC multiplayer">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="color-scheme" content="dark">
    <!-- os, desktop, terminal, filesystem, multiplayer, webrtc, apps -->
    <style>
        :root {
            --bg-desktop: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --taskbar-bg: rgba(20, 20, 35, 0.95);
            --window-bg: rgba(30, 30, 50, 0.98);
            --window-header: rgba(40, 40, 70, 0.98);
            --accent: #00d4ff;
            --accent-secondary: #ff006e;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4466;
            --text: #e8e8f0;
            --text-dim: #888899;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-desktop);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* Boot Screen */
        #boot-screen {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }

        #boot-screen.hidden { opacity: 0; pointer-events: none; }

        .boot-logo {
            font-size: 4rem;
            margin-bottom: 2rem;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .boot-progress {
            width: 300px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
        }

        .boot-progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        .boot-text {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--text-dim);
        }

        /* Desktop */
        #desktop {
            position: absolute;
            inset: 0;
            bottom: 48px;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, 80px);
            grid-template-rows: repeat(auto-fill, 90px);
            gap: 10px;
            align-content: start;
        }

        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .desktop-icon:hover { background: rgba(255, 255, 255, 0.1); }
        .desktop-icon.selected { background: rgba(0, 212, 255, 0.3); }

        .desktop-icon-img {
            font-size: 2.5rem;
            margin-bottom: 4px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .desktop-icon-name {
            font-size: 0.75rem;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            word-break: break-word;
        }

        /* Taskbar */
        #taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: var(--taskbar-bg);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-top: 1px solid var(--border);
            z-index: 9000;
        }

        #start-button {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        #start-button:hover { transform: scale(1.1); }

        #taskbar-apps {
            flex: 1;
            display: flex;
            gap: 4px;
            margin-left: 10px;
            overflow-x: auto;
        }

        .taskbar-app {
            height: 40px;
            min-width: 44px;
            padding: 0 12px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 6px;
            color: var(--text);
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .taskbar-app:hover { background: rgba(255, 255, 255, 0.1); }
        .taskbar-app.active { background: rgba(0, 212, 255, 0.3); border-bottom: 2px solid var(--accent); }

        #system-tray {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 0 15px;
            font-size: 0.8rem;
        }

        .tray-item { cursor: pointer; opacity: 0.8; }
        .tray-item:hover { opacity: 1; }

        #clock {
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        /* Start Menu */
        #start-menu {
            position: fixed;
            bottom: 58px;
            left: 10px;
            width: 320px;
            background: var(--window-bg);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            display: none;
            overflow: hidden;
            z-index: 9500;
        }

        #start-menu.visible { display: block; }

        .start-menu-header {
            padding: 15px;
            background: rgba(0, 212, 255, 0.1);
            border-bottom: 1px solid var(--border);
        }

        .start-menu-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .user-name { font-weight: 600; }
        .user-status { font-size: 0.75rem; color: var(--success); }

        .start-menu-apps {
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .start-app-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .start-app-item:hover { background: rgba(255, 255, 255, 0.1); }

        .start-app-icon { font-size: 1.5rem; }
        .start-app-name { font-size: 0.9rem; }

        .start-menu-footer {
            padding: 10px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }

        .start-footer-btn {
            padding: 8px 16px;
            background: none;
            border: none;
            color: var(--text);
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .start-footer-btn:hover { background: rgba(255, 255, 255, 0.1); }

        /* Windows */
        .window {
            position: absolute;
            background: var(--window-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 50px rgba(0,0,0,0.4);
            min-width: 300px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: calc(100% - 48px) !important;
            border-radius: 0;
        }

        .window.minimized { display: none; }

        .window-header {
            height: 36px;
            background: var(--window-header);
            display: flex;
            align-items: center;
            padding: 0 10px;
            cursor: move;
            flex-shrink: 0;
        }

        .window-icon { font-size: 1rem; margin-right: 8px; }

        .window-title {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .window-controls {
            display: flex;
            gap: 8px;
        }

        .window-btn {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .window-btn:hover { opacity: 0.8; }
        .window-btn.minimize { background: var(--warning); }
        .window-btn.maximize { background: var(--success); }
        .window-btn.close { background: var(--danger); }

        .window-content {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .window-resize {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            cursor: nwse-resize;
        }

        /* Terminal */
        .terminal {
            height: 100%;
            background: #0d0d0d;
            padding: 10px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            overflow-y: auto;
        }

        .terminal-line {
            display: flex;
            margin-bottom: 2px;
            line-height: 1.4;
        }

        .terminal-prompt {
            color: var(--success);
            margin-right: 8px;
            white-space: nowrap;
        }

        .terminal-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text);
            font: inherit;
            outline: none;
        }

        .terminal-output { color: var(--text-dim); margin-bottom: 4px; }
        .terminal-error { color: var(--danger); }
        .terminal-success { color: var(--success); }

        /* File Manager */
        .file-manager {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .file-toolbar {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border);
        }

        .file-toolbar button {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            color: var(--text);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .file-toolbar button:hover { background: rgba(255,255,255,0.2); }

        .file-path {
            flex: 1;
            padding: 6px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.8rem;
        }

        .file-content {
            flex: 1;
            display: flex;
        }

        .file-sidebar {
            width: 180px;
            background: rgba(0,0,0,0.2);
            border-right: 1px solid var(--border);
            padding: 10px;
        }

        .file-sidebar-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .file-sidebar-item:hover { background: rgba(255,255,255,0.1); }
        .file-sidebar-item.active { background: rgba(0, 212, 255, 0.2); }

        .file-list {
            flex: 1;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            align-content: start;
        }

        .file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .file-item:hover { background: rgba(255,255,255,0.1); }
        .file-item.selected { background: rgba(0, 212, 255, 0.3); }

        .file-item-icon { font-size: 2rem; margin-bottom: 4px; }
        .file-item-name { font-size: 0.75rem; text-align: center; word-break: break-word; }

        /* App Store */
        .app-store {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .app-store-header {
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(255, 0, 110, 0.2));
        }

        .app-store-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .app-store-search {
            width: 100%;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .app-store-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .app-category {
            margin-bottom: 25px;
        }

        .app-category-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent);
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .app-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }

        .app-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.1); }

        .app-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .app-card-icon { font-size: 2.5rem; }
        .app-card-name { font-weight: 600; }
        .app-card-author { font-size: 0.75rem; color: var(--text-dim); }
        .app-card-desc { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 10px; }

        .app-card-install {
            width: 100%;
            padding: 8px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
        }

        .app-card-install.installed { background: var(--success); }

        /* Process Manager */
        .process-manager {
            height: 100%;
            display: flex;
            flex-direction: column;
            font-size: 0.85rem;
        }

        .process-header {
            display: grid;
            grid-template-columns: 40px 1fr 80px 80px 100px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }

        .process-list {
            flex: 1;
            overflow-y: auto;
        }

        .process-item {
            display: grid;
            grid-template-columns: 40px 1fr 80px 80px 100px;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .process-item:hover { background: rgba(255,255,255,0.05); }

        .process-icon { font-size: 1.2rem; }

        .process-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .process-bar-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        .process-kill {
            padding: 4px 10px;
            background: var(--danger);
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .memory-chart {
            padding: 15px;
            background: rgba(0,0,0,0.2);
        }

        .memory-bar {
            height: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
        }

        .memory-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: #000;
            transition: width 0.3s;
        }

        /* Text Editor */
        .text-editor {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .editor-toolbar {
            display: flex;
            gap: 5px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border);
        }

        .editor-toolbar button {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            color: var(--text);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .editor-textarea {
            flex: 1;
            padding: 15px;
            background: #0d0d0d;
            border: none;
            color: var(--text);
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }

        /* Settings */
        .settings {
            height: 100%;
            display: flex;
        }

        .settings-sidebar {
            width: 200px;
            background: rgba(0,0,0,0.2);
            border-right: 1px solid var(--border);
            padding: 15px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .settings-item:hover { background: rgba(255,255,255,0.1); }
        .settings-item.active { background: rgba(0, 212, 255, 0.2); }

        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-label { font-size: 0.9rem; }
        .settings-desc { font-size: 0.75rem; color: var(--text-dim); }

        .toggle {
            width: 44px;
            height: 24px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.on { background: var(--accent); }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.2s;
        }

        .toggle.on::after { left: 22px; }

        /* Multiplayer Panel */
        .multiplayer-panel {
            height: 100%;
            padding: 20px;
        }

        .peer-list {
            margin-top: 20px;
        }

        .peer-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .peer-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--success));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .peer-status {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
        }

        .peer-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .peer-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .peer-btn:hover { background: rgba(255,255,255,0.2); }

        /* Notifications */
        #notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: var(--window-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px 20px;
            min-width: 300px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.4);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-body {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Context Menu */
        #context-menu {
            position: fixed;
            background: var(--window-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 5px;
            min-width: 180px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.4);
            display: none;
            z-index: 9999;
        }

        .context-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .context-item:hover { background: rgba(255,255,255,0.1); }
        .context-divider { height: 1px; background: var(--border); margin: 5px 0; }
    </style>
</head>
<body>
    <!-- Boot Screen -->
    <div id="boot-screen">
        <div class="boot-logo">â˜ï¸</div>
        <div class="boot-progress"><div class="boot-progress-bar" id="boot-bar"></div></div>
        <div class="boot-text" id="boot-text">Initializing CloudOS...</div>
    </div>

    <!-- Desktop -->
    <div id="desktop"></div>

    <!-- Taskbar -->
    <div id="taskbar">
        <button id="start-button">â˜ï¸</button>
        <div id="taskbar-apps"></div>
        <div id="system-tray">
            <span class="tray-item" id="network-indicator" title="Network">ğŸ“¶</span>
            <span class="tray-item" id="multiplayer-indicator" title="Multiplayer: Offline">ğŸ‘¤</span>
            <span class="tray-item" id="memory-indicator" title="Memory">ğŸ’¾</span>
            <span id="clock"></span>
        </div>
    </div>

    <!-- Start Menu -->
    <div id="start-menu">
        <div class="start-menu-header">
            <div class="start-menu-user">
                <div class="user-avatar">ğŸ‘¤</div>
                <div>
                    <div class="user-name" id="user-name">User</div>
                    <div class="user-status">â— Online</div>
                </div>
            </div>
        </div>
        <div class="start-menu-apps" id="start-menu-apps"></div>
        <div class="start-menu-footer">
            <button class="start-footer-btn" onclick="os.showSettings()">âš™ï¸ Settings</button>
            <button class="start-footer-btn" onclick="os.shutdown()">â» Shutdown</button>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu"></div>

    <!-- Notifications -->
    <div id="notifications"></div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VIRTUAL FILE SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        class VirtualFS {
            constructor() {
                this.root = this.load() || this.createDefault();
            }

            createDefault() {
                return {
                    type: 'dir',
                    name: '/',
                    children: {
                        'home': {
                            type: 'dir',
                            name: 'home',
                            children: {
                                'user': {
                                    type: 'dir',
                                    name: 'user',
                                    children: {
                                        'Documents': { type: 'dir', name: 'Documents', children: {
                                            'readme.txt': { type: 'file', name: 'readme.txt', content: 'Welcome to CloudOS!\n\nThis is your virtual file system.' }
                                        }},
                                        'Pictures': { type: 'dir', name: 'Pictures', children: {} },
                                        'Downloads': { type: 'dir', name: 'Downloads', children: {} },
                                        'Desktop': { type: 'dir', name: 'Desktop', children: {} }
                                    }
                                }
                            }
                        },
                        'system': {
                            type: 'dir',
                            name: 'system',
                            children: {
                                'apps': { type: 'dir', name: 'apps', children: {} },
                                'config': { type: 'dir', name: 'config', children: {} }
                            }
                        },
                        'tmp': { type: 'dir', name: 'tmp', children: {} }
                    }
                };
            }

            save() {
                localStorage.setItem('cloudos-fs', JSON.stringify(this.root));
            }

            load() {
                const data = localStorage.getItem('cloudos-fs');
                return data ? JSON.parse(data) : null;
            }

            parsePath(path) {
                return path.split('/').filter(p => p.length > 0);
            }

            getNode(path) {
                if (path === '/' || path === '') return this.root;
                const parts = this.parsePath(path);
                let node = this.root;
                for (const part of parts) {
                    if (!node.children || !node.children[part]) return null;
                    node = node.children[part];
                }
                return node;
            }

            getParent(path) {
                const parts = this.parsePath(path);
                parts.pop();
                return this.getNode('/' + parts.join('/'));
            }

            list(path) {
                const node = this.getNode(path);
                if (!node || node.type !== 'dir') return null;
                return Object.values(node.children || {});
            }

            createFile(path, content = '') {
                const parts = this.parsePath(path);
                const name = parts.pop();
                const parent = this.getNode('/' + parts.join('/'));
                if (!parent || parent.type !== 'dir') return false;
                parent.children[name] = { type: 'file', name, content };
                this.save();
                return true;
            }

            createDir(path) {
                const parts = this.parsePath(path);
                const name = parts.pop();
                const parent = this.getNode('/' + parts.join('/'));
                if (!parent || parent.type !== 'dir') return false;
                parent.children[name] = { type: 'dir', name, children: {} };
                this.save();
                return true;
            }

            read(path) {
                const node = this.getNode(path);
                return node && node.type === 'file' ? node.content : null;
            }

            write(path, content) {
                const node = this.getNode(path);
                if (node && node.type === 'file') {
                    node.content = content;
                    this.save();
                    return true;
                }
                return this.createFile(path, content);
            }

            delete(path) {
                const parts = this.parsePath(path);
                const name = parts.pop();
                const parent = this.getNode('/' + parts.join('/'));
                if (!parent || !parent.children[name]) return false;
                delete parent.children[name];
                this.save();
                return true;
            }

            exists(path) {
                return this.getNode(path) !== null;
            }

            isDir(path) {
                const node = this.getNode(path);
                return node && node.type === 'dir';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROCESS MANAGER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        class ProcessManager {
            constructor() {
                this.processes = new Map();
                this.nextPid = 1;
                this.totalMemory = 1024; // MB
            }

            spawn(name, icon, type = 'app') {
                const pid = this.nextPid++;
                const process = {
                    pid,
                    name,
                    icon,
                    type,
                    memory: Math.floor(Math.random() * 100) + 20,
                    cpu: Math.floor(Math.random() * 30),
                    startTime: Date.now()
                };
                this.processes.set(pid, process);
                return pid;
            }

            kill(pid) {
                return this.processes.delete(pid);
            }

            getProcess(pid) {
                return this.processes.get(pid);
            }

            getAllProcesses() {
                return Array.from(this.processes.values());
            }

            getMemoryUsage() {
                let used = 0;
                for (const p of this.processes.values()) {
                    used += p.memory;
                }
                return { used, total: this.totalMemory, free: this.totalMemory - used };
            }

            updateStats() {
                for (const p of this.processes.values()) {
                    p.cpu = Math.max(0, Math.min(100, p.cpu + (Math.random() - 0.5) * 10));
                    p.memory = Math.max(20, Math.min(200, p.memory + (Math.random() - 0.5) * 5));
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WINDOW MANAGER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        class WindowManager {
            constructor(os) {
                this.os = os;
                this.windows = new Map();
                this.nextId = 1;
                this.zIndex = 100;
                this.activeWindow = null;
            }

            create(options) {
                const id = this.nextId++;
                const win = document.createElement('div');
                win.className = 'window';
                win.id = `window-${id}`;
                win.style.cssText = `
                    left: ${options.x || 100 + (id * 30) % 200}px;
                    top: ${options.y || 80 + (id * 30) % 150}px;
                    width: ${options.width || 600}px;
                    height: ${options.height || 400}px;
                    z-index: ${this.zIndex++};
                `;

                win.innerHTML = `
                    <div class="window-header">
                        <span class="window-icon">${options.icon || 'ğŸ“„'}</span>
                        <span class="window-title">${options.title || 'Window'}</span>
                        <div class="window-controls">
                            <button class="window-btn minimize" onclick="os.wm.minimize(${id})"></button>
                            <button class="window-btn maximize" onclick="os.wm.toggleMaximize(${id})"></button>
                            <button class="window-btn close" onclick="os.wm.close(${id})"></button>
                        </div>
                    </div>
                    <div class="window-content" id="window-content-${id}"></div>
                    <div class="window-resize"></div>
                `;

                document.body.appendChild(win);

                const windowData = {
                    id,
                    element: win,
                    pid: options.pid,
                    title: options.title,
                    icon: options.icon,
                    minimized: false,
                    maximized: false
                };

                this.windows.set(id, windowData);
                this.setupDrag(win, id);
                this.setupResize(win);
                this.focus(id);
                this.updateTaskbar();

                return { id, content: document.getElementById(`window-content-${id}`) };
            }

            setupDrag(win, id) {
                const header = win.querySelector('.window-header');
                let dragging = false;
                let startX, startY, startLeft, startTop;

                header.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('window-btn')) return;
                    dragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = win.offsetLeft;
                    startTop = win.offsetTop;
                    this.focus(id);
                });

                document.addEventListener('mousemove', (e) => {
                    if (!dragging) return;
                    const windowData = this.windows.get(id);
                    if (windowData.maximized) return;
                    win.style.left = startLeft + (e.clientX - startX) + 'px';
                    win.style.top = startTop + (e.clientY - startY) + 'px';
                });

                document.addEventListener('mouseup', () => dragging = false);
            }

            setupResize(win) {
                const resizer = win.querySelector('.window-resize');
                let resizing = false;
                let startX, startY, startWidth, startHeight;

                resizer.addEventListener('mousedown', (e) => {
                    resizing = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = win.offsetWidth;
                    startHeight = win.offsetHeight;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!resizing) return;
                    win.style.width = Math.max(300, startWidth + (e.clientX - startX)) + 'px';
                    win.style.height = Math.max(200, startHeight + (e.clientY - startY)) + 'px';
                });

                document.addEventListener('mouseup', () => resizing = false);
            }

            focus(id) {
                const windowData = this.windows.get(id);
                if (!windowData) return;

                this.activeWindow = id;
                windowData.element.style.zIndex = this.zIndex++;
                this.updateTaskbar();
            }

            minimize(id) {
                const windowData = this.windows.get(id);
                if (!windowData) return;
                windowData.minimized = true;
                windowData.element.classList.add('minimized');
                this.updateTaskbar();
            }

            restore(id) {
                const windowData = this.windows.get(id);
                if (!windowData) return;
                windowData.minimized = false;
                windowData.element.classList.remove('minimized');
                this.focus(id);
            }

            toggleMaximize(id) {
                const windowData = this.windows.get(id);
                if (!windowData) return;
                windowData.maximized = !windowData.maximized;
                windowData.element.classList.toggle('maximized', windowData.maximized);
            }

            close(id) {
                const windowData = this.windows.get(id);
                if (!windowData) return;
                windowData.element.remove();
                this.windows.delete(id);
                if (windowData.pid) {
                    this.os.pm.kill(windowData.pid);
                }
                this.updateTaskbar();
            }

            updateTaskbar() {
                const container = document.getElementById('taskbar-apps');
                container.innerHTML = '';

                for (const [id, win] of this.windows) {
                    const btn = document.createElement('button');
                    btn.className = 'taskbar-app' + (id === this.activeWindow && !win.minimized ? ' active' : '');
                    btn.innerHTML = `<span>${win.icon}</span><span>${win.title}</span>`;
                    btn.onclick = () => {
                        if (win.minimized) {
                            this.restore(id);
                        } else if (id === this.activeWindow) {
                            this.minimize(id);
                        } else {
                            this.focus(id);
                        }
                    };
                    container.appendChild(btn);
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MULTIPLAYER (WebRTC)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        class MultiplayerManager {
            constructor(os) {
                this.os = os;
                this.peerId = this.generateId();
                this.peers = new Map();
                this.connections = new Map();
                this.isHost = false;
                this.roomCode = null;
            }

            generateId() {
                return 'peer-' + Math.random().toString(36).substr(2, 9);
            }

            generateRoomCode() {
                return Math.random().toString(36).substr(2, 6).toUpperCase();
            }

            createRoom() {
                this.isHost = true;
                this.roomCode = this.generateRoomCode();
                this.os.notify('Room Created', `Room code: ${this.roomCode}`);
                this.updateIndicator();
                return this.roomCode;
            }

            joinRoom(code) {
                this.roomCode = code;
                this.os.notify('Joining Room', `Connecting to room: ${code}`);
                // In a real implementation, this would use a signaling server
                // For demo, we'll simulate a peer connection
                setTimeout(() => {
                    this.addPeer('demo-peer', 'Demo User');
                }, 1000);
            }

            addPeer(peerId, name) {
                this.peers.set(peerId, { id: peerId, name, connected: true });
                this.os.notify('Peer Connected', `${name} joined the session`);
                this.updateIndicator();
            }

            removePeer(peerId) {
                const peer = this.peers.get(peerId);
                if (peer) {
                    this.os.notify('Peer Disconnected', `${peer.name} left the session`);
                    this.peers.delete(peerId);
                }
                this.updateIndicator();
            }

            broadcast(type, data) {
                // Send data to all connected peers
                for (const conn of this.connections.values()) {
                    if (conn.open) {
                        conn.send({ type, data, from: this.peerId });
                    }
                }
            }

            shareScreen() {
                this.os.notify('Screen Share', 'Screen sharing started (simulated)');
            }

            updateIndicator() {
                const indicator = document.getElementById('multiplayer-indicator');
                const count = this.peers.size;
                indicator.textContent = count > 0 ? `ğŸ‘¥ ${count + 1}` : 'ğŸ‘¤';
                indicator.title = count > 0 ? `Multiplayer: ${count + 1} users` : 'Multiplayer: Offline';
            }

            getPeers() {
                return Array.from(this.peers.values());
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OPERATING SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        class CloudOS {
            constructor() {
                this.fs = new VirtualFS();
                this.pm = new ProcessManager();
                this.wm = new WindowManager(this);
                this.mp = new MultiplayerManager(this);

                this.apps = [
                    { id: 'terminal', name: 'Terminal', icon: 'ğŸ’»', system: true },
                    { id: 'files', name: 'Files', icon: 'ğŸ“', system: true },
                    { id: 'editor', name: 'Text Editor', icon: 'ğŸ“', system: true },
                    { id: 'appstore', name: 'App Store', icon: 'ğŸ›’', system: true },
                    { id: 'processes', name: 'Process Manager', icon: 'ğŸ“Š', system: true },
                    { id: 'settings', name: 'Settings', icon: 'âš™ï¸', system: true },
                    { id: 'multiplayer', name: 'Multiplayer', icon: 'ğŸŒ', system: true },
                    { id: 'browser', name: 'Web Browser', icon: 'ğŸŒ', installed: true },
                    { id: 'calculator', name: 'Calculator', icon: 'ğŸ”¢', installed: true },
                    { id: 'notes', name: 'Notes', icon: 'ğŸ“’', installed: true }
                ];

                this.installedApps = new Set(['browser', 'calculator', 'notes']);
            }

            async boot() {
                const bootBar = document.getElementById('boot-bar');
                const bootText = document.getElementById('boot-text');
                const steps = [
                    'Initializing kernel...',
                    'Loading file system...',
                    'Starting process manager...',
                    'Loading desktop...',
                    'Starting services...',
                    'Welcome to CloudOS!'
                ];

                for (let i = 0; i < steps.length; i++) {
                    bootText.textContent = steps[i];
                    bootBar.style.width = ((i + 1) / steps.length * 100) + '%';
                    await new Promise(r => setTimeout(r, 400));
                }

                await new Promise(r => setTimeout(r, 500));
                document.getElementById('boot-screen').classList.add('hidden');

                this.initDesktop();
                this.initClock();
                this.initStartMenu();
                this.initContextMenu();
                this.startMemoryMonitor();

                // System process
                this.pm.spawn('System', 'âš™ï¸', 'system');
                this.pm.spawn('Desktop', 'ğŸ–¥ï¸', 'system');
            }

            initDesktop() {
                const desktop = document.getElementById('desktop');
                const desktopIcons = [
                    { name: 'Terminal', icon: 'ğŸ’»', app: 'terminal' },
                    { name: 'Files', icon: 'ğŸ“', app: 'files' },
                    { name: 'App Store', icon: 'ğŸ›’', app: 'appstore' },
                    { name: 'Settings', icon: 'âš™ï¸', app: 'settings' }
                ];

                desktopIcons.forEach(item => {
                    const icon = document.createElement('div');
                    icon.className = 'desktop-icon';
                    icon.innerHTML = `
                        <div class="desktop-icon-img">${item.icon}</div>
                        <div class="desktop-icon-name">${item.name}</div>
                    `;
                    icon.ondblclick = () => this.openApp(item.app);
                    desktop.appendChild(icon);
                });

                desktop.onclick = (e) => {
                    if (e.target === desktop) {
                        document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
                    }
                };
            }

            initClock() {
                const update = () => {
                    const now = new Date();
                    document.getElementById('clock').textContent =
                        now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                };
                update();
                setInterval(update, 1000);
            }

            initStartMenu() {
                const container = document.getElementById('start-menu-apps');

                this.apps.filter(a => a.system || this.installedApps.has(a.id)).forEach(app => {
                    const item = document.createElement('div');
                    item.className = 'start-app-item';
                    item.innerHTML = `
                        <span class="start-app-icon">${app.icon}</span>
                        <span class="start-app-name">${app.name}</span>
                    `;
                    item.onclick = () => {
                        this.openApp(app.id);
                        this.toggleStartMenu();
                    };
                    container.appendChild(item);
                });

                document.getElementById('start-button').onclick = () => this.toggleStartMenu();

                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('start-menu');
                    const btn = document.getElementById('start-button');
                    if (!menu.contains(e.target) && !btn.contains(e.target)) {
                        menu.classList.remove('visible');
                    }
                });
            }

            toggleStartMenu() {
                document.getElementById('start-menu').classList.toggle('visible');
            }

            initContextMenu() {
                const menu = document.getElementById('context-menu');

                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    menu.innerHTML = `
                        <div class="context-item" onclick="os.openApp('terminal')">ğŸ’» Open Terminal</div>
                        <div class="context-item" onclick="os.openApp('files')">ğŸ“ Open Files</div>
                        <div class="context-divider"></div>
                        <div class="context-item" onclick="os.openApp('settings')">âš™ï¸ Settings</div>
                        <div class="context-item" onclick="location.reload()">ğŸ”„ Refresh</div>
                    `;
                    menu.style.left = e.clientX + 'px';
                    menu.style.top = e.clientY + 'px';
                    menu.style.display = 'block';
                });

                document.addEventListener('click', () => menu.style.display = 'none');
            }

            startMemoryMonitor() {
                setInterval(() => {
                    this.pm.updateStats();
                    const mem = this.pm.getMemoryUsage();
                    const pct = Math.round(mem.used / mem.total * 100);
                    document.getElementById('memory-indicator').textContent = `ğŸ’¾ ${pct}%`;
                }, 2000);
            }

            openApp(appId) {
                const app = this.apps.find(a => a.id === appId);
                if (!app) return;

                const pid = this.pm.spawn(app.name, app.icon);

                switch (appId) {
                    case 'terminal': this.openTerminal(pid); break;
                    case 'files': this.openFileManager(pid); break;
                    case 'editor': this.openTextEditor(pid); break;
                    case 'appstore': this.openAppStore(pid); break;
                    case 'processes': this.openProcessManager(pid); break;
                    case 'settings': this.openSettings(pid); break;
                    case 'multiplayer': this.openMultiplayer(pid); break;
                    case 'calculator': this.openCalculator(pid); break;
                    case 'notes': this.openNotes(pid); break;
                    case 'browser': this.openBrowser(pid); break;
                    default: this.openGenericApp(app, pid);
                }
            }

            openTerminal(pid) {
                const { content } = this.wm.create({
                    title: 'Terminal',
                    icon: 'ğŸ’»',
                    pid,
                    width: 700,
                    height: 450
                });

                content.innerHTML = '<div class="terminal" id="terminal-output"></div>';
                const terminal = content.querySelector('.terminal');
                let cwd = '/home/user';
                let history = [];
                let historyIndex = -1;

                const addLine = (text, className = '') => {
                    const line = document.createElement('div');
                    line.className = className;
                    line.textContent = text;
                    terminal.insertBefore(line, terminal.lastElementChild);
                };

                const createPrompt = () => {
                    const line = document.createElement('div');
                    line.className = 'terminal-line';
                    line.innerHTML = `
                        <span class="terminal-prompt">user@cloudos:${cwd}$</span>
                        <input class="terminal-input" type="text" autofocus>
                    `;
                    terminal.appendChild(line);
                    const input = line.querySelector('input');
                    input.focus();

                    input.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            const cmd = input.value.trim();
                            input.disabled = true;
                            if (cmd) {
                                history.push(cmd);
                                historyIndex = history.length;
                                this.executeCommand(cmd, cwd, addLine, (newCwd) => cwd = newCwd);
                            }
                            createPrompt();
                        } else if (e.key === 'ArrowUp') {
                            if (historyIndex > 0) {
                                historyIndex--;
                                input.value = history[historyIndex];
                            }
                            e.preventDefault();
                        } else if (e.key === 'ArrowDown') {
                            if (historyIndex < history.length - 1) {
                                historyIndex++;
                                input.value = history[historyIndex];
                            } else {
                                historyIndex = history.length;
                                input.value = '';
                            }
                            e.preventDefault();
                        }
                    };
                };

                addLine('CloudOS Terminal v1.0', 'terminal-success');
                addLine('Type "help" for available commands.', 'terminal-output');
                createPrompt();

                terminal.onclick = () => terminal.querySelector('input:last-of-type')?.focus();
            }

            executeCommand(cmd, cwd, addLine, setCwd) {
                const parts = cmd.split(' ');
                const command = parts[0];
                const args = parts.slice(1);

                switch (command) {
                    case 'help':
                        addLine('Available commands:', 'terminal-output');
                        addLine('  ls [path]     - List directory contents', 'terminal-output');
                        addLine('  cd <path>     - Change directory', 'terminal-output');
                        addLine('  pwd           - Print working directory', 'terminal-output');
                        addLine('  cat <file>    - Display file contents', 'terminal-output');
                        addLine('  mkdir <name>  - Create directory', 'terminal-output');
                        addLine('  touch <file>  - Create file', 'terminal-output');
                        addLine('  rm <path>     - Remove file/directory', 'terminal-output');
                        addLine('  echo <text>   - Print text', 'terminal-output');
                        addLine('  clear         - Clear terminal', 'terminal-output');
                        addLine('  ps            - List processes', 'terminal-output');
                        addLine('  kill <pid>    - Kill process', 'terminal-output');
                        addLine('  whoami        - Current user', 'terminal-output');
                        addLine('  date          - Current date/time', 'terminal-output');
                        addLine('  neofetch      - System info', 'terminal-output');
                        break;

                    case 'ls':
                        const lsPath = args[0] ? this.resolvePath(cwd, args[0]) : cwd;
                        const files = this.fs.list(lsPath);
                        if (files) {
                            files.forEach(f => {
                                const prefix = f.type === 'dir' ? 'ğŸ“ ' : 'ğŸ“„ ';
                                addLine(prefix + f.name, 'terminal-output');
                            });
                            if (files.length === 0) addLine('(empty)', 'terminal-output');
                        } else {
                            addLine(`ls: cannot access '${lsPath}': No such directory`, 'terminal-error');
                        }
                        break;

                    case 'cd':
                        if (!args[0]) {
                            setCwd('/home/user');
                        } else {
                            const newPath = this.resolvePath(cwd, args[0]);
                            if (this.fs.isDir(newPath)) {
                                setCwd(newPath);
                            } else {
                                addLine(`cd: no such directory: ${args[0]}`, 'terminal-error');
                            }
                        }
                        break;

                    case 'pwd':
                        addLine(cwd, 'terminal-output');
                        break;

                    case 'cat':
                        if (!args[0]) {
                            addLine('cat: missing operand', 'terminal-error');
                        } else {
                            const filePath = this.resolvePath(cwd, args[0]);
                            const content = this.fs.read(filePath);
                            if (content !== null) {
                                content.split('\n').forEach(line => addLine(line, 'terminal-output'));
                            } else {
                                addLine(`cat: ${args[0]}: No such file`, 'terminal-error');
                            }
                        }
                        break;

                    case 'mkdir':
                        if (!args[0]) {
                            addLine('mkdir: missing operand', 'terminal-error');
                        } else {
                            const dirPath = this.resolvePath(cwd, args[0]);
                            if (this.fs.createDir(dirPath)) {
                                addLine(`Created directory: ${args[0]}`, 'terminal-success');
                            } else {
                                addLine(`mkdir: cannot create directory '${args[0]}'`, 'terminal-error');
                            }
                        }
                        break;

                    case 'touch':
                        if (!args[0]) {
                            addLine('touch: missing operand', 'terminal-error');
                        } else {
                            const filePath = this.resolvePath(cwd, args[0]);
                            if (this.fs.createFile(filePath, '')) {
                                addLine(`Created file: ${args[0]}`, 'terminal-success');
                            } else {
                                addLine(`touch: cannot create file '${args[0]}'`, 'terminal-error');
                            }
                        }
                        break;

                    case 'rm':
                        if (!args[0]) {
                            addLine('rm: missing operand', 'terminal-error');
                        } else {
                            const rmPath = this.resolvePath(cwd, args[0]);
                            if (this.fs.delete(rmPath)) {
                                addLine(`Removed: ${args[0]}`, 'terminal-success');
                            } else {
                                addLine(`rm: cannot remove '${args[0]}'`, 'terminal-error');
                            }
                        }
                        break;

                    case 'echo':
                        addLine(args.join(' '), 'terminal-output');
                        break;

                    case 'clear':
                        const terminal = document.getElementById('terminal-output');
                        while (terminal.children.length > 1) {
                            terminal.removeChild(terminal.firstChild);
                        }
                        break;

                    case 'ps':
                        addLine('PID\tNAME\t\tMEM\tCPU', 'terminal-output');
                        this.pm.getAllProcesses().forEach(p => {
                            addLine(`${p.pid}\t${p.name.padEnd(12)}\t${p.memory}MB\t${p.cpu.toFixed(0)}%`, 'terminal-output');
                        });
                        break;

                    case 'kill':
                        if (!args[0]) {
                            addLine('kill: missing operand', 'terminal-error');
                        } else {
                            const pid = parseInt(args[0]);
                            if (this.pm.kill(pid)) {
                                addLine(`Killed process ${pid}`, 'terminal-success');
                            } else {
                                addLine(`kill: no such process: ${pid}`, 'terminal-error');
                            }
                        }
                        break;

                    case 'whoami':
                        addLine('user', 'terminal-output');
                        break;

                    case 'date':
                        addLine(new Date().toString(), 'terminal-output');
                        break;

                    case 'neofetch':
                        addLine('', 'terminal-output');
                        addLine('   â˜ï¸â˜ï¸â˜ï¸    user@cloudos', 'terminal-success');
                        addLine('  â˜ï¸â˜ï¸â˜ï¸â˜ï¸   --------------', 'terminal-success');
                        addLine(' â˜ï¸â˜ï¸â˜ï¸â˜ï¸â˜ï¸  OS: CloudOS 1.0', 'terminal-output');
                        addLine('  â˜ï¸â˜ï¸â˜ï¸â˜ï¸   Host: Browser', 'terminal-output');
                        addLine('   â˜ï¸â˜ï¸â˜ï¸    Kernel: JavaScript', 'terminal-output');
                        addLine('            Shell: CloudSH', 'terminal-output');
                        addLine(`            Memory: ${this.pm.getMemoryUsage().used}MB / ${this.pm.getMemoryUsage().total}MB`, 'terminal-output');
                        addLine(`            Processes: ${this.pm.getAllProcesses().length}`, 'terminal-output');
                        addLine('', 'terminal-output');
                        break;

                    default:
                        addLine(`${command}: command not found`, 'terminal-error');
                }
            }

            resolvePath(cwd, path) {
                if (path.startsWith('/')) return path;
                if (path === '..') {
                    const parts = cwd.split('/').filter(p => p);
                    parts.pop();
                    return '/' + parts.join('/');
                }
                if (path === '.') return cwd;
                return cwd === '/' ? '/' + path : cwd + '/' + path;
            }

            openFileManager(pid, initialPath = '/home/user') {
                const { content } = this.wm.create({
                    title: 'Files',
                    icon: 'ğŸ“',
                    pid,
                    width: 800,
                    height: 500
                });

                let currentPath = initialPath;

                const render = () => {
                    const files = this.fs.list(currentPath) || [];
                    const fileList = files.map(f => `
                        <div class="file-item" data-name="${f.name}" data-type="${f.type}">
                            <div class="file-item-icon">${f.type === 'dir' ? 'ğŸ“' : 'ğŸ“„'}</div>
                            <div class="file-item-name">${f.name}</div>
                        </div>
                    `).join('');

                    content.innerHTML = `
                        <div class="file-manager">
                            <div class="file-toolbar">
                                <button onclick="os.fileNav('${currentPath}', 'back')">â¬…ï¸ Back</button>
                                <button onclick="os.fileNav('${currentPath}', 'home')">ğŸ  Home</button>
                                <input class="file-path" value="${currentPath}" readonly>
                                <button onclick="os.createFolder('${currentPath}')">ğŸ“ New Folder</button>
                            </div>
                            <div class="file-content">
                                <div class="file-sidebar">
                                    <div class="file-sidebar-item" onclick="os.navigateTo('/home/user')">ğŸ  Home</div>
                                    <div class="file-sidebar-item" onclick="os.navigateTo('/home/user/Documents')">ğŸ“„ Documents</div>
                                    <div class="file-sidebar-item" onclick="os.navigateTo('/home/user/Pictures')">ğŸ–¼ï¸ Pictures</div>
                                    <div class="file-sidebar-item" onclick="os.navigateTo('/home/user/Downloads')">â¬‡ï¸ Downloads</div>
                                </div>
                                <div class="file-list">${fileList || '<div style="padding:20px;color:var(--text-dim)">Empty folder</div>'}</div>
                            </div>
                        </div>
                    `;

                    content.querySelectorAll('.file-item').forEach(item => {
                        item.ondblclick = () => {
                            const name = item.dataset.name;
                            const type = item.dataset.type;
                            if (type === 'dir') {
                                currentPath = currentPath === '/' ? '/' + name : currentPath + '/' + name;
                                render();
                            } else {
                                this.openFile(currentPath + '/' + name);
                            }
                        };
                    });
                };

                render();
                this.currentFileManager = { render, setPath: (p) => { currentPath = p; render(); } };
            }

            navigateTo(path) {
                if (this.currentFileManager) {
                    this.currentFileManager.setPath(path);
                }
            }

            fileNav(currentPath, action) {
                if (action === 'back') {
                    const parts = currentPath.split('/').filter(p => p);
                    parts.pop();
                    this.navigateTo('/' + parts.join('/') || '/');
                } else if (action === 'home') {
                    this.navigateTo('/home/user');
                }
            }

            createFolder(currentPath) {
                const name = prompt('Folder name:');
                if (name) {
                    const path = currentPath === '/' ? '/' + name : currentPath + '/' + name;
                    this.fs.createDir(path);
                    this.currentFileManager?.render();
                }
            }

            openFile(path) {
                const content = this.fs.read(path);
                if (content !== null) {
                    this.openTextEditor(this.pm.spawn('Text Editor', 'ğŸ“'), path, content);
                }
            }

            openTextEditor(pid, filePath = null, initialContent = '') {
                const { content } = this.wm.create({
                    title: filePath ? `Editor - ${filePath.split('/').pop()}` : 'Text Editor',
                    icon: 'ğŸ“',
                    pid,
                    width: 700,
                    height: 500
                });

                content.innerHTML = `
                    <div class="text-editor">
                        <div class="editor-toolbar">
                            <button onclick="os.editorNew()">ğŸ“„ New</button>
                            <button onclick="os.editorSave()">ğŸ’¾ Save</button>
                            <button onclick="os.editorSaveAs()">ğŸ“¥ Save As</button>
                        </div>
                        <textarea class="editor-textarea" id="editor-content" placeholder="Start typing...">${initialContent}</textarea>
                    </div>
                `;

                this.currentEditorPath = filePath;
            }

            editorSave() {
                const content = document.getElementById('editor-content')?.value;
                if (this.currentEditorPath && content !== undefined) {
                    this.fs.write(this.currentEditorPath, content);
                    this.notify('File Saved', this.currentEditorPath);
                } else {
                    this.editorSaveAs();
                }
            }

            editorSaveAs() {
                const path = prompt('Save as (full path):', '/home/user/Documents/');
                if (path) {
                    this.currentEditorPath = path;
                    this.editorSave();
                }
            }

            editorNew() {
                this.currentEditorPath = null;
                document.getElementById('editor-content').value = '';
            }

            openAppStore(pid) {
                const { content } = this.wm.create({
                    title: 'App Store',
                    icon: 'ğŸ›’',
                    pid,
                    width: 800,
                    height: 600
                });

                const storeApps = [
                    { id: 'browser', name: 'Web Browser', icon: 'ğŸŒ', desc: 'Browse the web', author: 'CloudOS' },
                    { id: 'calculator', name: 'Calculator', icon: 'ğŸ”¢', desc: 'Simple calculator', author: 'CloudOS' },
                    { id: 'notes', name: 'Notes', icon: 'ğŸ“’', desc: 'Quick notes app', author: 'CloudOS' },
                    { id: 'music', name: 'Music Player', icon: 'ğŸµ', desc: 'Play your music', author: 'CloudOS' },
                    { id: 'weather', name: 'Weather', icon: 'ğŸŒ¤ï¸', desc: 'Weather forecast', author: 'CloudOS' },
                    { id: 'clock', name: 'Clock', icon: 'â°', desc: 'World clock & timer', author: 'CloudOS' }
                ];

                const appCards = storeApps.map(app => `
                    <div class="app-card">
                        <div class="app-card-header">
                            <span class="app-card-icon">${app.icon}</span>
                            <div>
                                <div class="app-card-name">${app.name}</div>
                                <div class="app-card-author">by ${app.author}</div>
                            </div>
                        </div>
                        <div class="app-card-desc">${app.desc}</div>
                        <button class="app-card-install ${this.installedApps.has(app.id) ? 'installed' : ''}"
                                onclick="os.installApp('${app.id}')">
                            ${this.installedApps.has(app.id) ? 'âœ“ Installed' : 'Install'}
                        </button>
                    </div>
                `).join('');

                content.innerHTML = `
                    <div class="app-store">
                        <div class="app-store-header">
                            <div class="app-store-title">ğŸ›’ App Store</div>
                            <input class="app-store-search" placeholder="Search apps...">
                        </div>
                        <div class="app-store-content">
                            <div class="app-category">
                                <div class="app-category-title">Featured Apps</div>
                                <div class="app-grid">${appCards}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            installApp(id) {
                if (!this.installedApps.has(id)) {
                    this.installedApps.add(id);
                    this.notify('App Installed', `${id} has been installed`);
                    // Refresh app store if open
                    this.openAppStore(this.pm.spawn('App Store', 'ğŸ›’'));
                }
            }

            openProcessManager(pid) {
                const { content } = this.wm.create({
                    title: 'Process Manager',
                    icon: 'ğŸ“Š',
                    pid,
                    width: 700,
                    height: 500
                });

                const render = () => {
                    const processes = this.pm.getAllProcesses();
                    const mem = this.pm.getMemoryUsage();

                    const memColors = ['#00d4ff', '#ff006e', '#00ff88', '#ffaa00'];
                    const memSegments = processes.slice(0, 4).map((p, i) =>
                        `<div class="memory-segment" style="width:${p.memory / mem.total * 100}%;background:${memColors[i]}">${p.name.slice(0,8)}</div>`
                    ).join('');

                    content.innerHTML = `
                        <div class="process-manager">
                            <div class="memory-chart">
                                <div style="margin-bottom:10px">Memory: ${mem.used}MB / ${mem.total}MB (${Math.round(mem.used/mem.total*100)}%)</div>
                                <div class="memory-bar">
                                    ${memSegments}
                                    <div class="memory-segment" style="flex:1;background:rgba(255,255,255,0.1)"></div>
                                </div>
                            </div>
                            <div class="process-header">
                                <span></span>
                                <span>Name</span>
                                <span>Memory</span>
                                <span>CPU</span>
                                <span>Action</span>
                            </div>
                            <div class="process-list">
                                ${processes.map(p => `
                                    <div class="process-item">
                                        <span class="process-icon">${p.icon}</span>
                                        <span>${p.name}</span>
                                        <span>${p.memory.toFixed(0)}MB</span>
                                        <div class="process-bar"><div class="process-bar-fill" style="width:${p.cpu}%"></div></div>
                                        <button class="process-kill" onclick="os.killProcess(${p.pid})">End</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                };

                render();
                this.processManagerRender = render;
                setInterval(() => this.processManagerRender?.(), 2000);
            }

            killProcess(pid) {
                if (this.pm.kill(pid)) {
                    this.notify('Process Killed', `Process ${pid} terminated`);
                    this.processManagerRender?.();
                }
            }

            openSettings(pid) {
                const { content } = this.wm.create({
                    title: 'Settings',
                    icon: 'âš™ï¸',
                    pid,
                    width: 700,
                    height: 500
                });

                content.innerHTML = `
                    <div class="settings">
                        <div class="settings-sidebar">
                            <div class="settings-item active">ğŸ‘¤ Account</div>
                            <div class="settings-item">ğŸ¨ Appearance</div>
                            <div class="settings-item">ğŸ”” Notifications</div>
                            <div class="settings-item">ğŸŒ Network</div>
                            <div class="settings-item">ğŸ’¾ Storage</div>
                            <div class="settings-item">â„¹ï¸ About</div>
                        </div>
                        <div class="settings-content">
                            <div class="settings-section">
                                <div class="settings-section-title">Account Settings</div>
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-label">Username</div>
                                        <div class="settings-desc">Your display name</div>
                                    </div>
                                    <input style="background:rgba(0,0,0,0.3);border:1px solid var(--border);padding:8px;border-radius:4px;color:var(--text)" value="User">
                                </div>
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-label">Show online status</div>
                                        <div class="settings-desc">Let others see when you're online</div>
                                    </div>
                                    <div class="toggle on" onclick="this.classList.toggle('on')"></div>
                                </div>
                            </div>
                            <div class="settings-section">
                                <div class="settings-section-title">System</div>
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-label">Dark mode</div>
                                        <div class="settings-desc">Use dark theme</div>
                                    </div>
                                    <div class="toggle on" onclick="this.classList.toggle('on')"></div>
                                </div>
                                <div class="settings-row">
                                    <div>
                                        <div class="settings-label">Animations</div>
                                        <div class="settings-desc">Enable UI animations</div>
                                    </div>
                                    <div class="toggle on" onclick="this.classList.toggle('on')"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            showSettings() {
                this.openApp('settings');
                this.toggleStartMenu();
            }

            openMultiplayer(pid) {
                const { content } = this.wm.create({
                    title: 'Multiplayer',
                    icon: 'ğŸŒ',
                    pid,
                    width: 500,
                    height: 450
                });

                const peers = this.mp.getPeers();
                const peerList = peers.length > 0 ? peers.map(p => `
                    <div class="peer-item">
                        <div class="peer-avatar">ğŸ‘¤</div>
                        <div>
                            <div>${p.name}</div>
                            <div class="peer-status"></div>
                        </div>
                        <div class="peer-actions">
                            <button class="peer-btn" onclick="os.mp.shareScreen()">ğŸ“º Share</button>
                            <button class="peer-btn">ğŸ’¬ Chat</button>
                        </div>
                    </div>
                `).join('') : '<div style="color:var(--text-dim);padding:20px">No peers connected</div>';

                content.innerHTML = `
                    <div class="multiplayer-panel">
                        <div style="margin-bottom:20px">
                            <div style="font-size:1.2rem;font-weight:600;margin-bottom:10px">ğŸŒ Multiplayer</div>
                            <div style="color:var(--text-dim);font-size:0.9rem">
                                Connect with others to share screens and collaborate in real-time.
                            </div>
                        </div>

                        <div style="display:flex;gap:10px;margin-bottom:20px">
                            <button class="peer-btn" style="flex:1;padding:12px;background:var(--accent);color:#000;font-weight:600"
                                    onclick="os.createRoom()">Create Room</button>
                            <button class="peer-btn" style="flex:1;padding:12px" onclick="os.joinRoom()">Join Room</button>
                        </div>

                        ${this.mp.roomCode ? `
                            <div style="background:rgba(0,212,255,0.1);padding:15px;border-radius:8px;margin-bottom:20px">
                                <div style="font-size:0.8rem;color:var(--text-dim)">Room Code</div>
                                <div style="font-size:1.5rem;font-weight:600;letter-spacing:0.3em">${this.mp.roomCode}</div>
                            </div>
                        ` : ''}

                        <div class="peer-list">
                            <div style="font-size:0.9rem;font-weight:600;margin-bottom:10px">Connected Peers</div>
                            ${peerList}
                        </div>
                    </div>
                `;
            }

            createRoom() {
                this.mp.createRoom();
                this.openMultiplayer(this.pm.spawn('Multiplayer', 'ğŸŒ'));
            }

            joinRoom() {
                const code = prompt('Enter room code:');
                if (code) {
                    this.mp.joinRoom(code.toUpperCase());
                }
            }

            openCalculator(pid) {
                const { content } = this.wm.create({
                    title: 'Calculator',
                    icon: 'ğŸ”¢',
                    pid,
                    width: 320,
                    height: 420
                });

                content.innerHTML = `
                    <div style="padding:15px;height:100%;display:flex;flex-direction:column">
                        <input id="calc-display" style="width:100%;padding:20px;font-size:2rem;text-align:right;background:rgba(0,0,0,0.3);border:none;border-radius:8px;color:var(--text);margin-bottom:15px" readonly value="0">
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;flex:1">
                            ${['C','Â±','%','Ã·','7','8','9','Ã—','4','5','6','-','1','2','3','+','0','0','.','='].map(b =>
                                `<button onclick="os.calcBtn('${b}')" style="border:none;border-radius:8px;font-size:1.2rem;cursor:pointer;background:${
                                    'Ã·Ã—-+='.includes(b) ? 'var(--accent)' :
                                    'CÂ±%'.includes(b) ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.1)'
                                };color:${'Ã·Ã—-+='.includes(b) ? '#000' : 'var(--text)'}">${b}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;

                this.calcValue = '0';
                this.calcOp = null;
                this.calcPrev = null;
            }

            calcBtn(b) {
                const display = document.getElementById('calc-display');
                if ('0123456789'.includes(b)) {
                    this.calcValue = this.calcValue === '0' ? b : this.calcValue + b;
                } else if (b === '.') {
                    if (!this.calcValue.includes('.')) this.calcValue += '.';
                } else if (b === 'C') {
                    this.calcValue = '0';
                    this.calcOp = null;
                    this.calcPrev = null;
                } else if (b === 'Â±') {
                    this.calcValue = String(-parseFloat(this.calcValue));
                } else if (b === '%') {
                    this.calcValue = String(parseFloat(this.calcValue) / 100);
                } else if ('Ã·Ã—-+'.includes(b)) {
                    this.calcPrev = parseFloat(this.calcValue);
                    this.calcOp = b;
                    this.calcValue = '0';
                } else if (b === '=') {
                    const curr = parseFloat(this.calcValue);
                    let result;
                    switch (this.calcOp) {
                        case '+': result = this.calcPrev + curr; break;
                        case '-': result = this.calcPrev - curr; break;
                        case 'Ã—': result = this.calcPrev * curr; break;
                        case 'Ã·': result = this.calcPrev / curr; break;
                        default: result = curr;
                    }
                    this.calcValue = String(result);
                    this.calcOp = null;
                }
                display.value = this.calcValue;
            }

            openNotes(pid) {
                const { content } = this.wm.create({
                    title: 'Notes',
                    icon: 'ğŸ“’',
                    pid,
                    width: 400,
                    height: 500
                });

                const notes = JSON.parse(localStorage.getItem('cloudos-notes') || '[]');

                content.innerHTML = `
                    <div style="height:100%;display:flex;flex-direction:column">
                        <div style="padding:10px;background:rgba(0,0,0,0.2);border-bottom:1px solid var(--border)">
                            <button onclick="os.addNote()" style="padding:8px 16px;background:var(--accent);border:none;border-radius:6px;color:#000;cursor:pointer">+ New Note</button>
                        </div>
                        <div id="notes-list" style="flex:1;overflow-y:auto;padding:10px">
                            ${notes.map((n, i) => `
                                <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:8px;margin-bottom:10px;cursor:pointer" onclick="os.editNote(${i})">
                                    <div style="font-weight:600;margin-bottom:5px">${n.title || 'Untitled'}</div>
                                    <div style="font-size:0.8rem;color:var(--text-dim)">${n.content.slice(0, 50)}...</div>
                                </div>
                            `).join('') || '<div style="color:var(--text-dim);padding:20px;text-align:center">No notes yet</div>'}
                        </div>
                    </div>
                `;
            }

            addNote() {
                const notes = JSON.parse(localStorage.getItem('cloudos-notes') || '[]');
                notes.push({ title: 'New Note', content: '', created: Date.now() });
                localStorage.setItem('cloudos-notes', JSON.stringify(notes));
                this.openNotes(this.pm.spawn('Notes', 'ğŸ“’'));
            }

            editNote(index) {
                const notes = JSON.parse(localStorage.getItem('cloudos-notes') || '[]');
                const note = notes[index];
                if (note) {
                    const content = prompt('Edit note:', note.content);
                    if (content !== null) {
                        notes[index].content = content;
                        localStorage.setItem('cloudos-notes', JSON.stringify(notes));
                    }
                }
            }

            openBrowser(pid) {
                const { content } = this.wm.create({
                    title: 'Web Browser',
                    icon: 'ğŸŒ',
                    pid,
                    width: 900,
                    height: 600
                });

                content.innerHTML = `
                    <div style="height:100%;display:flex;flex-direction:column">
                        <div style="display:flex;gap:8px;padding:8px;background:rgba(0,0,0,0.2);border-bottom:1px solid var(--border)">
                            <button style="padding:6px 12px;background:rgba(255,255,255,0.1);border:none;border-radius:4px;color:var(--text);cursor:pointer">â—€</button>
                            <button style="padding:6px 12px;background:rgba(255,255,255,0.1);border:none;border-radius:4px;color:var(--text);cursor:pointer">â–¶</button>
                            <button style="padding:6px 12px;background:rgba(255,255,255,0.1);border:none;border-radius:4px;color:var(--text);cursor:pointer">â†»</button>
                            <input id="browser-url" style="flex:1;padding:8px 12px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:6px;color:var(--text)" placeholder="Enter URL..." value="https://example.com">
                            <button onclick="os.browserGo()" style="padding:6px 12px;background:var(--accent);border:none;border-radius:4px;color:#000;cursor:pointer">Go</button>
                        </div>
                        <div style="flex:1;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.2)">
                            <div style="text-align:center;color:var(--text-dim)">
                                <div style="font-size:4rem;margin-bottom:20px">ğŸŒ</div>
                                <div style="font-size:1.2rem">Browser Sandbox</div>
                                <div style="font-size:0.9rem;margin-top:10px">For security, external sites cannot be loaded in iframes.</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            browserGo() {
                const url = document.getElementById('browser-url')?.value;
                if (url) {
                    this.notify('Browser', `Cannot navigate to ${url} (sandbox mode)`);
                }
            }

            openGenericApp(app, pid) {
                const { content } = this.wm.create({
                    title: app.name,
                    icon: app.icon,
                    pid,
                    width: 500,
                    height: 400
                });

                content.innerHTML = `
                    <div style="height:100%;display:flex;align-items:center;justify-content:center">
                        <div style="text-align:center">
                            <div style="font-size:4rem;margin-bottom:20px">${app.icon}</div>
                            <div style="font-size:1.2rem">${app.name}</div>
                            <div style="font-size:0.9rem;color:var(--text-dim);margin-top:10px">App coming soon...</div>
                        </div>
                    </div>
                `;
            }

            notify(title, body) {
                const container = document.getElementById('notifications');
                const notif = document.createElement('div');
                notif.className = 'notification';
                notif.innerHTML = `
                    <div class="notification-title">${title}</div>
                    <div class="notification-body">${body}</div>
                `;
                container.appendChild(notif);
                setTimeout(() => notif.remove(), 5000);
            }

            shutdown() {
                if (confirm('Shutdown CloudOS?')) {
                    document.body.innerHTML = '<div style="height:100vh;display:flex;align-items:center;justify-content:center;background:#000;color:#fff;font-size:1.5rem">CloudOS has shut down. Refresh to restart.</div>';
                }
            }
        }

        // Initialize OS
        const os = new CloudOS();
        os.boot();
    </script>
</body>
</html>
