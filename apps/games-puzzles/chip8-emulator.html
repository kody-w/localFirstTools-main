<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHIP-8 Retro Emulator Hub - Full CPU Emulation with Debugger</title>
    <meta name="description" content="Complete CHIP-8 emulator with CRT effects, debugger, save states, rewind, and built-in game library">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="color-scheme" content="dark">
    <!-- emulator, chip8, retro, gaming, wasm, cpu, debugger -->
    <style>
        :root {
            --bg: #0a0a0f;
            --surface: #12121a;
            --surface-light: #1a1a25;
            --accent: #00ff88;
            --accent-dim: #00aa55;
            --secondary: #ff6b35;
            --purple: #9d4edd;
            --cyan: #00d4ff;
            --text: #e0e0e0;
            --text-dim: #666680;
            --crt-green: #33ff66;
            --crt-amber: #ffaa00;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(180deg, var(--surface) 0%, transparent 100%);
            border-bottom: 1px solid var(--accent-dim);
        }

        h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--accent), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }

        .emulator-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* CRT Display */
        .crt-container {
            position: relative;
            background: #000;
            border-radius: 20px;
            padding: 20px;
            box-shadow:
                0 0 0 3px #222,
                0 0 0 6px #111,
                inset 0 0 50px rgba(0, 255, 136, 0.1),
                0 0 100px rgba(0, 255, 136, 0.2);
        }

        .crt-bezel {
            position: relative;
            background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #333;
        }

        .crt-screen {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            background: #000;
        }

        #display {
            display: block;
            width: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background: #000;
        }

        /* CRT Effects Overlay */
        .crt-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            border-radius: 10px;
        }

        .scanlines {
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15) 0px,
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
        }

        .screen-curve {
            background: radial-gradient(
                ellipse at center,
                transparent 0%,
                transparent 70%,
                rgba(0, 0, 0, 0.3) 100%
            );
        }

        .phosphor-glow {
            box-shadow: inset 0 0 60px rgba(0, 255, 136, 0.1);
        }

        /* Controls Bar */
        .controls-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 15px;
            background: var(--surface);
            border-radius: 10px;
            border: 1px solid var(--surface-light);
        }

        button {
            background: var(--surface-light);
            color: var(--text);
            border: 1px solid var(--text-dim);
            padding: 8px 16px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button:hover:not(:disabled) {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: #000;
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        button.primary {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        button.danger { background: #ff4444; border-color: #ff4444; color: #fff; }
        button.warning { background: var(--secondary); border-color: var(--secondary); color: #000; }

        .status-display {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.75rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
        }

        .status-led.running { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .status-led.paused { background: var(--secondary); }

        /* ROM Library */
        .rom-library {
            background: var(--surface);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--surface-light);
        }

        .rom-library h3 {
            font-size: 0.9rem;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rom-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }

        .rom-card {
            background: var(--bg);
            border: 1px solid var(--surface-light);
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .rom-card:hover {
            border-color: var(--accent);
            background: var(--surface-light);
        }

        .rom-card.active {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .rom-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .rom-name {
            font-size: 0.7rem;
            color: var(--text);
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background: var(--surface);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid var(--surface-light);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--surface-light);
        }

        .panel-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--cyan);
        }

        /* Registers Panel */
        .registers-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            font-size: 0.7rem;
        }

        .register {
            background: var(--bg);
            padding: 4px 6px;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
        }

        .reg-name { color: var(--accent); }
        .reg-value { color: var(--text); font-family: inherit; }

        .special-regs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            margin-top: 8px;
            font-size: 0.7rem;
        }

        .special-reg {
            background: var(--bg);
            padding: 6px;
            border-radius: 3px;
        }

        .special-reg .reg-name { color: var(--purple); }

        /* Stack Panel */
        .stack-display {
            font-size: 0.65rem;
            max-height: 100px;
            overflow-y: auto;
        }

        .stack-entry {
            display: flex;
            justify-content: space-between;
            padding: 2px 4px;
            background: var(--bg);
            margin-bottom: 2px;
            border-radius: 2px;
        }

        .stack-entry.current { background: var(--accent-dim); color: #000; }

        /* Memory Panel */
        .memory-display {
            font-size: 0.6rem;
            max-height: 150px;
            overflow-y: auto;
            background: var(--bg);
            padding: 6px;
            border-radius: 4px;
        }

        .memory-row {
            display: flex;
            gap: 8px;
            line-height: 1.4;
        }

        .memory-addr { color: var(--purple); min-width: 40px; }
        .memory-bytes { color: var(--text-dim); }
        .memory-byte.highlight { color: var(--accent); font-weight: bold; }

        /* Disassembly Panel */
        .disasm-display {
            font-size: 0.65rem;
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg);
            padding: 6px;
            border-radius: 4px;
        }

        .disasm-line {
            display: flex;
            gap: 10px;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .disasm-line.current {
            background: var(--accent);
            color: #000;
        }

        .disasm-addr { color: var(--purple); min-width: 45px; }
        .disasm-bytes { color: var(--text-dim); min-width: 50px; }
        .disasm-instr { color: var(--cyan); min-width: 50px; }
        .disasm-args { color: var(--text); }

        /* Keypad */
        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }

        .key {
            aspect-ratio: 1;
            background: var(--bg);
            border: 1px solid var(--surface-light);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.1s;
        }

        .key:hover { border-color: var(--accent); }
        .key.pressed {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }

        .key-label {
            font-size: 0.5rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        /* Save States */
        .save-states {
            display: flex;
            gap: 6px;
        }

        .save-slot {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--surface-light);
            border-radius: 4px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .save-slot:hover { border-color: var(--accent); }
        .save-slot.filled { border-color: var(--purple); }
        .save-slot.filled .slot-status { color: var(--purple); }

        .slot-number { font-weight: bold; color: var(--text); }
        .slot-status { font-size: 0.6rem; color: var(--text-dim); margin-top: 4px; }

        /* Rewind Bar */
        .rewind-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rewind-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: var(--bg);
            border-radius: 3px;
            outline: none;
        }

        .rewind-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .rewind-info {
            font-size: 0.7rem;
            color: var(--text-dim);
            min-width: 80px;
        }

        /* Settings */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 0.75rem;
        }

        .setting-row label { color: var(--text-dim); }

        select {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--surface-light);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.75rem;
        }

        input[type="checkbox"] {
            accent-color: var(--accent);
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--surface-light);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: var(--text-dim);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent);
            background: rgba(0, 255, 136, 0.05);
        }

        @media (max-width: 1000px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Sound indicator */
        .sound-wave {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin-left: 5px;
        }

        .sound-bar {
            width: 3px;
            background: var(--accent);
            animation: soundPulse 0.3s ease-in-out infinite alternate;
        }

        .sound-bar:nth-child(1) { height: 8px; animation-delay: 0s; }
        .sound-bar:nth-child(2) { height: 12px; animation-delay: 0.1s; }
        .sound-bar:nth-child(3) { height: 6px; animation-delay: 0.2s; }

        @keyframes soundPulse {
            from { opacity: 0.3; }
            to { opacity: 1; }
        }

        .sound-wave.muted .sound-bar {
            background: var(--text-dim);
            animation: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CHIP-8 Retro Emulator Hub</h1>
            <p class="subtitle">Full CPU Emulation | Live Debugger | Save States | Rewind | CRT Effects</p>
        </header>

        <div class="main-layout">
            <div class="emulator-section">
                <!-- CRT Display -->
                <div class="crt-container">
                    <div class="crt-bezel">
                        <div class="crt-screen">
                            <canvas id="display" width="640" height="320"></canvas>
                            <div class="crt-overlay scanlines" id="scanlinesOverlay"></div>
                            <div class="crt-overlay screen-curve" id="curveOverlay"></div>
                            <div class="crt-overlay phosphor-glow" id="glowOverlay"></div>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="controls-bar">
                    <button class="primary" id="playBtn" onclick="togglePlay()">
                        <span id="playIcon">â–¶</span> <span id="playText">Run</span>
                    </button>
                    <button id="stepBtn" onclick="step()">â­ Step</button>
                    <button id="resetBtn" onclick="reset()">â†º Reset</button>
                    <button class="warning" id="rewindBtn" onclick="toggleRewind()">âª Rewind</button>

                    <div class="status-display">
                        <div class="status-item">
                            <div class="status-led" id="statusLed"></div>
                            <span id="statusText">Stopped</span>
                        </div>
                        <div class="status-item">
                            <span>PC:</span>
                            <span id="pcDisplay">0x200</span>
                        </div>
                        <div class="status-item">
                            <span>Cycles:</span>
                            <span id="cyclesDisplay">0</span>
                        </div>
                        <div class="status-item">
                            <span id="soundIndicator" class="sound-wave muted">
                                <div class="sound-bar"></div>
                                <div class="sound-bar"></div>
                                <div class="sound-bar"></div>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- ROM Library -->
                <div class="rom-library">
                    <h3>ğŸ“š Built-in Games</h3>
                    <div class="rom-grid" id="romGrid"></div>
                    <div class="drop-zone" id="dropZone" onclick="document.getElementById('romInput').click()">
                        Drop ROM file here or click to upload
                        <input type="file" id="romInput" accept=".ch8,.c8,.rom" style="display:none" onchange="loadROMFile(event)">
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Registers -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">CPU Registers</span>
                    </div>
                    <div class="registers-grid" id="registersGrid"></div>
                    <div class="special-regs" id="specialRegs"></div>
                </div>

                <!-- Stack -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Stack</span>
                        <span style="font-size:0.7rem;color:var(--text-dim)" id="stackPointer">SP: 0</span>
                    </div>
                    <div class="stack-display" id="stackDisplay"></div>
                </div>

                <!-- Disassembly -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Disassembly</span>
                    </div>
                    <div class="disasm-display" id="disasmDisplay"></div>
                </div>

                <!-- Keypad -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Keypad</span>
                    </div>
                    <div class="keypad" id="keypad"></div>
                </div>

                <!-- Save States -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Save States</span>
                    </div>
                    <div class="save-states" id="saveStates"></div>
                    <div class="rewind-bar" style="margin-top:10px">
                        <span style="font-size:0.7rem">âª</span>
                        <input type="range" class="rewind-slider" id="rewindSlider" min="0" max="100" value="100">
                        <span class="rewind-info" id="rewindInfo">Live</span>
                    </div>
                </div>

                <!-- Settings -->
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">Settings</span>
                    </div>
                    <div class="setting-row">
                        <label>Clock Speed</label>
                        <select id="clockSpeed" onchange="setClockSpeed(this.value)">
                            <option value="200">200 Hz</option>
                            <option value="500" selected>500 Hz</option>
                            <option value="1000">1000 Hz</option>
                            <option value="2000">2000 Hz</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label>Display Color</label>
                        <select id="displayColor" onchange="setDisplayColor(this.value)">
                            <option value="#33ff66">Green</option>
                            <option value="#ffaa00">Amber</option>
                            <option value="#ffffff">White</option>
                            <option value="#00d4ff">Cyan</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label>Scanlines</label>
                        <input type="checkbox" id="scanlinesToggle" checked onchange="toggleScanlines()">
                    </div>
                    <div class="setting-row">
                        <label>Screen Curve</label>
                        <input type="checkbox" id="curveToggle" checked onchange="toggleCurve()">
                    </div>
                    <div class="setting-row">
                        <label>Sound</label>
                        <input type="checkbox" id="soundToggle" checked onchange="toggleSound()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHIP-8 EMULATOR CORE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        class Chip8 {
            constructor() {
                this.reset();
            }

            reset() {
                // Memory: 4KB
                this.memory = new Uint8Array(4096);

                // Registers: V0-VF (16 8-bit registers)
                this.V = new Uint8Array(16);

                // Index register (16-bit)
                this.I = 0;

                // Program counter (starts at 0x200)
                this.PC = 0x200;

                // Stack (16 levels)
                this.stack = new Uint16Array(16);
                this.SP = 0;

                // Timers (60Hz)
                this.delayTimer = 0;
                this.soundTimer = 0;

                // Display: 64x32 pixels
                this.display = new Uint8Array(64 * 32);

                // Keypad: 16 keys (0x0-0xF)
                this.keys = new Uint8Array(16);

                // Flags
                this.drawFlag = false;
                this.waitingForKey = false;
                this.keyRegister = 0;

                // Cycle counter
                this.cycles = 0;

                // Load fontset into memory (0x000-0x1FF)
                this.loadFontset();
            }

            loadFontset() {
                const fontset = [
                    0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
                    0x20, 0x60, 0x20, 0x20, 0x70, // 1
                    0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
                    0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
                    0x90, 0x90, 0xF0, 0x10, 0x10, // 4
                    0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
                    0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
                    0xF0, 0x10, 0x20, 0x40, 0x40, // 7
                    0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
                    0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
                    0xF0, 0x90, 0xF0, 0x90, 0x90, // A
                    0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
                    0xF0, 0x80, 0x80, 0x80, 0xF0, // C
                    0xE0, 0x90, 0x90, 0x90, 0xE0, // D
                    0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
                    0xF0, 0x80, 0xF0, 0x80, 0x80  // F
                ];
                for (let i = 0; i < fontset.length; i++) {
                    this.memory[i] = fontset[i];
                }
            }

            loadROM(data) {
                this.reset();
                for (let i = 0; i < data.length; i++) {
                    this.memory[0x200 + i] = data[i];
                }
            }

            cycle() {
                if (this.waitingForKey) return;

                // Fetch opcode (2 bytes)
                const opcode = (this.memory[this.PC] << 8) | this.memory[this.PC + 1];
                this.PC += 2;
                this.cycles++;

                // Decode and execute
                this.execute(opcode);
            }

            execute(opcode) {
                const x = (opcode & 0x0F00) >> 8;
                const y = (opcode & 0x00F0) >> 4;
                const n = opcode & 0x000F;
                const nn = opcode & 0x00FF;
                const nnn = opcode & 0x0FFF;

                switch (opcode & 0xF000) {
                    case 0x0000:
                        switch (opcode) {
                            case 0x00E0: // CLS - Clear display
                                this.display.fill(0);
                                this.drawFlag = true;
                                break;
                            case 0x00EE: // RET - Return from subroutine
                                this.SP--;
                                this.PC = this.stack[this.SP];
                                break;
                        }
                        break;

                    case 0x1000: // JP addr - Jump to address
                        this.PC = nnn;
                        break;

                    case 0x2000: // CALL addr - Call subroutine
                        this.stack[this.SP] = this.PC;
                        this.SP++;
                        this.PC = nnn;
                        break;

                    case 0x3000: // SE Vx, byte - Skip if Vx == nn
                        if (this.V[x] === nn) this.PC += 2;
                        break;

                    case 0x4000: // SNE Vx, byte - Skip if Vx != nn
                        if (this.V[x] !== nn) this.PC += 2;
                        break;

                    case 0x5000: // SE Vx, Vy - Skip if Vx == Vy
                        if (this.V[x] === this.V[y]) this.PC += 2;
                        break;

                    case 0x6000: // LD Vx, byte - Load nn into Vx
                        this.V[x] = nn;
                        break;

                    case 0x7000: // ADD Vx, byte - Add nn to Vx
                        this.V[x] = (this.V[x] + nn) & 0xFF;
                        break;

                    case 0x8000:
                        switch (n) {
                            case 0x0: // LD Vx, Vy
                                this.V[x] = this.V[y];
                                break;
                            case 0x1: // OR Vx, Vy
                                this.V[x] |= this.V[y];
                                this.V[0xF] = 0; // Quirk
                                break;
                            case 0x2: // AND Vx, Vy
                                this.V[x] &= this.V[y];
                                this.V[0xF] = 0; // Quirk
                                break;
                            case 0x3: // XOR Vx, Vy
                                this.V[x] ^= this.V[y];
                                this.V[0xF] = 0; // Quirk
                                break;
                            case 0x4: // ADD Vx, Vy with carry
                                const sum = this.V[x] + this.V[y];
                                this.V[x] = sum & 0xFF;
                                this.V[0xF] = sum > 255 ? 1 : 0;
                                break;
                            case 0x5: // SUB Vx, Vy with borrow
                                const vf5 = this.V[x] >= this.V[y] ? 1 : 0;
                                this.V[x] = (this.V[x] - this.V[y]) & 0xFF;
                                this.V[0xF] = vf5;
                                break;
                            case 0x6: // SHR Vx
                                const lsb = this.V[x] & 1;
                                this.V[x] >>= 1;
                                this.V[0xF] = lsb;
                                break;
                            case 0x7: // SUBN Vx, Vy
                                const vf7 = this.V[y] >= this.V[x] ? 1 : 0;
                                this.V[x] = (this.V[y] - this.V[x]) & 0xFF;
                                this.V[0xF] = vf7;
                                break;
                            case 0xE: // SHL Vx
                                const msb = (this.V[x] >> 7) & 1;
                                this.V[x] = (this.V[x] << 1) & 0xFF;
                                this.V[0xF] = msb;
                                break;
                        }
                        break;

                    case 0x9000: // SNE Vx, Vy - Skip if Vx != Vy
                        if (this.V[x] !== this.V[y]) this.PC += 2;
                        break;

                    case 0xA000: // LD I, addr
                        this.I = nnn;
                        break;

                    case 0xB000: // JP V0, addr
                        this.PC = nnn + this.V[0];
                        break;

                    case 0xC000: // RND Vx, byte
                        this.V[x] = Math.floor(Math.random() * 256) & nn;
                        break;

                    case 0xD000: // DRW Vx, Vy, n - Draw sprite
                        const xPos = this.V[x] % 64;
                        const yPos = this.V[y] % 32;
                        this.V[0xF] = 0;

                        for (let row = 0; row < n; row++) {
                            const spriteByte = this.memory[this.I + row];
                            for (let col = 0; col < 8; col++) {
                                if ((spriteByte & (0x80 >> col)) !== 0) {
                                    const px = (xPos + col) % 64;
                                    const py = (yPos + row) % 32;
                                    const idx = py * 64 + px;
                                    if (this.display[idx] === 1) {
                                        this.V[0xF] = 1;
                                    }
                                    this.display[idx] ^= 1;
                                }
                            }
                        }
                        this.drawFlag = true;
                        break;

                    case 0xE000:
                        switch (nn) {
                            case 0x9E: // SKP Vx - Skip if key pressed
                                if (this.keys[this.V[x] & 0xF]) this.PC += 2;
                                break;
                            case 0xA1: // SKNP Vx - Skip if key not pressed
                                if (!this.keys[this.V[x] & 0xF]) this.PC += 2;
                                break;
                        }
                        break;

                    case 0xF000:
                        switch (nn) {
                            case 0x07: // LD Vx, DT
                                this.V[x] = this.delayTimer;
                                break;
                            case 0x0A: // LD Vx, K - Wait for key
                                this.waitingForKey = true;
                                this.keyRegister = x;
                                break;
                            case 0x15: // LD DT, Vx
                                this.delayTimer = this.V[x];
                                break;
                            case 0x18: // LD ST, Vx
                                this.soundTimer = this.V[x];
                                break;
                            case 0x1E: // ADD I, Vx
                                this.I = (this.I + this.V[x]) & 0xFFF;
                                break;
                            case 0x29: // LD F, Vx - Font sprite location
                                this.I = (this.V[x] & 0xF) * 5;
                                break;
                            case 0x33: // LD B, Vx - BCD
                                this.memory[this.I] = Math.floor(this.V[x] / 100);
                                this.memory[this.I + 1] = Math.floor((this.V[x] / 10) % 10);
                                this.memory[this.I + 2] = this.V[x] % 10;
                                break;
                            case 0x55: // LD [I], Vx - Store registers
                                for (let i = 0; i <= x; i++) {
                                    this.memory[this.I + i] = this.V[i];
                                }
                                break;
                            case 0x65: // LD Vx, [I] - Load registers
                                for (let i = 0; i <= x; i++) {
                                    this.V[i] = this.memory[this.I + i];
                                }
                                break;
                        }
                        break;
                }
            }

            updateTimers() {
                if (this.delayTimer > 0) this.delayTimer--;
                if (this.soundTimer > 0) this.soundTimer--;
            }

            keyDown(key) {
                this.keys[key] = 1;
                if (this.waitingForKey) {
                    this.V[this.keyRegister] = key;
                    this.waitingForKey = false;
                }
            }

            keyUp(key) {
                this.keys[key] = 0;
            }

            getState() {
                return {
                    memory: new Uint8Array(this.memory),
                    V: new Uint8Array(this.V),
                    I: this.I,
                    PC: this.PC,
                    stack: new Uint16Array(this.stack),
                    SP: this.SP,
                    delayTimer: this.delayTimer,
                    soundTimer: this.soundTimer,
                    display: new Uint8Array(this.display),
                    cycles: this.cycles
                };
            }

            loadState(state) {
                this.memory = new Uint8Array(state.memory);
                this.V = new Uint8Array(state.V);
                this.I = state.I;
                this.PC = state.PC;
                this.stack = new Uint16Array(state.stack);
                this.SP = state.SP;
                this.delayTimer = state.delayTimer;
                this.soundTimer = state.soundTimer;
                this.display = new Uint8Array(state.display);
                this.cycles = state.cycles;
                this.drawFlag = true;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DISASSEMBLER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function disassemble(opcode) {
            const x = (opcode & 0x0F00) >> 8;
            const y = (opcode & 0x00F0) >> 4;
            const n = opcode & 0x000F;
            const nn = opcode & 0x00FF;
            const nnn = opcode & 0x0FFF;

            switch (opcode & 0xF000) {
                case 0x0000:
                    if (opcode === 0x00E0) return { instr: 'CLS', args: '' };
                    if (opcode === 0x00EE) return { instr: 'RET', args: '' };
                    return { instr: 'SYS', args: `${nnn.toString(16).toUpperCase()}` };
                case 0x1000: return { instr: 'JP', args: `${nnn.toString(16).toUpperCase()}` };
                case 0x2000: return { instr: 'CALL', args: `${nnn.toString(16).toUpperCase()}` };
                case 0x3000: return { instr: 'SE', args: `V${x.toString(16).toUpperCase()}, ${nn}` };
                case 0x4000: return { instr: 'SNE', args: `V${x.toString(16).toUpperCase()}, ${nn}` };
                case 0x5000: return { instr: 'SE', args: `V${x.toString(16).toUpperCase()}, V${y.toString(16).toUpperCase()}` };
                case 0x6000: return { instr: 'LD', args: `V${x.toString(16).toUpperCase()}, ${nn}` };
                case 0x7000: return { instr: 'ADD', args: `V${x.toString(16).toUpperCase()}, ${nn}` };
                case 0x8000:
                    switch (n) {
                        case 0: return { instr: 'LD', args: `V${x.toString(16).toUpperCase()}, V${y.toString(16).toUpperCase()}` };
                        case 1: return { instr: 'OR', args: `V${x.toString(16).toUpperCase()}, V${y.toString(16).toUpperCase()}` };
                        case 2: return { instr: 'AND', args: `V${x.toString(16).toUpperCase()}, V${y.toString(16).toUpperCase()}` };
                        case 3: return { instr: 'XOR', args: `V${x.toString(16).toUpperCase()}, V${y.toString(16).toUpperCase()}` };
                        case 4: return { instr: 'ADD', args: `V${x.toString(16).toUpperCase()}, V${y.toString(16).toUpperCase()}` };
                        case 5: return { instr: 'SUB', args: `V${x.toString(16).toUpperCase()}, V${y.toString(16).toUpperCase()}` };
                        case 6: return { instr: 'SHR', args: `V${x.toString(16).toUpperCase()}` };
                        case 7: return { instr: 'SUBN', args: `V${x.toString(16).toUpperCase()}, V${y.toString(16).toUpperCase()}` };
                        case 0xE: return { instr: 'SHL', args: `V${x.toString(16).toUpperCase()}` };
                    }
                    break;
                case 0x9000: return { instr: 'SNE', args: `V${x.toString(16).toUpperCase()}, V${y.toString(16).toUpperCase()}` };
                case 0xA000: return { instr: 'LD', args: `I, ${nnn.toString(16).toUpperCase()}` };
                case 0xB000: return { instr: 'JP', args: `V0, ${nnn.toString(16).toUpperCase()}` };
                case 0xC000: return { instr: 'RND', args: `V${x.toString(16).toUpperCase()}, ${nn}` };
                case 0xD000: return { instr: 'DRW', args: `V${x.toString(16).toUpperCase()}, V${y.toString(16).toUpperCase()}, ${n}` };
                case 0xE000:
                    if (nn === 0x9E) return { instr: 'SKP', args: `V${x.toString(16).toUpperCase()}` };
                    if (nn === 0xA1) return { instr: 'SKNP', args: `V${x.toString(16).toUpperCase()}` };
                    break;
                case 0xF000:
                    switch (nn) {
                        case 0x07: return { instr: 'LD', args: `V${x.toString(16).toUpperCase()}, DT` };
                        case 0x0A: return { instr: 'LD', args: `V${x.toString(16).toUpperCase()}, K` };
                        case 0x15: return { instr: 'LD', args: `DT, V${x.toString(16).toUpperCase()}` };
                        case 0x18: return { instr: 'LD', args: `ST, V${x.toString(16).toUpperCase()}` };
                        case 0x1E: return { instr: 'ADD', args: `I, V${x.toString(16).toUpperCase()}` };
                        case 0x29: return { instr: 'LD', args: `F, V${x.toString(16).toUpperCase()}` };
                        case 0x33: return { instr: 'LD', args: `B, V${x.toString(16).toUpperCase()}` };
                        case 0x55: return { instr: 'LD', args: `[I], V${x.toString(16).toUpperCase()}` };
                        case 0x65: return { instr: 'LD', args: `V${x.toString(16).toUpperCase()}, [I]` };
                    }
                    break;
            }
            return { instr: '???', args: opcode.toString(16).toUpperCase() };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // APPLICATION STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const chip8 = new Chip8();
        let running = false;
        let clockSpeed = 500;
        let displayColor = '#33ff66';
        let soundEnabled = true;
        let audioContext = null;
        let oscillator = null;

        // Rewind system
        const rewindBuffer = [];
        const maxRewindFrames = 300; // ~5 seconds at 60fps
        let rewindMode = false;

        // Save states
        const saveStates = [null, null, null, null];

        // Canvas
        const canvas = document.getElementById('display');
        const ctx = canvas.getContext('2d');

        // Keyboard mapping
        const keyMap = {
            '1': 0x1, '2': 0x2, '3': 0x3, '4': 0xC,
            'q': 0x4, 'w': 0x5, 'e': 0x6, 'r': 0xD,
            'a': 0x7, 's': 0x8, 'd': 0x9, 'f': 0xE,
            'z': 0xA, 'x': 0x0, 'c': 0xB, 'v': 0xF
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BUILT-IN ROM LIBRARY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const builtInROMs = {
            'Maze': {
                icon: 'ğŸŒ€',
                description: 'Random maze generator',
                data: [0x60, 0x00, 0x61, 0x00, 0xA2, 0x22, 0xC2, 0x01, 0x32, 0x01, 0xA2, 0x1E, 0xD0, 0x14, 0x70, 0x04, 0x30, 0x40, 0x12, 0x04, 0x60, 0x00, 0x71, 0x04, 0x31, 0x20, 0x12, 0x04, 0x12, 0x1C, 0x80, 0x40, 0x20, 0x10, 0x20, 0x40, 0x80, 0x10]
            },
            'Pong': {
                icon: 'ğŸ“',
                description: 'Classic Pong game (1P)',
                data: [0x6A, 0x02, 0x6B, 0x0C, 0x6C, 0x3F, 0x6D, 0x0C, 0xA2, 0xEA, 0xDA, 0xB6, 0xDC, 0xD6, 0x6E, 0x00, 0x22, 0xD4, 0x66, 0x03, 0x68, 0x02, 0x60, 0x60, 0xF0, 0x15, 0xF0, 0x07, 0x30, 0x00, 0x12, 0x1A, 0xC7, 0x17, 0x77, 0x08, 0x69, 0xFF, 0xA2, 0xF0, 0xD6, 0x71, 0xA2, 0xEA, 0xDA, 0xB6, 0xDC, 0xD6, 0x60, 0x01, 0xE0, 0xA1, 0x7B, 0xFE, 0x60, 0x04, 0xE0, 0xA1, 0x7B, 0x02, 0x60, 0x1F, 0x8B, 0x02, 0xDA, 0xB6, 0x60, 0x0C, 0xE0, 0xA1, 0x7D, 0xFE, 0x60, 0x0D, 0xE0, 0xA1, 0x7D, 0x02, 0x60, 0x1F, 0x8D, 0x02, 0xDC, 0xD6, 0xA2, 0xF0, 0xD6, 0x71, 0x86, 0x84, 0x87, 0x94, 0x60, 0x3F, 0x86, 0x02, 0x61, 0x1F, 0x87, 0x12, 0x46, 0x02, 0x12, 0x78, 0x46, 0x3F, 0x12, 0x82, 0x47, 0x1F, 0x69, 0xFF, 0x47, 0x00, 0x69, 0x01, 0xD6, 0x71, 0x12, 0x2A, 0x68, 0x02, 0x63, 0x01, 0x80, 0x70, 0x80, 0xB5, 0x12, 0x8A, 0x68, 0xFE, 0x63, 0x0A, 0x80, 0x70, 0x80, 0xD5, 0x3F, 0x01, 0x12, 0xA2, 0x61, 0x02, 0x80, 0x15, 0x3F, 0x01, 0x12, 0xBA, 0x80, 0x15, 0x3F, 0x01, 0x12, 0xC8, 0x80, 0x15, 0x3F, 0x01, 0x12, 0xC2, 0x60, 0x20, 0xF0, 0x18, 0x22, 0xD4, 0x8E, 0x34, 0x22, 0xD4, 0x66, 0x3E, 0x33, 0x01, 0x66, 0x03, 0x68, 0xFE, 0x33, 0x01, 0x68, 0x02, 0x12, 0x16, 0x79, 0xFF, 0x49, 0xFE, 0x69, 0xFF, 0x12, 0xC8, 0x79, 0x01, 0x49, 0x02, 0x69, 0x01, 0x60, 0x04, 0xF0, 0x18, 0x76, 0x01, 0x46, 0x40, 0x76, 0xFE, 0x12, 0x6C, 0xA2, 0xF2, 0xFE, 0x33, 0xF2, 0x65, 0xF1, 0x29, 0x64, 0x14, 0x65, 0x02, 0xD4, 0x55, 0x74, 0x15, 0xF2, 0x29, 0xD4, 0x55, 0x00, 0xEE, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00]
            },
            'Tetris': {
                icon: 'ğŸ§±',
                description: 'Simple Tetris clone',
                data: [0xA2, 0xB4, 0x23, 0xE6, 0x22, 0xB6, 0x70, 0x01, 0xD0, 0x11, 0x30, 0x25, 0x12, 0x06, 0x71, 0xFF, 0xD0, 0x11, 0x60, 0x1A, 0xD0, 0x11, 0x60, 0x25, 0x31, 0x00, 0x12, 0x0E, 0xC4, 0x70, 0x44, 0x70, 0x12, 0x06, 0x00, 0xE0, 0x6E, 0x05, 0x65, 0x00, 0x6B, 0x06, 0x6A, 0x00, 0x6D, 0x01, 0xA2, 0xA6, 0x60, 0x0B, 0xF0, 0x1E, 0xF0, 0x65, 0x30, 0x00, 0x12, 0x4C, 0x31, 0x00, 0x12, 0x58, 0x71, 0x01, 0x12, 0x2C, 0x61, 0x04, 0x23, 0x90, 0x45, 0x60, 0x12, 0x40, 0x7A, 0xFF, 0x4A, 0x06, 0x6A, 0x06, 0x12, 0x40, 0x7A, 0x01, 0x12, 0x40, 0x00, 0xE0, 0xA2, 0xA4, 0x60, 0x19, 0x6C, 0x10, 0xDC, 0x01, 0x70, 0x04, 0x3C, 0x00, 0x12, 0x60, 0x23, 0x90, 0x12, 0x26, 0xC6, 0x07, 0x76, 0xA4, 0xF6, 0x1E, 0xF0, 0x65, 0xA3, 0x00, 0xF5, 0x55, 0x6D, 0xFF, 0x12, 0x2C, 0xA2, 0xA6, 0x8F, 0xB0, 0xF0, 0x1E, 0xDA, 0xB1, 0x00, 0xEE, 0x6F, 0x00, 0x6E, 0x04, 0x7E, 0xFF, 0x3E, 0xFF, 0x00, 0xEE, 0xA3, 0x00, 0xFE, 0x65, 0x60, 0x01, 0x80, 0xE4, 0xA3, 0x00, 0xF0, 0x55, 0x12, 0x74, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0xC0, 0x80, 0x80, 0x00, 0x40, 0xC0, 0x40, 0x00, 0x80, 0xC0, 0x80, 0x00, 0xC0, 0x40, 0x40, 0x00, 0x80, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x10, 0xF0, 0x80, 0xF0]
            },
            'Breakout': {
                icon: 'ğŸ§±',
                description: 'Breakout arcade game',
                data: [0x6E, 0x05, 0x65, 0x00, 0x6B, 0x06, 0x6A, 0x00, 0xA2, 0xD2, 0x60, 0x1F, 0x61, 0x01, 0xD0, 0x12, 0x70, 0x04, 0x30, 0x3F, 0x12, 0x10, 0x60, 0x00, 0x71, 0x02, 0xD0, 0x12, 0x31, 0x1D, 0x12, 0x08, 0x6A, 0x00, 0x6B, 0x20, 0x6C, 0x1F, 0x6D, 0x04, 0xA2, 0xD0, 0xDA, 0xB1, 0xA2, 0xD4, 0xDC, 0xD1, 0x22, 0xCA, 0xA2, 0xD0, 0xDA, 0xB1, 0x83, 0xD4, 0x73, 0x01, 0x43, 0x02, 0x63, 0xFE, 0x82, 0xC4, 0x72, 0x01, 0x42, 0x02, 0x62, 0xFE, 0x8A, 0x34, 0x8B, 0x24, 0x4A, 0x00, 0x12, 0xA8, 0x4B, 0x20, 0x12, 0xA8, 0x4B, 0x00, 0x12, 0xA8, 0xA2, 0xD4, 0xDC, 0xD1, 0x3F, 0x00, 0x12, 0x40, 0x60, 0x0A, 0xF0, 0x15, 0xF0, 0x07, 0x30, 0x00, 0x12, 0x6E, 0x7C, 0x01, 0x4C, 0x40, 0x7C, 0xFE, 0x60, 0x07, 0xE0, 0x9E, 0x12, 0x8E, 0x60, 0x09, 0xE0, 0x9E, 0x12, 0x98, 0x12, 0xA0, 0xA2, 0xD4, 0xDC, 0xD1, 0x7C, 0xFE, 0xDC, 0xD1, 0x12, 0xA0, 0xA2, 0xD4, 0xDC, 0xD1, 0x7C, 0x02, 0xDC, 0xD1, 0x12, 0x40, 0x6D, 0xFC, 0x12, 0x40, 0x12, 0x2E, 0x00, 0xE0, 0xA2, 0xD6, 0x6C, 0x19, 0xDC, 0xA5, 0x00, 0xEE, 0x00, 0x00, 0xFF, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x3C, 0x24, 0x24, 0x24, 0x3C]
            },
            'Invaders': {
                icon: 'ğŸ‘¾',
                description: 'Space Invaders',
                data: [0x12, 0x26, 0xE0, 0x9E, 0x7D, 0xFE, 0xE0, 0xA1, 0x7D, 0x02, 0x3D, 0x01, 0x6D, 0x01, 0x3D, 0x3D, 0x6D, 0x3D, 0x00, 0xEE, 0x77, 0x08, 0xD8, 0x75, 0x00, 0xEE, 0xDC, 0xD5, 0x3F, 0x00, 0x12, 0x24, 0x7C, 0x08, 0x3C, 0x38, 0x12, 0x18, 0x00, 0xEE, 0x6B, 0x00, 0x6C, 0x00, 0x6D, 0x1C, 0x22, 0x06, 0xA2, 0x5E, 0xD8, 0xD5, 0x60, 0x04, 0xE0, 0x9E, 0x22, 0x12, 0x60, 0x06, 0xE0, 0x9E, 0x22, 0x18, 0xD8, 0xD5, 0x60, 0x05, 0xE0, 0x9E, 0x22, 0x54, 0x3B, 0x00, 0x22, 0x30, 0x22, 0x36, 0x12, 0x28, 0x22, 0x4E, 0x12, 0x28, 0xD8, 0x75, 0x3F, 0x00, 0x12, 0x68, 0x6B, 0x00, 0x7D, 0x08, 0xDD, 0x85, 0x00, 0xEE, 0xDC, 0xD5, 0x3F, 0x00, 0x12, 0x5C, 0x7C, 0x08, 0x3C, 0x28, 0x12, 0x46, 0x6C, 0x00, 0x00, 0xEE, 0x80, 0x40, 0xE0, 0x40, 0x80, 0x20, 0x70, 0x20, 0x00, 0x40, 0xE0, 0x40, 0x00, 0x00]
            },
            'IBMLogo': {
                icon: 'ğŸ–¥ï¸',
                description: 'IBM Logo test ROM',
                data: [0x00, 0xE0, 0xA2, 0x2A, 0x60, 0x0C, 0x61, 0x08, 0xD0, 0x1F, 0x70, 0x09, 0xA2, 0x39, 0xD0, 0x1F, 0xA2, 0x48, 0x70, 0x08, 0xD0, 0x1F, 0x70, 0x04, 0xA2, 0x57, 0xD0, 0x1F, 0x70, 0x08, 0xA2, 0x66, 0xD0, 0x1F, 0x70, 0x08, 0xA2, 0x75, 0xD0, 0x1F, 0x12, 0x28, 0xFF, 0x00, 0xFF, 0x00, 0x3C, 0x00, 0x3C, 0x00, 0x3C, 0x00, 0x3C, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0x00, 0x38, 0x00, 0x3F, 0x00, 0x3F, 0x00, 0x38, 0x00, 0xFF, 0x00, 0xFF, 0x80, 0x00, 0xE0, 0x00, 0xE0, 0x00, 0x80, 0x00, 0x80, 0x00, 0xE0, 0x00, 0xE0, 0x00, 0x80, 0xF8, 0x00, 0xFC, 0x00, 0x3E, 0x00, 0x3F, 0x00, 0x3B, 0x00, 0x39, 0x00, 0xF8, 0x00, 0xF8, 0x03, 0x00, 0x07, 0x00, 0x0F, 0x00, 0xBF, 0x00, 0xFB, 0x00, 0xF3, 0x00, 0xE3, 0x00, 0x43, 0xE0, 0x00, 0xE0, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0xE0, 0x00, 0xE0]
            },
            'Keypad': {
                icon: 'ğŸ¹',
                description: 'Keypad test',
                data: [0x6F, 0x00, 0x60, 0x00, 0xF0, 0x0A, 0xF0, 0x29, 0x61, 0x08, 0x62, 0x10, 0x00, 0xE0, 0xD1, 0x25, 0x12, 0x00]
            },
            'Particle': {
                icon: 'âœ¨',
                description: 'Particle simulation',
                data: [0x61, 0x00, 0x62, 0x00, 0xA2, 0x2C, 0xD1, 0x21, 0xC0, 0x01, 0x30, 0x01, 0x71, 0xFF, 0x30, 0x00, 0x71, 0x01, 0xC0, 0x01, 0x30, 0x01, 0x72, 0xFF, 0x30, 0x00, 0x72, 0x01, 0x40, 0x00, 0x61, 0x00, 0x41, 0x3F, 0x61, 0x3F, 0x40, 0x00, 0x62, 0x00, 0x42, 0x1F, 0x62, 0x1F, 0x12, 0x04, 0x80]
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function initUI() {
            // Build ROM grid
            const romGrid = document.getElementById('romGrid');
            for (const [name, rom] of Object.entries(builtInROMs)) {
                const card = document.createElement('div');
                card.className = 'rom-card';
                card.innerHTML = `
                    <div class="rom-icon">${rom.icon}</div>
                    <div class="rom-name">${name}</div>
                `;
                card.title = rom.description;
                card.onclick = () => loadBuiltInROM(name);
                romGrid.appendChild(card);
            }

            // Build registers display
            updateRegisters();

            // Build keypad
            const keypad = document.getElementById('keypad');
            const keyLayout = [
                ['1', '2', '3', 'C'],
                ['4', '5', '6', 'D'],
                ['7', '8', '9', 'E'],
                ['A', '0', 'B', 'F']
            ];
            const keyboardKeys = [
                ['1', '2', '3', '4'],
                ['Q', 'W', 'E', 'R'],
                ['A', 'S', 'D', 'F'],
                ['Z', 'X', 'C', 'V']
            ];

            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const hexKey = keyLayout[row][col];
                    const kbKey = keyboardKeys[row][col];
                    const keyNum = parseInt(hexKey, 16);

                    const keyEl = document.createElement('div');
                    keyEl.className = 'key';
                    keyEl.id = `key-${keyNum}`;
                    keyEl.innerHTML = `${hexKey}<div class="key-label">${kbKey}</div>`;
                    keyEl.onmousedown = () => chip8.keyDown(keyNum);
                    keyEl.onmouseup = () => chip8.keyUp(keyNum);
                    keyEl.onmouseleave = () => chip8.keyUp(keyNum);
                    keypad.appendChild(keyEl);
                }
            }

            // Build save state slots
            const saveStatesEl = document.getElementById('saveStates');
            for (let i = 0; i < 4; i++) {
                const slot = document.createElement('div');
                slot.className = 'save-slot';
                slot.id = `slot-${i}`;
                slot.innerHTML = `
                    <div class="slot-number">Slot ${i + 1}</div>
                    <div class="slot-status">Empty</div>
                `;
                slot.onclick = (e) => {
                    if (e.shiftKey) {
                        loadState(i);
                    } else {
                        saveState(i);
                    }
                };
                slot.title = 'Click to save, Shift+Click to load';
                saveStatesEl.appendChild(slot);
            }

            // Drop zone
            const dropZone = document.getElementById('dropZone');
            dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
            dropZone.ondragleave = () => dropZone.classList.remove('dragover');
            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) loadROMFromFile(file);
            };

            // Rewind slider
            document.getElementById('rewindSlider').oninput = (e) => {
                if (rewindBuffer.length > 0) {
                    const idx = Math.floor((e.target.value / 100) * (rewindBuffer.length - 1));
                    chip8.loadState(rewindBuffer[idx]);
                    render();
                    updateDebugger();
                    document.getElementById('rewindInfo').textContent = `Frame ${idx}/${rewindBuffer.length - 1}`;
                }
            };
        }

        function loadBuiltInROM(name) {
            const rom = builtInROMs[name];
            if (rom) {
                chip8.loadROM(new Uint8Array(rom.data));
                rewindBuffer.length = 0;
                render();
                updateDebugger();

                // Update UI
                document.querySelectorAll('.rom-card').forEach(c => c.classList.remove('active'));
                event.target.closest('.rom-card').classList.add('active');
            }
        }

        function loadROMFile(event) {
            const file = event.target.files[0];
            if (file) loadROMFromFile(file);
        }

        function loadROMFromFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                chip8.loadROM(new Uint8Array(e.target.result));
                rewindBuffer.length = 0;
                render();
                updateDebugger();
            };
            reader.readAsArrayBuffer(file);
        }

        function togglePlay() {
            running = !running;
            document.getElementById('playIcon').textContent = running ? 'â¸' : 'â–¶';
            document.getElementById('playText').textContent = running ? 'Pause' : 'Run';
            document.getElementById('statusLed').className = 'status-led ' + (running ? 'running' : 'paused');
            document.getElementById('statusText').textContent = running ? 'Running' : 'Paused';
        }

        function step() {
            chip8.cycle();
            if (chip8.drawFlag) {
                render();
                chip8.drawFlag = false;
            }
            updateDebugger();
        }

        function reset() {
            const currentROM = new Uint8Array(chip8.memory.slice(0x200, 0xFFF));
            chip8.reset();
            for (let i = 0; i < currentROM.length && currentROM[i] !== 0; i++) {
                chip8.memory[0x200 + i] = currentROM[i];
            }
            rewindBuffer.length = 0;
            running = false;
            document.getElementById('playIcon').textContent = 'â–¶';
            document.getElementById('playText').textContent = 'Run';
            document.getElementById('statusLed').className = 'status-led';
            document.getElementById('statusText').textContent = 'Stopped';
            render();
            updateDebugger();
        }

        function toggleRewind() {
            rewindMode = !rewindMode;
            document.getElementById('rewindBtn').classList.toggle('active', rewindMode);
        }

        function saveState(slot) {
            saveStates[slot] = chip8.getState();
            const slotEl = document.getElementById(`slot-${slot}`);
            slotEl.classList.add('filled');
            slotEl.querySelector('.slot-status').textContent = new Date().toLocaleTimeString();
        }

        function loadState(slot) {
            if (saveStates[slot]) {
                chip8.loadState(saveStates[slot]);
                render();
                updateDebugger();
            }
        }

        function setClockSpeed(speed) {
            clockSpeed = parseInt(speed);
        }

        function setDisplayColor(color) {
            displayColor = color;
            render();
        }

        function toggleScanlines() {
            document.getElementById('scanlinesOverlay').style.display =
                document.getElementById('scanlinesToggle').checked ? 'block' : 'none';
        }

        function toggleCurve() {
            document.getElementById('curveOverlay').style.display =
                document.getElementById('curveToggle').checked ? 'block' : 'none';
        }

        function toggleSound() {
            soundEnabled = document.getElementById('soundToggle').checked;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDERING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function render() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 640, 320);

            ctx.fillStyle = displayColor;
            for (let y = 0; y < 32; y++) {
                for (let x = 0; x < 64; x++) {
                    if (chip8.display[y * 64 + x]) {
                        ctx.fillRect(x * 10, y * 10, 10, 10);
                    }
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DEBUGGER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function updateDebugger() {
            updateRegisters();
            updateStack();
            updateDisassembly();
            document.getElementById('pcDisplay').textContent = '0x' + chip8.PC.toString(16).toUpperCase().padStart(3, '0');
            document.getElementById('cyclesDisplay').textContent = chip8.cycles;
        }

        function updateRegisters() {
            const grid = document.getElementById('registersGrid');
            grid.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const reg = document.createElement('div');
                reg.className = 'register';
                reg.innerHTML = `
                    <span class="reg-name">V${i.toString(16).toUpperCase()}</span>
                    <span class="reg-value">${chip8.V[i].toString(16).toUpperCase().padStart(2, '0')}</span>
                `;
                grid.appendChild(reg);
            }

            document.getElementById('specialRegs').innerHTML = `
                <div class="special-reg">
                    <span class="reg-name">I</span>
                    <span class="reg-value">${chip8.I.toString(16).toUpperCase().padStart(4, '0')}</span>
                </div>
                <div class="special-reg">
                    <span class="reg-name">PC</span>
                    <span class="reg-value">${chip8.PC.toString(16).toUpperCase().padStart(4, '0')}</span>
                </div>
                <div class="special-reg">
                    <span class="reg-name">DT</span>
                    <span class="reg-value">${chip8.delayTimer.toString(16).toUpperCase().padStart(2, '0')}</span>
                </div>
                <div class="special-reg">
                    <span class="reg-name">ST</span>
                    <span class="reg-value">${chip8.soundTimer.toString(16).toUpperCase().padStart(2, '0')}</span>
                </div>
            `;
        }

        function updateStack() {
            document.getElementById('stackPointer').textContent = `SP: ${chip8.SP}`;
            const display = document.getElementById('stackDisplay');
            display.innerHTML = '';
            for (let i = 0; i < chip8.SP; i++) {
                const entry = document.createElement('div');
                entry.className = 'stack-entry' + (i === chip8.SP - 1 ? ' current' : '');
                entry.innerHTML = `
                    <span>${i}</span>
                    <span>0x${chip8.stack[i].toString(16).toUpperCase().padStart(4, '0')}</span>
                `;
                display.appendChild(entry);
            }
            if (chip8.SP === 0) {
                display.innerHTML = '<div style="color:var(--text-dim);padding:4px">Empty</div>';
            }
        }

        function updateDisassembly() {
            const display = document.getElementById('disasmDisplay');
            display.innerHTML = '';

            const startAddr = Math.max(0x200, chip8.PC - 10);
            const endAddr = Math.min(0xFFF, chip8.PC + 20);

            for (let addr = startAddr; addr < endAddr; addr += 2) {
                const opcode = (chip8.memory[addr] << 8) | chip8.memory[addr + 1];
                if (opcode === 0) continue;

                const { instr, args } = disassemble(opcode);
                const line = document.createElement('div');
                line.className = 'disasm-line' + (addr === chip8.PC ? ' current' : '');
                line.innerHTML = `
                    <span class="disasm-addr">${addr.toString(16).toUpperCase().padStart(4, '0')}</span>
                    <span class="disasm-bytes">${opcode.toString(16).toUpperCase().padStart(4, '0')}</span>
                    <span class="disasm-instr">${instr}</span>
                    <span class="disasm-args">${args}</span>
                `;
                display.appendChild(line);
            }

            // Auto-scroll to current instruction
            const current = display.querySelector('.current');
            if (current) current.scrollIntoView({ block: 'center' });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUDIO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playBeep() {
            if (!soundEnabled || !audioContext) return;

            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();

            osc.type = 'square';
            osc.frequency.value = 440;
            gain.gain.value = 0.1;

            osc.connect(gain);
            gain.connect(audioContext.destination);

            osc.start();
            osc.stop(audioContext.currentTime + 0.05);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // KEYBOARD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (keyMap[key] !== undefined) {
                chip8.keyDown(keyMap[key]);
                document.getElementById(`key-${keyMap[key]}`).classList.add('pressed');

                // Initialize audio on first keypress
                if (!audioContext) initAudio();
            }
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (keyMap[key] !== undefined) {
                chip8.keyUp(keyMap[key]);
                document.getElementById(`key-${keyMap[key]}`).classList.remove('pressed');
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MAIN LOOP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let lastTime = 0;
        let cycleAccumulator = 0;
        let timerAccumulator = 0;
        const timerInterval = 1000 / 60; // 60Hz

        function mainLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            if (running) {
                // CPU cycles
                cycleAccumulator += deltaTime;
                const cycleInterval = 1000 / clockSpeed;

                while (cycleAccumulator >= cycleInterval) {
                    chip8.cycle();
                    cycleAccumulator -= cycleInterval;
                }

                // Timers at 60Hz
                timerAccumulator += deltaTime;
                if (timerAccumulator >= timerInterval) {
                    chip8.updateTimers();

                    // Sound
                    if (chip8.soundTimer > 0) {
                        playBeep();
                        document.getElementById('soundIndicator').classList.remove('muted');
                    } else {
                        document.getElementById('soundIndicator').classList.add('muted');
                    }

                    timerAccumulator -= timerInterval;
                }

                // Rewind buffer (save state every few frames)
                if (chip8.cycles % 10 === 0) {
                    rewindBuffer.push(chip8.getState());
                    if (rewindBuffer.length > maxRewindFrames) {
                        rewindBuffer.shift();
                    }
                    document.getElementById('rewindSlider').max = rewindBuffer.length - 1;
                    document.getElementById('rewindSlider').value = rewindBuffer.length - 1;
                    document.getElementById('rewindInfo').textContent = 'Live';
                }

                // Render if needed
                if (chip8.drawFlag) {
                    render();
                    chip8.drawFlag = false;
                }

                // Update debugger less frequently
                if (chip8.cycles % 50 === 0) {
                    updateDebugger();
                }
            }

            requestAnimationFrame(mainLoop);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        initUI();
        render();
        updateDebugger();
        requestAnimationFrame(mainLoop);

        // Load default ROM
        loadBuiltInROM('Maze');
    </script>
</body>
</html>
