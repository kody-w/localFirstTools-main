<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WowMon Battles - Card Battle Arena</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a1a;color:#e0e0e0;font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden;user-select:none}
canvas{display:block;cursor:pointer}
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100}
.overlay h1{font-size:3rem;color:#ffcc00;text-shadow:0 0 20px rgba(255,204,0,.5);margin-bottom:10px}
.overlay h2{font-size:1.4rem;color:#aaa;margin-bottom:30px;font-weight:normal}
.btn{background:linear-gradient(135deg,#2a1a4e,#3a2a6e);border:2px solid #6a4aae;color:#e0d0ff;padding:12px 36px;margin:6px;font-size:1rem;border-radius:8px;cursor:pointer;transition:all .3s;min-width:180px}
.btn:hover{background:linear-gradient(135deg,#3a2a6e,#5a3a9e);border-color:#9a7ade;transform:scale(1.05);box-shadow:0 0 20px rgba(106,74,174,.5)}
.diff-row{display:flex;gap:10px;margin:16px 0}
.diff-btn{padding:8px 20px;border:2px solid #555;background:rgba(40,40,60,.8);color:#ccc;border-radius:6px;cursor:pointer;transition:all .3s}
.diff-btn:hover,.diff-btn.sel{border-color:#ffcc00;color:#ffcc00;background:rgba(60,50,20,.8)}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
const C=document.getElementById('c'),X=C.getContext('2d');
let W,H;function resize(){W=C.width=innerWidth;H=C.height=innerHeight}
addEventListener('resize',resize);resize();

/* ===== AUDIO ENGINE ===== */
class SFX{
  constructor(){this.c=null;this.ok=false}
  init(){if(this.ok)return;try{this.c=new(AudioContext||webkitAudioContext)();this.ok=true}catch(e){}}
  tone(t,f,d,v){if(!this.c)return;const o=this.c.createOscillator(),g=this.c.createGain();
    o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v||.12,this.c.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,this.c.currentTime+d);o.connect(g).connect(this.c.destination);o.start();o.stop(this.c.currentTime+d)}
  cardDraw(){this.tone('triangle',800,.1);setTimeout(()=>this.tone('triangle',1000,.08,.1),50)}
  cardPlay(){this.tone('square',300,.15,.15);this.tone('sawtooth',450,.1,.08)}
  hit(){this.tone('sawtooth',200,.15,.2);this.tone('square',150,.1,.15)}
  heal(){this.tone('sine',500,.3,.12);setTimeout(()=>this.tone('sine',700,.3,.1),100);setTimeout(()=>this.tone('sine',900,.3,.08),200)}
  shield(){this.tone('triangle',400,.2,.1);this.tone('sine',600,.15,.08)}
  combo(){for(let i=0;i<4;i++)setTimeout(()=>this.tone('square',400+i*150,.1,.12),i*60)}
  crit(){this.tone('sawtooth',100,.3,.25);this.tone('square',800,.15,.15)}
  death(){for(let i=0;i<5;i++)setTimeout(()=>this.tone('sawtooth',300-i*50,.3,.15-i*.02),i*80)}
  win(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>this.tone('triangle',f,.3,.12),i*150))}
  lose(){[400,350,300,200].forEach((f,i)=>setTimeout(()=>this.tone('sine',f,.4,.1),i*200))}
  boss(){this.tone('sawtooth',80,.6,.25);setTimeout(()=>this.tone('square',100,.4,.2),200)}
  menu(){this.tone('triangle',600,.08,.1)}
  power(){[400,500,600,800].forEach((f,i)=>setTimeout(()=>this.tone('sine',f,.15,.1),i*80))}
}
const sfx=new SFX();

/* ===== PARTICLES ===== */
const particles=[];
class Ptc{constructor(x,y,vx,vy,col,life,sz){this.x=x;this.y=y;this.vx=vx;this.vy=vy;this.col=col;this.life=life;this.ml=life;this.sz=sz||3}
  upd(dt){this.x+=this.vx*dt;this.y+=this.vy*dt;this.vy+=120*dt;this.life-=dt}
  draw(){const a=Math.max(0,this.life/this.ml);X.globalAlpha=a;X.fillStyle=this.col;X.beginPath();X.arc(this.x,this.y,this.sz*a,0,Math.PI*2);X.fill();X.globalAlpha=1}}
function emit(x,y,col,n,sp){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=sp*(.3+Math.random()*.7);particles.push(new Ptc(x,y,Math.cos(a)*s,Math.sin(a)*s-50,col,.5+Math.random()*.8,2+Math.random()*4))}}

/* ===== SHAKE ===== */
let shakeAmt=0,shakeDur=0;
function shake(a,d){shakeAmt=a;shakeDur=d}

/* ===== ELEMENTS ===== */
const ELEMS=['fire','water','earth','air','shadow','light'];
const ECOL={fire:'#ff4422',water:'#2266ff',earth:'#44aa22',air:'#aaddff',shadow:'#8833aa',light:'#ffdd44'};
const EWEAK={fire:'water',water:'earth',earth:'air',air:'fire',shadow:'light',light:'shadow'};
const RCOL={common:'#aaa',rare:'#4488ff',epic:'#aa44ff',legendary:'#ffaa00'};

/* ===== CARDS ===== */
let cardId=1;
function mkCard(d){return{...d,id:cardId++}}
const CARDS=[
  {name:'Flame Strike',elem:'fire',type:'atk',dmg:8,cost:2,desc:'Burst of flame',rar:'common'},
  {name:'Inferno',elem:'fire',type:'atk',dmg:15,cost:4,desc:'Engulf in fire',rar:'rare'},
  {name:'Ember Wall',elem:'fire',type:'def',shld:6,cost:2,desc:'Fire barrier',rar:'common'},
  {name:'Volcanic Fury',elem:'fire',type:'atk',dmg:25,cost:7,desc:'Devastating eruption',rar:'epic'},
  {name:'Phoenix Rise',elem:'fire',type:'spc',heal:15,dmg:10,cost:5,desc:'Heal and strike',rar:'epic'},
  {name:'Tidal Wave',elem:'water',type:'atk',dmg:7,cost:2,desc:'Crashing wave',rar:'common'},
  {name:'Healing Rain',elem:'water',type:'heal',heal:12,cost:3,desc:'Restorative rain',rar:'common'},
  {name:'Ice Armor',elem:'water',type:'def',shld:10,cost:3,desc:'Frozen protection',rar:'rare'},
  {name:'Tsunami',elem:'water',type:'atk',dmg:20,cost:6,desc:'Massive wave',rar:'epic'},
  {name:'Frost Nova',elem:'water',type:'spc',dmg:12,shld:5,cost:4,desc:'Freeze and shield',rar:'rare'},
  {name:'Rock Throw',elem:'earth',type:'atk',dmg:6,cost:1,desc:'Hurl boulder',rar:'common'},
  {name:'Stone Wall',elem:'earth',type:'def',shld:12,cost:3,desc:'Impenetrable wall',rar:'rare'},
  {name:'Earthquake',elem:'earth',type:'atk',dmg:18,cost:5,desc:'Shake the ground',rar:'rare'},
  {name:'Crystal Grow',elem:'earth',type:'heal',heal:8,shld:4,cost:3,desc:'Grow crystals',rar:'common'},
  {name:'Tectonic Fury',elem:'earth',type:'atk',dmg:30,cost:8,desc:'World-shatter',rar:'legendary'},
  {name:'Wind Slash',elem:'air',type:'atk',dmg:7,cost:2,desc:'Cutting wind',rar:'common'},
  {name:'Gale Force',elem:'air',type:'atk',dmg:14,cost:4,desc:'Powerful gust',rar:'rare'},
  {name:'Zephyr Shield',elem:'air',type:'def',shld:8,cost:2,desc:'Wind barrier',rar:'common'},
  {name:'Lightning',elem:'air',type:'atk',dmg:22,cost:6,desc:'Strike from above',rar:'epic'},
  {name:'Storm Surge',elem:'air',type:'spc',dmg:16,cost:5,desc:'Chain lightning',rar:'rare'},
  {name:'Dark Bolt',elem:'shadow',type:'atk',dmg:9,cost:2,desc:'Shadow bolt',rar:'common'},
  {name:'Life Drain',elem:'shadow',type:'spc',dmg:10,heal:5,cost:3,desc:'Steal life',rar:'rare'},
  {name:'Shadow Cloak',elem:'shadow',type:'def',shld:7,cost:2,desc:'Invisible barrier',rar:'common'},
  {name:'Void Rupture',elem:'shadow',type:'atk',dmg:24,cost:7,desc:'Tear reality',rar:'epic'},
  {name:'Soul Harvest',elem:'shadow',type:'spc',dmg:15,heal:10,cost:6,desc:'Consume souls',rar:'epic'},
  {name:'Holy Lance',elem:'light',type:'atk',dmg:8,cost:2,desc:'Radiant spear',rar:'common'},
  {name:'Divine Heal',elem:'light',type:'heal',heal:15,cost:3,desc:'Holy restoration',rar:'rare'},
  {name:'Radiant Wall',elem:'light',type:'def',shld:9,cost:3,desc:'Light shield',rar:'rare'},
  {name:'Judgement',elem:'light',type:'atk',dmg:28,cost:8,desc:'Divine wrath',rar:'legendary'},
  {name:'Blessing',elem:'light',type:'spc',heal:20,shld:10,cost:6,desc:'Full blessing',rar:'epic'},
];

/* ===== ENEMIES ===== */
const MOBS=[
  {name:'Goblin',hp:30,atk:6,elem:'earth'},{name:'Fire Imp',hp:25,atk:8,elem:'fire'},
  {name:'Water Sprite',hp:35,atk:5,elem:'water'},{name:'Wind Djinn',hp:40,atk:7,elem:'air'},
  {name:'Shadow Wraith',hp:45,atk:9,elem:'shadow'},{name:'Dark Knight',hp:55,atk:10,elem:'shadow'},
  {name:'Crystal Golem',hp:60,atk:8,elem:'earth'},{name:'Storm Hawk',hp:35,atk:11,elem:'air'},
  {name:'Lava Serpent',hp:50,atk:12,elem:'fire'},{name:'Ice Witch',hp:42,atk:10,elem:'water'},
];
const BOSSES=[
  {name:'Dragon Lord',hp:120,atk:15,elem:'fire',boss:true,abs:['firebreath','tailswipe']},
  {name:'Leviathan',hp:140,atk:13,elem:'water',boss:true,abs:['tsunami','whirlpool']},
  {name:'Titan of Stone',hp:160,atk:12,elem:'earth',boss:true,abs:['quake','rockfall']},
  {name:'Void Emperor',hp:180,atk:18,elem:'shadow',boss:true,abs:['voidblast','soulrip']},
  {name:'Celestial Guard',hp:200,atk:16,elem:'light',boss:true,abs:['judgement','radiance']},
];

/* ===== GAME STATE ===== */
const G={
  scr:'menu',diff:'normal',dm:1,
  hp:100,mhp:100,mp:5,mmp:5,shld:0,
  deck:[],hand:[],disc:[],draw:[],
  sc:0,cmb:0,mcmb:0,ct:0,
  turn:'player',rnd:1,wins:0,bosses:0,tc:0,
  en:null,es:0,
  hov:-1,mx:0,my:0,
  toasts:[],floats:[],
  ehit:0,phit:0,eatk:0,
  rewards:null,
  hi:[],sfxOn:true,
  paused:false
};

function save(){localStorage.setItem('wowmon_v2',JSON.stringify({hi:G.hi,sfxOn:G.sfxOn}))}
function load(){try{const d=JSON.parse(localStorage.getItem('wowmon_v2'));if(d){G.hi=d.hi||[];G.sfxOn=d.sfxOn!==false}}catch(e){}}

/* ===== DECK ===== */
function buildDeck(){
  G.deck=[];
  const com=CARDS.filter(c=>c.rar==='common');
  for(let i=0;i<12;i++)G.deck.push(mkCard(com[i%com.length]));
  const rare=CARDS.filter(c=>c.rar==='rare');
  for(let i=0;i<2;i++)G.deck.push(mkCard(rare[~~(Math.random()*rare.length)]));
  shuffle();
}
function shuffle(){
  G.draw=[...G.deck];
  for(let i=G.draw.length-1;i>0;i--){const j=~~(Math.random()*(i+1));[G.draw[i],G.draw[j]]=[G.draw[j],G.draw[i]]}
  G.disc=[];
}
function drawN(n){
  for(let i=0;i<n;i++){
    if(!G.draw.length){if(!G.disc.length)break;G.draw=[...G.disc];G.disc=[];
      for(let j=G.draw.length-1;j>0;j--){const k=~~(Math.random()*(j+1));[G.draw[j],G.draw[k]]=[G.draw[k],G.draw[j]]}}
    if(G.draw.length){G.hand.push(G.draw.pop());if(G.sfxOn)sfx.cardDraw()}
  }
}

/* ===== CARD LAYOUT ===== */
function cardRect(i){
  const n=G.hand.length,cw=Math.min(130,(W-40)/Math.max(n,1)-10),ch=cw*1.4;
  const tw=n*(cw+8),sx=(W-tw)/2,by=H-ch-20;
  return{x:sx+i*(cw+8),y:i===G.hov?by-30:by,w:cw,h:ch}
}
function updHov(){
  G.hov=-1;
  for(let i=G.hand.length-1;i>=0;i--){const r=cardRect(i);if(G.mx>=r.x&&G.mx<=r.x+r.w&&G.my>=r.y&&G.my<=r.y+r.h){G.hov=i;break}}
}

/* ===== BATTLE ===== */
function spawnEn(){
  if(G.rnd%5===0){const bi=Math.min(~~(G.rnd/5)-1,BOSSES.length-1);const b={...BOSSES[bi]};b.hp=~~(b.hp*G.dm);b.mhp=b.hp;G.en=b;if(G.sfxOn)sfx.boss();toast('BOSS: '+b.name)}
  else{const pool=MOBS.filter((_,i)=>i<Math.min(G.rnd+2,MOBS.length));const t=pool[~~(Math.random()*pool.length)];const e={...t};const s=1+(G.rnd-1)*.15*G.dm;e.hp=~~(e.hp*s);e.mhp=e.hp;e.atk=~~(e.atk*s);G.en=e}
  G.es=0;
}

function playCard(i){
  if(G.turn!=='player'||i<0||i>=G.hand.length)return;
  const c=G.hand[i];if(c.cost>G.mp){toast('Not enough mana!');return}
  G.mp-=c.cost;G.hand.splice(i,1);G.hov=-1;if(G.sfxOn)sfx.cardPlay();
  let dm=1;
  if(G.en&&c.elem&&EWEAK[G.en.elem]===c.elem){dm=1.5;toast('SUPER EFFECTIVE!');emit(W/2,H*.3,'#ffff00',20,200)}
  if(c.dmg){
    let d=~~(c.dmg*dm);if(G.cmb>0)d=~~(d*(1+G.cmb*.15));
    if(G.es>0){const sd=Math.min(d,G.es);G.es-=sd;d-=sd}
    if(G.en){G.en.hp=Math.max(0,G.en.hp-d);G.ehit=.3;shake(5,.15);
      emit(W/2,H*.3,ECOL[c.elem]||'#f44',15,150);float(W/2,H*.25,'-'+d,'#f44');
      if(G.sfxOn)sfx.hit();if(d>=15&&G.sfxOn)sfx.crit()}
    G.cmb++;G.ct=3;G.mcmb=Math.max(G.mcmb,G.cmb);G.sc+=d*(G.cmb>1?G.cmb:1);
  }
  if(c.heal){G.hp=Math.min(G.mhp,G.hp+c.heal);float(W*.3,H*.65,'+'+c.heal,'#4f8');emit(W*.3,H*.65,'#4f8',10,100);if(G.sfxOn)sfx.heal()}
  if(c.shld){G.shld+=c.shld;float(W*.3,H*.6,'+'+c.shld+' Shld','#48f');if(G.sfxOn)sfx.shield()}
  if(G.cmb>0&&G.cmb%3===0){if(G.sfxOn)sfx.combo();toast('COMBO x'+G.cmb+'!');G.sc+=G.cmb*50}
  G.disc.push(c);G.tc++;
  if(G.en&&G.en.hp<=0)enDead();
}

function endTurn(){
  if(G.turn!=='player')return;G.turn='enemy';G.ct=0;G.cmb=0;setTimeout(enTurn,600);
}

function enTurn(){
  if(!G.en||G.en.hp<=0)return;
  const d=~~(Math.random()*G.en.atk)+~~(G.en.atk*.3);
  if(G.en.boss&&Math.random()<.3){const ab=G.en.abs[~~(Math.random()*G.en.abs.length)];
    dmgPlayer(~~(d*1.5));toast(G.en.name+' uses '+ab.toUpperCase()+'!');shake(10,.3);emit(W*.3,H*.65,ECOL[G.en.elem],25,200)}
  else dmgPlayer(d);
  G.eatk=.4;G.phit=.3;
  if(G.hp<=0){gameOver();return}
  setTimeout(()=>{G.turn='player';G.mp=Math.min(G.mmp,G.mp+3);drawN(Math.min(3,7-G.hand.length))},400);
}

function dmgPlayer(d){
  if(G.shld>0){const sd=Math.min(d,G.shld);G.shld-=sd;d-=sd;if(sd>0)float(W*.3,H*.55,'Shld -'+sd,'#48f')}
  G.hp=Math.max(0,G.hp-d);float(W*.3,H*.65,'-'+d,'#f44');emit(W*.3,H*.65,'#f44',12,120);shake(6,.2);if(G.sfxOn)sfx.hit();
}

function enDead(){
  G.wins++;const boss=G.en.boss;const bonus=boss?500:100;G.sc+=bonus;
  if(boss){G.bosses++;if(G.sfxOn)sfx.win();toast('BOSS DEFEATED! +'+bonus)}
  else toast(G.en.name+' defeated! +'+bonus);
  emit(W/2,H*.3,ECOL[G.en.elem],30,250);if(G.sfxOn)sfx.death();
  G.turn='reward';setTimeout(showReward,800);
}

function showReward(){
  const pool=CARDS.filter(c=>{if(G.rnd<3)return c.rar==='common'||c.rar==='rare';if(G.rnd<7)return c.rar!=='legendary';return true});
  const opts=[];while(opts.length<3){const c=pool[~~(Math.random()*pool.length)];if(!opts.find(o=>o.name===c.name))opts.push({...c})}
  G.rewards=opts;
}

function pickReward(i){
  if(!G.rewards||i<0||i>=G.rewards.length)return;
  G.deck.push(mkCard(G.rewards[i]));if(G.sfxOn)sfx.power();toast('Added '+G.rewards[i].name);
  G.rewards=null;G.rnd++;
  if(G.rnd>15){victory();return}
  startBattle();
}

function startBattle(){spawnEn();G.hand=[];G.shld=0;G.es=0;shuffle();G.mp=G.mmp;G.turn='player';G.cmb=0;drawN(5)}

function newRun(){
  rmOvr();G.scr='battle';G.hp=100;G.mhp=100;G.mp=5;G.mmp=5;G.shld=0;G.sc=0;G.cmb=0;G.mcmb=0;G.rnd=1;G.wins=0;G.bosses=0;G.tc=0;
  G.rewards=null;G.floats=[];G.toasts=[];particles.length=0;buildDeck();startBattle();
}

function gameOver(){
  G.scr='over';G.hi.push({sc:G.sc,dt:new Date().toISOString().split('T')[0],df:G.diff});
  G.hi.sort((a,b)=>b.sc-a.sc);G.hi=G.hi.slice(0,10);save();if(G.sfxOn)sfx.lose();showOvr();
}

function victory(){
  G.scr='win';const fs=G.sc+G.hp*10+G.bosses*200+G.mcmb*25;G.sc=fs;
  G.hi.push({sc:fs,dt:new Date().toISOString().split('T')[0],df:G.diff});
  G.hi.sort((a,b)=>b.sc-a.sc);G.hi=G.hi.slice(0,10);save();if(G.sfxOn)sfx.win();showOvr();
}

/* ===== UI HELPERS ===== */
function toast(t){G.toasts.push({t,tm:2})}
function float(x,y,t,c){G.floats.push({x,y,t,c,l:1.2,ml:1.2})}

function rr(x,y,w,h,r){X.beginPath();X.moveTo(x+r,y);X.lineTo(x+w-r,y);X.quadraticCurveTo(x+w,y,x+w,y+r);X.lineTo(x+w,y+h-r);X.quadraticCurveTo(x+w,y+h,x+w-r,y+h);X.lineTo(x+r,y+h);X.quadraticCurveTo(x,y+h,x,y+h-r);X.lineTo(x,y+r);X.quadraticCurveTo(x,y,x+r,y);X.closePath()}

/* ===== DRAWING ===== */
function drawCardUI(c,x,y,w,h,hov){
  const ec=ECOL[c.elem]||'#888',rc=RCOL[c.rar]||'#aaa',ok=c.cost<=G.mp;
  X.save();if(hov){X.shadowColor=ec;X.shadowBlur=15}
  const gr=X.createLinearGradient(x,y,x,y+h);gr.addColorStop(0,ok?'#1a1a2e':'#1a1010');gr.addColorStop(1,ok?'#0a0a1e':'#0a0505');
  X.fillStyle=gr;rr(x,y,w,h,8);X.fill();X.strokeStyle=hov?ec:(ok?'#444':'#332222');X.lineWidth=hov?2:1;X.stroke();X.restore();
  X.fillStyle=ec;rr(x,y,w,4,0);X.fill();
  // Mana
  X.fillStyle='#2244aa';X.beginPath();X.arc(x+14,y+14,11,0,Math.PI*2);X.fill();
  X.fillStyle='#adf';X.font='bold '+~~(w*.1)+'px monospace';X.textAlign='center';X.fillText(c.cost,x+14,y+18);
  // Name
  X.fillStyle=rc;X.font='bold '+~~(w*.09)+'px sans-serif';X.fillText(c.name,x+w/2,y+35,w-10);
  // Element
  X.fillStyle=ec;X.globalAlpha=.3;X.beginPath();X.arc(x+w/2,y+h*.3,w*.18,0,Math.PI*2);X.fill();X.globalAlpha=1;
  X.fillStyle=ec;X.font='bold '+~~(w*.18*1.2)+'px sans-serif';X.textBaseline='middle';
  X.fillText(c.elem[0].toUpperCase(),x+w/2,y+h*.3+2);X.textBaseline='alphabetic';
  // Stats
  X.font=~~(w*.08)+'px sans-serif';let sy=y+h*.58;
  if(c.dmg){X.fillStyle='#f64';X.fillText('DMG: '+c.dmg,x+w/2,sy);sy+=~~(w*.1)+4}
  if(c.heal){X.fillStyle='#4f8';X.fillText('HEAL: '+c.heal,x+w/2,sy);sy+=~~(w*.1)+4}
  if(c.shld){X.fillStyle='#48f';X.fillText('SHLD: '+c.shld,x+w/2,sy);sy+=~~(w*.1)+4}
  X.fillStyle='#888';X.font=~~(w*.07)+'px sans-serif';X.fillText(c.desc,x+w/2,y+h-12,w-10);
}

function drawEnemy(en,cx,cy){
  if(!en)return;const boss=en.boss,sz=boss?80:50,col=ECOL[en.elem]||'#888';
  if(G.ehit>0)X.globalAlpha=.5+Math.sin(G.ehit*30)*.5;
  X.fillStyle=col;X.globalAlpha*=.8;
  if(boss){X.beginPath();X.moveTo(cx,cy-sz);X.lineTo(cx+sz*.8,cy-sz*.3);X.lineTo(cx+sz*.6,cy+sz*.5);
    X.lineTo(cx-sz*.6,cy+sz*.5);X.lineTo(cx-sz*.8,cy-sz*.3);X.closePath();X.fill();X.strokeStyle='#fff';X.lineWidth=2;X.stroke();
    X.fillStyle='#fa0';for(let i=-2;i<=2;i++){X.beginPath();X.moveTo(cx+i*15,cy-sz-5);X.lineTo(cx+i*15-6,cy-sz+12);X.lineTo(cx+i*15+6,cy-sz+12);X.closePath();X.fill()}}
  else{X.beginPath();X.arc(cx,cy,sz*.6,0,Math.PI*2);X.fill();X.strokeStyle='#fff';X.lineWidth=1;X.stroke();
    for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2-Math.PI/2;X.beginPath();X.moveTo(cx+Math.cos(a)*sz*.55,cy+Math.sin(a)*sz*.55);
      X.lineTo(cx+Math.cos(a)*sz*.8,cy+Math.sin(a)*sz*.8);X.strokeStyle=col;X.lineWidth=3;X.stroke()}}
  X.globalAlpha=1;
  // Eyes
  X.fillStyle='#fff';X.beginPath();X.arc(cx-sz*.15,cy-sz*.1,sz*.1,0,Math.PI*2);X.arc(cx+sz*.15,cy-sz*.1,sz*.1,0,Math.PI*2);X.fill();
  X.fillStyle='#000';X.beginPath();X.arc(cx-sz*.12,cy-sz*.08,sz*.05,0,Math.PI*2);X.arc(cx+sz*.12,cy-sz*.08,sz*.05,0,Math.PI*2);X.fill();
  // HP bar
  const bw=boss?160:100,bh=10,bx=cx-bw/2,by=cy-sz-(boss?35:20);
  X.fillStyle='#222';rr(bx,by,bw,bh,3);X.fill();
  const pct=Math.max(0,en.hp/en.mhp);X.fillStyle=pct>.5?'#4c4':pct>.25?'#cc4':'#c44';rr(bx,by,bw*pct,bh,3);X.fill();
  X.strokeStyle='#444';X.lineWidth=1;rr(bx,by,bw,bh,3);X.stroke();
  X.fillStyle='#fff';X.font='10px sans-serif';X.textAlign='center';X.fillText(en.hp+'/'+en.mhp,cx,by-3);
  X.fillStyle=boss?'#fa0':'#ddd';X.font=(boss?'bold 16px':'13px')+' sans-serif';X.fillText(en.name,cx,by-16);
  if(G.es>0){X.fillStyle='#48f';X.font='bold 12px sans-serif';X.fillText('Shield: '+G.es,cx,cy+sz*.7)}
  // Element badge
  X.fillStyle='rgba(0,0,0,.5)';X.beginPath();X.arc(cx+sz*.5,cy-sz*.4,12,0,Math.PI*2);X.fill();
  X.fillStyle=col;X.font='bold 10px sans-serif';X.fillText(en.elem[0].toUpperCase(),cx+sz*.5,cy-sz*.4+4);
}

function drawPlayer(cx,cy){
  const sz=40;X.fillStyle='#48f';X.beginPath();X.arc(cx,cy-sz*.3,sz*.4,0,Math.PI*2);X.fill();
  X.fillStyle='#24a';X.beginPath();X.moveTo(cx-sz*.3,cy);X.lineTo(cx,cy+sz*.5);X.lineTo(cx+sz*.3,cy);X.closePath();X.fill();
  if(G.shld>0){X.strokeStyle='#48f';X.lineWidth=2;X.globalAlpha=.5+Math.sin(Date.now()*.005)*.3;
    X.beginPath();X.arc(cx,cy,sz*.7,0,Math.PI*2);X.stroke();X.globalAlpha=1;
    X.fillStyle='#adf';X.font='bold 11px sans-serif';X.textAlign='center';X.fillText(G.shld,cx,cy+sz*.8)}
}

function drawHUD(){
  X.fillStyle='rgba(10,10,26,.9)';X.fillRect(0,0,W,50);
  X.strokeStyle='#333';X.lineWidth=1;X.beginPath();X.moveTo(0,50);X.lineTo(W,50);X.stroke();
  // HP
  X.fillStyle='#aaa';X.font='11px sans-serif';X.textAlign='left';X.fillText('HP',10,18);
  X.fillStyle='#222';rr(30,8,120,14,4);X.fill();
  const hp=G.hp/G.mhp;X.fillStyle=hp>.5?'#4c4':hp>.25?'#cc4':'#c44';rr(30,8,120*hp,14,4);X.fill();
  X.fillStyle='#fff';X.font='bold 10px sans-serif';X.textAlign='center';X.fillText(G.hp+'/'+G.mhp,90,19);
  // Mana
  X.textAlign='left';X.fillStyle='#aaa';X.font='11px sans-serif';X.fillText('MP',10,38);
  X.fillStyle='#222';rr(30,28,80,12,4);X.fill();
  X.fillStyle='#26f';rr(30,28,80*(G.mp/G.mmp),12,4);X.fill();
  X.fillStyle='#adf';X.font='bold 10px sans-serif';X.textAlign='center';X.fillText(G.mp+'/'+G.mmp,70,38);
  // Score
  X.textAlign='right';X.fillStyle='#fc0';X.font='bold 14px sans-serif';X.fillText('SCORE: '+G.sc,W-10,20);
  if(G.cmb>1){X.fillStyle='#f60';X.font='bold 12px sans-serif';X.fillText('COMBO x'+G.cmb,W-10,38)}
  // Center
  X.textAlign='center';X.fillStyle='#666';X.font='10px sans-serif';
  X.fillText(G.diff.toUpperCase()+' | Round '+G.rnd+'/15',W/2,20);
  X.fillText('Won: '+G.wins+' | Bosses: '+G.bosses,W/2,38);
}

function drawBattle(){
  // Background
  const bg=X.createLinearGradient(0,0,0,H);bg.addColorStop(0,'#0a0a2a');bg.addColorStop(.4,'#0a0a1a');bg.addColorStop(1,'#050510');
  X.fillStyle=bg;X.fillRect(0,0,W,H);
  // Stars
  const t=Date.now()*.001;
  for(let i=0;i<40;i++){const sx=((i*137.5)%W),sy=((i*97.3)%(H*.5));
    X.globalAlpha=.3+Math.sin(t+i)*.2;X.fillStyle='#fff';X.beginPath();X.arc(sx,sy,1,0,Math.PI*2);X.fill()}
  X.globalAlpha=1;
  // Arena
  X.fillStyle='rgba(30,30,60,.5)';X.beginPath();X.ellipse(W/2,H*.55,W*.4,H*.1,0,0,Math.PI*2);X.fill();
  // Enemy
  if(G.en)drawEnemy(G.en,W/2,H*.28);
  // Player
  if(G.phit>0)X.globalAlpha=.5+Math.sin(G.phit*30)*.5;
  drawPlayer(W*.2,H*.55);X.globalAlpha=1;
  // Hand
  if(G.turn==='player')for(let i=0;i<G.hand.length;i++){const r=cardRect(i);drawCardUI(G.hand[i],r.x,r.y,r.w,r.h,i===G.hov)}
  // End turn btn
  if(G.turn==='player'){const bx=W-140,by=H-200;
    X.fillStyle='#2a2a4e';rr(bx,by,120,40,6);X.fill();X.strokeStyle='#6a4aae';X.lineWidth=1;rr(bx,by,120,40,6);X.stroke();
    X.fillStyle='#ddd';X.font='14px sans-serif';X.textAlign='center';X.fillText('End Turn',bx+60,by+25);
    X.fillStyle='#888';X.font='10px sans-serif';X.fillText('[SPACE]',bx+60,by+38)}
  // Deck info
  X.fillStyle='#666';X.font='11px sans-serif';X.textAlign='left';
  X.fillText('Draw: '+G.draw.length,10,H-15);X.fillText('Disc: '+G.disc.length,80,H-15);X.fillText('Deck: '+G.deck.length,160,H-15);
  X.textAlign='right';X.fillStyle='#888';X.fillText('Round '+G.rnd+'/15',W-10,H-15);
  drawHUD();
  // Reward
  if(G.turn==='reward'&&G.rewards)drawRewards();
  // Hovered card info
  if(G.hov>=0&&G.hov<G.hand.length){
    const c=G.hand[G.hov];X.fillStyle='rgba(15,15,30,.95)';const iw=300,ih=50,ix=(W-iw)/2,iy=H-cardRect(0).h-70;
    rr(ix,iy,iw,ih,8);X.fill();X.strokeStyle=ECOL[c.elem]||'#444';rr(ix,iy,iw,ih,8);X.stroke();
    X.fillStyle='#fc0';X.font='bold 13px sans-serif';X.textAlign='center';X.fillText(c.name+' ('+c.elem+')',W/2,iy+18);
    X.fillStyle='#aaa';X.font='11px sans-serif';X.fillText(c.desc+' | Cost: '+c.cost,W/2,iy+36)}
  // Floats
  X.textAlign='center';G.floats.forEach(f=>{const p=1-f.l/f.ml;X.globalAlpha=Math.max(0,f.l/f.ml);X.fillStyle=f.c;X.font='bold 18px sans-serif';X.fillText(f.t,f.x,f.y-p*40);X.globalAlpha=1});
  // Particles
  particles.forEach(p=>p.draw());
  // Enemy turn banner
  if(G.turn==='enemy'){X.fillStyle='rgba(0,0,0,.5)';X.fillRect(0,H/2-20,W,40);X.fillStyle='#f44';X.font='bold 18px sans-serif';X.textAlign='center';X.fillText('ENEMY TURN',W/2,H/2+6)}
}

function drawRewards(){
  X.fillStyle='rgba(0,0,0,.7)';X.fillRect(0,0,W,H);
  X.fillStyle='#fc0';X.font='bold 24px sans-serif';X.textAlign='center';X.fillText('CHOOSE A CARD REWARD',W/2,H*.2);
  X.fillStyle='#aaa';X.font='14px sans-serif';X.fillText('Click a card to add to deck',W/2,H*.25);
  const cw=140,ch=200,tw=3*cw+40,sx=(W-tw)/2,y=H/2-ch/2;
  G.rewards.forEach((c,i)=>{const x=sx+i*(cw+20);const h=G.mx>=x&&G.mx<=x+cw&&G.my>=y&&G.my<=y+ch;drawCardUI(c,x,h?y-10:y,cw,ch,h)});
}

/* ===== OVERLAYS ===== */
function rmOvr(){const e=document.querySelector('.overlay');if(e)e.remove()}
function showOvr(){
  rmOvr();if(G.scr!=='menu'&&G.scr!=='over'&&G.scr!=='win')return;
  const d=document.createElement('div');d.className='overlay';
  if(G.scr==='menu'){
    d.innerHTML='<h1>WowMon Battles</h1><h2>Card Battle Arena</h2>'+
      '<div class="diff-row">'+
      '<button class="diff-btn '+(G.diff==='easy'?'sel':'')+'" onclick="G.diff=\'easy\';G.dm=.7;sfx.init();sfx.menu();showOvr()">Easy</button>'+
      '<button class="diff-btn '+(G.diff==='normal'?'sel':'')+'" onclick="G.diff=\'normal\';G.dm=1;sfx.init();sfx.menu();showOvr()">Normal</button>'+
      '<button class="diff-btn '+(G.diff==='hard'?'sel':'')+'" onclick="G.diff=\'hard\';G.dm=1.5;sfx.init();sfx.menu();showOvr()">Hard</button></div>'+
      '<button class="btn" onclick="sfx.init();sfx.menu();newRun()">Start Battle</button>'+
      '<div style="margin-top:30px;max-width:300px"><h3 style="color:#fc0;margin-bottom:10px">High Scores</h3>'+
      (G.hi.length>0?G.hi.slice(0,5).map((s,i)=>'<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #222"><span style="color:#888">#'+(i+1)+'</span><span style="color:#fc0">'+s.sc+'</span><span style="color:#666">'+s.df+'</span></div>').join(''):'<div style="color:#666">No scores yet</div>')+
      '</div><div style="margin-top:20px;color:#666;font-size:.85rem"><div>Click cards or press 1-7</div><div>SPACE=End Turn | ESC=Pause | R=Restart</div></div>';
  }else if(G.scr==='over'){
    d.innerHTML='<h1 style="color:#f44">DEFEAT</h1><h2>Fell in round '+G.rnd+'</h2>'+
      '<div style="color:#fc0;font-size:1.5rem;margin:20px">Score: '+G.sc+'</div>'+
      '<div style="color:#aaa;margin-bottom:20px"><div>Wins: '+G.wins+'</div><div>Bosses: '+G.bosses+'</div><div>Max Combo: '+G.mcmb+'</div></div>'+
      '<button class="btn" onclick="sfx.init();newRun()">Try Again [R]</button><button class="btn" onclick="G.scr=\'menu\';showOvr()">Menu</button>';
  }else{
    d.innerHTML='<h1 style="color:#4f8">VICTORY!</h1><h2>15 rounds cleared!</h2>'+
      '<div style="color:#fc0;font-size:2rem;margin:20px">Score: '+G.sc+'</div>'+
      '<div style="color:#aaa;margin-bottom:20px"><div>Wins: '+G.wins+'</div><div>Bosses: '+G.bosses+'</div><div>Max Combo: '+G.mcmb+'</div><div>HP: '+G.hp+'</div><div>'+G.diff.toUpperCase()+'</div></div>'+
      '<button class="btn" onclick="sfx.init();newRun()">Play Again [R]</button><button class="btn" onclick="G.scr=\'menu\';showOvr()">Menu</button>';
  }
  document.body.appendChild(d);
}

/* ===== INPUT ===== */
addEventListener('keydown',e=>{
  if(e.key==='Escape'&&G.scr==='battle'){G.paused=!G.paused;if(G.paused){const d=document.createElement('div');d.className='overlay';d.id='pause';
    d.innerHTML='<h1 style="color:#fc0;font-size:2.5rem;margin-bottom:30px">PAUSED</h1><button class="btn" onclick="G.paused=false;document.getElementById(\'pause\').remove()">Resume</button><button class="btn" onclick="G.paused=false;document.getElementById(\'pause\').remove();G.scr=\'menu\';showOvr()">Menu</button>';
    document.body.appendChild(d)}else{const p=document.getElementById('pause');if(p)p.remove()}}
  if((e.key==='r'||e.key==='R')&&(G.scr==='over'||G.scr==='win'))newRun();
  if(G.scr==='battle'&&G.turn==='player'){const n=parseInt(e.key);if(n>=1&&n<=G.hand.length)playCard(n-1)}
  if(e.key===' '&&G.scr==='battle'&&G.turn==='player')endTurn();
});

C.addEventListener('mousemove',e=>{G.mx=e.clientX;G.my=e.clientY;if(G.scr==='battle'&&G.turn==='player')updHov()});
C.addEventListener('click',e=>{sfx.init();G.mx=e.clientX;G.my=e.clientY;onClick(e.clientX,e.clientY)});
C.addEventListener('touchstart',e=>{e.preventDefault();sfx.init();const t=e.touches[0];G.mx=t.clientX;G.my=t.clientY;onClick(t.clientX,t.clientY)},{passive:false});

function onClick(mx,my){
  if(G.scr==='battle'&&G.turn==='player'){
    for(let i=G.hand.length-1;i>=0;i--){const r=cardRect(i);if(mx>=r.x&&mx<=r.x+r.w&&my>=r.y&&my<=r.y+r.h){playCard(i);return}}
    const bx=W-140,by=H-200;if(mx>=bx&&mx<=bx+120&&my>=by&&my<=by+40){endTurn();return}
  }
  if(G.scr==='battle'&&G.turn==='reward'&&G.rewards){
    const cw=140,ch=200,tw=3*cw+40,sx=(W-tw)/2,y=H/2-ch/2;
    for(let i=0;i<3;i++){const x=sx+i*(cw+20);if(mx>=x&&mx<=x+cw&&my>=y&&my<=y+ch){pickReward(i);return}}
  }
}

/* ===== GAME LOOP ===== */
let lt=0;
function loop(t){
  const dt=Math.min((t-lt)/1000,.05);lt=t;
  if(G.paused){requestAnimationFrame(loop);return}
  if(G.scr==='battle'){
    for(let i=particles.length-1;i>=0;i--){particles[i].upd(dt);if(particles[i].life<=0)particles.splice(i,1)}
    for(let i=G.floats.length-1;i>=0;i--){G.floats[i].l-=dt;if(G.floats[i].l<=0)G.floats.splice(i,1)}
    for(let i=G.toasts.length-1;i>=0;i--){G.toasts[i].tm-=dt;if(G.toasts[i].tm<=0)G.toasts.splice(i,1)}
    if(G.ehit>0)G.ehit-=dt;if(G.phit>0)G.phit-=dt;if(G.eatk>0)G.eatk-=dt;
    if(G.ct>0){G.ct-=dt;if(G.ct<=0)G.cmb=0}
    if(shakeDur>0)shakeDur-=dt;
    X.save();
    if(shakeDur>0){X.translate((Math.random()-.5)*shakeAmt*2,(Math.random()-.5)*shakeAmt*2)}
    drawBattle();
    X.restore();
    // Toasts on top
    G.toasts.forEach((ts,i)=>{const a=Math.min(1,ts.tm);X.globalAlpha=a;X.fillStyle='rgba(20,20,40,.95)';
      const tw=X.measureText(ts.t).width+40;rr((W-tw)/2,60+i*40,tw,30,6);X.fill();
      X.strokeStyle='#fc0';rr((W-tw)/2,60+i*40,tw,30,6);X.stroke();
      X.fillStyle='#fc0';X.font='bold 13px sans-serif';X.textAlign='center';X.fillText(ts.t,W/2,80+i*40);X.globalAlpha=1});
  }
  requestAnimationFrame(loop);
}

load();showOvr();requestAnimationFrame(loop);
</script>
</body>
</html>