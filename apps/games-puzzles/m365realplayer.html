<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Player - M365 Copilot Theme</title>
    <style>
        /* Font Imports from M365 Shell */
        @font-face { 
            font-family: "Segoe UI Web"; 
            src: url('https://res-1.cdn.office.net/files/fabric-cdn-prod_20230815.002/assets/fonts/segoeui-west-european/segoeui-regular.woff2') format("woff2"), 
                 url('https://res-1.cdn.office.net/files/fabric-cdn-prod_20230815.002/assets/fonts/segoeui-west-european/segoeui-regular.woff') format("woff"); 
            font-weight: 400; 
            font-style: normal; 
            font-display: swap; 
        }
        @font-face { 
            font-family: "Segoe UI Web"; 
            src: url('https://res-1.cdn.office.net/files/fabric-cdn-prod_20230815.002/assets/fonts/segoeui-west-european/segoeui-semibold.woff2') format("woff2"), 
                 url('https://res-1.cdn.office.net/files/fabric-cdn-prod_20230815.002/assets/fonts/segoeui-west-european/segoeui-semibold.woff') format("woff"); 
            font-weight: 600; 
            font-style: normal; 
            font-display: swap; 
        }
        @font-face { 
            font-family: "Segoe UI Web"; 
            src: url('https://res-1.cdn.office.net/files/fabric-cdn-prod_20230815.002/assets/fonts/segoeui-west-european/segoeui-bold.woff2') format("woff2"), 
                 url('https://res-1.cdn.office.net/files/fabric-cdn-prod_20230815.002/assets/fonts/segoeui-west-european/segoeui-bold.woff') format("woff"); 
            font-weight: 700; 
            font-style: normal; 
            font-display: swap; 
        }

        /* M365 Copilot Theme Variables */
        :root {
            --font-family-primary: "Segoe UI Web", "Segoe UI", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            --background-color-page: #f5f5f5;
            --background-color-chat: #ffffff;
            --background-color-input: #ffffff;
            --text-color-primary: #1d1d1d;
            --text-color-secondary: #616161;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --accent-color-purple: #6264a7;
            --status-critical-bg: #fdeded;
            --status-critical-fg: #a80000;
            --status-warning-bg: #fff4ce;
            --status-warning-fg: #795b00;
            --status-active-bg: #e6f2ff;
            --status-active-fg: #004578;
            --status-complete-bg: #e6ffe6;
            --status-complete-fg: #107c10;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-primary);
            background: var(--background-color-page);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--text-color-primary);
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color-primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color-secondary);
            font-size: 14px;
        }

        .main-container {
            flex: 1;
            display: flex;
            min-height: 0;
            padding: 20px;
            gap: 20px;
        }

        /* Video Container */
        .video-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .screen-frame {
            flex: 1;
            background: #000;
            position: relative;
            overflow: hidden;
        }

        .narrator-overlay {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 20px 30px;
            border-radius: 8px;
            max-width: 80%;
            text-align: center;
            color: white;
            z-index: 10;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .narrator-overlay.left {
            left: 20px;
            transform: translateX(0);
        }

        .narrator-overlay.right {
            left: auto;
            right: 20px;
            transform: translateX(0);
        }

        .narrator-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .narrator-text {
            font-size: 16px;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .narrator-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Controls */
        .controls {
            padding: 15px 20px;
            background: #f8f8f8;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-color-purple);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .control-btn:hover {
            background: #5153a3;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            flex: 1;
            margin: 0 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color-purple);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }

        .time-display {
            font-size: 12px;
            color: var(--text-color-secondary);
            min-width: 80px;
        }

        .step-indicator {
            font-size: 14px;
            color: var(--text-color-secondary);
        }

        /* Chat Sidebar */
        .chat-sidebar {
            width: 400px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: var(--background-color-chat);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
            overflow: hidden;
        }

        .chat-header {
            padding: 12px 16px;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #fafafa;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* Message Styles */
        .message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-icon {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .message.user .message-icon {
            background: #f0f0f0;
        }

        .message.agent .message-icon {
            background: linear-gradient(135deg, #6264a7, #8b8cc7);
        }

        .message.system .message-icon {
            background: #616161;
        }

        .message-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-title {
            font-weight: 600;
            font-size: 14px;
        }

        .message-timestamp {
            font-size: 12px;
            color: var(--text-color-secondary);
        }

        .message-body {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color-primary);
            white-space: pre-wrap;
        }

        /* Agent Card */
        .agent-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .agent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .agent-card-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color-primary);
        }

        .agent-card-status {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .agent-card-status.ACTIVE,
        .agent-card-status.ANALYZING,
        .agent-card-status.PROCESSING,
        .agent-card-status.EXTRACTING,
        .agent-card-status.MONITORING {
            background: var(--status-active-bg);
            color: var(--status-active-fg);
        }

        .agent-card-status.COMPLETE,
        .agent-card-status.READY,
        .agent-card-status.CONNECTED,
        .agent-card-status.OPERATIONAL,
        .agent-card-status.VALIDATED,
        .agent-card-status.DISPATCHED {
            background: var(--status-complete-bg);
            color: var(--status-complete-fg);
        }

        .agent-card-status.CRITICAL {
            background: var(--status-critical-bg);
            color: var(--status-critical-fg);
        }

        .agent-card-status.WARNING {
            background: var(--status-warning-bg);
            color: var(--status-warning-fg);
        }

        .agent-card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .detail-key {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-color-secondary);
            text-transform: uppercase;
        }

        .detail-value {
            font-size: 13px;
            color: var(--text-color-primary);
        }

        /* Input Area */
        .chat-input-container {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: white;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: flex-end;
            background: var(--background-color-input);
            border: 1px solid #c2c2c2;
            border-radius: 6px;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--accent-color-purple);
            box-shadow: 0 0 0 1px var(--accent-color-purple);
        }

        .chat-input-container textarea {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 10px;
            font-family: var(--font-family-primary);
            font-size: 14px;
            resize: none;
            background: transparent;
            min-height: 42px;
            max-height: 150px;
        }

        .send-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            margin-right: 4px;
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            color: #616161;
        }

        .send-button:hover svg {
            color: var(--accent-color-purple);
        }

        /* File Upload */
        .file-upload-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 400px;
        }

        .file-upload-container.hidden {
            display: none;
        }

        .file-upload-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color-primary);
        }

        .file-input-wrapper {
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-wrapper:hover {
            border-color: var(--accent-color-purple);
            background: #f8f8fc;
        }

        .file-input-wrapper.dragover {
            border-color: var(--accent-color-purple);
            background: #f0f0ff;
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 10px;
            color: var(--accent-color-purple);
        }

        .upload-text {
            font-size: 14px;
            color: var(--text-color-primary);
            margin-bottom: 5px;
        }

        .upload-subtext {
            font-size: 12px;
            color: var(--text-color-secondary);
        }

        .close-upload {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color-secondary);
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-color-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-color-purple);">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
            </svg>
            <span class="header-title" id="headerTitle">M365 Copilot Demo Player</span>
        </div>
        <div class="user-info">
            <span id="userName">Guest User</span>
            <button id="uploadBtn" class="control-btn" style="width: auto; padding: 0 15px;" title="Upload Demo JSON">
                üìÅ Load Demo
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Video/Demo Container -->
        <div class="video-container">
            <div class="screen-frame" id="screenFrame">
                <div id="narratorOverlay" class="narrator-overlay" style="display: none;">
                    <div class="narrator-title" id="narratorTitle"></div>
                    <div class="narrator-text" id="narratorText"></div>
                    <div class="narrator-subtitle" id="narratorSubtitle"></div>
                </div>
            </div>
            <div class="controls">
                <div class="control-buttons">
                    <button id="playPauseBtn" class="control-btn" title="Play/Pause">‚ñ∂</button>
                    <button id="restartBtn" class="control-btn" title="Restart">‚Ü∫</button>
                    <button id="muteBtn" class="control-btn" title="Mute/Unmute">üîä</button>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="time-display" id="timeDisplay">0:00 / 0:00</span>
                </div>
                <div class="step-indicator" id="stepIndicator">Step 1 of 1</div>
            </div>
        </div>

        <!-- Chat Sidebar -->
        <div class="chat-sidebar">
            <div class="chat-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-color-purple);">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
                <span>Copilot</span>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea placeholder="Demo running - chat is view only" rows="1" readonly></textarea>
                    <button class="send-button" title="Send" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div id="fileUploadContainer" class="file-upload-container hidden">
        <button class="close-upload" id="closeUpload">‚úï</button>
        <div class="file-upload-header">Upload Demo JSON File</div>
        <div class="file-input-wrapper" id="fileInputWrapper">
            <input type="file" id="fileInput" class="file-input" accept=".json">
            <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <div class="upload-text">Click to upload or drag and drop</div>
            <div class="upload-subtext">JSON files only</div>
        </div>
    </div>

    <script>
        // Global Variables
        let demoData = null;
        let currentStepIndex = 0;
        let isPlaying = false;
        let currentTime = 0;
        let totalDuration = 0;
        let animationFrameId = null;
        let speechSynthesizer = null;
        let isMuted = false;
        let stepStartTime = 0;

        // DOM Elements
        const playPauseBtn = document.getElementById('playPauseBtn');
        const restartBtn = document.getElementById('restartBtn');
        const muteBtn = document.getElementById('muteBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const timeDisplay = document.getElementById('timeDisplay');
        const stepIndicator = document.getElementById('stepIndicator');
        const chatMessages = document.getElementById('chatMessages');
        const narratorOverlay = document.getElementById('narratorOverlay');
        const narratorTitle = document.getElementById('narratorTitle');
        const narratorText = document.getElementById('narratorText');
        const narratorSubtitle = document.getElementById('narratorSubtitle');
        const headerTitle = document.getElementById('headerTitle');
        const userName = document.getElementById('userName');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        const fileInput = document.getElementById('fileInput');
        const fileInputWrapper = document.getElementById('fileInputWrapper');
        const closeUpload = document.getElementById('closeUpload');

        // File Upload Handlers
        uploadBtn.addEventListener('click', () => {
            fileUploadContainer.classList.remove('hidden');
        });

        closeUpload.addEventListener('click', () => {
            fileUploadContainer.classList.add('hidden');
        });

        fileInputWrapper.addEventListener('click', () => {
            fileInput.click();
        });

        fileInputWrapper.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileInputWrapper.classList.add('dragover');
        });

        fileInputWrapper.addEventListener('dragleave', () => {
            fileInputWrapper.classList.remove('dragover');
        });

        fileInputWrapper.addEventListener('drop', (e) => {
            e.preventDefault();
            fileInputWrapper.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/json') {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        function handleFileUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    loadDemo(json);
                    fileUploadContainer.classList.add('hidden');
                } catch (error) {
                    alert('Invalid JSON file. Please upload a valid demo JSON file.');
                }
            };
            reader.readAsText(file);
        }

        // Demo Loading
        function loadDemo(data) {
            demoData = data;
            currentStepIndex = 0;
            currentTime = 0;
            isPlaying = false;
            
            // Update UI with demo info
            if (data.headerTitle) headerTitle.textContent = data.headerTitle;
            if (data.userName) userName.textContent = data.userName;
            
            // Calculate total duration
            totalDuration = data.demoSteps.reduce((sum, step) => sum + (step.duration || 5000), 0);
            
            // Initialize speech if Azure TTS config is provided
            if (data.azureTTS && data.azureTTS.key !== 'YOUR_AZURE_TTS_KEY') {
                initializeSpeech(data.azureTTS);
            }
            
            // Reset UI
            resetDemo();
            updateStepIndicator();
            updateTimeDisplay();
            
            // Start demo automatically
            setTimeout(() => playDemo(), 500);
        }

        // Speech Synthesis
        function initializeSpeech(config) {
            if (typeof SpeechSDK !== 'undefined') {
                try {
                    const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.key, config.region);
                    speechConfig.speechSynthesisVoiceName = config.voiceName || "en-US-AriaNeural";
                    speechSynthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, null);
                } catch (error) {
                    console.error('Failed to initialize speech:', error);
                }
            }
        }

        function speakText(text) {
            if (!speechSynthesizer || isMuted) return;
            
            speechSynthesizer.speakTextAsync(
                text,
                result => {
                    if (result.reason === SpeechSDK.ResultReason.Canceled) {
                        console.error('Speech synthesis canceled');
                    }
                },
                error => {
                    console.error('Speech error:', error);
                }
            );
        }

        // Demo Controls
        playPauseBtn.addEventListener('click', () => {
            if (isPlaying) {
                pauseDemo();
            } else {
                playDemo();
            }
        });

        restartBtn.addEventListener('click', () => {
            resetDemo();
            playDemo();
        });

        muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
            if (isMuted && speechSynthesizer) {
                speechSynthesizer.close();
                initializeSpeech(demoData.azureTTS);
            }
        });

        progressBar.addEventListener('click', (e) => {
            if (!demoData) return;
            const rect = progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            seekToTime(percent * totalDuration);
        });

        function playDemo() {
            if (!demoData || isPlaying) return;
            isPlaying = true;
            playPauseBtn.innerHTML = '‚è∏';
            stepStartTime = Date.now() - (currentTime % demoData.demoSteps[currentStepIndex].duration);
            animate();
        }

        function pauseDemo() {
            isPlaying = false;
            playPauseBtn.innerHTML = '‚ñ∂';
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }

        function resetDemo() {
            pauseDemo();
            currentStepIndex = 0;
            currentTime = 0;
            clearChat();
            hideNarrator();
            updateProgressBar();
            updateStepIndicator();
            updateTimeDisplay();
        }

        function seekToTime(time) {
            currentTime = Math.max(0, Math.min(time, totalDuration));
            
            // Find the correct step
            let accumulatedTime = 0;
            for (let i = 0; i < demoData.demoSteps.length; i++) {
                const stepDuration = demoData.demoSteps[i].duration || 5000;
                if (accumulatedTime + stepDuration > currentTime) {
                    if (i !== currentStepIndex) {
                        currentStepIndex = i;
                        executeStep(demoData.demoSteps[i]);
                    }
                    stepStartTime = Date.now() - (currentTime - accumulatedTime);
                    break;
                }
                accumulatedTime += stepDuration;
            }
            
            updateProgressBar();
            updateStepIndicator();
            updateTimeDisplay();
        }

        function animate() {
            if (!isPlaying) return;
            
            const now = Date.now();
            const stepDuration = demoData.demoSteps[currentStepIndex].duration || 5000;
            const stepProgress = now - stepStartTime;
            
            if (stepProgress >= stepDuration) {
                // Move to next step
                currentStepIndex++;
                if (currentStepIndex >= demoData.demoSteps.length) {
                    // Demo finished
                    pauseDemo();
                    currentStepIndex = demoData.demoSteps.length - 1;
                    return;
                }
                stepStartTime = now;
                executeStep(demoData.demoSteps[currentStepIndex]);
            }
            
            // Update current time
            let accumulatedTime = 0;
            for (let i = 0; i < currentStepIndex; i++) {
                accumulatedTime += demoData.demoSteps[i].duration || 5000;
            }
            currentTime = accumulatedTime + stepProgress;
            
            updateProgressBar();
            updateTimeDisplay();
            
            animationFrameId = requestAnimationFrame(animate);
        }

        function executeStep(step) {
            updateStepIndicator();
            
            // Show narrator if present
            if (step.narrator) {
                showNarrator(step.narrator);
            } else {
                hideNarrator();
            }
            
            // Handle chat interactions
            if (demoData.chatInteractions) {
                const interactions = demoData.chatInteractions.filter(i => i.stepId === step.id);
                interactions.forEach(interaction => {
                    if (interaction.messages) {
                        interaction.messages.forEach((msg, index) => {
                            setTimeout(() => addMessage(msg), index * 500);
                        });
                    }
                });
            }
            
            // Show agent card if present
            if (demoData.agentCards) {
                const card = demoData.agentCards.find(c => c.stepId === step.id);
                if (card) {
                    setTimeout(() => addAgentCard(card.card), 1000);
                }
            }
            
            // Speak voice text
            if (step.voiceText) {
                speakText(step.voiceText);
            }
        }

        // UI Update Functions
        function updateProgressBar() {
            const percent = (currentTime / totalDuration) * 100;
            progressFill.style.width = percent + '%';
        }

        function updateTimeDisplay() {
            const current = formatTime(currentTime);
            const total = formatTime(totalDuration);
            timeDisplay.textContent = `${current} / ${total}`;
        }

        function updateStepIndicator() {
            if (!demoData) return;
            stepIndicator.textContent = `Step ${currentStepIndex + 1} of ${demoData.demoSteps.length}`;
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Narrator Functions
        function showNarrator(narrator) {
            narratorTitle.textContent = narrator.title || '';
            narratorText.textContent = narrator.text || '';
            narratorSubtitle.textContent = narrator.subtitle || '';
            
            narratorOverlay.className = 'narrator-overlay';
            if (narrator.position) {
                narratorOverlay.classList.add(narrator.position);
            }
            narratorOverlay.style.display = 'block';
        }

        function hideNarrator() {
            narratorOverlay.style.display = 'none';
        }

        // Chat Functions
        function clearChat() {
            chatMessages.innerHTML = '';
        }

        function addMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;
            
            const icon = getMessageIcon(message.type);
            const title = getMessageTitle(message.type);
            const timestamp = message.timestamp || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-icon">${icon}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-title">${title}</span>
                        <span class="message-timestamp">${timestamp}</span>
                    </div>
                    <div class="message-body">${formatMessageText(message.text)}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addAgentCard(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'agent-card';
            
            let detailsHTML = '';
            if (card.details) {
                Object.entries(card.details).forEach(([key, value]) => {
                    detailsHTML += `
                        <div class="detail-item">
                            <div class="detail-key">${key}</div>
                            <div class="detail-value">${value}</div>
                        </div>
                    `;
                });
            }
            
            cardDiv.innerHTML = `
                <div class="agent-card-header">
                    <span class="agent-card-title">${card.title || 'Agent'}</span>
                    ${card.status ? `<span class="agent-card-status ${card.status}">${card.status}</span>` : ''}
                </div>
                <div class="agent-card-details">${detailsHTML}</div>
            `;
            
            chatMessages.appendChild(cardDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getMessageIcon(type) {
            switch(type) {
                case 'user':
                    return 'üë§';
                case 'agent':
                    return '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>';
                case 'system':
                    return '‚öôÔ∏è';
                default:
                    return 'üí¨';
            }
        }

        function getMessageTitle(type) {
            switch(type) {
                case 'user':
                    return demoData?.userName || 'User';
                case 'agent':
                    return 'Copilot';
                case 'system':
                    return 'System';
                default:
                    return 'Message';
            }
        }

        function formatMessageText(text) {
            // Convert markdown-like formatting
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/‚Ä¢/g, '&bull;')
                .replace(/‚úì/g, '‚úÖ')
                .replace(/‚úî/g, '‚úÖ')
                .replace(/‚ùå/g, '‚ùå')
                .replace(/‚ö†Ô∏è/g, '‚ö†Ô∏è');
        }

        // Initialize
        window.addEventListener('load', () => {
            // Try to load a default demo if available
            const defaultDemos = [
                'french-retailer-voice-agent-demo.json',
                'ar-stack-demo.json',
                'universal_data_connector_demo.json',
                'UCLAdmissions.json'
            ];
            
            // You can attempt to load a default demo here if needed
            // For now, just show the upload prompt
            console.log('Demo Player Ready. Click "Load Demo" to upload a JSON file.');
        });
    </script>

    <!-- Azure Speech SDK -->
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
</body>
</html>