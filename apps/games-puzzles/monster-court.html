<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monster Court - Courtroom Drama RPG</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a0a00;color:#f0e6d2;font-family:'Courier New',monospace;overflow:hidden;height:100vh;width:100vw;user-select:none}
#game{width:100%;height:100%;position:relative;overflow:hidden}
#title-screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg,#0a0005 0%,#1a0a2e 40%,#2d1b4e 100%);z-index:100}
#title-screen h1{font-size:clamp(2rem,6vw,4.5rem);color:#ffd700;text-shadow:0 0 30px #ffd700,0 0 60px #ff8c00;letter-spacing:4px;margin-bottom:10px;animation:pulse 2s infinite}
#title-screen h2{font-size:clamp(0.9rem,2.5vw,1.5rem);color:#c0a0ff;margin-bottom:40px;letter-spacing:6px}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
.menu-btn{background:linear-gradient(135deg,#4a2800,#7a4400);border:2px solid #ffd700;color:#ffd700;padding:15px 50px;font-size:1.2rem;font-family:inherit;cursor:pointer;margin:8px;letter-spacing:2px;transition:all .2s;min-width:250px}
.menu-btn:hover,.menu-btn:focus{background:linear-gradient(135deg,#7a4400,#aa6600);transform:scale(1.05);box-shadow:0 0 20px rgba(255,215,0,.4)}
#court-screen{position:absolute;inset:0;display:none;flex-direction:column;background:#2c1810}
#judge-bar{height:50px;background:linear-gradient(90deg,#1a0a00,#2c1810);display:flex;align-items:center;padding:0 20px;border-bottom:2px solid #4a3020;z-index:10}
#judge-meter-container{flex:1;height:24px;background:#1a0a00;border:2px solid #4a3020;border-radius:12px;margin:0 15px;position:relative;overflow:hidden}
#judge-meter{height:100%;width:50%;background:linear-gradient(90deg,#cc3333,#cccc33,#33cc33);transition:width .5s;border-radius:10px}
#judge-label{color:#ffd700;font-size:.8rem;white-space:nowrap}
#strikes-display{color:#ff4444;font-size:1rem;white-space:nowrap}
#case-label{color:#c0a0ff;font-size:.8rem;white-space:nowrap;margin-right:10px}
#courtroom{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column}
#court-bg{position:absolute;inset:0;z-index:0}
#scene-area{flex:1;position:relative;z-index:1;display:flex;justify-content:space-around;align-items:flex-end;padding:10px 20px}
.portrait-box{width:clamp(100px,18vw,200px);height:clamp(140px,25vw,280px);position:relative;display:flex;flex-direction:column;align-items:center}
.portrait-canvas{border:3px solid #4a3020;border-radius:4px;background:#1a1a2e;image-rendering:pixelated}
.portrait-label{color:#ffd700;font-size:.7rem;margin-top:4px;text-align:center;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#dialogue-area{height:clamp(150px,25vh,220px);background:linear-gradient(180deg,#1a0a00,#0d0500);border-top:3px solid #ffd700;padding:15px 20px;z-index:10;display:flex;flex-direction:column;position:relative}
#speaker-name{color:#ffd700;font-size:1rem;font-weight:bold;margin-bottom:8px;min-height:1.2em}
#dialogue-text{color:#f0e6d2;font-size:clamp(.85rem,1.8vw,1.05rem);line-height:1.6;flex:1;overflow-y:auto;white-space:pre-wrap}
#action-buttons{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.action-btn{background:linear-gradient(135deg,#3a1800,#5a2800);border:2px solid #aa7733;color:#ffd700;padding:8px 16px;font-family:inherit;font-size:.8rem;cursor:pointer;letter-spacing:1px;transition:all .15s}
.action-btn:hover,.action-btn.selected{background:linear-gradient(135deg,#6a3800,#8a5800);transform:scale(1.05)}
.action-btn.objection{border-color:#ff4444;color:#ff4444}
.action-btn.objection:hover{background:#3a0000;box-shadow:0 0 15px rgba(255,68,68,.4)}
.action-btn:disabled{opacity:.4;cursor:default;transform:none}
#evidence-panel{position:absolute;right:0;top:0;bottom:0;width:clamp(250px,30vw,350px);background:rgba(10,5,0,.95);border-left:3px solid #ffd700;z-index:20;display:none;flex-direction:column;padding:15px;overflow-y:auto}
#evidence-panel h3{color:#ffd700;margin-bottom:15px;text-align:center}
.evidence-item{background:linear-gradient(135deg,#2a1800,#1a0a00);border:2px solid #4a3020;padding:12px;margin-bottom:10px;cursor:pointer;transition:all .15s}
.evidence-item:hover,.evidence-item.selected{border-color:#ffd700;background:linear-gradient(135deg,#3a2800,#2a1a00)}
.evidence-icon{font-size:1.5rem;float:left;margin-right:10px}
.evidence-name{color:#ffd700;font-size:.9rem;font-weight:bold}
.evidence-desc{color:#c0a0a0;font-size:.75rem;margin-top:5px;clear:both}
#testimony-lines{position:absolute;left:0;right:0;top:0;bottom:0;background:rgba(10,5,0,.97);z-index:25;display:none;flex-direction:column;padding:15px;overflow-y:auto}
#testimony-lines h3{color:#ffd700;margin-bottom:10px;text-align:center}
.testimony-line{background:#1a0a00;border:2px solid #3a2010;padding:10px 15px;margin-bottom:6px;cursor:pointer;transition:all .15s;font-size:.85rem;line-height:1.4;position:relative}
.testimony-line:hover,.testimony-line.active{border-color:#ffd700;background:#2a1a10}
.testimony-line .line-num{color:#aa7733;margin-right:10px;font-weight:bold}
.testimony-line.pressed{border-color:#44aaff}
.testimony-line.broken{border-color:#ff4444;background:#2a0a0a}
#objection-overlay{position:fixed;inset:0;z-index:1000;display:none;align-items:center;justify-content:center;background:rgba(255,0,0,.15)}
#objection-overlay .objection-text{font-size:clamp(3rem,10vw,7rem);color:#ff4444;font-weight:bold;letter-spacing:8px;text-shadow:0 0 30px #ff0000,0 0 60px #ff0000,4px 4px 0 #000;animation:objectionSlam .4s ease-out}
@keyframes objectionSlam{0%{transform:scale(3);opacity:0}60%{transform:scale(.9)}100%{transform:scale(1);opacity:1}}
#flash-overlay{position:fixed;inset:0;z-index:999;background:#fff;opacity:0;pointer-events:none;transition:opacity .05s}
#verdict-screen{position:absolute;inset:0;z-index:50;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(10,5,0,.95)}
#verdict-screen h2{font-size:clamp(2rem,5vw,4rem);margin-bottom:20px}
#verdict-screen p{font-size:1.1rem;margin-bottom:10px;text-align:center;max-width:600px;line-height:1.6}
.verdict-guilty h2{color:#ff4444;text-shadow:0 0 30px #ff0000}
.verdict-not-guilty h2{color:#44ff44;text-shadow:0 0 30px #00ff00}
#case-intro{position:absolute;inset:0;z-index:40;display:none;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg,#0a0005,#1a0a2e);padding:30px}
#case-intro h2{color:#ffd700;font-size:clamp(1.5rem,4vw,2.5rem);margin-bottom:20px}
#case-intro .case-details{max-width:600px;text-align:center;line-height:1.8;font-size:1rem;color:#c0a0ff}
.shake{animation:shake .3s ease-out}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
#mobile-controls{display:none;position:fixed;bottom:0;left:0;right:0;z-index:30;padding:8px;background:rgba(10,5,0,.9);border-top:2px solid #4a3020}
@media(hover:none)and(pointer:coarse){#mobile-controls{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}}
.mobile-btn{background:#2a1800;border:2px solid #aa7733;color:#ffd700;padding:10px 18px;font-family:inherit;font-size:.9rem;cursor:pointer;border-radius:4px;min-width:60px;text-align:center}
.mobile-btn.obj{border-color:#ff4444;color:#ff4444}
#continue-hint{position:absolute;bottom:5px;right:15px;color:#665533;font-size:.7rem;animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:#1a0a00}
::-webkit-scrollbar-thumb{background:#4a3020;border-radius:3px}
</style>
</head>
<body>
<div id="game">
<div id="title-screen">
<h1>‚öñÔ∏è MONSTER COURT</h1>
<h2>COURTROOM DRAMA RPG</h2>
<button class="menu-btn" onclick="startNewGame()">NEW GAME</button>
<button class="menu-btn" onclick="continueGame()">CONTINUE</button>
<p style="color:#665533;margin-top:30px;font-size:.75rem">Arrow Keys / Tap to navigate ‚Ä¢ Enter to select ‚Ä¢ O to object</p>
</div>
<div id="case-intro">
<h2 id="case-intro-title"></h2>
<div class="case-details" id="case-intro-details"></div>
<button class="menu-btn" style="margin-top:30px" onclick="beginTrial()">ENTER COURTROOM</button>
</div>
<div id="court-screen">
<div id="judge-bar">
<span id="case-label">Case 1/5</span>
<span id="judge-label">Judge's Opinion:</span>
<div id="judge-meter-container"><div id="judge-meter"></div></div>
<span id="strikes-display">‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è</span>
</div>
<div id="courtroom">
<canvas id="court-bg"></canvas>
<div id="scene-area">
<div class="portrait-box" id="left-portrait"><canvas class="portrait-canvas" width="120" height="160"></canvas><div class="portrait-label" id="left-label"></div></div>
<div class="portrait-box" id="center-portrait" style="display:none"><canvas class="portrait-canvas" width="120" height="160"></canvas><div class="portrait-label" id="center-label"></div></div>
<div class="portrait-box" id="right-portrait"><canvas class="portrait-canvas" width="120" height="160"></canvas><div class="portrait-label" id="right-label"></div></div>
</div>
<div id="dialogue-area">
<div id="speaker-name"></div>
<div id="dialogue-text"></div>
<div id="action-buttons"></div>
<div id="continue-hint">‚ñº ENTER / TAP</div>
</div>
<div id="evidence-panel"><h3>üìã EVIDENCE</h3><div id="evidence-list"></div><button class="action-btn" style="width:100%;margin-top:10px" onclick="closeEvidence()">BACK</button></div>
<div id="testimony-lines"><h3>üìù TESTIMONY</h3><div id="testimony-list"></div><div id="testimony-actions" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></div></div>
</div>
</div>
<div id="objection-overlay"><div class="objection-text">OBJECTION!</div></div>
<div id="flash-overlay"></div>
<div id="verdict-screen"><h2 id="verdict-title"></h2><p id="verdict-text"></p><button class="menu-btn" id="verdict-btn" style="margin-top:20px"></button></div>
<div id="mobile-controls">
<button class="mobile-btn" onclick="handleKey('ArrowLeft')">‚óÄ</button>
<button class="mobile-btn" onclick="handleKey('ArrowRight')">‚ñ∂</button>
<button class="mobile-btn" onclick="handleKey('Enter')">OK</button>
<button class="mobile-btn" onclick="handleKey('KeyE')">Evidence</button>
<button class="mobile-btn obj" onclick="handleKey('KeyO')">OBJECT!</button>
</div>
</div>
<script>
// ======================== GAME STATE ========================
const GS = {
  phase: 'title', caseNum: 0, totalCases: 5, judgeMeter: 50, strikes: 0, maxStrikes: 3,
  currentCase: null, witnessIndex: 0, statementIndex: 0, typewriterTimer: null,
  textComplete: false, dialogueQueue: [], crossExamMode: false, evidenceOpen: false,
  testimonyOpen: false, selectedEvidence: -1, foundContradictions: new Set(),
  casesWon: 0, usedMonsters: [], awaitingChoice: false, choiceCallback: null, choiceIndex: 0
};

// ======================== MONSTER DEFINITIONS ========================
const MONSTERS = [
  { type:'dragon', name:'Ignis the Ember Dragon', emoji:'üêâ', color:'#cc4400',
    personality:'proud', bodyColor:'#2d8a2d', headColor:'#3aaa3a', eyeColor:'#ff6600', accentColor:'#ffaa00',
    greet:"I am Ignis, of the Northern Peaks. These charges are an insult to dragonkind.",
    worried:"Even the mightiest flame can be extinguished by injustice...",
    happy:"HA! As expected. The truth burns brighter than any fire.",
    sad:"Imprisoned... The skies will remember my name." },
  { type:'kraken', name:'Tethys the Deep Kraken', emoji:'ü¶ë', color:'#4466aa',
    personality:'mysterious', bodyColor:'#2244aa', headColor:'#3355cc', eyeColor:'#00ffcc', accentColor:'#66aaff',
    greet:"The depths sent me to answer these... curious accusations.",
    worried:"The currents of justice run deeper than mortals know...",
    happy:"The ocean's truth cannot be contained. I am free.",
    sad:"Back to the depths... but not by choice this time." },
  { type:'werewolf', name:'Fenris the Reluctant', emoji:'üê∫', color:'#886644',
    personality:'apologetic', bodyColor:'#7a6644', headColor:'#8a7654', eyeColor:'#ffcc00', accentColor:'#aa8866',
    greet:"I-I'm sorry you have to defend me. I really didn't do it, I swear!",
    worried:"Oh no, oh no... they're going to lock me in a silver cage...",
    happy:"Thank you! THANK YOU! *wags tail involuntarily* ...sorry about that.",
    sad:"I... I understand. The moon was full. It always looks bad for my kind." },
  { type:'ghost', name:'Lady Elara the Specter', emoji:'üëª', color:'#aabbcc',
    personality:'melancholic', bodyColor:'#8899bb', headColor:'#aabbdd', eyeColor:'#ccddff', accentColor:'#ffffff',
    greet:"I have been accused... even in death, there is no peace.",
    worried:"Will they exorcise me? I've only just found a place to rest...",
    happy:"Perhaps the living can understand us after all. Thank you.",
    sad:"Another century of wandering, then..." },
  { type:'troll', name:'Grundle the Bridge Keeper', emoji:'üßå', color:'#558844',
    personality:'gruff', bodyColor:'#557744', headColor:'#668855', eyeColor:'#eedd00', accentColor:'#88aa66',
    greet:"Grundle pays taxes! Grundle has LICENSE! This is outrage!",
    worried:"If Grundle loses bridge, where Grundle sleep? UNDER bridge?!",
    happy:"HA! Grundle KNEW it! Justice system not totally broken!",
    sad:"Fine. Grundle go. But who maintain bridge NOW, huh?!" },
  { type:'basilisk', name:'Petra the Shy Basilisk', emoji:'üêç', color:'#88aa44',
    personality:'shy', bodyColor:'#6a8833', headColor:'#7a9944', eyeColor:'#ff3366', accentColor:'#aacc55',
    greet:"*averts gaze* P-please don't look directly at me... I mean, I HAVE been wearing my safety goggles!",
    worried:"*curls up* Everyone always blames the basilisk...",
    happy:"*peeks out* R-really? I can go? Thank you so much! *quickly looks away*",
    sad:"*stone-cold silence* ...I suppose that's fitting." },
  { type:'phoenix', name:'Solara the Reborn', emoji:'üî•', color:'#ff6633',
    personality:'dramatic', bodyColor:'#ff4400', headColor:'#ff6622', eyeColor:'#ffee00', accentColor:'#ffaa33',
    greet:"FROM THE ASHES OF INJUSTICE, I SHALL RISE! ...ahem. Hello, attorney.",
    worried:"Even my eternal flame flickers in the face of such falsehood!",
    happy:"JUSTICE BLAZES ETERNAL! *accidentally sets podium on fire* ...sorry.",
    sad:"I shall be reborn again... but the sting of injustice lingers." },
  { type:'mimic', name:'Chester the Mimic', emoji:'üì¶', color:'#aa8844',
    personality:'shifty', bodyColor:'#8a6633', headColor:'#aa8844', eyeColor:'#ff4444', accentColor:'#ccaa55',
    greet:"*opens lid slightly* Psst! Thanks for taking my case. I'm totally NOT a regular chest. I mean‚ÄîI AM a regular... wait.",
    worried:"*lid chattering nervously* They're gonna lock me in a vault forever!",
    happy:"*happy lid flapping* YES! I mean‚Äî *ahem* ‚Äîthank you for your services. *normal chest noises*",
    sad:"*closes lid slowly* ...click." }
];

// ======================== CASE TEMPLATES ========================
const CASE_TEMPLATES = [
{ monsterType:'dragon', crime:'Arson of the Riverside Market',
  crimeDesc:"The Riverside Market was engulfed in flames on the night of the Harvest Moon. Witnesses claim a dragon was seen near the scene.",
  witnesses:[
    { name:'Marta the Baker', occupation:'Baker', emoji:'üë©‚Äçüç≥',
      statements:[
        "I was closing my bakery at around 9 PM when I saw bright flames outside.",
        "The fire was an unusual BLUE color ‚Äî definitely magical dragon fire!",
        "I heard a tremendous roar just before the flames erupted, shaking my windows.",
        "I saw a large shadow with wings fly over the market right before the fire started.",
        "The fire started on the EAST side of the market, near the fish stalls."
      ],
      contradiction:{ index:1, evidenceId:'fire_report',
        pressTip:"The witness seems very certain about the color...",
        breakText:"W-wait... now that I think about it, it was dark and smoky. Maybe it was more orange? I... I might have been confused by the smoke.",
        explanation:"Dragon fire burns ORANGE with traces of sulfur. Blue flames indicate alchemical accelerant ‚Äî someone PLANTED this fire!" }
    },
    { name:'Guard Captain Hendricks', occupation:'City Guard', emoji:'üíÇ',
      statements:[
        "I arrived at the scene approximately 15 minutes after the first alarm.",
        "My guards found large claw marks on the cobblestones near the market entrance.",
        "We recovered traces of sulfur ‚Äî a clear indicator of dragon involvement.",
        "The defendant was spotted at the Gilded Goblet tavern, but that's ACROSS TOWN from the market.",
        "No other suspects were identified during our investigation."
      ],
      contradiction:{ index:3, evidenceId:'tavern_receipt',
        pressTip:"Interesting ‚Äî the guard mentions the tavern is across town...",
        breakText:"Well... yes, the tavern IS across town. About a 30-minute flight for a dragon. But‚Äîwait, the fire was already burning when I arrived 15 minutes later...",
        explanation:"If the dragon was at the tavern across town, they couldn't have started the fire AND been at the tavern within the timeline!" }
    },
    { name:'Pip the Street Urchin', occupation:'Street kid', emoji:'üë¶',
      statements:[
        "I was sleeping behind the barrels near the market that night.",
        "I saw someone in a DARK CLOAK carrying bottles before the fire started.",
        "There was a funny chemical smell, not like normal fire ‚Äî kinda sweet and sharp.",
        "I ran away when the flames started, but I looked back and saw NO dragon at all.",
        "The cloaked figure ran toward the merchant guild after the fire started."
      ],
      contradiction:{ index:3, evidenceId:'claw_marks',
        pressTip:"Wait ‚Äî Pip was RIGHT THERE and saw no dragon?",
        breakText:"I'm telling you, mister, there was no dragon! Just that person in the cloak! I know what I saw!",
        explanation:"An eyewitness AT the scene saw no dragon ‚Äî only a cloaked arsonist. The 'claw marks' were likely planted!" }
    }
  ],
  evidence:[
    { id:'fire_report', name:'Fire Analysis Report', icon:'üìã', desc:'Lab results: residue is consistent with ALCHEMICAL ACCELERANT, not dragon fire. Dragon fire leaves crystallized carbon ‚Äî none found. Blue flame residue matches common firestarter compounds.' },
    { id:'tavern_receipt', name:'Tavern Receipt', icon:'üßæ', desc:'A receipt from The Gilded Goblet tavern dated the night of the fire at 8:45 PM, with Ignis\'s claw mark. The tavern is 30 minutes across town.' },
    { id:'claw_marks', name:'Claw Mark Analysis', icon:'üîç', desc:'Forensic analysis of the claw marks: scratches are UNIFORM and EVENLY SPACED ‚Äî consistent with a tool, not actual dragon claws which are irregular.' },
    { id:'guild_ledger', name:'Merchant Guild Ledger', icon:'üìí', desc:'Shows the market was heavily insured. The guild master recently increased the policy ‚Äî suspicious timing.' }
  ]
},
{ monsterType:'kraken', crime:'Sinking of the Trading Vessel "Prosperity"',
  crimeDesc:"The merchant ship Prosperity sank in calm waters near Port Azure. The crew claims a kraken attacked. Cargo worth 50,000 gold was lost.",
  witnesses:[
    { name:'Captain Redbeard', occupation:'Ship Captain', emoji:'üßë‚Äç‚úàÔ∏è',
      statements:[
        "We were sailing through calm waters when tentacles burst from the deep!",
        "The beast wrapped around the hull and crushed it like kindling.",
        "I saw the creature clearly ‚Äî it had EIGHT massive tentacles.",
        "The attack lasted about ten minutes before we abandoned ship.",
        "We lost ALL cargo ‚Äî every last crate went to the bottom."
      ],
      contradiction:{ index:2, evidenceId:'kraken_anatomy',
        pressTip:"The captain seems confident about the tentacle count...",
        breakText:"Eight... or was it ten? There were tentacles EVERYWHERE! It was chaos! I‚Äî maybe I miscounted in the panic!",
        explanation:"Krakens have TEN tentacles, not eight. Eight tentacles is a common OCTOPUS. If the captain can't tell the difference, his whole identification is suspect!" }
    },
    { name:'First Mate Jenkins', occupation:'Sailor', emoji:'‚öì',
      statements:[
        "I was below deck when I heard the captain screaming about a sea monster.",
        "When I came up, I saw massive tentacles gripping the port side.",
        "The water was churning with a DARK INK-LIKE substance.",
        "I noticed the hull had ALREADY been taking on water before the attack.",
        "We managed to save the crew but not a single crate of cargo."
      ],
      contradiction:{ index:3, evidenceId:'hull_fragment',
        pressTip:"Wait ‚Äî the hull was ALREADY taking on water BEFORE the attack?",
        breakText:"I... well... there might have been a small leak. But the tentacles made it WAY worse! That's the point!",
        explanation:"The hull was compromised BEFORE any alleged kraken attack! This suggests the ship was DELIBERATELY scuttled ‚Äî insurance fraud!" }
    },
    { name:'Harbor Inspector Walsh', occupation:'Inspector', emoji:'üîé',
      statements:[
        "I inspected the Prosperity just three days before its final voyage.",
        "The ship passed all safety checks with flying colors ‚Äî perfect condition.",
        "I found no evidence of kraken activity in the shipping lanes that month.",
        "The captain filed an insurance claim within HOURS of being rescued.",
        "The cargo manifest listed standard trade goods ‚Äî nothing unusual."
      ],
      contradiction:{ index:1, evidenceId:'inspection_log',
        pressTip:"Perfect condition, you say? Let's verify that...",
        breakText:"Well... I mean, there were some minor issues in the lower hull, but nothing that would... oh. You have the actual report?",
        explanation:"The REAL inspection report shows SEVENTEEN hull violations! The inspector falsified records ‚Äî he's in on the insurance scam!" }
    }
  ],
  evidence:[
    { id:'kraken_anatomy', name:'Marine Biology Textbook', icon:'üìö', desc:'Standard reference: Krakens possess TEN primary tentacles, distinct from octopi which have EIGHT. This is a fundamental taxonomic difference.' },
    { id:'hull_fragment', name:'Recovered Hull Fragment', icon:'ü™µ', desc:'Fragment from the Prosperity shows damage patterns consistent with INTERNAL pressure (explosive scuttling charges), not external tentacle crushing.' },
    { id:'inspection_log', name:'Original Inspection Report', icon:'üìù', desc:'The ORIGINAL report (not the filed copy) lists 17 hull violations and a recommendation to GROUND the vessel. Someone replaced this with a clean report.' },
    { id:'insurance_docs', name:'Insurance Documents', icon:'üí∞', desc:'Captain Redbeard tripled the cargo insurance ONE WEEK before the voyage. The beneficiary is a shell company linked to the harbor inspector.' }
  ]
},
{ monsterType:'werewolf', crime:'Livestock Attacks in Millfield Village',
  crimeDesc:"Twelve sheep have been killed in Millfield Village over the past month. Bite marks match a large canine. A werewolf was seen near the pastures.",
  witnesses:[
    { name:'Farmer Gregory', occupation:'Sheep Farmer', emoji:'üßë‚Äçüåæ',
      statements:[
        "I've lost twelve of my best sheep this month! Something's been tearing them apart!",
        "The attacks always happen on FULL MOON nights ‚Äî classic werewolf behavior.",
        "I found huge paw prints near the sheep pen ‚Äî much bigger than any normal wolf.",
        "I saw the beast myself last Tuesday ‚Äî it was standing upright like a man-wolf!",
        "The creature had SILVER-GREY fur, just like that werewolf sitting right there!"
      ],
      contradiction:{ index:1, evidenceId:'lunar_calendar',
        pressTip:"EVERY attack on a full moon? Let's check that...",
        breakText:"Well... most of them! At least the worst ones! ...Fine, SOME were on regular nights too. But the full moon ones were DEFINITELY worse!",
        explanation:"The lunar calendar shows attacks occurred on SEVEN different nights ‚Äî only TWO were full moons! Werewolves ONLY transform during full moons. This is a regular predator!" }
    },
    { name:'Dr. Helena Marsh', occupation:'Veterinarian', emoji:'üë©‚Äç‚öïÔ∏è',
      statements:[
        "I examined the remains of several sheep. The bite patterns are from a very large canine.",
        "The wounds are consistent with a SINGLE predator ‚Äî one animal, not a pack.",
        "I found traces of a SEDATIVE in the sheep's blood ‚Äî they were drugged before being attacked.",
        "The bite radius suggests jaws approximately 8 inches wide ‚Äî werewolf-sized.",
        "In my professional opinion, this is clearly the work of a supernatural predator."
      ],
      contradiction:{ index:2, evidenceId:'sedative_report',
        pressTip:"A sedative? Why would a werewolf need to drug its prey?",
        breakText:"I... that IS unusual for a werewolf attack. Werewolves don't typically use... I mean, they CAN'T use drugs. They're in a feral state...",
        explanation:"Werewolves in transformed state operate on PURE INSTINCT ‚Äî they cannot prepare and administer sedatives! Someone is drugging the sheep and staging attacks!" }
    },
    { name:'Night Watchman Boris', occupation:'Village Watch', emoji:'üèÆ',
      statements:[
        "I patrol the village every night from dusk till dawn.",
        "I saw a large wolf-like creature near the pastures on three separate occasions.",
        "Each time, it fled toward the WESTERN woods when it spotted my lantern.",
        "On the night of the worst attack, I was called away to the EASTERN bridge for a disturbance.",
        "When I returned, six sheep were dead and I found the werewolf's tracks."
      ],
      contradiction:{ index:3, evidenceId:'disturbance_log',
        pressTip:"A conveniently timed disturbance pulling the guard away...",
        breakText:"Now that you mention it... the disturbance at the bridge was just some knocked-over barrels. Nobody was there when I arrived. Almost like... a diversion?",
        explanation:"Someone created a DIVERSION to lure the watchman away from the pastures! This was a coordinated attack ‚Äî not a mindless werewolf!" }
    }
  ],
  evidence:[
    { id:'lunar_calendar', name:'Lunar Calendar', icon:'üåô', desc:'Official astronomical calendar showing moon phases for the past month. Attacks occurred on 7 different nights ‚Äî only 2 were full moons. Werewolves can ONLY transform during full moon phases.' },
    { id:'sedative_report', name:'Alchemist\'s Report', icon:'‚öóÔ∏è', desc:'Analysis of sheep blood: contains Moonsbane, a powerful animal sedative available at any apothecary. Werewolves in transformed state cannot handle, measure, or administer drugs.' },
    { id:'disturbance_log', name:'Watch Log Book', icon:'üìì', desc:'The "disturbance" that called Boris away was just toppled barrels ‚Äî no perpetrator found. Every major attack coincides with Boris being called to a false alarm elsewhere.' },
    { id:'rival_farm', name:'Land Deed Records', icon:'üìú', desc:'Farmer Gregory\'s neighbor, Lord Ashworth, has been trying to buy Gregory\'s land for years. His gamekeeper owns several large hunting dogs.' }
  ]
},
{ monsterType:'ghost', crime:'Haunting and Property Damage at Thornfield Manor',
  crimeDesc:"The new owners of Thornfield Manor report violent ghostly activity ‚Äî flying objects, broken furniture, and terrifying apparitions driving away guests.",
  witnesses:[
    { name:'Lord Pemberton', occupation:'Manor Owner', emoji:'üé©',
      statements:[
        "I purchased Thornfield Manor six months ago as a luxury inn.",
        "The haunting began IMMEDIATELY ‚Äî the very first night, furniture flew across rooms!",
        "My guests have been terrorized! China smashing, doors slamming, ghostly wailing!",
        "I've lost THOUSANDS in refunds and repairs. This ghost is ruining my business!",
        "The ghost appears every night WITHOUT FAIL, always between 10 PM and midnight."
      ],
      contradiction:{ index:4, evidenceId:'ghost_theory',
        pressTip:"Every night without fail? That's unusually regular for a haunting...",
        breakText:"Well, yes, it's very predictable! Almost like clockwork! Which is... actually rather unusual for a ghost, isn't it?",
        explanation:"Real hauntings are IRREGULAR and tied to emotional anchors, not schedules! Clockwork 'haunting' suggests a MECHANICAL setup ‚Äî someone is faking it!" }
    },
    { name:'Maid Rosa', occupation:'Servant', emoji:'üßπ',
      statements:[
        "I've worked at Thornfield for three years ‚Äî through two previous owners.",
        "Lady Elara's ghost has been here long before Lord Pemberton bought the place.",
        "The ghost was always PEACEFUL before ‚Äî just cold spots and a sad melody at night.",
        "The VIOLENT activity only started after Lord Pemberton's renovation of the east wing.",
        "I've seen wires and pulleys hidden behind the new wallpaper in the east wing."
      ],
      contradiction:{ index:4, evidenceId:'renovation_plans',
        pressTip:"Wires and pulleys? That's very specific...",
        breakText:"I tried to tell Lord Pemberton but he dismissed me! Those wires aren't part of any normal renovation ‚Äî they're attached to furniture and wall panels!",
        explanation:"Hidden MECHANICAL DEVICES are rigged to create fake 'haunting' effects! Lord Pemberton is STAGING the haunting ‚Äî likely for an insurance claim!" }
    },
    { name:'Paranormal Investigator Drake', occupation:'Ghost Hunter', emoji:'üîÆ',
      statements:[
        "I was hired by Lord Pemberton to document the haunting for his insurance claim.",
        "My equipment detected genuine spectral energy in the manor ‚Äî level 3 on the Ecto-Scale.",
        "However, the VIOLENT phenomena registered ZERO on my spectral sensors.",
        "The flying furniture showed no ectoplasmic residue ‚Äî ghosts ALWAYS leave residue.",
        "In my professional opinion, there are TWO phenomena: a real gentle ghost and a fake poltergeist."
      ],
      contradiction:{ index:0, evidenceId:'insurance_claim',
        pressTip:"Wait ‚Äî he was hired specifically for an INSURANCE CLAIM?",
        breakText:"Yes, Lord Pemberton specifically asked me to document 'evidence of supernatural damage' for his insurer. He was very insistent on getting dramatic footage...",
        explanation:"Lord Pemberton hired the investigator specifically to BUILD AN INSURANCE CASE! He's using the real ghost as cover for staged property damage!" }
    }
  ],
  evidence:[
    { id:'ghost_theory', name:'Paranormal Studies Handbook', icon:'üìñ', desc:'Chapter 7: "Genuine hauntings are triggered by emotional resonance, never following regular schedules. Regular timed events indicate mechanical or human intervention."' },
    { id:'renovation_plans', name:'Renovation Blueprints', icon:'üìê', desc:'East wing renovation plans show hidden channels in walls marked "special effects rigging." The architect confirms these are NOT standard construction features.' },
    { id:'insurance_claim', name:'Insurance Claim Filing', icon:'üíº', desc:'Lord Pemberton filed a massive insurance claim for "supernatural property damage" ‚Äî but the policy was taken out just ONE MONTH before the "violent haunting" began.' },
    { id:'elara_diary', name:'Lady Elara\'s Diary', icon:'üìî', desc:'Found in the manor library. Last entry: "I only wish to watch over my beloved garden. I would never harm this house ‚Äî it is all I have left."' }
  ]
},
{ monsterType:'troll', crime:'Extortion and Illegal Toll Collection at Stone Bridge',
  crimeDesc:"Travelers report being forced to pay exorbitant tolls to cross Stone Bridge. Those who refuse are threatened with violence. A troll controls the bridge.",
  witnesses:[
    { name:'Merchant Thomas', occupation:'Trader', emoji:'üß≥',
      statements:[
        "I cross Stone Bridge twice a week for my trade route to the eastern markets.",
        "The troll charges FIVE GOLD per crossing ‚Äî outrageous for a simple bridge!",
        "When I refused to pay, the troll GROWLED at me and blocked the path with his body.",
        "I had no choice ‚Äî there's NO OTHER ROUTE to the eastern markets.",
        "I've paid over 500 gold this year alone! It's highway robbery!"
      ],
      contradiction:{ index:3, evidenceId:'map_routes',
        pressTip:"No other route? Is that really true?",
        breakText:"Well... I SUPPOSE there's the southern road. But it adds two hours to my journey! It's incredibly inconvenient!",
        explanation:"There IS an alternative route! The bridge toll is OPTIONAL ‚Äî merchants choose it for convenience. This isn't extortion, it's a TOLL SERVICE!" }
    },
    { name:'Magistrate Cromwell', occupation:'Local Official', emoji:'‚öñÔ∏è',
      statements:[
        "The troll has been operating this toll bridge for FIFTEEN years without a permit.",
        "Multiple complaints have been filed about aggressive behavior at the bridge.",
        "The troll collects an estimated 10,000 gold per year in tolls.",
        "This revenue goes ENTIRELY to the troll ‚Äî no taxes paid to the township.",
        "I've been trying to shut this operation down since I took office LAST YEAR."
      ],
      contradiction:{ index:0, evidenceId:'bridge_permit',
        pressTip:"Fifteen years without a permit? Let's verify that claim...",
        breakText:"I... what? There IS a permit? Let me see that! ...This is dated fifteen years ago, signed by my predecessor. I was told no permit existed!",
        explanation:"Grundle HAS a valid bridge operation permit, properly filed and signed! The magistrate either lied or didn't do basic research!" }
    },
    { name:'Engineer Patricia', occupation:'Bridge Inspector', emoji:'üë∑‚Äç‚ôÄÔ∏è',
      statements:[
        "I inspect all bridges in the county for structural safety.",
        "Stone Bridge is in EXCELLENT condition ‚Äî far better than any other bridge in the region.",
        "The troll personally maintains the bridge ‚Äî replaces stones, clears moss, reinforces supports.",
        "Without the troll's maintenance, that bridge would have collapsed YEARS ago.",
        "The county hasn't spent a SINGLE coin on Stone Bridge maintenance since the troll took over."
      ],
      contradiction:{ index:4, evidenceId:'county_budget',
        pressTip:"The county spent nothing on maintenance? Interesting...",
        breakText:"That's right ‚Äî the troll does ALL the work. Honestly, the county should be THANKING him. Other bridges get far less care and they're falling apart.",
        explanation:"The troll provides a VALUABLE PUBLIC SERVICE! The bridge is maintained at ZERO cost to taxpayers. The toll is payment for legitimate maintenance work!" }
    }
  ],
  evidence:[
    { id:'map_routes', name:'Regional Map', icon:'üó∫Ô∏è', desc:'Map shows THREE alternative routes to the eastern markets. The southern road adds only 2 hours. Bridge crossing is convenient but entirely OPTIONAL.' },
    { id:'bridge_permit', name:'Bridge Operation Permit', icon:'üìã', desc:'Official permit #4472, issued 15 years ago by then-Magistrate Eldrin, authorizing Grundle to "operate, maintain, and collect reasonable tolls for Stone Bridge." Still legally valid.' },
    { id:'county_budget', name:'County Budget Records', icon:'üí∞', desc:'County infrastructure budget shows ZERO allocated for Stone Bridge for 15 years. Other bridges cost the county 800-2000 gold per year in maintenance. Grundle saves taxpayers ~25,000 gold.' },
    { id:'toll_comparison', name:'Regional Toll Records', icon:'üìä', desc:'Comparable toll bridges charge 3-8 gold per crossing. Grundle\'s 5 gold toll is EXACTLY the regional average. Not extortionate at all.' }
  ]
},
{ monsterType:'basilisk', crime:'Petrification of Three Villagers in Sundale',
  crimeDesc:"Three residents of Sundale were found turned to stone in the town square. A basilisk matching Petra's description was seen in the area.",
  witnesses:[
    { name:'Mayor Henderson', occupation:'Town Mayor', emoji:'üèõÔ∏è',
      statements:[
        "Three of our citizens were found petrified at dawn on the morning of the 14th.",
        "All three were positioned near the central fountain in the town square.",
        "A basilisk was spotted entering town from the NORTH road the evening before.",
        "Our town has NEVER had a petrification incident before this creature arrived.",
        "We demand justice and the restoration of our citizens!"
      ],
      contradiction:{ index:2, evidenceId:'gate_log',
        pressTip:"From the north road, you say? Let's check the records...",
        breakText:"The... the gate log? Well, our gate guards record all unusual visitors. Let me see... hmm. This doesn't mention a basilisk at the north gate...",
        explanation:"The gate log shows NO basilisk entered through the north gate! Petra entered from the SOUTH, and was seen wearing her safety goggles the ENTIRE time!" }
    },
    { name:'Alchemist Vera', occupation:'Alchemist', emoji:'üß™',
      statements:[
        "I analyzed the petrification ‚Äî it's INSTANTANEOUS stone conversion, classic basilisk work.",
        "The stone is high-quality marble-like material, consistent with basilisk petrification.",
        "I found NO trace of petrification potion residue on the victims.",
        "Basilisk petrification is the ONLY known way to turn flesh to stone instantly.",
        "There is simply no other explanation for this phenomenon."
      ],
      contradiction:{ index:3, evidenceId:'alchemy_text',
        pressTip:"The ONLY known way? That's a bold claim for an alchemist...",
        breakText:"Well... there IS Medusa's Draught, a rare petrification potion. But it's incredibly difficult to brew and‚Äîoh. Oh no. You don't think...?",
        explanation:"Medusa's Draught CAN cause instantaneous petrification! An alchemist of Vera's skill could ABSOLUTELY brew it. The alchemist herself is a suspect!" }
    },
    { name:'Witness Samuel', occupation:'Fisherman', emoji:'üé£',
      statements:[
        "I was walking home from the docks at about 11 PM when I passed the town square.",
        "I saw the three people standing near the fountain, talking normally.",
        "Then I saw a hooded figure approach them from behind the fountain.",
        "There was a bright FLASH of green light and when I looked again, they were stone!",
        "I ran away. When I looked back, the hooded figure was GONE and I saw a snake-like shape slither away."
      ],
      contradiction:{ index:3, evidenceId:'goggle_cert',
        pressTip:"A bright FLASH? Basilisk petrification doesn't produce light...",
        breakText:"It... doesn't? But I definitely saw a green flash! Like a potion or a spell! Come to think of it, the figure was HOLDING something...",
        explanation:"Basilisk gaze is SILENT and produces NO LIGHT! A green flash indicates an ALCHEMICAL reaction ‚Äî someone threw Medusa's Draught! The hooded figure is the real culprit!" }
    }
  ],
  evidence:[
    { id:'gate_log', name:'Town Gate Log', icon:'üìã', desc:'Gate records for the 13th show Petra entered from the SOUTH gate at 2 PM, wearing certified safety goggles. She visited the apothecary for goggle polish and left at 4 PM.' },
    { id:'alchemy_text', name:'Advanced Alchemy Reference', icon:'üìö', desc:'"Medusa\'s Draught: A rare but achievable petrification potion. Causes instantaneous flesh-to-stone conversion with a characteristic GREEN FLASH upon contact. Requires moonstone, gorgon blood, and basilisk shed-skin."' },
    { id:'goggle_cert', name:'Safety Goggle Certificate', icon:'ü•Ω', desc:'Official certification that Petra\'s safety goggles are Grade-A Petrification Suppressors, inspected monthly. Her gaze CANNOT petrify while wearing them. Last inspection: 3 days before the incident.' },
    { id:'shed_skin', name:'Stolen Skin Report', icon:'üóûÔ∏è', desc:'Petra filed a report 2 weeks ago: someone STOLE her shed basilisk skin from outside her den. Basilisk shed-skin is a KEY INGREDIENT in Medusa\'s Draught.' }
  ]
},
{ monsterType:'phoenix', crime:'The Great Pinewood Forest Wildfire',
  crimeDesc:"Pinewood Forest, 500 acres of ancient woodland, burned in a massive wildfire. Rangers spotted a phoenix flying over the forest that day.",
  witnesses:[
    { name:'Ranger Collins', occupation:'Forest Ranger', emoji:'üå≤',
      statements:[
        "I was on patrol when I spotted the fire starting in the northwest section around 2 PM.",
        "I saw a phoenix ‚Äî unmistakable with those flaming wings ‚Äî circling ABOVE the forest.",
        "The fire spread incredibly fast, consuming 500 acres in just four hours.",
        "Phoenix fire is UNQUENCHABLE ‚Äî that's why our water brigade couldn't stop it.",
        "In twenty years of service, I've never seen a fire spread like that."
      ],
      contradiction:{ index:3, evidenceId:'fire_brigade',
        pressTip:"Unquenchable? But was the fire actually fought?",
        breakText:"Well, our water brigade DID respond... and actually, the water DID slow the fire on the eastern front. If it were true phoenix fire, water would have been useless...",
        explanation:"Phoenix fire is MAGICAL and cannot be extinguished by water! The fact that the water brigade SUCCESSFULLY fought sections proves this was ORDINARY fire, not phoenix fire!" }
    },
    { name:'Logger McManus', occupation:'Lumber Company Rep', emoji:'ü™ì',
      statements:[
        "Our company had logging rights in Pinewood Forest ‚Äî this fire destroyed our livelihood!",
        "We had over 200,000 gold worth of timber contracts set to begin NEXT MONTH.",
        "The phoenix must have been nesting in the forest ‚Äî they're attracted to old-growth trees.",
        "We demand full compensation for our lost contracts from the defendant.",
        "We've been pressuring the Forest Council to approve our logging permits for YEARS."
      ],
      contradiction:{ index:1, evidenceId:'logging_permit',
        pressTip:"Timber contracts set for next month? That's convenient timing...",
        breakText:"I‚Äî yes, we had contracts. The Forest Council FINALLY approved them after years of... environmental concerns. The fire is a TRAGEDY for us!",
        explanation:"The logging company had contracts worth 200,000 gold ‚Äî but the Forest Council was about to REVOKE them due to endangered species! A fire destroys the evidence and triggers insurance. MOTIVE!" }
    },
    { name:'Druid Willow', occupation:'Forest Guardian', emoji:'üßù',
      statements:[
        "I commune with the forest daily. The trees were SCREAMING that afternoon.",
        "The fire origin point was near an old hollow oak ‚Äî a place with NO natural ignition source.",
        "I found EMPTY OIL BARRELS hidden in a ravine near the fire's origin point.",
        "A phoenix's presence in a forest is actually BENEFICIAL ‚Äî they promote new growth.",
        "The forest was due for a controlled burn anyway; the logging company had been blocking it."
      ],
      contradiction:{ index:2, evidenceId:'oil_barrels',
        pressTip:"Empty oil barrels at the origin point? That's not natural...",
        breakText:"That's what I'VE been saying! Phoenixes don't need BARRELS to start fires! Someone deliberately set this blaze with accelerants!",
        explanation:"Oil barrels at the fire's origin prove ARSON with mundane accelerants! A phoenix wouldn't carry oil barrels ‚Äî this fire was SET by someone with a profit motive!" }
    }
  ],
  evidence:[
    { id:'fire_brigade', name:'Fire Brigade Report', icon:'üöí', desc:'Official report: "Water suppression was PARTIALLY EFFECTIVE on the eastern fire line." Phoenix fire is completely immune to water suppression. This fire responded to water = NOT phoenix fire.' },
    { id:'logging_permit', name:'Logging Permit Documents', icon:'üìã', desc:'Forest Council internal memo: "Logging permits for Pinewood set for EMERGENCY REVOCATION due to discovery of endangered Silverleaf habitat. Vote scheduled for next week." The fire destroyed the evidence.' },
    { id:'oil_barrels', name:'Oil Barrel Evidence', icon:'ÔøΩÔøΩÔ∏è', desc:'Three empty industrial oil barrels found in a ravine 50 meters from the fire origin. Barrels stamped with McManus Lumber Company logo. Traces of kerosene match the fire accelerant.' },
    { id:'phoenix_nature', name:'Phoenix Ecology Study', icon:'üî¨', desc:'Academic paper: "Phoenix fire causes controlled, SLOW burns that promote forest regeneration. Phoenix fire has never been documented causing destructive wildfires. Their presence PREVENTS devastating fires."' }
  ]
},
{ monsterType:'mimic', crime:'Identity Theft and Fraud Against the Royal Treasury',
  crimeDesc:"Someone impersonated the Royal Tax Collector and diverted 100,000 gold into fake accounts. A mimic was seen near the treasury.",
  witnesses:[
    { name:'Treasury Clerk Abigail', occupation:'Treasury Clerk', emoji:'üíº',
      statements:[
        "On the 5th of the month, the Tax Collector came to process the quarterly revenue.",
        "Everything seemed normal ‚Äî he had proper identification and knew the procedures.",
        "He redirected funds to THREE new accounts, claiming they were approved overflow accounts.",
        "I noticed his signature was SLIGHTLY different, but he said he'd hurt his hand.",
        "After he left, the REAL Tax Collector showed up. That's when we realized the fraud."
      ],
      contradiction:{ index:1, evidenceId:'security_log',
        pressTip:"Proper identification? Let's check what identification was used...",
        breakText:"He showed a Treasury Badge ‚Äî but now that you mention it, he entered through the SIDE door, not the main entrance. Our security checkpoint is at the MAIN entrance...",
        explanation:"The impostor bypassed the main security checkpoint! A mimic wouldn't need to ‚Äî they can perfectly replicate badges. But someone who STOLE a badge would avoid the checkpoint where it could be scanned!" }
    },
    { name:'Guard Sergeant Morris', occupation:'Treasury Guard', emoji:'üõ°Ô∏è',
      statements:[
        "I was on duty at the side entrance that day. A man in tax collector uniform approached.",
        "He showed valid credentials, so I let him through the side entrance.",
        "I noticed a WOODEN CHEST being carried by his assistant ‚Äî said it was for document transport.",
        "About thirty minutes later, ONLY the man left. No chest, no assistant.",
        "I thought nothing of it until the alarm was raised an hour later."
      ],
      contradiction:{ index:3, evidenceId:'chest_evidence',
        pressTip:"The chest went IN but never came OUT? Interesting...",
        breakText:"You're right ‚Äî the chest never left through my entrance. And the other exits were all monitored too. Where did it go? Unless...",
        explanation:"The chest ‚Äî Chester ‚Äî went IN as a 'chest' carried by an accomplice, then SHIFTED into the Tax Collector form to commit the fraud. But Chester LEFT in human form. He was used as a PROP, not the mastermind!" }
    },
    { name:'Tax Collector Whitmore', occupation:'Royal Tax Collector', emoji:'üè¶',
      statements:[
        "I arrived at my usual time of 2 PM to find the fraud had already been committed.",
        "Whoever impersonated me knew EXACT treasury procedures ‚Äî this is INSIDER knowledge.",
        "The redirected funds went to accounts at three different banks under false names.",
        "I've been the Tax Collector for TWELVE years with a spotless record.",
        "Only FOUR people know the quarterly processing codes: myself, the Chancellor, and two senior clerks."
      ],
      contradiction:{ index:4, evidenceId:'code_access',
        pressTip:"Only four people know the codes? Who exactly?",
        breakText:"Myself, Chancellor Graves, Senior Clerk Davidson, and Senior Clerk... Abigail. Wait ‚Äî Abigail is the one who processed the fake transactions!",
        explanation:"Only FOUR people knew the codes ‚Äî and one of them is the witness who 'helpfully' processed the fraud! Abigail is the inside person. Chester was just used as a disguise prop!" }
    }
  ],
  evidence:[
    { id:'security_log', name:'Security Gate Log', icon:'üìã', desc:'Main entrance security log shows NO tax collector badge was scanned on the 5th. The impostor used the SIDE entrance to avoid electronic badge verification.' },
    { id:'chest_evidence', name:'Chester\'s Testimony', icon:'üì¶', desc:'Chester admits: "A human HIRED me to look like a chest and then look like a person. Said it was for a theater performance. Paid me 50 gold. I didn\'t know about any theft!"' },
    { id:'code_access', name:'Access Code Registry', icon:'üîê', desc:'Treasury security records show only 4 people have quarterly processing codes. One of them is Senior Clerk Abigail ‚Äî the very witness who processed the fraudulent transactions.' },
    { id:'bank_records', name:'Bank Account Trace', icon:'üè¶', desc:'The three fake accounts were opened with identification documents forged by a HUMAN forger, not a mimic. Paper trail leads to a known criminal associate of Clerk Davidson.' }
  ]
}
];

// ======================== PIXEL ART RENDERER ========================
const PORTRAITS = {
  dragon:(ctx,w,h,expr)=>{
    const s=Math.floor(w/16);
    const c=(x,y,color)=>{ctx.fillStyle=color;ctx.fillRect(x*s,y*s,s,s)};
    const body='#2d8a2d',head='#3aaa3a',eye=expr==='worried'?'#ffaa00':'#ff6600',horn='#ccaa00',mouth='#cc3333';
    [[5,1],[6,1],[9,1],[10,1]].forEach(p=>c(p[0],p[1],horn));
    [[5,2],[6,2],[9,2],[10,2]].forEach(p=>c(p[0],p[1],horn));
    for(let x=4;x<=11;x++)c(x,3,head);for(let x=3;x<=12;x++){c(x,4,head);c(x,5,head);c(x,6,head)}
    c(5,5,eye);c(6,5,eye);c(9,5,eye);c(10,5,eye);c(5,4,'#000');c(10,4,'#000');
    if(expr==='happy'){for(let x=5;x<=10;x++)c(x,7,'#cc3333')}else{for(let x=6;x<=9;x++)c(x,7,mouth)}
    for(let x=4;x<=11;x++){c(x,8,body);c(x,9,body);c(x,10,body);c(x,11,body)}
    [[3,8],[3,9],[12,8],[12,9]].forEach(p=>c(p[0],p[1],body));
    [[2,6],[2,7],[2,8],[1,7],[13,6],[13,7],[13,8],[14,7]].forEach(p=>c(p[0],p[1],'#1d6a1d'));
    for(let x=5;x<=10;x++){c(x,12,body);c(x,13,body)}
    [[5,14],[6,14],[9,14],[10,14]].forEach(p=>c(p[0],p[1],body));
  },
  kraken:(ctx,w,h,expr)=>{
    const s=Math.floor(w/16);
    const c=(x,y,color)=>{ctx.fillStyle=color;ctx.fillRect(x*s,y*s,s,s)};
    const body='#3355aa',light='#4477cc',eye=expr==='worried'?'#88ddff':'#00ffcc';
    for(let x=4;x<=11;x++){c(x,2,body);c(x,3,body)}
    for(let x=3;x<=12;x++){c(x,4,body);c(x,5,body);c(x,6,body);c(x,7,body)}
    c(5,5,eye);c(6,5,eye);c(9,5,eye);c(10,5,eye);
    for(let x=3;x<=12;x++){c(x,8,body);c(x,9,body)}
    [[3,10],[4,10],[5,10],[6,10],[7,10],[8,10],[9,10],[10,10],[11,10],[12,10]].forEach(p=>c(p[0],p[1],light));
    [[2,11],[3,11],[5,11],[6,11],[9,11],[10,11],[12,11],[13,11]].forEach(p=>c(p[0],p[1],light));
    [[1,12],[2,12],[5,12],[6,12],[9,12],[10,12],[13,12],[14,12]].forEach(p=>c(p[0],p[1],light));
    [[1,13],[6,13],[9,13],[14,13]].forEach(p=>c(p[0],p[1],light));
    [[0,14],[7,14],[8,14],[15,14]].forEach(p=>c(p[0],p[1],light));
  },
  werewolf:(ctx,w,h,expr)=>{
    const s=Math.floor(w/16);
    const c=(x,y,color)=>{ctx.fillStyle=color;ctx.fillRect(x*s,y*s,s,s)};
    const fur='#8a7654',dark='#6a5634',eye=expr==='worried'?'#ff8800':'#ffcc00',nose='#333';
    [[4,0],[5,0],[10,0],[11,0]].forEach(p=>c(p[0],p[1],dark));
    [[4,1],[5,1],[6,1],[9,1],[10,1],[11,1]].forEach(p=>c(p[0],p[1],fur));
    for(let x=4;x<=11;x++){c(x,2,fur);c(x,3,fur);c(x,4,fur);c(x,5,fur)}
    c(5,3,eye);c(6,3,eye);c(9,3,eye);c(10,3,eye);c(7,5,nose);c(8,5,nose);
    if(expr==='happy'){c(6,6,'#cc4444');c(7,6,'#cc4444');c(8,6,'#cc4444');c(9,6,'#cc4444')}
    for(let x=5;x<=10;x++){c(x,7,fur);c(x,8,fur);c(x,9,fur);c(x,10,fur)}
    [[4,7],[4,8],[11,7],[11,8]].forEach(p=>c(p[0],p[1],fur));
    [[3,9],[3,10],[12,9],[12,10]].forEach(p=>c(p[0],p[1],dark));
    for(let x=5;x<=10;x++){c(x,11,dark);c(x,12,dark)}
    [[5,13],[6,13],[9,13],[10,13],[5,14],[6,14],[9,14],[10,14]].forEach(p=>c(p[0],p[1],dark));
  },
  ghost:(ctx,w,h,expr)=>{
    const s=Math.floor(w/16);
    const c=(x,y,color)=>{ctx.fillStyle=color;ctx.fillRect(x*s,y*s,s,s)};
    const body='rgba(170,187,221,0.7)',eye=expr==='worried'?'#aaccff':'#ddeeff';
    for(let x=5;x<=10;x++)c(x,1,body);
    for(let x=4;x<=11;x++){c(x,2,body);c(x,3,body);c(x,4,body);c(x,5,body)}
    c(5,4,eye);c(6,4,eye);c(9,4,eye);c(10,4,eye);c(5,3,'#667');c(10,3,'#667');
    if(expr==='sad'){c(7,6,'#99aabb');c(8,6,'#99aabb')}
    for(let x=3;x<=12;x++){c(x,6,body);c(x,7,body);c(x,8,body);c(x,9,body);c(x,10,body);c(x,11,body)}
    [[3,12],[4,12],[5,12],[7,12],[8,12],[10,12],[11,12],[12,12]].forEach(p=>c(p[0],p[1],body));
    [[3,13],[4,13],[7,13],[8,13],[11,13],[12,13]].forEach(p=>c(p[0],p[1],body));
  },
  troll:(ctx,w,h,expr)=>{
    const s=Math.floor(w/16);
    const c=(x,y,color)=>{ctx.fillStyle=color;ctx.fillRect(x*s,y*s,s,s)};
    const body='#668855',dark='#557744',eye=expr==='worried'?'#ddcc00':'#eedd00';
    for(let x=4;x<=11;x++){c(x,1,body);c(x,2,body)}
    for(let x=3;x<=12;x++){c(x,3,body);c(x,4,body);c(x,5,body);c(x,6,body)}
    c(4,4,eye);c(5,4,eye);c(10,4,eye);c(11,4,eye);
    c(7,5,'#557744');c(8,5,'#557744');
    if(expr==='happy'){for(let x=5;x<=10;x++)c(x,6,'#444')}else{c(6,7,'#444');c(7,7,'#444');c(8,7,'#444');c(9,7,'#444')}
    for(let x=3;x<=12;x++){c(x,7,dark);c(x,8,dark);c(x,9,dark);c(x,10,dark);c(x,11,dark)}
    [[2,8],[2,9],[2,10],[13,8],[13,9],[13,10]].forEach(p=>c(p[0],p[1],body));
    for(let x=4;x<=11;x++){c(x,12,dark)}
    [[4,13],[5,13],[6,13],[9,13],[10,13],[11,13]].forEach(p=>c(p[0],p[1],dark));
    [[4,14],[5,14],[10,14],[11,14]].forEach(p=>c(p[0],p[1],dark));
  },
  basilisk:(ctx,w,h,expr)=>{
    const s=Math.floor(w/16);
    const c=(x,y,color)=>{ctx.fillStyle=color;ctx.fillRect(x*s,y*s,s,s)};
    const body='#7a9944',dark='#5a7733',eye='#ff3366',goggle='#aaddff';
    for(let x=5;x<=10;x++){c(x,2,body);c(x,3,body)}
    for(let x=4;x<=11;x++){c(x,4,body);c(x,5,body);c(x,6,body)}
    c(5,4,goggle);c(6,4,goggle);c(9,4,goggle);c(10,4,goggle);
    c(5,5,eye);c(10,5,eye);c(7,4,'#888');c(8,4,'#888');
    for(let x=3;x<=12;x++){c(x,7,body);c(x,8,body)}
    for(let x=4;x<=11;x++){c(x,9,body);c(x,10,body);c(x,11,body)}
    [[3,10],[3,11],[12,10],[12,11]].forEach(p=>c(p[0],p[1],dark));
    for(let x=5;x<=10;x++){c(x,12,dark);c(x,13,dark)}
    [[5,14],[6,14],[7,14],[8,14]].forEach(p=>c(p[0],p[1],dark));
  },
  phoenix:(ctx,w,h,expr)=>{
    const s=Math.floor(w/16);
    const c=(x,y,color)=>{ctx.fillStyle=color;ctx.fillRect(x*s,y*s,s,s)};
    const body='#ff5522',light='#ffaa33',eye='#ffee00',wing='#ff3300';
    [[6,0],[7,0],[8,0],[9,0]].forEach(p=>c(p[0],p[1],'#ffcc00'));
    [[5,1],[6,1],[7,1],[8,1],[9,1],[10,1]].forEach(p=>c(p[0],p[1],light));
    for(let x=4;x<=11;x++){c(x,2,body);c(x,3,body);c(x,4,body);c(x,5,body)}
    c(5,3,eye);c(6,3,eye);c(9,3,eye);c(10,3,eye);
    c(7,5,'#ffcc00');c(8,5,'#ffcc00');
    [[2,4],[2,5],[2,6],[1,5],[1,6],[0,6],[13,4],[13,5],[13,6],[14,5],[14,6],[15,6]].forEach(p=>c(p[0],p[1],wing));
    for(let x=4;x<=11;x++){c(x,6,body);c(x,7,body);c(x,8,body);c(x,9,body)}
    for(let x=5;x<=10;x++){c(x,10,light);c(x,11,light)}
    [[5,12],[6,12],[7,12],[8,12],[9,12],[10,12]].forEach(p=>c(p[0],p[1],light));
    [[6,13],[7,13],[8,13],[9,13]].forEach(p=>c(p[0],p[1],'#ffcc00'));
    [[7,14],[8,14]].forEach(p=>c(p[0],p[1],'#ffcc00'));
  },
  mimic:(ctx,w,h,expr)=>{
    const s=Math.floor(w/16);
    const c=(x,y,color)=>{ctx.fillStyle=color;ctx.fillRect(x*s,y*s,s,s)};
    const wood='#8a6633',dark='#6a4422',metal='#ccaa55',eye='#ff4444';
    if(expr==='happy'){
      for(let x=3;x<=12;x++){c(x,2,dark);c(x,3,wood)}
      for(let x=3;x<=12;x++)c(x,4,dark);
    }else{
      for(let x=3;x<=12;x++)c(x,4,dark);
    }
    for(let x=3;x<=12;x++){c(x,5,wood);c(x,6,wood);c(x,7,wood);c(x,8,wood);c(x,9,wood);c(x,10,wood);c(x,11,wood)}
    for(let x=3;x<=12;x++)c(x,12,dark);
    c(3,7,metal);c(12,7,metal);c(7,7,metal);c(8,7,metal);
    if(expr!=='sad'){c(5,5,eye);c(6,5,eye);c(9,5,eye);c(10,5,eye)}
    [[3,5],[3,6],[3,7],[3,8],[3,9],[3,10],[3,11],[12,5],[12,6],[12,7],[12,8],[12,9],[12,10],[12,11]].forEach(p=>c(p[0],p[1],dark));
    if(expr==='happy'){
      for(let x=5;x<=10;x++)c(x,10,'#cc4444');
      c(4,9,'#fff');c(11,9,'#fff');c(4,10,'#fff');c(11,10,'#fff');
    }
  },
  judge:(ctx,w,h)=>{
    const s=Math.floor(w/16);
    const c=(x,y,color)=>{ctx.fillStyle=color;ctx.fillRect(x*s,y*s,s,s)};
    for(let x=4;x<=11;x++){c(x,0,'#ddd');c(x,1,'#ddd')}
    [[3,1],[12,1],[3,2],[12,2]].forEach(p=>c(p[0],p[1],'#ccc'));
    for(let x=4;x<=11;x++){c(x,2,'#f5d0a9');c(x,3,'#f5d0a9');c(x,4,'#f5d0a9');c(x,5,'#f5d0a9')}
    c(5,3,'#333');c(6,3,'#333');c(9,3,'#333');c(10,3,'#333');
    c(7,5,'#cc8866');c(8,5,'#cc8866');
    for(let x=3;x<=12;x++){c(x,7,'#222');c(x,8,'#222');c(x,9,'#222');c(x,10,'#222');c(x,11,'#222');c(x,12,'#222')}
    c(7,7,'#ffd700');c(8,7,'#ffd700');
  },
  prosecutor:(ctx,w,h)=>{
    const s=Math.floor(w/16);
    const c=(x,y,color)=>{ctx.fillStyle=color;ctx.fillRect(x*s,y*s,s,s)};
    for(let x=5;x<=10;x++){c(x,1,'#333');c(x,2,'#333')}
    for(let x=4;x<=11;x++){c(x,3,'#f5d0a9');c(x,4,'#f5d0a9');c(x,5,'#f5d0a9')}
    c(5,4,'#336');c(6,4,'#336');c(9,4,'#336');c(10,4,'#336');
    c(7,5,'#c88');c(8,5,'#c88');
    if(true){c(6,6,'#c88');c(9,6,'#c88')}
    for(let x=3;x<=12;x++){c(x,7,'#440000');c(x,8,'#440000');c(x,9,'#440000');c(x,10,'#440000');c(x,11,'#440000')}
    c(7,7,'#888');c(8,7,'#888');
    for(let x=4;x<=11;x++)c(x,12,'#440000');
  },
  witness:(ctx,w,h,emoji)=>{
    const s=Math.floor(w/16);
    ctx.font=`${s*8}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(emoji||'üë§',w/2,h/2);
  }
};

// ======================== CASE GENERATOR ========================
function generateCase(caseNum) {
  const available = CASE_TEMPLATES.filter(t => !GS.usedMonsters.includes(t.monsterType));
  let template;
  if (caseNum === GS.totalCases) {
    // Final case: pick a specific one for the "guilty client" twist
    const guilty = available.length > 0 ? available[available.length - 1] : CASE_TEMPLATES[CASE_TEMPLATES.length - 1];
    template = JSON.parse(JSON.stringify(guilty));
    template.isGuilty = true;
  } else {
    const idx = Math.floor(Math.random() * available.length);
    template = JSON.parse(JSON.stringify(available[idx]));
    template.isGuilty = false;
  }
  GS.usedMonsters.push(template.monsterType);
  const monster = MONSTERS.find(m => m.type === template.monsterType);
  // Scale difficulty
  const difficulty = caseNum;
  if (difficulty >= 3) {
    // Add red herring evidence for harder cases
    template.evidence.push({
      id: 'red_herring_' + caseNum,
      name: 'Mysterious Note',
      icon: 'üìù',
      desc: 'An anonymous note reading: "The truth is not what it seems." Unsigned and untraceable. Probably irrelevant.'
    });
  }
  if (difficulty >= 4) {
    template.evidence.push({
      id: 'red_herring2_' + caseNum,
      name: 'Witness Sketch',
      icon: 'üñºÔ∏è',
      desc: 'A rough sketch of a shadowy figure. Too vague to identify anyone specific. Could be anyone ‚Äî or anything.'
    });
  }
  // Shuffle witness statement order slightly for variety (keep contradiction index correct)
  template.witnesses.forEach(w => {
    // Add pressure level tracking
    w.pressed = new Array(w.statements.length).fill(false);
    w.broken = false;
  });
  return { ...template, monster, difficulty };
}

// ======================== DRAWING FUNCTIONS ========================
function drawCourtBackground() {
  const canvas = document.getElementById('court-bg');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
  const ctx = canvas.getContext('2d');
  // Wooden courtroom background
  const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
  grad.addColorStop(0, '#1a0a00');
  grad.addColorStop(0.3, '#2c1810');
  grad.addColorStop(0.7, '#3a2010');
  grad.addColorStop(1, '#1a0a00');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  // Wood paneling lines
  ctx.strokeStyle = 'rgba(100,60,20,0.3)';
  ctx.lineWidth = 1;
  for (let y = 0; y < canvas.height; y += 30) {
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }
  // Vertical pillars
  ctx.fillStyle = 'rgba(80,40,10,0.4)';
  ctx.fillRect(0, 0, 30, canvas.height);
  ctx.fillRect(canvas.width - 30, 0, 30, canvas.height);
  // Judge bench (top center)
  ctx.fillStyle = '#2a1500';
  ctx.fillRect(canvas.width * 0.3, 10, canvas.width * 0.4, 40);
  ctx.strokeStyle = '#ffd700';
  ctx.lineWidth = 2;
  ctx.strokeRect(canvas.width * 0.3, 10, canvas.width * 0.4, 40);
  // Gallery railing
  ctx.fillStyle = '#3a1a00';
  ctx.fillRect(0, canvas.height * 0.15, canvas.width, 8);
}

function drawPortrait(canvasEl, type, expression) {
  const ctx = canvasEl.getContext('2d');
  ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
  // Background
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, canvasEl.width, canvasEl.height);
  if (PORTRAITS[type]) {
    PORTRAITS[type](ctx, canvasEl.width, canvasEl.height, expression);
  }
}

function drawWitnessPortrait(canvasEl, emoji) {
  const ctx = canvasEl.getContext('2d');
  ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
  ctx.fillStyle = '#1a1a2e';
  ctx.fillRect(0, 0, canvasEl.width, canvasEl.height);
  PORTRAITS.witness(ctx, canvasEl.width, canvasEl.height, emoji);
}

// ======================== UI HELPERS ========================
function updateJudgeMeter() {
  GS.judgeMeter = Math.max(0, Math.min(100, GS.judgeMeter));
  document.getElementById('judge-meter').style.width = GS.judgeMeter + '%';
  let strikes = '';
  for (let i = 0; i < GS.maxStrikes; i++) {
    strikes += i < GS.strikes ? '‚ùå' : '‚ö†Ô∏è';
  }
  document.getElementById('strikes-display').textContent = strikes;
  document.getElementById('case-label').textContent = `Case ${GS.caseNum}/${GS.totalCases}`;
}

function showScreen(id) {
  ['title-screen', 'court-screen', 'case-intro', 'verdict-screen'].forEach(s => {
    document.getElementById(s).style.display = 'none';
  });
  document.getElementById(id).style.display = id === 'court-screen' ? 'flex' : 'flex';
}

// ======================== DIALOGUE SYSTEM ========================
let typewriterText = '';
let typewriterIndex = 0;
let typewriterSpeed = 25;

function typewrite(text, callback) {
  clearInterval(GS.typewriterTimer);
  typewriterText = text;
  typewriterIndex = 0;
  GS.textComplete = false;
  const textEl = document.getElementById('dialogue-text');
  textEl.textContent = '';
  document.getElementById('continue-hint').style.display = 'none';
  GS.typewriterTimer = setInterval(() => {
    if (typewriterIndex < typewriterText.length) {
      textEl.textContent += typewriterText[typewriterIndex];
      typewriterIndex++;
    } else {
      clearInterval(GS.typewriterTimer);
      GS.textComplete = true;
      document.getElementById('continue-hint').style.display = 'block';
      if (callback) callback();
    }
  }, typewriterSpeed);
}

function completeTypewriter() {
  if (!GS.textComplete) {
    clearInterval(GS.typewriterTimer);
    document.getElementById('dialogue-text').textContent = typewriterText;
    GS.textComplete = true;
    document.getElementById('continue-hint').style.display = 'block';
    return true; // consumed the input
  }
  return false;
}

function setSpeaker(name) {
  document.getElementById('speaker-name').textContent = name;
}

function clearActions() {
  document.getElementById('action-buttons').innerHTML = '';
  GS.awaitingChoice = false;
  GS.choiceCallback = null;
}

function showActions(actions) {
  const container = document.getElementById('action-buttons');
  container.innerHTML = '';
  GS.awaitingChoice = true;
  GS.choiceIndex = 0;
  actions.forEach((action, i) => {
    const btn = document.createElement('button');
    btn.className = 'action-btn' + (action.className ? ' ' + action.className : '') + (i === 0 ? ' selected' : '');
    btn.textContent = action.label;
    btn.onclick = () => {
      GS.awaitingChoice = false;
      clearActions();
      action.callback();
    };
    container.appendChild(btn);
  });
  GS.choiceCallback = (idx) => {
    if (actions[idx]) {
      GS.awaitingChoice = false;
      clearActions();
      actions[idx].callback();
    }
  };
}

function navigateChoice(dir) {
  if (!GS.awaitingChoice) return;
  const btns = document.querySelectorAll('#action-buttons .action-btn');
  if (btns.length === 0) return;
  btns[GS.choiceIndex].classList.remove('selected');
  GS.choiceIndex = (GS.choiceIndex + dir + btns.length) % btns.length;
  btns[GS.choiceIndex].classList.add('selected');
}

function selectChoice() {
  if (GS.awaitingChoice && GS.choiceCallback) {
    GS.choiceCallback(GS.choiceIndex);
  }
}

// ======================== EFFECTS ========================
function flashScreen(color, duration) {
  const el = document.getElementById('flash-overlay');
  el.style.background = color || '#fff';
  el.style.opacity = '1';
  setTimeout(() => { el.style.transition = `opacity ${duration || 300}ms`; el.style.opacity = '0'; }, 50);
  setTimeout(() => { el.style.transition = 'opacity 0.05s'; }, (duration || 300) + 100);
}

function shakeScreen() {
  const el = document.getElementById('courtroom');
  el.classList.remove('shake');
  void el.offsetWidth;
  el.classList.add('shake');
  setTimeout(() => el.classList.remove('shake'), 400);
}

function showObjection(who) {
  const overlay = document.getElementById('objection-overlay');
  const textEl = overlay.querySelector('.objection-text');
  textEl.textContent = who === 'prosecution' ? 'OBJECTION!' : 'OBJECTION!';
  textEl.style.color = who === 'prosecution' ? '#ff4444' : '#44aaff';
  overlay.style.display = 'flex';
  flashScreen(who === 'prosecution' ? '#ff000033' : '#0044ff33', 500);
  shakeScreen();
  setTimeout(() => { overlay.style.display = 'none'; }, 1200);
}

// ======================== EVIDENCE PANEL ========================
function openEvidencePanel(forPresentation, callback) {
  const panel = document.getElementById('evidence-panel');
  const list = document.getElementById('evidence-list');
  list.innerHTML = '';
  GS.evidenceOpen = true;
  GS.selectedEvidence = 0;
  GS.currentCase.evidence.forEach((ev, i) => {
    const div = document.createElement('div');
    div.className = 'evidence-item' + (i === 0 ? ' selected' : '');
    div.innerHTML = `<span class="evidence-icon">${ev.icon}</span><div class="evidence-name">${ev.name}</div><div class="evidence-desc">${ev.desc}</div>`;
    div.onclick = () => {
      if (forPresentation && callback) {
        GS.evidenceOpen = false;
        panel.style.display = 'none';
        callback(ev);
      } else {
        document.querySelectorAll('.evidence-item').forEach(e => e.classList.remove('selected'));
        div.classList.add('selected');
        GS.selectedEvidence = i;
      }
    };
    list.appendChild(div);
  });
  panel.style.display = 'flex';
}

function closeEvidence() {
  document.getElementById('evidence-panel').style.display = 'none';
  GS.evidenceOpen = false;
}

function navigateEvidence(dir) {
  const items = document.querySelectorAll('.evidence-item');
  if (items.length === 0) return;
  items[GS.selectedEvidence].classList.remove('selected');
  GS.selectedEvidence = (GS.selectedEvidence + dir + items.length) % items.length;
  items[GS.selectedEvidence].classList.add('selected');
  items[GS.selectedEvidence].scrollIntoView({ block: 'nearest' });
}

// ======================== DIALOGUE QUEUE ========================
function queueDialogue(entries) {
  GS.dialogueQueue = entries;
  GS.dialogueQueueIndex = 0;
  playNextDialogue();
}

function playNextDialogue() {
  if (GS.dialogueQueueIndex >= GS.dialogueQueue.length) {
    if (GS.dialogueQueue.onComplete) GS.dialogueQueue.onComplete();
    return;
  }
  const entry = GS.dialogueQueue[GS.dialogueQueueIndex];
  if (entry.speaker) setSpeaker(entry.speaker);
  if (entry.portrait) {
    updatePortraits(entry.portrait);
  }
  if (entry.action) {
    entry.action();
    GS.dialogueQueueIndex++;
    if (entry.noWait) {
      playNextDialogue();
    }
    return;
  }
  typewrite(entry.text, () => {
    if (entry.choices) {
      showActions(entry.choices);
    }
  });
}

function advanceDialogue() {
  if (GS.evidenceOpen || GS.testimonyOpen) return;
  if (GS.awaitingChoice) return;
  if (completeTypewriter()) return;
  GS.dialogueQueueIndex++;
  playNextDialogue();
}

function updatePortraits(config) {
  const lCanvas = document.querySelector('#left-portrait .portrait-canvas');
  const rCanvas = document.querySelector('#right-portrait .portrait-canvas');
  const cBox = document.getElementById('center-portrait');
  const cCanvas = cBox.querySelector('.portrait-canvas');
  if (config.left) {
    drawPortrait(lCanvas, config.left.type, config.left.expr);
    document.getElementById('left-label').textContent = config.left.label || '';
  }
  if (config.right) {
    if (config.right.isWitness) {
      drawWitnessPortrait(rCanvas, config.right.emoji);
    } else {
      drawPortrait(rCanvas, config.right.type, config.right.expr);
    }
    document.getElementById('right-label').textContent = config.right.label || '';
  }
  if (config.center) {
    cBox.style.display = 'flex';
    if (config.center.isWitness) {
      drawWitnessPortrait(cCanvas, config.center.emoji);
    } else {
      drawPortrait(cCanvas, config.center.type, config.center.expr);
    }
    document.getElementById('center-label').textContent = config.center.label || '';
  } else {
    cBox.style.display = 'none';
  }
}

// ======================== TRIAL PHASES ========================
function startCase() {
  GS.caseNum++;
  GS.judgeMeter = 50;
  GS.strikes = 0;
  GS.witnessIndex = 0;
  GS.statementIndex = 0;
  GS.foundContradictions = new Set();
  GS.crossExamMode = false;
  GS.currentCase = generateCase(GS.caseNum);
  updateJudgeMeter();
  // Show case intro
  showScreen('case-intro');
  const c = GS.currentCase;
  document.getElementById('case-intro-title').textContent = `Case ${GS.caseNum}: ${c.crime}`;
  let details = `Your client: ${c.monster.emoji} ${c.monster.name}\n\n`;
  details += `Charge: ${c.crime}\n\n`;
  details += c.crimeDesc + '\n\n';
  if (c.isGuilty) {
    details += '‚ö†Ô∏è CONFIDENTIAL: Your client has privately admitted guilt.\nYou must find procedural errors and witness inconsistencies to win.\n\n';
  }
  details += `Witnesses: ${c.witnesses.length} | Evidence items: ${c.evidence.length}`;
  document.getElementById('case-intro-details').textContent = details;
}

function beginTrial() {
  showScreen('court-screen');
  drawCourtBackground();
  const c = GS.currentCase;
  // Opening sequence
  const entries = [
    { speaker: '‚öñÔ∏è Judge Ironwood', text: `Court is now in session for the trial of ${c.monster.name}.`,
      portrait: { left: { type: c.monster.type, expr: 'normal', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
    { speaker: '‚öñÔ∏è Judge Ironwood', text: `The defendant is charged with: ${c.crime}.` },
    { speaker: 'üî¥ Prosecutor Vex', text: `Your Honor, the prosecution will prove beyond doubt that ${c.monster.name} is guilty of this heinous crime!`,
      portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'prosecutor', label: 'Prosecutor Vex' } } },
    { speaker: 'üî¥ Prosecutor Vex', text: `We have ${c.witnesses.length} witnesses who will testify to the defendant's guilt, and damning evidence to present.` },
    { speaker: 'üîµ You (Defense)', text: `Your Honor, the defense is ready. We will show that ${c.monster.name} is innocent of these charges!`,
      portrait: { left: { type: c.monster.type, expr: 'normal', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
    { speaker: c.monster.emoji + ' ' + c.monster.name, text: c.monster.greet,
      portrait: { left: { type: c.monster.type, expr: 'normal', label: c.monster.name }, right: { type: 'prosecutor', label: 'Prosecutor Vex' } } },
    { speaker: '‚öñÔ∏è Judge Ironwood', text: 'The prosecution may call its first witness.',
      portrait: { left: { type: c.monster.type, expr: 'normal', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
  ];
  entries.onComplete = () => startWitnessTestimony(0);
  queueDialogue(entries);
}

function startWitnessTestimony(witnessIdx) {
  GS.witnessIndex = witnessIdx;
  const c = GS.currentCase;
  if (witnessIdx >= c.witnesses.length) {
    startClosingArguments();
    return;
  }
  const w = c.witnesses[witnessIdx];
  GS.statementIndex = 0;
  const entries = [
    { speaker: 'üî¥ Prosecutor Vex', text: `The prosecution calls ${w.name} to the stand!`,
      portrait: { left: { type: c.monster.type, expr: 'normal', label: c.monster.name }, right: { isWitness: true, emoji: w.emoji, label: w.name } } },
    { speaker: '‚öñÔ∏è Judge Ironwood', text: `${w.name}, please give your testimony regarding the incident.` },
    { speaker: '‚Äî WITNESS TESTIMONY ‚Äî', text: `${w.name} (${w.occupation}) takes the stand...`,
      portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { isWitness: true, emoji: w.emoji, label: w.name } } },
  ];
  // Add each statement as dialogue
  w.statements.forEach((stmt, i) => {
    entries.push({
      speaker: w.emoji + ' ' + w.name,
      text: `"${stmt}"`,
      portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { isWitness: true, emoji: w.emoji, label: w.name } }
    });
  });
  entries.push({
    speaker: '‚öñÔ∏è Judge Ironwood',
    text: 'The defense may now cross-examine the witness.',
  });
  entries.onComplete = () => startCrossExamination(witnessIdx);
  queueDialogue(entries);
}

function startCrossExamination(witnessIdx) {
  GS.crossExamMode = true;
  GS.testimonyOpen = true;
  GS.statementIndex = 0;
  const c = GS.currentCase;
  const w = c.witnesses[witnessIdx];
  const panel = document.getElementById('testimony-lines');
  const list = document.getElementById('testimony-list');
  const actions = document.getElementById('testimony-actions');
  list.innerHTML = '';
  w.statements.forEach((stmt, i) => {
    const div = document.createElement('div');
    div.className = 'testimony-line' + (i === 0 ? ' active' : '') + (w.pressed[i] ? ' pressed' : '');
    if (w.broken && i === w.contradiction.index) div.className += ' broken';
    div.innerHTML = `<span class="line-num">${i + 1}.</span> "${stmt}"`;
    div.onclick = () => selectTestimonyLine(i);
    list.appendChild(div);
  });
  // Action buttons
  actions.innerHTML = '';
  const pressBtn = document.createElement('button');
  pressBtn.className = 'action-btn';
  pressBtn.textContent = 'üîç PRESS (Enter)';
  pressBtn.onclick = () => pressStatement();
  actions.appendChild(pressBtn);
  const presentBtn = document.createElement('button');
  presentBtn.className = 'action-btn';
  presentBtn.textContent = 'üìã PRESENT (E)';
  presentBtn.onclick = () => presentEvidence();
  actions.appendChild(presentBtn);
  const objectBtn = document.createElement('button');
  objectBtn.className = 'action-btn objection';
  objectBtn.textContent = '‚ö° OBJECTION! (O)';
  objectBtn.onclick = () => objectToStatement();
  actions.appendChild(objectBtn);
  const doneBtn = document.createElement('button');
  doneBtn.className = 'action-btn';
  doneBtn.textContent = '‚úì DONE';
  doneBtn.onclick = () => finishCrossExam();
  actions.appendChild(doneBtn);
  panel.style.display = 'flex';
  setSpeaker('‚Äî CROSS-EXAMINATION ‚Äî');
  document.getElementById('dialogue-text').textContent = 'Select a statement to examine. Press, Present evidence, or Object!';
  document.getElementById('continue-hint').style.display = 'none';
}

function selectTestimonyLine(idx) {
  GS.statementIndex = idx;
  const lines = document.querySelectorAll('.testimony-line');
  lines.forEach(l => l.classList.remove('active'));
  if (lines[idx]) lines[idx].classList.add('active');
}

function navigateTestimony(dir) {
  const w = GS.currentCase.witnesses[GS.witnessIndex];
  const newIdx = Math.max(0, Math.min(w.statements.length - 1, GS.statementIndex + dir));
  selectTestimonyLine(newIdx);
}

function pressStatement() {
  const c = GS.currentCase;
  const w = c.witnesses[GS.witnessIndex];
  const idx = GS.statementIndex;
  if (w.pressed[idx]) {
    document.getElementById('dialogue-text').textContent = "You've already pressed this statement.";
    return;
  }
  w.pressed[idx] = true;
  const lines = document.querySelectorAll('.testimony-line');
  if (lines[idx]) lines[idx].classList.add('pressed');
  // Close testimony panel temporarily to show dialogue
  document.getElementById('testimony-lines').style.display = 'none';
  GS.testimonyOpen = false;
  if (idx === w.contradiction.index) {
    // Pressing the contradiction line - give a hint
    const entries = [
      { speaker: 'üîµ You (Defense)', text: `Can you elaborate on that statement?` },
      { speaker: w.emoji + ' ' + w.name, text: w.contradiction.pressTip,
        portrait: { left: { type: c.monster.type, expr: 'normal', label: c.monster.name }, right: { isWitness: true, emoji: w.emoji, label: w.name } } },
      { speaker: 'üí≠', text: '(That response was suspicious... Maybe I should PRESENT some evidence here, or OBJECT!)' },
    ];
    entries.onComplete = () => { reopenTestimony(); };
    GS.judgeMeter += 3;
    updateJudgeMeter();
    queueDialogue(entries);
  } else {
    // Normal press - witness elaborates, minor info
    const elaborations = [
      "I'm certain of what I said. I stand by my testimony.",
      "That's what happened. I have nothing more to add.",
      "I've told you everything I know about that.",
      "Are you trying to confuse me? My statement is clear!",
      "I remember it vividly. It happened exactly as I described."
    ];
    const entries = [
      { speaker: 'üîµ You (Defense)', text: 'Could you tell us more about that?' },
      { speaker: w.emoji + ' ' + w.name, text: elaborations[idx % elaborations.length],
        portrait: { left: { type: c.monster.type, expr: 'normal', label: c.monster.name }, right: { isWitness: true, emoji: w.emoji, label: w.name } } },
    ];
    entries.onComplete = () => { reopenTestimony(); };
    queueDialogue(entries);
  }
}

function presentEvidence() {
  document.getElementById('testimony-lines').style.display = 'none';
  GS.testimonyOpen = false;
  openEvidencePanel(true, (evidence) => {
    checkEvidencePresentation(evidence);
  });
}

function checkEvidencePresentation(evidence) {
  const c = GS.currentCase;
  const w = c.witnesses[GS.witnessIndex];
  const stmtIdx = GS.statementIndex;
  const contradiction = w.contradiction;
  if (stmtIdx === contradiction.index && evidence.id === contradiction.evidenceId) {
    // CORRECT! Contradiction found!
    GS.foundContradictions.add(`${GS.witnessIndex}_${stmtIdx}`);
    w.broken = true;
    flashScreen('#44ff4444', 500);
    shakeScreen();
    showObjection('defense');
    setTimeout(() => {
      const entries = [
        { speaker: 'üîµ You (Defense)', text: `TAKE THAT! This evidence directly contradicts your testimony!`,
          portrait: { left: { type: c.monster.type, expr: 'normal', label: c.monster.name }, right: { isWitness: true, emoji: w.emoji, label: w.name } } },
        { speaker: 'üîµ You (Defense)', text: `${evidence.name}: ${evidence.desc}` },
        { speaker: w.emoji + ' ' + w.name, text: contradiction.breakText },
        { speaker: 'üîµ You (Defense)', text: contradiction.explanation },
        { speaker: '‚öñÔ∏è Judge Ironwood', text: 'The court takes note of this contradiction. The witness\'s credibility is severely damaged.',
          portrait: { left: { type: c.monster.type, expr: 'happy', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
        { speaker: c.monster.emoji + ' ' + c.monster.name, text: c.monster.type === 'werewolf' ? '*tail wagging intensifies*' : 'Excellent work, attorney!',
          portrait: { left: { type: c.monster.type, expr: 'happy', label: c.monster.name }, right: { isWitness: true, emoji: w.emoji, label: w.name } } },
      ];
      GS.judgeMeter += 20;
      updateJudgeMeter();
      entries.onComplete = () => { reopenTestimony(); };
      queueDialogue(entries);
    }, 1300);
  } else if (stmtIdx === contradiction.index) {
    // Right statement, wrong evidence
    const entries = [
      { speaker: 'üîµ You (Defense)', text: `I present this evidence: ${evidence.name}!` },
      { speaker: 'üî¥ Prosecutor Vex', text: 'Objection! That evidence has no bearing on this particular testimony!',
        portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'prosecutor', label: 'Prosecutor Vex' } } },
      { speaker: '‚öñÔ∏è Judge Ironwood', text: 'Sustained. Defense, please present relevant evidence only.',
        portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
    ];
    GS.judgeMeter -= 5;
    updateJudgeMeter();
    entries.onComplete = () => { reopenTestimony(); };
    queueDialogue(entries);
  } else if (evidence.id === contradiction.evidenceId) {
    // Right evidence, wrong statement
    const entries = [
      { speaker: 'üîµ You (Defense)', text: `I present ${evidence.name} against this testimony!` },
      { speaker: '‚öñÔ∏è Judge Ironwood', text: "Hmm... the evidence is interesting, but I fail to see how it contradicts THIS specific statement.",
        portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
      { speaker: 'üí≠', text: '(The evidence is right, but I need to use it on a DIFFERENT statement...)' },
    ];
    GS.judgeMeter -= 3;
    updateJudgeMeter();
    entries.onComplete = () => { reopenTestimony(); };
    queueDialogue(entries);
  } else {
    // Both wrong
    const entries = [
      { speaker: 'üîµ You (Defense)', text: `This evidence proves‚Äî` },
      { speaker: 'üî¥ Prosecutor Vex', text: 'Objection! Irrelevant!',
        portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'prosecutor', label: 'Prosecutor Vex' } } },
      { speaker: '‚öñÔ∏è Judge Ironwood', text: 'Sustained. The defense will refrain from wasting the court\'s time.' },
    ];
    GS.judgeMeter -= 7;
    updateJudgeMeter();
    entries.onComplete = () => { reopenTestimony(); };
    queueDialogue(entries);
  }
}

function objectToStatement() {
  const c = GS.currentCase;
  const w = c.witnesses[GS.witnessIndex];
  const idx = GS.statementIndex;
  document.getElementById('testimony-lines').style.display = 'none';
  GS.testimonyOpen = false;
  if (idx === w.contradiction.index && !w.broken) {
    // Correct objection!
    showObjection('defense');
    setTimeout(() => {
      const entries = [
        { speaker: 'üîµ You (Defense)', text: 'OBJECTION! This statement contains a clear contradiction!',
          portrait: { left: { type: c.monster.type, expr: 'normal', label: c.monster.name }, right: { isWitness: true, emoji: w.emoji, label: w.name } } },
        { speaker: '‚öñÔ∏è Judge Ironwood', text: 'The defense raises an interesting point. Can you back this up with evidence?',
          portrait: { left: { type: c.monster.type, expr: 'normal', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
        { speaker: 'üí≠', text: '(Good ‚Äî the judge is listening! Now I need to PRESENT the right evidence to prove it!)',
          choices: [
            { label: 'üìã PRESENT EVIDENCE', callback: () => {
              openEvidencePanel(true, (evidence) => {
                if (evidence.id === w.contradiction.evidenceId) {
                  GS.foundContradictions.add(`${GS.witnessIndex}_${idx}`);
                  w.broken = true;
                  flashScreen('#44ff4444', 500);
                  shakeScreen();
                  GS.judgeMeter += 25;
                  updateJudgeMeter();
                  const entries2 = [
                    { speaker: 'üîµ You (Defense)', text: `HERE is the proof! ${evidence.name}!` },
                    { speaker: w.emoji + ' ' + w.name, text: w.contradiction.breakText,
                      portrait: { left: { type: c.monster.type, expr: 'happy', label: c.monster.name }, right: { isWitness: true, emoji: w.emoji, label: w.name } } },
                    { speaker: 'üîµ You (Defense)', text: w.contradiction.explanation },
                    { speaker: '‚öñÔ∏è Judge Ironwood', text: 'Devastating! The testimony is struck from the record!',
                      portrait: { left: { type: c.monster.type, expr: 'happy', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
                  ];
                  entries2.onComplete = () => { reopenTestimony(); };
                  queueDialogue(entries2);
                } else {
                  GS.judgeMeter -= 10;
                  GS.strikes++;
                  updateJudgeMeter();
                  const entries2 = [
                    { speaker: '‚öñÔ∏è Judge Ironwood', text: 'That evidence does not support your objection. Strike against the defense!',
                      portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
                  ];
                  if (GS.strikes >= GS.maxStrikes) {
                    entries2.push({ speaker: '‚öñÔ∏è Judge Ironwood', text: 'That is your THIRD strike! The court is losing patience with the defense!' });
                    GS.judgeMeter -= 15;
                    updateJudgeMeter();
                  }
                  entries2.onComplete = () => { reopenTestimony(); };
                  queueDialogue(entries2);
                }
              });
            }},
            { label: '‚Ü©Ô∏è WITHDRAW', callback: () => {
              GS.judgeMeter -= 3;
              updateJudgeMeter();
              const entries2 = [
                { speaker: 'üîµ You (Defense)', text: "I... withdraw my objection for now." },
              ];
              entries2.onComplete = () => { reopenTestimony(); };
              queueDialogue(entries2);
            }}
          ]
        },
      ];
      GS.judgeMeter += 10;
      updateJudgeMeter();
      entries.onComplete = null;
      queueDialogue(entries);
    }, 1300);
  } else if (w.broken && idx === w.contradiction.index) {
    const entries = [
      { speaker: '‚öñÔ∏è Judge Ironwood', text: "This contradiction has already been exposed. Move on, counselor." },
    ];
    entries.onComplete = () => { reopenTestimony(); };
    queueDialogue(entries);
  } else {
    // Wrong objection
    showObjection('defense');
    GS.strikes++;
    GS.judgeMeter -= 10;
    updateJudgeMeter();
    setTimeout(() => {
      const entries = [
        { speaker: 'üîµ You (Defense)', text: 'OBJECTION! This testimony is‚Äî' },
        { speaker: 'üî¥ Prosecutor Vex', text: 'On what grounds?!',
          portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'prosecutor', label: 'Prosecutor Vex' } } },
        { speaker: '‚öñÔ∏è Judge Ironwood', text: `Overruled! The defense will refrain from baseless objections. ${GS.strikes >= GS.maxStrikes ? 'That was your FINAL warning!' : 'That is a strike against you, counselor.'}`,
          portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
      ];
      if (GS.strikes >= GS.maxStrikes) {
        GS.judgeMeter -= 10;
        updateJudgeMeter();
      }
      entries.onComplete = () => { reopenTestimony(); };
      queueDialogue(entries);
    }, 1300);
  }
}

function reopenTestimony() {
  GS.testimonyOpen = true;
  const panel = document.getElementById('testimony-lines');
  panel.style.display = 'flex';
  // Refresh the display
  const w = GS.currentCase.witnesses[GS.witnessIndex];
  const list = document.getElementById('testimony-list');
  const lines = list.querySelectorAll('.testimony-line');
  lines.forEach((line, i) => {
    line.className = 'testimony-line';
    if (i === GS.statementIndex) line.className += ' active';
    if (w.pressed[i]) line.className += ' pressed';
    if (w.broken && i === w.contradiction.index) line.className += ' broken';
  });
  setSpeaker('‚Äî CROSS-EXAMINATION ‚Äî');
  document.getElementById('dialogue-text').textContent = w.broken
    ? '‚úÖ Contradiction found! You may continue examining or finish.'
    : 'Select a statement to examine. Press, Present evidence, or Object!';
  document.getElementById('continue-hint').style.display = 'none';
}

function finishCrossExam() {
  GS.crossExamMode = false;
  GS.testimonyOpen = false;
  document.getElementById('testimony-lines').style.display = 'none';
  const c = GS.currentCase;
  const w = c.witnesses[GS.witnessIndex];
  const entries = [];
  if (w.broken) {
    entries.push({ speaker: '‚öñÔ∏è Judge Ironwood', text: 'The witness is dismissed. The court notes the significant contradictions in their testimony.',
      portrait: { left: { type: c.monster.type, expr: 'happy', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } });
  } else {
    entries.push({ speaker: '‚öñÔ∏è Judge Ironwood', text: 'The witness is dismissed. Their testimony stands as given.',
      portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } });
    GS.judgeMeter -= 5;
    updateJudgeMeter();
  }
  if (GS.witnessIndex + 1 < c.witnesses.length) {
    entries.push({ speaker: '‚öñÔ∏è Judge Ironwood', text: 'The prosecution may call its next witness.' });
  }
  entries.onComplete = () => startWitnessTestimony(GS.witnessIndex + 1);
  queueDialogue(entries);
}

// ======================== CLOSING & VERDICT ========================
function startClosingArguments() {
  const c = GS.currentCase;
  const contradictionsFound = GS.foundContradictions.size;
  const totalWitnesses = c.witnesses.length;
  const brokenCount = c.witnesses.filter(w => w.broken).length;
  let prosecutionClosing, defenseClosing;
  if (brokenCount >= totalWitnesses) {
    prosecutionClosing = "Your Honor... despite the defense's... theatrical displays... the evidence still points to the defendant. We urge a guilty verdict.";
    defenseClosing = `Your Honor, EVERY witness had their testimony dismantled! Not a single claim against ${c.monster.name} survived cross-examination. The prosecution has NO case!`;
  } else if (brokenCount > 0) {
    prosecutionClosing = `Your Honor, while the defense raised some points, the remaining testimony clearly establishes the defendant's guilt. We are confident in our case.`;
    defenseClosing = `Your Honor, we exposed critical contradictions in the prosecution's witnesses. Their case is built on a foundation of lies and mistakes. ${c.monster.name} deserves acquittal!`;
  } else {
    prosecutionClosing = `Your Honor, the testimony has been clear and consistent. The defendant is guilty beyond any reasonable doubt!`;
    defenseClosing = `Your Honor, the prosecution's case is entirely circumstantial. There is reasonable doubt, and my client deserves the benefit of that doubt!`;
  }
  if (c.isGuilty) {
    defenseClosing = `Your Honor, regardless of what may or may not have happened, the prosecution has failed to PROVE their case! Witness testimony was unreliable, evidence was circumstantial, and procedure was not followed. My client is entitled to a fair trial ‚Äî and the prosecution did not deliver one!`;
  }
  const entries = [
    { speaker: '‚öñÔ∏è Judge Ironwood', text: 'We will now hear closing arguments. The prosecution may proceed.',
      portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
    { speaker: 'üî¥ Prosecutor Vex', text: prosecutionClosing,
      portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'prosecutor', label: 'Prosecutor Vex' } } },
    { speaker: '‚öñÔ∏è Judge Ironwood', text: 'The defense may now give their closing statement.' },
    { speaker: 'üîµ You (Defense)', text: defenseClosing,
      portrait: { left: { type: c.monster.type, expr: brokenCount > 0 ? 'normal' : 'worried', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } } },
  ];
  // If guilty case and found contradictions, add bonus argument
  if (c.isGuilty && brokenCount > 0) {
    entries.push({
      speaker: 'üîµ You (Defense)',
      text: 'Furthermore, the procedural errors and unreliable witnesses mean this court CANNOT deliver a just guilty verdict, regardless of any other consideration!'
    });
    GS.judgeMeter += 5;
    updateJudgeMeter();
  }
  entries.push({
    speaker: '‚öñÔ∏è Judge Ironwood',
    text: 'The court will now render its verdict...',
    portrait: { left: { type: c.monster.type, expr: 'worried', label: c.monster.name }, right: { type: 'judge', label: 'Judge Ironwood' } }
  });
  entries.onComplete = () => renderVerdict();
  queueDialogue(entries);
}

function renderVerdict() {
  const c = GS.currentCase;
  // Determine verdict based on judge meter
  const threshold = c.isGuilty ? 60 : 45; // Harder to win guilty cases
  const won = GS.judgeMeter >= threshold;
  // Dramatic pause
  setTimeout(() => {
    flashScreen('#fff', 800);
    shakeScreen();
    setTimeout(() => showVerdictScreen(won), 1000);
  }, 500);
}

function showVerdictScreen(won) {
  const c = GS.currentCase;
  const screen = document.getElementById('verdict-screen');
  screen.style.display = 'flex';
  screen.className = won ? 'verdict-not-guilty' : 'verdict-guilty';
  const title = document.getElementById('verdict-title');
  const text = document.getElementById('verdict-text');
  const btn = document.getElementById('verdict-btn');
  if (won) {
    title.textContent = '‚ú® NOT GUILTY! ‚ú®';
    GS.casesWon++;
    let msg = c.monster.happy + '\n\n';
    if (c.isGuilty) {
      msg += '(Your guilty client walks free thanks to your legal brilliance. Justice... or injustice? The moral weight is yours to carry.)\n\n';
    }
    msg += `Judge's Opinion: ${GS.judgeMeter}% in your favor\n`;
    msg += `Contradictions exposed: ${GS.foundContradictions.size}\n`;
    msg += `Strikes received: ${GS.strikes}/${GS.maxStrikes}`;
    text.textContent = msg;
    if (GS.caseNum < GS.totalCases) {
      btn.textContent = 'NEXT CASE ‚Üí';
      btn.onclick = () => {
        screen.style.display = 'none';
        saveProgress();
        startCase();
      };
    } else {
      btn.textContent = 'VIEW FINAL RESULTS';
      btn.onclick = () => showFinalResults();
    }
  } else {
    title.textContent = '‚õìÔ∏è GUILTY ‚õìÔ∏è';
    let msg = c.monster.sad + '\n\n';
    msg += `Judge's Opinion: ${GS.judgeMeter}% ‚Äî not enough to acquit.\n`;
    msg += `Contradictions exposed: ${GS.foundContradictions.size}\n`;
    msg += `Strikes received: ${GS.strikes}/${GS.maxStrikes}\n\n`;
    msg += 'But the fight for justice continues...';
    text.textContent = msg;
    if (GS.caseNum < GS.totalCases) {
      btn.textContent = 'NEXT CASE ‚Üí';
      btn.onclick = () => {
        screen.style.display = 'none';
        saveProgress();
        startCase();
      };
    } else {
      btn.textContent = 'VIEW FINAL RESULTS';
      btn.onclick = () => showFinalResults();
    }
  }
}

function showFinalResults() {
  const screen = document.getElementById('verdict-screen');
  screen.className = GS.casesWon >= 3 ? 'verdict-not-guilty' : 'verdict-guilty';
  const title = document.getElementById('verdict-title');
  const text = document.getElementById('verdict-text');
  const btn = document.getElementById('verdict-btn');
  if (GS.casesWon === GS.totalCases) {
    title.textContent = 'üèÜ LEGENDARY ATTORNEY! üèÜ';
    text.textContent = `You won ALL ${GS.totalCases} cases!\n\nFrom fire-breathing dragons to shapeshifting mimics, no monster was beyond your defense.\n\nYou have earned the title:\n"SUPREME MONSTER ADVOCATE"\n\nThe monsters of the realm sleep easier knowing you fight for them.`;
  } else if (GS.casesWon >= 3) {
    title.textContent = '‚≠ê SKILLED DEFENDER ‚≠ê';
    text.textContent = `Cases won: ${GS.casesWon}/${GS.totalCases}\n\nYou proved yourself a capable defender of monsterkind. Not every case went your way, but you fought hard.\n\nTitle earned: "MONSTER DEFENDER"`;
  } else if (GS.casesWon >= 1) {
    title.textContent = 'üìú APPRENTICE ATTORNEY üìú';
    text.textContent = `Cases won: ${GS.casesWon}/${GS.totalCases}\n\nThe path of justice is long, and you're still learning. But every monster deserves a defender who tries.\n\nTitle earned: "NOVICE ADVOCATE"`;
  } else {
    title.textContent = 'üòî DISBARRED üòî';
    text.textContent = `Cases won: 0/${GS.totalCases}\n\nEvery client found guilty... The Monster Bar Association has revoked your license.\n\nBut perhaps... try again?`;
  }
  btn.textContent = 'NEW GAME';
  btn.onclick = () => {
    screen.style.display = 'none';
    localStorage.removeItem('monsterCourtSave');
    showScreen('title-screen');
  };
}

// ======================== SAVE / LOAD ========================
function saveProgress() {
  const save = {
    caseNum: GS.caseNum,
    casesWon: GS.casesWon,
    usedMonsters: GS.usedMonsters
  };
  localStorage.setItem('monsterCourtSave', JSON.stringify(save));
}

function loadProgress() {
  try {
    const data = JSON.parse(localStorage.getItem('monsterCourtSave'));
    if (data && data.caseNum < data.caseNum) return null; // invalid
    return data;
  } catch { return null; }
}

// ======================== INPUT HANDLING ========================
function handleKey(key) {
  if (GS.phase === 'title') return;
  if (GS.evidenceOpen) {
    if (key === 'ArrowUp' || key === 'ArrowLeft') navigateEvidence(-1);
    else if (key === 'ArrowDown' || key === 'ArrowRight') navigateEvidence(1);
    else if (key === 'Enter') {
      const items = document.querySelectorAll('.evidence-item');
      if (items[GS.selectedEvidence]) items[GS.selectedEvidence].click();
    }
    else if (key === 'Escape' || key === 'KeyE') closeEvidence();
    return;
  }
  if (GS.testimonyOpen) {
    if (key === 'ArrowUp' || key === 'ArrowLeft') navigateTestimony(-1);
    else if (key === 'ArrowDown' || key === 'ArrowRight') navigateTestimony(1);
    else if (key === 'Enter') pressStatement();
    else if (key === 'KeyE') presentEvidence();
    else if (key === 'KeyO') objectToStatement();
    else if (key === 'Escape') finishCrossExam();
    return;
  }
  if (GS.awaitingChoice) {
    if (key === 'ArrowLeft' || key === 'ArrowUp') navigateChoice(-1);
    else if (key === 'ArrowRight' || key === 'ArrowDown') navigateChoice(1);
    else if (key === 'Enter') selectChoice();
    return;
  }
  if (key === 'Enter' || key === 'ArrowRight') {
    advanceDialogue();
  }
  if (key === 'KeyE' && GS.crossExamMode) {
    openEvidencePanel(false);
  }
}

document.addEventListener('keydown', (e) => {
  const key = e.code || e.key;
  if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Enter','Space','KeyE','KeyO','Escape'].includes(key)) {
    e.preventDefault();
    handleKey(key === 'Space' ? 'Enter' : key);
  }
});

// Touch support for dialogue area
document.getElementById('dialogue-area').addEventListener('click', () => {
  if (!GS.evidenceOpen && !GS.testimonyOpen && !GS.awaitingChoice) {
    advanceDialogue();
  }
});

// ======================== GAME START ========================
function startNewGame() {
  GS.caseNum = 0;
  GS.casesWon = 0;
  GS.usedMonsters = [];
  GS.phase = 'playing';
  localStorage.removeItem('monsterCourtSave');
  startCase();
}

function continueGame() {
  const save = loadProgress();
  if (save && save.caseNum > 0 && save.caseNum < GS.totalCases) {
    GS.caseNum = save.caseNum;
    GS.casesWon = save.casesWon || 0;
    GS.usedMonsters = save.usedMonsters || [];
    GS.phase = 'playing';
    startCase();
  } else {
    startNewGame();
  }
}

// ======================== SOUND EFFECTS (Web Audio) ========================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function initAudio() { if (!audioCtx) audioCtx = new AudioCtx(); }

function playTone(freq, duration, type, vol) {
  try {
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type || 'square';
    osc.frequency.value = freq;
    gain.gain.value = vol || 0.08;
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + (duration || 0.15));
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + (duration || 0.15));
  } catch(e) {}
}

function sfxTypewriter() { playTone(800 + Math.random() * 400, 0.03, 'square', 0.02); }
function sfxObjection() {
  playTone(880, 0.1, 'sawtooth', 0.12);
  setTimeout(() => playTone(1100, 0.1, 'sawtooth', 0.12), 100);
  setTimeout(() => playTone(1320, 0.2, 'sawtooth', 0.15), 200);
}
function sfxContradiction() {
  playTone(523, 0.15, 'square', 0.1);
  setTimeout(() => playTone(659, 0.15, 'square', 0.1), 150);
  setTimeout(() => playTone(784, 0.15, 'square', 0.1), 300);
  setTimeout(() => playTone(1047, 0.3, 'square', 0.12), 450);
}
function sfxGuilty() {
  playTone(400, 0.3, 'sawtooth', 0.1);
  setTimeout(() => playTone(300, 0.3, 'sawtooth', 0.1), 300);
  setTimeout(() => playTone(200, 0.5, 'sawtooth', 0.12), 600);
}
function sfxNotGuilty() {
  playTone(523, 0.15, 'square', 0.1);
  setTimeout(() => playTone(659, 0.15, 'square', 0.1), 150);
  setTimeout(() => playTone(784, 0.15, 'square', 0.1), 300);
  setTimeout(() => playTone(1047, 0.15, 'square', 0.1), 450);
  setTimeout(() => playTone(1320, 0.4, 'square', 0.12), 600);
}
function sfxStrike() {
  playTone(200, 0.2, 'sawtooth', 0.1);
  setTimeout(() => playTone(150, 0.3, 'sawtooth', 0.12), 200);
}
function sfxPress() { playTone(660, 0.08, 'triangle', 0.06); }
function sfxSelect() { playTone(440, 0.05, 'triangle', 0.05); }
function sfxGavel() {
  playTone(120, 0.1, 'square', 0.15);
  setTimeout(() => playTone(100, 0.15, 'square', 0.12), 150);
}

// Enhance existing functions with sound
const _origShowObjection = showObjection;
showObjection = function(who) { sfxObjection(); _origShowObjection(who); };

const _origFlash = flashScreen;
flashScreen = function(c, d) {
  if (c && c.includes('44ff44')) sfxContradiction();
  _origFlash(c, d);
};

// Add typewriter sound to the typewrite function
const _origTypewrite = typewrite;
typewrite = function(text, callback) {
  clearInterval(GS.typewriterTimer);
  typewriterText = text;
  typewriterIndex = 0;
  GS.textComplete = false;
  const textEl = document.getElementById('dialogue-text');
  textEl.textContent = '';
  document.getElementById('continue-hint').style.display = 'none';
  let soundCounter = 0;
  GS.typewriterTimer = setInterval(() => {
    if (typewriterIndex < typewriterText.length) {
      textEl.textContent += typewriterText[typewriterIndex];
      typewriterIndex++;
      soundCounter++;
      if (soundCounter % 3 === 0) sfxTypewriter();
    } else {
      clearInterval(GS.typewriterTimer);
      GS.textComplete = true;
      document.getElementById('continue-hint').style.display = 'block';
      if (callback) callback();
    }
  }, typewriterSpeed);
};

// ======================== PARTICLE EFFECTS ========================
const particles = [];
let particleCanvas = null;
let particleCtx = null;
let particleAnimFrame = null;

function initParticles() {
  particleCanvas = document.createElement('canvas');
  particleCanvas.style.cssText = 'position:fixed;inset:0;z-index:998;pointer-events:none';
  document.getElementById('game').appendChild(particleCanvas);
  resizeParticleCanvas();
  animateParticles();
}

function resizeParticleCanvas() {
  if (particleCanvas) {
    particleCanvas.width = window.innerWidth;
    particleCanvas.height = window.innerHeight;
    particleCtx = particleCanvas.getContext('2d');
  }
}

function spawnParticles(x, y, color, count, spread) {
  for (let i = 0; i < (count || 20); i++) {
    particles.push({
      x: x || window.innerWidth / 2,
      y: y || window.innerHeight / 2,
      vx: (Math.random() - 0.5) * (spread || 8),
      vy: (Math.random() - 0.5) * (spread || 8) - 2,
      life: 1,
      decay: 0.01 + Math.random() * 0.02,
      size: 2 + Math.random() * 4,
      color: color || '#ffd700'
    });
  }
}

function animateParticles() {
  if (!particleCtx) { particleAnimFrame = requestAnimationFrame(animateParticles); return; }
  particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.1;
    p.life -= p.decay;
    if (p.life <= 0) { particles.splice(i, 1); continue; }
    particleCtx.globalAlpha = p.life;
    particleCtx.fillStyle = p.color;
    particleCtx.fillRect(p.x - p.size / 2, p.y - p.size / 2, p.size, p.size);
  }
  particleCtx.globalAlpha = 1;
  particleAnimFrame = requestAnimationFrame(animateParticles);
}

// ======================== ACHIEVEMENTS ========================
const ACHIEVEMENTS = [
  { id: 'first_win', name: 'First Acquittal', desc: 'Win your first case', icon: '‚öñÔ∏è' },
  { id: 'perfect_case', name: 'Flawless Defense', desc: 'Win a case with 0 strikes', icon: '‚ú®' },
  { id: 'all_contradictions', name: 'Ace Detective', desc: 'Find all contradictions in a case', icon: 'üîç' },
  { id: 'guilty_win', name: 'Legal Eagle', desc: 'Win the case even when your client is guilty', icon: 'ü¶Ö' },
  { id: 'perfect_game', name: 'Supreme Advocate', desc: 'Win all 5 cases', icon: 'üèÜ' },
  { id: 'three_objections', name: 'Objection Overload', desc: 'Get 3 strikes in a single case', icon: 'üí•' },
  { id: 'speed_cross', name: 'Quick Thinker', desc: 'Find a contradiction on first press', icon: '‚ö°' },
];

function checkAchievement(id) {
  let unlocked = JSON.parse(localStorage.getItem('monsterCourtAchievements') || '[]');
  if (unlocked.includes(id)) return;
  unlocked.push(id);
  localStorage.setItem('monsterCourtAchievements', JSON.stringify(unlocked));
  const ach = ACHIEVEMENTS.find(a => a.id === id);
  if (ach) showAchievementPopup(ach);
}

function showAchievementPopup(ach) {
  const div = document.createElement('div');
  div.style.cssText = 'position:fixed;top:60px;right:20px;background:linear-gradient(135deg,#2a1800,#4a2800);border:2px solid #ffd700;padding:15px 20px;z-index:2000;animation:slideIn .4s ease-out;border-radius:4px;max-width:280px';
  div.innerHTML = `<div style="color:#ffd700;font-size:1.1rem;font-weight:bold">${ach.icon} Achievement Unlocked!</div><div style="color:#f0e6d2;font-size:.85rem;margin-top:5px">${ach.name}</div><div style="color:#aa8866;font-size:.75rem;margin-top:3px">${ach.desc}</div>`;
  document.body.appendChild(div);
  sfxNotGuilty();
  spawnParticles(window.innerWidth - 150, 90, '#ffd700', 30, 6);
  setTimeout(() => { div.style.opacity = '0'; div.style.transition = 'opacity .5s'; }, 3000);
  setTimeout(() => div.remove(), 3600);
}

// Hook achievements into game flow
const _origShowVerdict = showVerdictScreen;
showVerdictScreen = function(won) {
  if (won) {
    checkAchievement('first_win');
    sfxNotGuilty();
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, '#44ff44', 40, 10);
    if (GS.strikes === 0) checkAchievement('perfect_case');
    if (GS.currentCase.isGuilty) checkAchievement('guilty_win');
    const allBroken = GS.currentCase.witnesses.every(w => w.broken);
    if (allBroken) checkAchievement('all_contradictions');
    if (GS.casesWon + 1 === GS.totalCases && GS.caseNum === GS.totalCases) checkAchievement('perfect_game');
  } else {
    sfxGuilty();
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, '#ff4444', 30, 8);
  }
  if (GS.strikes >= GS.maxStrikes) checkAchievement('three_objections');
  _origShowVerdict(won);
};

// ======================== TUTORIAL / HELP OVERLAY ========================
function showHelp() {
  const existing = document.getElementById('help-overlay');
  if (existing) { existing.remove(); return; }
  const div = document.createElement('div');
  div.id = 'help-overlay';
  div.style.cssText = 'position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;padding:20px';
  div.innerHTML = `<div style="max-width:600px;max-height:80vh;overflow-y:auto;background:#1a0a00;border:2px solid #ffd700;padding:30px;border-radius:4px">
    <h2 style="color:#ffd700;margin-bottom:15px;text-align:center">üìú HOW TO PLAY</h2>
    <div style="color:#f0e6d2;font-size:.9rem;line-height:1.8">
      <p><strong style="color:#ffd700">You are a defense attorney for monsters.</strong> Each case, a monster is accused of a crime. Your job: find contradictions in witness testimony to prove innocence!</p>
      <h3 style="color:#ffaa33;margin:15px 0 8px">‚å®Ô∏è Controls</h3>
      <p>‚Ä¢ <strong>Enter / Space / Tap</strong> ‚Äî Advance dialogue, Confirm selection</p>
      <p>‚Ä¢ <strong>Arrow Keys</strong> ‚Äî Navigate choices, testimony lines, evidence</p>
      <p>‚Ä¢ <strong>O key</strong> ‚Äî Shout OBJECTION! (use on contradictory statements)</p>
      <p>‚Ä¢ <strong>E key</strong> ‚Äî Open evidence / Present evidence</p>
      <p>‚Ä¢ <strong>H key</strong> ‚Äî Toggle this help screen</p>
      <h3 style="color:#ffaa33;margin:15px 0 8px">üîç Cross-Examination</h3>
      <p>‚Ä¢ <strong>PRESS</strong> a statement to get more details from the witness</p>
      <p>‚Ä¢ <strong>PRESENT</strong> evidence that contradicts a specific statement</p>
      <p>‚Ä¢ <strong>OBJECT</strong> when you spot the contradictory statement</p>
      <p>‚Ä¢ Find the right evidence + right statement = expose the contradiction!</p>
      <h3 style="color:#ffaa33;margin:15px 0 8px">‚öñÔ∏è Judge's Opinion</h3>
      <p>‚Ä¢ The meter shows how the judge is leaning (50% = neutral)</p>
      <p>‚Ä¢ Correct objections and evidence: <span style="color:#44ff44">+meter</span></p>
      <p>‚Ä¢ Wrong objections: <span style="color:#ff4444">-meter + strike</span></p>
      <p>‚Ä¢ 3 strikes = severe penalty!</p>
      <h3 style="color:#ffaa33;margin:15px 0 8px">üí° Tips</h3>
      <p>‚Ä¢ Read ALL testimony before objecting ‚Äî look for inconsistencies</p>
      <p>‚Ä¢ PRESS suspicious statements for hints before presenting evidence</p>
      <p>‚Ä¢ Check your evidence descriptions carefully ‚Äî they contain clues</p>
      <p>‚Ä¢ The final case has a twist ‚Äî your client is GUILTY. Find procedural errors!</p>
    </div>
    <button class="menu-btn" style="width:100%;margin-top:20px" onclick="this.parentElement.parentElement.remove()">GOT IT!</button>
  </div>`;
  div.addEventListener('click', (e) => { if (e.target === div) div.remove(); });
  document.body.appendChild(div);
}

// ======================== TITLE SCREEN ANIMATION ========================
let titleAnimFrame = null;
function animateTitle() {
  const canvas = document.createElement('canvas');
  const container = document.getElementById('title-screen');
  if (!container || container.style.display === 'none') return;
  // Draw floating scales of justice on title
  if (!document.getElementById('title-canvas')) {
    canvas.id = 'title-canvas';
    canvas.style.cssText = 'position:absolute;inset:0;pointer-events:none;z-index:0';
    container.insertBefore(canvas, container.firstChild);
  }
  const c = document.getElementById('title-canvas');
  if (!c) return;
  c.width = container.clientWidth;
  c.height = container.clientHeight;
  const ctx = c.getContext('2d');
  const t = Date.now() / 1000;
  // Floating particles
  ctx.fillStyle = 'rgba(255, 215, 0, 0.15)';
  for (let i = 0; i < 30; i++) {
    const x = (Math.sin(t * 0.3 + i * 2.1) * 0.5 + 0.5) * c.width;
    const y = (Math.cos(t * 0.2 + i * 1.7) * 0.5 + 0.5) * c.height;
    const s = 2 + Math.sin(t + i) * 2;
    ctx.fillRect(x, y, s, s);
  }
  // Glowing scales
  ctx.strokeStyle = 'rgba(255, 215, 0, 0.08)';
  ctx.lineWidth = 2;
  const cx = c.width / 2;
  const cy = c.height / 2 - 60;
  const swing = Math.sin(t * 0.5) * 15;
  ctx.beginPath();
  ctx.moveTo(cx, cy - 40);
  ctx.lineTo(cx, cy + 10);
  ctx.moveTo(cx - 60, cy + 10 - swing);
  ctx.lineTo(cx + 60, cy + 10 + swing);
  ctx.stroke();
  // Scale pans
  ctx.beginPath();
  ctx.arc(cx - 60, cy + 25 - swing, 20, 0, Math.PI);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(cx + 60, cy + 25 + swing, 20, 0, Math.PI);
  ctx.stroke();
  titleAnimFrame = requestAnimationFrame(animateTitle);
}

// ======================== ENHANCED COURTROOM RENDERING ========================
function drawCourtSceneDetails() {
  const canvas = document.getElementById('court-bg');
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  // Gallery spectators (simple dots)
  ctx.fillStyle = 'rgba(200, 180, 140, 0.2)';
  for (let i = 0; i < 15; i++) {
    const x = 50 + (i % 8) * (w - 100) / 8;
    const y = h * 0.08 + Math.floor(i / 8) * 20;
    ctx.beginPath();
    ctx.arc(x, y, 5, 0, Math.PI * 2);
    ctx.fill();
  }
  // Candle flames (atmospheric)
  const t = Date.now() / 500;
  ctx.fillStyle = 'rgba(255, 200, 50, 0.3)';
  [w * 0.1, w * 0.9].forEach(x => {
    const flicker = Math.sin(t + x) * 3;
    ctx.beginPath();
    ctx.arc(x, h * 0.3 + flicker, 4, 0, Math.PI * 2);
    ctx.fill();
    // Glow
    const grd = ctx.createRadialGradient(x, h * 0.3, 0, x, h * 0.3, 30);
    grd.addColorStop(0, 'rgba(255, 180, 50, 0.15)');
    grd.addColorStop(1, 'rgba(255, 180, 50, 0)');
    ctx.fillStyle = grd;
    ctx.fillRect(x - 30, h * 0.3 - 30, 60, 60);
  });
  // Floor pattern
  ctx.strokeStyle = 'rgba(60, 30, 10, 0.3)';
  ctx.lineWidth = 1;
  for (let x = 0; x < w; x += 40) {
    ctx.beginPath();
    ctx.moveTo(x, h * 0.85);
    ctx.lineTo(x, h);
    ctx.stroke();
  }
}

// Override drawCourtBackground to include details
const _origDrawBg = drawCourtBackground;
drawCourtBackground = function() {
  _origDrawBg();
  drawCourtSceneDetails();
};

// ======================== CASE STATUS DISPLAY ========================
function getCaseStatusText() {
  if (!GS.currentCase) return '';
  const c = GS.currentCase;
  const broken = c.witnesses.filter(w => w.broken).length;
  return `Contradictions: ${broken}/${c.witnesses.length} | Meter: ${GS.judgeMeter}%`;
}

// ======================== DIFFICULTY MODIFIERS ========================
function getDifficultyLabel(num) {
  const labels = ['', '‚òÖ Beginner', '‚òÖ‚òÖ Easy', '‚òÖ‚òÖ‚òÖ Medium', '‚òÖ‚òÖ‚òÖ‚òÖ Hard', '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Expert'];
  return labels[num] || '‚òÖ‚òÖ‚òÖ Medium';
}

// ======================== MONSTER IDLE ANIMATIONS ========================
let idleAnimTimer = null;
function startIdleAnimation() {
  if (idleAnimTimer) clearInterval(idleAnimTimer);
  idleAnimTimer = setInterval(() => {
    if (GS.phase !== 'playing') return;
    if (!GS.currentCase) return;
    // Subtle expression changes on the monster portrait
    const lCanvas = document.querySelector('#left-portrait .portrait-canvas');
    if (lCanvas && GS.currentCase.monster) {
      const expressions = ['normal', 'worried', 'normal', 'normal'];
      const expr = expressions[Math.floor(Date.now() / 3000) % expressions.length];
      if (GS.judgeMeter > 65) {
        drawPortrait(lCanvas, GS.currentCase.monster.type, 'happy');
      } else if (GS.judgeMeter < 35) {
        drawPortrait(lCanvas, GS.currentCase.monster.type, 'worried');
      } else {
        drawPortrait(lCanvas, GS.currentCase.monster.type, expr);
      }
    }
  }, 2000);
}

// ======================== ENHANCED VERDICT ANIMATIONS ========================
function animateVerdict(won) {
  if (won) {
    // Gold confetti
    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        spawnParticles(
          Math.random() * window.innerWidth,
          -10,
          ['#ffd700', '#ffaa33', '#44ff44', '#ffffff'][Math.floor(Math.random() * 4)],
          15, 5
        );
      }, i * 200);
    }
  } else {
    // Red fading particles
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, '#ff2222', 50, 12);
  }
}

// Hook into verdict
const _origRenderVerdict = renderVerdict;
renderVerdict = function() {
  const c = GS.currentCase;
  const threshold = c.isGuilty ? 60 : 45;
  const won = GS.judgeMeter >= threshold;
  sfxGavel();
  setTimeout(() => {
    flashScreen('#fff', 800);
    shakeScreen();
    animateVerdict(won);
    setTimeout(() => showVerdictScreen(won), 1000);
  }, 500);
};

// ======================== KEYBOARD SHORTCUT EXPANSION ========================
document.addEventListener('keydown', (e) => {
  if (e.code === 'KeyH') {
    e.preventDefault();
    showHelp();
  }
});

// ======================== RESPONSIVE PORTRAIT SIZING ========================
function resizePortraits() {
  const canvases = document.querySelectorAll('.portrait-canvas');
  const w = Math.min(120, window.innerWidth * 0.15);
  const h = w * 1.33;
  canvases.forEach(c => { c.width = Math.floor(w); c.height = Math.floor(h); });
}

// ======================== INITIALIZATION ========================
window.addEventListener('resize', () => {
  if (GS.phase !== 'title') {
    drawCourtBackground();
    resizePortraits();
  }
  resizeParticleCanvas();
});

window.addEventListener('load', () => {
  initParticles();
  animateTitle();
  startIdleAnimation();
  resizePortraits();
  // Add H for help hint on title
  const hint = document.querySelector('#title-screen p');
  if (hint) hint.textContent += ' ‚Ä¢ H for help';
});

// Ensure audio initializes on first user interaction
document.addEventListener('click', () => initAudio(), { once: true });
document.addEventListener('keydown', () => initAudio(), { once: true });

// Initial focus
document.querySelector('.menu-btn').focus();
</script>
</body>
</html>
