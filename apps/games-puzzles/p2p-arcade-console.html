<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="description" content="10-game P2P arcade console with WebRTC multiplayer â€” Pong, Tron, Battleship, Draw & Guess, Reaction Duels, Tanks, Connect Four, Word Bomb, Finger Fencing, Space Joust">
<meta name="category" content="games_puzzles">
<title>P2P Arcade Console â€” 10 Games</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#08090f;--s1:#0e1019;--s2:#161a28;--bd:#222840;--acc:#00d4ff;--red:#ff3366;--grn:#00ff88;--org:#ffaa00;--pur:#b366ff;--txt:#d8e0f0;--dim:#5a6488;--rad:12px}
body{font-family:'SF Pro Display',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--txt);overflow:hidden;height:100vh;touch-action:none}
button{cursor:pointer;font-family:inherit;border:none;outline:none}
.hidden{display:none!important}

/* Console Menu */
#console{height:100vh;overflow-y:auto;padding:20px;display:flex;flex-direction:column;align-items:center}
.con-hdr{text-align:center;padding:20px 0 10px}
.con-hdr h1{font-size:clamp(1.6rem,5vw,2.4rem);font-weight:900;background:linear-gradient(135deg,var(--red),var(--acc),var(--pur));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.con-hdr p{color:var(--dim);font-size:.85rem;margin-top:4px}
.peer-bar{display:flex;align-items:center;justify-content:center;gap:10px;margin:12px 0;padding:8px 16px;background:var(--s1);border:1px solid var(--bd);border-radius:20px;font-size:.8rem}
.peer-dot{width:8px;height:8px;border-radius:50%;background:var(--dim)}
.peer-dot.on{background:var(--grn);box-shadow:0 0 6px var(--grn)}
.peer-btns button{padding:6px 14px;border-radius:8px;font-size:.75rem;margin:0 3px;background:var(--s2);color:var(--txt);border:1px solid var(--bd)}
.peer-btns button:hover{border-color:var(--acc)}

/* Game Grid */
.gg{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;width:100%;max-width:700px;margin:16px 0}
.gc{background:var(--s1);border:1px solid var(--bd);border-radius:var(--rad);padding:16px;cursor:pointer;transition:all .2s;text-align:center}
.gc:hover{border-color:var(--acc);transform:translateY(-3px);box-shadow:0 6px 24px #00d4ff15}
.gc .gi{font-size:2rem;margin-bottom:6px}
.gc .gn{font-size:.85rem;font-weight:600}
.gc .gd{font-size:.7rem;color:var(--dim);margin-top:3px}

/* Connection Modal */
.modal{position:fixed;inset:0;background:#000b;z-index:50;display:flex;align-items:center;justify-content:center;padding:16px}
.modal-box{background:var(--s1);border:1px solid var(--bd);border-radius:var(--rad);padding:24px;max-width:420px;width:100%;max-height:80vh;overflow-y:auto}
.modal-box h2{font-size:1.2rem;margin-bottom:12px;text-align:center}
.modal-box textarea{width:100%;padding:8px;border-radius:8px;border:1px solid var(--bd);background:var(--bg);color:var(--txt);font-family:monospace;font-size:.65rem;resize:none;min-height:50px}
.modal-box .mbtn{display:block;width:100%;padding:10px;border-radius:8px;font-size:.9rem;font-weight:600;margin:6px 0;text-align:center}
.mbtn.pri{background:var(--acc);color:var(--bg)}
.mbtn.sec{background:var(--s2);color:var(--txt);border:1px solid var(--bd)}
.mstatus{text-align:center;font-size:.8rem;color:var(--dim);margin-top:8px}
.mstatus.ok{color:var(--grn)}

/* Game UI */
#gameUI{position:fixed;inset:0;z-index:5}
#gc{position:fixed;inset:0;z-index:4}
#backBtn{position:fixed;top:10px;left:10px;z-index:10;background:#0008;backdrop-filter:blur(6px);color:var(--dim);border:1px solid var(--bd);border-radius:8px;padding:6px 14px;font-size:.75rem}
#backBtn:hover{color:var(--txt);border-color:var(--acc)}
#gameHUD{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:10;background:#0009;backdrop-filter:blur(8px);border-radius:20px;padding:6px 20px;font-size:1rem;font-weight:700;pointer-events:none;font-variant-numeric:tabular-nums}
#textInput{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;width:280px;padding:12px 16px;border-radius:10px;border:2px solid var(--acc);background:var(--s1);color:var(--txt);font-size:1.1rem;text-align:center;font-family:inherit}
#msgOverlay{position:fixed;inset:0;z-index:20;display:flex;align-items:center;justify-content:center;background:#000a;pointer-events:none}
#msgOverlay .msg{font-size:clamp(1.5rem,6vw,3rem);font-weight:900;text-align:center;animation:popIn .4s}
@keyframes popIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
</style>
</head>
<body>

<div id="console">
  <div class="con-hdr">
    <h1>ğŸ® P2P ARCADE</h1>
    <p>10 instant multiplayer games Â· WebRTC peer-to-peer</p>
  </div>
  <div class="peer-bar">
    <span class="peer-dot" id="peerDot"></span>
    <span id="peerLabel">Not Connected</span>
    <span class="peer-btns">
      <button onclick="showModal('host')">ğŸ“¡ Host</button>
      <button onclick="showModal('join')">ğŸ“± Join</button>
    </span>
  </div>
  <div class="gg" id="gameGrid"></div>
  <p style="color:var(--dim);font-size:.7rem;margin-top:8px;text-align:center">All games work locally (same device). Connect P2P for online play!</p>
</div>

<canvas id="gc" class="hidden"></canvas>
<div id="gameUI" class="hidden">
  <button id="backBtn" onclick="backToMenu()">â† Menu</button>
  <div id="gameHUD"></div>
  <input type="text" id="textInput" class="hidden" autocomplete="off" spellcheck="false">
</div>
<div id="msgOverlay" class="hidden"><div class="msg" id="msgText"></div></div>

<!-- Connection Modal -->
<div class="modal hidden" id="modal">
  <div class="modal-box" id="modalBox"></div>
</div>

<script>
(()=>{
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED SYSTEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas=document.getElementById('gc');
const C=canvas.getContext('2d');
let W=0,H=0;
function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight}
resize();window.addEventListener('resize',resize);

// â”€â”€ Sound â”€â”€
const Snd=(()=>{
  let x;
  function i(){if(!x)x=new(window.AudioContext||window.webkitAudioContext)();if(x.state==='suspended')x.resume();return x}
  function tone(f,d,g,t){const a=i();const o=a.createOscillator();o.type=t||'sine';o.frequency.value=f;const gn=a.createGain();gn.gain.setValueAtTime(g||.1,a.currentTime);gn.gain.exponentialRampToValueAtTime(.001,a.currentTime+d);o.connect(gn);gn.connect(a.destination);o.start();o.stop(a.currentTime+d)}
  function noise(d,g,f){const a=i();const n=a.createBufferSource();const b=a.createBuffer(1,a.sampleRate*d,a.sampleRate);const c=b.getChannelData(0);for(let j=0;j<c.length;j++)c[j]=Math.random()*2-1;n.buffer=b;const fl=a.createBiquadFilter();fl.type='bandpass';fl.frequency.value=f||1000;const gn=a.createGain();gn.gain.setValueAtTime(g||.1,a.currentTime);gn.gain.exponentialRampToValueAtTime(.001,a.currentTime+d);n.connect(fl);fl.connect(gn);gn.connect(a.destination);n.start()}
  return{
    hit(){tone(440,.06,.12);noise(.03,.04,2000)},
    wall(){tone(220,.04,.06)},
    goal(){tone(523,.12,.18);setTimeout(()=>tone(659,.12,.18),60);setTimeout(()=>tone(784,.2,.2),120);noise(.4,.12,900)},
    bad(){tone(150,.3,.15,'sawtooth')},
    good(){tone(800,.08,.1);setTimeout(()=>tone(1200,.08,.1),60)},
    tick(){tone(1000,.02,.05)},
    boom(){noise(.5,.2,400);tone(80,.4,.15)},
    click(){tone(600,.03,.06)},
    whoosh(){noise(.15,.08,3000)}
  };
})();

// â”€â”€ Input â”€â”€
const inp={x:0,y:0,down:false,clicked:false,keys:{},typed:''};
let _clicked=false;
document.addEventListener('keydown',e=>{inp.keys[e.key]=true;if(e.key.length===1)inp.typed+=e.key});
document.addEventListener('keyup',e=>{inp.keys[e.key]=false});
canvas.addEventListener('pointermove',e=>{inp.x=e.clientX;inp.y=e.clientY});
canvas.addEventListener('pointerdown',e=>{inp.down=true;_clicked=true;inp.x=e.clientX;inp.y=e.clientY;Snd.click()});
canvas.addEventListener('pointerup',()=>{inp.down=false});
function consumeClick(){if(_clicked){_clicked=false;return true}return false}
function consumeTyped(){const t=inp.typed;inp.typed='';return t}

// â”€â”€ P2P â”€â”€
let pc=null,dc=null,isHost=false,peerConnected=false;
const ICE={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};

function peerSend(obj){if(dc&&dc.readyState==='open')dc.send(JSON.stringify(obj))}
let onPeerMsg=null;

function setupDC(ch){
  dc=ch;
  ch.onopen=()=>{peerConnected=true;updatePeerUI();closeModal();showFlash('ğŸ”— Connected!',var_grn)};
  ch.onmessage=e=>{const m=JSON.parse(e.data);if(m.t==='sel'){launchGame(m.g,false)}else if(m.t==='back'){backToMenu()}else if(onPeerMsg)onPeerMsg(m)};
  ch.onclose=()=>{peerConnected=false;updatePeerUI()};
}

async function hostP2P(){
  pc=new RTCPeerConnection(ICE);
  const ch=pc.createDataChannel('g');setupDC(ch);
  pc.onicecandidate=e=>{if(!e.candidate){
    document.getElementById('mOffer').value=btoa(JSON.stringify(pc.localDescription));
    document.getElementById('mStatus').textContent='âœ… Code ready. Share it!';document.getElementById('mStatus').className='mstatus ok'}};
  const o=await pc.createOffer();await pc.setLocalDescription(o);
}

async function hostComplete(){
  try{const a=JSON.parse(atob(document.getElementById('mAnswer').value.trim()));await pc.setRemoteDescription(a)}
  catch(e){document.getElementById('mStatus').textContent='âŒ Invalid answer';document.getElementById('mStatus').className='mstatus'}
}

async function joinP2P(){
  try{
    pc=new RTCPeerConnection(ICE);
    pc.ondatachannel=e=>setupDC(e.channel);
    const o=JSON.parse(atob(document.getElementById('mOffer2').value.trim()));
    await pc.setRemoteDescription(o);
    const a=await pc.createAnswer();await pc.setLocalDescription(a);
    pc.onicecandidate=e=>{if(!e.candidate){
      document.getElementById('mAnswer2').value=btoa(JSON.stringify(pc.localDescription));
      document.getElementById('mStep2').classList.remove('hidden');
      document.getElementById('mStatus2').textContent='âœ… Answer ready. Send it back!';document.getElementById('mStatus2').className='mstatus ok'}};
  }catch(e){document.getElementById('mStatus2').textContent='âŒ Invalid code';document.getElementById('mStatus2').className='mstatus'}
}

function updatePeerUI(){
  document.getElementById('peerDot').classList.toggle('on',peerConnected);
  document.getElementById('peerLabel').textContent=peerConnected?'Connected âœ“':'Not Connected';
}

const var_grn='#00ff88';

// â”€â”€ Modal â”€â”€
window.showModal=function(mode){
  const m=document.getElementById('modal');const b=document.getElementById('modalBox');
  m.classList.remove('hidden');
  isHost=mode==='host';
  if(mode==='host'){
    b.innerHTML=`<h2>ğŸ“¡ Host Game</h2>
      <p style="font-size:.8rem;color:var(--dim);margin-bottom:10px;text-align:center">Share this code with your friend</p>
      <textarea id="mOffer" readonly placeholder="Generating..."></textarea>
      <button class="mbtn pri" onclick="navigator.clipboard.writeText(document.getElementById('mOffer').value)">ğŸ“‹ Copy Code</button>
      <hr style="border-color:var(--bd);margin:12px 0">
      <p style="font-size:.8rem;color:var(--dim);margin-bottom:6px">Paste their answer:</p>
      <textarea id="mAnswer" placeholder="Paste answer here..."></textarea>
      <button class="mbtn pri" onclick="hostComplete()">ğŸ”— Connect</button>
      <div class="mstatus" id="mStatus">Generating...</div>
      <button class="mbtn sec" onclick="closeModal()">Cancel</button>`;
    hostP2P();
  } else {
    b.innerHTML=`<h2>ğŸ“± Join Game</h2>
      <p style="font-size:.8rem;color:var(--dim);margin-bottom:6px">Paste the host's code:</p>
      <textarea id="mOffer2" placeholder="Paste host code here..."></textarea>
      <button class="mbtn pri" onclick="joinP2P()">Generate Answer</button>
      <div id="mStep2" class="hidden">
        <hr style="border-color:var(--bd);margin:12px 0">
        <p style="font-size:.8rem;color:var(--dim);margin-bottom:6px">Send this answer back:</p>
        <textarea id="mAnswer2" readonly></textarea>
        <button class="mbtn pri" onclick="navigator.clipboard.writeText(document.getElementById('mAnswer2').value)">ğŸ“‹ Copy Answer</button>
      </div>
      <div class="mstatus" id="mStatus2">Paste host code above</div>
      <button class="mbtn sec" onclick="closeModal()">Cancel</button>`;
  }
};
window.closeModal=function(){document.getElementById('modal').classList.add('hidden')};
window.hostComplete=hostComplete;
window.joinP2P=joinP2P;

// â”€â”€ Flash Message â”€â”€
function showFlash(text,color){
  const o=document.getElementById('msgOverlay');
  const t=document.getElementById('msgText');
  t.innerHTML=`<span style="color:${color||'#fff'}">${text}</span>`;
  o.classList.remove('hidden');
  setTimeout(()=>o.classList.add('hidden'),1200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GAMES=[];
let activeGame=null, amPlayer1=true;

function regGame(g){GAMES.push(g)}

// â”€â”€ Shared draw helpers â”€â”€
function drawBg(){C.fillStyle='#08090f';C.fillRect(0,0,W,H)}
function drawText(text,x,y,size,color,align){
  C.font=`${size||16}px 'SF Pro Display',sans-serif`;C.fillStyle=color||'#fff';C.textAlign=align||'center';C.textBaseline='middle';C.fillText(text,x,y);
}

// Helper: check if point in rect
function inRect(px,py,rx,ry,rw,rh){return px>=rx&&px<=rx+rw&&py>=ry&&py<=ry+rh}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. PONG EVOLVED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
regGame({
  id:'pong',icon:'ğŸ“',name:'Pong Evolved',desc:'Power-ups & speed',color:'#ff3366',
  state:null,
  init(p1){
    const s={score:[0,0],bx:W/2,by:H/2,bvx:(Math.random()>.5?1:-1)*4,bvy:-5,
      p1y:H-60,p2y:60,p1x:W/2,p2x:W/2,pw:80,ph:14,br:8,
      powerups:[],powerTimer:0,bigP:0,multiBalls:[]};
    this.state=s;
  },
  update(dt){
    const s=this.state;if(!s)return;
    const spd=1+Math.max(s.score[0],s.score[1])*.15;

    // Paddles
    if(amPlayer1){s.p1x+=(inp.x-s.p1x)*.15}else{s.p1x+=(inp.x-s.p1x)*.15}
    s.p1x=Math.max(s.pw/2,Math.min(W-s.pw/2,s.p1x));

    // P2: AI or peer
    if(!peerConnected){
      const tx=s.bvy<0?s.bx+(s.bvx/Math.abs(s.bvy||1))*(s.p2y-s.by):W/2;
      s.p2x+=(tx-s.p2x)*.06;
    }
    s.p2x=Math.max(s.pw/2,Math.min(W-s.pw/2,s.p2x));

    // Ball
    s.bx+=s.bvx*spd;s.by+=s.bvy*spd;
    if(s.bx<s.br||s.bx>W-s.br){s.bvx*=-1;s.bx=Math.max(s.br,Math.min(W-s.br,s.bx));Snd.wall()}

    // Paddle collision
    const pw2=(s.pw+(s.bigP>0?40:0))/2;
    if(s.by+s.br>s.p1y-s.ph/2&&s.by<s.p1y+s.ph/2&&s.bx>s.p1x-pw2&&s.bx<s.p1x+pw2&&s.bvy>0){
      s.bvy=-Math.abs(s.bvy)*1.02;s.bvx+=(s.bx-s.p1x)*.1;Snd.hit()}
    if(s.by-s.br<s.p2y+s.ph/2&&s.by>s.p2y-s.ph/2&&s.bx>s.p2x-pw2&&s.bx<s.p2x+pw2&&s.bvy<0){
      s.bvy=Math.abs(s.bvy)*1.02;s.bvx+=(s.bx-s.p2x)*.1;Snd.hit()}

    // Score
    if(s.by<-20){s.score[0]++;Snd.goal();this._reset(s,1)}
    if(s.by>H+20){s.score[1]++;Snd.goal();this._reset(s,-1)}

    // Power-ups
    s.powerTimer++;
    if(s.powerTimer>300&&Math.random()<.01){
      s.powerups.push({x:Math.random()*(W-80)+40,y:H/2+(Math.random()-.5)*H*.3,type:Math.random()<.5?'big':'speed',life:200});
      s.powerTimer=0;
    }
    s.powerups=s.powerups.filter(p=>{p.life--;
      if(Math.abs(s.bx-p.x)<20&&Math.abs(s.by-p.y)<20){
        if(p.type==='big')s.bigP=180;
        if(p.type==='speed'){s.bvx*=1.5;s.bvy*=1.5}
        Snd.good();return false;
      }
      return p.life>0;
    });
    if(s.bigP>0)s.bigP--;

    if(peerConnected)peerSend({t:'go',s:{p:amPlayer1?s.p1x:s.p2x,bx:s.bx,by:s.by,bvx:s.bvx,bvy:s.bvy,sc:s.score}});
    if(s.score[0]>=7||s.score[1]>=7)showFlash(s.score[0]>=7?'ğŸ† Bottom Wins!':'ğŸ† Top Wins!','#fff');
  },
  _reset(s,dir){s.bx=W/2;s.by=H/2;s.bvx=(Math.random()-.5)*4;s.bvy=dir*5},
  draw(){
    const s=this.state;if(!s)return;drawBg();
    const pw2=(s.pw+(s.bigP>0?40:0))/2;
    // Paddles
    C.shadowColor='#ff3366';C.shadowBlur=15;C.fillStyle='#ff3366';
    C.fillRect(s.p1x-pw2,s.p1y-s.ph/2,pw2*2,s.ph);
    C.shadowColor='#00d4ff';C.fillStyle='#00d4ff';
    C.fillRect(s.p2x-pw2,s.p2y-s.ph/2,pw2*2,s.ph);
    C.shadowBlur=0;
    // Ball
    C.shadowColor='#fff';C.shadowBlur=12;C.fillStyle='#fff';
    C.beginPath();C.arc(s.bx,s.by,s.br,0,Math.PI*2);C.fill();C.shadowBlur=0;
    // Center line
    C.setLineDash([6,8]);C.strokeStyle='#222840';C.beginPath();C.moveTo(0,H/2);C.lineTo(W,H/2);C.stroke();C.setLineDash([]);
    // Power-ups
    s.powerups.forEach(p=>{drawText(p.type==='big'?'â¬›':'âš¡',p.x,p.y,20)});
    // HUD
    document.getElementById('gameHUD').innerHTML=`<span style="color:#ff3366">${s.score[0]}</span> â€” <span style="color:#00d4ff">${s.score[1]}</span>`;
  },
  onMsg(m){const s=this.state;if(!s)return;if(m.s){
    if(amPlayer1){s.p2x=m.s.p}else{s.p1x=m.s.p;s.bx=m.s.bx;s.by=m.s.by;s.bvx=m.s.bvx;s.bvy=m.s.bvy}
    s.score=m.s.sc;
  }}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. TRON LIGHTCYCLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
regGame({
  id:'tron',icon:'ğŸï¸',name:'Tron Lightcycles',desc:'Trail of death',color:'#00ff88',
  state:null,
  init(){
    const cols=Math.floor(W/12),rows=Math.floor(H/12);
    const grid=Array.from({length:rows},()=>new Uint8Array(cols));
    this.state={grid,cols,rows,cs:12,
      p1:{x:Math.floor(cols*.25),y:Math.floor(rows/2),dx:1,dy:0},
      p2:{x:Math.floor(cols*.75),y:Math.floor(rows/2),dx:-1,dy:0},
      tick:0,speed:6,alive:[true,true],score:[0,0],round:0,countdown:90};
  },
  update(dt){
    const s=this.state;if(!s)return;
    if(s.countdown>0){s.countdown--;return}
    // Input P1
    if(inp.keys.a&&s.p1.dx!==1){s.p1.dx=-1;s.p1.dy=0}
    if(inp.keys.d&&s.p1.dx!==-1){s.p1.dx=1;s.p1.dy=0}
    if(inp.keys.w&&s.p1.dy!==1){s.p1.dx=0;s.p1.dy=-1}
    if(inp.keys.s&&s.p1.dy!==-1){s.p1.dx=0;s.p1.dy=1}
    // Input P2 (arrows or AI)
    if(peerConnected){/* handled via messages */}
    else{
      if(inp.keys.ArrowLeft&&s.p2.dx!==1){s.p2.dx=-1;s.p2.dy=0}
      if(inp.keys.ArrowRight&&s.p2.dx!==-1){s.p2.dx=1;s.p2.dy=0}
      if(inp.keys.ArrowUp&&s.p2.dy!==1){s.p2.dx=0;s.p2.dy=-1}
      if(inp.keys.ArrowDown&&s.p2.dy!==-1){s.p2.dx=0;s.p2.dy=1}
    }
    s.tick++;
    if(s.tick%s.speed!==0)return;
    // Move
    [s.p1,s.p2].forEach((p,i)=>{
      if(!s.alive[i])return;
      p.x+=p.dx;p.y+=p.dy;
      if(p.x<0||p.x>=s.cols||p.y<0||p.y>=s.rows||s.grid[p.y][p.x]){
        s.alive[i]=false;Snd.boom();
      }else{s.grid[p.y][p.x]=i+1}
    });
    if(!s.alive[0]||!s.alive[1]){
      if(!s.alive[0]&&!s.alive[1]){}
      else if(!s.alive[0])s.score[1]++;
      else s.score[0]++;
      setTimeout(()=>{if(activeGame===this)this.init()},1500);
    }
    if(peerConnected)peerSend({t:'go',d:{p1:s.p1,p2:s.p2}});
  },
  draw(){
    const s=this.state;if(!s)return;drawBg();
    const cs=s.cs;
    for(let r=0;r<s.rows;r++)for(let c=0;c<s.cols;c++){
      if(s.grid[r][c]===1){C.fillStyle='#ff336644';C.fillRect(c*cs,r*cs,cs,cs)}
      if(s.grid[r][c]===2){C.fillStyle='#00d4ff44';C.fillRect(c*cs,r*cs,cs,cs)}
    }
    if(s.alive[0]){C.shadowColor='#ff3366';C.shadowBlur=10;C.fillStyle='#ff3366';C.fillRect(s.p1.x*cs,s.p1.y*cs,cs,cs);C.shadowBlur=0}
    if(s.alive[1]){C.shadowColor='#00d4ff';C.shadowBlur=10;C.fillStyle='#00d4ff';C.fillRect(s.p2.x*cs,s.p2.y*cs,cs,cs);C.shadowBlur=0}
    if(s.countdown>0)drawText('GET READY',W/2,H/2,40,'#fff');
    document.getElementById('gameHUD').innerHTML=`<span style="color:#ff3366">${s.score[0]}</span> â€” <span style="color:#00d4ff">${s.score[1]}</span>`;
    if(!s.alive[0]&&s.alive[1])drawText('ğŸ† Blue Wins!',W/2,H/2,36,'#00d4ff');
    if(s.alive[0]&&!s.alive[1])drawText('ğŸ† Red Wins!',W/2,H/2,36,'#ff3366');
    drawText('P1: WASD',80,H-20,12,'#ff336688');
    drawText('P2: Arrows',W-80,H-20,12,'#00d4ff88');
  },
  onMsg(m){if(m.d&&this.state){if(!amPlayer1)this.state.p1=m.d.p1;else this.state.p2=m.d.p2}}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. BATTLESHIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
regGame({
  id:'battleship',icon:'ğŸš¢',name:'Battleship',desc:'Hunt & sink ships',color:'#ff8800',
  state:null,
  init(){
    const sz=8,cell=Math.min((W-40)/16,(H-80)/sz)|0;
    const myG=Array.from({length:sz},()=>new Uint8Array(sz));
    const opG=Array.from({length:sz},()=>new Uint8Array(sz));
    // 0=empty,1=ship,2=miss,3=hit
    // Auto-place ships
    const ships=[4,3,2];
    ships.forEach(len=>{
      let placed=false;
      while(!placed){
        const horiz=Math.random()>.5;
        const r=Math.floor(Math.random()*(horiz?sz:sz-len));
        const c=Math.floor(Math.random()*(horiz?sz-len:sz));
        let ok=true;
        for(let i=0;i<len;i++){if(myG[horiz?r:r+i][horiz?c+i:c])ok=false}
        if(ok){for(let i=0;i<len;i++)myG[horiz?r:r+i][horiz?c+i:c]=1;placed=true}
      }
    });
    this.state={sz,cell,myG,opG,myTurn:amPlayer1||!peerConnected,shipHits:0,opHits:0,totalShips:4+3+2,phase:'play',lastResult:''};
  },
  update(){
    const s=this.state;if(!s||s.phase!=='play')return;
    if(s.myTurn&&consumeClick()){
      const ox=W/2+10,oy=(H-s.sz*s.cell)/2;
      const gc=Math.floor((inp.x-ox)/s.cell),gr=Math.floor((inp.y-oy)/s.cell);
      if(gc>=0&&gc<s.sz&&gr>=0&&gr<s.sz&&s.opG[gr][gc]===0){
        if(peerConnected){peerSend({t:'go',a:'fire',r:gr,c:gc})}
        else{
          // vs self (practice): fire on own grid
          if(s.myG[gr][gc]===1){s.opG[gr][gc]=3;s.opHits++;Snd.boom();s.lastResult='ğŸ’¥ HIT!'}
          else{s.opG[gr][gc]=2;Snd.wall();s.lastResult='ğŸ’¨ Miss';s.myTurn=false;setTimeout(()=>{s.myTurn=true},600)}
          if(s.opHits>=s.totalShips){s.phase='won';showFlash('ğŸ† You Win!','#00ff88')}
        }
      }
    }
  },
  draw(){
    const s=this.state;if(!s)return;drawBg();
    const oy=(H-s.sz*s.cell)/2;
    // My grid (left)
    const mx=W/2-s.sz*s.cell-10;
    drawText('Your Fleet',mx+s.sz*s.cell/2,oy-16,14,'#ff3366');
    for(let r=0;r<s.sz;r++)for(let c=0;c<s.sz;c++){
      const x=mx+c*s.cell,y=oy+r*s.cell;
      C.strokeStyle='#222840';C.strokeRect(x,y,s.cell,s.cell);
      if(s.myG[r][c]===1)C.fillStyle='#334';
      else C.fillStyle='#0c1019';
      C.fillRect(x+1,y+1,s.cell-2,s.cell-2);
      if(s.myG[r][c]===1){C.fillStyle='#556';C.fillRect(x+2,y+2,s.cell-4,s.cell-4)}
    }
    // Opponent grid (right)
    const ox=W/2+10;
    drawText('Enemy Waters',ox+s.sz*s.cell/2,oy-16,14,'#00d4ff');
    for(let r=0;r<s.sz;r++)for(let c=0;c<s.sz;c++){
      const x=ox+c*s.cell,y=oy+r*s.cell;
      C.strokeStyle='#222840';C.strokeRect(x,y,s.cell,s.cell);
      C.fillStyle='#0c1019';C.fillRect(x+1,y+1,s.cell-2,s.cell-2);
      if(s.opG[r][c]===2){C.fillStyle='#334';C.beginPath();C.arc(x+s.cell/2,y+s.cell/2,4,0,Math.PI*2);C.fill()}
      if(s.opG[r][c]===3){C.fillStyle='#ff3366';C.font='bold '+Math.floor(s.cell*.6)+'px sans-serif';C.textAlign='center';C.textBaseline='middle';C.fillText('âœ•',x+s.cell/2,y+s.cell/2)}
    }
    document.getElementById('gameHUD').innerHTML=s.myTurn?`<span style="color:${var_grn}">Your Turn</span> ${s.lastResult}`:'Opponent\'s Turn';
    if(s.phase==='won')drawText('ğŸ† Victory!',W/2,H/2,40,'#00ff88');
    if(s.phase==='lost')drawText('ğŸ’€ Defeated',W/2,H/2,40,'#ff3366');
  },
  onMsg(m){
    const s=this.state;if(!s)return;
    if(m.a==='fire'){
      const hit=s.myG[m.r][m.c]===1;
      if(hit){s.myG[m.r][m.c]=3;s.shipHits++;Snd.boom()}else Snd.wall();
      peerSend({t:'go',a:'result',r:m.r,c:m.c,h:hit});
      if(s.shipHits>=s.totalShips){s.phase='lost';showFlash('ğŸ’€ Defeated','#ff3366')}
      s.myTurn=true;
    }
    if(m.a==='result'){
      s.opG[m.r][m.c]=m.h?3:2;
      s.lastResult=m.h?'ğŸ’¥ HIT!':'ğŸ’¨ Miss';
      if(m.h){s.opHits++;Snd.boom()}else Snd.wall();
      if(s.opHits>=s.totalShips){s.phase='won';showFlash('ğŸ† You Win!','#00ff88')}
      s.myTurn=!m.h;
    }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. DRAW & GUESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
regGame({
  id:'draw',icon:'ğŸ¨',name:'Draw & Guess',desc:'Pictionary style',color:'#b366ff',
  state:null,
  init(){
    const words=['cat','house','sun','tree','car','fish','hat','boat','star','moon','dog','bird','flower','rain','fire',
      'pizza','guitar','phone','book','clock','shoe','cake','robot','rocket','dragon','crown','sword','key','heart','smile'];
    this.state={word:words[Math.floor(Math.random()*words.length)],strokes:[],curStroke:[],
      drawing:!peerConnected||amPlayer1,timer:60*60,guessed:false,guess:'',score:[0,0],round:1};
    const ti=document.getElementById('textInput');
    if(!this.state.drawing){ti.classList.remove('hidden');ti.placeholder='Type your guess...';ti.value='';ti.focus()}
    else ti.classList.add('hidden');
  },
  update(){
    const s=this.state;if(!s||s.guessed)return;
    s.timer--;
    if(s.timer<=0){showFlash(`Time up! Word was: ${s.word}`,'#ff3366');s.guessed=true;return}
    if(s.drawing){
      if(inp.down){
        s.curStroke.push({x:inp.x/W,y:inp.y/H});
        if(peerConnected&&s.curStroke.length%3===0)peerSend({t:'go',a:'stroke',pts:s.curStroke.slice(-3)});
      }else if(s.curStroke.length){
        s.strokes.push([...s.curStroke]);
        if(peerConnected)peerSend({t:'go',a:'endstroke'});
        s.curStroke=[];
      }
    }else{
      const ti=document.getElementById('textInput');
      if(ti.value&&inp.keys.Enter){
        const guess=ti.value.trim().toLowerCase();ti.value='';
        if(guess===s.word.toLowerCase()){
          s.guessed=true;s.score[1]++;Snd.goal();
          showFlash('ğŸ‰ Correct!','#00ff88');
          ti.classList.add('hidden');
        }else{Snd.bad();peerSend({t:'go',a:'wrong',g:guess})}
        inp.keys.Enter=false;
      }
    }
  },
  draw(){
    const s=this.state;if(!s)return;
    C.fillStyle='#f5f0e8';C.fillRect(0,0,W,H);
    C.strokeStyle='#333';C.lineWidth=3;C.lineCap='round';C.lineJoin='round';
    const drawStroke=(pts)=>{if(pts.length<2)return;C.beginPath();C.moveTo(pts[0].x*W,pts[0].y*H);for(let i=1;i<pts.length;i++)C.lineTo(pts[i].x*W,pts[i].y*H);C.stroke()};
    s.strokes.forEach(drawStroke);
    if(s.curStroke.length)drawStroke(s.curStroke);
    // Word display for drawer
    if(s.drawing)drawText(`Draw: ${s.word}`,W/2,30,20,'#333');
    else drawText('Guess the drawing!',W/2,30,18,'#666');
    const secs=Math.ceil(s.timer/60);
    document.getElementById('gameHUD').innerHTML=`<span style="color:#333">â± ${secs}s</span>`;
  },
  onMsg(m){
    const s=this.state;if(!s)return;
    if(m.a==='stroke')s.curStroke.push(...m.pts);
    if(m.a==='endstroke'){s.strokes.push([...s.curStroke]);s.curStroke=[]}
    if(m.a==='wrong'){/* could display wrong guess */}
    if(m.a==='correct'){s.guessed=true;showFlash('They guessed it!','#00ff88')}
  },
  cleanup(){document.getElementById('textInput').classList.add('hidden')}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5. REACTION DUELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
regGame({
  id:'react',icon:'âš¡',name:'Reaction Duels',desc:'Fastest click wins',color:'#ffaa00',
  state:null,
  init(){this.state={phase:'wait',timer:0,delay:120+Math.floor(Math.random()*240),
    score:[0,0],round:1,p1time:0,p2time:0,result:'',showTime:0,bestOf:7}},
  update(){
    const s=this.state;if(!s)return;
    if(s.phase==='wait'){
      s.timer++;
      if(s.timer>=s.delay){s.phase='go';s.timer=0;Snd.good()}
      if(consumeClick()){s.phase='early';s.score[1]++;Snd.bad();s.result='Too early! Point to P2';s.showTime=120;s.phase='result'}
    }else if(s.phase==='go'){
      s.timer++;
      if(consumeClick()){
        s.p1time=s.timer;s.score[0]++;
        s.result=`${Math.round(s.timer*16.67)}ms â€” You win this round!`;Snd.goal();
        s.showTime=120;s.phase='result';
      }
      // P2 AI reaction
      if(!peerConnected&&s.timer>12+Math.floor(Math.random()*20)){
        if(!s.p2time){s.p2time=s.timer}
        if(!s.p1time&&s.timer>s.p2time+10){
          s.score[1]++;s.result=`AI reacted in ${Math.round(s.p2time*16.67)}ms â€” AI wins!`;Snd.bad();s.showTime=120;s.phase='result';
        }
      }
    }else if(s.phase==='result'){
      s.showTime--;
      if(s.showTime<=0){
        s.round++;s.phase='wait';s.timer=0;s.delay=120+Math.floor(Math.random()*240);s.p1time=0;s.p2time=0;
        if(s.score[0]>=4||s.score[1]>=4){
          showFlash(s.score[0]>=4?'ğŸ† You Win!':'ğŸ’€ You Lose','#ffaa00');
          setTimeout(()=>this.init(),2000);
        }
      }
    }
    if(peerConnected)peerSend({t:'go',phase:s.phase,timer:s.timer});
  },
  draw(){
    const s=this.state;if(!s)return;
    if(s.phase==='wait'){C.fillStyle='#331111';C.fillRect(0,0,W,H);drawText('WAIT...',W/2,H/2,60,'#ff3366')}
    else if(s.phase==='go'){C.fillStyle='#113311';C.fillRect(0,0,W,H);drawText('SHOOT!',W/2,H/2,60,'#00ff88');drawText('TAP NOW!',W/2,H/2+50,20,'#00ff8888')}
    else{drawBg();drawText(s.result,W/2,H/2,22,'#ffaa00');drawText(`Round ${s.round}/${s.bestOf}`,W/2,H/2+40,14,'#5a6488')}
    document.getElementById('gameHUD').innerHTML=`<span style="color:#ff3366">${s.score[0]}</span> â€” <span style="color:#00d4ff">${s.score[1]}</span>  R${s.round}`;
  },
  onMsg(){}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6. TANKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
regGame({
  id:'tanks',icon:'ğŸ’£',name:'Tanks',desc:'Angle + Power artillery',color:'#ff6633',
  state:null,
  init(){
    // Terrain
    const pts=[];const segs=60;
    for(let i=0;i<=segs;i++){
      const x=(i/segs)*W;
      const base=H*0.55+Math.sin(i*.3)*40+Math.sin(i*.7)*25+Math.cos(i*.15)*50;
      pts.push({x,y:base+(Math.random()-.5)*20});
    }
    this.state={terrain:pts,
      p1:{x:W*.2,angle:60,power:50,hp:3},
      p2:{x:W*.8,angle:120,power:50,hp:3},
      turn:1,proj:null,wind:(Math.random()-.5)*2,
      firing:false,result:''};
    // Set Y from terrain
    this.state.p1.y=this._terrainY(this.state.p1.x,pts);
    this.state.p2.y=this._terrainY(this.state.p2.x,pts);
  },
  _terrainY(x,pts){
    for(let i=0;i<pts.length-1;i++){
      if(x>=pts[i].x&&x<=pts[i+1].x){
        const t=(x-pts[i].x)/(pts[i+1].x-pts[i].x);
        return pts[i].y*(1-t)+pts[i+1].y*t;
      }
    }return H*.6;
  },
  update(){
    const s=this.state;if(!s)return;
    const me=s.turn===1?s.p1:s.p2;
    if(!s.firing){
      if(s.turn===1||!peerConnected){
        if(inp.keys.ArrowUp)me.angle=Math.min(170,me.angle+1);
        if(inp.keys.ArrowDown)me.angle=Math.max(10,me.angle-1);
        if(inp.keys.ArrowRight)me.power=Math.min(100,me.power+.5);
        if(inp.keys.ArrowLeft)me.power=Math.max(10,me.power-.5);
        if(inp.keys[' ']){this._fire(s);inp.keys[' ']=false}
      }
    }else if(s.proj){
      s.proj.x+=s.proj.vx;s.proj.y+=s.proj.vy;s.proj.vy+=.15;s.proj.vx+=s.wind*.005;
      const ty=this._terrainY(s.proj.x,s.terrain);
      if(s.proj.y>=ty||s.proj.x<0||s.proj.x>W){
        // Check hit
        const target=s.turn===1?s.p2:s.p1;
        const dist=Math.sqrt((s.proj.x-target.x)**2+(s.proj.y-target.y)**2);
        if(dist<30){target.hp--;Snd.boom();s.result=`Direct hit! ${target===s.p1?'P1':'P2'} takes damage`}
        else{Snd.wall();s.result='Miss!'}
        s.proj=null;s.firing=false;s.turn=s.turn===1?2:1;
        s.wind=(Math.random()-.5)*2;
        if(s.p1.hp<=0)showFlash('ğŸ† P2 Wins!','#00d4ff');
        if(s.p2.hp<=0)showFlash('ğŸ† P1 Wins!','#ff3366');
      }
    }
  },
  _fire(s){
    const me=s.turn===1?s.p1:s.p2;
    const rad=me.angle*Math.PI/180;
    s.proj={x:me.x,y:me.y-10,vx:Math.cos(rad)*me.power*.12*(s.turn===1?1:-1),vy:-Math.sin(rad)*me.power*.12};
    s.firing=true;Snd.whoosh();
    if(peerConnected)peerSend({t:'go',a:'fire',angle:me.angle,power:me.power});
  },
  draw(){
    const s=this.state;if(!s)return;drawBg();
    // Sky gradient
    const sky=C.createLinearGradient(0,0,0,H*.4);sky.addColorStop(0,'#0a0a2e');sky.addColorStop(1,'#161a28');C.fillStyle=sky;C.fillRect(0,0,W,H*.4);
    // Terrain
    C.beginPath();C.moveTo(0,H);
    s.terrain.forEach(p=>C.lineTo(p.x,p.y));
    C.lineTo(W,H);C.closePath();C.fillStyle='#1a2810';C.fill();C.strokeStyle='#2a4820';C.stroke();
    // Tanks
    const drawTank=(p,col)=>{C.fillStyle=col;C.fillRect(p.x-12,p.y-8,24,8);C.fillRect(p.x-8,p.y-14,16,6);
      // HP
      for(let i=0;i<p.hp;i++){C.fillStyle=col;C.fillRect(p.x-10+i*8,p.y-22,6,4)}};
    drawTank(s.p1,'#ff3366');drawTank(s.p2,'#00d4ff');
    // Turret angle indicator
    const me=s.turn===1?s.p1:s.p2;
    const rad=me.angle*Math.PI/180;
    C.strokeStyle='#fff';C.lineWidth=2;C.beginPath();
    C.moveTo(me.x,me.y-11);C.lineTo(me.x+Math.cos(rad)*25*(s.turn===1?1:-1),me.y-11-Math.sin(rad)*25);C.stroke();
    // Projectile
    if(s.proj){C.shadowColor='#ffaa00';C.shadowBlur=10;C.fillStyle='#ffaa00';C.beginPath();C.arc(s.proj.x,s.proj.y,4,0,Math.PI*2);C.fill();C.shadowBlur=0}
    // Wind
    drawText(`Wind: ${s.wind>0?'â†’':'â†'} ${Math.abs(s.wind).toFixed(1)}`,W/2,20,13,'#5a6488');
    // Controls
    drawText(`â†‘â†“ Angle: ${Math.round(me.angle)}Â°  â†â†’ Power: ${Math.round(me.power)}  [Space] Fire`,W/2,H-20,12,'#5a648888');
    document.getElementById('gameHUD').innerHTML=`<span style="color:#ff3366">P1:${'â¤ï¸'.repeat(s.p1.hp)}</span>  <span style="color:#00d4ff">P2:${'â¤ï¸'.repeat(s.p2.hp)}</span>  ${s.result}`;
  },
  onMsg(m){if(m.a==='fire'&&this.state){const s=this.state;const me=s.turn===1?s.p1:s.p2;me.angle=m.angle;me.power=m.power;this._fire(s)}}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 7. CONNECT FOUR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
regGame({
  id:'c4',icon:'ğŸ”´',name:'Connect Four',desc:'Drop 4 in a row',color:'#ff4444',
  state:null,
  init(){
    const cols=7,rows=6;
    const grid=Array.from({length:rows},()=>new Array(cols).fill(0));
    const cellSz=Math.min((W-40)/cols,(H-100)/rows)|0;
    this.state={grid,cols,rows,cellSz,turn:1,winner:0,lastCol:-1,animRow:-1,animCol:-1,animY:0};
  },
  update(){
    const s=this.state;if(!s||s.winner)return;
    const myTurn=(s.turn===1&&(amPlayer1||!peerConnected))||(s.turn===2&&!amPlayer1&&peerConnected);
    if(myTurn&&consumeClick()){
      const ox=(W-s.cols*s.cellSz)/2;
      const col=Math.floor((inp.x-ox)/s.cellSz);
      if(col>=0&&col<s.cols){this._drop(s,col)}
    }
    // AI for P2 local
    if(!peerConnected&&s.turn===2){
      // Simple AI: block or random
      let best=-1;
      for(let c=0;c<s.cols;c++){
        const r=this._topRow(s,c);if(r<0)continue;
        s.grid[r][c]=2;if(this._checkWin(s,r,c)){s.grid[r][c]=0;best=c;break}s.grid[r][c]=0;
        s.grid[r][c]=1;if(this._checkWin(s,r,c)){s.grid[r][c]=0;best=c;break}s.grid[r][c]=0;
      }
      if(best<0){const valid=[];for(let c=0;c<s.cols;c++)if(this._topRow(s,c)>=0)valid.push(c);best=valid[Math.floor(Math.random()*valid.length)]}
      if(best>=0)setTimeout(()=>{if(s.turn===2&&!s.winner)this._drop(s,best)},400);
    }
  },
  _topRow(s,col){for(let r=s.rows-1;r>=0;r--)if(!s.grid[r][col])return r;return -1},
  _drop(s,col){
    const row=this._topRow(s,col);if(row<0)return;
    s.grid[row][col]=s.turn;Snd.hit();
    if(this._checkWin(s,row,col)){s.winner=s.turn;Snd.goal();showFlash(s.winner===1?'ğŸ† Red Wins!':'ğŸ† Blue Wins!',s.winner===1?'#ff3366':'#00d4ff')}
    else s.turn=s.turn===1?2:1;
    if(peerConnected)peerSend({t:'go',col});
  },
  _checkWin(s,r,c){
    const v=s.grid[r][c];
    const dirs=[[0,1],[1,0],[1,1],[1,-1]];
    for(const[dr,dc]of dirs){
      let count=1;
      for(let d=1;d<4;d++){const rr=r+dr*d,cc=c+dc*d;if(rr>=0&&rr<s.rows&&cc>=0&&cc<s.cols&&s.grid[rr][cc]===v)count++;else break}
      for(let d=1;d<4;d++){const rr=r-dr*d,cc=c-dc*d;if(rr>=0&&rr<s.rows&&cc>=0&&cc<s.cols&&s.grid[rr][cc]===v)count++;else break}
      if(count>=4)return true;
    }return false;
  },
  draw(){
    const s=this.state;if(!s)return;drawBg();
    const ox=(W-s.cols*s.cellSz)/2,oy=(H-s.rows*s.cellSz)/2;
    // Board
    C.fillStyle='#0a1a66';C.beginPath();C.roundRect(ox-8,oy-8,s.cols*s.cellSz+16,s.rows*s.cellSz+16,12);C.fill();
    for(let r=0;r<s.rows;r++)for(let c=0;c<s.cols;c++){
      const x=ox+c*s.cellSz+s.cellSz/2,y=oy+r*s.cellSz+s.cellSz/2,rad=s.cellSz*.38;
      C.beginPath();C.arc(x,y,rad,0,Math.PI*2);
      if(s.grid[r][c]===1){C.fillStyle='#ff3366';C.shadowColor='#ff3366';C.shadowBlur=8}
      else if(s.grid[r][c]===2){C.fillStyle='#00d4ff';C.shadowColor='#00d4ff';C.shadowBlur=8}
      else{C.fillStyle='#060a1a';C.shadowBlur=0}
      C.fill();C.shadowBlur=0;
    }
    // Hover indicator
    const hc=Math.floor((inp.x-ox)/s.cellSz);
    if(hc>=0&&hc<s.cols&&!s.winner){
      C.fillStyle=s.turn===1?'#ff336644':'#00d4ff44';
      C.beginPath();C.arc(ox+hc*s.cellSz+s.cellSz/2,oy-s.cellSz/2,s.cellSz*.3,0,Math.PI*2);C.fill();
    }
    document.getElementById('gameHUD').innerHTML=s.winner?`<span style="color:${s.winner===1?'#ff3366':'#00d4ff'}">Player ${s.winner} Wins!</span>`:`<span style="color:${s.turn===1?'#ff3366':'#00d4ff'}">Player ${s.turn}'s Turn</span>`;
  },
  onMsg(m){if(m.col!==undefined&&this.state){this._drop(this.state,m.col)}}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8. WORD BOMB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
regGame({
  id:'wordbomb',icon:'ğŸ’£',name:'Word Bomb',desc:'Type before it explodes',color:'#ff2222',
  state:null,
  init(){
    const combos=['TH','AN','IN','ER','OU','RE','IT','EN','AT','ON','HA','TO','AL','IS','PH','PR','ST','CR','CH','GH','PL','TR','SH','BR','FR','GR','FL','WR','SC','SP'];
    document.getElementById('textInput').classList.remove('hidden');
    document.getElementById('textInput').value='';
    document.getElementById('textInput').placeholder='Type a word with the letters...';
    document.getElementById('textInput').focus();
    this.state={combos,combo:combos[Math.floor(Math.random()*combos.length)],
      turn:1,lives:[3,3],timer:300,maxTime:300,tick:0,result:'',phase:'play',round:1};
  },
  update(){
    const s=this.state;if(!s||s.phase!=='play')return;
    const ti=document.getElementById('textInput');
    const myTurn=(s.turn===1)||(!peerConnected);
    s.tick++;
    if(myTurn&&s.tick>=1)s.timer--;
    if(s.timer<=0){
      // Explode!
      s.lives[s.turn-1]--;Snd.boom();
      s.result=`ğŸ’¥ Player ${s.turn} exploded!`;
      if(s.lives[s.turn-1]<=0){s.phase='over';showFlash(`ğŸ† Player ${s.turn===1?2:1} Wins!`,'#ffaa00');ti.classList.add('hidden');return}
      this._nextRound(s);
    }
    if(myTurn&&inp.keys.Enter){
      const word=ti.value.trim().toUpperCase();ti.value='';
      if(word.length>=3&&word.includes(s.combo)){
        Snd.good();s.result=`âœ… "${word}" â€” nice!`;
        if(peerConnected)peerSend({t:'go',a:'word',w:word});
        this._nextRound(s);
      }else{Snd.bad();s.result=word.length<3?'Too short!':'Doesn\'t contain '+s.combo}
      inp.keys.Enter=false;
    }
  },
  _nextRound(s){
    s.turn=s.turn===1?2:1;s.timer=Math.max(150,s.maxTime-s.round*10);s.round++;s.tick=0;
    s.combo=s.combos[Math.floor(Math.random()*s.combos.length)];
    document.getElementById('textInput').value='';document.getElementById('textInput').focus();
  },
  draw(){
    const s=this.state;if(!s)return;drawBg();
    // Bomb
    const pct=s.timer/s.maxTime;
    const bx=W/2,by=H*.35;
    C.beginPath();C.arc(bx,by,60,0,Math.PI*2);C.fillStyle=`hsl(${pct*60},80%,20%)`;C.fill();
    C.strokeStyle=`hsl(${pct*60},90%,50%)`;C.lineWidth=4;C.stroke();
    // Fuse
    C.strokeStyle=pct<.3?'#ff3333':'#ffaa00';C.lineWidth=3;C.beginPath();
    C.moveTo(bx+40,by-40);C.quadraticCurveTo(bx+55,by-60,bx+50,by-70);C.stroke();
    if(pct<.5){C.fillStyle='#ff6600';C.beginPath();C.arc(bx+50,by-72,5+Math.random()*4,0,Math.PI*2);C.fill()}
    // Letters
    drawText(s.combo,bx,by,48,'#fff');
    // Timer bar
    C.fillStyle='#222';C.fillRect(W*.2,H*.58,W*.6,12);
    C.fillStyle=pct>.3?'#00ff88':pct>.15?'#ffaa00':'#ff3366';
    C.fillRect(W*.2,H*.58,W*.6*pct,12);
    // Lives
    drawText(`P1: ${'â¤ï¸'.repeat(s.lives[0])}${'ğŸ–¤'.repeat(3-s.lives[0])}`,W*.3,H*.7,16);
    drawText(`P2: ${'â¤ï¸'.repeat(s.lives[1])}${'ğŸ–¤'.repeat(3-s.lives[1])}`,W*.7,H*.7,16);
    drawText(s.result,W/2,H*.8,16,'#ffaa00');
    const who=peerConnected?(s.turn===1?'Your':'Their'):(s.turn===1?'P1':'P2');
    document.getElementById('gameHUD').innerHTML=`${who} turn Â· Type a word with <b style="color:#ffaa00">${s.combo}</b>`;
  },
  onMsg(m){if(m.a==='word'&&this.state){Snd.good();this.state.result=`âœ… "${m.w}"`;this._nextRound(this.state)}},
  cleanup(){document.getElementById('textInput').classList.add('hidden')}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9. FINGER FENCING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
regGame({
  id:'fencing',icon:'ğŸ¤º',name:'Finger Fencing',desc:'Lunge & dodge',color:'#ff66aa',
  state:null,
  init(){
    this.state={
      p1:{x:W*.3,y:H/2,vx:0,vy:0,lunge:0,cd:0,r:18},
      p2:{x:W*.7,y:H/2,vx:0,vy:0,lunge:0,cd:0,r:18},
      score:[0,0],frozen:0};
  },
  update(){
    const s=this.state;if(!s)return;
    if(s.frozen>0){s.frozen--;return}
    const spd=4,fric=.88,lungeSpd=18;
    // P1 input (WASD + Space)
    if(inp.keys.a)s.p1.vx-=spd*.15;if(inp.keys.d)s.p1.vx+=spd*.15;
    if(inp.keys.w)s.p1.vy-=spd*.15;if(inp.keys.s)s.p1.vy+=spd*.15;
    if(inp.keys[' ']&&s.p1.cd<=0){s.p1.lunge=8;s.p1.cd=45;inp.keys[' ']=false;Snd.whoosh()}
    // P2 input (Arrows + Enter) or AI
    if(!peerConnected){
      if(inp.keys.ArrowLeft)s.p2.vx-=spd*.15;if(inp.keys.ArrowRight)s.p2.vx+=spd*.15;
      if(inp.keys.ArrowUp)s.p2.vy-=spd*.15;if(inp.keys.ArrowDown)s.p2.vy+=spd*.15;
      if(inp.keys.Enter&&s.p2.cd<=0){s.p2.lunge=8;s.p2.cd=45;inp.keys.Enter=false;Snd.whoosh()}
    }
    [s.p1,s.p2].forEach(p=>{
      if(p.lunge>0){const dx=p===s.p1?1:-1;p.vx+=dx*lungeSpd*.15;p.lunge--}
      p.x+=p.vx;p.y+=p.vy;p.vx*=fric;p.vy*=fric;
      p.x=Math.max(p.r,Math.min(W-p.r,p.x));p.y=Math.max(p.r,Math.min(H-p.r,p.y));
      if(p.cd>0)p.cd--;
    });
    // Hit detection
    const dx=s.p1.x-s.p2.x,dy=s.p1.y-s.p2.y,dist=Math.sqrt(dx*dx+dy*dy);
    if(dist<s.p1.r+s.p2.r){
      if(s.p1.lunge>0&&s.p2.lunge<=0){s.score[0]++;Snd.goal();s.frozen=60;showFlash('ğŸ”´ TouchÃ©!','#ff3366')}
      else if(s.p2.lunge>0&&s.p1.lunge<=0){s.score[1]++;Snd.goal();s.frozen=60;showFlash('ğŸ”µ TouchÃ©!','#00d4ff')}
      else if(s.p1.lunge>0&&s.p2.lunge>0){Snd.hit();s.frozen=30;showFlash('âš”ï¸ Clash!','#ffaa00')}
      // Reset positions
      s.p1.x=W*.3;s.p1.y=H/2;s.p2.x=W*.7;s.p2.y=H/2;
      s.p1.vx=s.p1.vy=s.p2.vx=s.p2.vy=0;s.p1.lunge=s.p2.lunge=0;
      if(s.score[0]>=5)showFlash('ğŸ† Red Wins!','#ff3366');
      if(s.score[1]>=5)showFlash('ğŸ† Blue Wins!','#00d4ff');
    }
    if(peerConnected)peerSend({t:'go',p:amPlayer1?{x:s.p1.x/W,y:s.p1.y/H,l:s.p1.lunge}:{x:s.p2.x/W,y:s.p2.y/H,l:s.p2.lunge}});
  },
  draw(){
    const s=this.state;if(!s)return;drawBg();
    // Arena
    C.strokeStyle='#1a2d5233';C.lineWidth=2;C.beginPath();C.arc(W/2,H/2,Math.min(W,H)*.4,0,Math.PI*2);C.stroke();
    // Center line
    C.strokeStyle='#1a2d5222';C.setLineDash([6,6]);C.beginPath();C.moveTo(W/2,0);C.lineTo(W/2,H);C.stroke();C.setLineDash([]);
    // Players
    const drawFencer=(p,col)=>{
      C.shadowColor=col;C.shadowBlur=p.lunge>0?25:12;C.fillStyle=col;
      C.beginPath();C.arc(p.x,p.y,p.r+(p.lunge>0?4:0),0,Math.PI*2);C.fill();
      C.shadowBlur=0;
      if(p.cd>0){C.strokeStyle='#fff3';C.lineWidth=2;C.beginPath();C.arc(p.x,p.y,p.r+8,0,Math.PI*2*(1-p.cd/45));C.stroke()}
    };
    drawFencer(s.p1,'#ff3366');drawFencer(s.p2,'#00d4ff');
    drawText('P1: WASD + Space',100,H-20,11,'#ff336666');
    drawText('P2: Arrows + Enter',W-100,H-20,11,'#00d4ff66');
    document.getElementById('gameHUD').innerHTML=`<span style="color:#ff3366">${s.score[0]}</span> â€” <span style="color:#00d4ff">${s.score[1]}</span>  First to 5`;
  },
  onMsg(m){if(m.p&&this.state){const target=amPlayer1?this.state.p2:this.state.p1;target.x=m.p.x*W;target.y=m.p.y*H;if(m.p.l>0)target.lunge=m.p.l}}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 10. SPACE JOUST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
regGame({
  id:'joust',icon:'ğŸš€',name:'Space Joust',desc:'Thrust & shoot',color:'#8866ff',
  state:null,
  init(){
    this.state={
      p1:{x:W*.25,y:H/2,vx:0,vy:0,angle:0,bullet:null,cd:0,r:14},
      p2:{x:W*.75,y:H/2,vx:0,vy:0,angle:Math.PI,bullet:null,cd:0,r:14},
      score:[0,0],stars:[],frozen:0};
    for(let i=0;i<80;i++)this.state.stars.push({x:Math.random()*W,y:Math.random()*H,s:Math.random()*2+.5});
  },
  update(){
    const s=this.state;if(!s)return;
    if(s.frozen>0){s.frozen--;return}
    const thrust=.15,rot=.06,fric=.995,bspd=8;
    // P1 controls (WASD + Space)
    if(inp.keys.a)s.p1.angle-=rot;if(inp.keys.d)s.p1.angle+=rot;
    if(inp.keys.w){s.p1.vx+=Math.cos(s.p1.angle)*thrust;s.p1.vy+=Math.sin(s.p1.angle)*thrust}
    if(inp.keys[' ']&&s.p1.cd<=0&&!s.p1.bullet){
      s.p1.bullet={x:s.p1.x,y:s.p1.y,vx:Math.cos(s.p1.angle)*bspd+s.p1.vx,vy:Math.sin(s.p1.angle)*bspd+s.p1.vy,life:120};
      s.p1.cd=30;Snd.whoosh();inp.keys[' ']=false;
    }
    // P2 controls (Arrows + Enter) or AI
    if(!peerConnected){
      if(inp.keys.ArrowLeft)s.p2.angle-=rot;if(inp.keys.ArrowRight)s.p2.angle+=rot;
      if(inp.keys.ArrowUp){s.p2.vx+=Math.cos(s.p2.angle)*thrust;s.p2.vy+=Math.sin(s.p2.angle)*thrust}
      if(inp.keys.Enter&&s.p2.cd<=0&&!s.p2.bullet){
        s.p2.bullet={x:s.p2.x,y:s.p2.y,vx:Math.cos(s.p2.angle)*bspd+s.p2.vx,vy:Math.sin(s.p2.angle)*bspd+s.p2.vy,life:120};
        s.p2.cd=30;Snd.whoosh();inp.keys.Enter=false;
      }
    }
    // Update ships
    [s.p1,s.p2].forEach(p=>{
      p.vx*=fric;p.vy*=fric;p.x+=p.vx;p.y+=p.vy;
      if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;
      if(p.cd>0)p.cd--;
      if(p.bullet){
        p.bullet.x+=p.bullet.vx;p.bullet.y+=p.bullet.vy;p.bullet.life--;
        if(p.bullet.x<0)p.bullet.x=W;if(p.bullet.x>W)p.bullet.x=0;
        if(p.bullet.y<0)p.bullet.y=H;if(p.bullet.y>H)p.bullet.y=0;
        if(p.bullet.life<=0)p.bullet=null;
      }
    });
    // Hit detection
    if(s.p1.bullet){
      const dx=s.p1.bullet.x-s.p2.x,dy=s.p1.bullet.y-s.p2.y;
      if(Math.sqrt(dx*dx+dy*dy)<s.p2.r+4){s.score[0]++;Snd.boom();s.p1.bullet=null;this._respawn(s);s.frozen=60;showFlash('ğŸ”´ Hit!','#ff3366')}
    }
    if(s.p2.bullet){
      const dx=s.p2.bullet.x-s.p1.x,dy=s.p2.bullet.y-s.p1.y;
      if(Math.sqrt(dx*dx+dy*dy)<s.p1.r+4){s.score[1]++;Snd.boom();s.p2.bullet=null;this._respawn(s);s.frozen=60;showFlash('ğŸ”µ Hit!','#00d4ff')}
    }
    if(s.score[0]>=5)showFlash('ğŸ† Red Wins!','#ff3366');
    if(s.score[1]>=5)showFlash('ğŸ† Blue Wins!','#00d4ff');
    if(peerConnected)peerSend({t:'go',p:amPlayer1?{x:s.p1.x/W,y:s.p1.y/H,a:s.p1.angle,b:s.p1.bullet?{x:s.p1.bullet.x/W,y:s.p1.bullet.y/H}:null}:{x:s.p2.x/W,y:s.p2.y/H,a:s.p2.angle,b:s.p2.bullet?{x:s.p2.bullet.x/W,y:s.p2.bullet.y/H}:null}});
  },
  _respawn(s){s.p1.x=W*.25;s.p1.y=H/2;s.p1.vx=s.p1.vy=0;s.p2.x=W*.75;s.p2.y=H/2;s.p2.vx=s.p2.vy=0;s.p1.bullet=s.p2.bullet=null},
  draw(){
    const s=this.state;if(!s)return;drawBg();
    // Stars
    s.stars.forEach(st=>{C.fillStyle=`rgba(255,255,255,${.3+st.s*.2})`;C.fillRect(st.x,st.y,st.s,st.s)});
    // Ships
    const drawShip=(p,col)=>{
      C.save();C.translate(p.x,p.y);C.rotate(p.angle);
      C.shadowColor=col;C.shadowBlur=12;
      C.fillStyle=col;C.beginPath();C.moveTo(18,0);C.lineTo(-10,-10);C.lineTo(-6,0);C.lineTo(-10,10);C.closePath();C.fill();
      C.shadowBlur=0;C.restore();
      // Bullet
      if(p.bullet){C.fillStyle=col;C.shadowColor=col;C.shadowBlur=8;C.beginPath();C.arc(p.bullet.x,p.bullet.y,3,0,Math.PI*2);C.fill();C.shadowBlur=0}
    };
    drawShip(s.p1,'#ff3366');drawShip(s.p2,'#00d4ff');
    drawText('P1: WASD + Space',100,H-20,11,'#ff336666');
    drawText('P2: Arrows + Enter',W-100,H-20,11,'#00d4ff66');
    document.getElementById('gameHUD').innerHTML=`<span style="color:#ff3366">${s.score[0]}</span> â€” <span style="color:#00d4ff">${s.score[1]}</span>  First to 5`;
  },
  onMsg(m){if(m.p&&this.state){
    const target=amPlayer1?this.state.p2:this.state.p1;
    target.x=m.p.x*W;target.y=m.p.y*H;target.angle=m.p.a;
    if(m.p.b)target.bullet={x:m.p.b.x*W,y:m.p.b.y*H,vx:0,vy:0,life:60};else target.bullet=null;
  }}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSOLE MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const gridEl=document.getElementById('gameGrid');
GAMES.forEach(g=>{
  const card=document.createElement('div');card.className='gc';
  card.innerHTML=`<div class="gi">${g.icon}</div><div class="gn" style="color:${g.color}">${g.name}</div><div class="gd">${g.desc}</div>`;
  card.onclick=()=>{
    if(peerConnected&&isHost)peerSend({t:'sel',g:g.id});
    launchGame(g.id,true);
  };
  gridEl.appendChild(card);
});

function launchGame(id,isInitiator){
  const g=GAMES.find(g=>g.id===id);if(!g)return;
  amPlayer1=isInitiator||!peerConnected;
  activeGame=g;
  onPeerMsg=m=>{if(m.t==='go'&&activeGame&&activeGame.onMsg)activeGame.onMsg(m)};
  document.getElementById('console').classList.add('hidden');
  canvas.classList.remove('hidden');
  document.getElementById('gameUI').classList.remove('hidden');
  resize();
  g.init(amPlayer1);
  Snd.click();
}

window.backToMenu=function(){
  if(activeGame&&activeGame.cleanup)activeGame.cleanup();
  if(peerConnected)peerSend({t:'back'});
  activeGame=null;onPeerMsg=null;
  canvas.classList.add('hidden');
  document.getElementById('gameUI').classList.add('hidden');
  document.getElementById('gameHUD').innerHTML='';
  document.getElementById('textInput').classList.add('hidden');
  document.getElementById('console').classList.remove('hidden');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastT=0;
function loop(t){
  requestAnimationFrame(loop);
  if(!activeGame)return;
  _clicked&&consumeClick(); // auto-consume stale clicks
  const dt=Math.min(t-lastT,33);lastT=t;
  activeGame.update(dt);
  activeGame.draw();
  _clicked=false;
}
requestAnimationFrame(loop);

})();
</script>
</body>
</html>
