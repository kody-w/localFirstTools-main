<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="WoWmon Survival - A creature taming survival crafting game set in the wilderness of Azeroth">
    <title>WoWmon Survival - Wilderness of Azeroth</title>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', monospace, system-ui;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            overflow: hidden;
            position: relative;
        }

        /* Enhanced Color Palette */
        :root {
            --gb-darkest: #0f380f;
            --gb-dark: #306230;
            --gb-light: #8bac0f;
            --gb-lightest: #9bbc0f;
            --screen-width: 640px;
            --screen-height: 480px;

            /* Survival colors */
            --primary: #00f2fe;
            --secondary: #4facfe;
            --accent: #f093fb;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #ef4444;
            --dark: #1e293b;
            --darker: #0f172a;
            --hunger: #ff6b35;
            --thirst: #4ecdc4;
            --health: #ff3366;
            --energy: #ffd700;
        }

        /* Main Container */
        .game-container {
            background: linear-gradient(145deg, #2d3748 0%, #1a202c 100%);
            padding: 20px;
            border-radius: 24px;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(79, 172, 254, 0.3);
        }

        /* Game Screen */
        .game-screen {
            width: var(--screen-width);
            height: var(--screen-height);
            background: linear-gradient(180deg, #0a0e27 0%, #1a1f3a 100%);
            position: relative;
            border: 3px solid rgba(79, 172, 254, 0.5);
            border-radius: 16px;
            overflow: hidden;
            box-shadow:
                inset 0 0 40px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(79, 172, 254, 0.3);
        }

        /* Canvas */
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            image-rendering: pixelated;
        }

        /* HUD Overlay */
        .hud-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            pointer-events: none;
            z-index: 10;
        }

        /* Survival Stats Bar */
        .survival-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .stat-bar {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-label {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-icon {
            font-size: 10px;
        }

        .stat-value {
            height: 6px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .stat-fill {
            height: 100%;
            transition: width 0.3s ease;
            position: relative;
        }

        .stat-fill.health { background: linear-gradient(90deg, #ff3366 0%, #ff6b6b 100%); }
        .stat-fill.hunger { background: linear-gradient(90deg, #ff6b35 0%, #ffb347 100%); }
        .stat-fill.thirst { background: linear-gradient(90deg, #4ecdc4 0%, #95e1d3 100%); }
        .stat-fill.energy { background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%); }

        .stat-fill.critical {
            animation: criticalPulse 0.5s ease-in-out infinite;
        }

        @keyframes criticalPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Time and Weather */
        .time-weather {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .time-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
        }

        .day-night-icon {
            font-size: 16px;
        }

        .weather-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
        }

        .temp-display {
            color: var(--warning);
        }

        /* Inventory Quick Access */
        .quick-inventory {
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            gap: 6px;
            z-index: 10;
            pointer-events: none;
        }

        .quick-slot {
            width: 48px;
            height: 48px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 20px;
        }

        .quick-slot.selected {
            border-color: var(--primary);
            box-shadow: 0 0 12px var(--primary);
        }

        .quick-slot-count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 8px;
            background: rgba(0, 0, 0, 0.8);
            padding: 1px 3px;
            border-radius: 3px;
        }

        .quick-slot-number {
            position: absolute;
            top: 2px;
            left: 4px;
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Companion Display */
        .companion-display {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 10;
        }

        .companion-slot {
            width: 56px;
            height: 56px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(74, 222, 128, 0.5);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .companion-slot.active {
            border-color: var(--success);
            box-shadow: 0 0 12px var(--success);
        }

        .companion-icon {
            font-size: 24px;
        }

        .companion-hp {
            width: 48px;
            height: 4px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }

        .companion-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            transition: width 0.3s ease;
        }

        /* Controls */
        .controls {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-btn {
            background: linear-gradient(145deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 8px;
            box-shadow:
                0 4px 0 #0369a1,
                0 6px 16px rgba(79, 172, 254, 0.4);
            font-family: 'Press Start 2P', monospace;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow:
                0 6px 0 #0369a1,
                0 8px 20px rgba(79, 172, 254, 0.6);
        }

        .action-btn:active {
            transform: translateY(2px);
            box-shadow:
                0 2px 0 #0369a1,
                0 4px 10px rgba(79, 172, 254, 0.3);
        }

        .action-btn.craft { background: linear-gradient(145deg, #f093fb 0%, #f5576c 100%); }
        .action-btn.craft:hover { box-shadow: 0 6px 0 #c41e3a, 0 8px 20px rgba(245, 87, 108, 0.6); }
        .action-btn.craft:active { box-shadow: 0 2px 0 #c41e3a, 0 4px 10px rgba(245, 87, 108, 0.3); }

        /* D-Pad */
        .dpad {
            display: grid;
            grid-template-columns: 48px 48px 48px;
            grid-template-rows: 48px 48px 48px;
            gap: 4px;
            padding: 8px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 16px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .dpad-btn {
            background: linear-gradient(145deg, #334155 0%, #1e293b 100%);
            border: 2px solid rgba(79, 172, 254, 0.3);
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 0 #0f172a;
            user-select: none;
            transition: all 0.15s;
            color: var(--primary);
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dpad-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .dpad-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0f172a;
        }

        #up { grid-column: 2; grid-row: 1; }
        #left { grid-column: 1; grid-row: 2; }
        #right { grid-column: 3; grid-row: 2; }
        #down { grid-column: 2; grid-row: 3; }

        /* Modal System */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, #2d3748 0%, #1a202c 100%);
            border: 3px solid var(--primary);
            border-radius: 16px;
            padding: 20px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(79, 172, 254, 0.3);
        }

        .modal-title {
            font-size: 12px;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
        }

        /* Crafting Grid */
        .crafting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .craft-recipe {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .craft-recipe:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .craft-recipe.can-craft {
            border-color: var(--success);
        }

        .craft-recipe.cannot-craft {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recipe-icon {
            font-size: 32px;
            text-align: center;
            margin-bottom: 8px;
        }

        .recipe-name {
            font-size: 8px;
            text-align: center;
            margin-bottom: 8px;
        }

        .recipe-materials {
            font-size: 7px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Inventory Grid */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            font-size: 24px;
            transition: all 0.2s;
        }

        .inventory-slot:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .inventory-slot.selected {
            border-color: var(--success);
            box-shadow: 0 0 12px var(--success);
        }

        .item-count {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 8px;
            background: rgba(0, 0, 0, 0.8);
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Building Grid */
        .building-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .building-option {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .building-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .building-option.can-build {
            border-color: var(--success);
        }

        .building-icon {
            font-size: 40px;
            text-align: center;
            margin-bottom: 8px;
        }

        .building-name {
            font-size: 8px;
            text-align: center;
            margin-bottom: 4px;
        }

        .building-desc {
            font-size: 7px;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            margin-bottom: 8px;
        }

        /* Message Log */
        .message-log {
            position: absolute;
            top: 120px;
            left: 10px;
            right: 10px;
            max-height: 100px;
            overflow-y: auto;
            pointer-events: none;
            z-index: 5;
        }

        .message {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 6px;
            margin-bottom: 4px;
            font-size: 8px;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .message.fade-out {
            animation: messageFade 0.5s ease-out forwards;
        }

        @keyframes messageFade {
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Taming Interface */
        .taming-interface {
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid var(--warning);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .taming-creature {
            font-size: 48px;
            margin: 16px 0;
        }

        .taming-progress {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            margin: 16px 0;
        }

        .taming-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--warning) 0%, var(--success) 100%);
            transition: width 0.3s ease;
        }

        .taming-tip {
            font-size: 8px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 12px;
        }

        /* Tutorial Tips */
        .tutorial-tip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 12px;
            font-size: 8px;
            max-width: 200px;
            z-index: 100;
            animation: tipBounce 0.5s ease-out;
        }

        @keyframes tipBounce {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Status Effects */
        .status-effects {
            position: absolute;
            top: 90px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .status-effect {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 6px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-duration {
            font-size: 8px;
        }

        .status-effect.buff { border-color: var(--success); }
        .status-effect.debuff { border-color: var(--danger); }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-screen">
            <canvas id="gameCanvas"></canvas>

            <!-- HUD Overlay -->
            <div class="hud-overlay">
                <!-- Survival Stats -->
                <div class="survival-stats">
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span class="stat-icon">‚ù§Ô∏è</span>
                            <span id="health-text">100</span>
                        </div>
                        <div class="stat-value">
                            <div class="stat-fill health" id="health-bar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span class="stat-icon">üçñ</span>
                            <span id="hunger-text">100</span>
                        </div>
                        <div class="stat-value">
                            <div class="stat-fill hunger" id="hunger-bar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span class="stat-icon">üíß</span>
                            <span id="thirst-text">100</span>
                        </div>
                        <div class="stat-value">
                            <div class="stat-fill thirst" id="thirst-bar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span class="stat-icon">‚ö°</span>
                            <span id="energy-text">100</span>
                        </div>
                        <div class="stat-value">
                            <div class="stat-fill energy" id="energy-bar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>

                <!-- Time and Weather -->
                <div class="time-weather">
                    <div class="time-display">
                        <span class="day-night-icon" id="time-icon">‚òÄÔ∏è</span>
                        <span id="time-text">Day 1 - 06:00</span>
                    </div>
                    <div class="weather-display">
                        <span id="weather-icon">‚òÄÔ∏è</span>
                        <span id="weather-text">Clear</span>
                        <span class="temp-display" id="temp-text">22¬∞C</span>
                    </div>
                </div>

                <!-- Status Effects -->
                <div class="status-effects" id="status-effects"></div>

                <!-- Message Log -->
                <div class="message-log" id="message-log"></div>
            </div>

            <!-- Quick Inventory -->
            <div class="quick-inventory">
                <div class="quick-slot selected" data-slot="0">
                    <span class="quick-slot-number">1</span>
                    <span id="quick-0-icon">‚úä</span>
                    <span class="quick-slot-count" id="quick-0-count"></span>
                </div>
                <div class="quick-slot" data-slot="1">
                    <span class="quick-slot-number">2</span>
                    <span id="quick-1-icon"></span>
                    <span class="quick-slot-count" id="quick-1-count"></span>
                </div>
                <div class="quick-slot" data-slot="2">
                    <span class="quick-slot-number">3</span>
                    <span id="quick-2-icon"></span>
                    <span class="quick-slot-count" id="quick-2-count"></span>
                </div>
                <div class="quick-slot" data-slot="3">
                    <span class="quick-slot-number">4</span>
                    <span id="quick-3-icon"></span>
                    <span class="quick-slot-count" id="quick-3-count"></span>
                </div>
                <div class="quick-slot" data-slot="4">
                    <span class="quick-slot-number">5</span>
                    <span id="quick-4-icon"></span>
                    <span class="quick-slot-count" id="quick-4-count"></span>
                </div>
            </div>

            <!-- Companion Display -->
            <div class="companion-display" id="companion-display"></div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn" onclick="game.openInventory()">üì¶ Inventory</button>
                <button class="action-btn craft" onclick="game.openCrafting()">üî® Craft</button>
                <button class="action-btn" onclick="game.openBuilding()">üè† Build</button>
            </div>

            <!-- D-Pad -->
            <div class="dpad">
                <button class="dpad-btn" id="up" data-key="ArrowUp">‚Üë</button>
                <button class="dpad-btn" id="left" data-key="ArrowLeft">‚Üê</button>
                <button class="dpad-btn" id="right" data-key="ArrowRight">‚Üí</button>
                <button class="dpad-btn" id="down" data-key="ArrowDown">‚Üì</button>
            </div>

            <!-- Utility Buttons -->
            <div class="action-buttons">
                <button class="action-btn" onclick="game.rest()">üí§ Rest</button>
                <button class="action-btn" onclick="game.openMap()">üó∫Ô∏è Map</button>
                <button class="action-btn" onclick="game.saveGame()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Inventory Modal -->
    <div class="modal" id="inventory-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üì¶ Inventory</h2>
                <button class="close-btn" onclick="game.closeModal('inventory-modal')">‚úï</button>
            </div>
            <div class="inventory-grid" id="inventory-grid"></div>
        </div>
    </div>

    <!-- Crafting Modal -->
    <div class="modal" id="crafting-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üî® Crafting</h2>
                <button class="close-btn" onclick="game.closeModal('crafting-modal')">‚úï</button>
            </div>
            <div class="crafting-grid" id="crafting-grid"></div>
        </div>
    </div>

    <!-- Building Modal -->
    <div class="modal" id="building-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üè† Building</h2>
                <button class="close-btn" onclick="game.closeModal('building-modal')">‚úï</button>
            </div>
            <div class="building-grid" id="building-grid"></div>
        </div>
    </div>

    <!-- Taming Modal -->
    <div class="modal" id="taming-modal">
        <div class="modal-content">
            <div class="taming-interface">
                <h2 class="modal-title">üéØ Taming Creature</h2>
                <div class="taming-creature" id="taming-creature">üê∫</div>
                <div id="taming-name">Wild Wolf</div>
                <div class="taming-progress">
                    <div class="taming-fill" id="taming-fill" style="width: 0%"></div>
                </div>
                <div class="taming-tip">Stay still and offer food to gain trust!</div>
                <button class="action-btn" onclick="game.feedTamingCreature()">üçñ Feed</button>
                <button class="action-btn" onclick="game.cancelTaming()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GAME DATA ====================

        const ITEMS = {
            // Resources
            wood: { id: 'wood', name: 'Wood', icon: 'ü™µ', category: 'resource', stackSize: 99 },
            stone: { id: 'stone', name: 'Stone', icon: 'ü™®', category: 'resource', stackSize: 99 },
            fiber: { id: 'fiber', name: 'Plant Fiber', icon: 'üåæ', category: 'resource', stackSize: 99 },
            metal: { id: 'metal', name: 'Metal Ore', icon: '‚õèÔ∏è', category: 'resource', stackSize: 99 },
            hide: { id: 'hide', name: 'Animal Hide', icon: 'ü¶å', category: 'resource', stackSize: 50 },
            crystal: { id: 'crystal', name: 'Crystal', icon: 'üíé', category: 'resource', stackSize: 20 },

            // Food
            berries: { id: 'berries', name: 'Berries', icon: 'ü´ê', category: 'food', hunger: 10, stackSize: 50 },
            meat_raw: { id: 'meat_raw', name: 'Raw Meat', icon: 'ü•©', category: 'food', hunger: 15, health: -5, stackSize: 20 },
            meat_cooked: { id: 'meat_cooked', name: 'Cooked Meat', icon: 'üçñ', category: 'food', hunger: 30, health: 5, stackSize: 20 },
            fish_raw: { id: 'fish_raw', name: 'Raw Fish', icon: 'üêü', category: 'food', hunger: 12, stackSize: 20 },
            fish_cooked: { id: 'fish_cooked', name: 'Cooked Fish', icon: 'üç£', category: 'food', hunger: 25, health: 3, stackSize: 20 },
            mushroom: { id: 'mushroom', name: 'Mushroom', icon: 'üçÑ', category: 'food', hunger: 8, energy: 5, stackSize: 30 },

            // Tools
            axe_stone: { id: 'axe_stone', name: 'Stone Axe', icon: 'ü™ì', category: 'tool', durability: 50, gatherBonus: 'wood' },
            pickaxe_stone: { id: 'pickaxe_stone', name: 'Stone Pickaxe', icon: '‚õèÔ∏è', category: 'tool', durability: 50, gatherBonus: 'stone' },
            spear_wood: { id: 'spear_wood', name: 'Wooden Spear', icon: 'üó°Ô∏è', category: 'weapon', durability: 30, damage: 10 },
            bow_wood: { id: 'bow_wood', name: 'Wooden Bow', icon: 'üèπ', category: 'weapon', durability: 40, damage: 8, range: 5 },

            // Water
            water_dirty: { id: 'water_dirty', name: 'Dirty Water', icon: 'üíß', category: 'water', thirst: 10, health: -3, stackSize: 10 },
            water_clean: { id: 'water_clean', name: 'Clean Water', icon: 'üí¶', category: 'water', thirst: 30, stackSize: 10 },

            // Taming
            taming_bait: { id: 'taming_bait', name: 'Taming Bait', icon: 'üé£', category: 'special', stackSize: 10 }
        };

        const RECIPES = {
            campfire: {
                id: 'campfire',
                name: 'Campfire',
                icon: 'üî•',
                category: 'structure',
                materials: { wood: 5, stone: 3 },
                description: 'Cook food and stay warm'
            },
            axe_stone: {
                id: 'axe_stone',
                name: 'Stone Axe',
                icon: 'ü™ì',
                materials: { wood: 3, stone: 5, fiber: 2 },
                description: 'Gather wood faster'
            },
            pickaxe_stone: {
                id: 'pickaxe_stone',
                name: 'Stone Pickaxe',
                icon: '‚õèÔ∏è',
                materials: { wood: 3, stone: 6, fiber: 2 },
                description: 'Gather stone and metal'
            },
            spear_wood: {
                id: 'spear_wood',
                name: 'Wooden Spear',
                icon: 'üó°Ô∏è',
                materials: { wood: 5, fiber: 3 },
                description: 'Basic hunting weapon'
            },
            bow_wood: {
                id: 'bow_wood',
                name: 'Wooden Bow',
                icon: 'üèπ',
                materials: { wood: 8, fiber: 5 },
                description: 'Ranged hunting weapon'
            },
            taming_bait: {
                id: 'taming_bait',
                name: 'Taming Bait',
                icon: 'üé£',
                materials: { berries: 3, meat_raw: 1 },
                description: 'Attract and tame creatures'
            },
            meat_cooked: {
                id: 'meat_cooked',
                name: 'Cooked Meat',
                icon: 'üçñ',
                materials: { meat_raw: 1 },
                requiresStructure: 'campfire',
                description: 'Safe and nutritious food'
            },
            fish_cooked: {
                id: 'fish_cooked',
                name: 'Cooked Fish',
                icon: 'üç£',
                materials: { fish_raw: 1 },
                requiresStructure: 'campfire',
                description: 'Restore hunger and health'
            },
            water_clean: {
                id: 'water_clean',
                name: 'Clean Water',
                icon: 'üí¶',
                materials: { water_dirty: 1 },
                requiresStructure: 'campfire',
                description: 'Safe drinking water'
            }
        };

        const BUILDINGS = {
            shelter: {
                id: 'shelter',
                name: 'Shelter',
                icon: '‚õ∫',
                materials: { wood: 20, fiber: 15 },
                description: 'Sleep and save progress',
                size: 3
            },
            campfire: {
                id: 'campfire',
                name: 'Campfire',
                icon: 'üî•',
                materials: { wood: 5, stone: 3 },
                description: 'Cook food and boil water',
                size: 1
            },
            storage: {
                id: 'storage',
                name: 'Storage Box',
                icon: 'üì¶',
                materials: { wood: 15, fiber: 10 },
                description: 'Store extra items',
                size: 2
            },
            workbench: {
                id: 'workbench',
                name: 'Workbench',
                icon: 'üî®',
                materials: { wood: 25, stone: 10 },
                description: 'Craft advanced items',
                size: 2
            },
            fence: {
                id: 'fence',
                name: 'Wooden Fence',
                icon: 'üöß',
                materials: { wood: 5, fiber: 2 },
                description: 'Keep creatures safe',
                size: 1
            },
            farm: {
                id: 'farm',
                name: 'Farm Plot',
                icon: 'üå±',
                materials: { wood: 10, fiber: 20 },
                description: 'Grow food',
                size: 2
            }
        };

        const CREATURES = {
            murloc: {
                id: 'murloc',
                name: 'Murloc',
                icon: 'üê∏',
                type: 'water',
                biome: ['water', 'beach'],
                tameDifficulty: 30,
                abilities: ['fishing', 'swimming'],
                gatherBonus: 'fish_raw',
                description: 'Amphibious fisher'
            },
            wolf: {
                id: 'wolf',
                name: 'Wolf',
                icon: 'üê∫',
                type: 'beast',
                biome: ['forest', 'plains'],
                tameDifficulty: 50,
                abilities: ['hunting', 'tracking'],
                combatBonus: 1.5,
                description: 'Loyal hunting companion'
            },
            wisp: {
                id: 'wisp',
                name: 'Wisp',
                icon: '‚ú®',
                type: 'magic',
                biome: ['forest', 'mountain'],
                tameDifficulty: 70,
                abilities: ['lighting', 'healing'],
                utilityBonus: 'energy',
                description: 'Magical light source'
            },
            bear: {
                id: 'bear',
                name: 'Bear',
                icon: 'üêª',
                type: 'beast',
                biome: ['forest', 'mountain'],
                tameDifficulty: 80,
                abilities: ['gathering', 'protection'],
                gatherBonus: 'berries',
                combatBonus: 2.0,
                description: 'Powerful gatherer'
            },
            raptor: {
                id: 'raptor',
                name: 'Raptor',
                icon: 'ü¶ñ',
                type: 'beast',
                biome: ['plains', 'desert'],
                tameDifficulty: 60,
                abilities: ['speed', 'hunting'],
                speedBonus: 1.5,
                description: 'Fast mount and hunter'
            },
            treant: {
                id: 'treant',
                name: 'Treant',
                icon: 'üå≥',
                type: 'nature',
                biome: ['forest'],
                tameDifficulty: 90,
                abilities: ['wood_gathering', 'defense'],
                gatherBonus: 'wood',
                description: 'Ancient forest guardian'
            }
        };

        const TILES = {
            grass: { id: 'grass', color: '#8bac0f', walkable: true, symbol: ',' },
            forest: { id: 'forest', color: '#306230', walkable: true, symbol: 'üå≤', resources: ['wood', 'berries', 'fiber'] },
            water: { id: 'water', color: '#306230', walkable: false, symbol: '‚âà', resources: ['fish_raw', 'water_dirty'] },
            mountain: { id: 'mountain', color: '#556b2f', walkable: false, symbol: '‚õ∞Ô∏è', resources: ['stone', 'metal', 'crystal'] },
            beach: { id: 'beach', color: '#e0c690', walkable: true, symbol: '.', resources: ['stone', 'fiber'] },
            desert: { id: 'desert', color: '#d4a574', walkable: true, symbol: '~' },
            snow: { id: 'snow', color: '#f0f0f0', walkable: true, symbol: '‚ùÑÔ∏è' }
        };

        const WEATHER_TYPES = ['clear', 'rain', 'storm', 'fog', 'snow'];

        // ==================== GAME ENGINE ====================

        class SurvivalGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.ctx.imageSmoothingEnabled = false;

                // Screen setup
                this.tileSize = 16;
                this.screenTilesX = 40;
                this.screenTilesY = 30;
                this.canvas.width = this.screenTilesX * this.tileSize;
                this.canvas.height = this.screenTilesY * this.tileSize;

                // Player state
                this.player = {
                    x: 20,
                    y: 15,
                    health: 100,
                    maxHealth: 100,
                    hunger: 100,
                    maxHunger: 100,
                    thirst: 100,
                    maxThirst: 100,
                    energy: 100,
                    maxEnergy: 100,
                    icon: 'üßë'
                };

                // Inventory
                this.inventory = {};
                this.quickSlots = [null, null, null, null, null];
                this.selectedSlot = 0;

                // Companions
                this.companions = [];
                this.activeCompanion = null;

                // World
                this.worldSize = 100;
                this.world = this.generateWorld();
                this.structures = [];

                // Time system
                this.time = 360; // Minutes from midnight (6am start)
                this.day = 1;
                this.weather = 'clear';
                this.temperature = 22;

                // Game state
                this.statusEffects = [];
                this.discoveredRecipes = new Set(['axe_stone', 'pickaxe_stone', 'campfire', 'spear_wood']);
                this.tutorialShown = false;

                // Input
                this.keys = {};
                this.lastMoveTime = 0;
                this.moveDelay = 150;

                // Messages
                this.messages = [];

                // Taming
                this.tamingTarget = null;
                this.tamingProgress = 0;

                this.init();
            }

            init() {
                this.setupInput();
                this.addItem('wood', 5);
                this.addItem('stone', 3);
                this.addItem('berries', 3);
                this.addMessage('Welcome to WoWmon Survival! Gather resources to survive.');
                this.addMessage('Press I for inventory, C to craft, B to build.');
                this.gameLoop();
            }

            setupInput() {
                document.addEventListener('keydown', (e) => {
                    if (!this.keys[e.key]) {
                        this.keys[e.key] = true;
                        this.handleKeyPress(e.key);
                    }
                });

                document.addEventListener('keyup', (e) => {
                    this.keys[e.key] = false;
                });

                // Button input
                document.querySelectorAll('[data-key]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.handleKeyPress(btn.dataset.key);
                    });
                });

                // Number keys for quick slots
                for (let i = 1; i <= 5; i++) {
                    document.addEventListener('keydown', (e) => {
                        if (e.key === i.toString()) {
                            this.selectQuickSlot(i - 1);
                        }
                    });
                }

                // Shortcut keys
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'i' || e.key === 'I') this.openInventory();
                    if (e.key === 'c' || e.key === 'C') this.openCrafting();
                    if (e.key === 'b' || e.key === 'B') this.openBuilding();
                    if (e.key === 'e' || e.key === 'E') this.interact();
                });
            }

            handleKeyPress(key) {
                const now = Date.now();
                if (now - this.lastMoveTime < this.moveDelay) return;

                let dx = 0, dy = 0;

                switch(key) {
                    case 'ArrowUp': dy = -1; break;
                    case 'ArrowDown': dy = 1; break;
                    case 'ArrowLeft': dx = -1; break;
                    case 'ArrowRight': dx = 1; break;
                    default: return;
                }

                const newX = this.player.x + dx;
                const newY = this.player.y + dy;

                if (this.canWalk(newX, newY)) {
                    this.player.x = newX;
                    this.player.y = newY;
                    this.lastMoveTime = now;

                    // Energy cost for movement
                    this.modifyEnergy(-0.1);

                    // Check for interaction
                    this.checkTileInteraction(newX, newY);

                    // Random encounter
                    if (Math.random() < 0.02) {
                        this.encounterCreature();
                    }
                }
            }

            canWalk(x, y) {
                if (x < 0 || x >= this.worldSize || y < 0 || y >= this.worldSize) return false;
                const tile = this.world[y][x];
                return TILES[tile].walkable;
            }

            checkTileInteraction(x, y) {
                const tile = this.world[y][x];
                const tileData = TILES[tile];

                if (tileData.resources && Math.random() < 0.15) {
                    const resource = tileData.resources[Math.floor(Math.random() * tileData.resources.length)];
                    const amount = Math.floor(Math.random() * 3) + 1;
                    this.addItem(resource, amount);
                    this.addMessage(`Gathered ${amount}x ${ITEMS[resource].name}`);
                }
            }

            interact() {
                // Check for nearby structures
                const nearbyStructure = this.structures.find(s =>
                    Math.abs(s.x - this.player.x) <= 1 &&
                    Math.abs(s.y - this.player.y) <= 1
                );

                if (nearbyStructure) {
                    if (nearbyStructure.type === 'campfire') {
                        this.addMessage('Standing near campfire. You can cook food!');
                    } else if (nearbyStructure.type === 'shelter') {
                        this.rest();
                    }
                }

                // Check for nearby creatures
                const nearbyCreature = this.findNearbyCreature();
                if (nearbyCreature && !nearbyCreature.tamed) {
                    this.startTaming(nearbyCreature);
                }
            }

            findNearbyCreature() {
                // Simplified - would check actual creature positions
                if (Math.random() < 0.1) {
                    const creatureTypes = Object.keys(CREATURES);
                    const randomType = creatureTypes[Math.floor(Math.random() * creatureTypes.length)];
                    return {
                        ...CREATURES[randomType],
                        tamed: false,
                        x: this.player.x + (Math.random() < 0.5 ? 1 : -1),
                        y: this.player.y + (Math.random() < 0.5 ? 1 : -1)
                    };
                }
                return null;
            }

            startTaming(creature) {
                this.tamingTarget = creature;
                this.tamingProgress = 0;
                document.getElementById('taming-creature').textContent = creature.icon;
                document.getElementById('taming-name').textContent = creature.name;
                document.getElementById('taming-modal').classList.add('active');
                this.addMessage(`Attempting to tame ${creature.name}...`);
            }

            feedTamingCreature() {
                if (!this.tamingTarget) return;

                // Check for food in inventory
                const foodItems = ['berries', 'meat_cooked', 'taming_bait'];
                let fed = false;

                for (const food of foodItems) {
                    if (this.inventory[food] && this.inventory[food] > 0) {
                        this.removeItem(food, 1);
                        const bonus = food === 'taming_bait' ? 30 : 10;
                        this.tamingProgress = Math.min(100, this.tamingProgress + bonus);
                        fed = true;
                        break;
                    }
                }

                if (!fed) {
                    this.addMessage('No food to feed!');
                    return;
                }

                document.getElementById('taming-fill').style.width = this.tamingProgress + '%';

                if (this.tamingProgress >= 100) {
                    this.completeTaming();
                }
            }

            completeTaming() {
                const creature = {
                    ...this.tamingTarget,
                    tamed: true,
                    hp: 100,
                    maxHp: 100,
                    level: 1,
                    experience: 0
                };

                this.companions.push(creature);
                if (!this.activeCompanion) {
                    this.activeCompanion = creature;
                }

                this.addMessage(`Successfully tamed ${creature.name}!`);
                this.cancelTaming();
                this.updateCompanionDisplay();
            }

            cancelTaming() {
                this.tamingTarget = null;
                this.tamingProgress = 0;
                document.getElementById('taming-modal').classList.remove('active');
            }

            encounterCreature() {
                const creatureTypes = Object.keys(CREATURES);
                const randomType = creatureTypes[Math.floor(Math.random() * creatureTypes.length)];
                const creature = CREATURES[randomType];
                this.addMessage(`A wild ${creature.name} appeared! ${creature.icon}`);
            }

            generateWorld() {
                const world = [];
                for (let y = 0; y < this.worldSize; y++) {
                    const row = [];
                    for (let x = 0; x < this.worldSize; x++) {
                        // Simplified biome generation
                        const distance = Math.sqrt(Math.pow(x - 50, 2) + Math.pow(y - 50, 2));

                        if (distance < 3) {
                            row.push('grass'); // Starting area
                        } else if (distance < 15) {
                            row.push(Math.random() < 0.3 ? 'forest' : 'grass');
                        } else if (distance < 30) {
                            const rand = Math.random();
                            if (rand < 0.3) row.push('forest');
                            else if (rand < 0.4) row.push('water');
                            else row.push('grass');
                        } else if (distance < 45) {
                            const rand = Math.random();
                            if (rand < 0.2) row.push('mountain');
                            else if (rand < 0.3) row.push('water');
                            else if (rand < 0.5) row.push('forest');
                            else row.push('grass');
                        } else {
                            row.push('mountain');
                        }
                    }
                    world.push(row);
                }
                return world;
            }

            // Inventory Management
            addItem(itemId, amount = 1) {
                if (!this.inventory[itemId]) {
                    this.inventory[itemId] = 0;
                }
                this.inventory[itemId] += amount;
                this.updateQuickSlots();
            }

            removeItem(itemId, amount = 1) {
                if (!this.inventory[itemId] || this.inventory[itemId] < amount) return false;
                this.inventory[itemId] -= amount;
                if (this.inventory[itemId] === 0) {
                    delete this.inventory[itemId];
                }
                this.updateQuickSlots();
                return true;
            }

            hasItems(requirements) {
                for (const [item, amount] of Object.entries(requirements)) {
                    if (!this.inventory[item] || this.inventory[item] < amount) {
                        return false;
                    }
                }
                return true;
            }

            consumeItems(requirements) {
                for (const [item, amount] of Object.entries(requirements)) {
                    this.removeItem(item, amount);
                }
            }

            useItem(itemId) {
                const item = ITEMS[itemId];
                if (!item) return;

                if (item.category === 'food') {
                    if (item.hunger) this.modifyHunger(item.hunger);
                    if (item.health) this.modifyHealth(item.health);
                    if (item.energy) this.modifyEnergy(item.energy);
                    this.removeItem(itemId, 1);
                    this.addMessage(`Consumed ${item.name}`);
                } else if (item.category === 'water') {
                    if (item.thirst) this.modifyThirst(item.thirst);
                    if (item.health) this.modifyHealth(item.health);
                    this.removeItem(itemId, 1);
                    this.addMessage(`Drank ${item.name}`);
                }
            }

            // UI Management
            selectQuickSlot(slot) {
                this.selectedSlot = slot;
                document.querySelectorAll('.quick-slot').forEach((el, i) => {
                    el.classList.toggle('selected', i === slot);
                });
            }

            updateQuickSlots() {
                const items = Object.keys(this.inventory).slice(0, 5);
                for (let i = 0; i < 5; i++) {
                    const itemId = items[i];
                    const iconEl = document.getElementById(`quick-${i}-icon`);
                    const countEl = document.getElementById(`quick-${i}-count`);

                    if (itemId && ITEMS[itemId]) {
                        iconEl.textContent = ITEMS[itemId].icon;
                        countEl.textContent = this.inventory[itemId];
                        this.quickSlots[i] = itemId;
                    } else {
                        iconEl.textContent = '';
                        countEl.textContent = '';
                        this.quickSlots[i] = null;
                    }
                }
            }

            updateCompanionDisplay() {
                const display = document.getElementById('companion-display');
                display.innerHTML = '';

                this.companions.forEach((companion, i) => {
                    const slot = document.createElement('div');
                    slot.className = 'companion-slot';
                    if (this.activeCompanion === companion) {
                        slot.classList.add('active');
                    }

                    slot.innerHTML = `
                        <span class="companion-icon">${companion.icon}</span>
                        <div class="companion-hp">
                            <div class="companion-hp-fill" style="width: ${(companion.hp / companion.maxHp) * 100}%"></div>
                        </div>
                    `;

                    slot.addEventListener('click', () => {
                        this.activeCompanion = companion;
                        this.updateCompanionDisplay();
                    });

                    display.appendChild(slot);
                });
            }

            // Survival Stats
            modifyHealth(amount) {
                this.player.health = Math.max(0, Math.min(this.player.maxHealth, this.player.health + amount));
                this.updateSurvivalStats();
                if (this.player.health === 0) this.gameOver();
            }

            modifyHunger(amount) {
                this.player.hunger = Math.max(0, Math.min(this.player.maxHunger, this.player.hunger + amount));
                this.updateSurvivalStats();
            }

            modifyThirst(amount) {
                this.player.thirst = Math.max(0, Math.min(this.player.maxThirst, this.player.thirst + amount));
                this.updateSurvivalStats();
            }

            modifyEnergy(amount) {
                this.player.energy = Math.max(0, Math.min(this.player.maxEnergy, this.player.energy + amount));
                this.updateSurvivalStats();
            }

            updateSurvivalStats() {
                const stats = ['health', 'hunger', 'thirst', 'energy'];
                stats.forEach(stat => {
                    const percent = (this.player[stat] / this.player[`max${stat.charAt(0).toUpperCase() + stat.slice(1)}`]) * 100;
                    const bar = document.getElementById(`${stat}-bar`);
                    const text = document.getElementById(`${stat}-text`);

                    bar.style.width = percent + '%';
                    text.textContent = Math.floor(this.player[stat]);

                    if (percent < 20) {
                        bar.classList.add('critical');
                    } else {
                        bar.classList.remove('critical');
                    }
                });
            }

            // Time and Weather
            updateTime() {
                this.time += 0.5; // 30 seconds per game tick
                if (this.time >= 1440) {
                    this.time = 0;
                    this.day++;
                    this.addMessage(`Day ${this.day} begins...`);
                }

                const hours = Math.floor(this.time / 60);
                const minutes = Math.floor(this.time % 60);
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;

                document.getElementById('time-text').textContent = `Day ${this.day} - ${timeString}`;

                // Update day/night icon
                const icon = hours >= 6 && hours < 18 ? '‚òÄÔ∏è' : 'üåô';
                document.getElementById('time-icon').textContent = icon;

                // Random weather changes
                if (Math.random() < 0.001) {
                    this.weather = WEATHER_TYPES[Math.floor(Math.random() * WEATHER_TYPES.length)];
                    this.updateWeather();
                }

                // Survival degradation over time
                if (Math.random() < 0.05) {
                    this.modifyHunger(-0.5);
                    this.modifyThirst(-0.7);
                    if (this.player.energy < 30) {
                        this.modifyHealth(-0.1);
                    }
                }

                // Critical warnings
                if (this.player.hunger < 20 && Math.random() < 0.1) {
                    this.addMessage('You are starving!');
                }
                if (this.player.thirst < 20 && Math.random() < 0.1) {
                    this.addMessage('You are very thirsty!');
                }
            }

            updateWeather() {
                const weatherIcons = {
                    clear: '‚òÄÔ∏è',
                    rain: 'üåßÔ∏è',
                    storm: '‚õàÔ∏è',
                    fog: 'üå´Ô∏è',
                    snow: '‚ùÑÔ∏è'
                };

                document.getElementById('weather-icon').textContent = weatherIcons[this.weather];
                document.getElementById('weather-text').textContent = this.weather.charAt(0).toUpperCase() + this.weather.slice(1);

                // Weather effects
                if (this.weather === 'rain' || this.weather === 'storm') {
                    this.temperature -= 5;
                } else if (this.weather === 'clear') {
                    this.temperature += 2;
                }

                this.temperature = Math.max(-10, Math.min(40, this.temperature));
                document.getElementById('temp-text').textContent = `${this.temperature}¬∞C`;
            }

            // Messages
            addMessage(text) {
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                messageEl.textContent = text;

                const logEl = document.getElementById('message-log');
                logEl.appendChild(messageEl);

                // Remove after 5 seconds
                setTimeout(() => {
                    messageEl.classList.add('fade-out');
                    setTimeout(() => messageEl.remove(), 500);
                }, 5000);

                // Keep only last 3 messages
                while (logEl.children.length > 3) {
                    logEl.children[0].remove();
                }
            }

            // Modal System
            openInventory() {
                const grid = document.getElementById('inventory-grid');
                grid.innerHTML = '';

                Object.entries(this.inventory).forEach(([itemId, count]) => {
                    const item = ITEMS[itemId];
                    if (!item) return;

                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot';
                    slot.innerHTML = `
                        ${item.icon}
                        <div class="item-count">${count}</div>
                    `;

                    slot.addEventListener('click', () => {
                        this.useItem(itemId);
                        this.openInventory(); // Refresh
                    });

                    grid.appendChild(slot);
                });

                document.getElementById('inventory-modal').classList.add('active');
            }

            openCrafting() {
                const grid = document.getElementById('crafting-grid');
                grid.innerHTML = '';

                Object.values(RECIPES).forEach(recipe => {
                    if (!this.discoveredRecipes.has(recipe.id)) return;

                    const canCraft = this.hasItems(recipe.materials);
                    const requiresMet = !recipe.requiresStructure ||
                        this.structures.some(s => s.type === recipe.requiresStructure &&
                            Math.abs(s.x - this.player.x) <= 2 &&
                            Math.abs(s.y - this.player.y) <= 2);

                    const recipeEl = document.createElement('div');
                    recipeEl.className = `craft-recipe ${canCraft && requiresMet ? 'can-craft' : 'cannot-craft'}`;

                    const matsText = Object.entries(recipe.materials)
                        .map(([item, amount]) => `${ITEMS[item].icon}${amount}`)
                        .join(' ');

                    recipeEl.innerHTML = `
                        <div class="recipe-icon">${recipe.icon}</div>
                        <div class="recipe-name">${recipe.name}</div>
                        <div class="recipe-materials">${matsText}</div>
                        ${recipe.requiresStructure ? `<div class="recipe-materials">Needs: ${recipe.requiresStructure}</div>` : ''}
                    `;

                    if (canCraft && requiresMet) {
                        recipeEl.addEventListener('click', () => {
                            this.craft(recipe);
                        });
                    }

                    grid.appendChild(recipeEl);
                });

                document.getElementById('crafting-modal').classList.add('active');
            }

            craft(recipe) {
                if (!this.hasItems(recipe.materials)) {
                    this.addMessage('Not enough materials!');
                    return;
                }

                this.consumeItems(recipe.materials);

                if (recipe.category === 'structure') {
                    // Place structure near player
                    this.structures.push({
                        type: recipe.id,
                        x: this.player.x + 1,
                        y: this.player.y,
                        icon: recipe.icon
                    });
                    this.addMessage(`Built ${recipe.name}!`);
                } else {
                    this.addItem(recipe.id, 1);
                    this.addMessage(`Crafted ${recipe.name}!`);
                }

                this.closeModal('crafting-modal');
            }

            openBuilding() {
                const grid = document.getElementById('building-grid');
                grid.innerHTML = '';

                Object.values(BUILDINGS).forEach(building => {
                    const canBuild = this.hasItems(building.materials);

                    const buildingEl = document.createElement('div');
                    buildingEl.className = `building-option ${canBuild ? 'can-build' : ''}`;

                    const matsText = Object.entries(building.materials)
                        .map(([item, amount]) => `${ITEMS[item].icon}${amount}`)
                        .join(' ');

                    buildingEl.innerHTML = `
                        <div class="building-icon">${building.icon}</div>
                        <div class="building-name">${building.name}</div>
                        <div class="building-desc">${building.description}</div>
                        <div class="recipe-materials">${matsText}</div>
                    `;

                    if (canBuild) {
                        buildingEl.addEventListener('click', () => {
                            this.build(building);
                        });
                    }

                    grid.appendChild(buildingEl);
                });

                document.getElementById('building-modal').classList.add('active');
            }

            build(building) {
                if (!this.hasItems(building.materials)) {
                    this.addMessage('Not enough materials!');
                    return;
                }

                this.consumeItems(building.materials);

                this.structures.push({
                    type: building.id,
                    x: this.player.x + 2,
                    y: this.player.y,
                    icon: building.icon,
                    size: building.size
                });

                this.addMessage(`Built ${building.name}!`);
                this.closeModal('building-modal');
            }

            openMap() {
                this.addMessage('Map feature coming soon!');
            }

            rest() {
                if (this.player.energy < this.player.maxEnergy) {
                    this.modifyEnergy(50);
                    this.modifyHealth(20);
                    this.time += 120; // Advance 2 hours
                    this.addMessage('You rested and feel refreshed!');
                } else {
                    this.addMessage('You are not tired.');
                }
            }

            saveGame() {
                const saveData = {
                    player: this.player,
                    inventory: this.inventory,
                    companions: this.companions,
                    structures: this.structures,
                    time: this.time,
                    day: this.day,
                    weather: this.weather,
                    discoveredRecipes: Array.from(this.discoveredRecipes)
                };

                localStorage.setItem('wowmon_survival_save', JSON.stringify(saveData));
                this.addMessage('Game saved!');
            }

            loadGame() {
                const saveData = localStorage.getItem('wowmon_survival_save');
                if (saveData) {
                    const data = JSON.parse(saveData);
                    Object.assign(this.player, data.player);
                    this.inventory = data.inventory;
                    this.companions = data.companions;
                    this.structures = data.structures;
                    this.time = data.time;
                    this.day = data.day;
                    this.weather = data.weather;
                    this.discoveredRecipes = new Set(data.discoveredRecipes);
                    this.addMessage('Game loaded!');
                    this.updateSurvivalStats();
                    this.updateQuickSlots();
                }
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }

            gameOver() {
                this.addMessage('You died... Game Over');
                setTimeout(() => {
                    if (confirm('You died. Load last save?')) {
                        this.loadGame();
                    } else {
                        location.reload();
                    }
                }, 2000);
            }

            // Rendering
            render() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Calculate camera offset
                const cameraX = Math.floor(this.player.x - this.screenTilesX / 2);
                const cameraY = Math.floor(this.player.y - this.screenTilesY / 2);

                // Render world
                for (let y = 0; y < this.screenTilesY; y++) {
                    for (let x = 0; x < this.screenTilesX; x++) {
                        const worldX = cameraX + x;
                        const worldY = cameraY + y;

                        if (worldX >= 0 && worldX < this.worldSize && worldY >= 0 && worldY < this.worldSize) {
                            const tile = this.world[worldY][worldX];
                            const tileData = TILES[tile];

                            this.ctx.fillStyle = tileData.color;
                            this.ctx.fillRect(x * this.tileSize, y * this.tileSize, this.tileSize, this.tileSize);

                            // Draw symbol if exists
                            if (tileData.symbol && tileData.symbol.length > 1) {
                                this.ctx.font = `${this.tileSize}px Arial`;
                                this.ctx.textAlign = 'center';
                                this.ctx.textBaseline = 'middle';
                                this.ctx.fillText(
                                    tileData.symbol,
                                    x * this.tileSize + this.tileSize / 2,
                                    y * this.tileSize + this.tileSize / 2
                                );
                            }
                        }
                    }
                }

                // Render structures
                this.structures.forEach(structure => {
                    const screenX = structure.x - cameraX;
                    const screenY = structure.y - cameraY;

                    if (screenX >= 0 && screenX < this.screenTilesX && screenY >= 0 && screenY < this.screenTilesY) {
                        this.ctx.font = `${this.tileSize * 1.5}px Arial`;
                        this.ctx.textAlign = 'center';
                        this.ctx.textBaseline = 'middle';
                        this.ctx.fillText(
                            structure.icon,
                            screenX * this.tileSize + this.tileSize / 2,
                            screenY * this.tileSize + this.tileSize / 2
                        );
                    }
                });

                // Render player
                const playerScreenX = this.player.x - cameraX;
                const playerScreenY = this.player.y - cameraY;

                this.ctx.font = `${this.tileSize * 2}px Arial`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(
                    this.player.icon,
                    playerScreenX * this.tileSize + this.tileSize / 2,
                    playerScreenY * this.tileSize + this.tileSize / 2
                );

                // Render active companion
                if (this.activeCompanion) {
                    this.ctx.font = `${this.tileSize * 1.5}px Arial`;
                    this.ctx.fillText(
                        this.activeCompanion.icon,
                        (playerScreenX + 1) * this.tileSize + this.tileSize / 2,
                        playerScreenY * this.tileSize + this.tileSize / 2
                    );
                }

                // Day/night overlay
                const hours = Math.floor(this.time / 60);
                if (hours < 6 || hours >= 18) {
                    const darkness = hours >= 22 || hours < 5 ? 0.6 : 0.3;
                    this.ctx.fillStyle = `rgba(0, 0, 20, ${darkness})`;
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }

                // Weather effects
                if (this.weather === 'rain' || this.weather === 'storm') {
                    this.ctx.fillStyle = 'rgba(100, 150, 200, 0.3)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                } else if (this.weather === 'fog') {
                    this.ctx.fillStyle = 'rgba(200, 200, 200, 0.4)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }
            }

            gameLoop() {
                this.updateTime();
                this.render();
                requestAnimationFrame(() => this.gameLoop());
            }
        }

        // Start game
        let game;
        window.addEventListener('load', () => {
            game = new SurvivalGame();

            // Auto-load on startup
            setTimeout(() => {
                if (localStorage.getItem('wowmon_survival_save')) {
                    if (confirm('Continue from last save?')) {
                        game.loadGame();
                    }
                }
            }, 1000);
        });
    </script>
</body>
</html>