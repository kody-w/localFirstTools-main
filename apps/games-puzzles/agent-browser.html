<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Infiltrator</title>
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="games-puzzles">
<meta name="rappterzoo:tags" content="canvas,game,stealth,hacking,audio,ai">
<meta name="rappterzoo:type" content="game">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="2">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0f;color:#c0c0c0;font-family:'Courier New',monospace;overflow:hidden;height:100vh}
canvas{display:block;width:100%;height:100%}
#hud{position:absolute;top:0;left:0;right:0;padding:6px 14px;display:flex;justify-content:space-between;font-size:12px;background:linear-gradient(180deg,rgba(10,10,15,0.9),transparent);pointer-events:none;z-index:5}
.hc{color:#00ff88;font-weight:bold}.hr{color:#ff4466}.hy{color:#ffcc00}.hb{color:#44aaff}
#ov{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(10,10,15,0.95);z-index:20;transition:opacity 0.3s}
#ov.hide{opacity:0;pointer-events:none}
#ov h1{font-size:2.2rem;color:#00ff88;text-shadow:0 0 30px rgba(0,255,136,0.4);margin-bottom:6px;letter-spacing:3px}
#ov h2{font-size:1rem;color:#667;margin-bottom:18px;font-weight:normal}
.mb{background:linear-gradient(135deg,#0a1a0f,#0f2a1a);border:1px solid #00ff8844;color:#c0c0c0;padding:10px 28px;margin:4px;font-size:0.9rem;border-radius:6px;cursor:pointer;transition:all 0.2s;font-family:'Courier New',monospace}
.mb:hover{border-color:#00ff88;box-shadow:0 0 15px rgba(0,255,136,0.2);transform:scale(1.03)}
.mb.sel{border-color:#00ff88;box-shadow:0 0 10px rgba(0,255,136,0.3)}
#si{font-size:0.78rem;color:#556;margin-top:12px;text-align:center;line-height:1.7}
#si span{color:#00ff88}
.hh{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:0.7rem;color:#334;z-index:5;pointer-events:none}
</style>
</head>
<body>
<div id="hud">
<div>FLOOR <span class="hc" id="h-fl">1</span> | STEALTH <span class="hc" id="h-st">100</span>%</div>
<div>SCORE <span class="hy" id="h-sc">0</span> | COMBO <span class="hb" id="h-co">x1</span></div>
<div>DATA <span class="hb" id="h-dt">0</span>/5 | LIVES <span class="hr" id="h-li">3</span></div>
</div>
<canvas id="c"></canvas>
<div id="ov">
<h1>AGENT INFILTRATOR</h1>
<h2>Hack into server nodes, avoid ICE programs, steal data</h2>
<div>
<button class="mb sel" onclick="sd(0)">Easy</button>
<button class="mb" onclick="sd(1)">Normal</button>
<button class="mb" onclick="sd(2)">Hard</button>
</div>
<button class="mb" style="margin-top:10px;min-width:160px" onclick="sg()">JACK IN</button>
<div id="si"></div>
</div>
<div class="hh">WASD/Arrows move | Q hack terminal | E cloak | SPACE dash | ESC pause | R restart</div>
<script>
const cv=document.getElementById('c'),cx=cv.getContext('2d');
let W,H;function rs(){W=cv.width=innerWidth;H=cv.height=innerHeight}
addEventListener('resize',rs);rs();

// Audio
const AX=window.AudioContext||window.webkitAudioContext;let ax=null;
function ia(){if(!ax)ax=new AX()}
function sn(f,d,t='sine',v=0.1){
  if(!ax)return;const o=ax.createOscillator(),g=ax.createGain();
  o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,ax.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,ax.currentTime+d);
  o.connect(g);g.connect(ax.destination);o.start();o.stop(ax.currentTime+d);
}
function sfxStep(){sn(200+Math.random()*100,0.05,'sine',0.03)}
function sfxHack(){sn(800,0.15);sn(1000,0.1,'triangle',0.08);setTimeout(()=>sn(1200,0.1),60)}
function sfxAlert(){sn(300,0.3,'sawtooth',0.12);sn(400,0.2,'square',0.08)}
function sfxDash(){sn(600,0.1,'triangle',0.08);sn(800,0.08)}
function sfxCollect(){sn(660,0.1);sn(880,0.1,'triangle',0.07)}
function sfxCloak(){sn(440,0.3,'sine',0.06);sn(330,0.2,'triangle',0.05)}
function sfxDie(){sn(100,0.5,'sawtooth',0.15);sn(80,0.4,'square',0.1)}
function sfxFloor(){sn(440,0.2);setTimeout(()=>sn(554,0.15),80);setTimeout(()=>sn(660,0.15),160)}

// State
let diff=1,state='menu',score=0,combo=1,ct=0,floor=1,lives=3;
let stealth=100,dataCollected=0,dataReq=5,fn=0;
let player,enemies=[],terminals=[],walls=[],particles=[],items=[];
let keys={},shX=0,shY=0,shD=0;
let camX=0,camY=0;
let cloakTimer=0,dashCd=0;
let hs=parseInt(localStorage.getItem('ai_hs')||'0');
let bf=parseInt(localStorage.getItem('ai_bf')||'0');
let td=parseInt(localStorage.getItem('ai_td')||'0');
const TS=32; // tile size
let mapW=20,mapH=15;

class Player{
  constructor(x,y){
    this.x=x;this.y=y;this.size=12;this.speed=120;
    this.angle=0;this.cloaked=false;this.hacking=false;
    this.hackProgress=0;this.hackTarget=null;
    this.dashVx=0;this.dashVy=0;this.dashTimer=0;
    this.trail=[];
  }
  update(dt){
    if(this.hacking){
      this.hackProgress+=dt*(diff===0?1.5:diff===1?1:0.7);
      if(this.hackProgress>=1){
        this.hacking=false;this.hackProgress=0;
        if(this.hackTarget){
          this.hackTarget.hacked=true;dataCollected++;td++;
          score+=200*combo;combo++;ct=4;
          sfxHack();spawnP(this.hackTarget.x,this.hackTarget.y,12,'#00ff88');
          shake(3,0.15);
        }
      }
      return;
    }
    let dx=0,dy=0;
    if(keys.ArrowLeft||keys.a)dx=-1;if(keys.ArrowRight||keys.d)dx=1;
    if(keys.ArrowUp||keys.w)dy=-1;if(keys.ArrowDown||keys.s)dy=1;
    if(dx&&dy){dx*=0.707;dy*=0.707}
    // Dash
    if(this.dashTimer>0){
      this.dashTimer-=dt;
      this.x+=this.dashVx*dt;this.y+=this.dashVy*dt;
    }else{
      let spd=this.speed*(this.cloaked?0.7:1);
      this.x+=dx*spd*dt;this.y+=dy*spd*dt;
    }
    if(dx||dy)this.angle=Math.atan2(dy,dx);
    // Wall collision
    for(let w of walls){
      if(this.x>w.x&&this.x<w.x+w.w&&this.y>w.y&&this.y<w.y+w.h){
        // Push out
        let ox=[w.x-this.size,w.x+w.w+this.size];
        let oy=[w.y-this.size,w.y+w.h+this.size];
        let best=Infinity,bx=this.x,by=this.y;
        for(let px of ox){let d=Math.abs(px-this.x);if(d<best){best=d;bx=px;by=this.y}}
        for(let py of oy){let d=Math.abs(py-this.y);if(d<best){best=d;bx=this.x;by=py}}
        this.x=bx;this.y=by;
      }
    }
    // Bounds
    this.x=Math.max(this.size,Math.min(mapW*TS-this.size,this.x));
    this.y=Math.max(this.size,Math.min(mapH*TS-this.size,this.y));
    // Cloak
    if(cloakTimer>0){cloakTimer-=dt;this.cloaked=true}else{this.cloaked=false}
    // Step sounds
    if((dx||dy)&&fn%15===0)sfxStep();
    // Trail
    if(fn%3===0)this.trail.push({x:this.x,y:this.y,life:0.3});
    for(let i=this.trail.length-1;i>=0;i--){this.trail[i].life-=dt;if(this.trail[i].life<=0)this.trail.splice(i,1)}
    // Collect items
    for(let i=items.length-1;i>=0;i--){
      if(Math.hypot(items[i].x-this.x,items[i].y-this.y)<20){
        sfxCollect();score+=items[i].value*combo;
        spawnP(items[i].x,items[i].y,6,items[i].color);
        if(items[i].type==='health')lives=Math.min(5,lives+1);
        if(items[i].type==='stealth')stealth=Math.min(100,stealth+30);
        items.splice(i,1);
      }
    }
  }
  draw(){
    const sx=this.x-camX,sy=this.y-camY;
    // Trail
    for(let t of this.trail){
      cx.fillStyle='#00ff88';cx.globalAlpha=t.life*0.3*(this.cloaked?0.2:1);
      cx.beginPath();cx.arc(t.x-camX,t.y-camY,3,0,Math.PI*2);cx.fill();
    }
    cx.globalAlpha=this.cloaked?0.3:1;
    // Body
    cx.save();cx.translate(sx,sy);cx.rotate(this.angle);
    cx.fillStyle='#00ff88';
    cx.beginPath();cx.moveTo(this.size,0);cx.lineTo(-8,7);cx.lineTo(-4,0);cx.lineTo(-8,-7);cx.closePath();cx.fill();
    // Glow
    cx.globalAlpha=0.15;cx.shadowColor='#00ff88';cx.shadowBlur=20;cx.fill();cx.shadowBlur=0;
    cx.restore();
    cx.globalAlpha=1;
    // Hack bar
    if(this.hacking){
      const bw=30,bh=4;
      cx.fillStyle='#222';cx.fillRect(sx-bw/2,sy-20,bw,bh);
      cx.fillStyle='#00ff88';cx.fillRect(sx-bw/2,sy-20,bw*this.hackProgress,bh);
    }
  }
}

class Enemy{
  constructor(x,y,type){
    this.x=x;this.y=y;this.type=type;
    this.size=10+type*3;this.speed=30+type*15+diff*10;
    this.angle=Math.random()*Math.PI*2;this.fov=Math.PI/3+type*0.2;
    this.viewDist=100+type*30;this.alertLevel=0;
    this.patrolPoints=[];this.patrolIdx=0;
    this.color=['#ff4466','#ff8800','#ff00aa','#aa00ff','#ffcc00'][type]||'#ff4466';
    this.stunTimer=0;
  }
  setPatrol(points){this.patrolPoints=points}
  update(dt){
    if(this.stunTimer>0){this.stunTimer-=dt;return}
    // Patrol
    if(this.patrolPoints.length>0){
      let tp=this.patrolPoints[this.patrolIdx];
      let dx=tp.x-this.x,dy=tp.y-this.y,d=Math.hypot(dx,dy);
      if(d<5){this.patrolIdx=(this.patrolIdx+1)%this.patrolPoints.length}
      else{this.x+=dx/d*this.speed*dt;this.y+=dy/d*this.speed*dt;this.angle=Math.atan2(dy,dx)}
    }
    // Detection
    if(player&&!player.cloaked){
      let dx=player.x-this.x,dy=player.y-this.y,d=Math.hypot(dx,dy);
      let a=Math.atan2(dy,dx);
      let diff2=Math.abs(((a-this.angle+Math.PI*3)%(Math.PI*2))-Math.PI);
      if(d<this.viewDist&&diff2<this.fov/2){
        this.alertLevel=Math.min(1,this.alertLevel+dt*(d<50?3:1));
        if(this.alertLevel>=1){
          // Chase
          this.x+=dx/d*(this.speed*1.5)*dt;this.y+=dy/d*(this.speed*1.5)*dt;
          this.angle=a;
          stealth=Math.max(0,stealth-dt*20);
          // Catch
          if(d<this.size+player.size){
            sfxDie();lives--;stealth=Math.max(0,stealth-30);
            shake(8,0.3);spawnP(player.x,player.y,20,'#ff4466');
            player.x=TS*2;player.y=TS*2;combo=1;
            if(lives<=0){
              state='gameover';
              if(score>hs){hs=score;localStorage.setItem('ai_hs',hs)}
              if(floor>bf){bf=floor;localStorage.setItem('ai_bf',bf)}
              localStorage.setItem('ai_td',td);
              showOv('gameover');
            }
          }
        }
      }else{
        this.alertLevel=Math.max(0,this.alertLevel-dt*0.5);
      }
    }else{
      this.alertLevel=Math.max(0,this.alertLevel-dt*0.5);
    }
  }
  draw(){
    const sx=this.x-camX,sy=this.y-camY;
    // FOV cone
    cx.save();cx.translate(sx,sy);cx.rotate(this.angle);
    cx.fillStyle=this.alertLevel>0.5?'#ff444422':'#ffcc0011';
    cx.beginPath();cx.moveTo(0,0);
    cx.arc(0,0,this.viewDist,-this.fov/2,this.fov/2);
    cx.closePath();cx.fill();
    // Body
    cx.fillStyle=this.color;cx.globalAlpha=0.9;
    cx.beginPath();
    for(let i=0;i<(3+this.type);i++){
      let a=i*Math.PI*2/(3+this.type)-Math.PI/2;
      cx.lineTo(Math.cos(a)*this.size,Math.sin(a)*this.size);
    }
    cx.closePath();cx.fill();
    cx.restore();
    // Alert indicator
    if(this.alertLevel>0.1){
      cx.fillStyle='#ff4466';cx.font='bold 14px monospace';cx.textAlign='center';
      cx.globalAlpha=this.alertLevel;
      cx.fillText('!',sx,sy-this.size-8);
    }
    cx.globalAlpha=1;
  }
}

// Particles
let parts=[];
function spawnP(x,y,n,col){for(let i=0;i<n;i++){
  let a=Math.random()*Math.PI*2,s=40+Math.random()*100;
  parts.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:0.3+Math.random()*0.3,ml:0.5,size:1+Math.random()*3,color:col});
}}
function shake(a,d){shX=a;shY=a;shD=d}

// Map generation
function genMap(){
  walls=[];terminals=[];enemies=[];items=[];parts=[];
  dataCollected=0;stealth=100;
  mapW=16+Math.min(8,floor*2);mapH=12+Math.min(6,floor);
  dataReq=3+floor+diff;

  // Generate rooms
  let rooms=[];
  for(let i=0;i<4+floor;i++){
    let rw=3+Math.floor(Math.random()*4),rh=3+Math.floor(Math.random()*3);
    let rx=1+Math.floor(Math.random()*(mapW-rw-2)),ry=1+Math.floor(Math.random()*(mapH-rh-2));
    rooms.push({x:rx,y:ry,w:rw,h:rh});
  }

  // Build wall grid
  let grid=Array(mapH).fill(null).map(()=>Array(mapW).fill(1));
  // Carve rooms
  for(let r of rooms){
    for(let y=r.y;y<r.y+r.h;y++){
      for(let x=r.x;x<r.x+r.w;x++){
        if(x>=0&&x<mapW&&y>=0&&y<mapH)grid[y][x]=0;
      }
    }
  }
  // Connect rooms with corridors
  for(let i=0;i<rooms.length-1;i++){
    let a=rooms[i],b=rooms[i+1];
    let ax=Math.floor(a.x+a.w/2),ay=Math.floor(a.y+a.h/2);
    let bx=Math.floor(b.x+b.w/2),by=Math.floor(b.y+b.h/2);
    let cx2=ax,cy2=ay;
    while(cx2!==bx){cx2+=cx2<bx?1:-1;if(cy2>=0&&cy2<mapH&&cx2>=0&&cx2<mapW)grid[cy2][cx2]=0}
    while(cy2!==by){cy2+=cy2<by?1:-1;if(cy2>=0&&cy2<mapH&&cx2>=0&&cx2<mapW)grid[cy2][cx2]=0}
  }

  // Convert grid to wall rects
  for(let y=0;y<mapH;y++){
    for(let x=0;x<mapW;x++){
      if(grid[y][x]===1)walls.push({x:x*TS,y:y*TS,w:TS,h:TS});
    }
  }

  // Place terminals in rooms
  for(let i=0;i<dataReq+2;i++){
    let r=rooms[Math.floor(Math.random()*rooms.length)];
    let tx=r.x+1+Math.floor(Math.random()*(r.w-2)),ty=r.y+1+Math.floor(Math.random()*(r.h-2));
    terminals.push({x:tx*TS+TS/2,y:ty*TS+TS/2,hacked:false,size:8,pulse:0});
  }

  // Place enemies
  let numEnemies=2+floor+diff*2;
  for(let i=0;i<numEnemies;i++){
    let r=rooms[1+Math.floor(Math.random()*(rooms.length-1))];
    let ex=r.x*TS+r.w*TS/2,ey=r.y*TS+r.h*TS/2;
    let type=Math.min(4,Math.floor(Math.random()*(1+floor/3)));
    let e=new Enemy(ex,ey,type);
    // Simple patrol
    let p1={x:r.x*TS+TS,y:r.y*TS+TS};
    let p2={x:(r.x+r.w-1)*TS,y:(r.y+r.h-1)*TS};
    e.setPatrol([p1,p2,{x:p2.x,y:p1.y},{x:p1.x,y:p2.y}]);
    enemies.push(e);
  }

  // Boss every 5 floors
  if(floor%5===0){
    let br=rooms[rooms.length-1];
    let boss=new Enemy(br.x*TS+br.w*TS/2,br.y*TS+br.h*TS/2,4);
    boss.viewDist=180;boss.speed=60;boss.size=18;
    boss.setPatrol([{x:br.x*TS,y:br.y*TS},{x:(br.x+br.w)*TS,y:(br.y+br.h)*TS}]);
    enemies.push(boss);
  }

  // Place items
  for(let i=0;i<3+floor;i++){
    let r=rooms[Math.floor(Math.random()*rooms.length)];
    let ix=r.x*TS+Math.random()*r.w*TS,iy=r.y*TS+Math.random()*r.h*TS;
    let t=Math.random();
    if(t<0.3)items.push({x:ix,y:iy,type:'health',value:0,color:'#ff4466',size:6});
    else if(t<0.6)items.push({x:ix,y:iy,type:'stealth',value:0,color:'#00ff88',size:6});
    else items.push({x:ix,y:iy,type:'data',value:50,color:'#44aaff',size:6});
  }

  // Player start
  player=new Player(rooms[0].x*TS+rooms[0].w*TS/2,rooms[0].y*TS+rooms[0].h*TS/2);
  sfxFloor();
}

// Input
document.addEventListener('keydown',e=>{
  keys[e.key]=true;
  if(e.key==='q'||e.key==='Q'){
    if(state==='playing'&&player&&!player.hacking){
      // Try to hack nearest terminal
      for(let t of terminals){
        if(!t.hacked&&Math.hypot(t.x-player.x,t.y-player.y)<30){
          player.hacking=true;player.hackProgress=0;player.hackTarget=t;break;
        }
      }
    }
  }
  if(e.key==='e'||e.key==='E'){
    if(state==='playing'&&cloakTimer<=0){cloakTimer=5;sfxCloak()}
  }
  if(e.key===' '){
    e.preventDefault();
    if(state==='playing'&&dashCd<=0&&player){
      dashCd=3;player.dashTimer=0.15;
      let dx=0,dy=0;
      if(keys.ArrowLeft||keys.a)dx=-1;if(keys.ArrowRight||keys.d)dx=1;
      if(keys.ArrowUp||keys.w)dy=-1;if(keys.ArrowDown||keys.s)dy=1;
      if(!dx&&!dy)dx=Math.cos(player.angle),dy=Math.sin(player.angle);
      let d=Math.hypot(dx,dy)||1;
      player.dashVx=dx/d*400;player.dashVy=dy/d*400;
      sfxDash();spawnP(player.x,player.y,8,'#00ff88');
    }
  }
  if(e.key==='Escape'){
    if(state==='playing'){state='paused';showOv('pause')}
    else if(state==='paused'){state='playing';document.getElementById('ov').classList.add('hide')}
  }
  if(e.key==='r'||e.key==='R'){if(state==='gameover')sg()}
});
document.addEventListener('keyup',e=>{keys[e.key]=false});

// Touch
let tx=0,ty=0;
cv.addEventListener('touchstart',e=>{
  e.preventDefault();ia();
  tx=e.touches[0].clientX;ty=e.touches[0].clientY;
  if(state==='playing'){
    // Tap right side = dash, left side = hack
    if(tx>W/2){keys[' ']=true;setTimeout(()=>{keys[' ']=false},100)}
    else{keys.q=true;setTimeout(()=>{keys.q=false},100)}
  }
},{passive:false});
cv.addEventListener('touchmove',e=>{
  e.preventDefault();
  let dx=e.touches[0].clientX-tx,dy=e.touches[0].clientY-ty;
  keys.a=dx<-20;keys.d=dx>20;keys.w=dy<-20;keys.s=dy>20;
},{passive:false});
cv.addEventListener('touchend',()=>{keys.a=keys.d=keys.w=keys.s=false});

// Game loop
let lt=0;
function loop(t){
  requestAnimationFrame(loop);
  let dt=Math.min(0.05,(t-lt)/1000);lt=t;
  if(state!=='playing'){draw();return}
  fn++;
  ct-=dt;if(ct<=0){combo=1;ct=0}
  dashCd=Math.max(0,dashCd-dt);
  if(shD>0){shD-=dt;shX*=0.9;shY*=0.9}else{shX=0;shY=0}

  if(player){
    player.update(dt);
    // Camera follow
    camX+=(player.x-W/2-camX)*0.08;camY+=(player.y-H/2-camY)*0.08;
  }
  for(let e of enemies)e.update(dt);
  for(let t of terminals){t.pulse=(t.pulse+dt*2)%(Math.PI*2)}
  for(let i=parts.length-1;i>=0;i--){
    let p=parts[i];p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;p.vx*=0.94;p.vy*=0.94;
    if(p.life<=0)parts.splice(i,1);
  }

  // Check floor complete
  if(dataCollected>=dataReq){
    floor++;score+=1000*floor;
    if(floor>bf){bf=floor;localStorage.setItem('ai_bf',bf)}
    genMap();
  }

  // Stealth depletion
  if(stealth<=0){
    // All enemies alerted
    for(let e of enemies)e.alertLevel=1;
  }

  // HUD
  document.getElementById('h-fl').textContent=floor;
  document.getElementById('h-st').textContent=Math.ceil(stealth);
  document.getElementById('h-st').className=stealth<30?'hr':'hc';
  document.getElementById('h-sc').textContent=score.toLocaleString();
  document.getElementById('h-co').textContent='x'+combo;
  document.getElementById('h-dt').textContent=dataCollected;
  document.getElementById('h-li').textContent=lives;

  draw();
}

function draw(){
  cx.save();
  cx.translate(shX*(Math.random()-0.5)*2,shY*(Math.random()-0.5)*2);
  cx.fillStyle='#0a0a0f';cx.fillRect(0,0,W,H);

  // Walls
  for(let w of walls){
    let sx=w.x-camX,sy=w.y-camY;
    if(sx>-TS&&sx<W+TS&&sy>-TS&&sy<H+TS){
      cx.fillStyle='#151520';cx.fillRect(sx,sy,w.w-1,w.h-1);
      cx.strokeStyle='#1a1a2a';cx.lineWidth=1;cx.strokeRect(sx,sy,w.w-1,w.h-1);
    }
  }

  // Floor grid
  cx.strokeStyle='#111118';cx.lineWidth=0.5;
  let gox=(-camX%TS+TS)%TS,goy=(-camY%TS+TS)%TS;
  for(let x=gox;x<W;x+=TS){cx.beginPath();cx.moveTo(x,0);cx.lineTo(x,H);cx.stroke()}
  for(let y=goy;y<H;y+=TS){cx.beginPath();cx.moveTo(0,y);cx.lineTo(W,y);cx.stroke()}

  // Items
  for(let it of items){
    let sx=it.x-camX,sy=it.y-camY+Math.sin(fn*0.05)*3;
    cx.fillStyle=it.color;cx.globalAlpha=0.8;
    cx.beginPath();cx.arc(sx,sy,it.size,0,Math.PI*2);cx.fill();
    cx.globalAlpha=0.2;cx.beginPath();cx.arc(sx,sy,it.size*2,0,Math.PI*2);cx.fill();
    cx.globalAlpha=1;
  }

  // Terminals
  for(let t of terminals){
    let sx=t.x-camX,sy=t.y-camY;
    cx.fillStyle=t.hacked?'#00ff8844':'#44aaff';cx.globalAlpha=t.hacked?0.3:0.8;
    let pulse=1+Math.sin(t.pulse)*0.15;
    cx.beginPath();cx.arc(sx,sy,t.size*pulse,0,Math.PI*2);cx.fill();
    if(!t.hacked){
      cx.globalAlpha=0.15;cx.beginPath();cx.arc(sx,sy,t.size*2.5,0,Math.PI*2);cx.fill();
    }
    cx.globalAlpha=1;
    cx.fillStyle=t.hacked?'#00ff88':'#fff';cx.font='bold 8px monospace';cx.textAlign='center';
    cx.fillText(t.hacked?'OK':'$',sx,sy+3);
  }

  // Enemies
  for(let e of enemies)e.draw();

  // Player
  if(player)player.draw();

  // Particles
  for(let p of parts){
    cx.fillStyle=p.color;cx.globalAlpha=p.life/p.ml;
    cx.fillRect(p.x-camX-p.size/2,p.y-camY-p.size/2,p.size,p.size);
  }
  cx.globalAlpha=1;

  // Minimap
  const mmW=120,mmH=90,mmX=W-mmW-10,mmY=H-mmH-10;
  cx.fillStyle='#0a0a0f88';cx.fillRect(mmX,mmY,mmW,mmH);
  cx.strokeStyle='#333';cx.strokeRect(mmX,mmY,mmW,mmH);
  const sx2=mmW/(mapW*TS),sy2=mmH/(mapH*TS);
  // Mini walls
  cx.fillStyle='#222';
  for(let w of walls){cx.fillRect(mmX+w.x*sx2,mmY+w.y*sy2,Math.max(1,w.w*sx2),Math.max(1,w.h*sy2))}
  // Mini terminals
  for(let t of terminals){
    cx.fillStyle=t.hacked?'#00ff8844':'#44aaff';
    cx.fillRect(mmX+t.x*sx2-1,mmY+t.y*sy2-1,3,3);
  }
  // Mini enemies
  cx.fillStyle='#ff4466';
  for(let e of enemies){cx.fillRect(mmX+e.x*sx2-1,mmY+e.y*sy2-1,2,2)}
  // Mini player
  if(player){cx.fillStyle='#00ff88';cx.fillRect(mmX+player.x*sx2-2,mmY+player.y*sy2-2,4,4)}

  // Ability indicators
  if(state==='playing'){
    cx.font='11px monospace';cx.textAlign='left';
    cx.fillStyle=cloakTimer>0?'#00ff88':'#444';
    cx.fillText('E:Cloak'+(cloakTimer>0?' '+cloakTimer.toFixed(1)+'s':''),10,H-30);
    cx.fillStyle=dashCd<=0?'#44aaff':'#444';
    cx.fillText('SPC:Dash'+(dashCd>0?' '+dashCd.toFixed(1)+'s':''),10,H-15);
  }

  // Combo
  if(combo>1){
    cx.fillStyle='#ffcc00';cx.font='bold 20px monospace';cx.textAlign='center';
    cx.globalAlpha=Math.min(1,ct/2);
    cx.fillText('COMBO x'+combo,W/2,65);cx.globalAlpha=1;
  }

  cx.restore();
}

function showOv(mode){
  const ov=document.getElementById('ov');
  ov.classList.remove('hide');
  const h1=ov.querySelector('h1'),h2=ov.querySelector('h2'),si=document.getElementById('si');
  if(mode==='gameover'){
    h1.textContent='JACKED OUT';h1.style.color='#ff4466';
    h2.textContent='Your neural link was severed';
    let end='';
    if(floor>=15)end='ENDING: Ghost in the Machine -- You became one with the network.';
    else if(floor>=10)end='ENDING: Shadow Operative -- The servers remember your silence.';
    else if(floor>=5)end='ENDING: Script Kiddie -- A promising start, cut short.';
    else end='ENDING: Noob Detected -- The ICE barely noticed you.';
    si.innerHTML='Score: <span>'+score.toLocaleString()+'</span> | Floor: <span>'+floor+'</span><br>'+
      'High Score: <span>'+hs.toLocaleString()+'</span> | Best Floor: <span>'+bf+'</span><br>'+
      'Total Data: <span>'+td+'</span><br><span style="color:#ffcc00">'+end+'</span>';
  }else if(mode==='pause'){
    h1.textContent='PAUSED';h1.style.color='#00ff88';h2.textContent='ESC to resume';
    si.innerHTML='Floor: <span>'+floor+'</span> | Score: <span>'+score.toLocaleString()+'</span>';
  }else{
    h1.textContent='AGENT INFILTRATOR';h1.style.color='#00ff88';
    h2.textContent='Hack into server nodes, avoid ICE programs, steal data';
    si.innerHTML='High Score: <span>'+hs.toLocaleString()+'</span> | Best Floor: <span>'+bf+'</span>';
  }
}

function sd(d){diff=d;document.querySelectorAll('.mb').forEach((b,i)=>{if(i<3)b.classList.toggle('sel',i===d)})}
function sg(){
  ia();state='playing';score=0;combo=1;ct=0;floor=1;lives=3;
  genMap();document.getElementById('ov').classList.add('hide');
}

showOv('menu');
requestAnimationFrame(loop);
</script>
</body>
</html>
