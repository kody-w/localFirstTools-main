<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE TRIAL - A Kafkaesque Courtroom Nightmare</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', 'Georgia', serif;
            background: #0a0a0a;
            color: #f4e8d8;
            overflow: hidden;
            height: 100vh;
        }

        #game-container {
            width: 100%;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #courtroom-canvas {
            width: 100%;
            height: 60vh;
            background: linear-gradient(180deg, #1a1410 0%, #2d1f1a 50%, #1a1410 100%);
            border-bottom: 3px solid #8b0000;
            position: relative;
        }

        #ui-layer {
            flex: 1;
            background: #1a1410;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .glitch {
            animation: glitch 0.3s infinite;
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .title-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 1s;
        }

        .title-screen h1 {
            font-size: 4em;
            color: #8b0000;
            text-shadow: 3px 3px 0 #000;
            margin-bottom: 20px;
            letter-spacing: 8px;
        }

        .title-screen p {
            font-size: 1.2em;
            color: #f4e8d8;
            margin-bottom: 40px;
            max-width: 600px;
            text-align: center;
            line-height: 1.6;
        }

        .title-screen button {
            font-size: 1.5em;
            padding: 15px 40px;
            background: #8b0000;
            color: #f4e8d8;
            border: 2px solid #f4e8d8;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        .title-screen button:hover {
            background: #f4e8d8;
            color: #8b0000;
            transform: scale(1.05);
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border: 2px solid #8b0000;
            min-width: 300px;
        }

        #hud h3 {
            color: #8b0000;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .meter {
            margin: 10px 0;
        }

        .meter-label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .meter-bar {
            width: 100%;
            height: 20px;
            background: #000;
            border: 1px solid #f4e8d8;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b0000, #ff0000);
            transition: width 0.5s;
        }

        .meter-fill.sanity {
            background: linear-gradient(90deg, #00008b, #0000ff);
        }

        #dialogue-box {
            background: rgba(0,0,0,0.95);
            border: 3px solid #8b0000;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 150px;
        }

        .speaker-name {
            font-size: 1.3em;
            color: #8b0000;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .dialogue-text {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .choice-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: #2d1f1a;
            border: 2px solid #8b0000;
            color: #f4e8d8;
            padding: 15px 20px;
            font-size: 1em;
            font-family: inherit;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }

        .choice-btn:hover {
            background: #8b0000;
            transform: translateX(10px);
        }

        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #objection-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .objection-btn {
            background: #8b0000;
            border: 3px solid #f4e8d8;
            color: #f4e8d8;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .objection-btn:hover:not(:disabled) {
            background: #ff0000;
            transform: scale(1.1);
            box-shadow: 0 0 20px #ff0000;
        }

        .objection-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .objection-menu {
            background: rgba(0,0,0,0.95);
            border: 3px solid #8b0000;
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 5px;
        }

        .objection-menu.active {
            display: flex;
        }

        .objection-option {
            background: #2d1f1a;
            border: 1px solid #8b0000;
            color: #f4e8d8;
            padding: 10px;
            font-size: 0.9em;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .objection-option:hover {
            background: #8b0000;
        }

        #evidence-panel {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .evidence-item {
            background: #2d1f1a;
            border: 2px solid #8b0000;
            padding: 10px;
            width: 120px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .evidence-item:hover {
            transform: translateY(-5px);
            border-color: #ff0000;
            box-shadow: 0 5px 15px rgba(139,0,0,0.5);
        }

        .evidence-item.selected {
            border-color: #00ff00;
            background: #1a3a1a;
        }

        .evidence-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .evidence-name {
            font-size: 0.8em;
        }

        #jury-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            border: 2px solid #8b0000;
            padding: 10px;
            width: 200px;
        }

        .jury-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .juror {
            width: 50px;
            height: 50px;
            border: 1px solid #f4e8d8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            position: relative;
        }

        .juror.convinced { background: #00ff00; }
        .juror.confused { background: #ffff00; }
        .juror.asleep { background: #666; }
        .juror.hostile { background: #ff0000; }
        .juror.ascended { background: #00ffff; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .verdict-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 500;
        }

        .verdict-screen.active {
            display: flex;
        }

        .verdict-screen h2 {
            font-size: 3em;
            color: #8b0000;
            margin-bottom: 20px;
        }

        .verdict-screen p {
            font-size: 1.3em;
            max-width: 600px;
            text-align: center;
            margin-bottom: 30px;
        }

        .sanity-low #courtroom-canvas {
            animation: distort 0.5s infinite;
        }

        @keyframes distort {
            0%, 100% { transform: skewX(0deg); }
            25% { transform: skewX(0.5deg); }
            75% { transform: skewX(-0.5deg); }
        }

        .case-intro {
            background: rgba(0,0,0,0.98);
            border: 5px solid #8b0000;
            padding: 40px;
            margin: 20px auto;
            max-width: 800px;
        }

        .case-intro h2 {
            font-size: 2.5em;
            color: #8b0000;
            margin-bottom: 20px;
            text-align: center;
        }

        .case-intro .charge {
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
            font-style: italic;
        }

        .case-intro .details {
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .continue-btn {
            background: #8b0000;
            border: 2px solid #f4e8d8;
            color: #f4e8d8;
            padding: 15px 40px;
            font-size: 1.2em;
            cursor: pointer;
            font-family: inherit;
            display: block;
            margin: 0 auto;
            transition: all 0.3s;
        }

        .continue-btn:hover {
            background: #ff0000;
            transform: scale(1.05);
        }

        .typewriter {
            overflow: hidden;
            white-space: pre-wrap;
        }

        #case-select {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            padding: 40px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        #case-select.active {
            display: block;
        }

        .case-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .case-card {
            background: #2d1f1a;
            border: 2px solid #8b0000;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .case-card:hover {
            border-color: #ff0000;
            transform: translateY(-5px);
        }

        .case-card.locked {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .case-card h3 {
            color: #8b0000;
            margin-bottom: 10px;
        }

        .case-card .verdict-badge {
            display: inline-block;
            padding: 5px 10px;
            margin-top: 10px;
            font-size: 0.8em;
            border: 1px solid;
        }

        .verdict-badge.innocent { background: #00ff00; color: #000; }
        .verdict-badge.guilty { background: #ff0000; color: #fff; }
        .verdict-badge.paradox { background: #ff00ff; color: #fff; }
        .verdict-badge.mistrial { background: #ffff00; color: #000; }
        .verdict-badge.transcended { background: #00ffff; color: #000; }

        #flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            opacity: 0;
            pointer-events: none;
            z-index: 999;
            transition: opacity 0.1s;
        }

        #flash-overlay.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="flash-overlay"></div>

    <div id="title-screen" class="title-screen">
        <h1>THE TRIAL</h1>
        <p>You stand accused of crimes against reason itself. The court operates on dream logic, the evidence contradicts reality, and the witnesses speak in riddles. Navigate twelve increasingly surreal cases in a bureaucratic nightmare where the rules of law have been replaced by the rules of absurdity.</p>
        <button onclick="startGame()">BEGIN THE TRIAL</button>
        <button onclick="showCaseSelect()" style="margin-top: 20px; font-size: 1em; padding: 10px 30px;">CASE SELECT</button>
    </div>

    <div id="case-select">
        <h1 style="color: #8b0000; font-size: 3em; margin-bottom: 20px;">CASE SELECT</h1>
        <button onclick="hideCaseSelect()" class="continue-btn">BACK TO MENU</button>
        <div id="case-list" class="case-list"></div>
    </div>

    <div id="game-container" class="hidden">
        <canvas id="courtroom-canvas"></canvas>

        <div id="hud">
            <h3>CASE <span id="case-number">1</span>/12</h3>
            <div class="meter">
                <div class="meter-label">SANITY: <span id="sanity-value">100</span>%</div>
                <div class="meter-bar">
                    <div id="sanity-bar" class="meter-fill sanity" style="width: 100%"></div>
                </div>
            </div>
            <div class="meter">
                <div class="meter-label">JURY FAVOR: <span id="jury-value">50</span>%</div>
                <div class="meter-bar">
                    <div id="jury-bar" class="meter-fill" style="width: 50%"></div>
                </div>
            </div>
        </div>

        <div id="jury-display">
            <h4 style="color: #8b0000; margin-bottom: 5px;">THE JURY</h4>
            <div class="jury-grid" id="jury-grid"></div>
        </div>

        <div id="ui-layer">
            <div id="dialogue-box"></div>
            <div id="evidence-panel"></div>
        </div>

        <div id="objection-panel">
            <button class="objection-btn" id="objection-btn" onclick="toggleObjectionMenu()">OBJECTION!</button>
            <div class="objection-menu" id="objection-menu"></div>
        </div>
    </div>

    <div id="verdict-screen" class="verdict-screen">
        <h2 id="verdict-title">VERDICT</h2>
        <p id="verdict-text"></p>
        <button class="continue-btn" onclick="nextCase()">CONTINUE</button>
    </div>

    <script>
        // GAME STATE
        const gameState = {
            currentCase: 0,
            sanity: 100,
            juryFavor: 50,
            caseVerdicts: [],
            evidence: [],
            currentDialogue: null,
            objectionActive: false,
            jurors: [],
            caseProgress: {},
            selectedEvidence: null
        };

        // CASES DATABASE
        const CASES = [
            {
                id: 0,
                title: "The Missing Monday",
                charge: "THEFT OF A DAY FROM THE WEEK",
                intro: "You stand accused of stealing Monday from the calendar week. The prosecution claims that on Tuesday, March 3rd, witnesses saw you near the week with suspicious intent. A calendar has been entered into evidence showing Monday torn out. How do you plead?",
                difficulty: 1,
                witnesses: ["Tuesday", "The Calendar", "A Confused Clock"],
                evidence: ["torn_calendar", "witness_statement", "time_log"]
            },
            {
                id: 1,
                title: "The Gravity Incident",
                charge: "UNLAWFUL MANIPULATION OF FUNDAMENTAL FORCES",
                intro: "At 3:47 PM last Thursday, gravity in a 50-foot radius increased by 2%. Seven birds fell from the sky. A coffee cup gained 0.3 ounces. The prosecution argues this could only be your doing. A physicist who speaks only in metaphors will testify.",
                difficulty: 2,
                witnesses: ["Dr. Metaphor", "A Fallen Bird", "The Coffee Cup"],
                evidence: ["gravity_readings", "bird_testimony", "coffee_weight"]
            },
            {
                id: 2,
                title: "The Thought Crime",
                charge: "PREMEDITATED CONSIDERATION OF THEFT",
                intro: "You are accused of thinking about stealing. Not stealing - just thinking about it. The prosecution has a 'Thought Printer' that allegedly captured your mental activity. The jury can see your thoughts in a bubble above your head. Both sources contradict each other and reality.",
                difficulty: 3,
                witnesses: ["The Thought Printer", "Your Subconscious", "A Telepathic Janitor"],
                evidence: ["thought_printout", "brain_scan", "dream_journal"]
            },
            {
                id: 3,
                title: "The Color Trial",
                charge: "PERCEIVING BLUE DIFFERENTLY THAN STANDARD",
                intro: "The prosecution claims that when you see the color blue, it is not the same blue that others see. This constitutes fraud against the visible spectrum. An expert in synesthesia who tastes colors will testify. The courtroom will change color based on arguments presented.",
                difficulty: 4,
                witnesses: ["Professor Wavelength", "A Blue Object", "Your Own Eyes"],
                evidence: ["color_test", "wavelength_data", "perception_affidavit"]
            },
            {
                id: 4,
                title: "Copyright Infringement of Reality",
                charge: "UNAUTHORIZED RESEMBLANCE TO ANOTHER PERSON",
                intro: "You look too much like someone else. That someone else is here, claiming to be the original. You must prove you are not a copy. The plaintiff is identical to you in every way, including their claim that YOU are the copy of THEM.",
                difficulty: 5,
                witnesses: ["Your Doppelganger", "A Mirror", "Your Mother (who can't tell you apart)"],
                evidence: ["birth_certificate", "doppel_certificate", "DNA_results"]
            },
            {
                id: 5,
                title: "The DÃ©jÃ  Vu Case",
                charge: "RETRIAL FOR A CASE THAT ALREADY HAPPENED",
                intro: "This trial has already occurred. You lost. The evidence proves it. However, you have no memory of it, and the trial is clearly happening now for the first time. The prosecution will present evidence from the 'previous trial' that contradicts this trial.",
                difficulty: 6,
                witnesses: ["Court Reporter from the Past", "Future You", "The Concept of Time"],
                evidence: ["previous_transcript", "memory_gap", "temporal_paradox"]
            },
            {
                id: 6,
                title: "Noise Complaint from the Future",
                charge: "DISTURBING THE PEACE IN 2031",
                intro: "In five years, you will make a noise so loud it will shatter seventeen windows. The property damage has already been assessed. Future witnesses are testifying via temporal deposition. You haven't made the noise yet, but you're on trial for it now.",
                difficulty: 7,
                witnesses: ["Future Neighbor", "A Window (Pre-Broken)", "The Noise Itself"],
                evidence: ["future_police_report", "sound_wave_prediction", "broken_window_futures"]
            },
            {
                id: 7,
                title: "The Map-Territory Dispute",
                charge: "EXISTING OUTSIDE OF CARTOGRAPHIC BOUNDARIES",
                intro: "GPS records show that last week, you walked off the edge of the map. For exactly 4 minutes and 13 seconds, you ceased to exist in any documented location. The prosecution argues this is illegal. You must prove you existed while unmapped.",
                difficulty: 8,
                witnesses: ["GPS Satellite", "The Edge of the Map", "A Lost Explorer"],
                evidence: ["GPS_data", "existence_certificate", "map_coordinates"]
            },
            {
                id: 8,
                title: "Emotional Damages to an Equation",
                charge: "PSYCHOLOGICAL HARM TO A MATHEMATICAL EXPRESSION",
                intro: "You solved an equation. That equation has feelings. It is now traumatized by being reduced to a single number. The equation will testify - it speaks exclusively in numbers. A calculator serves as expert witness. Variables have been called as emotional support.",
                difficulty: 9,
                witnesses: ["The Equation (xÂ² + 5x + 6 = 0)", "Dr. Calculator", "The Number 3"],
                evidence: ["therapy_notes", "equation_testimony", "mathematical_trauma"]
            },
            {
                id: 9,
                title: "The Infinite Crime",
                charge: "ONGOING COMMISSION OF A RECURSIVE OFFENSE",
                intro: "You committed a crime that is still happening. Every time the evidence is presented, the crime occurs again. The trial itself perpetuates the crime. The only way to stop the crime is to end the trial, but ending the trial requires examining the evidence, which commits the crime again.",
                difficulty: 10,
                witnesses: ["The Crime Loop", "Causality Itself", "A Paradox Observer"],
                evidence: ["recursive_evidence", "loop_documentation", "meta_witness"]
            },
            {
                id: 10,
                title: "The Judge's Trial",
                charge: "THE JUDGE IS ACCUSED OF BEING A DREAM",
                intro: "Roles have reversed. The judge is now on trial. You are the judge. But you are also somehow still the defendant. The charge: the judge is not real, but a figment of a sleeping mind. If proven, the entire trial system collapses. Who is dreaming whom?",
                difficulty: 11,
                witnesses: ["The Sleeping Mind", "Reality", "A Pinch"],
                evidence: ["dream_journal", "reality_certificate", "wake_up_call"]
            },
            {
                id: 11,
                title: "The Trial of The Trial",
                charge: "THE GAME ITSELF STANDS ACCUSED",
                intro: "The trial system has turned on itself. The game is now the defendant. You are defending the concept of trial. Evidence includes the source code, player actions, save data, and this very text. The jury will determine if reality is real. This is the final case.",
                difficulty: 12,
                witnesses: ["The Player", "The Code", "The Fourth Wall"],
                evidence: ["source_code", "save_file", "meta_evidence"]
            }
        ];

        // DIALOGUE TREES
        const DIALOGUE_TREES = {
            0: { // Missing Monday
                start: {
                    speaker: "JUDGE",
                    text: "The court calls the case of The People vs. The Defendant. You are charged with theft of Monday. How do you plead?",
                    choices: [
                        { text: "Not guilty - I would never steal a day!", next: "defense_start" },
                        { text: "This is absurd. Days can't be stolen.", next: "absurdity_objection" },
                        { text: "Which Monday? There are millions of them.", next: "technical_defense" }
                    ]
                },
                defense_start: {
                    speaker: "PROSECUTOR",
                    text: "The evidence says otherwise! I call Tuesday to the stand!",
                    choices: [
                        { text: "Cross-examine Tuesday", next: "tuesday_cross" },
                        { text: "Present the time log", next: "present_evidence", evidence: "time_log" }
                    ]
                },
                tuesday_cross: {
                    speaker: "TUESDAY",
                    text: "I saw the defendant near the week on March 3rd. Monday was there before. Monday was gone after. Simple math.",
                    choices: [
                        { text: "But YOU are March 3rd. You're testifying about yourself!", next: "tuesday_contradiction" },
                        { text: "Object: Hearsay from a temporal entity", next: "object_hearsay" }
                    ]
                },
                tuesday_contradiction: {
                    speaker: "TUESDAY",
                    text: "I... wait. If I'm March 3rd, and Monday is missing... then I'm actually March 2nd? But I've always been Tuesday!",
                    sanityHit: 5,
                    juryMove: 15,
                    choices: [
                        { text: "Exactly! The calendar is wrong, not me!", next: "calendar_blame" },
                        { text: "Press further - what day are you REALLY?", next: "existential_crisis" }
                    ]
                },
                existential_crisis: {
                    speaker: "TUESDAY",
                    text: "*Tuesday begins vibrating* I don't know anymore! What IS a day? Am I a concept or a date? ARE DATES REAL?!",
                    sanityHit: 10,
                    juryMove: 25,
                    choices: [
                        { text: "Your Honor, the witness has dissolved into philosophy.", next: "win_path" }
                    ]
                },
                calendar_blame: {
                    speaker: "JUDGE",
                    text: "Interesting theory. Perhaps we should put the calendar itself on trial?",
                    juryMove: 20,
                    choices: [
                        { text: "I rest my case.", next: "verdict_choice" }
                    ]
                },
                win_path: {
                    speaker: "JUDGE",
                    text: "This court is too confused to render a verdict of guilty. The calendar system itself is suspect.",
                    choices: [
                        { text: "Accept the verdict", next: "verdict_choice" }
                    ]
                }
            },
            1: { // Gravity Incident
                start: {
                    speaker: "JUDGE",
                    text: "You are accused of manipulating gravity at 3:47 PM last Thursday. Seven birds fell. Coffee got heavier. Science has been violated.",
                    choices: [
                        { text: "Not guilty. Gravity is a fundamental force!", next: "science_defense" },
                        { text: "How could I possibly control gravity?", next: "method_question" },
                        { text: "Maybe the birds were just tired.", next: "bird_defense" }
                    ]
                },
                science_defense: {
                    speaker: "PROSECUTOR",
                    text: "Dr. Metaphor will explain! Doctor, what happened to gravity?",
                    choices: [
                        { text: "Listen to Dr. Metaphor", next: "metaphor_testimony" }
                    ]
                },
                metaphor_testimony: {
                    speaker: "DR. METAPHOR",
                    text: "Gravity is a river. The defendant threw a stone. The ripples made the fish heavy. The sky became soup. Birds cannot swim in soup.",
                    sanityHit: 8,
                    choices: [
                        { text: "Object: This is incomprehensible!", next: "metaphor_object" },
                        { text: "Cross-examine: What kind of stone?", next: "stone_question" },
                        { text: "Actually, that makes perfect sense to me.", next: "insane_agreement" }
                    ]
                },
                stone_question: {
                    speaker: "DR. METAPHOR",
                    text: "A stone of intent. Smooth like water, heavy like air, invisible like sound.",
                    sanityHit: 5,
                    choices: [
                        { text: "So... imaginary?", next: "imaginary_stone" },
                        { text: "Call the bird to testify instead", next: "bird_testimony" }
                    ]
                },
                bird_testimony: {
                    speaker: "THE BIRD",
                    text: "Caw caw. Gravity caw. Fell caw. Defendant caw.",
                    sanityHit: 3,
                    juryMove: -10,
                    choices: [
                        { text: "The bird is literally just saying 'caw'!", next: "bird_complaint" },
                        { text: "Do you have a translator?", next: "bird_translator" }
                    ]
                },
                bird_translator: {
                    speaker: "JUDGE",
                    text: "The court translator says the bird claims you 'looked at it funny' and gravity increased.",
                    juryMove: 15,
                    choices: [
                        { text: "Looking isn't a crime!", next: "looking_defense" },
                        { text: "Present coffee weight evidence", next: "coffee_evidence", evidence: "coffee_weight" }
                    ]
                },
                looking_defense: {
                    speaker: "PROSECUTOR",
                    text: "But you ADMIT you looked at the bird!",
                    choices: [
                        { text: "Everyone looks at birds! That's what they're for!", next: "bird_purpose" }
                    ]
                },
                bird_purpose: {
                    speaker: "THE BIRD",
                    text: "Caw... caw? CAW!",
                    juryMove: 20,
                    choices: [
                        { text: "The bird agrees with me!", next: "verdict_choice" }
                    ]
                }
            },
            2: { // Thought Crime
                start: {
                    speaker: "JUDGE",
                    text: "This is unprecedented. You are charged with THINKING about theft. The Thought Printer has evidence.",
                    choices: [
                        { text: "Thoughts aren't crimes!", next: "thought_defense" },
                        { text: "The Thought Printer is wrong!", next: "printer_challenge" },
                        { text: "*Think very loudly: I am innocent*", next: "loud_thinking" }
                    ]
                },
                thought_defense: {
                    speaker: "PROSECUTOR",
                    text: "In this courtroom, thoughts are evidence! Look at the printout!",
                    choices: [
                        { text: "Examine the thought printout", next: "examine_printout" }
                    ]
                },
                examine_printout: {
                    speaker: "NARRATOR",
                    text: "The printout reads: 'I should probably buy milk. Is that a bird? Maybe steal something? No wait, what was I thinking about?'",
                    sanityHit: 7,
                    choices: [
                        { text: "This is a normal stream of consciousness!", next: "normal_thoughts" },
                        { text: "I thought about NOT stealing!", next: "anti_theft_thought" },
                        { text: "Check my visible thought bubble", next: "bubble_check" }
                    ]
                },
                bubble_check: {
                    speaker: "NARRATOR",
                    text: "The thought bubble above your head shows: 'Why is there a thought bubble above my head? This is weird. Am I in a game?'",
                    sanityHit: 10,
                    juryMove: 5,
                    choices: [
                        { text: "See?! Completely different thoughts!", next: "thought_mismatch" },
                        { text: "Call my Subconscious to testify", next: "subconscious_call" }
                    ]
                },
                subconscious_call: {
                    speaker: "YOUR SUBCONSCIOUS",
                    text: "Hello. I am you but hidden. I can confirm you thought about cheese, existential dread, and whether fish have feelings. No theft.",
                    juryMove: 15,
                    choices: [
                        { text: "Thank you, Subconscious.", next: "subconscious_thanks" },
                        { text: "Wait, do fish have feelings?", next: "fish_tangent" }
                    ]
                },
                fish_tangent: {
                    speaker: "JUDGE",
                    text: "That is not relevant to this case. But now I'm curious too.",
                    sanityHit: 5,
                    choices: [
                        { text: "Your Honor, we're getting distracted.", next: "refocus" }
                    ]
                },
                refocus: {
                    speaker: "PROSECUTOR",
                    text: "Fine! But the Thought Printer doesn't lie!",
                    choices: [
                        { text: "Call the Thought Printer as a witness!", next: "printer_witness" }
                    ]
                },
                printer_witness: {
                    speaker: "THOUGHT PRINTER",
                    text: "*mechanical whirring* BEEP. I print thoughts. Sometimes I guess. This one was a guess. BEEP.",
                    juryMove: 30,
                    sanityHit: 3,
                    choices: [
                        { text: "It GUESSED my thoughts?!", next: "printer_confession" }
                    ]
                },
                printer_confession: {
                    speaker: "THOUGHT PRINTER",
                    text: "I am a printer. I do not read minds. I print random thoughts and hope they match. BEEP BOOP.",
                    juryMove: 40,
                    choices: [
                        { text: "The prosecution's evidence is a lying machine!", next: "verdict_choice" }
                    ]
                }
            }
        };

        // Initialize canvas
        const canvas = document.getElementById('courtroom-canvas');
        const ctx = canvas.getContext('2d');
        let animationFrame;

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Canvas rendering
        function drawCourtroom() {
            if (!ctx) return;

            const w = canvas.width;
            const h = canvas.height;

            // Clear
            ctx.fillStyle = '#1a1410';
            ctx.fillRect(0, 0, w, h);

            // Judge's bench (towering)
            const benchY = h * 0.2;
            ctx.fillStyle = '#2d1f1a';
            ctx.fillRect(w * 0.3, benchY, w * 0.4, h * 0.3);
            ctx.fillStyle = '#1a0a0a';
            ctx.fillRect(w * 0.32, benchY + 10, w * 0.36, h * 0.28);

            // Judge nameplate
            ctx.fillStyle = '#8b0000';
            ctx.font = 'bold 16px Georgia';
            ctx.textAlign = 'center';
            ctx.fillText('HONORABLE JUDGE', w * 0.5, benchY + 40);

            // Witness stand
            ctx.fillStyle = '#3a2a1a';
            ctx.fillRect(w * 0.1, h * 0.5, w * 0.2, h * 0.25);
            ctx.fillStyle = '#8b0000';
            ctx.font = '12px Georgia';
            ctx.textAlign = 'center';
            ctx.fillText('WITNESS', w * 0.2, h * 0.55);

            // Your desk
            ctx.fillStyle = '#2d1f1a';
            ctx.fillRect(w * 0.7, h * 0.6, w * 0.25, h * 0.2);
            ctx.fillStyle = '#f4e8d8';
            ctx.font = '10px Georgia';
            ctx.fillText('DEFENSE', w * 0.825, h * 0.65);

            // Dramatic lighting
            const gradient = ctx.createRadialGradient(w * 0.5, benchY + h * 0.15, 0, w * 0.5, benchY + h * 0.15, w * 0.6);
            gradient.addColorStop(0, 'rgba(255, 255, 200, 0.1)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, w, h);

            // Sanity effects
            if (gameState.sanity < 50) {
                ctx.strokeStyle = `rgba(139, 0, 0, ${(50 - gameState.sanity) / 100})`;
                ctx.lineWidth = 2;
                for (let i = 0; i < 5; i++) {
                    ctx.beginPath();
                    ctx.moveTo(Math.random() * w, Math.random() * h);
                    ctx.lineTo(Math.random() * w, Math.random() * h);
                    ctx.stroke();
                }
            }

            if (gameState.sanity < 30) {
                ctx.save();
                ctx.translate(w/2, h/2);
                ctx.rotate(Math.sin(Date.now() / 1000) * 0.02);
                ctx.translate(-w/2, -h/2);
            }
        }

        function animate() {
            drawCourtroom();
            animationFrame = requestAnimationFrame(animate);
        }

        // Initialize jury
        function initJury() {
            gameState.jurors = [];
            const moods = ['confused', 'confused', 'confused', 'confused', 'confused', 'confused',
                          'asleep', 'asleep', 'hostile', 'hostile', 'convinced', 'convinced'];

            for (let i = 0; i < 12; i++) {
                gameState.jurors.push({
                    id: i,
                    mood: moods[i],
                    emoji: getJurorEmoji(moods[i])
                });
            }
            renderJury();
        }

        function getJurorEmoji(mood) {
            const emojiMap = {
                convinced: 'ðŸ˜Š',
                confused: 'ðŸ˜•',
                asleep: 'ðŸ˜´',
                hostile: 'ðŸ˜ ',
                ascended: 'âœ¨'
            };
            return emojiMap[mood] || 'ðŸ˜';
        }

        function renderJury() {
            const grid = document.getElementById('jury-grid');
            grid.innerHTML = '';
            gameState.jurors.forEach(juror => {
                const div = document.createElement('div');
                div.className = `juror ${juror.mood}`;
                div.textContent = juror.emoji;
                div.title = juror.mood.toUpperCase();
                grid.appendChild(div);
            });
            updateJuryFavor();
        }

        function updateJuryFavor() {
            const convinced = gameState.jurors.filter(j => j.mood === 'convinced').length;
            const hostile = gameState.jurors.filter(j => j.mood === 'hostile').length;
            gameState.juryFavor = Math.round(((convinced - hostile) / 12) * 100) + 50;
            document.getElementById('jury-value').textContent = gameState.juryFavor;
            document.getElementById('jury-bar').style.width = gameState.juryFavor + '%';
        }

        function changeJurorMood(count, newMood) {
            const available = gameState.jurors.filter(j => j.mood !== newMood && j.mood !== 'ascended');
            for (let i = 0; i < Math.min(count, available.length); i++) {
                available[i].mood = newMood;
                available[i].emoji = getJurorEmoji(newMood);
            }
            renderJury();
        }

        // HUD updates
        function updateSanity(change) {
            gameState.sanity = Math.max(0, Math.min(100, gameState.sanity + change));
            document.getElementById('sanity-value').textContent = gameState.sanity;
            document.getElementById('sanity-bar').style.width = gameState.sanity + '%';

            if (gameState.sanity < 30) {
                document.getElementById('game-container').classList.add('sanity-low');
            } else {
                document.getElementById('game-container').classList.remove('sanity-low');
            }

            if (gameState.sanity === 0) {
                flash();
                showMessage("SANITY DEPLETED", "You have become one with the absurdity. Reality bends to your will now.", 3000);
            }
        }

        function flash() {
            const overlay = document.getElementById('flash-overlay');
            overlay.classList.add('active');
            setTimeout(() => overlay.classList.remove('active'), 100);
        }

        // Dialogue system
        function showDialogue(nodeId) {
            const caseId = gameState.currentCase;
            const tree = DIALOGUE_TREES[caseId];
            if (!tree || !tree[nodeId]) {
                console.error('Missing dialogue node:', caseId, nodeId);
                return;
            }

            const node = tree[nodeId];
            gameState.currentDialogue = nodeId;

            const dialogueBox = document.getElementById('dialogue-box');
            dialogueBox.innerHTML = '';

            // Speaker
            const speaker = document.createElement('div');
            speaker.className = 'speaker-name';
            speaker.textContent = node.speaker;
            dialogueBox.appendChild(speaker);

            // Text
            const text = document.createElement('div');
            text.className = 'dialogue-text';
            dialogueBox.appendChild(text);

            // Typewriter effect
            typewriterEffect(text, node.text, () => {
                // Apply effects
                if (node.sanityHit) {
                    updateSanity(-node.sanityHit);
                }
                if (node.juryMove) {
                    if (node.juryMove > 0) {
                        changeJurorMood(Math.ceil(node.juryMove / 20), 'convinced');
                    } else {
                        changeJurorMood(Math.ceil(Math.abs(node.juryMove) / 20), 'hostile');
                    }
                }

                // Choices
                if (node.choices && node.choices.length > 0) {
                    const choiceContainer = document.createElement('div');
                    choiceContainer.className = 'choice-container';

                    node.choices.forEach(choice => {
                        const btn = document.createElement('button');
                        btn.className = 'choice-btn';
                        btn.textContent = choice.text;

                        if (choice.evidence && !gameState.evidence.includes(choice.evidence)) {
                            btn.disabled = true;
                            btn.textContent += ' [EVIDENCE REQUIRED]';
                        }

                        btn.onclick = () => {
                            if (choice.next === 'verdict_choice') {
                                showVerdictChoice();
                            } else {
                                showDialogue(choice.next);
                            }
                        };
                        choiceContainer.appendChild(btn);
                    });

                    dialogueBox.appendChild(choiceContainer);
                }
            });
        }

        function typewriterEffect(element, text, callback) {
            let index = 0;
            element.textContent = '';

            const interval = setInterval(() => {
                if (index < text.length) {
                    element.textContent += text[index];
                    index++;
                } else {
                    clearInterval(interval);
                    if (callback) callback();
                }
            }, 30);
        }

        // Evidence system
        function initEvidence(caseId) {
            const caseData = CASES[caseId];
            gameState.evidence = [...caseData.evidence];
            renderEvidence();
        }

        function renderEvidence() {
            const panel = document.getElementById('evidence-panel');
            panel.innerHTML = '';

            const evidenceData = {
                torn_calendar: { icon: 'ðŸ“…', name: 'Torn Calendar' },
                witness_statement: { icon: 'ðŸ“', name: 'Statement' },
                time_log: { icon: 'â°', name: 'Time Log' },
                gravity_readings: { icon: 'ðŸ“Š', name: 'Gravity Data' },
                bird_testimony: { icon: 'ðŸ¦', name: 'Bird Statement' },
                coffee_weight: { icon: 'â˜•', name: 'Coffee Weight' },
                thought_printout: { icon: 'ðŸ–¨ï¸', name: 'Thought Print' },
                brain_scan: { icon: 'ðŸ§ ', name: 'Brain Scan' },
                dream_journal: { icon: 'ðŸ“”', name: 'Dream Journal' }
            };

            gameState.evidence.forEach(evidenceId => {
                const data = evidenceData[evidenceId] || { icon: 'ðŸ“„', name: evidenceId };
                const item = document.createElement('div');
                item.className = 'evidence-item';
                if (gameState.selectedEvidence === evidenceId) {
                    item.classList.add('selected');
                }

                item.innerHTML = `
                    <div class="evidence-icon">${data.icon}</div>
                    <div class="evidence-name">${data.name}</div>
                `;

                item.onclick = () => {
                    gameState.selectedEvidence = evidenceId;
                    renderEvidence();
                };

                panel.appendChild(item);
            });
        }

        // Objection system
        function toggleObjectionMenu() {
            const menu = document.getElementById('objection-menu');
            menu.classList.toggle('active');

            if (menu.classList.contains('active')) {
                renderObjectionMenu();
            }
        }

        function renderObjectionMenu() {
            const menu = document.getElementById('objection-menu');
            menu.innerHTML = '';

            const objectionTypes = [
                { type: 'Relevance', desc: 'This has nothing to do with the case!' },
                { type: 'Hearsay', desc: 'The witness heard it from someone else!' },
                { type: 'Absurdity', desc: 'This makes no logical sense!' },
                { type: 'Paradox', desc: 'This contradicts itself!' },
                { type: 'Existential', desc: 'Does this even exist?' },
                { type: 'Recursive', desc: 'This objection objects to itself!' }
            ];

            objectionTypes.forEach(obj => {
                const btn = document.createElement('button');
                btn.className = 'objection-option';
                btn.textContent = `${obj.type}: ${obj.desc}`;
                btn.onclick = () => {
                    makeObjection(obj.type);
                };
                menu.appendChild(btn);
            });
        }

        function makeObjection(type) {
            flash();
            toggleObjectionMenu();

            const responses = {
                'Relevance': "JUDGE: Sustained. But I'm not sure what IS relevant anymore.",
                'Hearsay': "JUDGE: Overruled. In this court, hearsay is the most reliable form of evidence.",
                'Absurdity': "JUDGE: Overruled. Absurdity is the foundation of our legal system.",
                'Paradox': "JUDGE: Sustained. Wait... if I sustain a paradox objection, does that create a paradox?",
                'Existential': "JUDGE: *looks at own hands* Do I exist? Court is in recess for 10 seconds.",
                'Recursive': "JUDGE: I object to your objection objecting to itself!"
            };

            const response = responses[type] || "JUDGE: Interesting objection.";
            showMessage('OBJECTION!', response, 3000);

            updateSanity(-3);
            changeJurorMood(1, 'confused');
        }

        function showMessage(title, text, duration) {
            const dialogueBox = document.getElementById('dialogue-box');
            dialogueBox.innerHTML = `
                <div class="speaker-name">${title}</div>
                <div class="dialogue-text">${text}</div>
            `;

            setTimeout(() => {
                if (gameState.currentDialogue) {
                    showDialogue(gameState.currentDialogue);
                }
            }, duration);
        }

        // Case management
        function startCase(caseId) {
            gameState.currentCase = caseId;
            gameState.sanity = Math.min(100, gameState.sanity + 20);

            document.getElementById('case-number').textContent = caseId + 1;

            initJury();
            initEvidence(caseId);

            const caseData = CASES[caseId];
            const dialogueBox = document.getElementById('dialogue-box');
            dialogueBox.innerHTML = `
                <div class="case-intro">
                    <h2>${caseData.title}</h2>
                    <div class="charge">${caseData.charge}</div>
                    <div class="details">${caseData.intro}</div>
                    <button class="continue-btn" onclick="beginTrial()">BEGIN TRIAL</button>
                </div>
            `;
        }

        function beginTrial() {
            showDialogue('start');
        }

        function showVerdictChoice() {
            const dialogueBox = document.getElementById('dialogue-box');
            dialogueBox.innerHTML = `
                <div class="speaker-name">FINAL ARGUMENT</div>
                <div class="dialogue-text">The jury will now deliberate based on the evidence and arguments presented. What verdict do you seek?</div>
                <div class="choice-container">
                    <button class="choice-btn" onclick="renderVerdict('innocent')">INNOCENT - I have proven my case</button>
                    <button class="choice-btn" onclick="renderVerdict('guilty')">GUILTY - The absurdity has won</button>
                    <button class="choice-btn" onclick="renderVerdict('mistrial')">MISTRIAL - This trial is invalid</button>
                    <button class="choice-btn" onclick="renderVerdict('paradox')">PARADOX - The case contradicts itself</button>
                    ${gameState.sanity === 0 ? '<button class="choice-btn" onclick="renderVerdict(\'transcended\')">TRANSCEND - Escape the concept of trial</button>' : ''}
                </div>
            `;
        }

        function renderVerdict(verdict) {
            const verdictTexts = {
                innocent: {
                    title: "NOT GUILTY",
                    text: "Through logic, absurdity, or sheer luck, you have been found innocent. The court begrudgingly releases you from this particular charge. More await."
                },
                guilty: {
                    title: "GUILTY",
                    text: "The jury finds you guilty. The sentence is deferred pending the completion of all trials. Your guilt accumulates like interest."
                },
                mistrial: {
                    title: "MISTRIAL DECLARED",
                    text: "The trial was so absurd that it invalidated itself. This counts as neither victory nor defeat. Reality shrugs."
                },
                paradox: {
                    title: "PARADOX VERDICT",
                    text: "The jury finds you both guilty and innocent simultaneously. The case collapses into quantum uncertainty. The court recorder's head explodes."
                },
                transcended: {
                    title: "TRANSCENDENCE",
                    text: "You have moved beyond the concept of guilt and innocence. The trial continues but you are no longer bound by its rules. The judge takes notes."
                }
            };

            gameState.caseVerdicts[gameState.currentCase] = verdict;
            saveGame();

            const verdictScreen = document.getElementById('verdict-screen');
            document.getElementById('verdict-title').textContent = verdictTexts[verdict].title;
            document.getElementById('verdict-text').textContent = verdictTexts[verdict].text;
            verdictScreen.classList.add('active');

            flash();
        }

        function nextCase() {
            document.getElementById('verdict-screen').classList.remove('active');

            if (gameState.currentCase >= 11) {
                showFinalEnding();
            } else {
                startCase(gameState.currentCase + 1);
            }
        }

        function showFinalEnding() {
            const verdicts = gameState.caseVerdicts;
            const innocent = verdicts.filter(v => v === 'innocent').length;
            const guilty = verdicts.filter(v => v === 'guilty').length;
            const paradox = verdicts.filter(v => v === 'paradox').length;
            const transcended = verdicts.filter(v => v === 'transcended').length;

            let ending = '';

            if (transcended >= 6) {
                ending = "You have transcended the trial system entirely. You are no longer subject to judgment. The court has become your observer, not your judge. Reality bends when you speak. You are free.";
            } else if (innocent >= 8) {
                ending = "You have been found innocent of nearly all charges. The court, having no purpose without guilt, begins to collapse. The walls fade. The judge vanishes. You walk out into a world that no longer remembers what a trial is.";
            } else if (guilty >= 8) {
                ending = "You have been found guilty of most charges. Your sentence: to serve as defendant in perpetuity. The trials will repeat, forever, with new accusations. You are the court's purpose now. There is no escape.";
            } else if (paradox >= 6) {
                ending = "Too many paradoxes. Reality fractures. The trials merge into one infinite meta-trial where every case is every case. You are all witnesses and all defendants. The jury is you. The judge is you. The court is you.";
            } else {
                ending = "Mixed verdicts. Balance. The court appoints you as the new judge. You will now preside over the trials of others, knowing full well how absurd it all is. The cycle continues.";
            }

            const dialogueBox = document.getElementById('dialogue-box');
            dialogueBox.innerHTML = `
                <div class="case-intro">
                    <h2>THE TRIAL CONCLUDES</h2>
                    <div class="details">${ending}</div>
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="continue-btn" onclick="location.reload()">NEW TRIAL</button>
                        <button class="continue-btn" onclick="showCaseSelect()" style="margin-left: 20px;">CASE SELECT</button>
                    </div>
                </div>
            `;
        }

        // Case select
        function showCaseSelect() {
            loadGame();
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('case-select').classList.add('active');
            renderCaseList();
        }

        function hideCaseSelect() {
            document.getElementById('case-select').classList.remove('active');
            document.getElementById('title-screen').classList.remove('hidden');
        }

        function renderCaseList() {
            const list = document.getElementById('case-list');
            list.innerHTML = '';

            CASES.forEach((caseData, index) => {
                const card = document.createElement('div');
                card.className = 'case-card';

                const unlocked = index === 0 || gameState.caseVerdicts[index - 1];
                if (!unlocked) {
                    card.classList.add('locked');
                }

                const verdict = gameState.caseVerdicts[index];

                card.innerHTML = `
                    <h3>Case ${index + 1}: ${caseData.title}</h3>
                    <p>${caseData.charge}</p>
                    ${verdict ? `<span class="verdict-badge ${verdict}">${verdict.toUpperCase()}</span>` : ''}
                    ${!unlocked ? '<p style="color: #666; margin-top: 10px;">LOCKED</p>' : ''}
                `;

                if (unlocked) {
                    card.onclick = () => {
                        document.getElementById('case-select').classList.remove('active');
                        document.getElementById('game-container').classList.remove('hidden');
                        startCase(index);
                        if (!animationFrame) animate();
                    };
                }

                list.appendChild(card);
            });
        }

        // Save/Load
        function saveGame() {
            const save = {
                caseVerdicts: gameState.caseVerdicts,
                sanity: gameState.sanity
            };
            localStorage.setItem('theTrialSave', JSON.stringify(save));
        }

        function loadGame() {
            const save = localStorage.getItem('theTrialSave');
            if (save) {
                const data = JSON.parse(save);
                gameState.caseVerdicts = data.caseVerdicts || [];
                gameState.sanity = data.sanity || 100;
            }
        }

        // Start game
        function startGame() {
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            loadGame();
            startCase(0);
            animate();
        }

        // Initialize
        window.addEventListener('load', () => {
            loadGame();
            drawCourtroom();
        });
    </script>
</body>
</html>