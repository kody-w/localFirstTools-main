<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvoMon Lab: Breeding Center</title>
    <style>
        body {
            margin: 0;
            background: #050510;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        header {
            padding: 20px;
            background: #0a0a1a;
            border-bottom: 1px solid #333;
            text-align: center;
        }
        
        h1 { margin: 0; color: #00ffff; text-transform: uppercase; letter-spacing: 2px; }
        
        #lab-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: radial-gradient(circle at center, #111 0%, #050510 100%);
            overflow-y: auto;
            min-height: 0;
        }
        
        #parents-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-bottom: 40px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        .pod {
            width: 300px;
            height: 400px;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid #333;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
        }
        
        .pod.active { border-color: #00ffff; box-shadow: 0 0 20px rgba(0, 255, 255, 0.2); }
        .pod.result { border-color: #ff00ff; box-shadow: 0 0 30px rgba(255, 0, 255, 0.3); }
        
        .pod-title { font-size: 18px; color: #aaa; margin-bottom: 15px; text-transform: uppercase; }
        
        .preview-box {
            width: 200px;
            height: 200px;
            background: #000;
            border: 1px solid #444;
            border-radius: 50%;
            margin-bottom: 20px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .preview-box canvas { width: 100%; height: 100%; }
        
        .stats-box {
            width: 100%;
            font-size: 12px;
            color: #ccc;
        }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-bar { width: 100px; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .stat-fill { height: 100%; background: #00ffff; }
        
        .btn-upload {
            margin-top: auto;
            background: #222;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 5px;
        }
        .btn-upload:hover { background: #333; border-color: #888; }

        .btn-random {
            background: #224;
            color: #aaf;
            border: 1px solid #446;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 12px;
        }
        .btn-random:hover { background: #335; border-color: #668; }
        
        #breed-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #222;
            border: 4px solid #444;
            color: #888;
            font-size: 18px;
            font-weight: bold;
            cursor: not-allowed;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        #breed-btn.ready {
            background: #00ffff;
            border-color: #fff;
            color: #000;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        #nursery-section {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
            flex-shrink: 0;
        }

        #nursery-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .child-card {
            width: 200px;
            background: rgba(20, 0, 40, 0.6);
            border: 2px solid #444;
            border-radius: 15px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .child-card:hover { background: rgba(40, 0, 60, 0.8); }
        .child-card.selected { border-color: #ff00ff; box-shadow: 0 0 15px rgba(255, 0, 255, 0.4); background: rgba(40, 0, 60, 0.9); }
        
        .child-preview {
            width: 100%;
            height: 150px;
            background: #000;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .selection-badge {
            position: absolute;
            top: 10px; right: 10px;
            width: 24px; height: 24px;
            background: #ff00ff;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            display: none;
        }
        .child-card.selected .selection-badge { display: flex; }
        
        #action-bar {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            height: 50px;
        }
        
        .action-btn {
            padding: 0 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.3s;
        }
        
        .action-btn.active { opacity: 1; pointer-events: auto; }
        
        #btn-promote { background: #00ffff; color: #000; box-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }
        #btn-export { background: #ff00ff; color: #fff; box-shadow: 0 0 20px rgba(255, 0, 255, 0.3); }

        #dna-strand {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 100px;
            pointer-events: none;
            z-index: 0;
            opacity: 0.2;
        }
        
        .hidden { display: none; }
        
    </style>
</head>
<body>
    <header>
        <h1>EvoMon Lab</h1>
        <p style="color: #666; font-size: 12px; margin-top: 5px;">GENETIC COMBINATION FACILITY</p>
    </header>
    
    <div id="lab-container">
        <div id="parents-row">
            <!-- Parent A -->
            <div class="pod" id="pod-a">
                <div class="pod-title">Parent A</div>
                <div class="preview-box" id="preview-a">
                    <div style="color: #444;">Empty</div>
                </div>
                <div class="stats-box" id="stats-a" style="opacity: 0;">
                    <div class="stat-row"><span>AGG</span><div class="stat-bar"><div class="stat-fill" style="width: 0%"></div></div></div>
                    <div class="stat-row"><span>RES</span><div class="stat-bar"><div class="stat-fill" style="width: 0%"></div></div></div>
                    <div class="stat-row"><span>AGI</span><div class="stat-bar"><div class="stat-fill" style="width: 0%"></div></div></div>
                    <div class="stat-row"><span>ELE</span><div class="stat-bar"><div class="stat-fill" style="width: 0%"></div></div></div>
                </div>
                <button class="btn-upload" onclick="document.getElementById('file-a').click()">Load DNA</button>
                <button class="btn-random" onclick="lab.randomizeParent('a')">Randomize</button>
                <input type="file" id="file-a" class="hidden" onchange="lab.loadParent('a', this)">
            </div>
            
            <!-- Breed Button -->
            <button id="breed-btn" onclick="lab.breed()">BREED</button>
            
            <!-- Parent B -->
            <div class="pod" id="pod-b">
                <div class="pod-title">Parent B</div>
                <div class="preview-box" id="preview-b">
                    <div style="color: #444;">Empty</div>
                </div>
                <div class="stats-box" id="stats-b" style="opacity: 0;">
                    <div class="stat-row"><span>AGG</span><div class="stat-bar"><div class="stat-fill" style="width: 0%"></div></div></div>
                    <div class="stat-row"><span>RES</span><div class="stat-bar"><div class="stat-fill" style="width: 0%"></div></div></div>
                    <div class="stat-row"><span>AGI</span><div class="stat-bar"><div class="stat-fill" style="width: 0%"></div></div></div>
                    <div class="stat-row"><span>ELE</span><div class="stat-bar"><div class="stat-fill" style="width: 0%"></div></div></div>
                </div>
                <button class="btn-upload" onclick="document.getElementById('file-b').click()">Load DNA</button>
                <button class="btn-random" onclick="lab.randomizeParent('b')">Randomize</button>
                <input type="file" id="file-b" class="hidden" onchange="lab.loadParent('b', this)">
            </div>
        </div>
        
        <!-- Nursery Section -->
        <div id="nursery-section" class="hidden">
            <h2 style="color: #ff00ff; margin-bottom: 20px;">OFFSPRING VARIANTS</h2>
            <div id="nursery-grid">
                <!-- Children injected here -->
            </div>
            
            <div id="action-bar">
                <button id="btn-promote" class="action-btn" onclick="lab.promoteSelected()">
                    <span>â¬†</span> Promote 2 to Parents
                </button>
                <button id="btn-export" class="action-btn" onclick="lab.exportSelected()">
                    <span>ðŸ’¾</span> Export Selected
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        class Lab {
            constructor() {
                this.parents = { a: null, b: null };
                this.children = [];
                this.selectedIndices = [];
                this.renderers = {};
                this.scenes = {};
                this.cameras = {};
                
                this.init3D('a');
                this.init3D('b');
            }
            
            init3D(id, containerEl) {
                const container = containerEl || document.getElementById(`preview-${id}`);
                container.innerHTML = '';
                
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000000);
                
                const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
                camera.position.set(0, 0.5, 2.5);
                camera.lookAt(0, 0.5, 0);
                
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(container.clientWidth, container.clientHeight);
                container.appendChild(renderer.domElement);
                
                const ambient = new THREE.AmbientLight(0x404040);
                scene.add(ambient);
                
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(2, 5, 3);
                scene.add(dirLight);
                
                this.scenes[id] = scene;
                this.cameras[id] = camera;
                this.renderers[id] = renderer;
                
                // Animation loop
                const animate = () => {
                    if (!document.body.contains(renderer.domElement)) return; // Stop if removed
                    requestAnimationFrame(animate);
                    if (scene.userData.mesh) {
                        scene.userData.mesh.rotation.y += 0.01;
                    }
                    renderer.render(scene, camera);
                };
                animate();
            }
            
            loadParent(id, input) {
                const file = input.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        const data = json.stats || json;
                        
                        // Ensure genome exists
                        if (!data.genome && data.evolutionLog && data.evolutionLog.length > 0) {
                            data.genome = data.evolutionLog[data.evolutionLog.length-1].genome;
                        }
                        
                        if (data.genome) {
                            this.parents[id] = data;
                            this.updatePod(id, data.genome);
                            this.checkReady();
                        } else {
                            alert("Invalid DNA sequence.");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Failed to analyze sample.");
                    }
                };
                reader.readAsText(file);
                input.value = '';
            }

            randomizeParent(id) {
                const genome = {
                    aggression: Math.random(),
                    resilience: Math.random(),
                    agility: Math.random(),
                    element: Math.random()
                };
                
                const data = {
                    level: Math.floor(Math.random() * 20) + 1,
                    genome: genome,
                    evolutionLog: [{
                        gen: Math.floor(Math.random() * 5) + 1,
                        timestamp: new Date().toISOString(),
                        event: "Wild Capture",
                        genome: genome
                    }]
                };
                
                this.parents[id] = data;
                this.updatePod(id, genome);
                this.checkReady();
            }
            
            updatePod(id, genome) {
                document.getElementById(`pod-${id}`).classList.add('active');
                document.getElementById(`stats-${id}`).style.opacity = 1;
                
                // Update Stats Bars
                const stats = document.getElementById(`stats-${id}`).children;
                stats[0].querySelector('.stat-fill').style.width = (genome.aggression * 100) + '%';
                stats[1].querySelector('.stat-fill').style.width = (genome.resilience * 100) + '%';
                stats[2].querySelector('.stat-fill').style.width = (genome.agility * 100) + '%';
                stats[3].querySelector('.stat-fill').style.width = (genome.element * 100) + '%';
                
                // Render 3D
                this.renderCreature(id, genome);
            }
            
            renderCreature(id, genome) {
                const scene = this.scenes[id];
                if (scene.userData.mesh) scene.remove(scene.userData.mesh);
                
                const group = new THREE.Group();
                
                // --- SHARED GENERATION LOGIC ---
                const geo = new THREE.SphereGeometry(0.6, 32, 32);
                const posAttribute = geo.attributes.position;
                const vertex = new THREE.Vector3();
                
                for (let i = 0; i < posAttribute.count; i++) {
                    vertex.fromBufferAttribute(posAttribute, i);
                    
                    const resilienceFactor = Math.max(0.05, genome.resilience);
                    if (resilienceFactor > 0) {
                        const cubeFactor = resilienceFactor;
                        const maxDim = Math.max(Math.abs(vertex.x), Math.max(Math.abs(vertex.y), Math.abs(vertex.z)));
                        const sphereLen = vertex.length();
                        const cubeLen = 0.6 * (sphereLen / maxDim);
                        const targetLen = sphereLen * (1 - cubeFactor) + cubeLen * cubeFactor;
                        vertex.setLength(targetLen);
                    }
                    
                    if (genome.aggression > 0) {
                        const noise = Math.sin(vertex.x * 10) * Math.sin(vertex.y * 10) * Math.sin(vertex.z * 10);
                        if (noise > 0.5) {
                            const spikeAmt = (noise - 0.5) * Math.max(0.1, genome.aggression) * 0.5;
                            vertex.add(vertex.clone().normalize().multiplyScalar(spikeAmt));
                        }
                    }
                    
                    posAttribute.setXYZ(i, vertex.x, vertex.y, vertex.z);
                }
                
                geo.computeVertexNormals();
                
                const hue = Math.floor(genome.element * 360);
                const color = new THREE.Color(`hsl(${hue}, 70%, 50%)`);
                
                const body = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ 
                    color: color,
                    roughness: 0.7 - (genome.resilience * 0.5),
                    metalness: genome.resilience * 0.3
                }));
                body.position.y = 0.5;
                group.add(body);
                
                const limbCount = Math.max(0, Math.floor(genome.agility * 6));
                if (limbCount > 0) {
                    for(let i=0; i<limbCount; i++) {
                        const angle = (i / limbCount) * Math.PI * 2;
                        const limbLen = 0.4 + Math.max(0.1, genome.agility) * 0.5;
                        let limbGeo;
                        if (THREE.CapsuleGeometry) {
                            limbGeo = new THREE.CapsuleGeometry(0.1, limbLen, 4, 8);
                        } else {
                            limbGeo = new THREE.CylinderGeometry(0.1, 0.1, limbLen, 8);
                        }
                        const limb = new THREE.Mesh(limbGeo, new THREE.MeshStandardMaterial({ color: color }));
                        limb.position.set(Math.cos(angle)*0.5, 0.5, Math.sin(angle)*0.5);
                        limb.lookAt(0, 0.5, 0);
                        limb.rotateX(Math.PI/2);
                        group.add(limb);
                    }
                }
                
                const eyeSize = 0.1 + (Math.max(0.1, genome.agility) * 0.05);
                const eyeCount = 1 + Math.floor(genome.element * 3);
                const eyeAngleSpan = Math.PI / 2;
                const startAngle = -eyeAngleSpan / 2;
                
                for(let i=0; i<eyeCount; i++) {
                    let angle = 0;
                    if (eyeCount > 1) {
                        angle = startAngle + (i / (eyeCount - 1)) * eyeAngleSpan;
                    }
                    const ex = Math.sin(angle) * 0.5;
                    const ez = Math.cos(angle) * 0.5;
                    
                    const eye = new THREE.Mesh(
                        new THREE.SphereGeometry(eyeSize, 8, 8),
                        new THREE.MeshBasicMaterial({ color: 0xffffff })
                    );
                    eye.position.set(ex, 0.7, ez);
                    const pupil = new THREE.Mesh(
                        new THREE.SphereGeometry(eyeSize * 0.4, 8, 8),
                        new THREE.MeshBasicMaterial({ color: 0x000000 })
                    );
                    pupil.position.set(0, 0, eyeSize);
                    eye.add(pupil);
                    group.add(eye);
                }
                
                scene.add(group);
                scene.userData.mesh = group;
            }
            
            checkReady() {
                if (this.parents.a && this.parents.b) {
                    document.getElementById('breed-btn').classList.add('ready');
                }
            }
            
            breed() {
                if (!this.parents.a || !this.parents.b) return;
                
                const gA = this.parents.a.genome;
                const gB = this.parents.b.genome;
                
                this.children = [];
                this.selectedIndices = [];
                this.updateActionBar();
                
                // Generate 4 Variants
                for(let i=0; i<4; i++) {
                    // Crossover & Mutation
                    const childGenome = {
                        aggression: this.mix(gA.aggression, gB.aggression),
                        resilience: this.mix(gA.resilience, gB.resilience),
                        agility: this.mix(gA.agility, gB.agility),
                        element: this.mix(gA.element, gB.element)
                    };
                    
                    this.children.push({
                        level: 1,
                        xp: 0,
                        hp: 100,
                        maxHp: 100,
                        atk: 10,
                        def: 5,
                        spd: 5,
                        genome: childGenome,
                        history: { damageTaken: 0, damageDealt: 0, fled: 0, biomeTime: {} },
                        evolutionLog: [{
                            gen: (Math.max(this.parents.a.evolutionLog ? this.parents.a.evolutionLog.length : 1, this.parents.b.evolutionLog ? this.parents.b.evolutionLog.length : 1)) + 1,
                            timestamp: new Date().toISOString(),
                            event: "Hatched in Lab",
                            details: "Genetic Synthesis (Variant " + (i+1) + ")",
                            genome: JSON.parse(JSON.stringify(childGenome)),
                            level: 1
                        }]
                    });
                }
                
                this.renderNursery();
            }
            
            renderNursery() {
                const grid = document.getElementById('nursery-grid');
                grid.innerHTML = '';
                document.getElementById('nursery-section').classList.remove('hidden');
                
                this.children.forEach((child, index) => {
                    const card = document.createElement('div');
                    card.className = 'child-card';
                    card.onclick = () => this.toggleSelection(index);
                    card.id = `child-card-${index}`;
                    
                    card.innerHTML = `
                        <div class="selection-badge">âœ“</div>
                        <div class="child-preview" id="child-preview-${index}"></div>
                        <div class="stats-box">
                            <div class="stat-row"><span>AGG</span><div class="stat-bar"><div class="stat-fill" style="width: ${child.genome.aggression*100}%"></div></div></div>
                            <div class="stat-row"><span>RES</span><div class="stat-bar"><div class="stat-fill" style="width: ${child.genome.resilience*100}%"></div></div></div>
                            <div class="stat-row"><span>AGI</span><div class="stat-bar"><div class="stat-fill" style="width: ${child.genome.agility*100}%"></div></div></div>
                            <div class="stat-row"><span>ELE</span><div class="stat-bar"><div class="stat-fill" style="width: ${child.genome.element*100}%"></div></div></div>
                        </div>
                    `;
                    grid.appendChild(card);
                    
                    // Init 3D for this child
                    this.init3D(`child-${index}`, card.querySelector('.child-preview'));
                    this.renderCreature(`child-${index}`, child.genome);
                });
                
                // Scroll to nursery
                document.getElementById('nursery-section').scrollIntoView({ behavior: 'smooth' });
            }
            
            toggleSelection(index) {
                const pos = this.selectedIndices.indexOf(index);
                if (pos > -1) {
                    this.selectedIndices.splice(pos, 1);
                    document.getElementById(`child-card-${index}`).classList.remove('selected');
                } else {
                    if (this.selectedIndices.length < 2) {
                        this.selectedIndices.push(index);
                        document.getElementById(`child-card-${index}`).classList.add('selected');
                    }
                }
                this.updateActionBar();
            }
            
            updateActionBar() {
                const promoteBtn = document.getElementById('btn-promote');
                const exportBtn = document.getElementById('btn-export');
                
                if (this.selectedIndices.length === 2) {
                    promoteBtn.classList.add('active');
                } else {
                    promoteBtn.classList.remove('active');
                }
                
                if (this.selectedIndices.length > 0) {
                    exportBtn.classList.add('active');
                } else {
                    exportBtn.classList.remove('active');
                }
            }
            
            promoteSelected() {
                if (this.selectedIndices.length !== 2) return;
                
                const childA = this.children[this.selectedIndices[0]];
                const childB = this.children[this.selectedIndices[1]];
                
                this.parents.a = childA;
                this.parents.b = childB;
                
                this.updatePod('a', childA.genome);
                this.updatePod('b', childB.genome);
                
                // Reset Nursery
                document.getElementById('nursery-section').classList.add('hidden');
                this.children = [];
                this.selectedIndices = [];
                
                // Scroll top
                document.getElementById('lab-container').scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            exportSelected() {
                this.selectedIndices.forEach(index => {
                    const child = this.children[index];
                    const data = JSON.stringify({ stats: child }, null, 2);
                    const blob = new Blob([data], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `evomon-gen${child.evolutionLog[0].gen}-variant${index+1}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            }
            
            mix(v1, v2) {
                // Average + Mutation
                let val = (v1 + v2) / 2;
                // Mutation chance 30% (increased for variants)
                if (Math.random() < 0.3) {
                    val += (Math.random() - 0.5) * 0.3; // +/- 0.15
                }
                return Math.max(0, Math.min(1, val));
            }
        }
        
        const lab = new Lab();
    </script>
</body>
</html>