<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WowMon: Crystal Edition</title>
    <style>
        @font-face {
            font-family: 'PixelFont';
            src: local('Courier New'), local('Consolas'), monospace; /* Fallback */
        }

        :root {
            --gbc-dark: #0f380f;
            --gbc-main: #306230;
            --gbc-light: #8bac0f;
            --gbc-white: #9bbc0f;
            --ui-bg: #f0f0f8;
            --ui-border: #404050;
            --ui-text: #202028;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #202020;
            color: var(--ui-text);
            font-family: 'Courier New', monospace; /* Pixel-ish font */
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            image-rendering: pixelated;
        }

        #game-boy {
            width: 100%;
            max-width: 480px;
            height: 100%;
            max-height: 800px;
            background-color: #c0c0d0; /* GBC Purple/Grey */
            border-radius: 10px 10px 40px 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        #screen-bezel {
            background-color: #505060;
            padding: 15px 15px 30px 15px;
            border-radius: 10px 10px 30px 10px;
            width: 100%;
            position: relative;
        }

        #power-led {
            position: absolute;
            top: 40%;
            left: 10px;
            width: 8px;
            height: 8px;
            background-color: #f00;
            border-radius: 50%;
            box-shadow: 0 0 5px #f00;
        }

        #screen-container {
            width: 100%;
            aspect-ratio: 10/9;
            background-color: #9bbc0f; /* Classic GB Greenish */
            border: 2px solid #303040;
            position: relative;
            overflow: hidden;
        }

        /* --- GAME SCREENS --- */
        .game-screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
            flex-direction: column;
        }

        .game-screen.active {
            display: flex;
        }

        /* --- OVERWORLD --- */
        #overworld-canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        /* --- BATTLE UI (G/S/C Style) --- */
        #battle-screen {
            background-color: #f8f8f8;
            font-weight: bold;
            font-size: 14px;
        }

        .battle-scene {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, #f8f8f8 0%, #f8f8f8 60%, #d0d0d0 60%, #d0d0d0 100%);
        }

        .battle-mon {
            width: 96px;
            height: 96px;
            position: absolute;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            image-rendering: pixelated;
        }

        #enemy-mon {
            top: 20px;
            right: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">üê∫</text></svg>');
        }

        #player-mon {
            bottom: 20px;
            left: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">üê∏</text></svg>');
            transform: scaleX(-1); /* Face right */
        }

        .status-box {
            position: absolute;
            background: #fff;
            border: 2px solid #000;
            border-radius: 5px;
            padding: 5px;
            width: 140px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }

        #enemy-status {
            top: 10px;
            left: 10px;
        }

        #player-status {
            bottom: 40px;
            right: 10px;
        }

        .hp-bar-container {
            width: 100%;
            height: 8px;
            border: 1px solid #000;
            border-radius: 4px;
            margin-top: 2px;
            background: #eee;
        }

        .hp-fill {
            height: 100%;
            background: #4caf50;
            width: 100%;
            border-radius: 2px;
            transition: width 0.5s;
        }

        .battle-dialogue {
            height: 80px;
            background: #306230; /* Dark Green Frame */
            border-top: 4px solid #0f380f;
            padding: 10px;
            color: #fff;
            font-family: monospace;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .battle-menu {
            display: grid;
            grid-template-columns: 1fr 1fr;
            width: 100%;
            height: 100%;
            gap: 5px;
        }

        .menu-btn {
            background: #fff;
            border: 2px solid #0f380f;
            color: #000;
            font-family: monospace;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-btn:active {
            background: #eee;
        }
        
        .menu-btn:hover {
            background: #f0f0d0;
        }

        /* --- CONTROLS --- */
        #controls {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        #d-pad {
            width: 120px;
            height: 120px;
            position: relative;
        }

        .d-btn {
            position: absolute;
            background: #333;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .d-btn:active { background: #111; }

        #up { top: 0; left: 40px; width: 40px; height: 40px; }
        #down { bottom: 0; left: 40px; width: 40px; height: 40px; }
        #left { top: 40px; left: 0; width: 40px; height: 40px; }
        #right { top: 40px; right: 0; width: 40px; height: 40px; }
        #center-d { top: 40px; left: 40px; width: 40px; height: 40px; background: #333; }

        #action-btns {
            display: flex;
            gap: 20px;
            transform: rotate(-15deg);
            margin-top: 20px;
        }

        .a-b-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #a00;
            color: #400;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            font-family: sans-serif;
        }
        
        .a-b-btn:active { transform: scale(0.95); box-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

        #start-select {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .pill-btn {
            width: 60px;
            height: 15px;
            background: #333;
            border-radius: 10px;
            transform: rotate(-15deg);
            cursor: pointer;
            border: 1px solid #555;
        }

        /* --- MENU UI --- */
        .retro-window {
            background: #fff;
            border: 3px double #000;
            border-radius: 2px;
            padding: 5px;
            font-family: monospace;
        }

        .menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-item {
            padding: 5px 10px;
            cursor: pointer;
        }

        .menu-item.selected {
            background: #eee;
        }
        
        .menu-item::before {
            content: ' ';
            display: inline-block;
            width: 10px;
        }
        
        .menu-item.selected::before {
            content: '‚ñ∂';
        }

        /* --- PERMADEATH WARNING --- */
        #permadeath-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            color: #f00;
            padding: 20px;
            border: 2px solid #f00;
            text-align: center;
            display: none;
            z-index: 100;
            font-family: monospace;
        }

    </style>
</head>
<body>

    <div id="game-boy">
        <div id="screen-bezel">
            <div style="color: #aaa; font-style: italic; font-weight: bold; margin-bottom: 5px; font-size: 12px;">NINTENDO GAME BOY COLOR</div>
            <div id="power-led"></div>
            <div id="screen-container">
                
                <!-- TITLE SCREEN -->
                <div id="title-screen" class="game-screen active" style="background: #000; color: #fff; align-items: center; justify-content: center;">
                    <h1 style="font-size: 30px; color: #ffd700; text-shadow: 2px 2px #c0c0c0;">WOWMON</h1>
                    <h2 style="font-size: 16px; color: #4facfe; margin-top: -10px;">CRYSTAL EDITION</h2>
                    <div style="margin-top: 40px; font-size: 12px; animation: blink 1s infinite;">PRESS START</div>
                    <div style="margin-top: 80px; font-size: 10px; color: #888;">¬© 2025 BLIZZARD/NINTENDO</div>
                </div>

                <!-- OVERWORLD -->
                <div id="overworld-screen" class="game-screen">
                    <canvas id="overworld-canvas" width="160" height="144"></canvas>
                    <div id="dialogue-box" class="retro-window" style="position: absolute; bottom: 0; width: 100%; height: 48px; display: none; font-size: 10px;">
                        <div id="dialogue-text"></div>
                        <div style="text-align: right; color: #f00;">‚ñº</div>
                    </div>
                    <div id="start-menu" class="retro-window" style="position: absolute; top: 0; right: 0; width: 80px; display: none; font-size: 10px;">
                        <ul class="menu-list">
                            <li class="menu-item selected" onclick="Game.menuSelect('dex')">DEX</li>
                            <li class="menu-item" onclick="Game.menuSelect('mon')">MON</li>
                            <li class="menu-item" onclick="Game.menuSelect('bag')">BAG</li>
                            <li class="menu-item" onclick="Game.menuSelect('save')">SAVE</li>
                            <li class="menu-item" onclick="Game.menuSelect('exit')">EXIT</li>
                        </ul>
                    </div>
                </div>

                <!-- BATTLE -->
                <div id="battle-screen" class="game-screen">
                    <div class="battle-scene">
                        <div class="status-box" id="enemy-status">
                            <div id="enemy-name-disp">Worgpup</div>
                            <div style="font-size: 10px;">Lv<span id="enemy-lvl">5</span></div>
                            <div class="hp-bar-container"><div class="hp-fill" id="enemy-hp-fill"></div></div>
                        </div>
                        <div class="battle-mon" id="enemy-mon"></div>

                        <div class="battle-mon" id="player-mon"></div>
                        <div class="status-box" id="player-status">
                            <div id="player-name-disp">Puddlefin</div>
                            <div style="font-size: 10px;">Lv<span id="player-lvl">5</span></div>
                            <div class="hp-bar-container"><div class="hp-fill" id="player-hp-fill"></div></div>
                            <div style="font-size: 10px; text-align: right;"><span id="player-hp-text">20/20</span></div>
                        </div>
                    </div>
                    <div class="battle-dialogue">
                        <div id="battle-text" style="width: 100%;">Wild WORGPUP appeared!</div>
                        <div id="battle-actions" class="battle-menu" style="display: none;">
                            <button class="menu-btn" onclick="Battle.fight()">FIGHT</button>
                            <button class="menu-btn" onclick="Battle.bag()">BAG</button>
                            <button class="menu-btn" onclick="Battle.mon()">MON</button>
                            <button class="menu-btn" onclick="Battle.run()">RUN</button>
                        </div>
                        <div id="move-menu" class="battle-menu" style="display: none;">
                            <!-- Moves injected here -->
                            <button class="menu-btn" onclick="Battle.back()">BACK</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="controls">
            <div id="d-pad">
                <div id="up" class="d-btn" onclick="Input.up()"></div>
                <div id="left" class="d-btn" onclick="Input.left()"></div>
                <div id="center-d"></div>
                <div id="right" class="d-btn" onclick="Input.right()"></div>
                <div id="down" class="d-btn" onclick="Input.down()"></div>
            </div>

            <div id="start-select">
                <div class="pill-btn" onclick="Input.select()"></div>
                <div class="pill-btn" onclick="Input.start()"></div>
            </div>

            <div id="action-btns">
                <div class="a-b-btn" style="margin-top: 20px;" onclick="Input.b()">B</div>
                <div class="a-b-btn" style="margin-bottom: 20px;" onclick="Input.a()">A</div>
            </div>
        </div>
    </div>

    <div id="permadeath-warning">
        <h3>‚ö†Ô∏è CRITICAL INJURY ‚ö†Ô∏è</h3>
        <p><span id="dead-mon-name">MON</span> has taken fatal damage.</p>
        <p>Their spirit has returned to the Emerald Dream.</p>
        <p>(They are gone forever)</p>
        <button onclick="document.getElementById('permadeath-warning').style.display='none'">ACCEPT FATE</button>
    </div>

    <script>
        // --- ASSETS & DATA ---
        const SPRITES = {
            player: 'üßô‚Äç‚ôÇÔ∏è',
            cho: 'üêº',
            puddlefin: 'üê∏',
            cinderwhelp: 'üê≤',
            brambleclaw: 'üêª',
            worgpup: 'üê∫',
            hogger: 'üêó',
            murloc_oracle: 'üê°',
            voidwalker: 'üëª',
            grass: 'üü©',
            tree: 'üå≤',
            water: 'üü¶',
            path: 'üü´',
            house: 'üè†',
            sign: 'ü™ß',
            flower: 'üå∏',
            bridge: 'üåâ'
        };

        let MONS = {
            puddlefin: { name: 'Puddlefin', type: 'Water', maxHp: 22, atk: 12, def: 10, spd: 12, moves: ['Bubble', 'Tackle'], exp: 0, lvl: 5 },
            cinderwhelp: { name: 'Cinderwhelp', type: 'Fire', maxHp: 20, atk: 14, def: 8, spd: 14, moves: ['Ember', 'Scratch'], exp: 0, lvl: 5 },
            brambleclaw: { name: 'Brambleclaw', type: 'Nature', maxHp: 26, atk: 10, def: 12, spd: 9, moves: ['Vine Whip', 'Tackle'], exp: 0, lvl: 5 },
            
            // Wild
            worgpup: { name: 'Worgpup', type: 'Shadow', maxHp: 18, atk: 11, def: 7, spd: 13, moves: ['Bite', 'Howl'], exp: 15 },
            murloc_oracle: { name: 'Oracle', type: 'Water', maxHp: 20, atk: 12, def: 8, spd: 10, moves: ['Bubble', 'Heal'], exp: 20 },
            voidwalker: { name: 'Voidwalker', type: 'Shadow', maxHp: 25, atk: 8, def: 14, spd: 6, moves: ['Tackle', 'Harden'], exp: 25 },
            
            // Boss
            hogger: { name: 'Hogger', type: 'Normal', maxHp: 60, atk: 16, def: 12, spd: 10, moves: ['Smash', 'Laugh'], exp: 100 }
        };

        let MOVES = {
            'Bubble': { type: 'Water', pwr: 40, acc: 100 },
            'Tackle': { type: 'Normal', pwr: 35, acc: 95 },
            'Ember': { type: 'Fire', pwr: 40, acc: 100 },
            'Scratch': { type: 'Normal', pwr: 40, acc: 100 },
            'Vine Whip': { type: 'Nature', pwr: 45, acc: 100 },
            'Bite': { type: 'Shadow', pwr: 60, acc: 100 },
            'Howl': { type: 'Normal', pwr: 0, acc: 100, effect: 'atk_up' },
            'Smash': { type: 'Normal', pwr: 50, acc: 90 },
            'Laugh': { type: 'Normal', pwr: 0, acc: 100, effect: 'def_down' },
            'Heal': { type: 'Normal', pwr: 0, acc: 100, effect: 'heal' },
            'Harden': { type: 'Normal', pwr: 0, acc: 100, effect: 'def_up' }
        };

        let MAPS = {
            'Northshire': {
                width: 20, height: 20,
                data: [
                    "TTTTTTTTTTTTTTTTTTTT",
                    "TTTTTTTTTTTTTTTTTTTT",
                    "TTGGGGGGGGGGGGGGGGTT",
                    "TTGGGGGGGGGGGGGGGGTT",
                    "TTGGHHGGGGGGHHGGGGTT",
                    "TTGGPPGGGGGGPPGGGGTT",
                    "TTGGPPGGGGGGPPGGGGTT",
                    "TTGGPPPPPPPPPPGGGGTT",
                    "TTGGGGGGGGGGGGGGGGTT",
                    "TTGGGGGGGGGGGGGGGGTT",
                    "TTGGGGGGGGGGGGGGGGTT",
                    "TTGGGGGGGGGGGGGGGGTT",
                    "TTWWWWWWBBWWWWWWWWTT",
                    "TTWWWWWWBBWWWWWWWWTT",
                    "TTGGGGGGPPGGGGGGGGTT",
                    "TTGGGGGGPPGGGGGGGGTT",
                    "TTGGGGGGPPGGGGGGGGTT",
                    "TTGGGGGGPPGGGGGGGGTT",
                    "TTTTTTTTPPTTTTTTTTTT",
                    "TTTTTTTTPPTTTTTTTTTT"
                ],
                events: {
                    '5,6': { type: 'sign', text: "Northshire Abbey" },
                    '12,6': { type: 'sign', text: "Loremaster Cho's House" },
                    '8,19': { type: 'warp', map: 'Elwynn', x: 8, y: 1 }
                }
            },
            'Elwynn': {
                width: 20, height: 40,
                data: [
                    "TTTTTTTTPPTTTTTTTTTT",
                    "TTTTTTTTPPTTTTTTTTTT",
                    "TTGGGGGGPPGGGGGGGGTT",
                    "TTGGGGGGPPGGGGGGGGTT",
                    "TTGGFFFFPPFFFFGGGGTT", // F = Tall Grass (Flower/Fern)
                    "TTGGFFFFPPFFFFGGGGTT",
                    "TTGGFFFFPPFFFFGGGGTT",
                    "TTGGFFFFPPFFFFGGGGTT",
                    "TTGGGGGGPPGGGGGGGGTT",
                    "TTGGGGGGPPGGGGGGGGTT",
                    "TTTTTTTTTTTTTTTTTTTT" // Simplified for demo
                ],
                events: {
                    '8,0': { type: 'warp', map: 'Northshire', x: 8, y: 18 }
                }
            }
        };

        // --- GAME ENGINE ---
        const Game = {
            state: 'title', // title, intro, overworld, battle, menu, dialogue
            ctx: null,
            player: {
                x: 8,
                y: 8,
                dir: 'down',
                map: 'Northshire',
                team: [],
                bag: { potions: 5, balls: 5 }
            },
            camera: { x: 0, y: 0 },
            dialogueQueue: [],
            
            async init() {
                const canvas = document.getElementById('overworld-canvas');
                this.ctx = canvas.getContext('2d');
                
                // Try to load external assets
                await this.loadAssets();
                
                this.loop();
            },

            async loadAssets() {
                try {
                    console.log("Attempting to load assets...");
                    const [monsRes, movesRes, mapsRes] = await Promise.all([
                        fetch('data/games/wowmon/mons.json'),
                        fetch('data/games/wowmon/moves.json'),
                        fetch('data/games/wowmon/maps.json')
                    ]);

                    if (monsRes.ok) {
                        MONS = await monsRes.json();
                        console.log("Loaded MONS");
                    }
                    if (movesRes.ok) {
                        MOVES = await movesRes.json();
                        console.log("Loaded MOVES");
                    }
                    if (mapsRes.ok) {
                        MAPS = await mapsRes.json();
                        console.log("Loaded MAPS");
                    }
                } catch (e) {
                    console.log("Using embedded assets (Offline/No Server)", e);
                }
            },

            draw() {
                // Clear
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, 160, 144);

                if (this.state === 'overworld' || this.state === 'dialogue') {
                    this.drawOverworld();
                }
            },

            drawOverworld() {
                const map = MAPS[this.player.map];
                
                // Camera follow
                const camX = Math.max(0, Math.min(this.player.x * 16 - 80 + 8, map.width*16 - 160));
                const camY = Math.max(0, Math.min(this.player.y * 16 - 72 + 8, map.height*16 - 144));

                // Draw Map
                for(let y=0; y<map.height; y++) {
                    const row = map.data[y] || "";
                    for(let x=0; x<map.width; x++) {
                        const char = row[x];
                        let sprite = '‚¨õ';
                        if (char === 'T') sprite = SPRITES.tree;
                        if (char === 'G') sprite = SPRITES.grass;
                        if (char === 'P') sprite = SPRITES.path;
                        if (char === 'W') sprite = SPRITES.water;
                        if (char === 'H') sprite = SPRITES.house;
                        if (char === 'B') sprite = SPRITES.bridge;
                        if (char === 'F') sprite = SPRITES.flower; // Tall grass

                        const drawX = x * 16 - camX;
                        const drawY = y * 16 - camY;
                        
                        if (drawX < -16 || drawX > 160 || drawY < -16 || drawY > 144) continue;

                        this.ctx.font = '16px serif';
                        this.ctx.textBaseline = 'top';
                        this.ctx.fillText(sprite, drawX, drawY);
                    }
                }

                // Draw Player
                const pDrawX = this.player.x * 16 - camX;
                const pDrawY = this.player.y * 16 - camY;
                this.ctx.fillText(SPRITES.player, pDrawX, pDrawY);
            },

            loop() {
                requestAnimationFrame(() => Game.loop());
                Game.draw();
            },

            movePlayer(dx, dy) {
                if (this.state !== 'overworld') return;

                const map = MAPS[this.player.map];
                const newX = this.player.x + dx;
                const newY = this.player.y + dy;

                // Collision
                if (newX < 0 || newX >= map.width || newY < 0 || newY >= map.height) return;
                
                const tileChar = map.data[newY][newX];
                if (tileChar === 'T' || tileChar === 'W' || tileChar === 'H') return; // Solid tiles

                this.player.x = newX;
                this.player.y = newY;

                // Events (Warps, Signs)
                const key = `${newX},${newY}`;
                if (map.events && map.events[key]) {
                    const event = map.events[key];
                    if (event.type === 'warp') {
                        this.player.map = event.map;
                        this.player.x = event.x;
                        this.player.y = event.y;
                    } else if (event.type === 'sign') {
                        this.showDialogue(event.text);
                    }
                }

                // Wild Encounter Check (Tall Grass 'F')
                if (tileChar === 'F' && Math.random() < 0.15) {
                    const wildPool = ['worgpup', 'murloc_oracle', 'voidwalker'];
                    const wildId = wildPool[Math.floor(Math.random() * wildPool.length)];
                    this.startBattle(wildId);
                }
            },

            showDialogue(text) {
                this.state = 'dialogue';
                document.getElementById('dialogue-box').style.display = 'block';
                document.getElementById('dialogue-text').innerText = text;
            },

            advanceDialogue() {
                // Simple close for now
                this.state = 'overworld';
                document.getElementById('dialogue-box').style.display = 'none';
            },

            startBattle(enemyId) {
                this.state = 'battle';
                document.getElementById('overworld-screen').classList.remove('active');
                document.getElementById('battle-screen').classList.add('active');
                Battle.init(enemyId);
            },
            
            showMenu() {
                if (this.state === 'overworld') {
                    this.state = 'menu';
                    document.getElementById('start-menu').style.display = 'block';
                } else if (this.state === 'menu') {
                    this.state = 'overworld';
                    document.getElementById('start-menu').style.display = 'none';
                }
            },
            
            startGame() {
                document.getElementById('title-screen').classList.remove('active');
                this.startIntro();
            },

            startIntro() {
                this.state = 'intro';
                // Simple HTML overlay for intro
                const introDiv = document.createElement('div');
                introDiv.id = 'intro-screen';
                introDiv.className = 'game-screen active';
                introDiv.style.background = '#fff';
                introDiv.style.color = '#000';
                introDiv.style.padding = '20px';
                introDiv.style.textAlign = 'center';
                introDiv.innerHTML = `
                    <div style="font-size: 40px; margin-bottom: 20px;">${SPRITES.cho}</div>
                    <p>Greetings! I am Loremaster Cho.</p>
                    <p>Welcome to the world of Azerymons!</p>
                    <p>Spirits inhabit every corner of this land.</p>
                    <button class="menu-btn" style="margin: 20px auto;" onclick="Game.introNext()">CONTINUE</button>
                `;
                document.getElementById('screen-container').appendChild(introDiv);
            },

            introNext() {
                const div = document.getElementById('intro-screen');
                div.innerHTML = `
                    <p>You are a Spirit Binder, yes?</p>
                    <p>Choose your first companion!</p>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                        <div onclick="Game.pickStarter('puddlefin')" style="cursor: pointer; border: 2px solid #000; padding: 5px;">
                            <div style="font-size: 30px;">${SPRITES.puddlefin}</div>
                            <div>Water</div>
                        </div>
                        <div onclick="Game.pickStarter('cinderwhelp')" style="cursor: pointer; border: 2px solid #000; padding: 5px;">
                            <div style="font-size: 30px;">${SPRITES.cinderwhelp}</div>
                            <div>Fire</div>
                        </div>
                        <div onclick="Game.pickStarter('brambleclaw')" style="cursor: pointer; border: 2px solid #000; padding: 5px;">
                            <div style="font-size: 30px;">${SPRITES.brambleclaw}</div>
                            <div>Nature</div>
                        </div>
                    </div>
                `;
            },

            pickStarter(id) {
                this.player.team.push({ ...MONS[id], hp: MONS[id].maxHp });
                document.getElementById('intro-screen').remove();
                document.getElementById('overworld-screen').classList.add('active');
                this.state = 'overworld';
                this.init();
                this.showDialogue(`You chose ${MONS[id].name}! Adventure awaits!`);
            }
        };

        // --- BATTLE SYSTEM ---
        const Battle = {
            enemy: null,
            playerMon: null,
            turn: 0,

            init(enemyId) {
                this.enemy = { ...MONS[enemyId], hp: MONS[enemyId].maxHp, lvl: 3 }; 
                this.playerMon = Game.player.team[0]; 
                
                // UI Setup
                document.getElementById('enemy-name-disp').innerText = this.enemy.name;
                document.getElementById('enemy-lvl').innerText = this.enemy.lvl;
                document.getElementById('enemy-mon').style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">${SPRITES[enemyId]}</text></svg>')`;
                
                document.getElementById('player-name-disp').innerText = this.playerMon.name;
                document.getElementById('player-lvl').innerText = this.playerMon.lvl;
                // Find sprite key by name (lowercase)
                const pSprite = SPRITES[Object.keys(MONS).find(key => MONS[key].name === this.playerMon.name)];
                document.getElementById('player-mon').style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">${pSprite}</text></svg>')`;
                
                this.updateHealthUI();
                
                this.log(`Wild ${this.enemy.name} appeared!`);
                document.getElementById('battle-actions').style.display = 'grid';
                document.getElementById('move-menu').style.display = 'none';
            },

            updateHealthUI() {
                const ePct = Math.max(0, (this.enemy.hp / this.enemy.maxHp) * 100);
                document.getElementById('enemy-hp-fill').style.width = `${ePct}%`;
                
                const pPct = Math.max(0, (this.playerMon.hp / this.playerMon.maxHp) * 100);
                document.getElementById('player-hp-fill').style.width = `${pPct}%`;
                document.getElementById('player-hp-text').innerText = `${this.playerMon.hp}/${this.playerMon.maxHp}`;
                
                document.getElementById('player-hp-fill').style.background = pPct < 20 ? '#f00' : pPct < 50 ? '#fc0' : '#4caf50';
            },

            log(text) {
                document.getElementById('battle-text').innerText = text;
            },

            fight() {
                document.getElementById('battle-actions').style.display = 'none';
                document.getElementById('move-menu').style.display = 'grid';
                
                const menu = document.getElementById('move-menu');
                menu.innerHTML = '';
                this.playerMon.moves.forEach(moveName => {
                    const btn = document.createElement('button');
                    btn.className = 'menu-btn';
                    btn.innerText = moveName;
                    btn.onclick = () => this.useMove(moveName);
                    menu.appendChild(btn);
                });
                const back = document.createElement('button');
                back.className = 'menu-btn';
                back.innerText = 'BACK';
                back.onclick = () => this.back();
                menu.appendChild(back);
            },

            back() {
                document.getElementById('move-menu').style.display = 'none';
                document.getElementById('battle-actions').style.display = 'grid';
            },

            useMove(moveName) {
                document.getElementById('move-menu').style.display = 'none';
                
                // Player Move
                const move = MOVES[moveName];
                this.log(`${this.playerMon.name} used ${moveName}!`);
                
                setTimeout(() => {
                    // Damage Calc
                    let dmg = Math.floor((this.playerMon.atk / this.enemy.def) * move.pwr * 0.5);
                    if (move.pwr === 0) dmg = 0; // Status move
                    
                    this.enemy.hp = Math.max(0, this.enemy.hp - dmg);
                    this.updateHealthUI();
                    
                    if (this.enemy.hp <= 0) {
                        this.winBattle();
                    } else {
                        setTimeout(() => this.enemyTurn(), 1000);
                    }
                }, 1000);
            },

            enemyTurn() {
                const moveName = this.enemy.moves[Math.floor(Math.random() * this.enemy.moves.length)];
                const move = MOVES[moveName];
                
                this.log(`Enemy ${this.enemy.name} used ${moveName}!`);
                
                setTimeout(() => {
                    let dmg = Math.floor((this.enemy.atk / this.playerMon.def) * move.pwr * 0.5);
                    if (move.pwr === 0) dmg = 0;

                    this.playerMon.hp = Math.max(0, this.playerMon.hp - dmg);
                    this.updateHealthUI();
                    
                    if (this.playerMon.hp <= 0) {
                        this.loseBattle();
                    } else {
                        document.getElementById('battle-actions').style.display = 'grid';
                        this.log(`What will ${this.playerMon.name} do?`);
                    }
                }, 1000);
            },

            winBattle() {
                this.log(`Enemy ${this.enemy.name} fainted!`);
                setTimeout(() => {
                    this.log(`You gained ${this.enemy.exp} EXP!`);
                    setTimeout(() => {
                        document.getElementById('battle-screen').classList.remove('active');
                        document.getElementById('overworld-screen').classList.add('active');
                        Game.state = 'overworld';
                    }, 1500);
                }, 1000);
            },

            loseBattle() {
                this.log(`${this.playerMon.name} fainted!`);
                
                setTimeout(() => {
                    document.getElementById('dead-mon-name').innerText = this.playerMon.name;
                    document.getElementById('permadeath-warning').style.display = 'block';
                    
                    Game.player.team.shift();
                    
                    if (Game.player.team.length === 0) {
                        this.log("You have no more WowMons...");
                        setTimeout(() => location.reload(), 3000);
                    } else {
                        this.playerMon = Game.player.team[0];
                        this.updateHealthUI();
                        document.getElementById('battle-screen').classList.remove('active');
                        document.getElementById('overworld-screen').classList.add('active');
                        Game.state = 'overworld';
                    }
                }, 1500);
            },
            
            run() {
                this.log("Got away safely!");
                setTimeout(() => {
                    document.getElementById('battle-screen').classList.remove('active');
                    document.getElementById('overworld-screen').classList.add('active');
                    Game.state = 'overworld';
                }, 1000);
            }
        };

        // --- INPUT HANDLING ---
        const Input = {
            up() { Game.movePlayer(0, -1); },
            down() { Game.movePlayer(0, 1); },
            left() { Game.movePlayer(-1, 0); },
            right() { Game.movePlayer(1, 0); },
            a() { 
                if (Game.state === 'title') Game.startGame();
                else if (Game.state === 'dialogue') Game.advanceDialogue();
            },
            b() { 
                if (Game.state === 'menu') Game.showMenu();
            },
            start() { 
                if (Game.state === 'title') Game.startGame();
                else Game.showMenu();
            },
            select() { }
        };

        // Keyboard support
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp') Input.up();
            if (e.key === 'ArrowDown') Input.down();
            if (e.key === 'ArrowLeft') Input.left();
            if (e.key === 'ArrowRight') Input.right();
            if (e.key === 'z') Input.a();
            if (e.key === 'x') Input.b();
            if (e.key === 'Enter') Input.start();
        });

        // Animation CSS
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>