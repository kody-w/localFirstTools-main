<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEEP STATE - Conspiracy Board Investigation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #gameContainer {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar */
        #topBar {
            background: #2a2a2a;
            padding: 10px 20px;
            border-bottom: 2px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        #topBar h1 {
            font-size: 24px;
            color: #ff4444;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 3px;
        }

        #stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            color: #888;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
        }

        #heatMeter {
            width: 100px;
            height: 8px;
            background: #333;
            border: 1px solid #666;
            position: relative;
            overflow: hidden;
        }

        #heatBar {
            height: 100%;
            background: linear-gradient(90deg, #ffaa00, #ff4444, #aa0000);
            transition: width 0.3s;
        }

        /* Main Game Area */
        #gameArea {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* Evidence Board */
        #boardContainer {
            flex: 1;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }

        #boardContainer.grabbing {
            cursor: grabbing;
        }

        #evidenceBoard {
            position: absolute;
            top: 0;
            left: 0;
            background:
                repeating-linear-gradient(
                    0deg,
                    #8b7355 0px,
                    #8b7355 2px,
                    transparent 2px,
                    transparent 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    #8b7355 0px,
                    #8b7355 2px,
                    transparent 2px,
                    transparent 4px
                ),
                radial-gradient(circle at 20% 30%, #9d8568 0%, #7a6449 100%);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.3);
        }

        /* Evidence Piece */
        .evidence-piece {
            position: absolute;
            cursor: move;
            user-select: none;
            transition: transform 0.1s;
        }

        .evidence-piece:hover {
            transform: scale(1.05);
            z-index: 50 !important;
        }

        .evidence-piece.selected {
            transform: scale(1.1);
            z-index: 51 !important;
        }

        .evidence-content {
            background: #fff;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 1px solid #ccc;
            position: relative;
        }

        .evidence-type-document .evidence-content {
            width: 180px;
            min-height: 220px;
            background: #fdfdf8;
        }

        .evidence-type-photo .evidence-content {
            width: 160px;
            height: 160px;
            background: #f5f5f5;
            border: 8px solid #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
        }

        .evidence-type-testimony .evidence-content {
            width: 200px;
            min-height: 150px;
            background: #fffef0;
        }

        .evidence-type-financial .evidence-content {
            width: 220px;
            min-height: 180px;
            background: #f0f8f0;
        }

        .evidence-type-communication .evidence-content {
            width: 190px;
            min-height: 140px;
            background: #f0f0ff;
        }

        .evidence-type-physical .evidence-content {
            width: 150px;
            height: 150px;
            background: #fef8f0;
        }

        .thumbtack {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            z-index: 10;
        }

        .thumbtack::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: radial-gradient(circle, #ff6666, #cc3333);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4), inset 0 -2px 2px rgba(0,0,0,0.3);
        }

        .thumbtack::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 8px;
            background: linear-gradient(180deg, #888, #555);
            box-shadow: 0 1px 2px rgba(0,0,0,0.4);
        }

        .evidence-title {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #222;
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
        }

        .evidence-text {
            font-size: 10px;
            line-height: 1.4;
            color: #333;
        }

        .classification {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 8px;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 2px;
            background: #000;
            color: #fff;
        }

        .classification.public { background: #4CAF50; }
        .classification.leaked { background: #FF9800; }
        .classification.classified { background: #F44336; }
        .classification.eyesonly { background: #9C27B0; }

        .redaction {
            display: inline-block;
            background: #000;
            color: #000;
            user-select: none;
        }

        /* Red String Canvas */
        #stringCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }

        /* Side Panel */
        #sidePanel {
            width: 320px;
            background: #252525;
            border-left: 2px solid #444;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-tabs {
            display: flex;
            background: #2a2a2a;
            border-bottom: 2px solid #444;
        }

        .panel-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: #2a2a2a;
            color: #888;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: all 0.2s;
        }

        .panel-tab:hover {
            background: #333;
            color: #fff;
        }

        .panel-tab.active {
            background: #444;
            color: #fff;
            border-bottom: 2px solid #ff4444;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }

        .panel-content.active {
            display: block;
        }

        /* Evidence List */
        .evidence-list-item {
            background: #333;
            margin-bottom: 10px;
            padding: 10px;
            border-left: 3px solid #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .evidence-list-item:hover {
            background: #3a3a3a;
            border-left-color: #ff4444;
        }

        .evidence-list-item.placed {
            opacity: 0.6;
        }

        .evidence-list-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #fff;
        }

        .evidence-list-desc {
            font-size: 10px;
            color: #aaa;
            line-height: 1.3;
        }

        /* Sources */
        .source-item {
            background: #333;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 4px;
        }

        .source-name {
            font-size: 13px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .source-role {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .source-stat {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            margin-bottom: 3px;
        }

        .source-bar {
            width: 60%;
            height: 6px;
            background: #222;
            border-radius: 3px;
            overflow: hidden;
        }

        .source-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
        }

        .source-bar-fill.risk {
            background: linear-gradient(90deg, #FF9800, #F44336);
        }

        .source-actions {
            margin-top: 8px;
            display: flex;
            gap: 5px;
        }

        .source-btn {
            flex: 1;
            padding: 5px;
            background: #444;
            border: 1px solid #666;
            color: #fff;
            cursor: pointer;
            font-size: 9px;
            font-family: 'Courier New', monospace;
            transition: all 0.2s;
        }

        .source-btn:hover {
            background: #555;
            border-color: #ff4444;
        }

        .source-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Actions Panel */
        .action-category {
            margin-bottom: 20px;
        }

        .action-category-title {
            font-size: 13px;
            font-weight: bold;
            color: #ff4444;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .action-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            cursor: pointer;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #3a3a3a;
            border-color: #ff4444;
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .action-cost {
            float: right;
            color: #888;
            font-size: 10px;
        }

        /* Story Panel */
        .story-entry {
            background: #333;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #ff4444;
        }

        .story-day {
            font-size: 10px;
            color: #888;
            margin-bottom: 5px;
        }

        .story-text {
            font-size: 11px;
            line-height: 1.5;
            color: #ddd;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 30px;
            border: 2px solid #ff4444;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .modal-title {
            font-size: 20px;
            color: #ff4444;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 2px;
        }

        .modal-text {
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 15px;
            color: #ddd;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            background: #444;
            border: 1px solid #666;
            color: #fff;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: all 0.2s;
        }

        .modal-btn:hover {
            background: #555;
            border-color: #ff4444;
        }

        .modal-btn.primary {
            background: #ff4444;
            border-color: #ff4444;
        }

        .modal-btn.primary:hover {
            background: #ff6666;
        }

        /* Context Menu */
        #contextMenu {
            display: none;
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #666;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 2000;
            min-width: 150px;
        }

        .context-item {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid #333;
            transition: background 0.2s;
        }

        .context-item:hover {
            background: #444;
        }

        .context-item:last-child {
            border-bottom: none;
        }

        /* Toolbar */
        #toolbar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(42, 42, 42, 0.95);
            padding: 10px;
            border: 1px solid #666;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .tool-btn {
            padding: 8px 12px;
            background: #444;
            border: 1px solid #666;
            color: #fff;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #555;
            border-color: #ff4444;
        }

        .tool-btn.active {
            background: #ff4444;
            border-color: #ff4444;
        }

        /* Intro Screen */
        #introScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .intro-content {
            max-width: 700px;
            padding: 40px;
            text-align: center;
        }

        .intro-title {
            font-size: 48px;
            color: #ff4444;
            letter-spacing: 8px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .intro-subtitle {
            font-size: 16px;
            color: #888;
            margin-bottom: 30px;
            letter-spacing: 2px;
        }

        .intro-text {
            font-size: 13px;
            line-height: 1.8;
            color: #ccc;
            margin-bottom: 30px;
            text-align: left;
        }

        .intro-btn {
            padding: 15px 40px;
            background: #ff4444;
            border: 2px solid #ff4444;
            color: #fff;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        .intro-btn:hover {
            background: transparent;
            color: #ff4444;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Mini-game styles */
        .minigame-container {
            padding: 20px;
        }

        .cipher-input {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #666;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
        }

        .cipher-text {
            background: #222;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #0f0;
            border: 1px solid #444;
        }

        .dialogue-option {
            background: #333;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dialogue-option:hover {
            background: #3a3a3a;
            border-left-color: #ff4444;
        }

        .timeline-event {
            padding: 10px;
            margin: 5px 0;
            background: #333;
            border-left: 3px solid #ff4444;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- Top Bar -->
        <div id="topBar">
            <h1>DEEP STATE</h1>
            <div id="stats">
                <div class="stat">
                    <span class="stat-label">DAY:</span>
                    <span class="stat-value" id="dayCounter">1</span>
                </div>
                <div class="stat">
                    <span class="stat-label">EVIDENCE:</span>
                    <span class="stat-value" id="evidenceCount">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">HEAT:</span>
                    <div id="heatMeter">
                        <div id="heatBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Game Area -->
        <div id="gameArea">
            <!-- Evidence Board -->
            <div id="boardContainer">
                <canvas id="stringCanvas"></canvas>
                <div id="evidenceBoard"></div>
            </div>

            <!-- Side Panel -->
            <div id="sidePanel">
                <div class="panel-tabs">
                    <button class="panel-tab active" data-tab="evidence">EVIDENCE</button>
                    <button class="panel-tab" data-tab="sources">SOURCES</button>
                    <button class="panel-tab" data-tab="actions">ACTIONS</button>
                    <button class="panel-tab" data-tab="story">STORY</button>
                </div>

                <div id="evidencePanel" class="panel-content active">
                    <div id="evidenceList"></div>
                </div>

                <div id="sourcesPanel" class="panel-content">
                    <div id="sourcesList"></div>
                </div>

                <div id="actionsPanel" class="panel-content">
                    <div id="actionsList"></div>
                </div>

                <div id="storyPanel" class="panel-content">
                    <div id="storyLog"></div>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div id="toolbar">
            <button class="tool-btn" id="clearStringsBtn">Clear Strings</button>
            <button class="tool-btn" id="publishBtn">Publish Article</button>
            <button class="tool-btn" id="advanceDayBtn">Advance Day</button>
            <button class="tool-btn" id="saveGameBtn">Save Game</button>
            <button class="tool-btn" id="newGameBtn">New Investigation</button>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu">
        <div class="context-item" data-action="connect">Draw Connection</div>
        <div class="context-item" data-action="examine">Examine Closely</div>
        <div class="context-item" data-action="remove">Remove from Board</div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div id="modalBody"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <!-- Intro Screen -->
    <div id="introScreen">
        <div class="intro-content">
            <div class="intro-title">DEEP STATE</div>
            <div class="intro-subtitle">Conspiracy Board Investigation</div>
            <div class="intro-text">
                You are an independent investigative journalist. A source has leaked documents suggesting a vast conspiracy
                connecting powerful corporations, government officials, and shadow organizations. Your job: build the evidence
                board, cultivate sources, follow the money, and expose the truth before they expose you.
                <br><br>
                Every investigation is different. Every conspiracy runs deep. Trust no one. Verify everything.
                <br><br>
                Pin evidence to your board. Draw connections with red string. Manage your sources carefully.
                The closer you get to the truth, the more dangerous it becomes.
            </div>
            <button class="intro-btn" id="startGameBtn">BEGIN INVESTIGATION</button>
        </div>
    </div>

    <script>
        // ===============================================
        // GAME STATE
        // ===============================================
        const game = {
            day: 1,
            heat: 0,
            conspiracy: null,
            evidence: [],
            placedEvidence: [],
            sources: [],
            connections: [],
            storyLog: [],
            discoveredActors: [],
            boardOffset: { x: 0, y: 0 },
            boardScale: 1,
            selectedEvidence: null,
            connectingFrom: null,
            isPanning: false,
            panStart: { x: 0, y: 0 }
        };

        // ===============================================
        // CONSPIRACY GENERATOR
        // ===============================================
        class ConspiracyGenerator {
            constructor() {
                this.actors = [];
                this.connections = [];
                this.evidence = [];
            }

            generate() {
                this.actors = [];
                this.connections = [];
                this.evidence = [];

                // Generate actors across 5 layers
                this.generateLayer1(); // Public figures (8-10)
                this.generateLayer2(); // Shell companies (6-8)
                this.generateLayer3(); // Secret meetings (5-7)
                this.generateLayer4(); // Black ops (4-6)
                this.generateLayer5(); // Inner circle (2-3)

                // Generate connections
                this.generateConnections();

                // Generate evidence pieces
                this.generateEvidence();

                return {
                    actors: this.actors,
                    connections: this.connections,
                    evidence: this.evidence
                };
            }

            generateLayer1() {
                const roles = ['Senator', 'CEO', 'General', 'Director', 'Governor', 'Ambassador'];
                const companies = ['TechCorp', 'BioSystems', 'Defense Dynamics', 'Global Energy', 'MediaGroup'];

                for (let i = 0; i < 9; i++) {
                    this.actors.push({
                        id: `L1_${i}`,
                        layer: 1,
                        name: this.randomName(),
                        role: this.randomChoice(roles),
                        organization: this.randomChoice(companies),
                        type: 'person',
                        discovered: i < 3 // Start with a few discovered
                    });
                }
            }

            generateLayer2() {
                const shellTypes = ['Holdings LLC', 'International Ltd', 'Ventures Inc', 'Capital Partners', 'Solutions Group'];

                for (let i = 0; i < 7; i++) {
                    const adjective = this.randomChoice(['Pacific', 'Atlantic', 'Global', 'Summit', 'Horizon', 'Phoenix']);
                    this.actors.push({
                        id: `L2_${i}`,
                        layer: 2,
                        name: `${adjective} ${this.randomChoice(shellTypes)}`,
                        role: 'Shell Company',
                        type: 'organization',
                        discovered: false
                    });
                }
            }

            generateLayer3() {
                const operations = ['Overwatch', 'Nightfall', 'Redline', 'Blackwater', 'Silent Spring', 'Iron Curtain'];

                for (let i = 0; i < 6; i++) {
                    this.actors.push({
                        id: `L3_${i}`,
                        layer: 3,
                        name: `Operation ${this.randomChoice(operations)}`,
                        role: 'Classified Program',
                        type: 'operation',
                        discovered: false
                    });
                }
            }

            generateLayer4() {
                for (let i = 0; i < 5; i++) {
                    this.actors.push({
                        id: `L4_${i}`,
                        layer: 4,
                        name: this.randomCodename(),
                        role: 'Black Ops Asset',
                        type: 'operative',
                        discovered: false
                    });
                }
            }

            generateLayer5() {
                const titles = ['The Architect', 'The Handler', 'The Coordinator'];

                for (let i = 0; i < 3; i++) {
                    this.actors.push({
                        id: `L5_${i}`,
                        layer: 5,
                        name: titles[i],
                        role: 'Inner Circle',
                        type: 'mastermind',
                        discovered: false
                    });
                }
            }

            generateConnections() {
                // Connect each layer to the next with logical links
                for (let layer = 1; layer < 5; layer++) {
                    const currentLayer = this.actors.filter(a => a.layer === layer);
                    const nextLayer = this.actors.filter(a => a.layer === layer + 1);

                    currentLayer.forEach(actor => {
                        // Each actor connects to 1-3 in next layer
                        const numConnections = Math.floor(Math.random() * 3) + 1;
                        for (let i = 0; i < numConnections; i++) {
                            const target = this.randomChoice(nextLayer);
                            this.connections.push({
                                from: actor.id,
                                to: target.id,
                                type: this.getConnectionType(layer),
                                discovered: false
                            });
                        }
                    });
                }

                // Add some red herrings (false connections)
                for (let i = 0; i < 10; i++) {
                    const a1 = this.randomChoice(this.actors);
                    const a2 = this.randomChoice(this.actors);
                    if (a1.id !== a2.id) {
                        this.connections.push({
                            from: a1.id,
                            to: a2.id,
                            type: 'suspected',
                            discovered: false,
                            redHerring: true
                        });
                    }
                }
            }

            getConnectionType(layer) {
                const types = [
                    ['funding', 'employment', 'ownership'],
                    ['money_transfer', 'shell_account', 'contract'],
                    ['communication', 'meeting', 'operation'],
                    ['command', 'handler', 'asset']
                ];
                return this.randomChoice(types[layer - 1]);
            }

            generateEvidence() {
                const types = ['document', 'photo', 'testimony', 'financial', 'communication', 'physical'];
                const classifications = ['public', 'leaked', 'classified', 'eyesonly'];

                // Generate 40-50 evidence pieces
                for (let i = 0; i < 45; i++) {
                    const actor = this.randomChoice(this.actors);
                    const type = this.randomChoice(types);

                    this.evidence.push({
                        id: `E_${i}`,
                        type: type,
                        classification: this.randomChoice(classifications),
                        relatedTo: [actor.id],
                        title: this.generateEvidenceTitle(type, actor),
                        content: this.generateEvidenceContent(type, actor),
                        discovered: i < 5, // Start with a few pieces
                        layer: actor.layer
                    });
                }

                // Add connection evidence
                this.connections.slice(0, 30).forEach((conn, i) => {
                    this.evidence.push({
                        id: `EC_${i}`,
                        type: this.randomChoice(types),
                        classification: this.randomChoice(classifications),
                        relatedTo: [conn.from, conn.to],
                        title: this.generateConnectionTitle(conn),
                        content: this.generateConnectionContent(conn),
                        discovered: false,
                        connectionEvidence: true
                    });
                });
            }

            generateEvidenceTitle(type, actor) {
                const templates = {
                    document: ['Internal Memo RE: ', 'Contract with ', 'Report on ', 'Classified Brief: '],
                    photo: ['Photo of ', 'Surveillance Image: ', 'Meeting photograph: ', 'Evidence photo: '],
                    testimony: ['Statement from ', 'Interview transcript: ', 'Witness account: ', 'Deposition: '],
                    financial: ['Bank transfer to ', 'Account statement: ', 'Wire record: ', 'Payment to '],
                    communication: ['Email from ', 'Phone record: ', 'Encrypted message: ', 'Communication log: '],
                    physical: ['Evidence bag: ', 'Physical sample: ', 'Recovered item: ', 'Artifact: ']
                };
                return this.randomChoice(templates[type]) + actor.name;
            }

            generateEvidenceContent(type, actor) {
                const templates = [
                    `Reference to ${actor.name} in connection with ${actor.organization || 'classified operation'}`,
                    `Documentation linking ${actor.role} to suspicious activities`,
                    `Evidence suggesting involvement in ${this.randomChoice(['money laundering', 'influence peddling', 'conspiracy', 'corruption'])}`,
                    `Details about ${actor.name}'s role in the operation`,
                    `Compromising information regarding ${actor.role}`,
                    `Financial records showing irregular transactions`,
                    `Communication suggesting coordination with others`,
                    `Testimony implicating ${actor.name} in wrongdoing`
                ];
                return this.randomChoice(templates);
            }

            generateConnectionTitle(conn) {
                return `Connection: ${conn.type} evidence`;
            }

            generateConnectionContent(conn) {
                return `Evidence of ${conn.type} relationship between two entities`;
            }

            randomName() {
                const first = ['James', 'Robert', 'Michael', 'William', 'David', 'Richard', 'Thomas', 'Charles',
                              'Mary', 'Patricia', 'Jennifer', 'Linda', 'Barbara', 'Elizabeth', 'Susan', 'Jessica'];
                const last = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis',
                             'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Wilson', 'Anderson', 'Thomas', 'Moore'];
                return `${this.randomChoice(first)} ${this.randomChoice(last)}`;
            }

            randomCodename() {
                const adj = ['Red', 'Black', 'Blue', 'Gray', 'White', 'Shadow', 'Ghost', 'Iron', 'Steel', 'Silver'];
                const noun = ['Wolf', 'Eagle', 'Bear', 'Tiger', 'Falcon', 'Viper', 'Phoenix', 'Raven', 'Hawk', 'Fox'];
                return `${this.randomChoice(adj)} ${this.randomChoice(noun)}`;
            }

            randomChoice(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            }
        }

        // ===============================================
        // SOURCE GENERATOR
        // ===============================================
        class SourceGenerator {
            generate() {
                const sources = [];
                const roles = [
                    'Intelligence Analyst', 'Corporate Whistleblower', 'Former Operative',
                    'Financial Auditor', 'IT Specialist', 'Congressional Aide',
                    'Military Officer', 'Legal Clerk', 'Journalist', 'Hacker',
                    'Security Guard', 'Executive Assistant', 'Forensic Accountant',
                    'Private Investigator', 'Government Employee'
                ];

                const codenames = [
                    'Deep Throat', 'Falcon', 'Nightingale', 'Oracle', 'Cipher',
                    'Raven', 'Ghost', 'Phoenix', 'Shadow', 'Atlas',
                    'Mercury', 'Viper', 'Sphinx', 'Prometheus', 'Harbinger'
                ];

                for (let i = 0; i < 15; i++) {
                    sources.push({
                        id: `SRC_${i}`,
                        codename: codenames[i],
                        role: roles[i],
                        trust: Math.floor(Math.random() * 40) + 20,
                        risk: Math.floor(Math.random() * 30) + 10,
                        knowledge: this.randomKnowledge(),
                        status: 'active',
                        contacted: i < 3,
                        lastContact: null,
                        meetingCount: 0
                    });
                }

                return sources;
            }

            randomKnowledge() {
                const domains = ['finance', 'operations', 'communications', 'personnel', 'classified'];
                const count = Math.floor(Math.random() * 3) + 1;
                return this.shuffle(domains).slice(0, count);
            }

            shuffle(arr) {
                const result = [...arr];
                for (let i = result.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [result[i], result[j]] = [result[j], result[i]];
                }
                return result;
            }
        }

        // ===============================================
        // EVIDENCE BOARD RENDERING
        // ===============================================
        class EvidenceBoard {
            constructor() {
                this.container = document.getElementById('boardContainer');
                this.board = document.getElementById('evidenceBoard');
                this.canvas = document.getElementById('stringCanvas');
                this.ctx = this.canvas.getContext('2d');

                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                const rect = this.container.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;

                // Set board size (larger virtual space)
                this.board.style.width = '4000px';
                this.board.style.height = '3000px';

                this.redrawStrings();
            }

            placeEvidence(evidence, x, y) {
                const piece = document.createElement('div');
                piece.className = `evidence-piece evidence-type-${evidence.type}`;
                piece.dataset.evidenceId = evidence.id;
                piece.style.left = x + 'px';
                piece.style.top = y + 'px';
                piece.style.zIndex = '10';

                const content = document.createElement('div');
                content.className = 'evidence-content';

                // Thumbtack
                const tack = document.createElement('div');
                tack.className = 'thumbtack';
                piece.appendChild(tack);

                // Classification badge
                const classTag = document.createElement('div');
                classTag.className = `classification ${evidence.classification}`;
                classTag.textContent = evidence.classification.toUpperCase();
                content.appendChild(classTag);

                // Title
                const title = document.createElement('div');
                title.className = 'evidence-title';
                title.textContent = evidence.title;
                content.appendChild(title);

                // Content
                const text = document.createElement('div');
                text.className = 'evidence-text';

                if (evidence.classification === 'classified' || evidence.classification === 'eyesonly') {
                    text.innerHTML = this.redactText(evidence.content);
                } else {
                    text.textContent = evidence.content;
                }

                content.appendChild(text);
                piece.appendChild(content);

                // Make draggable
                this.makeDraggable(piece);

                this.board.appendChild(piece);

                // Add to placed evidence
                game.placedEvidence.push({
                    evidenceId: evidence.id,
                    x: x,
                    y: y,
                    element: piece
                });

                return piece;
            }

            redactText(text) {
                const words = text.split(' ');
                return words.map(word => {
                    if (Math.random() > 0.4) {
                        return `<span class="redaction">${word}</span>`;
                    }
                    return word;
                }).join(' ');
            }

            makeDraggable(element) {
                let isDragging = false;
                let startX, startY, initialLeft, initialTop;

                element.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return; // Only left click

                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;

                    const rect = element.getBoundingClientRect();
                    const boardRect = this.board.getBoundingClientRect();

                    initialLeft = rect.left - boardRect.left;
                    initialTop = rect.top - boardRect.top;

                    element.classList.add('selected');
                    element.style.zIndex = '50';

                    e.stopPropagation();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;

                    element.style.left = (initialLeft + dx) + 'px';
                    element.style.top = (initialTop + dy) + 'px';

                    evidenceBoard.redrawStrings();
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        element.classList.remove('selected');
                        element.style.zIndex = '10';

                        // Update position in game state
                        const placed = game.placedEvidence.find(p => p.element === element);
                        if (placed) {
                            placed.x = parseInt(element.style.left);
                            placed.y = parseInt(element.style.top);
                        }
                    }
                });

                // Right-click context menu
                element.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    game.selectedEvidence = element;
                    showContextMenu(e.clientX, e.clientY);
                });
            }

            drawString(from, to) {
                const connection = { from, to };
                game.connections.push(connection);
                this.redrawStrings();
            }

            redrawStrings() {
                const ctx = this.ctx;
                ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                const boardRect = this.board.getBoundingClientRect();
                const canvasRect = this.canvas.getBoundingClientRect();

                game.connections.forEach(conn => {
                    const fromEl = document.querySelector(`[data-evidence-id="${conn.from}"]`);
                    const toEl = document.querySelector(`[data-evidence-id="${conn.to}"]`);

                    if (!fromEl || !toEl) return;

                    const fromRect = fromEl.getBoundingClientRect();
                    const toRect = toEl.getBoundingClientRect();

                    const x1 = fromRect.left + fromRect.width / 2 - canvasRect.left;
                    const y1 = fromRect.top + fromRect.height / 2 - canvasRect.top;
                    const x2 = toRect.left + toRect.width / 2 - canvasRect.left;
                    const y2 = toRect.top + toRect.height / 2 - canvasRect.top;

                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 2;
                    ctx.shadowColor = 'rgba(255, 0, 0, 0.5)';
                    ctx.shadowBlur = 4;

                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                });
            }

            clearStrings() {
                game.connections = [];
                this.redrawStrings();
            }
        }

        // ===============================================
        // UI MANAGEMENT
        // ===============================================
        function updateUI() {
            document.getElementById('dayCounter').textContent = game.day;
            document.getElementById('evidenceCount').textContent = game.placedEvidence.length;

            const heatPercent = Math.min((game.heat / 100) * 100, 100);
            document.getElementById('heatBar').style.width = heatPercent + '%';

            renderEvidenceList();
            renderSourcesList();
            renderActionsList();
            renderStoryLog();
        }

        function renderEvidenceList() {
            const list = document.getElementById('evidenceList');
            list.innerHTML = '';

            const discovered = game.evidence.filter(e => e.discovered);

            discovered.forEach(evidence => {
                const item = document.createElement('div');
                item.className = 'evidence-list-item';

                const placed = game.placedEvidence.find(p => p.evidenceId === evidence.id);
                if (placed) {
                    item.classList.add('placed');
                }

                const title = document.createElement('div');
                title.className = 'evidence-list-title';
                title.textContent = evidence.title;
                item.appendChild(title);

                const desc = document.createElement('div');
                desc.className = 'evidence-list-desc';
                desc.textContent = `${evidence.type.toUpperCase()} | ${evidence.classification.toUpperCase()}`;
                item.appendChild(desc);

                item.addEventListener('click', () => {
                    if (!placed) {
                        placeEvidenceOnBoard(evidence);
                    }
                });

                list.appendChild(item);
            });

            if (discovered.length === 0) {
                list.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">No evidence discovered yet. Take actions to gather information.</div>';
            }
        }

        function renderSourcesList() {
            const list = document.getElementById('sourcesList');
            list.innerHTML = '';

            const contacted = game.sources.filter(s => s.contacted);

            contacted.forEach(source => {
                const item = document.createElement('div');
                item.className = 'source-item';

                const name = document.createElement('div');
                name.className = 'source-name';
                name.textContent = source.codename;
                item.appendChild(name);

                const role = document.createElement('div');
                role.className = 'source-role';
                role.textContent = source.role;
                item.appendChild(role);

                // Trust bar
                const trustStat = document.createElement('div');
                trustStat.className = 'source-stat';
                trustStat.innerHTML = `
                    <span>Trust:</span>
                    <div class="source-bar">
                        <div class="source-bar-fill" style="width: ${source.trust}%"></div>
                    </div>
                `;
                item.appendChild(trustStat);

                // Risk bar
                const riskStat = document.createElement('div');
                riskStat.className = 'source-stat';
                riskStat.innerHTML = `
                    <span>Risk:</span>
                    <div class="source-bar">
                        <div class="source-bar-fill risk" style="width: ${source.risk}%"></div>
                    </div>
                `;
                item.appendChild(riskStat);

                // Actions
                const actions = document.createElement('div');
                actions.className = 'source-actions';

                const meetBtn = document.createElement('button');
                meetBtn.className = 'source-btn';
                meetBtn.textContent = 'MEET';
                meetBtn.addEventListener('click', () => meetSource(source));
                actions.appendChild(meetBtn);

                const pressBtn = document.createElement('button');
                pressBtn.className = 'source-btn';
                pressBtn.textContent = 'PRESS';
                pressBtn.addEventListener('click', () => pressSource(source));
                actions.appendChild(pressBtn);

                item.appendChild(actions);
                list.appendChild(item);
            });

            if (contacted.length === 0) {
                list.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">No sources contacted yet. Take actions to find and cultivate sources.</div>';
            }
        }

        function renderActionsList() {
            const list = document.getElementById('actionsList');
            list.innerHTML = '';

            const categories = [
                {
                    title: 'INVESTIGATION',
                    actions: [
                        { name: 'FOIA Request', cost: '1 day', handler: () => performAction('foia') },
                        { name: 'Public Records Search', cost: '1 day', handler: () => performAction('records') },
                        { name: 'Financial Audit', cost: '2 days', handler: () => performAction('audit') },
                        { name: 'Surveillance Operation', cost: '2 days', handler: () => performAction('surveillance') }
                    ]
                },
                {
                    title: 'SOURCES',
                    actions: [
                        { name: 'Cultivate New Source', cost: '1 day', handler: () => performAction('newSource') },
                        { name: 'Deep Background Meeting', cost: '1 day', handler: () => performAction('deepBackground') },
                        { name: 'Verify Information', cost: '1 day', handler: () => performAction('verify') }
                    ]
                },
                {
                    title: 'SECURITY',
                    actions: [
                        { name: 'Go Off-Grid', cost: '2 days', handler: () => performAction('offGrid') },
                        { name: 'Use Dead Drop', cost: '1 day', handler: () => performAction('deadDrop') },
                        { name: 'Publish Cover Story', cost: '1 day', handler: () => performAction('coverStory') }
                    ]
                }
            ];

            categories.forEach(cat => {
                const catDiv = document.createElement('div');
                catDiv.className = 'action-category';

                const title = document.createElement('div');
                title.className = 'action-category-title';
                title.textContent = cat.title;
                catDiv.appendChild(title);

                cat.actions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.innerHTML = `${action.name} <span class="action-cost">${action.cost}</span>`;
                    btn.addEventListener('click', action.handler);
                    catDiv.appendChild(btn);
                });

                list.appendChild(catDiv);
            });
        }

        function renderStoryLog() {
            const log = document.getElementById('storyLog');
            log.innerHTML = '';

            const sorted = [...game.storyLog].reverse();

            sorted.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'story-entry';

                const day = document.createElement('div');
                day.className = 'story-day';
                day.textContent = `DAY ${entry.day}`;
                item.appendChild(day);

                const text = document.createElement('div');
                text.className = 'story-text';
                text.textContent = entry.text;
                item.appendChild(text);

                log.appendChild(item);
            });

            if (sorted.length === 0) {
                log.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">Investigation log will appear here.</div>';
            }
        }

        function placeEvidenceOnBoard(evidence) {
            const centerX = 1800 + Math.random() * 400 - 200;
            const centerY = 1200 + Math.random() * 400 - 200;

            evidenceBoard.placeEvidence(evidence, centerX, centerY);
            updateUI();
        }

        // ===============================================
        // GAME ACTIONS
        // ===============================================
        function performAction(actionType) {
            const actions = {
                foia: () => {
                    advanceTime(1);
                    if (Math.random() > 0.3) {
                        discoverEvidence(1, 2);
                        addStoryEntry('FOIA request returned documents. Some interesting leads.');
                    } else {
                        addStoryEntry('FOIA request denied or heavily redacted. Dead end.');
                    }
                },
                records: () => {
                    advanceTime(1);
                    if (Math.random() > 0.2) {
                        discoverEvidence(1, 2);
                        addStoryEntry('Public records search turned up connections.');
                    } else {
                        addStoryEntry('Public records search found nothing useful.');
                    }
                },
                audit: () => {
                    advanceTime(2);
                    if (Math.random() > 0.4) {
                        discoverEvidence(2, 3);
                        addStoryEntry('Financial audit revealed suspicious transactions.');
                        increaseHeat(5);
                    } else {
                        addStoryEntry('Financial audit came up clean. Too clean.');
                    }
                },
                surveillance: () => {
                    advanceTime(2);
                    if (Math.random() > 0.5) {
                        discoverEvidence(1, 2);
                        addStoryEntry('Surveillance operation captured evidence of secret meetings.');
                        increaseHeat(10);
                    } else {
                        addStoryEntry('Surveillance operation yielded nothing. They may be onto us.');
                        increaseHeat(15);
                    }
                },
                newSource: () => {
                    advanceTime(1);
                    const uncontacted = game.sources.filter(s => !s.contacted);
                    if (uncontacted.length > 0) {
                        const source = uncontacted[Math.floor(Math.random() * uncontacted.length)];
                        source.contacted = true;
                        addStoryEntry(`Made contact with new source: ${source.codename}, ${source.role}.`);
                    } else {
                        addStoryEntry('Failed to establish new source contacts.');
                    }
                },
                deepBackground: () => {
                    advanceTime(1);
                    const sources = game.sources.filter(s => s.contacted && s.status === 'active');
                    if (sources.length > 0) {
                        const source = sources[Math.floor(Math.random() * sources.length)];
                        source.trust = Math.min(source.trust + 10, 100);
                        discoverEvidence(1, 1);
                        addStoryEntry(`Deep background meeting with ${source.codename}. Trust increased.`);
                    }
                },
                verify: () => {
                    advanceTime(1);
                    addStoryEntry('Cross-referenced sources. Some leads check out, others don\'t.');
                },
                offGrid: () => {
                    advanceTime(2);
                    game.heat = Math.max(0, game.heat - 20);
                    addStoryEntry('Went off-grid. Heat reduced but lost time.');
                },
                deadDrop: () => {
                    advanceTime(1);
                    if (Math.random() > 0.4) {
                        discoverEvidence(1, 1);
                        addStoryEntry('Dead drop successful. Received new intel.');
                    } else {
                        addStoryEntry('Dead drop was compromised. Nothing recovered.');
                        increaseHeat(10);
                    }
                },
                coverStory: () => {
                    advanceTime(1);
                    game.heat = Math.max(0, game.heat - 10);
                    addStoryEntry('Published cover story to throw them off the scent.');
                }
            };

            if (actions[actionType]) {
                actions[actionType]();
                updateUI();
                checkGameState();
            }
        }

        function meetSource(source) {
            if (source.trust < 40) {
                showModal('LOW TRUST', `${source.codename} is not ready to share information yet. Build more trust first.`, [
                    { text: 'OK', handler: closeModal }
                ]);
                return;
            }

            source.meetingCount++;
            source.lastContact = game.day;

            if (Math.random() * 100 < source.trust) {
                discoverEvidence(1, 2);
                source.trust = Math.min(source.trust + 5, 100);
                addStoryEntry(`${source.codename} provided valuable intel.`);
            } else {
                addStoryEntry(`${source.codename} had nothing new this time.`);
            }

            updateUI();
        }

        function pressSource(source) {
            const risk = Math.random() * 100;

            if (risk < source.risk) {
                source.status = 'scared';
                source.trust = Math.max(0, source.trust - 30);
                addStoryEntry(`Pushed ${source.codename} too hard. They've gone dark.`);
            } else {
                discoverEvidence(2, 3);
                source.trust = Math.max(0, source.trust - 10);
                source.risk = Math.min(100, source.risk + 20);
                addStoryEntry(`${source.codename} reluctantly provided critical information.`);
                increaseHeat(5);
            }

            updateUI();
        }

        function discoverEvidence(min, max) {
            const undiscovered = game.evidence.filter(e => !e.discovered);
            if (undiscovered.length === 0) return;

            const count = Math.floor(Math.random() * (max - min + 1)) + min;
            for (let i = 0; i < count && undiscovered.length > 0; i++) {
                const idx = Math.floor(Math.random() * undiscovered.length);
                undiscovered[idx].discovered = true;
                undiscovered.splice(idx, 1);
            }
        }

        function increaseHeat(amount) {
            game.heat = Math.min(100, game.heat + amount);

            if (game.heat >= 80) {
                addStoryEntry(' DANGER: They know you\'re getting close. Consider going off-grid.');
            } else if (game.heat >= 60) {
                addStoryEntry(' WARNING: Heat level critical. You\'re being watched.');
            }
        }

        function advanceTime(days) {
            game.day += days;

            // Random events
            if (Math.random() > 0.7) {
                randomEvent();
            }

            // Heat decay over time
            game.heat = Math.max(0, game.heat - 2);
        }

        function randomEvent() {
            const events = [
                () => {
                    discoverEvidence(1, 1);
                    addStoryEntry(' Anonymous tip arrived with new evidence.');
                },
                () => {
                    const source = game.sources.find(s => s.contacted && s.status === 'active');
                    if (source) {
                        addStoryEntry(` ${source.codename} reached out with urgent information.`);
                        discoverEvidence(1, 2);
                    }
                },
                () => {
                    addStoryEntry(' Unusual activity detected. Someone is watching your movements.');
                    increaseHeat(10);
                },
                () => {
                    addStoryEntry(' Related story published by another journalist. Some leads confirmed.');
                },
                () => {
                    const source = game.sources.find(s => s.contacted && s.status === 'active' && s.risk > 70);
                    if (source) {
                        source.status = 'disappeared';
                        addStoryEntry(` ${source.codename} has disappeared. Last known contact: 2 days ago.`);
                        increaseHeat(20);
                    }
                }
            ];

            const event = events[Math.floor(Math.random() * events.length)];
            event();
        }

        function addStoryEntry(text) {
            game.storyLog.push({
                day: game.day,
                text: text
            });
        }

        function checkGameState() {
            // Win condition: discovered deep evidence and low heat
            const deepEvidence = game.evidence.filter(e => e.discovered && e.layer >= 4).length;

            if (game.day >= 60) {
                endGame('timeout');
            } else if (game.heat >= 100) {
                endGame('exposed');
            } else if (deepEvidence >= 5 && game.placedEvidence.length >= 15 && game.connections.length >= 10) {
                // Player has enough to publish major story
                document.getElementById('publishBtn').style.background = '#4CAF50';
                document.getElementById('publishBtn').style.borderColor = '#4CAF50';
            }
        }

        function publishArticle() {
            const deepEvidence = game.evidence.filter(e => e.discovered && e.layer >= 4).length;

            if (game.placedEvidence.length < 10) {
                showModal('INSUFFICIENT EVIDENCE', 'You need at least 10 pieces of evidence on the board before publishing.', [
                    { text: 'OK', handler: closeModal }
                ]);
                return;
            }

            if (game.connections.length < 5) {
                showModal('INCOMPLETE STORY', 'You need to establish more connections between evidence pieces to tell a coherent story.', [
                    { text: 'OK', handler: closeModal }
                ]);
                return;
            }

            // Determine story quality
            let ending = 'partial';
            if (deepEvidence >= 5 && game.connections.length >= 15 && game.heat < 50) {
                ending = 'pulitzer';
            } else if (deepEvidence >= 3) {
                ending = 'partial';
            } else {
                ending = 'weak';
            }

            endGame(ending);
        }

        function endGame(type) {
            const endings = {
                pulitzer: {
                    title: 'PULITZER PRIZE',
                    text: 'Your investigation exposed the entire conspiracy from top to bottom. The evidence was irrefutable, the connections undeniable. Indictments are being issued. Congressional hearings are scheduled. You\'ve done what few journalists ever achieve: brought down the deep state.\n\nYour sources are safe. Your evidence is bulletproof. The truth prevailed.'
                },
                partial: {
                    title: 'PARTIAL EXPOSURE',
                    text: 'You managed to bring down some of the conspiracy, but the inner circle remains protected. Several mid-level players have been arrested, shell companies shut down, but the masterminds escaped justice.\n\nStill, you got closer than anyone before you. The investigation continues.'
                },
                weak: {
                    title: 'DEAD END',
                    text: 'Your story ran, but without deep evidence connecting to the top, it was dismissed as speculation. The public moved on. Sources went dark. The conspiracy lives on, and they\'re more careful now.\n\nMaybe next time you\'ll dig deeper before publishing.'
                },
                exposed: {
                    title: 'SILENCED',
                    text: 'You got too close without protecting yourself. They found you before you could publish. Your evidence disappeared. Your sources were compromised.\n\nSometimes the truth is too dangerous to expose.'
                },
                timeout: {
                    title: 'TIME RAN OUT',
                    text: 'Day 60. Your investigation stalled. Sources went cold. The trail ran dry. Without fresh leads and concrete evidence, you couldn\'t build the case.\n\nThe conspiracy continues in the shadows.'
                }
            };

            const ending = endings[type];

            showModal(ending.title, ending.text, [
                { text: 'NEW INVESTIGATION', handler: () => { closeModal(); newGame(); } },
                { text: 'CLOSE', handler: closeModal }
            ]);
        }

        // ===============================================
        // BOARD INTERACTION
        // ===============================================
        function initBoardInteraction() {
            const container = document.getElementById('boardContainer');
            const board = document.getElementById('evidenceBoard');

            // Pan the board
            container.addEventListener('mousedown', (e) => {
                if (e.target === container || e.target === board || e.target.id === 'stringCanvas') {
                    game.isPanning = true;
                    game.panStart = { x: e.clientX - game.boardOffset.x, y: e.clientY - game.boardOffset.y };
                    container.classList.add('grabbing');
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (game.isPanning) {
                    game.boardOffset.x = e.clientX - game.panStart.x;
                    game.boardOffset.y = e.clientY - game.panStart.y;

                    board.style.transform = `translate(${game.boardOffset.x}px, ${game.boardOffset.y}px) scale(${game.boardScale})`;
                    evidenceBoard.redrawStrings();
                }
            });

            document.addEventListener('mouseup', () => {
                game.isPanning = false;
                container.classList.remove('grabbing');
            });

            // Zoom
            container.addEventListener('wheel', (e) => {
                e.preventDefault();

                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                game.boardScale = Math.max(0.3, Math.min(2, game.boardScale * delta));

                board.style.transform = `translate(${game.boardOffset.x}px, ${game.boardOffset.y}px) scale(${game.boardScale})`;
                evidenceBoard.redrawStrings();
            });
        }

        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';

            document.addEventListener('click', hideContextMenu);
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            document.removeEventListener('click', hideContextMenu);
        }

        document.getElementById('contextMenu').addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (!action || !game.selectedEvidence) return;

            if (action === 'connect') {
                if (!game.connectingFrom) {
                    game.connectingFrom = game.selectedEvidence.dataset.evidenceId;
                    addStoryEntry('Select another piece of evidence to connect.');
                } else {
                    const to = game.selectedEvidence.dataset.evidenceId;
                    if (game.connectingFrom !== to) {
                        evidenceBoard.drawString(game.connectingFrom, to);
                        addStoryEntry('Connection drawn between evidence pieces.');
                    }
                    game.connectingFrom = null;
                }
            } else if (action === 'examine') {
                const evidenceId = game.selectedEvidence.dataset.evidenceId;
                const evidence = game.evidence.find(e => e.id === evidenceId);
                if (evidence) {
                    showModal(evidence.title, evidence.content, [
                        { text: 'CLOSE', handler: closeModal }
                    ]);
                }
            } else if (action === 'remove') {
                const evidenceId = game.selectedEvidence.dataset.evidenceId;
                const idx = game.placedEvidence.findIndex(p => p.evidenceId === evidenceId);
                if (idx !== -1) {
                    game.placedEvidence[idx].element.remove();
                    game.placedEvidence.splice(idx, 1);

                    // Remove connections
                    game.connections = game.connections.filter(c => c.from !== evidenceId && c.to !== evidenceId);
                    evidenceBoard.redrawStrings();
                    updateUI();
                }
            }

            hideContextMenu();
        });

        // ===============================================
        // MODAL SYSTEM
        // ===============================================
        function showModal(title, text, buttons) {
            const modal = document.getElementById('modal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = `<div class="modal-text">${text}</div>`;

            const btnContainer = document.getElementById('modalButtons');
            btnContainer.innerHTML = '';

            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'modal-btn';
                if (btn.primary) button.classList.add('primary');
                button.textContent = btn.text;
                button.addEventListener('click', btn.handler);
                btnContainer.appendChild(button);
            });

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // ===============================================
        // SAVE/LOAD
        // ===============================================
        function saveGame() {
            const saveData = {
                day: game.day,
                heat: game.heat,
                conspiracy: game.conspiracy,
                evidence: game.evidence,
                placedEvidence: game.placedEvidence.map(p => ({
                    evidenceId: p.evidenceId,
                    x: p.x,
                    y: p.y
                })),
                sources: game.sources,
                connections: game.connections,
                storyLog: game.storyLog,
                boardOffset: game.boardOffset,
                boardScale: game.boardScale
            };

            localStorage.setItem('deepstate_save', JSON.stringify(saveData));
            addStoryEntry(' Investigation saved.');
            updateUI();
        }

        function loadGame() {
            const saved = localStorage.getItem('deepstate_save');
            if (!saved) return false;

            try {
                const data = JSON.parse(saved);
                game.day = data.day;
                game.heat = data.heat;
                game.conspiracy = data.conspiracy;
                game.evidence = data.evidence;
                game.sources = data.sources;
                game.connections = data.connections;
                game.storyLog = data.storyLog;
                game.boardOffset = data.boardOffset || { x: 0, y: 0 };
                game.boardScale = data.boardScale || 1;

                // Restore placed evidence
                game.placedEvidence = [];
                data.placedEvidence.forEach(p => {
                    const evidence = game.evidence.find(e => e.id === p.evidenceId);
                    if (evidence) {
                        evidenceBoard.placeEvidence(evidence, p.x, p.y);
                    }
                });

                // Restore board transform
                const board = document.getElementById('evidenceBoard');
                board.style.transform = `translate(${game.boardOffset.x}px, ${game.boardOffset.y}px) scale(${game.boardScale})`;

                evidenceBoard.redrawStrings();
                updateUI();

                return true;
            } catch (e) {
                console.error('Failed to load game:', e);
                return false;
            }
        }

        function newGame() {
            // Generate new conspiracy
            const generator = new ConspiracyGenerator();
            game.conspiracy = generator.generate();
            game.evidence = game.conspiracy.evidence;

            // Generate sources
            const sourceGen = new SourceGenerator();
            game.sources = sourceGen.generate();

            // Reset game state
            game.day = 1;
            game.heat = 0;
            game.placedEvidence = [];
            game.connections = [];
            game.storyLog = [];
            game.boardOffset = { x: 0, y: 0 };
            game.boardScale = 1;

            // Clear board
            document.getElementById('evidenceBoard').innerHTML = '';
            const board = document.getElementById('evidenceBoard');
            board.style.transform = 'translate(0, 0) scale(1)';

            // Initial story entry
            addStoryEntry('Investigation begins. A mysterious source has contacted you with explosive allegations.');

            updateUI();
            evidenceBoard.redrawStrings();
        }

        // ===============================================
        // PANEL TABS
        // ===============================================
        document.querySelectorAll('.panel-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                const panelId = tab.dataset.tab + 'Panel';
                document.getElementById(panelId).classList.add('active');
            });
        });

        // ===============================================
        // TOOLBAR BUTTONS
        // ===============================================
        document.getElementById('clearStringsBtn').addEventListener('click', () => {
            evidenceBoard.clearStrings();
            addStoryEntry('Cleared all connection strings from board.');
            updateUI();
        });

        document.getElementById('publishBtn').addEventListener('click', publishArticle);

        document.getElementById('advanceDayBtn').addEventListener('click', () => {
            advanceTime(1);
            addStoryEntry('Day passes. Investigation continues.');
            updateUI();
            checkGameState();
        });

        document.getElementById('saveGameBtn').addEventListener('click', saveGame);

        document.getElementById('newGameBtn').addEventListener('click', () => {
            showModal('NEW INVESTIGATION', 'Start a new investigation? Current progress will be saved but you will generate a fresh conspiracy.', [
                { text: 'YES', handler: () => { closeModal(); saveGame(); newGame(); }, primary: true },
                { text: 'CANCEL', handler: closeModal }
            ]);
        });

        // ===============================================
        // INTRO SCREEN
        // ===============================================
        document.getElementById('startGameBtn').addEventListener('click', () => {
            document.getElementById('introScreen').style.display = 'none';

            // Try to load saved game
            if (!loadGame()) {
                newGame();
            }
        });

        // ===============================================
        // INITIALIZATION
        // ===============================================
        let evidenceBoard;

        window.addEventListener('load', () => {
            evidenceBoard = new EvidenceBoard();
            initBoardInteraction();
        });
    </script>
</body>
</html>