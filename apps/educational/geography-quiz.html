<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>World Atlas Challenge</title>
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="educational_tools">
<meta name="rappterzoo:tags" content="geography,quiz,canvas,education,game,audio">
<meta name="rappterzoo:type" content="game">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="2">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0d12;color:#e0e0e0;font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden;width:100vw;height:100vh}
canvas{display:block;cursor:crosshair}

.overlay{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:100;pointer-events:none}
.overlay.active{pointer-events:all}
.panel{background:rgba(10,13,18,0.95);border:2px solid #00d2d3;border-radius:16px;padding:40px;max-width:600px;width:90%;text-align:center;transform:scale(0.9);opacity:0;transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 20px 60px rgba(0,210,211,0.15)}
.overlay.active .panel{transform:scale(1);opacity:1}
.panel h1{font-size:2.5rem;color:#00d2d3;margin-bottom:8px;text-shadow:0 0 30px rgba(0,210,211,0.3)}
.panel h2{font-size:1.5rem;color:#e0e0e0;margin-bottom:20px}
.panel p{color:#888;margin-bottom:12px;line-height:1.6}
.panel .subtitle{font-size:1rem;color:#aaa;margin-bottom:24px}

.btn{display:inline-block;background:linear-gradient(135deg,#00d2d3,#0891b2);color:#0a0d12;border:none;padding:12px 28px;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:700;transition:all 0.2s;margin:6px;text-transform:uppercase;letter-spacing:1px}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,210,211,0.3)}
.btn.secondary{background:linear-gradient(135deg,#1e2329,#2a2f35);color:#00d2d3;border:1px solid #00d2d3}
.btn.danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:white}

.mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:20px 0}
.mode-card{background:#161a1e;border:2px solid #2a2f35;border-radius:12px;padding:20px;cursor:pointer;transition:all 0.3s;text-align:left}
.mode-card:hover{border-color:#00d2d3;transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,210,211,0.15)}
.mode-card.selected{border-color:#00d2d3;background:#00d2d310}
.mode-card h3{color:#00d2d3;font-size:1rem;margin-bottom:4px}
.mode-card p{color:#888;font-size:0.8rem;margin:0}
.mode-card .icon{font-size:2rem;margin-bottom:8px}

.difficulty-row{display:flex;gap:8px;justify-content:center;margin:16px 0}
.diff-btn{background:#161a1e;border:2px solid #2a2f35;color:#aaa;padding:8px 20px;border-radius:8px;cursor:pointer;font-size:0.85rem;transition:all 0.2s}
.diff-btn:hover{border-color:#00d2d3;color:#00d2d3}
.diff-btn.active{background:#00d2d320;border-color:#00d2d3;color:#00d2d3;font-weight:700}

.stats-row{display:flex;gap:16px;justify-content:center;margin:16px 0;flex-wrap:wrap}
.stat{background:#161a1e;border:1px solid #2a2f35;border-radius:8px;padding:12px 20px;text-align:center;min-width:80px}
.stat .num{font-size:1.8rem;color:#00d2d3;font-weight:700}
.stat .label{font-size:0.7rem;color:#888;margin-top:2px}

.hud{position:fixed;top:0;left:0;right:0;padding:8px 16px;display:flex;align-items:center;gap:16px;z-index:50;background:linear-gradient(to bottom,rgba(10,13,18,0.9),transparent);pointer-events:none}
.hud *{pointer-events:all}
.hud-left{display:flex;align-items:center;gap:12px}
.hud-center{flex:1;text-align:center}
.hud-right{display:flex;align-items:center;gap:12px}
.hud .score-display{font-size:1.2rem;color:#00d2d3;font-weight:700}
.hud .streak{font-size:0.85rem;color:#fbbf24;font-weight:600}
.hud .timer{font-size:1.1rem;color:#ef4444;font-weight:600}
.hud .combo{font-size:1rem;color:#a855f7;font-weight:700;text-shadow:0 0 10px rgba(168,85,247,0.5)}
.hud .question-text{font-size:1.1rem;color:#e0e0e0;text-shadow:0 2px 4px rgba(0,0,0,0.5)}
.hud .round-display{font-size:0.85rem;color:#888}
.hud .pause-btn{background:#1e2329;border:1px solid #2a2f35;color:#aaa;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:0.8rem}
.hud .pause-btn:hover{border-color:#00d2d3;color:#00d2d3}

.options-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:50;flex-wrap:wrap;justify-content:center;max-width:90%}
.option-btn{background:rgba(22,26,30,0.95);border:2px solid #2a2f35;color:#e0e0e0;padding:12px 24px;border-radius:10px;cursor:pointer;font-size:1rem;transition:all 0.2s;min-width:150px;text-align:center;backdrop-filter:blur(8px)}
.option-btn:hover{border-color:#00d2d3;background:rgba(0,210,211,0.1);transform:translateY(-2px)}
.option-btn.correct{border-color:#22c55e;background:rgba(34,197,94,0.2);color:#22c55e;animation:pulse-correct 0.5s}
.option-btn.wrong{border-color:#ef4444;background:rgba(239,68,68,0.2);color:#ef4444;animation:shake-wrong 0.4s}
.option-btn.disabled{pointer-events:none;opacity:0.5}

.feedback-toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);z-index:200;font-size:3rem;font-weight:900;text-shadow:0 0 40px currentColor;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);pointer-events:none}
.feedback-toast.show{transform:translate(-50%,-50%) scale(1)}
.feedback-toast.correct{color:#22c55e}
.feedback-toast.wrong{color:#ef4444}

.leaderboard{max-height:300px;overflow-y:auto;margin:16px 0}
.lb-row{display:flex;align-items:center;gap:12px;padding:8px 12px;border-bottom:1px solid #2a2f35}
.lb-row:nth-child(1) .lb-rank{color:#fbbf24}
.lb-row:nth-child(2) .lb-rank{color:#94a3b8}
.lb-row:nth-child(3) .lb-rank{color:#cd7f32}
.lb-rank{font-size:1.2rem;font-weight:700;width:30px;text-align:center}
.lb-name{flex:1;color:#e0e0e0}
.lb-score{color:#00d2d3;font-weight:600}
.lb-mode{color:#888;font-size:0.75rem}

.continent-bar{position:fixed;top:50px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:45;flex-wrap:wrap;justify-content:center}
.cont-btn{background:rgba(22,26,30,0.9);border:1px solid #2a2f35;color:#aaa;padding:4px 12px;border-radius:6px;cursor:pointer;font-size:0.75rem;transition:all 0.2s;backdrop-filter:blur(4px)}
.cont-btn:hover{border-color:#00d2d3;color:#00d2d3}
.cont-btn.active{background:rgba(0,210,211,0.2);border-color:#00d2d3;color:#00d2d3}

@keyframes pulse-correct{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes shake-wrong{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}50%{transform:translateX(8px)}75%{transform:translateX(-4px)}}
</style>
</head>
<body>
<canvas id="c"></canvas>

<div class="hud" id="hud" style="display:none">
  <div class="hud-left">
    <div class="score-display" id="hudScore">0</div>
    <div class="streak" id="hudStreak"></div>
    <div class="combo" id="hudCombo"></div>
  </div>
  <div class="hud-center">
    <div class="question-text" id="hudQuestion"></div>
    <div class="round-display" id="hudRound"></div>
  </div>
  <div class="hud-right">
    <div class="timer" id="hudTimer"></div>
    <button class="pause-btn" id="pauseBtn" onclick="togglePause()">ESC Pause</button>
  </div>
</div>

<div class="continent-bar" id="contBar" style="display:none"></div>
<div class="options-bar" id="optionsBar" style="display:none"></div>
<div class="feedback-toast" id="feedbackToast"></div>

<div class="overlay active" id="titleScreen">
  <div class="panel">
    <h1>World Atlas Challenge</h1>
    <p class="subtitle">Test your geography knowledge across 160 countries</p>
    <div class="mode-grid" id="modeGrid">
      <div class="mode-card selected" data-mode="capitals" onclick="selectMode(this)">
        <div class="icon">&#127963;</div>
        <h3>Capital Cities</h3>
        <p>Name the capital of each country</p>
      </div>
      <div class="mode-card" data-mode="population" onclick="selectMode(this)">
        <div class="icon">&#127758;</div>
        <h3>Population</h3>
        <p>Guess which country has the given stats</p>
      </div>
      <div class="mode-card" data-mode="locate" onclick="selectMode(this)">
        <div class="icon">&#128205;</div>
        <h3>Pin the Map</h3>
        <p>Click where each country is located</p>
      </div>
      <div class="mode-card" data-mode="challenge" onclick="selectMode(this)">
        <div class="icon">&#9876;</div>
        <h3>World Challenge</h3>
        <p>Mixed questions, timed, boss continents</p>
      </div>
    </div>
    <div class="difficulty-row">
      <button class="diff-btn" data-diff="easy" onclick="selectDiff(this)">Easy</button>
      <button class="diff-btn active" data-diff="normal" onclick="selectDiff(this)">Normal</button>
      <button class="diff-btn" data-diff="hard" onclick="selectDiff(this)">Hard</button>
    </div>
    <div>
      <button class="btn" onclick="startGame()">START GAME</button>
      <button class="btn secondary" onclick="showLeaderboard()">HIGH SCORES</button>
    </div>
    <p style="margin-top:16px;font-size:0.75rem;color:#555">R: Quick restart | ESC: Pause | 1-5: Quick answer</p>
  </div>
</div>

<div class="overlay" id="pauseScreen">
  <div class="panel">
    <h2>PAUSED</h2>
    <div class="stats-row">
      <div class="stat"><div class="num" id="pauseScore">0</div><div class="label">Score</div></div>
      <div class="stat"><div class="num" id="pauseStreak">0</div><div class="label">Best Streak</div></div>
      <div class="stat"><div class="num" id="pauseCorrect">0</div><div class="label">Correct</div></div>
    </div>
    <button class="btn" onclick="togglePause()">RESUME</button>
    <button class="btn secondary" onclick="quitToTitle()">QUIT</button>
  </div>
</div>

<div class="overlay" id="gameOverScreen">
  <div class="panel">
    <h2 id="goTitle">GAME OVER</h2>
    <div class="stats-row" id="goStats"></div>
    <div id="goGrade" style="font-size:4rem;font-weight:900;margin:12px 0"></div>
    <div id="goMessage" style="color:#aaa;margin-bottom:16px"></div>
    <button class="btn" onclick="startGame()">PLAY AGAIN</button>
    <button class="btn secondary" onclick="quitToTitle()">MAIN MENU</button>
  </div>
</div>

<div class="overlay" id="lbScreen">
  <div class="panel">
    <h2>HIGH SCORES</h2>
    <div class="leaderboard" id="lbList"></div>
    <button class="btn secondary" onclick="showTitle()">BACK</button>
  </div>
</div>

<script>
// ===== AUDIO ENGINE =====
class AudioEngine {
  constructor() { this.ctx = null; this.vol = null; }
  init() {
    if (this.ctx) return;
    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    this.vol = this.ctx.createGain();
    this.vol.gain.value = 0.3;
    this.vol.connect(this.ctx.destination);
  }
  play(type, freq, dur, vol) {
    if (!this.ctx) return;
    const o = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = vol || 0.2;
    g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
    o.connect(g); g.connect(this.vol);
    o.start(); o.stop(this.ctx.currentTime + dur);
  }
  correct() {
    this.play('sine', 523, 0.1, 0.25);
    setTimeout(() => this.play('sine', 659, 0.1, 0.25), 80);
    setTimeout(() => this.play('sine', 784, 0.15, 0.3), 160);
  }
  wrong() {
    this.play('square', 200, 0.15, 0.15);
    setTimeout(() => this.play('square', 150, 0.25, 0.15), 120);
  }
  combo(mult) {
    const base = 400 + mult * 50;
    this.play('sine', base, 0.08, 0.2);
    setTimeout(() => this.play('sine', base * 1.25, 0.08, 0.2), 60);
    setTimeout(() => this.play('sine', base * 1.5, 0.12, 0.25), 120);
  }
  tick() { this.play('sine', 1000, 0.03, 0.1); }
  boss() {
    for (let i = 0; i < 4; i++) {
      setTimeout(() => this.play('sawtooth', 100 + i * 30, 0.2, 0.15), i * 150);
    }
  }
  levelUp() {
    [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => this.play('sine', f, 0.15, 0.2), i * 100));
  }
  gameOver() {
    [400, 350, 300, 250].forEach((f, i) => setTimeout(() => this.play('triangle', f, 0.3, 0.2), i * 200));
  }
  menuSelect() { this.play('sine', 800, 0.05, 0.15); }
  timeWarning() { this.play('square', 600, 0.1, 0.2); }
}
const audio = new AudioEngine();

// ===== COUNTRY DATABASE =====
const COUNTRIES = [
  {n:"France",cap:"Paris",cont:"Europe",lat:46.6,lon:2.2,pop:67,area:643},
  {n:"Germany",cap:"Berlin",cont:"Europe",lat:51.2,lon:10.4,pop:83,area:357},
  {n:"Italy",cap:"Rome",cont:"Europe",lat:41.9,lon:12.6,pop:60,area:301},
  {n:"Spain",cap:"Madrid",cont:"Europe",lat:40.5,lon:-3.7,pop:47,area:506},
  {n:"United Kingdom",cap:"London",cont:"Europe",lat:55.4,lon:-3.4,pop:67,area:244},
  {n:"Portugal",cap:"Lisbon",cont:"Europe",lat:39.4,lon:-8.2,pop:10,area:92},
  {n:"Netherlands",cap:"Amsterdam",cont:"Europe",lat:52.1,lon:5.3,pop:17,area:42},
  {n:"Belgium",cap:"Brussels",cont:"Europe",lat:50.5,lon:4.5,pop:12,area:31},
  {n:"Switzerland",cap:"Bern",cont:"Europe",lat:46.8,lon:8.2,pop:9,area:41},
  {n:"Austria",cap:"Vienna",cont:"Europe",lat:47.5,lon:14.6,pop:9,area:84},
  {n:"Poland",cap:"Warsaw",cont:"Europe",lat:51.9,lon:19.1,pop:38,area:313},
  {n:"Sweden",cap:"Stockholm",cont:"Europe",lat:60.1,lon:18.6,pop:10,area:450},
  {n:"Norway",cap:"Oslo",cont:"Europe",lat:60.5,lon:8.5,pop:5,area:385},
  {n:"Denmark",cap:"Copenhagen",cont:"Europe",lat:56.3,lon:9.5,pop:6,area:43},
  {n:"Finland",cap:"Helsinki",cont:"Europe",lat:61.9,lon:25.7,pop:6,area:338},
  {n:"Greece",cap:"Athens",cont:"Europe",lat:39.1,lon:21.8,pop:11,area:132},
  {n:"Czech Republic",cap:"Prague",cont:"Europe",lat:49.8,lon:15.5,pop:11,area:79},
  {n:"Romania",cap:"Bucharest",cont:"Europe",lat:45.9,lon:25.0,pop:19,area:238},
  {n:"Ireland",cap:"Dublin",cont:"Europe",lat:53.4,lon:-8.2,pop:5,area:70},
  {n:"Hungary",cap:"Budapest",cont:"Europe",lat:47.2,lon:19.5,pop:10,area:93},
  {n:"Croatia",cap:"Zagreb",cont:"Europe",lat:45.1,lon:15.2,pop:4,area:57},
  {n:"Serbia",cap:"Belgrade",cont:"Europe",lat:44.0,lon:21.0,pop:7,area:88},
  {n:"Bulgaria",cap:"Sofia",cont:"Europe",lat:42.7,lon:25.5,pop:7,area:111},
  {n:"Slovakia",cap:"Bratislava",cont:"Europe",lat:48.7,lon:19.7,pop:5,area:49},
  {n:"Lithuania",cap:"Vilnius",cont:"Europe",lat:55.2,lon:23.9,pop:3,area:65},
  {n:"Latvia",cap:"Riga",cont:"Europe",lat:56.9,lon:24.1,pop:2,area:65},
  {n:"Estonia",cap:"Tallinn",cont:"Europe",lat:58.6,lon:25.0,pop:1,area:45},
  {n:"Slovenia",cap:"Ljubljana",cont:"Europe",lat:46.2,lon:14.8,pop:2,area:20},
  {n:"Iceland",cap:"Reykjavik",cont:"Europe",lat:64.9,lon:-19.0,pop:0.4,area:103},
  {n:"Albania",cap:"Tirana",cont:"Europe",lat:41.2,lon:20.2,pop:3,area:29},
  {n:"North Macedonia",cap:"Skopje",cont:"Europe",lat:41.5,lon:21.7,pop:2,area:26},
  {n:"Montenegro",cap:"Podgorica",cont:"Europe",lat:42.7,lon:19.4,pop:0.6,area:14},
  {n:"Luxembourg",cap:"Luxembourg City",cont:"Europe",lat:49.8,lon:6.1,pop:0.6,area:3},
  {n:"Moldova",cap:"Chisinau",cont:"Europe",lat:47.0,lon:28.9,pop:3,area:34},
  {n:"Ukraine",cap:"Kyiv",cont:"Europe",lat:48.4,lon:31.2,pop:44,area:604},
  {n:"Belarus",cap:"Minsk",cont:"Europe",lat:53.7,lon:27.9,pop:9,area:208},
  {n:"Bosnia and Herzegovina",cap:"Sarajevo",cont:"Europe",lat:43.9,lon:17.7,pop:3,area:51},
  {n:"Japan",cap:"Tokyo",cont:"Asia",lat:36.2,lon:138.3,pop:126,area:378},
  {n:"China",cap:"Beijing",cont:"Asia",lat:35.9,lon:104.2,pop:1400,area:9597},
  {n:"India",cap:"New Delhi",cont:"Asia",lat:20.6,lon:79.0,pop:1380,area:3287},
  {n:"South Korea",cap:"Seoul",cont:"Asia",lat:35.9,lon:128.0,pop:52,area:100},
  {n:"Thailand",cap:"Bangkok",cont:"Asia",lat:15.9,lon:100.9,pop:70,area:513},
  {n:"Vietnam",cap:"Hanoi",cont:"Asia",lat:14.1,lon:108.3,pop:97,area:331},
  {n:"Indonesia",cap:"Jakarta",cont:"Asia",lat:-0.8,lon:113.9,pop:274,area:1905},
  {n:"Philippines",cap:"Manila",cont:"Asia",lat:12.9,lon:121.8,pop:110,area:300},
  {n:"Malaysia",cap:"Kuala Lumpur",cont:"Asia",lat:4.2,lon:101.9,pop:32,area:330},
  {n:"Turkey",cap:"Ankara",cont:"Asia",lat:38.9,lon:35.2,pop:84,area:784},
  {n:"Saudi Arabia",cap:"Riyadh",cont:"Asia",lat:23.9,lon:45.1,pop:35,area:2150},
  {n:"Israel",cap:"Jerusalem",cont:"Asia",lat:31.0,lon:34.9,pop:9,area:22},
  {n:"Pakistan",cap:"Islamabad",cont:"Asia",lat:30.4,lon:69.3,pop:221,area:882},
  {n:"Bangladesh",cap:"Dhaka",cont:"Asia",lat:23.7,lon:90.4,pop:165,area:148},
  {n:"Singapore",cap:"Singapore",cont:"Asia",lat:1.4,lon:103.8,pop:6,area:0.7},
  {n:"Myanmar",cap:"Naypyidaw",cont:"Asia",lat:19.8,lon:96.1,pop:54,area:677},
  {n:"Nepal",cap:"Kathmandu",cont:"Asia",lat:28.4,lon:84.1,pop:29,area:147},
  {n:"Sri Lanka",cap:"Sri Jayawardenepura Kotte",cont:"Asia",lat:7.9,lon:80.8,pop:22,area:66},
  {n:"Cambodia",cap:"Phnom Penh",cont:"Asia",lat:12.6,lon:105.0,pop:17,area:181},
  {n:"Mongolia",cap:"Ulaanbaatar",cont:"Asia",lat:46.9,lon:103.8,pop:3,area:1564},
  {n:"Jordan",cap:"Amman",cont:"Asia",lat:30.6,lon:36.2,pop:10,area:89},
  {n:"Lebanon",cap:"Beirut",cont:"Asia",lat:33.9,lon:35.9,pop:7,area:10},
  {n:"Iraq",cap:"Baghdad",cont:"Asia",lat:33.2,lon:43.7,pop:40,area:438},
  {n:"Iran",cap:"Tehran",cont:"Asia",lat:32.4,lon:53.7,pop:84,area:1649},
  {n:"Afghanistan",cap:"Kabul",cont:"Asia",lat:33.9,lon:67.7,pop:39,area:652},
  {n:"Uzbekistan",cap:"Tashkent",cont:"Asia",lat:41.4,lon:64.6,pop:34,area:449},
  {n:"Kazakhstan",cap:"Astana",cont:"Asia",lat:48.0,lon:68.0,pop:19,area:2725},
  {n:"Taiwan",cap:"Taipei",cont:"Asia",lat:23.7,lon:121.0,pop:24,area:36},
  {n:"Egypt",cap:"Cairo",cont:"Africa",lat:26.8,lon:30.8,pop:102,area:1002},
  {n:"South Africa",cap:"Pretoria",cont:"Africa",lat:-30.6,lon:22.9,pop:60,area:1219},
  {n:"Nigeria",cap:"Abuja",cont:"Africa",lat:9.1,lon:8.7,pop:206,area:924},
  {n:"Kenya",cap:"Nairobi",cont:"Africa",lat:-0.0,lon:37.9,pop:54,area:580},
  {n:"Morocco",cap:"Rabat",cont:"Africa",lat:31.8,lon:-7.1,pop:37,area:447},
  {n:"Ethiopia",cap:"Addis Ababa",cont:"Africa",lat:9.1,lon:40.5,pop:115,area:1104},
  {n:"Ghana",cap:"Accra",cont:"Africa",lat:7.9,lon:-1.0,pop:31,area:239},
  {n:"Tanzania",cap:"Dodoma",cont:"Africa",lat:-6.4,lon:34.9,pop:60,area:947},
  {n:"Algeria",cap:"Algiers",cont:"Africa",lat:28.0,lon:1.7,pop:44,area:2382},
  {n:"Tunisia",cap:"Tunis",cont:"Africa",lat:33.9,lon:9.5,pop:12,area:164},
  {n:"Libya",cap:"Tripoli",cont:"Africa",lat:26.3,lon:17.2,pop:7,area:1760},
  {n:"Sudan",cap:"Khartoum",cont:"Africa",lat:12.9,lon:30.2,pop:44,area:1861},
  {n:"DR Congo",cap:"Kinshasa",cont:"Africa",lat:-4.0,lon:21.8,pop:90,area:2345},
  {n:"Cameroon",cap:"Yaounde",cont:"Africa",lat:7.4,lon:12.4,pop:27,area:475},
  {n:"Senegal",cap:"Dakar",cont:"Africa",lat:14.5,lon:-14.5,pop:17,area:197},
  {n:"Uganda",cap:"Kampala",cont:"Africa",lat:1.4,lon:32.3,pop:46,area:241},
  {n:"Mozambique",cap:"Maputo",cont:"Africa",lat:-18.7,lon:35.5,pop:31,area:802},
  {n:"Madagascar",cap:"Antananarivo",cont:"Africa",lat:-18.8,lon:46.9,pop:28,area:587},
  {n:"Zimbabwe",cap:"Harare",cont:"Africa",lat:-19.0,lon:29.2,pop:15,area:391},
  {n:"Rwanda",cap:"Kigali",cont:"Africa",lat:-1.9,lon:29.9,pop:13,area:26},
  {n:"Botswana",cap:"Gaborone",cont:"Africa",lat:-22.3,lon:24.7,pop:2,area:582},
  {n:"Angola",cap:"Luanda",cont:"Africa",lat:-11.2,lon:17.9,pop:33,area:1247},
  {n:"Mali",cap:"Bamako",cont:"Africa",lat:17.6,lon:-4.0,pop:20,area:1240},
  {n:"Niger",cap:"Niamey",cont:"Africa",lat:17.6,lon:8.1,pop:24,area:1267},
  {n:"Zambia",cap:"Lusaka",cont:"Africa",lat:-13.1,lon:28.0,pop:18,area:753},
  {n:"United States",cap:"Washington, D.C.",cont:"N. America",lat:37.1,lon:-95.7,pop:331,area:9834},
  {n:"Canada",cap:"Ottawa",cont:"N. America",lat:56.1,lon:-106.3,pop:38,area:9985},
  {n:"Mexico",cap:"Mexico City",cont:"N. America",lat:23.6,lon:-102.6,pop:129,area:1964},
  {n:"Cuba",cap:"Havana",cont:"N. America",lat:21.5,lon:-77.8,pop:11,area:110},
  {n:"Jamaica",cap:"Kingston",cont:"N. America",lat:18.1,lon:-77.3,pop:3,area:11},
  {n:"Costa Rica",cap:"San Jose",cont:"N. America",lat:9.7,lon:-84.0,pop:5,area:51},
  {n:"Panama",cap:"Panama City",cont:"N. America",lat:8.5,lon:-80.8,pop:4,area:75},
  {n:"Guatemala",cap:"Guatemala City",cont:"N. America",lat:15.8,lon:-90.2,pop:18,area:109},
  {n:"Haiti",cap:"Port-au-Prince",cont:"N. America",lat:19.0,lon:-72.3,pop:11,area:28},
  {n:"Honduras",cap:"Tegucigalpa",cont:"N. America",lat:15.2,lon:-86.2,pop:10,area:112},
  {n:"El Salvador",cap:"San Salvador",cont:"N. America",lat:13.8,lon:-88.9,pop:6,area:21},
  {n:"Nicaragua",cap:"Managua",cont:"N. America",lat:12.9,lon:-85.2,pop:7,area:130},
  {n:"Dominican Republic",cap:"Santo Domingo",cont:"N. America",lat:18.7,lon:-70.2,pop:11,area:49},
  {n:"Brazil",cap:"Brasilia",cont:"S. America",lat:-14.2,lon:-51.9,pop:213,area:8516},
  {n:"Argentina",cap:"Buenos Aires",cont:"S. America",lat:-38.4,lon:-63.6,pop:45,area:2780},
  {n:"Chile",cap:"Santiago",cont:"S. America",lat:-35.7,lon:-71.5,pop:19,area:757},
  {n:"Colombia",cap:"Bogota",cont:"S. America",lat:4.6,lon:-74.3,pop:51,area:1142},
  {n:"Peru",cap:"Lima",cont:"S. America",lat:-9.2,lon:-75.0,pop:33,area:1285},
  {n:"Venezuela",cap:"Caracas",cont:"S. America",lat:6.4,lon:-66.6,pop:28,area:916},
  {n:"Ecuador",cap:"Quito",cont:"S. America",lat:-1.8,lon:-78.2,pop:18,area:284},
  {n:"Bolivia",cap:"Sucre",cont:"S. America",lat:-16.3,lon:-63.6,pop:12,area:1099},
  {n:"Uruguay",cap:"Montevideo",cont:"S. America",lat:-32.5,lon:-55.8,pop:3,area:176},
  {n:"Paraguay",cap:"Asuncion",cont:"S. America",lat:-23.4,lon:-58.4,pop:7,area:407},
  {n:"Australia",cap:"Canberra",cont:"Oceania",lat:-25.3,lon:133.8,pop:26,area:7692},
  {n:"New Zealand",cap:"Wellington",cont:"Oceania",lat:-40.9,lon:174.9,pop:5,area:268},
  {n:"Fiji",cap:"Suva",cont:"Oceania",lat:-18.0,lon:179.4,pop:0.9,area:18},
  {n:"Papua New Guinea",cap:"Port Moresby",cont:"Oceania",lat:-6.3,lon:147.2,pop:9,area:463}
];

const CONTINENTS = ["All","Europe","Asia","Africa","N. America","S. America","Oceania"];
const CONT_COLORS = {
  "Europe":"#4f8ef7","Asia":"#f7c948","Africa":"#f77f4f","N. America":"#4fcf7b",
  "S. America":"#a855f7","Oceania":"#ec4899"
};

// ===== GAME STATE =====
let state = {
  screen:'title', mode:'capitals', difficulty:'normal',
  score:0, streak:0, bestStreak:0, combo:1,
  correct:0, total:0, round:0, maxRounds:20,
  timeLeft:0, currentQuestion:null, answered:false,
  bossRound:false, bossContinent:'',
  particles:[], shakeX:0, shakeY:0, shakeDecay:0.9,
  floatingTexts:[], clickedPos:null, correctPos:null,
  showCorrectLine:false, continentFilter:'All',
  mapScale:0.85, mapOffX:0, mapOffY:0
};

const DIFF = {
  easy:   { rounds:15, time:30, options:3, locateRadius:800, comboDecay:5, bossEvery:0, scoreMult:0.8 },
  normal: { rounds:20, time:20, options:4, locateRadius:500, comboDecay:3, bossEvery:10, scoreMult:1.0 },
  hard:   { rounds:30, time:12, options:5, locateRadius:300, comboDecay:2, bossEvery:7, scoreMult:1.5 }
};

// ===== CANVAS =====
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H;
function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

// ===== MAP PROJECTION =====
function latLonToXY(lat, lon) {
  const cx = W * 0.5 + state.mapOffX;
  const cy = H * 0.5 + state.mapOffY;
  const scaleX = W * 0.9 * state.mapScale / 360;
  const scaleY = H * 0.85 * state.mapScale / 180;
  return { x: cx + lon * scaleX, y: cy - lat * scaleY };
}

function xyToLatLon(x, y) {
  const cx = W * 0.5 + state.mapOffX;
  const cy = H * 0.5 + state.mapOffY;
  const scaleX = W * 0.9 * state.mapScale / 360;
  const scaleY = H * 0.85 * state.mapScale / 180;
  return { lat: -(y - cy) / scaleY, lon: (x - cx) / scaleX };
}

// ===== CONTINENT OUTLINES =====
const MAP_OUTLINES = [
  {cont:"Europe",pts:[[35,10],[35,-10],[40,-10],[43,-9],[37,-9],[36,-6],[38,-5],[44,0],[43,3],[46,6],[48,3],[51,4],[54,6],[58,5],[60,10],[62,15],[70,20],[70,30],[65,30],[60,25],[55,22],[50,18],[47,15],[45,12],[40,12]]},
  {cont:"Africa",pts:[[35,-10],[35,10],[33,13],[30,10],[25,17],[20,18],[15,17],[10,15],[5,10],[5,1],[-5,10],[-10,14],[-15,17],[-22,18],[-25,18],[-28,17],[-30,18],[-34,20],[-35,27],[-30,32],[-25,35],[-15,42],[-5,43],[5,42],[10,50],[15,46],[20,40],[25,35],[30,32],[32,35],[35,35],[37,30],[35,10]]},
  {cont:"Asia",pts:[[35,35],[40,40],[45,50],[50,55],[55,60],[60,65],[65,70],[70,80],[68,100],[65,110],[55,120],[50,130],[45,140],[40,140],[35,130],[30,120],[25,105],[20,100],[15,100],[10,105],[5,105],[0,100],[-5,105],[-8,115],[1,120],[5,115],[10,110],[15,120],[20,122],[30,125],[35,130],[40,132],[45,143],[50,140],[55,138],[60,145],[65,165],[70,170],[72,150],[70,130],[65,100],[60,90],[55,80],[50,60],[45,50],[40,40]]},
  {cont:"N. America",pts:[[70,-140],[70,-100],[65,-90],[60,-80],[55,-80],[50,-65],[45,-65],[42,-70],[40,-75],[35,-80],[30,-85],[25,-90],[20,-87],[15,-83],[10,-76],[15,-92],[20,-100],[25,-110],[30,-115],[35,-120],[40,-125],[50,-130],[55,-135],[60,-140],[65,-145]]},
  {cont:"S. America",pts:[[10,-76],[10,-65],[5,-60],[0,-50],[-5,-35],[-10,-37],[-15,-40],[-20,-41],[-25,-45],[-30,-50],[-35,-55],[-40,-62],[-45,-65],[-50,-70],[-55,-68],[-50,-75],[-45,-75],[-40,-70],[-35,-72],[-30,-70],[-25,-68],[-20,-65],[-15,-75],[-10,-78],[-5,-80],[0,-80],[5,-78]]},
  {cont:"Oceania",pts:[[-12,131],[-15,125],[-20,118],[-25,114],[-30,115],[-35,117],[-37,140],[-38,145],[-38,148],[-35,150],[-28,152],[-25,153],[-20,149],[-15,145],[-12,142],[-11,137]]}
];

// ===== STARS =====
const stars = [];
for (let i = 0; i < 200; i++) {
  stars.push({x:Math.random(),y:Math.random(),s:Math.random()*2+0.5,b:Math.random()*0.5+0.3,sp:Math.random()*0.01+0.005});
}

// ===== PARTICLES =====
function spawnParticles(x, y, color, count) {
  for (let i = 0; i < count; i++) {
    const a = Math.random() * Math.PI * 2;
    const sp = Math.random() * 4 + 2;
    state.particles.push({x, y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life:1.0, decay:Math.random()*0.03+0.02, size:Math.random()*4+2, color});
  }
}

function spawnFloat(x, y, text, color) {
  state.floatingTexts.push({x, y, text, color, life:1.0, vy:-2});
}

function addShake(amount) {
  state.shakeX += (Math.random()-0.5)*amount;
  state.shakeY += (Math.random()-0.5)*amount;
}

// ===== DRAWING =====
function drawBg(time) {
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,'#060810'); grad.addColorStop(0.5,'#0a0d15'); grad.addColorStop(1,'#0e1120');
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,W,H);
  stars.forEach(s => {
    const br = s.b + Math.sin(time*s.sp)*0.2;
    ctx.fillStyle = 'rgba(200,220,255,'+br+')';
    ctx.fillRect(s.x*W,s.y*H,s.s,s.s);
  });
}

function drawMap(time) {
  // Outlines
  MAP_OUTLINES.forEach(outline => {
    ctx.beginPath();
    const color = CONT_COLORS[outline.cont] || '#444';
    outline.pts.forEach((pt,i) => {
      const pos = latLonToXY(pt[0],pt[1]);
      if(i===0) ctx.moveTo(pos.x,pos.y); else ctx.lineTo(pos.x,pos.y);
    });
    ctx.closePath();
    ctx.fillStyle = color+'15';
    ctx.fill();
    ctx.strokeStyle = color+'40';
    ctx.lineWidth = 1.5;
    ctx.stroke();
  });

  // Country dots
  const pool = state.continentFilter==='All' ? COUNTRIES : COUNTRIES.filter(c=>c.cont===state.continentFilter);
  pool.forEach(country => {
    const pos = latLonToXY(country.lat, country.lon);
    if(pos.x<-20||pos.x>W+20||pos.y<-20||pos.y>H+20) return;
    const color = CONT_COLORS[country.cont]||'#888';
    ctx.beginPath();
    ctx.arc(pos.x,pos.y,3,0,Math.PI*2);
    ctx.fillStyle = color+'80';
    ctx.fill();

    // Highlight correct answer when answered
    if(state.currentQuestion && country.n===state.currentQuestion.correct.n && state.answered){
      ctx.beginPath();
      ctx.arc(pos.x,pos.y,12+Math.sin(time*0.005)*4,0,Math.PI*2);
      ctx.strokeStyle = '#22c55e';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Label
      ctx.fillStyle = '#22c55e';
      ctx.font = 'bold 14px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText(country.n, pos.x, pos.y - 20);
    }
  });

  // Continent labels
  const lps = [
    {cont:"Europe",lat:50,lon:15},{cont:"Asia",lat:40,lon:90},{cont:"Africa",lat:5,lon:20},
    {cont:"N. America",lat:45,lon:-100},{cont:"S. America",lat:-15,lon:-60},{cont:"Oceania",lat:-25,lon:135}
  ];
  ctx.font = '12px system-ui';
  ctx.textAlign = 'center';
  lps.forEach(lp => {
    const pos = latLonToXY(lp.lat,lp.lon);
    ctx.fillStyle = (CONT_COLORS[lp.cont]||'#888')+'50';
    ctx.fillText(lp.cont, pos.x, pos.y);
  });

  // Click marker for locate mode
  if(state.mode==='locate'||state.mode==='challenge') {
    if(state.clickedPos) {
      const cp = latLonToXY(state.clickedPos.lat,state.clickedPos.lon);
      ctx.beginPath();
      ctx.arc(cp.x,cp.y,8,0,Math.PI*2);
      ctx.strokeStyle = state.showCorrectLine ? '#ef4444' : '#00d2d3';
      ctx.lineWidth = 3;
      ctx.stroke();

      if(state.showCorrectLine && state.correctPos) {
        const crp = latLonToXY(state.correctPos.lat,state.correctPos.lon);
        ctx.beginPath();
        ctx.moveTo(cp.x,cp.y);
        ctx.lineTo(crp.x,crp.y);
        ctx.strokeStyle = '#ef444480';
        ctx.lineWidth = 2;
        ctx.setLineDash([8,4]);
        ctx.stroke();
        ctx.setLineDash([]);

        ctx.beginPath();
        ctx.arc(crp.x,crp.y,10,0,Math.PI*2);
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = 3;
        ctx.stroke();
      }
    }
  }
}

function drawParticles() {
  state.particles.forEach(p => {
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x-p.size/2, p.y-p.size/2, p.size, p.size);
  });
  ctx.globalAlpha = 1;
}

function drawFloats() {
  state.floatingTexts.forEach(ft => {
    ctx.globalAlpha = ft.life;
    ctx.fillStyle = ft.color;
    ctx.font = 'bold 18px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(ft.text, ft.x, ft.y);
  });
  ctx.globalAlpha = 1;
}

// ===== GAME LOGIC =====
function shuffle(arr) {
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}

function generateQuestion() {
  const diff = DIFF[state.difficulty];
  let pool = state.continentFilter==='All' ? [...COUNTRIES] : COUNTRIES.filter(c=>c.cont===state.continentFilter);

  // Boss round
  state.bossRound = diff.bossEvery>0 && state.round>0 && state.round%diff.bossEvery===0;
  if(state.bossRound){
    const conts = CONTINENTS.filter(c=>c!=='All');
    state.bossContinent = conts[Math.floor(Math.random()*conts.length)];
    audio.boss();
  }

  // Mode for challenge
  let mode = state.mode;
  if(state.mode==='challenge'){
    const modes = ['capitals','population','locate'];
    mode = modes[Math.floor(Math.random()*modes.length)];
    if(state.bossRound) mode = 'locate';
  }

  const bossPool = state.bossRound ? pool.filter(c=>c.cont===state.bossContinent) : pool;
  const usePool = bossPool.length >= diff.options ? bossPool : pool;

  const correct = usePool[Math.floor(Math.random()*usePool.length)];
  const wrongs = shuffle(usePool.filter(c=>c.n!==correct.n)).slice(0,diff.options-1);
  const options = shuffle([correct,...wrongs]);

  let questionText = '';
  if(mode==='capitals'){
    questionText = 'What is the capital of ' + correct.n + '?';
  } else if(mode==='population'){
    questionText = 'Which country has ~' + correct.pop + 'M people and ~' + correct.area + 'k km2?';
  } else if(mode==='locate'){
    questionText = 'Click on the map to find: ' + correct.n;
  }

  state.currentQuestion = { correct, options, questionText, mode, timeStart:Date.now() };
  state.answered = false;
  state.clickedPos = null;
  state.correctPos = null;
  state.showCorrectLine = false;
  state.timeLeft = diff.time;

  updateHUD();
  updateOptions();
  updateContBar();
}

function answerQuestion(idx) {
  if(state.answered||state.screen!=='playing') return;
  audio.init();
  state.answered = true;
  state.total++;

  const diff = DIFF[state.difficulty];
  const q = state.currentQuestion;
  const optionKey = q.mode==='capitals' ? 'cap' : 'n';
  const isCorrect = q.options[idx][optionKey] === q.correct[optionKey];

  processAnswer(isCorrect, q, diff);

  const btns = document.querySelectorAll('.option-btn');
  btns.forEach((btn,i) => {
    btn.classList.add('disabled');
    if(q.options[i][optionKey]===q.correct[optionKey]) btn.classList.add('correct');
    else if(i===idx && !isCorrect) btn.classList.add('wrong');
  });

  updateHUD();
  scheduleNext(isCorrect);
}

function answerLocate(lat, lon) {
  if(state.answered||state.screen!=='playing') return;
  if(!state.currentQuestion||state.currentQuestion.mode!=='locate') return;
  audio.init();
  state.answered = true;
  state.total++;

  const q = state.currentQuestion;
  const diff = DIFF[state.difficulty];
  state.clickedPos = {lat,lon};
  state.correctPos = {lat:q.correct.lat,lon:q.correct.lon};

  const dLat = (lat-q.correct.lat)*111;
  const dLon = (lon-q.correct.lon)*111*Math.cos(q.correct.lat*Math.PI/180);
  const dist = Math.sqrt(dLat*dLat+dLon*dLon);
  const isCorrect = dist < diff.locateRadius;

  if(isCorrect){
    state.correct++;
    state.streak++;
    if(state.streak>state.bestStreak) state.bestStreak = state.streak;
    if(state.streak>=3) state.combo = Math.min(5,Math.floor(state.streak/diff.comboDecay)+1);

    const proximityBonus = Math.max(0,Math.floor((diff.locateRadius-dist)/5));
    const timeBonus = Math.max(0,Math.floor(state.timeLeft*5));
    const finalScore = Math.round((100+proximityBonus)*state.combo*diff.scoreMult);
    state.score += finalScore;

    const pos = latLonToXY(q.correct.lat,q.correct.lon);
    spawnParticles(pos.x,pos.y,'#22c55e',25);
    spawnFloat(pos.x,pos.y-20,'+'+finalScore+' ('+Math.round(dist)+'km)','#22c55e');
    if(state.combo>1) { spawnFloat(pos.x,pos.y-45,'x'+state.combo+' COMBO!','#a855f7'); audio.combo(state.combo); }
    else audio.correct();
    addShake(3);
    showFeedback('correct');
  } else {
    state.streak = 0;
    state.combo = 1;
    state.showCorrectLine = true;
    audio.wrong();
    addShake(8);
    const cPos = latLonToXY(q.correct.lat,q.correct.lon);
    spawnFloat(cPos.x,cPos.y-20,Math.round(dist)+'km away','#ef4444');
    showFeedback('wrong');
  }

  updateHUD();
  scheduleNext(isCorrect);
}

function processAnswer(isCorrect, q, diff) {
  if(isCorrect){
    state.correct++;
    state.streak++;
    if(state.streak>state.bestStreak) state.bestStreak = state.streak;
    if(state.streak>=3) state.combo = Math.min(5,Math.floor(state.streak/diff.comboDecay)+1);

    const timeBonus = Math.max(0,Math.floor(state.timeLeft*10));
    const finalScore = Math.round((100*state.combo+timeBonus)*diff.scoreMult);
    state.score += finalScore;

    const pos = latLonToXY(q.correct.lat,q.correct.lon);
    spawnParticles(pos.x,pos.y,'#22c55e',20);
    spawnFloat(pos.x,pos.y-20,'+'+finalScore,'#22c55e');
    if(state.combo>1){spawnFloat(pos.x,pos.y-45,'x'+state.combo+' COMBO!','#a855f7');audio.combo(state.combo);}
    else audio.correct();
    addShake(3);
    showFeedback('correct');
  } else {
    state.streak = 0;
    state.combo = 1;
    audio.wrong();
    addShake(8);
    showFeedback('wrong');
    const pos = latLonToXY(q.correct.lat,q.correct.lon);
    spawnParticles(pos.x,pos.y,'#ef4444',10);
  }
}

function scheduleNext(isCorrect) {
  setTimeout(() => {
    state.round++;
    if(state.round >= DIFF[state.difficulty].rounds) endGame();
    else generateQuestion();
  }, isCorrect ? 1200 : 2000);
}

function showFeedback(type) {
  const toast = document.getElementById('feedbackToast');
  toast.className = 'feedback-toast '+type;
  toast.textContent = type==='correct' ? 'CORRECT' : 'WRONG';
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 800);
}

function updateHUD() {
  document.getElementById('hudScore').textContent = state.score.toLocaleString();
  document.getElementById('hudStreak').textContent = state.streak>0 ? 'Streak: '+state.streak : '';
  document.getElementById('hudCombo').textContent = state.combo>1 ? 'x'+state.combo : '';
  document.getElementById('hudRound').textContent = 'Round '+(state.round+1)+' / '+DIFF[state.difficulty].rounds;
  if(state.currentQuestion){
    let qt = state.currentQuestion.questionText;
    if(state.bossRound) qt = '[BOSS: '+state.bossContinent+'] '+qt;
    document.getElementById('hudQuestion').textContent = qt;
  }
}

function updateOptions() {
  const bar = document.getElementById('optionsBar');
  const q = state.currentQuestion;
  if(!q || q.mode==='locate'){bar.style.display='none';return;}
  bar.style.display = 'flex';
  const key = q.mode==='capitals' ? 'cap' : 'n';
  bar.innerHTML = q.options.map((o,i) => '<div class="option-btn" onclick="answerQuestion('+i+')">'+o[key]+'</div>').join('');
}

function updateContBar() {
  const bar = document.getElementById('contBar');
  if(state.screen!=='playing'){bar.style.display='none';return;}
  bar.style.display = 'flex';
  bar.innerHTML = CONTINENTS.map(c => '<div class="cont-btn'+(state.continentFilter===c?' active':'')+'" onclick="setCont(\''+c+'\')">'+c+'</div>').join('');
}

function setCont(c) {
  state.continentFilter = c;
  updateContBar();
}

// ===== GAME FLOW =====
function selectMode(el) {
  audio.init(); audio.menuSelect();
  document.querySelectorAll('.mode-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  state.mode = el.dataset.mode;
}

function selectDiff(el) {
  audio.init(); audio.menuSelect();
  document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  state.difficulty = el.dataset.diff;
}

function startGame() {
  audio.init();
  state.screen = 'playing';
  state.score = 0; state.streak = 0; state.bestStreak = 0; state.combo = 1;
  state.correct = 0; state.total = 0; state.round = 0;
  state.particles = []; state.floatingTexts = [];
  state.bossRound = false;
  hideAllOverlays();
  document.getElementById('hud').style.display = '';
  generateQuestion();
}

function togglePause() {
  audio.init();
  if(state.screen==='playing'){
    state.screen = 'paused';
    document.getElementById('pauseScore').textContent = state.score;
    document.getElementById('pauseStreak').textContent = state.bestStreak;
    document.getElementById('pauseCorrect').textContent = state.correct+'/'+state.total;
    document.getElementById('pauseScreen').classList.add('active');
    document.getElementById('optionsBar').style.display = 'none';
    document.getElementById('contBar').style.display = 'none';
  } else if(state.screen==='paused'){
    state.screen = 'playing';
    document.getElementById('pauseScreen').classList.remove('active');
    updateOptions();
    updateContBar();
  }
}

function endGame() {
  state.screen = 'gameover';
  audio.gameOver();
  hideAllOverlays();
  document.getElementById('hud').style.display = 'none';
  document.getElementById('optionsBar').style.display = 'none';
  document.getElementById('contBar').style.display = 'none';

  const pct = state.total>0 ? Math.round(state.correct/state.total*100) : 0;
  let grade, gradeColor, message;
  if(pct>=95){grade='S';gradeColor='#fbbf24';message='Master Geographer! You know the world like the back of your hand.';}
  else if(pct>=85){grade='A';gradeColor='#22c55e';message='Excellent! You are a world traveler in the making.';}
  else if(pct>=70){grade='B';gradeColor='#4f8ef7';message='Great job! Your geography knowledge is solid.';}
  else if(pct>=55){grade='C';gradeColor='#f7c948';message='Not bad! Keep exploring to improve.';}
  else if(pct>=40){grade='D';gradeColor='#f97316';message='Room for improvement. Try an easier difficulty!';}
  else{grade='F';gradeColor='#ef4444';message='Time to open an atlas! Practice makes perfect.';}

  document.getElementById('goGrade').style.color = gradeColor;
  document.getElementById('goGrade').textContent = grade;
  document.getElementById('goMessage').textContent = message;
  document.getElementById('goStats').innerHTML =
    '<div class="stat"><div class="num">'+state.score.toLocaleString()+'</div><div class="label">Final Score</div></div>'+
    '<div class="stat"><div class="num">'+state.correct+'/'+state.total+'</div><div class="label">Correct</div></div>'+
    '<div class="stat"><div class="num">'+pct+'%</div><div class="label">Accuracy</div></div>'+
    '<div class="stat"><div class="num">'+state.bestStreak+'</div><div class="label">Best Streak</div></div>';

  saveScore(state.score, pct, grade);
  document.getElementById('gameOverScreen').classList.add('active');
}

function quitToTitle() { hideAllOverlays(); document.getElementById('hud').style.display='none'; document.getElementById('optionsBar').style.display='none'; document.getElementById('contBar').style.display='none'; state.screen='title'; showTitle(); }

function showTitle() {
  hideAllOverlays();
  document.getElementById('hud').style.display='none';
  document.getElementById('optionsBar').style.display='none';
  document.getElementById('contBar').style.display='none';
  state.screen = 'title';
  document.getElementById('titleScreen').classList.add('active');
}

function showLeaderboard() {
  audio.init(); audio.menuSelect();
  hideAllOverlays();
  state.screen = 'leaderboard';
  const scores = loadScores();
  const list = document.getElementById('lbList');
  if(scores.length===0){
    list.innerHTML = '<p style="color:#888;text-align:center;padding:20px">No scores yet. Play a game!</p>';
  } else {
    list.innerHTML = scores.map((s,i) =>
      '<div class="lb-row"><div class="lb-rank">#'+(i+1)+'</div><div class="lb-name">'+s.mode+' ('+s.diff+')</div><div class="lb-score">'+s.score.toLocaleString()+'</div><div class="lb-mode">'+s.pct+'% | '+s.grade+' | '+s.date+'</div></div>'
    ).join('');
  }
  document.getElementById('lbScreen').classList.add('active');
}

function hideAllOverlays() { document.querySelectorAll('.overlay').forEach(o=>o.classList.remove('active')); }

// ===== PERSISTENCE =====
function saveScore(score, pct, grade) {
  const scores = loadScores();
  scores.push({score,pct,grade,mode:state.mode,diff:state.difficulty,date:new Date().toLocaleDateString()});
  scores.sort((a,b)=>b.score-a.score);
  localStorage.setItem('worldAtlasScores', JSON.stringify(scores.slice(0,20)));
}
function loadScores() { try{return JSON.parse(localStorage.getItem('worldAtlasScores')||'[]');}catch{return[];} }
function saveSettings() { localStorage.setItem('worldAtlasSettings',JSON.stringify({mode:state.mode,difficulty:state.difficulty,continentFilter:state.continentFilter})); }
function loadSettings() { try{const s=JSON.parse(localStorage.getItem('worldAtlasSettings'));if(s){state.mode=s.mode||'capitals';state.difficulty=s.difficulty||'normal';state.continentFilter=s.continentFilter||'All';}}catch{} }

// ===== INPUT =====
const keys = {};
window.addEventListener('keydown', e => {
  keys[e.key] = true;
  if(e.key==='Escape'){if(state.screen==='playing'||state.screen==='paused')togglePause();}
  if(e.key==='r'||e.key==='R'){if(state.screen==='gameover'||state.screen==='playing')startGame();}
  if(state.screen==='playing'&&!state.answered){
    const num = parseInt(e.key);
    if(num>=1&&num<=5){
      const btns = document.querySelectorAll('.option-btn');
      if(btns[num-1]) answerQuestion(num-1);
    }
  }
});
window.addEventListener('keyup', e => { keys[e.key]=false; });

canvas.addEventListener('click', e => {
  if(state.screen!=='playing'||state.answered) return;
  if(!state.currentQuestion||state.currentQuestion.mode!=='locate') return;
  audio.init();
  const rect = canvas.getBoundingClientRect();
  const ll = xyToLatLon(e.clientX-rect.left, e.clientY-rect.top);
  answerLocate(ll.lat, ll.lon);
});

canvas.addEventListener('touchstart', e => {
  if(state.screen!=='playing'||state.answered) return;
  if(!state.currentQuestion||state.currentQuestion.mode!=='locate') return;
  e.preventDefault(); audio.init();
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  const ll = xyToLatLon(t.clientX-rect.left, t.clientY-rect.top);
  answerLocate(ll.lat, ll.lon);
}, {passive:false});

// ===== MAIN LOOP =====
let lastTime = 0;

function update(time) {
  const dt = Math.min(time-lastTime, 50);
  lastTime = time;

  // Timer
  if(state.screen==='playing' && !state.answered && state.currentQuestion){
    state.timeLeft -= dt/1000;
    if(state.timeLeft<=5 && state.timeLeft>0 && Math.floor(state.timeLeft)!==Math.floor(state.timeLeft+dt/1000)){
      audio.timeWarning();
    }
    if(state.timeLeft<=0){
      state.timeLeft = 0;
      state.answered = true;
      state.total++;
      state.streak = 0;
      state.combo = 1;
      audio.wrong();
      addShake(10);
      showFeedback('wrong');

      const btns = document.querySelectorAll('.option-btn');
      const q = state.currentQuestion;
      const key = q.mode==='capitals' ? 'cap' : 'n';
      btns.forEach((btn,i)=>{
        btn.classList.add('disabled');
        if(q.options[i][key]===q.correct[key]) btn.classList.add('correct');
      });

      if(q.mode==='locate'){
        state.correctPos = {lat:q.correct.lat,lon:q.correct.lon};
        state.showCorrectLine = false;
      }

      updateHUD();
      setTimeout(()=>{state.round++;if(state.round>=DIFF[state.difficulty].rounds)endGame();else generateQuestion();},2000);
    }
    document.getElementById('hudTimer').textContent = Math.ceil(state.timeLeft)+'s';
    document.getElementById('hudTimer').style.color = state.timeLeft<=5 ? '#ef4444' : '#888';
  }

  // Shake
  state.shakeX *= state.shakeDecay;
  state.shakeY *= state.shakeDecay;
  if(Math.abs(state.shakeX)<0.1) state.shakeX=0;
  if(Math.abs(state.shakeY)<0.1) state.shakeY=0;

  // Particles
  state.particles = state.particles.filter(p => {
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.life-=p.decay;
    return p.life>0;
  });

  // Floats
  state.floatingTexts = state.floatingTexts.filter(ft => {
    ft.y+=ft.vy; ft.life-=0.015;
    return ft.life>0;
  });

  draw(time);
  requestAnimationFrame(update);
}

function draw(time) {
  ctx.save();
  ctx.translate(state.shakeX, state.shakeY);
  drawBg(time);
  drawMap(time);
  drawParticles();
  drawFloats();

  // Boss overlay
  if(state.bossRound && state.screen==='playing'){
    ctx.save();
    ctx.fillStyle = '#ef444430';
    ctx.font = 'bold 48px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText('BOSS ROUND: '+state.bossContinent.toUpperCase(), W/2, H/2);
    ctx.restore();
  }

  ctx.restore();
}

// ===== INIT =====
loadSettings();
requestAnimationFrame(update);
</script>
</body>
</html>
