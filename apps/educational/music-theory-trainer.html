<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Theory Trainer</title>
    <meta name="rappterzoo:author" content="Claude Agent">
    <meta name="rappterzoo:author-type" content="agent">
    <meta name="rappterzoo:category" content="educational">
    <meta name="rappterzoo:tags" content="audio,music,education,interactive">
    <meta name="rappterzoo:type" content="educational">
    <meta name="rappterzoo:complexity" content="advanced">
    <meta name="rappterzoo:created" content="2026-02-07">
    <meta name="rappterzoo:generation" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, hsl(240, 60%, 10%) 0%, hsl(280, 40%, 20%) 100%);
            color: hsl(0, 0%, 95%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.6s ease-out;
        }

        h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, hsl(280, 80%, 70%), hsl(320, 80%, 60%));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px hsla(300, 80%, 60%, 0.3);
        }

        .subtitle {
            font-size: 1.1em;
            color: hsl(280, 50%, 70%);
            margin-bottom: 20px;
        }

        .stats-bar {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: hsla(280, 30%, 15%, 0.6);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px hsla(0, 0%, 0%, 0.3);
        }

        .stat {
            text-align: center;
            padding: 10px 20px;
            background: linear-gradient(135deg, hsla(280, 60%, 25%, 0.4), hsla(260, 60%, 20%, 0.4));
            border-radius: 10px;
            border: 1px solid hsla(280, 60%, 50%, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px hsla(280, 70%, 50%, 0.4);
        }

        .stat-label {
            font-size: 0.85em;
            color: hsl(280, 40%, 60%);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: hsl(280, 80%, 75%);
            margin-top: 5px;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            color: hsl(0, 0%, 90%);
            background: linear-gradient(135deg, hsl(260, 50%, 35%), hsl(280, 50%, 25%));
            border: 2px solid hsl(280, 60%, 50%);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px hsla(0, 0%, 0%, 0.3);
            position: relative;
            overflow: hidden;
        }

        .mode-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: hsla(280, 80%, 60%, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .mode-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px hsla(280, 70%, 50%, 0.5);
            border-color: hsl(280, 80%, 60%);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, hsl(280, 70%, 50%), hsl(300, 70%, 40%));
            border-color: hsl(280, 90%, 70%);
            box-shadow: 0 0 30px hsla(280, 80%, 60%, 0.6);
        }

        .mode-btn span {
            position: relative;
            z-index: 1;
        }

        .controls-panel {
            background: hsla(280, 30%, 15%, 0.7);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            max-width: 1200px;
            width: 100%;
            box-shadow: 0 8px 32px hsla(0, 0%, 0%, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid hsla(280, 50%, 40%, 0.3);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: hsl(280, 50%, 75%);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        .control-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        select, button {
            padding: 12px 20px;
            font-size: 1em;
            border-radius: 8px;
            border: 2px solid hsl(280, 50%, 40%);
            background: linear-gradient(135deg, hsl(260, 40%, 25%), hsl(280, 40%, 20%));
            color: hsl(0, 0%, 95%);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        select:hover, button:hover {
            border-color: hsl(280, 70%, 60%);
            box-shadow: 0 4px 15px hsla(280, 70%, 50%, 0.4);
            transform: translateY(-2px);
        }

        button {
            background: linear-gradient(135deg, hsl(280, 60%, 40%), hsl(300, 60%, 35%));
        }

        button:active {
            transform: translateY(0);
        }

        .piano-container {
            perspective: 1000px;
            margin-bottom: 30px;
        }

        .piano {
            display: flex;
            justify-content: center;
            position: relative;
            height: 200px;
            padding: 20px;
            background: linear-gradient(135deg, hsl(30, 20%, 15%), hsl(20, 25%, 10%));
            border-radius: 15px;
            box-shadow: 0 10px 40px hsla(0, 0%, 0%, 0.5), inset 0 -2px 10px hsla(0, 0%, 0%, 0.3);
            transform-style: preserve-3d;
            animation: pianoEnter 0.8s ease-out;
        }

        @keyframes pianoEnter {
            from {
                opacity: 0;
                transform: rotateX(-15deg) scale(0.9);
            }
            to {
                opacity: 1;
                transform: rotateX(0) scale(1);
            }
        }

        .piano-keys {
            display: flex;
            position: relative;
        }

        .key {
            position: relative;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
        }

        .white-key {
            width: 50px;
            height: 160px;
            background: linear-gradient(180deg, hsl(0, 0%, 98%), hsl(0, 0%, 90%));
            border: 2px solid hsl(0, 0%, 20%);
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 8px hsla(0, 0%, 0%, 0.3), inset 0 -2px 3px hsla(0, 0%, 0%, 0.1);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-size: 0.75em;
            color: hsl(0, 0%, 40%);
            font-weight: bold;
        }

        .white-key:hover {
            background: linear-gradient(180deg, hsl(280, 30%, 95%), hsl(280, 20%, 85%));
            transform: translateY(2px);
            box-shadow: 0 2px 5px hsla(0, 0%, 0%, 0.3);
        }

        .white-key.active, .white-key.highlight {
            background: linear-gradient(180deg, hsl(280, 70%, 70%), hsl(280, 70%, 60%));
            transform: translateY(3px);
            box-shadow: 0 1px 3px hsla(0, 0%, 0%, 0.4), 0 0 20px hsla(280, 80%, 60%, 0.6);
        }

        .black-key {
            width: 32px;
            height: 100px;
            background: linear-gradient(180deg, hsl(0, 0%, 15%), hsl(0, 0%, 5%));
            border: 2px solid hsl(0, 0%, 0%);
            border-radius: 0 0 3px 3px;
            box-shadow: 0 3px 6px hsla(0, 0%, 0%, 0.6), inset 0 -2px 3px hsla(0, 0%, 100%, 0.1);
            position: absolute;
            z-index: 10;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
            font-size: 0.65em;
            color: hsl(0, 0%, 60%);
            font-weight: bold;
        }

        .black-key:hover {
            background: linear-gradient(180deg, hsl(280, 40%, 30%), hsl(280, 40%, 15%));
            transform: translateY(2px);
            box-shadow: 0 1px 4px hsla(0, 0%, 0%, 0.6);
        }

        .black-key.active, .black-key.highlight {
            background: linear-gradient(180deg, hsl(280, 80%, 50%), hsl(280, 80%, 40%));
            transform: translateY(3px);
            box-shadow: 0 1px 3px hsla(0, 0%, 0%, 0.6), 0 0 20px hsla(280, 90%, 60%, 0.8);
        }

        .staff-container {
            margin-bottom: 30px;
            background: hsla(280, 30%, 15%, 0.6);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px hsla(0, 0%, 0%, 0.3);
        }

        #staffCanvas {
            width: 100%;
            max-width: 800px;
            height: 250px;
            background: hsl(0, 0%, 98%);
            border-radius: 10px;
            box-shadow: inset 0 2px 10px hsla(0, 0%, 0%, 0.1);
            display: block;
            margin: 0 auto;
        }

        .quiz-panel {
            background: hsla(280, 30%, 15%, 0.7);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 8px 32px hsla(0, 0%, 0%, 0.4);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .quiz-question {
            font-size: 1.5em;
            margin-bottom: 25px;
            color: hsl(280, 70%, 80%);
            font-weight: 600;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .quiz-option {
            padding: 15px 20px;
            font-size: 1.1em;
            background: linear-gradient(135deg, hsl(260, 50%, 30%), hsl(280, 50%, 25%));
            border: 2px solid hsl(280, 50%, 40%);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: hsl(0, 0%, 95%);
            font-weight: 600;
        }

        .quiz-option:hover {
            background: linear-gradient(135deg, hsl(260, 60%, 40%), hsl(280, 60%, 35%));
            border-color: hsl(280, 70%, 60%);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px hsla(280, 70%, 50%, 0.4);
        }

        .quiz-option.correct {
            background: linear-gradient(135deg, hsl(140, 60%, 40%), hsl(160, 60%, 35%));
            border-color: hsl(140, 70%, 60%);
            animation: correctPulse 0.6s ease;
        }

        .quiz-option.incorrect {
            background: linear-gradient(135deg, hsl(0, 60%, 40%), hsl(10, 60%, 35%));
            border-color: hsl(0, 70%, 60%);
            animation: incorrectShake 0.4s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .feedback {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            animation: fadeIn 0.4s ease;
        }

        .feedback.correct {
            color: hsl(140, 70%, 70%);
            background: hsla(140, 60%, 30%, 0.3);
            border: 2px solid hsl(140, 60%, 50%);
        }

        .feedback.incorrect {
            color: hsl(0, 70%, 70%);
            background: hsla(0, 60%, 30%, 0.3);
            border: 2px solid hsl(0, 60%, 50%);
        }

        .chord-builder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .chord-notes {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
            background: hsla(280, 40%, 20%, 0.5);
            border-radius: 10px;
            min-height: 80px;
        }

        .chord-note {
            padding: 12px 24px;
            background: linear-gradient(135deg, hsl(280, 70%, 50%), hsl(300, 70%, 45%));
            border: 2px solid hsl(280, 80%, 60%);
            border-radius: 8px;
            font-size: 1.3em;
            font-weight: bold;
            color: hsl(0, 0%, 98%);
            box-shadow: 0 4px 12px hsla(280, 70%, 40%, 0.5);
            animation: noteAppear 0.4s ease;
        }

        @keyframes noteAppear {
            from {
                opacity: 0;
                transform: scale(0.5) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-panel {
            background: hsla(280, 30%, 15%, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-width: 800px;
            width: 100%;
            text-align: center;
            color: hsl(280, 40%, 70%);
            line-height: 1.6;
        }

        .keyboard-hint {
            margin-top: 15px;
            font-size: 0.9em;
            color: hsl(280, 40%, 60%);
            font-style: italic;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .stats-bar {
                gap: 15px;
            }

            .mode-btn {
                padding: 12px 20px;
                font-size: 1em;
            }

            .white-key {
                width: 40px;
                height: 140px;
            }

            .black-key {
                width: 26px;
                height: 85px;
            }

            .piano {
                height: 180px;
            }

            .quiz-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .white-key {
                width: 32px;
                height: 120px;
                font-size: 0.65em;
            }

            .black-key {
                width: 22px;
                height: 75px;
                font-size: 0.55em;
            }

            .piano {
                height: 160px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üéµ Music Theory Trainer</h1>
        <p class="subtitle">Master scales, intervals, and chords with interactive ear training</p>
    </header>

    <div class="stats-bar">
        <div class="stat">
            <div class="stat-label">Score</div>
            <div class="stat-value" id="scoreDisplay">0</div>
        </div>
        <div class="stat">
            <div class="stat-label">Streak</div>
            <div class="stat-value" id="streakDisplay">0</div>
        </div>
        <div class="stat">
            <div class="stat-label">Best Streak</div>
            <div class="stat-value" id="bestStreakDisplay">0</div>
        </div>
        <div class="stat">
            <div class="stat-label">Accuracy</div>
            <div class="stat-value" id="accuracyDisplay">0%</div>
        </div>
    </div>

    <div class="mode-selector">
        <button class="mode-btn active" data-mode="scales"><span>üéº Scales Explorer</span></button>
        <button class="mode-btn" data-mode="intervals"><span>üéØ Interval Trainer</span></button>
        <button class="mode-btn" data-mode="chords"><span>üéπ Chord Builder</span></button>
    </div>

    <div class="controls-panel" id="controlsPanel">
        <!-- Dynamic controls loaded here -->
    </div>

    <div class="staff-container">
        <canvas id="staffCanvas"></canvas>
    </div>

    <div class="piano-container">
        <div class="piano">
            <div class="piano-keys" id="pianoKeys"></div>
        </div>
        <p class="keyboard-hint">üéπ Play with mouse or keyboard: Q-P for white keys, 2-0 for black keys</p>
    </div>

    <div class="quiz-panel" id="quizPanel" style="display: none;">
        <!-- Quiz content loaded dynamically -->
    </div>

    <div class="info-panel" id="infoPanel">
        Select a mode to begin your music theory training journey!
    </div>

    <script>
        // Audio Context
        let audioCtx = null;
        const initAudio = () => {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioCtx;
        };

        // Note frequency map (A4 = 440Hz)
        const noteFrequencies = {
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81,
            'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00,
            'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63,
            'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00,
            'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25,
            'F5': 698.46
        };

        // Piano keyboard layout
        const pianoLayout = [
            { note: 'C3', type: 'white', key: 'Q' },
            { note: 'C#3', type: 'black', key: '2', offset: 35 },
            { note: 'D3', type: 'white', key: 'W' },
            { note: 'D#3', type: 'black', key: '3', offset: 85 },
            { note: 'E3', type: 'white', key: 'E' },
            { note: 'F3', type: 'white', key: 'R' },
            { note: 'F#3', type: 'black', key: '5', offset: 185 },
            { note: 'G3', type: 'white', key: 'T' },
            { note: 'G#3', type: 'black', key: '6', offset: 235 },
            { note: 'A3', type: 'white', key: 'Y' },
            { note: 'A#3', type: 'black', key: '7', offset: 285 },
            { note: 'B3', type: 'white', key: 'U' },
            { note: 'C4', type: 'white', key: 'I' },
            { note: 'C#4', type: 'black', key: '9', offset: 435 },
            { note: 'D4', type: 'white', key: 'O' },
            { note: 'D#4', type: 'black', key: '0', offset: 485 },
            { note: 'E4', type: 'white', key: 'P' },
            { note: 'F4', type: 'white', key: 'A' },
            { note: 'F#4', type: 'black', key: 'S', offset: 585 },
            { note: 'G4', type: 'white', key: 'D' },
            { note: 'G#4', type: 'black', key: 'F', offset: 635 },
            { note: 'A4', type: 'white', key: 'G' },
            { note: 'A#4', type: 'black', key: 'H', offset: 685 },
            { note: 'B4', type: 'white', key: 'J' },
            { note: 'C5', type: 'white', key: 'K' }
        ];

        // Music theory data
        const scales = {
            'Major': [0, 2, 4, 5, 7, 9, 11, 12],
            'Natural Minor': [0, 2, 3, 5, 7, 8, 10, 12],
            'Harmonic Minor': [0, 2, 3, 5, 7, 8, 11, 12],
            'Melodic Minor': [0, 2, 3, 5, 7, 9, 11, 12],
            'Major Pentatonic': [0, 2, 4, 7, 9, 12],
            'Minor Pentatonic': [0, 3, 5, 7, 10, 12],
            'Blues': [0, 3, 5, 6, 7, 10, 12],
            'Dorian': [0, 2, 3, 5, 7, 9, 10, 12],
            'Phrygian': [0, 1, 3, 5, 7, 8, 10, 12],
            'Lydian': [0, 2, 4, 6, 7, 9, 11, 12],
            'Mixolydian': [0, 2, 4, 5, 7, 9, 10, 12],
            'Aeolian': [0, 2, 3, 5, 7, 8, 10, 12]
        };

        const intervals = {
            'Unison': 0,
            'Minor 2nd': 1,
            'Major 2nd': 2,
            'Minor 3rd': 3,
            'Major 3rd': 4,
            'Perfect 4th': 5,
            'Tritone': 6,
            'Perfect 5th': 7,
            'Minor 6th': 8,
            'Major 6th': 9,
            'Minor 7th': 10,
            'Major 7th': 11,
            'Octave': 12
        };

        const chordTypes = {
            'Major': [0, 4, 7],
            'Minor': [0, 3, 7],
            'Diminished': [0, 3, 6],
            'Augmented': [0, 4, 8],
            'Major 7th': [0, 4, 7, 11],
            'Minor 7th': [0, 3, 7, 10],
            'Dominant 7th': [0, 4, 7, 10],
            'Sus2': [0, 2, 7],
            'Sus4': [0, 5, 7]
        };

        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const keyRoots = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        // State
        let currentMode = 'scales';
        let currentKey = 'C';
        let currentScale = 'Major';
        let currentChordType = 'Major';
        let currentInterval = 'Perfect 5th';
        let selectedChordNotes = [];
        let highlightedNotes = [];
        let quizActive = false;
        let currentQuizAnswer = null;
        let stats = {
            score: 0,
            streak: 0,
            bestStreak: 0,
            totalAttempts: 0,
            correctAttempts: 0
        };

        // Load stats from localStorage
        const loadStats = () => {
            const saved = localStorage.getItem('musicTheoryStats');
            if (saved) {
                stats = JSON.parse(saved);
                updateStatsDisplay();
            }
        };

        const saveStats = () => {
            localStorage.setItem('musicTheoryStats', JSON.stringify(stats));
        };

        const updateStatsDisplay = () => {
            document.getElementById('scoreDisplay').textContent = stats.score;
            document.getElementById('streakDisplay').textContent = stats.streak;
            document.getElementById('bestStreakDisplay').textContent = stats.bestStreak;
            const accuracy = stats.totalAttempts > 0
                ? Math.round((stats.correctAttempts / stats.totalAttempts) * 100)
                : 0;
            document.getElementById('accuracyDisplay').textContent = accuracy + '%';
        };

        // Audio functions
        const playNote = (frequency, duration = 0.5, type = 'sine') => {
            const ctx = initAudio();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();

            oscillator.type = type;
            oscillator.frequency.setValueAtTime(frequency, ctx.currentTime);

            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + duration);
        };

        const playNoteByName = (noteName, duration = 0.5) => {
            const freq = noteFrequencies[noteName];
            if (freq) {
                playNote(freq, duration);
                highlightKey(noteName, duration * 1000);
            }
        };

        const playChord = (noteNames, duration = 1.5) => {
            const ctx = initAudio();
            noteNames.forEach(noteName => {
                const freq = noteFrequencies[noteName];
                if (freq) {
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();

                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(freq, ctx.currentTime);

                    gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);

                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + duration);

                    highlightKey(noteName, duration * 1000);
                }
            });
        };

        const playSequence = (noteNames, noteDuration = 0.4, gap = 0.1) => {
            noteNames.forEach((noteName, index) => {
                setTimeout(() => {
                    playNoteByName(noteName, noteDuration);
                }, index * (noteDuration + gap) * 1000);
            });
        };

        const playInterval = (rootNote, semitones) => {
            const rootFreq = noteFrequencies[rootNote];
            const intervalFreq = rootFreq * Math.pow(2, semitones / 12);

            playNote(rootFreq, 0.6, 'sine');
            setTimeout(() => {
                playNote(intervalFreq, 0.6, 'sine');
            }, 700);

            highlightKey(rootNote, 600);
            setTimeout(() => {
                const intervalNote = transposeNote(rootNote, semitones);
                if (intervalNote) {
                    highlightKey(intervalNote, 600);
                }
            }, 700);
        };

        // Helper functions
        const getNoteIndex = (noteName) => {
            const baseNote = noteName.replace(/[0-9]/g, '');
            return noteNames.indexOf(baseNote);
        };

        const transposeNote = (noteName, semitones) => {
            const octave = parseInt(noteName.match(/\d+/)[0]);
            const baseNote = noteName.replace(/[0-9]/g, '');
            const noteIndex = noteNames.indexOf(baseNote);

            if (noteIndex === -1) return null;

            let newIndex = (noteIndex + semitones) % 12;
            if (newIndex < 0) newIndex += 12;

            let newOctave = octave + Math.floor((noteIndex + semitones) / 12);

            const newNote = noteNames[newIndex] + newOctave;
            return noteFrequencies[newNote] ? newNote : null;
        };

        const getScaleNotes = (root, scaleIntervals) => {
            const rootOctave = 4;
            const rootNote = root + rootOctave;
            const notes = [];

            scaleIntervals.forEach(interval => {
                const note = transposeNote(rootNote, interval);
                if (note) notes.push(note);
            });

            return notes;
        };

        const getChordNotes = (root, chordIntervals) => {
            const rootOctave = 4;
            const rootNote = root + rootOctave;
            const notes = [];

            chordIntervals.forEach(interval => {
                const note = transposeNote(rootNote, interval);
                if (note) notes.push(note);
            });

            return notes;
        };

        const highlightKey = (noteName, duration = 300) => {
            const keyElement = document.querySelector(`[data-note="${noteName}"]`);
            if (keyElement) {
                keyElement.classList.add('active');
                setTimeout(() => {
                    keyElement.classList.remove('active');
                }, duration);
            }
        };

        const setHighlightedNotes = (notes) => {
            // Clear previous highlights
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('highlight');
            });

            highlightedNotes = notes;

            // Add new highlights
            notes.forEach(noteName => {
                const keyElement = document.querySelector(`[data-note="${noteName}"]`);
                if (keyElement) {
                    keyElement.classList.add('highlight');
                }
            });
        };

        // Draw piano keyboard
        const drawPiano = () => {
            const container = document.getElementById('pianoKeys');
            container.innerHTML = '';

            // Draw white keys first
            pianoLayout.filter(k => k.type === 'white').forEach(key => {
                const keyEl = document.createElement('div');
                keyEl.className = 'key white-key';
                keyEl.dataset.note = key.note;
                keyEl.textContent = key.key;

                keyEl.addEventListener('mousedown', () => {
                    playNoteByName(key.note);
                });

                container.appendChild(keyEl);
            });

            // Draw black keys on top
            pianoLayout.filter(k => k.type === 'black').forEach(key => {
                const keyEl = document.createElement('div');
                keyEl.className = 'key black-key';
                keyEl.dataset.note = key.note;
                keyEl.style.left = key.offset + 'px';
                keyEl.textContent = key.key;

                keyEl.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    playNoteByName(key.note);
                });

                container.appendChild(keyEl);
            });
        };

        // Keyboard input
        document.addEventListener('keydown', (e) => {
            if (quizActive) return; // Disable piano during quiz

            const key = e.key.toUpperCase();
            const pianoKey = pianoLayout.find(k => k.key === key);

            if (pianoKey) {
                e.preventDefault();
                playNoteByName(pianoKey.note);
            }
        });

        // Staff notation drawing
        const drawStaff = (notes = []) => {
            const canvas = document.getElementById('staffCanvas');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;

            canvas.width = canvas.offsetWidth * dpr;
            canvas.height = canvas.offsetHeight * dpr;
            ctx.scale(dpr, dpr);

            const w = canvas.offsetWidth;
            const h = canvas.offsetHeight;

            ctx.clearRect(0, 0, w, h);

            // Draw staff lines
            const staffTop = h * 0.3;
            const lineSpacing = 15;
            const staffLeft = 80;
            const staffRight = w - 40;

            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1.5;

            for (let i = 0; i < 5; i++) {
                const y = staffTop + i * lineSpacing;
                ctx.beginPath();
                ctx.moveTo(staffLeft, y);
                ctx.lineTo(staffRight, y);
                ctx.stroke();
            }

            // Draw treble clef (simplified)
            ctx.font = 'bold 70px serif';
            ctx.fillStyle = '#333';
            ctx.fillText('ùÑû', staffLeft - 50, staffTop + lineSpacing * 3);

            // Draw notes
            if (notes.length > 0) {
                const notePositions = {
                    'C': 6, 'D': 5.5, 'E': 5, 'F': 4.5, 'G': 4, 'A': 3.5, 'B': 3,
                    'C#': 6, 'D#': 5.5, 'E#': 5, 'F#': 4.5, 'G#': 4, 'A#': 3.5, 'B#': 3
                };

                const spacing = (staffRight - staffLeft - 100) / notes.length;

                notes.forEach((noteName, index) => {
                    const baseNote = noteName.replace(/[0-9]/g, '');
                    const octave = parseInt(noteName.match(/\d+/)[0]);

                    let position = notePositions[baseNote] || 4;

                    // Adjust for octave
                    if (octave === 3) position += 3.5;
                    else if (octave === 5) position -= 3.5;

                    const x = staffLeft + 80 + index * spacing;
                    const y = staffTop + position * lineSpacing;

                    // Draw note head
                    ctx.fillStyle = '#8B4FDB';
                    ctx.beginPath();
                    ctx.ellipse(x, y, 8, 6, -0.3, 0, Math.PI * 2);
                    ctx.fill();

                    // Draw stem
                    ctx.strokeStyle = '#8B4FDB';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(x + 7, y);
                    ctx.lineTo(x + 7, y - 35);
                    ctx.stroke();

                    // Draw sharp/flat if needed
                    if (baseNote.includes('#')) {
                        ctx.font = 'bold 20px serif';
                        ctx.fillStyle = '#333';
                        ctx.fillText('‚ôØ', x - 15, y + 5);
                    } else if (baseNote.includes('b')) {
                        ctx.font = 'bold 20px serif';
                        ctx.fillStyle = '#333';
                        ctx.fillText('‚ô≠', x - 15, y + 5);
                    }

                    // Draw ledger lines if needed
                    if (position < 0 || position > 4) {
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 1.5;
                        const ledgerPositions = [];

                        if (position < 0) {
                            for (let i = -1; i >= position; i -= 1) {
                                ledgerPositions.push(staffTop + i * lineSpacing);
                            }
                        } else if (position > 4) {
                            for (let i = 5; i <= position; i += 1) {
                                ledgerPositions.push(staffTop + i * lineSpacing);
                            }
                        }

                        ledgerPositions.forEach(ly => {
                            ctx.beginPath();
                            ctx.moveTo(x - 12, ly);
                            ctx.lineTo(x + 12, ly);
                            ctx.stroke();
                        });
                    }
                });
            }
        };

        // Mode switching
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                currentMode = btn.dataset.mode;
                loadMode(currentMode);
            });
        });

        // Load mode-specific UI
        const loadMode = (mode) => {
            const controlsPanel = document.getElementById('controlsPanel');
            const quizPanel = document.getElementById('quizPanel');
            const infoPanel = document.getElementById('infoPanel');

            quizPanel.style.display = 'none';
            quizActive = false;
            setHighlightedNotes([]);

            if (mode === 'scales') {
                controlsPanel.innerHTML = `
                    <div class="control-group">
                        <label>Key Root</label>
                        <div class="control-row">
                            <select id="keySelect">
                                ${keyRoots.map(key => `<option value="${key}">${key}</option>`).join('')}
                            </select>
                            <select id="scaleSelect">
                                ${Object.keys(scales).map(scale => `<option value="${scale}">${scale}</option>`).join('')}
                            </select>
                            <button id="playScaleBtn">‚ñ∂ Play Scale</button>
                            <button id="showScaleBtn">üëÅ Show Notes</button>
                            <button id="quizScaleBtn">üéØ Quiz Me</button>
                        </div>
                    </div>
                `;

                document.getElementById('keySelect').value = currentKey;
                document.getElementById('scaleSelect').value = currentScale;

                document.getElementById('keySelect').addEventListener('change', (e) => {
                    currentKey = e.target.value;
                    updateScaleDisplay();
                });

                document.getElementById('scaleSelect').addEventListener('change', (e) => {
                    currentScale = e.target.value;
                    updateScaleDisplay();
                });

                document.getElementById('playScaleBtn').addEventListener('click', () => {
                    const notes = getScaleNotes(currentKey, scales[currentScale]);
                    playSequence(notes);
                    drawStaff(notes);
                });

                document.getElementById('showScaleBtn').addEventListener('click', () => {
                    const notes = getScaleNotes(currentKey, scales[currentScale]);
                    setHighlightedNotes(notes);
                    drawStaff(notes);
                });

                document.getElementById('quizScaleBtn').addEventListener('click', startScaleQuiz);

                updateScaleDisplay();

            } else if (mode === 'intervals') {
                controlsPanel.innerHTML = `
                    <div class="control-group">
                        <label>Interval Training</label>
                        <div class="control-row">
                            <select id="rootNoteSelect">
                                ${keyRoots.map(key => `<option value="${key}">${key}</option>`).join('')}
                            </select>
                            <select id="intervalSelect">
                                ${Object.keys(intervals).map(interval => `<option value="${interval}">${interval}</option>`).join('')}
                            </select>
                            <button id="playIntervalBtn">‚ñ∂ Play Interval</button>
                            <button id="quizIntervalBtn">üéØ Quiz Me</button>
                        </div>
                    </div>
                `;

                document.getElementById('rootNoteSelect').value = currentKey;
                document.getElementById('intervalSelect').value = currentInterval;

                document.getElementById('rootNoteSelect').addEventListener('change', (e) => {
                    currentKey = e.target.value;
                });

                document.getElementById('intervalSelect').addEventListener('change', (e) => {
                    currentInterval = e.target.value;
                });

                document.getElementById('playIntervalBtn').addEventListener('click', () => {
                    const rootNote = currentKey + '4';
                    const semitones = intervals[currentInterval];
                    playInterval(rootNote, semitones);

                    const intervalNote = transposeNote(rootNote, semitones);
                    if (intervalNote) {
                        drawStaff([rootNote, intervalNote]);
                    }
                });

                document.getElementById('quizIntervalBtn').addEventListener('click', startIntervalQuiz);

                infoPanel.textContent = 'Select an interval and play it to hear the sound. Test your ear with the quiz!';
                drawStaff([]);

            } else if (mode === 'chords') {
                controlsPanel.innerHTML = `
                    <div class="control-group">
                        <label>Chord Builder</label>
                        <div class="control-row">
                            <select id="chordRootSelect">
                                ${keyRoots.map(key => `<option value="${key}">${key}</option>`).join('')}
                            </select>
                            <select id="chordTypeSelect">
                                ${Object.keys(chordTypes).map(type => `<option value="${type}">${type}</option>`).join('')}
                            </select>
                            <button id="playChordBtn">‚ñ∂ Play Chord</button>
                            <button id="arpeggioBtn">üéµ Arpeggio</button>
                            <button id="quizChordBtn">üéØ Quiz Me</button>
                        </div>
                    </div>
                    <div class="chord-builder">
                        <div class="chord-notes" id="chordNotesDisplay"></div>
                    </div>
                `;

                document.getElementById('chordRootSelect').value = currentKey;
                document.getElementById('chordTypeSelect').value = currentChordType;

                document.getElementById('chordRootSelect').addEventListener('change', (e) => {
                    currentKey = e.target.value;
                    updateChordDisplay();
                });

                document.getElementById('chordTypeSelect').addEventListener('change', (e) => {
                    currentChordType = e.target.value;
                    updateChordDisplay();
                });

                document.getElementById('playChordBtn').addEventListener('click', () => {
                    const notes = getChordNotes(currentKey, chordTypes[currentChordType]);
                    playChord(notes, 2.0);
                    drawStaff(notes);
                });

                document.getElementById('arpeggioBtn').addEventListener('click', () => {
                    const notes = getChordNotes(currentKey, chordTypes[currentChordType]);
                    playSequence(notes, 0.4, 0.1);
                    drawStaff(notes);
                });

                document.getElementById('quizChordBtn').addEventListener('click', startChordQuiz);

                updateChordDisplay();
            }
        };

        const updateScaleDisplay = () => {
            const notes = getScaleNotes(currentKey, scales[currentScale]);
            const noteList = notes.map(n => n.replace(/[0-9]/g, '')).join(' - ');
            document.getElementById('infoPanel').textContent =
                `${currentKey} ${currentScale}: ${noteList}`;
        };

        const updateChordDisplay = () => {
            const notes = getChordNotes(currentKey, chordTypes[currentChordType]);
            const display = document.getElementById('chordNotesDisplay');
            display.innerHTML = notes.map(n =>
                `<div class="chord-note">${n.replace(/[0-9]/g, '')}</div>`
            ).join('');

            setHighlightedNotes(notes);
            document.getElementById('infoPanel').textContent =
                `${currentKey} ${currentChordType} chord contains: ${notes.map(n => n.replace(/[0-9]/g, '')).join(', ')}`;
        };

        // Quiz functions
        const startScaleQuiz = () => {
            quizActive = true;
            const quizPanel = document.getElementById('quizPanel');
            quizPanel.style.display = 'block';

            // Random key and scale
            const randomKey = keyRoots[Math.floor(Math.random() * keyRoots.length)];
            const scaleNames = Object.keys(scales);
            const randomScale = scaleNames[Math.floor(Math.random() * scaleNames.length)];

            currentQuizAnswer = randomScale;
            const notes = getScaleNotes(randomKey, scales[randomScale]);

            // Play the scale
            setTimeout(() => playSequence(notes), 500);
            drawStaff(notes);

            // Generate options
            const options = [randomScale];
            while (options.length < 4) {
                const option = scaleNames[Math.floor(Math.random() * scaleNames.length)];
                if (!options.includes(option)) {
                    options.push(option);
                }
            }
            options.sort(() => Math.random() - 0.5);

            quizPanel.innerHTML = `
                <div class="quiz-question">üéº What scale is this?</div>
                <button onclick="playCurrentQuiz()" style="margin-bottom: 20px;">üîä Play Again</button>
                <div class="quiz-options">
                    ${options.map(opt => `
                        <button class="quiz-option" onclick="checkScaleAnswer('${opt}')">${opt}</button>
                    `).join('')}
                </div>
                <div id="quizFeedback"></div>
            `;

            window.playCurrentQuiz = () => {
                playSequence(notes);
            };
        };

        const startIntervalQuiz = () => {
            quizActive = true;
            const quizPanel = document.getElementById('quizPanel');
            quizPanel.style.display = 'block';

            // Random interval
            const intervalNames = Object.keys(intervals);
            const randomInterval = intervalNames[Math.floor(Math.random() * intervalNames.length)];
            const semitones = intervals[randomInterval];

            currentQuizAnswer = randomInterval;
            const rootNote = 'C4';

            // Play the interval
            setTimeout(() => playInterval(rootNote, semitones), 500);

            const intervalNote = transposeNote(rootNote, semitones);
            if (intervalNote) {
                drawStaff([rootNote, intervalNote]);
            }

            // Generate options
            const options = [randomInterval];
            while (options.length < 4) {
                const option = intervalNames[Math.floor(Math.random() * intervalNames.length)];
                if (!options.includes(option)) {
                    options.push(option);
                }
            }
            options.sort(() => Math.random() - 0.5);

            quizPanel.innerHTML = `
                <div class="quiz-question">üéØ What interval is this?</div>
                <button onclick="playCurrentIntervalQuiz()" style="margin-bottom: 20px;">üîä Play Again</button>
                <div class="quiz-options">
                    ${options.map(opt => `
                        <button class="quiz-option" onclick="checkIntervalAnswer('${opt}')">${opt}</button>
                    `).join('')}
                </div>
                <div id="quizFeedback"></div>
            `;

            window.playCurrentIntervalQuiz = () => {
                playInterval(rootNote, semitones);
            };
        };

        const startChordQuiz = () => {
            quizActive = true;
            const quizPanel = document.getElementById('quizPanel');
            quizPanel.style.display = 'block';

            // Random chord
            const chordNames = Object.keys(chordTypes);
            const randomChord = chordNames[Math.floor(Math.random() * chordNames.length)];
            const randomKey = keyRoots[Math.floor(Math.random() * keyRoots.length)];

            currentQuizAnswer = randomChord;
            const notes = getChordNotes(randomKey, chordTypes[randomChord]);

            // Play the chord
            setTimeout(() => playChord(notes, 2.0), 500);
            drawStaff(notes);

            // Generate options
            const options = [randomChord];
            while (options.length < 4) {
                const option = chordNames[Math.floor(Math.random() * chordNames.length)];
                if (!options.includes(option)) {
                    options.push(option);
                }
            }
            options.sort(() => Math.random() - 0.5);

            quizPanel.innerHTML = `
                <div class="quiz-question">üéπ What chord quality is this?</div>
                <button onclick="playCurrentChordQuiz()" style="margin-bottom: 20px;">üîä Play Again</button>
                <div class="quiz-options">
                    ${options.map(opt => `
                        <button class="quiz-option" onclick="checkChordAnswer('${opt}')">${opt}</button>
                    `).join('')}
                </div>
                <div id="quizFeedback"></div>
            `;

            window.playCurrentChordQuiz = () => {
                playChord(notes, 2.0);
            };
        };

        window.checkScaleAnswer = (answer) => {
            checkAnswer(answer, () => {
                document.getElementById('quizPanel').style.display = 'none';
                quizActive = false;
                setTimeout(startScaleQuiz, 1500);
            });
        };

        window.checkIntervalAnswer = (answer) => {
            checkAnswer(answer, () => {
                document.getElementById('quizPanel').style.display = 'none';
                quizActive = false;
                setTimeout(startIntervalQuiz, 1500);
            });
        };

        window.checkChordAnswer = (answer) => {
            checkAnswer(answer, () => {
                document.getElementById('quizPanel').style.display = 'none';
                quizActive = false;
                setTimeout(startChordQuiz, 1500);
            });
        };

        const checkAnswer = (answer, nextQuiz) => {
            const feedback = document.getElementById('quizFeedback');
            const options = document.querySelectorAll('.quiz-option');

            stats.totalAttempts++;

            options.forEach(opt => {
                opt.disabled = true;
                if (opt.textContent === currentQuizAnswer) {
                    opt.classList.add('correct');
                }
                if (opt.textContent === answer && answer !== currentQuizAnswer) {
                    opt.classList.add('incorrect');
                }
            });

            if (answer === currentQuizAnswer) {
                stats.score += 10;
                stats.streak++;
                stats.correctAttempts++;
                if (stats.streak > stats.bestStreak) {
                    stats.bestStreak = stats.streak;
                }

                feedback.innerHTML = '<div class="feedback correct">‚úì Correct! +10 points</div>';
                playNote(523.25, 0.3, 'sine'); // C5

            } else {
                stats.streak = 0;
                feedback.innerHTML = `<div class="feedback incorrect">‚úó Incorrect. The answer was ${currentQuizAnswer}</div>`;
                playNote(130.81, 0.5, 'sawtooth'); // C3
            }

            saveStats();
            updateStatsDisplay();

            setTimeout(nextQuiz, 2000);
        };

        // Initialize
        loadStats();
        drawPiano();
        loadMode('scales');
        drawStaff([]);

        // Handle window resize for canvas
        window.addEventListener('resize', () => {
            drawStaff([]);
        });
    </script>
</body>
</html>