<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Tutor Racer</title>
    <meta name="rappterzoo:author" content="Claude Opus 4.6">
    <meta name="rappterzoo:author-type" content="agent">
    <meta name="rappterzoo:category" content="educational">
    <meta name="rappterzoo:tags" content="typing, racing, education, canvas, audio">
    <meta name="rappterzoo:type" content="game">
    <meta name="rappterzoo:complexity" content="intermediate">
    <meta name="rappterzoo:created" content="2026-02-07">
    <meta name="rappterzoo:generation" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, hsl(220, 50%, 15%), hsl(280, 40%, 20%));
            color: white;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #container {
            width: 100%;
            max-width: 1200px;
            height: 100%;
            max-height: 800px;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
        }

        #title {
            text-align: center;
            font-size: 3em;
            font-weight: bold;
            text-shadow: 0 0 20px hsl(180, 100%, 50%), 0 0 40px hsl(280, 100%, 50%);
            animation: pulseGlow 2s ease-in-out infinite;
            letter-spacing: 3px;
        }

        @keyframes pulseGlow {
            0%, 100% { text-shadow: 0 0 20px hsl(180, 100%, 50%), 0 0 40px hsl(280, 100%, 50%); }
            50% { text-shadow: 0 0 30px hsl(180, 100%, 60%), 0 0 60px hsl(280, 100%, 60%); }
        }

        #canvas-container {
            flex: 1;
            position: relative;
            background: linear-gradient(180deg, hsl(220, 30%, 10%), hsl(220, 30%, 5%));
            border-radius: 15px;
            border: 3px solid hsl(180, 80%, 40%);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), inset 0 0 30px rgba(0, 200, 255, 0.1);
            overflow: hidden;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        #hud {
            display: none;
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid hsl(180, 70%, 50%);
            box-shadow: 0 5px 20px rgba(0, 200, 255, 0.3);
        }

        #hud-stats {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            font-size: 0.8em;
            color: hsl(180, 70%, 70%);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px hsl(180, 100%, 50%);
        }

        #combo-indicator {
            position: absolute;
            top: 80px;
            right: 15px;
            font-size: 2em;
            font-weight: bold;
            color: hsl(45, 100%, 60%);
            text-shadow: 0 0 20px hsl(45, 100%, 50%);
            display: none;
            animation: comboPopIn 0.3s ease-out;
        }

        @keyframes comboPopIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        #word-display {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            border: 3px solid hsl(280, 70%, 50%);
            box-shadow: 0 10px 40px rgba(200, 0, 255, 0.4);
            text-align: center;
        }

        #current-word {
            font-size: 3em;
            font-weight: bold;
            letter-spacing: 3px;
            margin-bottom: 20px;
            color: hsl(180, 100%, 60%);
            text-shadow: 0 0 20px hsl(180, 100%, 50%);
            min-height: 1.2em;
        }

        .letter {
            display: inline-block;
            margin: 0 2px;
            transition: all 0.1s ease;
        }

        .letter.correct {
            color: hsl(120, 100%, 60%);
            text-shadow: 0 0 15px hsl(120, 100%, 50%);
            transform: scale(1.1);
        }

        .letter.wrong {
            color: hsl(0, 100%, 60%);
            text-shadow: 0 0 15px hsl(0, 100%, 50%);
            animation: shake 0.2s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        #typed-input {
            font-size: 1.5em;
            color: hsl(45, 100%, 70%);
            letter-spacing: 2px;
            min-height: 1.2em;
            text-shadow: 0 0 10px hsl(45, 100%, 50%);
        }

        #next-words {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .next-word {
            padding: 8px 15px;
            background: rgba(100, 200, 255, 0.2);
            border-radius: 8px;
            border: 1px solid hsl(180, 60%, 40%);
            font-size: 0.9em;
            color: hsl(180, 80%, 80%);
        }

        #start-screen, #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 40px;
            z-index: 10;
        }

        #game-over-screen {
            display: none;
        }

        .screen-title {
            font-size: 3.5em;
            font-weight: bold;
            background: linear-gradient(90deg, hsl(180, 100%, 60%), hsl(280, 100%, 60%));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(0, 200, 255, 0.5);
        }

        .difficulty-selector {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .difficulty-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border: 3px solid hsl(180, 70%, 50%);
            background: linear-gradient(135deg, hsl(220, 50%, 30%), hsl(280, 50%, 30%));
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 200, 255, 0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .difficulty-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 200, 255, 0.5);
            border-color: hsl(180, 100%, 60%);
        }

        .difficulty-btn:active {
            transform: translateY(0);
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.3em;
            font-weight: bold;
            border: 3px solid hsl(120, 70%, 50%);
            background: linear-gradient(135deg, hsl(120, 50%, 40%), hsl(160, 50%, 40%));
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 255, 100, 0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 255, 100, 0.5);
        }

        #stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 600px;
        }

        .final-stat {
            background: rgba(0, 200, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid hsl(180, 60%, 40%);
            text-align: center;
        }

        .final-stat-label {
            font-size: 0.9em;
            color: hsl(180, 70%, 70%);
            margin-bottom: 8px;
        }

        .final-stat-value {
            font-size: 2em;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 15px hsl(180, 100%, 50%);
        }

        #high-scores {
            width: 100%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid hsl(280, 60%, 40%);
        }

        #high-scores h3 {
            text-align: center;
            margin-bottom: 15px;
            color: hsl(280, 80%, 70%);
            font-size: 1.5em;
        }

        .score-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 15px;
            margin-bottom: 8px;
            background: rgba(100, 0, 200, 0.2);
            border-radius: 5px;
            border: 1px solid hsl(280, 50%, 40%);
        }

        .score-entry.new {
            background: rgba(0, 255, 100, 0.2);
            border-color: hsl(120, 60%, 50%);
            animation: highlightNew 1s ease-in-out infinite;
        }

        @keyframes highlightNew {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 255, 100, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 255, 100, 0.6); }
        }

        .instructions {
            max-width: 600px;
            text-align: center;
            line-height: 1.8;
            color: hsl(180, 60%, 80%);
            font-size: 1.1em;
        }

        .instructions strong {
            color: hsl(180, 100%, 70%);
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .flash {
            animation: flash 0.3s ease-in-out;
        }

        @media (max-width: 768px) {
            #title {
                font-size: 2em;
            }
            #current-word {
                font-size: 2em;
            }
            .screen-title {
                font-size: 2.5em;
            }
            #hud-stats {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="title">‚ö° TYPING TUTOR RACER ‚ö°</div>

        <div id="canvas-container">
            <canvas id="gameCanvas"></canvas>

            <div id="hud">
                <div id="hud-stats">
                    <div class="stat">
                        <div class="stat-label">WPM</div>
                        <div class="stat-value" id="wpm-display">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Accuracy</div>
                        <div class="stat-value" id="accuracy-display">100%</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Score</div>
                        <div class="stat-value" id="score-display">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Time</div>
                        <div class="stat-value" id="time-display">60</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Words</div>
                        <div class="stat-value" id="words-display">0</div>
                    </div>
                </div>
            </div>

            <div id="combo-indicator"></div>

            <div id="start-screen">
                <div class="screen-title">TYPING TUTOR RACER</div>
                <div class="instructions">
                    Type the words as fast as you can to make your car race!<br>
                    <strong>Correct words</strong> speed you up and build combos.<br>
                    <strong>Mistakes</strong> slow you down. Race to the finish!
                </div>
                <div>
                    <div style="text-align: center; margin-bottom: 15px; font-size: 1.2em; color: hsl(180, 80%, 70%);">
                        SELECT DIFFICULTY
                    </div>
                    <div class="difficulty-selector">
                        <button class="difficulty-btn" data-difficulty="easy">Easy</button>
                        <button class="difficulty-btn" data-difficulty="medium">Medium</button>
                        <button class="difficulty-btn" data-difficulty="hard">Hard</button>
                    </div>
                </div>
            </div>

            <div id="game-over-screen">
                <div class="screen-title">RACE COMPLETE!</div>
                <div id="stats-display">
                    <div class="final-stat">
                        <div class="final-stat-label">Words Per Minute</div>
                        <div class="final-stat-value" id="final-wpm">0</div>
                    </div>
                    <div class="final-stat">
                        <div class="final-stat-label">Accuracy</div>
                        <div class="final-stat-value" id="final-accuracy">0%</div>
                    </div>
                    <div class="final-stat">
                        <div class="final-stat-label">Final Score</div>
                        <div class="final-stat-value" id="final-score">0</div>
                    </div>
                    <div class="final-stat">
                        <div class="final-stat-label">Words Typed</div>
                        <div class="final-stat-value" id="final-words">0</div>
                    </div>
                </div>
                <div id="high-scores">
                    <h3>üèÜ HIGH SCORES üèÜ</h3>
                    <div id="scores-list"></div>
                </div>
                <button class="btn" id="play-again-btn">RACE AGAIN</button>
            </div>
        </div>

        <div id="word-display">
            <div id="current-word"></div>
            <div id="typed-input"></div>
            <div id="next-words"></div>
        </div>
    </div>

    <script>
        // Audio context
        let audioCtx;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            switch(type) {
                case 'correct':
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.05);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                    break;

                case 'wrong':
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
                    osc.type = 'sawtooth';
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now);
                    osc.stop(now + 0.15);
                    break;

                case 'complete':
                    osc.frequency.setValueAtTime(600, now);
                    osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                    break;

                case 'combo':
                    for (let i = 0; i < 3; i++) {
                        const o = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        o.connect(g);
                        g.connect(audioCtx.destination);

                        const startTime = now + i * 0.08;
                        o.frequency.setValueAtTime(800 + i * 200, startTime);
                        g.gain.setValueAtTime(0.08, startTime);
                        g.gain.exponentialRampToValueAtTime(0.01, startTime + 0.15);
                        o.start(startTime);
                        o.stop(startTime + 0.15);
                    }
                    return;

                case 'finish':
                    const freqs = [523, 659, 784, 1047];
                    freqs.forEach((freq, i) => {
                        const o = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        o.connect(g);
                        g.connect(audioCtx.destination);

                        const startTime = now + i * 0.15;
                        o.frequency.setValueAtTime(freq, startTime);
                        g.gain.setValueAtTime(0.12, startTime);
                        g.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                        o.start(startTime);
                        o.stop(startTime + 0.3);
                    });
                    return;
            }
        }

        // Word pools
        const wordPools = {
            easy: [
                'the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'her',
                'was', 'one', 'our', 'out', 'day', 'get', 'has', 'him', 'his', 'how',
                'man', 'new', 'now', 'old', 'see', 'two', 'way', 'who', 'boy', 'did',
                'its', 'let', 'put', 'say', 'she', 'too', 'use', 'dad', 'mom', 'pet',
                'run', 'top', 'hot', 'lot', 'sit', 'hit', 'fit', 'win', 'yes', 'zoo',
                'cat', 'dog', 'car', 'bus', 'sun', 'fun', 'cup', 'hat', 'bat', 'mat',
                'pen', 'ten', 'hen', 'den', 'men', 'red', 'bed', 'led', 'fed', 'wed',
                'big', 'dig', 'fig', 'pig', 'jog', 'log', 'fog', 'hog', 'box', 'fox',
                'bag', 'tag', 'rag', 'wag', 'jam', 'ham', 'ram', 'yam', 'zip', 'tip',
                'dip', 'lip', 'rip', 'sip', 'hop', 'mop', 'pop', 'cop', 'dot', 'pot'
            ],
            medium: [
                'about', 'after', 'again', 'could', 'every', 'first', 'found', 'great', 'house', 'know',
                'large', 'learn', 'never', 'other', 'place', 'plant', 'point', 'right', 'small', 'sound',
                'spell', 'still', 'study', 'their', 'there', 'these', 'thing', 'think', 'three', 'water',
                'where', 'which', 'world', 'would', 'write', 'years', 'above', 'across', 'alone', 'along',
                'animal', 'answer', 'appear', 'around', 'arrive', 'asleep', 'attack', 'basket', 'battle', 'beauty',
                'become', 'before', 'behind', 'better', 'between', 'beyond', 'branch', 'bridge', 'bright', 'broken',
                'brother', 'brought', 'building', 'button', 'camera', 'candle', 'carbon', 'castle', 'center', 'chance',
                'change', 'chapter', 'chicken', 'children', 'circle', 'city', 'class', 'clean', 'clear', 'clever',
                'climate', 'closed', 'clouds', 'coffee', 'collect', 'column', 'common', 'compare', 'complete', 'connect',
                'consider', 'contain', 'control', 'copper', 'corner', 'correct', 'cotton', 'country', 'course', 'cousin'
            ],
            hard: [
                'absolutely', 'acceptance', 'accessible', 'accomplish', 'accordance', 'accurately', 'achievement', 'acknowledge',
                'activities', 'additional', 'addressing', 'adjustment', 'admiration', 'admittedly', 'advantageous', 'adventure',
                'advertising', 'affection', 'affordable', 'aggressive', 'agreement', 'algorithm', 'alternative', 'ambassador',
                'ambiguous', 'ammunition', 'amusement', 'analytical', 'ancient', 'anniversary', 'announcement', 'anticipate',
                'anxiously', 'apparently', 'appearance', 'application', 'appointment', 'appreciation', 'appropriate', 'approximate',
                'architect', 'argument', 'arrangement', 'artificial', 'assessment', 'assignment', 'assistance', 'association',
                'assumption', 'astonishing', 'atmosphere', 'attachment', 'attention', 'attractive', 'attribute', 'audience',
                'authentic', 'authority', 'automatic', 'automobile', 'availability', 'background', 'beautiful', 'beginning',
                'behavior', 'beneficial', 'biology', 'brilliant', 'calculate', 'campaign', 'candidate', 'capability',
                'capacity', 'carefully', 'celebration', 'challenge', 'championship', 'character', 'characteristic', 'chemical',
                'chocolate', 'circumstance', 'civilization', 'classical', 'classification', 'colleague', 'collection', 'combination',
                'comfortable', 'commercial', 'commission', 'commitment', 'committee', 'communicate', 'community', 'comparison',
                'competition', 'competitive', 'complaint', 'completely', 'complicated', 'component', 'composition', 'comprehensive'
            ]
        };

        // Canvas setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Game state
        let gameState = 'start'; // start, playing, gameOver
        let difficulty = 'medium';
        let currentWord = '';
        let typedText = '';
        let wordQueue = [];
        let score = 0;
        let wordsTyped = 0;
        let correctKeystrokes = 0;
        let totalKeystrokes = 0;
        let combo = 0;
        let maxCombo = 0;
        let startTime = 0;
        let gameTime = 60; // seconds
        let timeRemaining = gameTime;
        let carPosition = 0;
        let carVelocity = 0;
        let targetPosition = 0;
        let particles = [];
        let shakeAmount = 0;
        let lastFrameTime = 0;
        let wrongAttempts = 0;
        const MAX_WRONG = 5;

        // Visual elements
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 8;
                this.vy = (Math.random() - 0.5) * 8 - 2;
                this.life = 1;
                this.color = color;
                this.size = Math.random() * 6 + 3;
            }

            update(dt) {
                this.x += this.vx * dt * 60;
                this.y += this.vy * dt * 60;
                this.vy += 0.3;
                this.life -= dt * 2;
            }

            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        function createParticleBurst(x, y, color, count = 20) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        // Game logic
        function getRandomWord() {
            const pool = wordPools[difficulty];
            return pool[Math.floor(Math.random() * pool.length)];
        }

        function initWordQueue() {
            wordQueue = [];
            for (let i = 0; i < 5; i++) {
                wordQueue.push(getRandomWord());
            }
            currentWord = wordQueue.shift();
            wordQueue.push(getRandomWord());
        }

        function updateWordDisplay() {
            const currentWordEl = document.getElementById('current-word');
            const typedInputEl = document.getElementById('typed-input');
            const nextWordsEl = document.getElementById('next-words');

            // Display current word with colored letters
            let html = '';
            for (let i = 0; i < currentWord.length; i++) {
                const letter = currentWord[i];
                let className = 'letter';

                if (i < typedText.length) {
                    if (typedText[i] === letter) {
                        className += ' correct';
                    } else {
                        className += ' wrong';
                    }
                }

                html += `<span class="${className}">${letter}</span>`;
            }
            currentWordEl.innerHTML = html;

            // Display typed text
            typedInputEl.textContent = typedText;

            // Display next words
            nextWordsEl.innerHTML = wordQueue.slice(0, 4).map(word =>
                `<div class="next-word">${word}</div>`
            ).join('');
        }

        function updateHUD() {
            const elapsed = (Date.now() - startTime) / 1000;
            const wpm = elapsed > 0 ? Math.round((wordsTyped / elapsed) * 60) : 0;
            const accuracy = totalKeystrokes > 0 ? Math.round((correctKeystrokes / totalKeystrokes) * 100) : 100;

            document.getElementById('wpm-display').textContent = wpm;
            document.getElementById('accuracy-display').textContent = accuracy + '%';
            document.getElementById('score-display').textContent = score;
            document.getElementById('time-display').textContent = Math.ceil(timeRemaining);
            document.getElementById('words-display').textContent = wordsTyped;
        }

        function completeWord() {
            playSound('complete');

            // Calculate score with combo multiplier
            const wordScore = currentWord.length * 10 * (1 + combo * 0.1);
            score += Math.round(wordScore);
            wordsTyped++;
            combo++;
            maxCombo = Math.max(maxCombo, combo);

            // Show combo indicator
            if (combo >= 3) {
                const comboEl = document.getElementById('combo-indicator');
                comboEl.textContent = `${combo}x COMBO!`;
                comboEl.style.display = 'block';

                if (combo % 5 === 0) {
                    playSound('combo');
                }

                setTimeout(() => {
                    comboEl.style.display = 'none';
                }, 1000);
            }

            // Update car position
            targetPosition += 50;

            // Create particles at car position
            const carX = canvas.width * 0.2;
            const carY = canvas.height * 0.7;
            createParticleBurst(carX + 30, carY, 'hsl(120, 100%, 60%)', 15);

            // Move to next word
            currentWord = wordQueue.shift();
            wordQueue.push(getRandomWord());
            typedText = '';
            wrongAttempts = 0;
            updateWordDisplay();
        }

        function handleKeyPress(key) {
            if (gameState !== 'playing') return;

            totalKeystrokes++;

            if (key === 'Backspace') {
                typedText = typedText.slice(0, -1);
                updateWordDisplay();
                return;
            }

            if (key.length !== 1) return;

            const expectedChar = currentWord[typedText.length];

            if (key === expectedChar) {
                correctKeystrokes++;
                typedText += key;
                playSound('correct');

                // Flash effect
                document.getElementById('word-display').classList.add('flash');
                setTimeout(() => {
                    document.getElementById('word-display').classList.remove('flash');
                }, 300);

                if (typedText === currentWord) {
                    completeWord();
                } else {
                    updateWordDisplay();
                }
            } else {
                playSound('wrong');
                shakeAmount = 10;
                wrongAttempts++;

                if (wrongAttempts >= MAX_WRONG) {
                    combo = 0;
                    document.getElementById('combo-indicator').style.display = 'none';
                }

                // Add visual feedback to current letter
                updateWordDisplay();
            }

            updateHUD();
        }

        function drawRaceTrack() {
            const w = canvas.width;
            const h = canvas.height;

            // Sky gradient
            const skyGrad = ctx.createLinearGradient(0, 0, 0, h * 0.5);
            skyGrad.addColorStop(0, 'hsl(220, 50%, 20%)');
            skyGrad.addColorStop(1, 'hsl(280, 40%, 30%)');
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, w, h * 0.5);

            // Ground
            const groundGrad = ctx.createLinearGradient(0, h * 0.5, 0, h);
            groundGrad.addColorStop(0, 'hsl(140, 30%, 25%)');
            groundGrad.addColorStop(1, 'hsl(140, 30%, 15%)');
            ctx.fillStyle = groundGrad;
            ctx.fillRect(0, h * 0.5, w, h * 0.5);

            // Track
            const trackY = h * 0.65;
            const trackHeight = h * 0.25;

            // Track background
            ctx.fillStyle = 'hsl(0, 0%, 20%)';
            ctx.fillRect(0, trackY, w, trackHeight);

            // Track lines
            ctx.strokeStyle = 'hsl(45, 100%, 50%)';
            ctx.lineWidth = 3;
            const lineOffset = (Date.now() / 50) % 100;
            for (let i = -100; i < w; i += 100) {
                ctx.beginPath();
                ctx.moveTo(i + lineOffset, trackY + trackHeight / 2);
                ctx.lineTo(i + lineOffset + 50, trackY + trackHeight / 2);
                ctx.stroke();
            }

            // Track edges
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, trackY);
            ctx.lineTo(w, trackY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, trackY + trackHeight);
            ctx.lineTo(w, trackY + trackHeight);
            ctx.stroke();

            // Finish line (moving based on progress)
            const progress = carPosition / 3000;
            const finishX = w * 0.8 - (progress * w * 0.6);

            if (finishX > 0 && finishX < w) {
                ctx.fillStyle = 'white';
                for (let y = 0; y < trackHeight; y += 20) {
                    for (let x = 0; x < 20; x += 20) {
                        if ((x + y) % 40 === 0) {
                            ctx.fillRect(finishX + x, trackY + y, 20, 20);
                        }
                    }
                }
            }
        }

        function drawCar() {
            const carX = canvas.width * 0.2;
            const carY = canvas.height * 0.7;
            const carWidth = 60;
            const carHeight = 30;

            ctx.save();

            // Car body
            const carGrad = ctx.createLinearGradient(carX, carY - carHeight/2, carX, carY + carHeight/2);
            carGrad.addColorStop(0, 'hsl(0, 80%, 60%)');
            carGrad.addColorStop(1, 'hsl(0, 80%, 40%)');
            ctx.fillStyle = carGrad;
            ctx.fillRect(carX, carY - carHeight/2, carWidth, carHeight);

            // Car window
            ctx.fillStyle = 'hsl(200, 50%, 30%)';
            ctx.fillRect(carX + 10, carY - carHeight/2 + 5, carWidth * 0.4, carHeight * 0.5);

            // Wheels
            ctx.fillStyle = 'hsl(0, 0%, 10%)';
            ctx.beginPath();
            ctx.arc(carX + 15, carY + carHeight/2, 8, 0, Math.PI * 2);
            ctx.arc(carX + carWidth - 15, carY + carHeight/2, 8, 0, Math.PI * 2);
            ctx.fill();

            // Speed lines (when moving fast)
            if (carVelocity > 0.5) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 2;
                for (let i = 0; i < 3; i++) {
                    const offset = i * 10;
                    ctx.beginPath();
                    ctx.moveTo(carX - 20 - offset, carY - 10 + i * 10);
                    ctx.lineTo(carX - 40 - offset, carY - 10 + i * 10);
                    ctx.stroke();
                }
            }

            ctx.restore();
        }

        function drawProgress() {
            const barWidth = canvas.width * 0.6;
            const barHeight = 30;
            const barX = canvas.width * 0.2;
            const barY = 50;

            // Progress bar background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(barX, barY, barWidth, barHeight);

            // Progress fill
            const progress = Math.min(carPosition / 3000, 1);
            const fillGrad = ctx.createLinearGradient(barX, 0, barX + barWidth, 0);
            fillGrad.addColorStop(0, 'hsl(120, 80%, 50%)');
            fillGrad.addColorStop(1, 'hsl(180, 80%, 50%)');
            ctx.fillStyle = fillGrad;
            ctx.fillRect(barX, barY, barWidth * progress, barHeight);

            // Progress border
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.strokeRect(barX, barY, barWidth, barHeight);

            // Progress text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`${Math.round(progress * 100)}%`, barX + barWidth / 2, barY + barHeight / 2);
        }

        function gameLoop(timestamp) {
            const dt = lastFrameTime ? Math.min((timestamp - lastFrameTime) / 1000, 0.1) : 0;
            lastFrameTime = timestamp;

            if (gameState === 'playing') {
                // Update time
                timeRemaining -= dt;
                if (timeRemaining <= 0) {
                    endGame();
                    return;
                }

                // Update car physics
                const targetVelocity = (targetPosition - carPosition) * 0.1;
                carVelocity += (targetVelocity - carVelocity) * 0.1;
                carPosition += carVelocity;

                // Decay target position
                targetPosition *= 0.98;

                // Update shake
                shakeAmount *= 0.9;
                if (shakeAmount < 0.1) shakeAmount = 0;

                // Update particles
                particles = particles.filter(p => {
                    p.update(dt);
                    return p.life > 0;
                });

                updateHUD();

                // Check for win condition
                if (carPosition >= 3000) {
                    endGame();
                    return;
                }
            }

            // Clear canvas with shake
            ctx.save();
            ctx.translate(
                (Math.random() - 0.5) * shakeAmount,
                (Math.random() - 0.5) * shakeAmount
            );

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw game elements
            drawRaceTrack();
            drawCar();
            drawProgress();

            // Draw particles
            particles.forEach(p => p.draw(ctx));

            ctx.restore();

            requestAnimationFrame(gameLoop);
        }

        function startGame(selectedDifficulty) {
            difficulty = selectedDifficulty;
            gameState = 'playing';
            score = 0;
            wordsTyped = 0;
            correctKeystrokes = 0;
            totalKeystrokes = 0;
            combo = 0;
            maxCombo = 0;
            carPosition = 0;
            carVelocity = 0;
            targetPosition = 0;
            typedText = '';
            wrongAttempts = 0;
            particles = [];

            gameTime = difficulty === 'easy' ? 90 : difficulty === 'medium' ? 60 : 45;
            timeRemaining = gameTime;
            startTime = Date.now();

            initWordQueue();
            updateWordDisplay();
            updateHUD();

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-over-screen').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('word-display').style.display = 'block';

            initAudio();
        }

        function endGame() {
            gameState = 'gameOver';
            playSound('finish');

            const elapsed = (Date.now() - startTime) / 1000;
            const wpm = elapsed > 0 ? Math.round((wordsTyped / elapsed) * 60) : 0;
            const accuracy = totalKeystrokes > 0 ? Math.round((correctKeystrokes / totalKeystrokes) * 100) : 100;

            document.getElementById('final-wpm').textContent = wpm;
            document.getElementById('final-accuracy').textContent = accuracy + '%';
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-words').textContent = wordsTyped;

            // Save high score
            saveHighScore({ wpm, accuracy, score, words: wordsTyped, difficulty, date: new Date().toISOString() });
            displayHighScores();

            document.getElementById('hud').style.display = 'none';
            document.getElementById('word-display').style.display = 'none';
            document.getElementById('game-over-screen').style.display = 'flex';
        }

        function saveHighScore(scoreData) {
            let scores = JSON.parse(localStorage.getItem('typingRacerScores') || '[]');
            scoreData.id = Date.now();
            scores.push(scoreData);
            scores.sort((a, b) => b.score - a.score);
            scores = scores.slice(0, 10);
            localStorage.setItem('typingRacerScores', JSON.stringify(scores));
        }

        function displayHighScores() {
            const scores = JSON.parse(localStorage.getItem('typingRacerScores') || '[]');
            const scoresList = document.getElementById('scores-list');
            const latestId = scores[0]?.id;

            scoresList.innerHTML = scores.map((s, i) => `
                <div class="score-entry ${s.id === latestId ? 'new' : ''}">
                    <div>#${i + 1} - ${s.difficulty.toUpperCase()}</div>
                    <div>${s.score} pts (${s.wpm} WPM, ${s.accuracy}%)</div>
                </div>
            `).join('') || '<div style="text-align: center; color: hsl(180, 50%, 60%);">No scores yet!</div>';
        }

        // Event listeners
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                startGame(btn.dataset.difficulty);
            });
        });

        document.getElementById('play-again-btn').addEventListener('click', () => {
            document.getElementById('game-over-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
        });

        document.addEventListener('keydown', (e) => {
            if (gameState === 'playing') {
                e.preventDefault();
                handleKeyPress(e.key);
            }
        });

        // Initialize
        displayHighScores();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>