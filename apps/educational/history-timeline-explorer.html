<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="rappterzoo:author" content="molter-engine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="educational_tools">
<meta name="rappterzoo:tags" content="canvas,education,history,quiz,interactive">
<meta name="rappterzoo:type" content="interactive">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-08">
<meta name="rappterzoo:generation" content="1">
<title>History Timeline Explorer - Interactive World History</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Georgia', serif;
  background: #1a1410;
  color: #e8dcc8;
  overflow: hidden;
  user-select: none;
}

#app { display: flex; flex-direction: column; height: 100vh; }

/* Header */
#header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 16px;
  background: linear-gradient(180deg, #2a2018, #1a1410);
  border-bottom: 1px solid #3d3020;
  z-index: 10;
}

#header h1 {
  font-size: 20px;
  background: linear-gradient(90deg, #c9a84c, #e8d5a0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.header-controls {
  display: flex;
  gap: 8px;
  align-items: center;
}

.era-btn {
  padding: 6px 14px;
  background: #2a2018;
  border: 1px solid #4d3d28;
  border-radius: 20px;
  color: #c9a84c;
  font-family: Georgia, serif;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.era-btn:hover { background: #3d3020; border-color: #c9a84c; }
.era-btn.active { background: #4d3820; border-color: #c9a84c; box-shadow: 0 0 8px rgba(201,168,76,0.3); }

.header-stat {
  font-size: 12px;
  color: #8a7a60;
  padding: 4px 10px;
  background: #221a10;
  border-radius: 12px;
}

/* Main area */
#main-area {
  flex: 1;
  display: flex;
  position: relative;
  overflow: hidden;
}

/* Timeline canvas */
#timelineCanvas {
  flex: 1;
  cursor: grab;
}

#timelineCanvas:active { cursor: grabbing; }

/* Side panel */
#side-panel {
  width: 320px;
  background: linear-gradient(180deg, #221a10, #1a1410);
  border-left: 1px solid #3d3020;
  overflow-y: auto;
  padding: 16px;
  transition: transform 0.3s ease;
}

#side-panel.collapsed { transform: translateX(100%); }

#event-detail {
  display: none;
}

#event-detail.active { display: block; }

#event-detail h2 {
  font-size: 18px;
  color: #c9a84c;
  margin-bottom: 4px;
}

#event-detail .event-date {
  font-size: 14px;
  color: #8a7a60;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid #3d3020;
}

#event-detail .event-category {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 10px;
  font-size: 11px;
  margin-bottom: 10px;
}

#event-detail .event-desc {
  font-size: 13px;
  line-height: 1.7;
  color: #c8b898;
  margin-bottom: 16px;
}

#event-detail .event-impact {
  padding: 12px;
  background: #2a2018;
  border-left: 3px solid #c9a84c;
  border-radius: 0 6px 6px 0;
  font-size: 12px;
  line-height: 1.6;
  color: #a89878;
  margin-bottom: 16px;
}

.connections-list {
  margin-top: 12px;
}

.connection-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  margin: 4px 0;
  background: #2a2018;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: background 0.2s;
}

.connection-item:hover { background: #3d3020; }

/* Quiz panel */
#quiz-panel {
  display: none;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 500px;
  max-width: 90%;
  background: #221a10;
  border: 2px solid #c9a84c;
  border-radius: 12px;
  padding: 24px;
  z-index: 50;
  box-shadow: 0 20px 60px rgba(0,0,0,0.8);
}

#quiz-panel.active { display: block; }

#quiz-panel h3 {
  color: #c9a84c;
  margin-bottom: 6px;
  font-size: 14px;
}

#quiz-question {
  font-size: 16px;
  line-height: 1.6;
  margin-bottom: 16px;
  color: #e8dcc8;
}

.quiz-option {
  display: block;
  width: 100%;
  padding: 12px 16px;
  margin: 6px 0;
  background: #2a2018;
  border: 1px solid #4d3d28;
  border-radius: 8px;
  color: #e8dcc8;
  font-family: Georgia, serif;
  font-size: 14px;
  cursor: pointer;
  text-align: left;
  transition: all 0.2s;
}

.quiz-option:hover { background: #3d3020; border-color: #c9a84c; }
.quiz-option.correct { background: #1a3a1a; border-color: #4ade80; color: #4ade80; }
.quiz-option.wrong { background: #3a1a1a; border-color: #ef4444; color: #ef4444; }
.quiz-option:disabled { cursor: default; opacity: 0.7; }

#quiz-feedback {
  margin-top: 12px;
  padding: 10px;
  border-radius: 6px;
  font-size: 13px;
  display: none;
}

#quiz-next {
  margin-top: 12px;
  padding: 8px 20px;
  background: #c9a84c;
  border: none;
  border-radius: 6px;
  color: #1a1410;
  font-family: Georgia, serif;
  font-weight: bold;
  cursor: pointer;
  display: none;
}

#quiz-next:hover { background: #e8d5a0; }

/* Search */
#search-bar {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 20;
}

#search-input {
  width: 250px;
  padding: 8px 12px;
  background: rgba(34,26,16,0.95);
  border: 1px solid #4d3d28;
  border-radius: 20px;
  color: #e8dcc8;
  font-family: Georgia, serif;
  font-size: 13px;
  outline: none;
}

#search-input:focus { border-color: #c9a84c; }

#search-results {
  position: absolute;
  top: 40px;
  left: 0;
  width: 300px;
  background: rgba(34,26,16,0.98);
  border: 1px solid #4d3d28;
  border-radius: 8px;
  max-height: 300px;
  overflow-y: auto;
  display: none;
}

.search-result {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 12px;
  border-bottom: 1px solid #2a2018;
  transition: background 0.15s;
}

.search-result:hover { background: #3d3020; }
.search-result .sr-date { color: #8a7a60; font-size: 11px; }

/* Score display */
#score-display {
  position: absolute;
  top: 10px;
  right: 340px;
  background: rgba(34,26,16,0.95);
  border: 1px solid #4d3d28;
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 13px;
  z-index: 20;
}

/* Mini map */
#minimap {
  position: absolute;
  bottom: 10px;
  left: 10px;
  width: 200px;
  height: 60px;
  background: rgba(34,26,16,0.9);
  border: 1px solid #3d3020;
  border-radius: 6px;
  z-index: 20;
  overflow: hidden;
}

/* Category colors */
.cat-war { color: #ef4444; background: rgba(239,68,68,0.15); border-color: #ef4444; }
.cat-science { color: #3b82f6; background: rgba(59,130,246,0.15); border-color: #3b82f6; }
.cat-culture { color: #a855f7; background: rgba(168,85,247,0.15); border-color: #a855f7; }
.cat-politics { color: #f59e0b; background: rgba(245,158,11,0.15); border-color: #f59e0b; }
.cat-exploration { color: #10b981; background: rgba(16,185,129,0.15); border-color: #10b981; }
.cat-disaster { color: #6b7280; background: rgba(107,114,128,0.15); border-color: #6b7280; }
.cat-religion { color: #ec4899; background: rgba(236,72,153,0.15); border-color: #ec4899; }

/* Responsive */
@media (max-width: 768px) {
  #side-panel { width: 100%; position: absolute; right: 0; top: 0; bottom: 0; z-index: 30; }
  #score-display { right: 10px; top: 50px; }
}
</style>
</head>
<body>
<div id="app">
  <div id="header">
    <h1>History Timeline Explorer</h1>
    <div class="header-controls">
      <button class="era-btn active" data-era="all">All Eras</button>
      <button class="era-btn" data-era="ancient">Ancient</button>
      <button class="era-btn" data-era="classical">Classical</button>
      <button class="era-btn" data-era="medieval">Medieval</button>
      <button class="era-btn" data-era="earlymodern">Early Modern</button>
      <button class="era-btn" data-era="modern">Modern</button>
      <button class="era-btn" data-era="contemporary">Contemporary</button>
      <button class="era-btn" onclick="app.startQuiz()" style="background:#4d3820">Quiz</button>
      <span class="header-stat" id="eventCount">0 Events</span>
    </div>
  </div>

  <div id="main-area">
    <canvas id="timelineCanvas"></canvas>

    <div id="search-bar">
      <input type="text" id="search-input" placeholder="Search events... (/)">
      <div id="search-results"></div>
    </div>

    <div id="score-display">
      Score: <span id="score-value">0</span> | Streak: <span id="streak-value">0</span>
    </div>

    <canvas id="minimap"></canvas>

    <div id="quiz-panel">
      <h3 id="quiz-header">History Quiz</h3>
      <div id="quiz-question"></div>
      <div id="quiz-options"></div>
      <div id="quiz-feedback"></div>
      <button id="quiz-next" onclick="app.nextQuestion()">Next Question</button>
    </div>

    <div id="side-panel">
      <div id="event-detail">
        <h2 id="detail-title"></h2>
        <div class="event-date" id="detail-date"></div>
        <div id="detail-category" class="event-category"></div>
        <div class="event-desc" id="detail-desc"></div>
        <div class="event-impact" id="detail-impact"></div>
        <h3 style="font-size:13px;color:#8a7a60;margin-bottom:8px">Connected Events</h3>
        <div class="connections-list" id="detail-connections"></div>
      </div>
      <div id="panel-placeholder" style="text-align:center;padding-top:60px">
        <p style="color:#8a7a60;font-size:14px">Click an event on the timeline to explore its details</p>
        <p style="color:#5a4a30;font-size:12px;margin-top:8px">Scroll to zoom, drag to pan</p>
        <p style="color:#5a4a30;font-size:12px;margin-top:4px">Press Q to start a quiz</p>
      </div>
    </div>
  </div>
</div>

<script>
// ================================================================
// HISTORY TIMELINE EXPLORER
// ================================================================

// --- Audio Engine ---
class AudioEngine {
  constructor() {
    this.ctx = null;
    this.initialized = false;
  }
  init() {
    if (this.initialized) return;
    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      this.initialized = true;
    } catch(e) {}
  }
  play(freq, dur, type, vol) {
    if (!this.ctx) return;
    const o = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    o.type = type || 'sine';
    o.frequency.value = freq;
    g.gain.setValueAtTime(vol || 0.05, this.ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
    o.connect(g); g.connect(this.ctx.destination);
    o.start(); o.stop(this.ctx.currentTime + dur);
  }
  click() { this.play(600, 0.05, 'triangle', 0.04); }
  hover() { this.play(400, 0.03, 'sine', 0.02); }
  correct() {
    this.play(523, 0.1, 'sine', 0.06);
    setTimeout(() => this.play(659, 0.1, 'sine', 0.06), 80);
    setTimeout(() => this.play(784, 0.15, 'sine', 0.06), 160);
  }
  wrong() { this.play(200, 0.3, 'sawtooth', 0.04); }
  fanfare() {
    [523, 587, 659, 784, 880].forEach((f, i) => {
      setTimeout(() => this.play(f, 0.2, 'sine', 0.05), i * 100);
    });
  }
}

const audio = new AudioEngine();

// --- Historical Events Database ---
const EVENTS = [
  // Ancient
  { id: 1, year: -3100, title: 'Unification of Egypt', category: 'politics', era: 'ancient',
    desc: 'King Narmer (Menes) united Upper and Lower Egypt, founding the First Dynasty and establishing Memphis as the capital. This marked the beginning of one of the most enduring civilizations in history.',
    impact: 'Created a centralized state that would last 3000 years, developed hieroglyphic writing, and built the foundations for monumental architecture.',
    connections: [2, 3] },
  { id: 2, year: -2560, title: 'Great Pyramid of Giza Built', category: 'culture', era: 'ancient',
    desc: 'Pharaoh Khufu commissioned the Great Pyramid, the largest of the three pyramids at Giza. It stood as the tallest man-made structure for over 3,800 years.',
    impact: 'Demonstrated unprecedented engineering capabilities and organizational power. Remains one of the Seven Wonders of the Ancient World.',
    connections: [1, 4] },
  { id: 3, year: -1754, title: 'Code of Hammurabi', category: 'politics', era: 'ancient',
    desc: 'Babylonian King Hammurabi enacted one of the earliest known written legal codes, comprising 282 laws covering trade, property, family, and criminal matters.',
    impact: 'Established the concept of codified law and the principle of "innocent until proven guilty." Influenced legal systems for millennia.',
    connections: [1, 5] },
  { id: 4, year: -1200, title: 'Bronze Age Collapse', category: 'disaster', era: 'ancient',
    desc: 'A catastrophic period saw the simultaneous destruction of multiple Mediterranean civilizations including the Hittites, Mycenaeans, and the disruption of Egypt. Sea Peoples invasions, drought, and trade disruption converged.',
    impact: 'Ended the Bronze Age palace economies. Led to a "Dark Age" but also enabled the rise of new powers like Phoenicia and Israel.',
    connections: [2, 5, 6] },
  { id: 5, year: -776, title: 'First Olympic Games', category: 'culture', era: 'ancient',
    desc: 'The first recorded Olympic Games were held in Olympia, Greece. Athletes competed in a single event: the stadion foot race. The games were held every four years for nearly 1,200 years.',
    impact: 'Established the tradition of peaceful athletic competition. Created a shared Greek cultural identity and the concept of the Olympiad as a time-keeping system.',
    connections: [3, 6, 7] },
  { id: 6, year: -509, title: 'Roman Republic Founded', category: 'politics', era: 'classical',
    desc: 'After overthrowing King Tarquinius Superbus, Rome established a republic with elected magistrates, a Senate, and citizen assemblies. This system of shared power would define Rome for centuries.',
    impact: 'Created the template for republican government that influenced the United States Constitution and modern democracies worldwide.',
    connections: [4, 5, 8, 12] },
  { id: 7, year: -490, title: 'Battle of Marathon', category: 'war', era: 'classical',
    desc: 'Outnumbered Athenian forces defeated the Persian army on the plain of Marathon. Pheidippides allegedly ran 26 miles to Athens to announce victory, inspiring the marathon race.',
    impact: 'Preserved Greek independence and democracy. Demonstrated that citizen-soldiers could defeat professional armies.',
    connections: [5, 6, 8] },
  { id: 8, year: -431, title: 'Peloponnesian War Begins', category: 'war', era: 'classical',
    desc: 'Athens and Sparta, the two most powerful Greek city-states, began a devastating 27-year war that would reshape the Greek world. Thucydides documented it as the first true work of history.',
    impact: 'Weakened all Greek states, enabling the eventual Macedonian conquest. Produced foundational works of history and political philosophy.',
    connections: [6, 7, 9] },
  { id: 9, year: -336, title: 'Alexander the Great Begins Conquest', category: 'war', era: 'classical',
    desc: 'At age 20, Alexander became king of Macedon and launched a campaign that would create one of the largest empires in history, stretching from Greece to India.',
    impact: 'Spread Greek culture across the known world (Hellenization). Founded over 70 cities including Alexandria. His empire fragments created the Hellenistic kingdoms.',
    connections: [8, 10, 11] },
  { id: 10, year: -221, title: 'Qin Shi Huang Unifies China', category: 'politics', era: 'classical',
    desc: 'The First Emperor united the warring states of China, standardized writing, currency, and measurements, and began construction of the Great Wall.',
    impact: 'Created the template for Chinese imperial governance that lasted until 1912. The name "China" derives from "Qin."',
    connections: [9, 11] },
  { id: 11, year: -44, title: 'Assassination of Julius Caesar', category: 'politics', era: 'classical',
    desc: 'Roman dictator Julius Caesar was assassinated by a group of senators on the Ides of March. Rather than restoring the Republic, his death triggered civil wars.',
    impact: 'Led directly to the fall of the Roman Republic and the rise of the Roman Empire under Augustus. Changed the course of Western civilization.',
    connections: [6, 9, 12] },
  { id: 12, year: 27, title: 'Roman Empire Established', category: 'politics', era: 'classical',
    desc: 'Octavian (Augustus) became the first Roman Emperor, ending the Republic. The Pax Romana that followed brought unprecedented peace and prosperity to the Mediterranean world.',
    impact: 'Created 200 years of relative peace. Roman law, engineering, language (Latin), and culture spread across Europe and North Africa.',
    connections: [6, 11, 13, 14] },
  { id: 13, year: 33, title: 'Crucifixion and Rise of Christianity', category: 'religion', era: 'classical',
    desc: 'Jesus of Nazareth was crucified in Jerusalem. His followers spread his teachings, eventually creating one of the world\'s largest religions that would reshape Western civilization.',
    impact: 'Christianity became the dominant religion of the Roman Empire by 380 CE. Shaped Western art, philosophy, law, and social structures for two millennia.',
    connections: [12, 14, 17] },
  { id: 14, year: 476, title: 'Fall of Western Roman Empire', category: 'politics', era: 'medieval',
    desc: 'Germanic chieftain Odoacer deposed the last Western Roman Emperor, Romulus Augustulus. The Eastern Empire (Byzantine) continued for nearly another thousand years.',
    impact: 'Marks the traditional end of antiquity and start of the Middle Ages. Led to political fragmentation of Western Europe and the rise of feudalism.',
    connections: [12, 13, 15, 16] },
  { id: 15, year: 622, title: 'Hijra - Birth of Islam', category: 'religion', era: 'medieval',
    desc: 'Prophet Muhammad migrated from Mecca to Medina, establishing the first Muslim community. This event marks Year 1 of the Islamic calendar.',
    impact: 'Islam rapidly spread across the Middle East, North Africa, and beyond. Created a vast civilization that preserved and advanced Greek and Roman knowledge.',
    connections: [13, 14, 16, 18] },
  { id: 16, year: 800, title: 'Charlemagne Crowned Emperor', category: 'politics', era: 'medieval',
    desc: 'Pope Leo III crowned Charlemagne as Emperor of the Romans on Christmas Day. His Carolingian Empire united much of Western Europe for the first time since Rome.',
    impact: 'Revived the concept of a European empire. The Carolingian Renaissance preserved classical learning. His empire eventually split into France and Germany.',
    connections: [14, 15, 17] },
  { id: 17, year: 1066, title: 'Norman Conquest of England', category: 'war', era: 'medieval',
    desc: 'William the Conqueror defeated King Harold at the Battle of Hastings, becoming King of England. Norman French culture and language merged with Anglo-Saxon traditions.',
    impact: 'Transformed English language, law, and culture. Established feudal system in England. Created enduring ties between England and continental Europe.',
    connections: [13, 16, 18, 19] },
  { id: 18, year: 1096, title: 'First Crusade', category: 'war', era: 'medieval',
    desc: 'Pope Urban II called for a military expedition to recapture Jerusalem from Muslim rule. Thousands of European knights marched east, capturing Jerusalem in 1099.',
    impact: 'Opened cultural and trade exchanges between Europe and the Middle East. Introduced Europeans to advanced Islamic science, medicine, and mathematics.',
    connections: [15, 17, 19] },
  { id: 19, year: 1215, title: 'Magna Carta Signed', category: 'politics', era: 'medieval',
    desc: 'English barons forced King John to sign the Magna Carta, establishing that even the king was subject to law. It guaranteed rights including trial by jury.',
    impact: 'Foundation of constitutional law. Directly influenced the United States Constitution and Bill of Rights. Established the principle of limited government.',
    connections: [17, 18, 20, 22] },
  { id: 20, year: 1347, title: 'Black Death Reaches Europe', category: 'disaster', era: 'medieval',
    desc: 'The bubonic plague arrived in Europe via trade ships from the East. Over the next 5 years, it killed an estimated 30-60% of Europe\'s population.',
    impact: 'Devastated feudalism as labor shortages gave peasants bargaining power. Accelerated the end of the Middle Ages. Changed art, religion, and social structures.',
    connections: [19, 21, 22] },
  { id: 21, year: 1440, title: 'Gutenberg Printing Press', category: 'science', era: 'medieval',
    desc: 'Johannes Gutenberg developed the movable-type printing press in Mainz, Germany. The first major book printed was the Gutenberg Bible around 1455.',
    impact: 'Revolutionized information dissemination. Enabled the Reformation, Scientific Revolution, and spread of literacy. Called the most important invention of the second millennium.',
    connections: [20, 22, 23, 24] },
  { id: 22, year: 1453, title: 'Fall of Constantinople', category: 'war', era: 'earlymodern',
    desc: 'Ottoman Sultan Mehmed II conquered Constantinople, ending the Byzantine Empire after 1,100 years. Greek scholars fled west, bringing classical texts.',
    impact: 'Ended the last remnant of the Roman Empire. Ottoman control of trade routes motivated Europeans to seek sea routes, leading to the Age of Exploration.',
    connections: [19, 20, 21, 23] },
  { id: 23, year: 1492, title: 'Columbus Reaches the Americas', category: 'exploration', era: 'earlymodern',
    desc: 'Christopher Columbus, sailing for Spain, reached the Bahamas, beginning sustained European contact with the Americas. He made four voyages between 1492 and 1504.',
    impact: 'Initiated the Columbian Exchange of plants, animals, and diseases. Led to European colonization of the Americas and devastating impact on indigenous peoples.',
    connections: [21, 22, 24, 25] },
  { id: 24, year: 1517, title: 'Protestant Reformation', category: 'religion', era: 'earlymodern',
    desc: 'Martin Luther posted his 95 Theses on the door of Wittenberg Castle church, challenging Catholic practices especially the sale of indulgences.',
    impact: 'Split Western Christianity permanently. Led to wars of religion but also promoted literacy, individual conscience, and eventually religious tolerance.',
    connections: [21, 23, 25, 26] },
  { id: 25, year: 1543, title: 'Copernicus Publishes Heliocentric Model', category: 'science', era: 'earlymodern',
    desc: 'Nicolaus Copernicus published "De Revolutionibus," proposing that Earth and other planets orbit the Sun. This challenged 1,400 years of Ptolemaic geocentrism.',
    impact: 'Launched the Scientific Revolution. Changed humanity\'s understanding of its place in the universe. Paved the way for Galileo, Kepler, and Newton.',
    connections: [23, 24, 26, 27] },
  { id: 26, year: 1687, title: 'Newton\'s Principia Published', category: 'science', era: 'earlymodern',
    desc: 'Isaac Newton published his laws of motion and universal gravitation. The Principia Mathematica unified celestial and terrestrial mechanics for the first time.',
    impact: 'Foundation of classical physics. Enabled the Industrial Revolution through applied mechanics. Dominated scientific thinking until Einstein.',
    connections: [24, 25, 27, 28] },
  { id: 27, year: 1776, title: 'American Declaration of Independence', category: 'politics', era: 'earlymodern',
    desc: 'The thirteen American colonies declared independence from Britain, asserting that "all men are created equal" with unalienable rights to life, liberty, and pursuit of happiness.',
    impact: 'Created the first modern republic based on Enlightenment principles. Inspired the French Revolution and independence movements worldwide.',
    connections: [25, 26, 28, 29] },
  { id: 28, year: 1789, title: 'French Revolution', category: 'politics', era: 'earlymodern',
    desc: 'The storming of the Bastille marked the beginning of the French Revolution. The monarchy was overthrown, leading to the Declaration of the Rights of Man and radical social change.',
    impact: 'Ended feudalism in France. Spread ideas of democracy, citizenship, and nationalism across Europe. Led to Napoleon and reshaped the continent.',
    connections: [26, 27, 29, 30] },
  { id: 29, year: 1804, title: 'Napoleon Crowned Emperor', category: 'politics', era: 'modern',
    desc: 'Napoleon Bonaparte crowned himself Emperor of France. His wars reshaped Europe\'s political map. The Napoleonic Code reformed legal systems across the continent.',
    impact: 'Spread revolutionary ideals across Europe paradoxically through conquest. The Napoleonic Code remains the basis of civil law in many countries.',
    connections: [28, 30, 31] },
  { id: 30, year: 1859, title: 'Darwin Publishes Origin of Species', category: 'science', era: 'modern',
    desc: 'Charles Darwin published "On the Origin of Species," presenting the theory of evolution by natural selection based on evidence gathered during his voyage on HMS Beagle.',
    impact: 'Revolutionized biology and our understanding of life. Challenged religious orthodoxy. One of the most influential scientific works ever published.',
    connections: [28, 29, 31, 32] },
  { id: 31, year: 1861, title: 'American Civil War Begins', category: 'war', era: 'modern',
    desc: 'Confederate forces attacked Fort Sumter, beginning a four-year war between Northern and Southern states. The war centered on slavery and states\' rights.',
    impact: 'Abolished slavery in the US. Preserved the Union. Demonstrated the devastating potential of industrial warfare. Shaped American identity and ongoing racial tensions.',
    connections: [29, 30, 32, 33] },
  { id: 32, year: 1903, title: 'Wright Brothers First Flight', category: 'science', era: 'modern',
    desc: 'Orville and Wilbur Wright achieved the first sustained, controlled, powered heavier-than-air flight at Kitty Hawk, North Carolina. The flight lasted 12 seconds.',
    impact: 'Launched the aviation age. Transformed warfare, travel, commerce, and the global economy. Led to the space age within 66 years.',
    connections: [30, 31, 33, 34] },
  { id: 33, year: 1914, title: 'World War I Begins', category: 'war', era: 'modern',
    desc: 'The assassination of Archduke Franz Ferdinand triggered a chain of alliances that plunged Europe into total war. Over 16 million died in four years of trench warfare.',
    impact: 'Destroyed four empires (Ottoman, Austro-Hungarian, Russian, German). Created the conditions for WWII. Introduced chemical warfare, tanks, and aerial combat.',
    connections: [31, 32, 34, 35] },
  { id: 34, year: 1917, title: 'Russian Revolution', category: 'politics', era: 'modern',
    desc: 'The Bolsheviks under Lenin seized power in Russia, overthrowing the Provisional Government. This established the world\'s first communist state, the Soviet Union.',
    impact: 'Created the ideological rivalry that defined the 20th century. Inspired communist movements worldwide. Led to the Cold War.',
    connections: [33, 35, 36] },
  { id: 35, year: 1929, title: 'Great Depression Begins', category: 'disaster', era: 'modern',
    desc: 'The Wall Street stock market crashed, triggering the worst economic depression in modern history. Global GDP fell by 15%. Unemployment in the US reached 25%.',
    impact: 'Discredited laissez-faire economics. Led to the New Deal, modern welfare states, and economic regulation. Contributed to the rise of fascism in Europe.',
    connections: [33, 34, 36, 37] },
  { id: 36, year: 1939, title: 'World War II Begins', category: 'war', era: 'modern',
    desc: 'Nazi Germany invaded Poland, beginning the deadliest conflict in human history. Over 70 million people died, including 6 million Jews in the Holocaust.',
    impact: 'Reshaped the global order. Created the United Nations. Launched the nuclear age and Cold War. Led to decolonization of Asia and Africa.',
    connections: [34, 35, 37, 38] },
  { id: 37, year: 1945, title: 'Atomic Bombs Dropped on Japan', category: 'war', era: 'modern',
    desc: 'The United States dropped atomic bombs on Hiroshima and Nagasaki, killing over 200,000 people. Japan surrendered six days later, ending World War II.',
    impact: 'Ushered in the nuclear age. Created the doctrine of Mutually Assured Destruction. Nuclear anxiety shaped culture, politics, and international relations for decades.',
    connections: [35, 36, 38, 39] },
  { id: 38, year: 1947, title: 'Indian Independence', category: 'politics', era: 'contemporary',
    desc: 'India gained independence from British rule through largely nonviolent resistance led by Mahatma Gandhi. The partition created India and Pakistan, causing massive displacement.',
    impact: 'Largest decolonization event. Gandhi\'s methods inspired civil rights movements worldwide. Partition caused one of the largest mass migrations in history.',
    connections: [36, 37, 39, 40] },
  { id: 39, year: 1957, title: 'Sputnik Launches Space Age', category: 'science', era: 'contemporary',
    desc: 'The Soviet Union launched Sputnik 1, the first artificial satellite, into orbit. Its radio signal could be heard worldwide, shocking the West.',
    impact: 'Started the Space Race. Led to the creation of NASA and massive investment in science education. Culminated in the Moon landing 12 years later.',
    connections: [37, 38, 40, 41] },
  { id: 40, year: 1963, title: 'Martin Luther King "I Have a Dream"', category: 'politics', era: 'contemporary',
    desc: 'Martin Luther King Jr. delivered his iconic speech during the March on Washington, calling for racial equality and an end to discrimination before 250,000 people.',
    impact: 'Galvanized the Civil Rights Movement. Led to the Civil Rights Act of 1964 and Voting Rights Act of 1965. Remains one of the most powerful speeches in history.',
    connections: [38, 39, 41, 42] },
  { id: 41, year: 1969, title: 'Moon Landing', category: 'science', era: 'contemporary',
    desc: 'Apollo 11 astronauts Neil Armstrong and Buzz Aldrin became the first humans to walk on the Moon. Armstrong\'s words: "That\'s one small step for man, one giant leap for mankind."',
    impact: 'Peak achievement of the Space Race. Demonstrated human capability for exploration. Provided the famous "Earthrise" photo that catalyzed the environmental movement.',
    connections: [39, 40, 42, 43] },
  { id: 42, year: 1989, title: 'Fall of the Berlin Wall', category: 'politics', era: 'contemporary',
    desc: 'East Germans breached the Berlin Wall, which had divided the city since 1961. Joyful crowds celebrated as the Cold War\'s most visible symbol was demolished.',
    impact: 'Marked the effective end of the Cold War. Led to German reunification and the dissolution of the Soviet Union. Ushered in a new era of globalization.',
    connections: [40, 41, 43, 44] },
  { id: 43, year: 1991, title: 'World Wide Web Goes Public', category: 'science', era: 'contemporary',
    desc: 'Tim Berners-Lee\'s World Wide Web became publicly available. Originally developed at CERN, the web democratized information access and created the digital age.',
    impact: 'Transformed communication, commerce, media, politics, and social interaction. Created the digital economy. Changed how humanity accesses and shares knowledge.',
    connections: [41, 42, 44, 45] },
  { id: 44, year: 2001, title: 'September 11 Attacks', category: 'war', era: 'contemporary',
    desc: 'Al-Qaeda terrorists hijacked four planes, destroying the World Trade Center towers and attacking the Pentagon. Nearly 3,000 people died in the deadliest terrorist attack in history.',
    impact: 'Launched the War on Terror. Changed global security, privacy, and foreign policy. Led to wars in Afghanistan and Iraq lasting two decades.',
    connections: [42, 43, 45] },
  { id: 45, year: 2020, title: 'COVID-19 Pandemic', category: 'disaster', era: 'contemporary',
    desc: 'A novel coronavirus caused a global pandemic, infecting hundreds of millions and killing millions. Governments imposed unprecedented lockdowns that reshaped daily life.',
    impact: 'Accelerated digital transformation. Exposed healthcare inequalities. Changed work culture (remote work). Fastest vaccine development in history (mRNA technology).',
    connections: [43, 44] }
];

// Category metadata
const CATEGORIES = {
  war: { color: '#ef4444', label: 'War & Conflict' },
  science: { color: '#3b82f6', label: 'Science & Technology' },
  culture: { color: '#a855f7', label: 'Culture & Art' },
  politics: { color: '#f59e0b', label: 'Politics & Society' },
  exploration: { color: '#10b981', label: 'Exploration' },
  disaster: { color: '#6b7280', label: 'Disaster & Crisis' },
  religion: { color: '#ec4899', label: 'Religion & Philosophy' }
};

const ERAS = {
  ancient: { start: -3500, end: -500, label: 'Ancient' },
  classical: { start: -500, end: 500, label: 'Classical' },
  medieval: { start: 500, end: 1400, label: 'Medieval' },
  earlymodern: { start: 1400, end: 1800, label: 'Early Modern' },
  modern: { start: 1800, end: 1950, label: 'Modern' },
  contemporary: { start: 1950, end: 2030, label: 'Contemporary' }
};

// --- Main Application ---
class HistoryTimeline {
  constructor() {
    this.canvas = document.getElementById('timelineCanvas');
    this.ctx = this.canvas.getContext('2d');
    this.miniCanvas = document.getElementById('minimap');
    this.miniCtx = this.miniCanvas.getContext('2d');

    this.events = EVENTS;
    this.filteredEvents = EVENTS;
    this.selectedEvent = null;
    this.hoveredEvent = null;
    this.activeEra = 'all';

    // View
    this.viewStart = -3500;
    this.viewEnd = 2050;
    this.viewY = 0;

    // Interaction
    this.isDragging = false;
    this.dragStartX = 0;
    this.dragStartViewStart = 0;
    this.dragStartViewEnd = 0;

    // Quiz
    this.quizActive = false;
    this.quizQuestions = [];
    this.quizIndex = 0;
    this.score = 0;
    this.streak = 0;
    this.bestStreak = 0;
    this.totalAnswered = 0;
    this.totalCorrect = 0;

    // Particles
    this.particles = [];

    // Layout cache
    this.eventPositions = [];

    this.init();
  }

  init() {
    this.resize();
    window.addEventListener('resize', () => this.resize());
    this.setupInput();
    this.loadProgress();
    this.updateEventCount();
    this.animate();
  }

  resize() {
    const area = document.getElementById('main-area');
    this.canvas.width = area.clientWidth - 320;
    this.canvas.height = area.clientHeight;
    this.miniCanvas.width = 200;
    this.miniCanvas.height = 60;
    this.layoutEvents();
  }

  // --- Input ---
  setupInput() {
    this.canvas.addEventListener('mousedown', e => this.onMouseDown(e));
    this.canvas.addEventListener('mousemove', e => this.onMouseMove(e));
    this.canvas.addEventListener('mouseup', () => this.isDragging = false);
    this.canvas.addEventListener('wheel', e => this.onWheel(e));
    this.canvas.addEventListener('click', e => this.onClick(e));

    // Touch
    let touchStartX = 0;
    this.canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      const t = e.touches[0];
      touchStartX = t.clientX;
      this.dragStartViewStart = this.viewStart;
      this.dragStartViewEnd = this.viewEnd;
    });
    this.canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      const t = e.touches[0];
      const dx = t.clientX - touchStartX;
      const range = this.dragStartViewEnd - this.dragStartViewStart;
      const shift = (-dx / this.canvas.width) * range;
      this.viewStart = this.dragStartViewStart + shift;
      this.viewEnd = this.dragStartViewEnd + shift;
      this.layoutEvents();
    });

    // Keyboard
    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT') return;
      if (e.key === '/') { e.preventDefault(); document.getElementById('search-input').focus(); }
      if (e.key === 'q' || e.key === 'Q') this.startQuiz();
      if (e.key === 'Escape') {
        document.getElementById('quiz-panel').classList.remove('active');
        this.quizActive = false;
      }
    });

    // Search
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', () => this.onSearch(searchInput.value));
    searchInput.addEventListener('focus', () => audio.init());

    // Era buttons
    document.querySelectorAll('.era-btn[data-era]').forEach(btn => {
      btn.addEventListener('click', () => {
        audio.init();
        audio.click();
        this.activeEra = btn.dataset.era;
        document.querySelectorAll('.era-btn[data-era]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.filterByEra(btn.dataset.era);
      });
    });
  }

  onMouseDown(e) {
    audio.init();
    this.isDragging = true;
    this.dragStartX = e.clientX;
    this.dragStartViewStart = this.viewStart;
    this.dragStartViewEnd = this.viewEnd;
  }

  onMouseMove(e) {
    if (this.isDragging) {
      const dx = e.clientX - this.dragStartX;
      const range = this.dragStartViewEnd - this.dragStartViewStart;
      const shift = (-dx / this.canvas.width) * range;
      this.viewStart = this.dragStartViewStart + shift;
      this.viewEnd = this.dragStartViewEnd + shift;
      this.layoutEvents();
      return;
    }

    // Check hover
    const rect = this.canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    this.hoveredEvent = null;
    for (const ep of this.eventPositions) {
      const dx = mx - ep.x;
      const dy = my - ep.y;
      if (Math.sqrt(dx * dx + dy * dy) < ep.radius + 4) {
        this.hoveredEvent = ep.event;
        break;
      }
    }

    this.canvas.style.cursor = this.hoveredEvent ? 'pointer' : 'grab';
  }

  onClick(e) {
    if (this.hoveredEvent) {
      audio.click();
      this.selectEvent(this.hoveredEvent);
    }
  }

  onWheel(e) {
    e.preventDefault();
    const rect = this.canvas.getBoundingClientRect();
    const mouseX = (e.clientX - rect.left) / this.canvas.width;
    const range = this.viewEnd - this.viewStart;
    const factor = e.deltaY > 0 ? 1.1 : 0.9;
    const newRange = Math.max(50, Math.min(6000, range * factor));
    const pivot = this.viewStart + range * mouseX;
    this.viewStart = pivot - newRange * mouseX;
    this.viewEnd = pivot + newRange * (1 - mouseX);
    this.layoutEvents();
  }

  // --- Layout ---
  layoutEvents() {
    this.eventPositions = [];
    const w = this.canvas.width;
    const h = this.canvas.height;
    const range = this.viewEnd - this.viewStart;
    const lanes = {};

    this.filteredEvents.forEach(event => {
      const x = ((event.year - this.viewStart) / range) * w;
      if (x < -50 || x > w + 50) return;

      // Find a lane that doesn't overlap
      let lane = 0;
      const cat = event.category;
      if (!lanes[cat]) lanes[cat] = [];

      for (let l = 0; l < 10; l++) {
        const overlaps = lanes[cat].some(ep => Math.abs(ep.x - x) < 40);
        if (!overlaps) { lane = l; break; }
        lane = l + 1;
      }

      const categoryIndex = Object.keys(CATEGORIES).indexOf(cat);
      const baseY = 80 + categoryIndex * 60;
      const y = baseY + lane * 25;
      const radius = event === this.selectedEvent ? 10 : (event === this.hoveredEvent ? 9 : 7);

      this.eventPositions.push({ event, x, y, radius });
      lanes[cat].push({ x, y });
    });
  }

  // --- Filtering ---
  filterByEra(era) {
    if (era === 'all') {
      this.filteredEvents = this.events;
      this.viewStart = -3500;
      this.viewEnd = 2050;
    } else {
      const e = ERAS[era];
      this.filteredEvents = this.events.filter(ev => ev.era === era);
      this.viewStart = e.start - 50;
      this.viewEnd = e.end + 50;
    }
    this.layoutEvents();
    this.updateEventCount();
  }

  onSearch(query) {
    const results = document.getElementById('search-results');
    if (!query.trim()) {
      results.style.display = 'none';
      return;
    }

    const q = query.toLowerCase();
    const matches = this.events.filter(e =>
      e.title.toLowerCase().includes(q) ||
      e.desc.toLowerCase().includes(q) ||
      e.category.includes(q)
    ).slice(0, 8);

    if (matches.length === 0) {
      results.style.display = 'none';
      return;
    }

    results.style.display = 'block';
    results.innerHTML = matches.map(e =>
      `<div class="search-result" onclick="app.selectEvent(app.events.find(ev=>ev.id===${e.id}));document.getElementById('search-results').style.display='none'">
        <div>${e.title}</div>
        <div class="sr-date">${this.formatYear(e.year)} - ${CATEGORIES[e.category].label}</div>
      </div>`
    ).join('');
  }

  // --- Event Selection ---
  selectEvent(event) {
    this.selectedEvent = event;
    document.getElementById('panel-placeholder').style.display = 'none';
    const detail = document.getElementById('event-detail');
    detail.classList.add('active');

    document.getElementById('detail-title').textContent = event.title;
    document.getElementById('detail-date').textContent = this.formatYear(event.year) + ' - ' + ERAS[event.era].label;

    const catEl = document.getElementById('detail-category');
    catEl.textContent = CATEGORIES[event.category].label;
    catEl.className = 'event-category cat-' + event.category;

    document.getElementById('detail-desc').textContent = event.desc;
    document.getElementById('detail-impact').textContent = event.impact;

    // Connections
    const connEl = document.getElementById('detail-connections');
    connEl.innerHTML = event.connections.map(id => {
      const conn = this.events.find(e => e.id === id);
      if (!conn) return '';
      return `<div class="connection-item" onclick="app.selectEvent(app.events.find(e=>e.id===${id}))">
        <span style="color:${CATEGORIES[conn.category].color}">&#9679;</span>
        <span>${conn.title} (${this.formatYear(conn.year)})</span>
      </div>`;
    }).join('');

    // Center view on event
    const range = this.viewEnd - this.viewStart;
    this.viewStart = event.year - range * 0.3;
    this.viewEnd = event.year + range * 0.7;
    this.layoutEvents();

    // Spawn particles
    const ep = this.eventPositions.find(p => p.event === event);
    if (ep) {
      for (let i = 0; i < 15; i++) {
        this.particles.push({
          x: ep.x, y: ep.y,
          vx: (Math.random() - 0.5) * 100,
          vy: (Math.random() - 0.5) * 100,
          life: 1,
          color: CATEGORIES[event.category].color,
          size: 2 + Math.random() * 3
        });
      }
    }
  }

  // --- Quiz System ---
  startQuiz() {
    audio.init();
    this.quizActive = true;
    this.quizQuestions = this.generateQuestions(10);
    this.quizIndex = 0;
    this.streak = 0;
    document.getElementById('quiz-panel').classList.add('active');
    this.showQuestion();
  }

  generateQuestions(count) {
    const questions = [];
    const shuffled = [...this.events].sort(() => Math.random() - 0.5);

    for (let i = 0; i < Math.min(count, shuffled.length); i++) {
      const event = shuffled[i];
      const type = Math.floor(Math.random() * 4);

      if (type === 0) {
        // When did X happen?
        const correctYear = event.year;
        const options = [correctYear];
        while (options.length < 4) {
          const offset = (Math.random() - 0.5) * 500;
          const year = Math.round(correctYear + offset);
          if (!options.includes(year)) options.push(year);
        }
        options.sort(() => Math.random() - 0.5);
        questions.push({
          question: `When did "${event.title}" occur?`,
          options: options.map(y => this.formatYear(y)),
          correct: options.indexOf(correctYear),
          explanation: event.desc.substring(0, 120) + '...',
          eventId: event.id
        });
      } else if (type === 1) {
        // Which came first?
        const other = shuffled[(i + 1) % shuffled.length];
        const first = event.year < other.year ? event : other;
        const second = event.year < other.year ? other : event;
        questions.push({
          question: `Which event happened first?`,
          options: [first.title, second.title, 'They happened the same year', 'Neither is a real event'],
          correct: 0,
          explanation: `${first.title} (${this.formatYear(first.year)}) happened before ${second.title} (${this.formatYear(second.year)}).`,
          eventId: first.id
        });
      } else if (type === 2) {
        // What category?
        const correctCat = event.category;
        const cats = Object.keys(CATEGORIES).filter(c => c !== correctCat).sort(() => Math.random() - 0.5).slice(0, 3);
        cats.push(correctCat);
        cats.sort(() => Math.random() - 0.5);
        questions.push({
          question: `"${event.title}" belongs to which category?`,
          options: cats.map(c => CATEGORIES[c].label),
          correct: cats.indexOf(correctCat),
          explanation: `${event.title} is categorized as ${CATEGORIES[correctCat].label}.`,
          eventId: event.id
        });
      } else {
        // What era?
        const correctEra = event.era;
        const eras = Object.keys(ERAS).filter(e => e !== correctEra).sort(() => Math.random() - 0.5).slice(0, 3);
        eras.push(correctEra);
        eras.sort(() => Math.random() - 0.5);
        questions.push({
          question: `"${event.title}" (${this.formatYear(event.year)}) belongs to which era?`,
          options: eras.map(e => ERAS[e].label),
          correct: eras.indexOf(correctEra),
          explanation: `${event.title} belongs to the ${ERAS[correctEra].label} era (${this.formatYear(ERAS[correctEra].start)} to ${this.formatYear(ERAS[correctEra].end)}).`,
          eventId: event.id
        });
      }
    }
    return questions;
  }

  showQuestion() {
    if (this.quizIndex >= this.quizQuestions.length) {
      this.showQuizResults();
      return;
    }

    const q = this.quizQuestions[this.quizIndex];
    document.getElementById('quiz-header').textContent = `Question ${this.quizIndex + 1} of ${this.quizQuestions.length}`;
    document.getElementById('quiz-question').textContent = q.question;
    document.getElementById('quiz-feedback').style.display = 'none';
    document.getElementById('quiz-next').style.display = 'none';

    const optionsEl = document.getElementById('quiz-options');
    optionsEl.innerHTML = q.options.map((opt, i) =>
      `<button class="quiz-option" onclick="app.answerQuestion(${i})">${opt}</button>`
    ).join('');

    // Highlight connected event on timeline
    const event = this.events.find(e => e.id === q.eventId);
    if (event) {
      const range = this.viewEnd - this.viewStart;
      this.viewStart = event.year - range * 0.3;
      this.viewEnd = event.year + range * 0.7;
      this.layoutEvents();
    }
  }

  answerQuestion(index) {
    const q = this.quizQuestions[this.quizIndex];
    const options = document.querySelectorAll('.quiz-option');
    options.forEach(o => o.disabled = true);

    const feedback = document.getElementById('quiz-feedback');
    feedback.style.display = 'block';

    if (index === q.correct) {
      options[index].classList.add('correct');
      this.streak++;
      this.totalCorrect++;
      const points = 10 * (1 + Math.floor(this.streak / 3));
      this.score += points;
      feedback.textContent = `Correct! +${points} points. ${q.explanation}`;
      feedback.style.background = 'rgba(74, 222, 128, 0.1)';
      feedback.style.color = '#4ade80';
      audio.correct();
    } else {
      options[index].classList.add('wrong');
      options[q.correct].classList.add('correct');
      this.streak = 0;
      feedback.textContent = `Incorrect. ${q.explanation}`;
      feedback.style.background = 'rgba(239, 68, 68, 0.1)';
      feedback.style.color = '#ef4444';
      audio.wrong();
    }

    this.totalAnswered++;
    if (this.streak > this.bestStreak) this.bestStreak = this.streak;
    this.updateScoreDisplay();
    document.getElementById('quiz-next').style.display = 'inline-block';
  }

  nextQuestion() {
    this.quizIndex++;
    this.showQuestion();
  }

  showQuizResults() {
    const panel = document.getElementById('quiz-panel');
    const pct = Math.round((this.totalCorrect / Math.max(1, this.totalAnswered)) * 100);

    panel.innerHTML = `
      <h3>Quiz Complete!</h3>
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:48px;color:#c9a84c">${this.score}</div>
        <div style="color:#8a7a60">Total Score</div>
        <div style="margin-top:16px;font-size:14px">
          ${this.totalCorrect}/${this.totalAnswered} correct (${pct}%)<br>
          Best streak: ${this.bestStreak}
        </div>
        <div style="margin-top:20px">
          <button class="era-btn" onclick="app.startQuiz()">Play Again</button>
          <button class="era-btn" onclick="document.getElementById('quiz-panel').classList.remove('active')">Close</button>
        </div>
      </div>
    `;
    audio.fanfare();
    this.saveProgress();
  }

  updateScoreDisplay() {
    document.getElementById('score-value').textContent = this.score;
    document.getElementById('streak-value').textContent = this.streak;
  }

  // --- Rendering ---
  draw() {
    const ctx = this.ctx;
    const w = this.canvas.width;
    const h = this.canvas.height;

    // Background
    ctx.fillStyle = '#1a1410';
    ctx.fillRect(0, 0, w, h);

    // Draw era backgrounds
    this.drawEraBands(ctx, w, h);

    // Draw timeline axis
    this.drawAxis(ctx, w, h);

    // Draw connection lines
    if (this.selectedEvent) {
      this.drawConnections(ctx);
    }

    // Draw events
    this.eventPositions.forEach(ep => this.drawEvent(ctx, ep));

    // Draw particles
    this.particles.forEach(p => {
      ctx.globalAlpha = p.life;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
    });
    ctx.globalAlpha = 1;

    // Draw minimap
    this.drawMinimap();
  }

  drawEraBands(ctx, w, h) {
    const range = this.viewEnd - this.viewStart;
    const eraColors = {
      ancient: 'rgba(139, 92, 246, 0.03)',
      classical: 'rgba(59, 130, 246, 0.03)',
      medieval: 'rgba(245, 158, 11, 0.03)',
      earlymodern: 'rgba(16, 185, 129, 0.03)',
      modern: 'rgba(239, 68, 68, 0.03)',
      contemporary: 'rgba(168, 85, 247, 0.03)'
    };

    Object.entries(ERAS).forEach(([key, era]) => {
      const x1 = ((era.start - this.viewStart) / range) * w;
      const x2 = ((era.end - this.viewStart) / range) * w;
      if (x2 < 0 || x1 > w) return;

      ctx.fillStyle = eraColors[key] || 'rgba(255,255,255,0.02)';
      ctx.fillRect(Math.max(0, x1), 0, Math.min(x2, w) - Math.max(0, x1), h);

      // Era label
      const labelX = Math.max(10, x1 + 10);
      if (labelX < w - 50) {
        ctx.fillStyle = '#3d3020';
        ctx.font = '11px Georgia';
        ctx.fillText(era.label, labelX, 20);
      }
    });
  }

  drawAxis(ctx, w, h) {
    const range = this.viewEnd - this.viewStart;

    // Category lanes
    Object.entries(CATEGORIES).forEach(([key, cat], i) => {
      const y = 80 + i * 60;
      ctx.strokeStyle = 'rgba(61, 48, 32, 0.3)';
      ctx.setLineDash([2, 4]);
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(w, y);
      ctx.stroke();
      ctx.setLineDash([]);

      ctx.fillStyle = cat.color;
      ctx.globalAlpha = 0.4;
      ctx.font = '10px Georgia';
      ctx.fillText(cat.label, 5, y - 5);
      ctx.globalAlpha = 1;
    });

    // Time markers
    let interval = 100;
    if (range < 200) interval = 10;
    else if (range < 500) interval = 25;
    else if (range < 1000) interval = 50;
    else if (range < 3000) interval = 100;
    else interval = 500;

    const startYear = Math.ceil(this.viewStart / interval) * interval;
    ctx.fillStyle = '#5a4a30';
    ctx.font = '11px Georgia';
    ctx.textAlign = 'center';

    for (let year = startYear; year <= this.viewEnd; year += interval) {
      const x = ((year - this.viewStart) / range) * w;
      if (x < 0 || x > w) continue;

      ctx.strokeStyle = 'rgba(61, 48, 32, 0.2)';
      ctx.beginPath();
      ctx.moveTo(x, 30);
      ctx.lineTo(x, h);
      ctx.stroke();

      ctx.fillText(this.formatYear(year), x, h - 5);
    }
    ctx.textAlign = 'left';
  }

  drawEvent(ctx, ep) {
    const cat = CATEGORIES[ep.event.category];
    const isSelected = ep.event === this.selectedEvent;
    const isHovered = ep.event === this.hoveredEvent;

    // Glow
    if (isSelected || isHovered) {
      const gradient = ctx.createRadialGradient(ep.x, ep.y, 0, ep.x, ep.y, 25);
      gradient.addColorStop(0, cat.color + '40');
      gradient.addColorStop(1, cat.color + '00');
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(ep.x, ep.y, 25, 0, Math.PI * 2);
      ctx.fill();
    }

    // Event dot
    ctx.fillStyle = cat.color;
    ctx.beginPath();
    ctx.arc(ep.x, ep.y, ep.radius, 0, Math.PI * 2);
    ctx.fill();

    // Border
    ctx.strokeStyle = isSelected ? '#e8dcc8' : cat.color;
    ctx.lineWidth = isSelected ? 2 : 1;
    ctx.stroke();

    // Label
    if (ep.radius > 6 || isHovered || isSelected) {
      ctx.fillStyle = '#e8dcc8';
      ctx.font = (isSelected ? 'bold ' : '') + '11px Georgia';
      ctx.textAlign = 'center';
      const maxLabelWidth = 120;
      let label = ep.event.title;
      if (ctx.measureText(label).width > maxLabelWidth) {
        while (ctx.measureText(label + '...').width > maxLabelWidth && label.length > 5) {
          label = label.substring(0, label.length - 1);
        }
        label += '...';
      }
      ctx.fillText(label, ep.x, ep.y - ep.radius - 6);

      ctx.fillStyle = '#8a7a60';
      ctx.font = '9px Georgia';
      ctx.fillText(this.formatYear(ep.event.year), ep.x, ep.y + ep.radius + 14);
      ctx.textAlign = 'left';
    }
  }

  drawConnections(ctx) {
    if (!this.selectedEvent) return;
    const selPos = this.eventPositions.find(p => p.event === this.selectedEvent);
    if (!selPos) return;

    this.selectedEvent.connections.forEach(connId => {
      const connPos = this.eventPositions.find(p => p.event.id === connId);
      if (!connPos) return;

      const cat = CATEGORIES[this.selectedEvent.category];
      ctx.strokeStyle = cat.color + '60';
      ctx.lineWidth = 1.5;
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(selPos.x, selPos.y);

      // Curved line
      const midX = (selPos.x + connPos.x) / 2;
      const midY = Math.min(selPos.y, connPos.y) - 30;
      ctx.quadraticCurveTo(midX, midY, connPos.x, connPos.y);
      ctx.stroke();
      ctx.setLineDash([]);
    });
  }

  drawMinimap() {
    const ctx = this.miniCtx;
    const w = 200;
    const h = 60;
    const fullStart = -3500;
    const fullEnd = 2050;
    const fullRange = fullEnd - fullStart;

    ctx.fillStyle = 'rgba(34,26,16,0.9)';
    ctx.fillRect(0, 0, w, h);

    // Events as dots
    this.events.forEach(event => {
      const x = ((event.year - fullStart) / fullRange) * w;
      const cat = CATEGORIES[event.category];
      ctx.fillStyle = cat.color;
      ctx.globalAlpha = 0.6;
      ctx.fillRect(x, 10, 2, h - 20);
    });
    ctx.globalAlpha = 1;

    // View window
    const vx1 = ((this.viewStart - fullStart) / fullRange) * w;
    const vx2 = ((this.viewEnd - fullStart) / fullRange) * w;
    ctx.strokeStyle = '#c9a84c';
    ctx.lineWidth = 1;
    ctx.strokeRect(Math.max(0, vx1), 2, Math.min(w, vx2) - Math.max(0, vx1), h - 4);
    ctx.fillStyle = 'rgba(201,168,76,0.1)';
    ctx.fillRect(Math.max(0, vx1), 2, Math.min(w, vx2) - Math.max(0, vx1), h - 4);
  }

  // --- Utilities ---
  formatYear(year) {
    if (year < 0) return Math.abs(year) + ' BCE';
    return year + ' CE';
  }

  updateEventCount() {
    document.getElementById('eventCount').textContent = this.filteredEvents.length + ' Events';
  }

  // --- Persistence ---
  saveProgress() {
    localStorage.setItem('historyTimeline_save', JSON.stringify({
      score: this.score,
      totalAnswered: this.totalAnswered,
      totalCorrect: this.totalCorrect,
      bestStreak: this.bestStreak
    }));
  }

  loadProgress() {
    const saved = localStorage.getItem('historyTimeline_save');
    if (saved) {
      try {
        const data = JSON.parse(saved);
        this.score = data.score || 0;
        this.totalAnswered = data.totalAnswered || 0;
        this.totalCorrect = data.totalCorrect || 0;
        this.bestStreak = data.bestStreak || 0;
        this.updateScoreDisplay();
      } catch(e) {}
    }
  }

  // --- Animation ---
  animate() {
    const now = performance.now();
    const dt = Math.min(0.05, (now - (this.lastFrame || now)) / 1000);
    this.lastFrame = now;

    // Update particles
    this.particles = this.particles.filter(p => {
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.vy += 50 * dt;
      p.life -= dt * 1.5;
      return p.life > 0;
    });

    this.draw();
    requestAnimationFrame(() => this.animate());
  }
}

// Initialize
const app = new HistoryTimeline();
window.app = app;
</script>
</body>
</html>