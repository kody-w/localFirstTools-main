<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antikythera Mechanism Simulator</title>
    <meta name="description" content="Interactive simulation of the ancient Greek astronomical computer with accurate gear trains, zodiac tracking, eclipse prediction, and rich historical context">
    <meta name="rappterzoo:category" content="educational">
    <meta name="rappterzoo:title" content="Antikythera Mechanism Simulator">
    <meta name="rappterzoo:description" content="Interactive simulation of the ancient Greek astronomical computer with accurate gear trains, zodiac tracking, eclipse prediction, and rich historical context">
    <meta name="rappterzoo:tags" content="astronomy,history,ancient-greece,gears,eclipse,educational,simulation">
    <meta name="rappterzoo:experience" content="discovery,wonder,awe">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0d1210;
            min-height: 100vh;
            font-family: Georgia, 'Times New Roman', serif;
            color: #b8a060;
            overflow: hidden;
            user-select: none;
        }
        canvas#main {
            position: fixed;
            top: 0;
            left: 0;
        }
        .panel {
            position: fixed;
            background: rgba(18,24,18,0.94);
            padding: 18px;
            border-radius: 10px;
            border: 2px solid rgba(112,88,48,0.5);
            z-index: 10;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.4), 0 4px 20px rgba(0,0,0,0.5);
            max-height: calc(100vh - 32px);
            overflow-y: auto;
        }
        .panel::-webkit-scrollbar { width: 4px; }
        .panel::-webkit-scrollbar-thumb { background: rgba(112,88,48,0.4); border-radius: 2px; }
        #controls { left: 16px; top: 16px; width: 228px; }
        #sky-panel { right: 16px; top: 16px; width: 258px; }
        h2 {
            font-size: 15px; color: #d4b870; margin-bottom: 12px;
            text-transform: uppercase; letter-spacing: 2px; font-weight: normal;
        }
        h3 {
            font-size: 11px; color: #c0a050; margin: 14px 0 8px;
            text-transform: uppercase; letter-spacing: 1px; font-weight: normal;
        }
        .info-row { margin: 8px 0; font-size: 13px; }
        .lbl { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; }
        .val { font-size: 16px; color: #d4b870; display: block; margin-top: 2px; }
        button {
            display: block; width: 100%; padding: 8px; margin: 4px 0;
            background: linear-gradient(180deg, rgba(74,58,32,0.7), rgba(58,42,21,0.7));
            border: 1px solid rgba(112,88,48,0.5); color: #d4b870; cursor: pointer;
            border-radius: 5px; font-family: inherit; font-size: 11px;
            text-transform: uppercase; letter-spacing: 1px; transition: background 0.2s;
        }
        button:hover { background: linear-gradient(180deg, rgba(94,78,42,0.8), rgba(74,58,32,0.8)); }
        .btn-row { display: flex; gap: 5px; }
        .btn-row button { flex: 1; }
        .speed-row { display: flex; align-items: center; gap: 6px; margin: 8px 0; }
        .speed-row label { font-size: 10px; opacity: 0.7; white-space: nowrap; }
        .speed-row input { flex: 1; }
        input[type="range"] {
            -webkit-appearance: none; height: 5px;
            background: rgba(112,88,48,0.3); border-radius: 3px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px;
            background: #c0a040; border-radius: 50%; cursor: pointer;
        }
        .gear-list { margin: 8px 0; }
        .gear-item {
            display: flex; align-items: center; gap: 8px; padding: 4px 0;
            font-size: 11px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;
        }
        .gear-item:hover, .gear-item.active { opacity: 1; }
        .gear-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        #date-bar {
            position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
            background: rgba(18,24,18,0.94); padding: 14px 30px; border-radius: 10px;
            border: 2px solid rgba(112,88,48,0.5); text-align: center; z-index: 10;
        }
        #date-text { font-size: 20px; color: #d4b870; letter-spacing: 1px; }
        #date-sub { font-size: 11px; opacity: 0.5; margin-top: 4px; }
        .eclipse-warn {
            background: rgba(200,60,40,0.15); border: 1px solid rgba(200,80,60,0.4);
            padding: 8px; border-radius: 6px; margin: 8px 0; text-align: center;
            font-size: 12px; color: #e08060; display: none;
        }
        .eclipse-warn.show { display: block; animation: epulse 1.5s infinite; }
        @keyframes epulse { 0%,100% { opacity: 0.7; } 50% { opacity: 1; } }
        .learn-toggle { cursor: pointer; font-size: 11px; color: #a09050; margin-top: 14px; display: block; }
        .learn-box {
            display: none; font-size: 10px; line-height: 1.7; opacity: 0.8;
            margin-top: 8px; padding: 10px; background: rgba(30,25,15,0.5); border-radius: 6px;
        }
        .learn-box.open { display: block; }
        .learn-box h4 { color: #d4b870; margin: 10px 0 4px; font-size: 11px; }
        .moon-vis { text-align: center; margin: 8px 0; }
        .paused-label {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
            font-size: 32px; color: rgba(212,184,112,0.35); pointer-events: none;
            z-index: 20; display: none; letter-spacing: 6px;
        }
    </style>
</head>
<body>
    <canvas id="main"></canvas>
    <div class="panel" id="controls">
        <h2>&#9881; Antikythera</h2>
        <h3>Time Control</h3>
        <div class="btn-row">
            <button id="btn-play">&#9654; Play</button>
            <button id="btn-stop">&#9208; Pause</button>
        </div>
        <div class="speed-row">
            <label>Speed</label>
            <input type="range" id="spd" min="0" max="100" value="30">
            <span id="spd-val" style="font-size:10px;min-width:50px;text-align:right">1 mo/s</span>
        </div>
        <div class="btn-row">
            <button id="b-day">+1 Day</button>
            <button id="b-month">+1 Month</button>
        </div>
        <div class="btn-row">
            <button id="b-year">+1 Year</button>
            <button id="b-oly">+Olympiad</button>
        </div>
        <div class="btn-row">
            <button id="b-saros">+1 Saros</button>
            <button id="b-reset">Reset 100 BCE</button>
        </div>
        <h3>Gear Train</h3>
        <div class="gear-list" id="gearlist"></div>
        <button id="b-xray">Toggle X-Ray View</button>
        <span class="learn-toggle" id="ltoggle">&#9654; History &amp; Science</span>
        <div class="learn-box" id="lbox">
            <h4>&#127963; Discovery</h4>
            <p>In 1901, sponge divers off the Greek island of Antikythera discovered corroded bronze fragments in a Roman-era shipwreck dating to roughly 70-60 BCE. It took decades before researchers understood they had found the world's first known analog computer.</p>
            <h4>&#9881; What It Computed</h4>
            <p>The mechanism tracked the Sun's position through the zodiac, the Moon's position and phase, predicted solar and lunar eclipses via the Saros cycle (223 synodic months, approximately 18 years), and counted Olympiad years (the 4-year cycle of the ancient Olympic Games). It encoded centuries of Babylonian astronomical knowledge into bronze gears.</p>
            <h4>&#128290; The Gear Ratios</h4>
            <p>The genius lies in encoding astronomical cycles as precise gear ratios. The Metonic cycle (235 lunar months equals 19 solar years) was encoded with a 127-tooth gear driving a 235-tooth gear. The Saros eclipse cycle uses 223 synodic months. These ratios, discovered by Babylonian astronomers, predicted celestial events with remarkable accuracy.</p>
            <h4>&#128300; Key Researchers</h4>
            <p>Derek de Solla Price published the first major analysis in 1959, calling it an ancient Greek computer. The Antikythera Mechanism Research Project (2005-present) used X-ray computed tomography to read inscriptions hidden inside the corroded fragments, revealing the full scope and sophistication of the device.</p>
            <h4>&#128161; Significance</h4>
            <p>Nothing of comparable mechanical complexity is known from the ancient world. It represents a level of sophistication not seen again until medieval astronomical clocks appeared over 1,000 years later. It fundamentally changed our understanding of ancient Greek technological capability and is considered one of the most important archaeological discoveries ever made.</p>
        </div>
    </div>
    <div class="panel" id="sky-panel">
        <h2>&#9789; Sky View</h2>
        <canvas id="skyc" width="222" height="222" style="width:222px;height:222px;display:block;margin:0 auto"></canvas>
        <div class="info-row"><div class="lbl">Sun Position</div><div class="val" id="d-sun">0&deg; Aries</div></div>
        <div class="info-row"><div class="lbl">Moon Position</div><div class="val" id="d-moon">0&deg; Aries</div></div>
        <div class="info-row"><div class="lbl">Moon Phase</div><div class="val" id="d-phase">New Moon</div></div>
        <div class="moon-vis"><canvas id="moonc" width="60" height="60" style="width:60px;height:60px"></canvas></div>
        <div class="eclipse-warn" id="ecl-warn">&#9888; ECLIPSE APPROACHING<div id="ecl-det" style="font-size:10px;margin-top:4px"></div></div>
        <div class="info-row"><div class="lbl">Next Eclipse Window</div><div class="val" id="d-ecl">--</div></div>
        <div class="info-row"><div class="lbl">Olympiad</div><div class="val" id="d-oly">--</div></div>
        <div class="info-row"><div class="lbl">Metonic Year</div><div class="val" id="d-met">--</div></div>
    </div>
    <div id="date-bar">
        <div id="date-text">January, 100 BCE</div>
        <div id="date-sub">Day 0 &middot; Drag gears or use arrow keys to advance time</div>
    </div>
    <div class="paused-label" id="plabel">PAUSED</div>
    <script>
    (function() {
        'use strict';

        // === Canvas Setup ===
        var MC = document.getElementById('main');
        var G = MC.getContext('2d');
        var W, H;
        function resize() { W = MC.width = innerWidth; H = MC.height = innerHeight; }
        resize();
        window.addEventListener('resize', resize);

        // === Astronomical Constants (in days) ===
        var SYNODIC = 29.53059;
        var SIDEREAL = 27.32166;
        var DRACONIC = 27.21222;
        var YEAR = 365.24219;
        var SAROS = 223 * SYNODIC;
        var METONIC = 235 * SYNODIC;
        var OLY = 4 * YEAR;
        var CALLIPPIC = 76 * YEAR;
        var EXELIGMOS = 3 * SAROS;

        // === State ===
        var days = 0;
        var playing = false;
        var speed = 30;
        var xrayMode = false;
        var selGear = -1;
        var isDrag = false;
        var lastDX = 0;

        // === Data Tables ===
        var ZODIAC = [
            {n:'Aries',s:'\u2648'}, {n:'Taurus',s:'\u2649'}, {n:'Gemini',s:'\u264A'},
            {n:'Cancer',s:'\u264B'}, {n:'Leo',s:'\u264C'}, {n:'Virgo',s:'\u264D'},
            {n:'Libra',s:'\u264E'}, {n:'Scorpio',s:'\u264F'}, {n:'Sagittarius',s:'\u2650'},
            {n:'Capricorn',s:'\u2651'}, {n:'Aquarius',s:'\u2652'}, {n:'Pisces',s:'\u2653'}
        ];
        var MONTHS = ['January','February','March','April','May','June',
                      'July','August','September','October','November','December'];
        var MPHASES = ['New Moon','Waxing Crescent','First Quarter','Waxing Gibbous',
                       'Full Moon','Waning Gibbous','Last Quarter','Waning Crescent'];

        // === Gear Definitions ===
        var gears = [
            {name:'Solar Cycle', per:YEAR, teeth:48, col:'#d4a030',
             desc:'1 rotation = 1 tropical year (365.24 days). The primary drive gear that sets the pace for all others.'},
            {name:'Lunar Synodic', per:SYNODIC, teeth:36, col:'#a0a0c0',
             desc:'1 rotation = 1 synodic month (29.53 days). Tracks the cycle of Moon phases from new to full and back.'},
            {name:'Lunar Node', per:DRACONIC, teeth:32, col:'#8090b0',
             desc:'1 rotation = 1 draconic month (27.21 days). Tracks the lunar nodes where eclipses become possible.'},
            {name:'Metonic (19yr)', per:METONIC, teeth:54, col:'#70a070',
             desc:'The Metonic cycle: 19 solar years = 235 synodic months. After one Metonic cycle, the Moon phases recur on the same calendar dates.'},
            {name:'Saros Eclipse', per:SAROS, teeth:44, col:'#c06040',
             desc:'223 synodic months (18.03 years). After one Saros, nearly identical eclipses recur at shifted longitudes.'},
            {name:'Exeligmos', per:EXELIGMOS, teeth:40, col:'#906050',
             desc:'Triple Saros (54.09 years). Returns eclipses to approximately the same geographical longitude.'},
            {name:'Olympiad', per:OLY, teeth:30, col:'#60a060',
             desc:'4-year cycle of the ancient Olympic Games, used as a chronological reference throughout the Greek world.'},
            {name:'Callippic', per:CALLIPPIC, teeth:50, col:'#808060',
             desc:'76-year refined calendar cycle (4 Metonic cycles minus 1 day). A more accurate long-term calendar correction.'}
        ];

        // Responsive gear layout
        function layoutGears() {
            var cx = W/2 - 20, cy = H/2;
            var br = Math.min(W, H) * 0.055;
            var pos = [
                [cx, cy, br*1.4],
                [cx + br*3.2, cy - br*0.8, br],
                [cx + br*3.2, cy + br*1.8, br*0.9],
                [cx - br*3.4, cy - br*1.5, br*1.2],
                [cx - br*3.0, cy + br*2.0, br*1.1],
                [cx - br*0.5, cy + br*3.3, br*0.95],
                [cx + br*2.5, cy + br*3.3, br*0.85],
                [cx - br*3.5, cy + br*3.9, br*1.05]
            ];
            for (var i = 0; i < gears.length; i++) {
                gears[i].x = pos[i][0];
                gears[i].y = pos[i][1];
                gears[i].r = pos[i][2];
            }
        }

        // === Background Stars ===
        var bgStars = [];
        for (var i = 0; i < 130; i++) {
            bgStars.push({
                x: Math.random(), y: Math.random(),
                rad: Math.random() * 1.3,
                alpha: Math.random() * 0.25 + 0.05
            });
        }

        // === Drawing: Background ===
        function drawBackground() {
            var grad = G.createRadialGradient(W/2, H/2, 0, W/2, H/2, Math.max(W,H)*0.7);
            grad.addColorStop(0, '#161e18');
            grad.addColorStop(1, '#0a100c');
            G.fillStyle = grad;
            G.fillRect(0, 0, W, H);

            for (var i = 0; i < bgStars.length; i++) {
                var s = bgStars[i];
                G.beginPath();
                G.arc(s.x * W, s.y * H, s.rad, 0, Math.PI * 2);
                G.fillStyle = 'rgba(180,170,140,' + s.alpha + ')';
                G.fill();
            }

            layoutGears();

            // Housing circle
            var cx = W/2 - 20, cy = H/2;
            var hr = Math.min(W, H) * 0.42;
            G.beginPath();
            G.arc(cx, cy, hr, 0, Math.PI * 2);
            G.fillStyle = 'rgba(40,38,28,0.3)';
            G.fill();
            G.strokeStyle = 'rgba(112,88,48,0.35)';
            G.lineWidth = 4;
            G.stroke();

            // Month markers
            for (var i = 0; i < 12; i++) {
                var a = (i/12) * Math.PI * 2 - Math.PI/2;
                G.fillStyle = 'rgba(180,160,100,0.4)';
                G.font = '11px Georgia';
                G.textAlign = 'center';
                G.textBaseline = 'middle';
                G.fillText(MONTHS[i].substring(0,3).toUpperCase(),
                    cx + Math.cos(a) * (hr - 20), cy + Math.sin(a) * (hr - 20));
            }

            // Decorative tick marks around housing
            for (var i = 0; i < 72; i++) {
                var a = (i/72) * Math.PI * 2;
                G.beginPath();
                G.moveTo(cx + Math.cos(a) * (hr - 8), cy + Math.sin(a) * (hr - 8));
                G.lineTo(cx + Math.cos(a) * (hr - 3), cy + Math.sin(a) * (hr - 3));
                G.strokeStyle = 'rgba(112,88,48,0.2)';
                G.lineWidth = 1;
                G.stroke();
            }
        }

        // === Drawing: Axles ===
        function drawAxles() {
            var conn = [[0,1],[0,2],[0,3],[0,4],[4,5],[0,6],[3,7]];
            for (var c = 0; c < conn.length; c++) {
                var ga = gears[conn[c][0]], gb = gears[conn[c][1]];
                // Shadow
                if (!xrayMode) {
                    G.beginPath();
                    G.moveTo(ga.x + 1, ga.y + 1);
                    G.lineTo(gb.x + 1, gb.y + 1);
                    G.strokeStyle = 'rgba(0,0,0,0.1)';
                    G.lineWidth = 5;
                    G.stroke();
                }
                G.beginPath();
                G.moveTo(ga.x, ga.y);
                G.lineTo(gb.x, gb.y);
                if (xrayMode) {
                    G.strokeStyle = 'rgba(112,88,48,0.4)';
                    G.lineWidth = 1;
                    G.setLineDash([6, 4]);
                } else {
                    G.strokeStyle = 'rgba(112,88,48,0.2)';
                    G.lineWidth = 4;
                    G.setLineDash([]);
                }
                G.stroke();
                G.setLineDash([]);
            }
        }

        // === Drawing: Individual Gear ===
        function drawOneGear(g, idx) {
            var ang = (days / g.per) * Math.PI * 2;
            var sel = idx === selGear;

            G.save();
            G.translate(g.x, g.y);
            G.rotate(ang);

            if (xrayMode) {
                // Schematic mode
                G.beginPath();
                G.arc(0, 0, g.r, 0, Math.PI * 2);
                G.strokeStyle = g.col;
                G.lineWidth = sel ? 3 : 1.5;
                G.setLineDash([4, 4]);
                G.stroke();
                G.setLineDash([]);

                for (var i = 0; i < g.teeth; i++) {
                    var ta = (i / g.teeth) * Math.PI * 2;
                    G.beginPath();
                    G.moveTo(Math.cos(ta) * (g.r - 3), Math.sin(ta) * (g.r - 3));
                    G.lineTo(Math.cos(ta) * (g.r + 5), Math.sin(ta) * (g.r + 5));
                    G.strokeStyle = g.col;
                    G.lineWidth = 1;
                    G.stroke();
                }

                G.beginPath();
                G.moveTo(0, 0);
                G.lineTo(0, -g.r + 10);
                G.strokeStyle = g.col;
                G.lineWidth = 2;
                G.stroke();
            } else {
                // Realistic bronze gear

                // Body with gradient
                var bg = G.createRadialGradient(0, 0, 0, 0, 0, g.r);
                bg.addColorStop(0, 'rgba(85,75,48,0.95)');
                bg.addColorStop(0.4, 'rgba(70,62,38,0.92)');
                bg.addColorStop(0.8, 'rgba(55,50,32,0.88)');
                bg.addColorStop(1, 'rgba(48,52,38,0.85)');
                G.beginPath();
                G.arc(0, 0, g.r - 2, 0, Math.PI * 2);
                G.fillStyle = bg;
                G.fill();

                // Rim
                G.beginPath();
                G.arc(0, 0, g.r, 0, Math.PI * 2);
                G.strokeStyle = sel ? '#ffe080' : g.col;
                G.lineWidth = sel ? 3.5 : 2.5;
                G.stroke();

                // Trapezoid teeth
                for (var i = 0; i < g.teeth; i++) {
                    var ta = (i / g.teeth) * Math.PI * 2;
                    var tw = Math.PI / g.teeth * 0.6;
                    var ir = g.r - 2;
                    var or = g.r + g.r * 0.12;
                    G.beginPath();
                    G.moveTo(Math.cos(ta - tw) * ir, Math.sin(ta - tw) * ir);
                    G.lineTo(Math.cos(ta - tw * 0.6) * or, Math.sin(ta - tw * 0.6) * or);
                    G.lineTo(Math.cos(ta + tw * 0.6) * or, Math.sin(ta + tw * 0.6) * or);
                    G.lineTo(Math.cos(ta + tw) * ir, Math.sin(ta + tw) * ir);
                    G.closePath();
                    var cr2 = parseInt(g.col.slice(1,3), 16);
                    var cg2 = parseInt(g.col.slice(3,5), 16);
                    var cb2 = parseInt(g.col.slice(5,7), 16);
                    G.fillStyle = sel ? 'rgba(220,200,120,0.7)' : 'rgba(' + cr2 + ',' + cg2 + ',' + cb2 + ',0.55)';
                    G.fill();
                    G.strokeStyle = 'rgba(100,90,60,0.3)';
                    G.lineWidth = 0.5;
                    G.stroke();
                }

                // Hub
                G.beginPath();
                G.arc(0, 0, g.r * 0.22, 0, Math.PI * 2);
                G.fillStyle = 'rgba(90,80,50,0.9)';
                G.fill();
                G.strokeStyle = g.col;
                G.lineWidth = 1.5;
                G.stroke();

                // Center pin
                G.beginPath();
                G.arc(0, 0, 3, 0, Math.PI * 2);
                G.fillStyle = '#705830';
                G.fill();

                // Spokes
                for (var i = 0; i < 4; i++) {
                    var sa = (i / 4) * Math.PI * 2;
                    G.beginPath();
                    G.moveTo(Math.cos(sa) * g.r * 0.24, Math.sin(sa) * g.r * 0.24);
                    G.lineTo(Math.cos(sa) * g.r * 0.78, Math.sin(sa) * g.r * 0.78);
                    G.strokeStyle = 'rgba(100,90,55,0.45)';
                    G.lineWidth = 2;
                    G.stroke();
                }

                // Verdigris corrosion spots
                for (var i = 0; i < 6; i++) {
                    var spotA = i * 1.1 + idx * 0.8;
                    var spotR = g.r * (0.28 + i * 0.09);
                    G.beginPath();
                    G.arc(Math.cos(spotA) * spotR, Math.sin(spotA) * spotR, 2.5 + i * 1.2, 0, Math.PI * 2);
                    G.fillStyle = 'rgba(55,' + (95 + i * 12) + ',65,' + (0.06 + i * 0.015) + ')';
                    G.fill();
                }

                // Pointer arrow
                G.beginPath();
                G.moveTo(-3, -g.r * 0.28);
                G.lineTo(0, -g.r + 14);
                G.lineTo(3, -g.r * 0.28);
                G.closePath();
                G.fillStyle = '#d4b870';
                G.fill();

                // Indicator dot
                G.beginPath();
                G.arc(0, -g.r + 10, 5, 0, Math.PI * 2);
                G.fillStyle = g.col;
                G.fill();
                G.strokeStyle = '#d4b870';
                G.lineWidth = 1;
                G.stroke();
            }

            G.restore();

            // Label
            G.fillStyle = sel ? '#ffe080' : 'rgba(180,160,100,0.65)';
            G.font = (sel ? 'bold ' : '') + '11px Georgia';
            G.textAlign = 'center';
            G.fillText(g.name.toUpperCase(), g.x, g.y + g.r + 22);
        }

        // === Astronomy Functions ===
        function sunLon() { return ((days / YEAR) * 360) % 360; }
        function moonLon() { return ((days / SIDEREAL) * 360) % 360; }
        function moonPA() { return ((days / SYNODIC) * 360) % 360; }

        function getZod(lon) {
            var nl = ((lon % 360) + 360) % 360;
            return { sign: ZODIAC[Math.floor(nl / 30)], deg: Math.round(nl % 30) };
        }

        function getMPName() { return MPHASES[Math.floor(moonPA() / 45) % 8]; }

        function eclInfo() {
            var sp = days % SAROS;
            var rem = Math.round(SAROS - sp);
            var mo = Math.round(rem / 30);
            var pa = moonPA();
            var nearNew = pa < 15 || pa > 345;
            var nearFull = pa > 165 && pa < 195;
            var imm = rem < 600 && (nearNew || nearFull);
            return { mo: mo, imm: imm, tp: nearNew ? 'Solar' : (nearFull ? 'Lunar' : null) };
        }

        function dateStr() {
            var ty = days / YEAR;
            var yr = Math.floor(100 - ty);
            var mn = Math.floor((days % YEAR) / 30.44);
            mn = Math.max(0, Math.min(11, mn));
            return MONTHS[mn] + ', ' + (Math.abs(yr) || 1) + ' ' + (yr > 0 ? 'BCE' : 'CE');
        }

        function olyStr() {
            var ty = days / YEAR;
            return 'Year ' + (Math.floor(ty % 4) + 1) + ' of Olympiad ' + Math.floor(164 + ty / 4);
        }

        function metStr() {
            var mp = days % METONIC;
            return 'Year ' + (Math.floor(mp / YEAR) + 1) + ' of 19';
        }

        // === Sky Chart ===
        function drawSky() {
            var sc = document.getElementById('skyc');
            var sx = sc.getContext('2d');
            var sz = 222, cx = sz/2, cy = sz/2, oR = 100, iR = 70;
            sx.clearRect(0, 0, sz, sz);

            // Background
            sx.beginPath(); sx.arc(cx, cy, oR + 8, 0, Math.PI * 2);
            sx.fillStyle = 'rgba(10,15,20,0.85)'; sx.fill();

            // Zodiac segments
            for (var i = 0; i < 12; i++) {
                var sa = (i/12) * Math.PI * 2 - Math.PI/2;
                var ea = ((i+1)/12) * Math.PI * 2 - Math.PI/2;
                sx.beginPath();
                sx.arc(cx, cy, oR, sa, ea);
                sx.arc(cx, cy, iR, ea, sa, true);
                sx.closePath();
                sx.fillStyle = i % 2 === 0 ? 'rgba(50,45,30,0.6)' : 'rgba(35,32,22,0.6)';
                sx.fill();
                sx.strokeStyle = 'rgba(112,88,48,0.4)';
                sx.lineWidth = 0.5;
                sx.stroke();

                var ma = (sa + ea) / 2, sr = (oR + iR) / 2;
                sx.fillStyle = '#b8a060';
                sx.font = '14px serif';
                sx.textAlign = 'center';
                sx.textBaseline = 'middle';
                sx.fillText(ZODIAC[i].s, cx + Math.cos(ma) * sr, cy + Math.sin(ma) * sr);
            }

            // Borders
            sx.beginPath(); sx.arc(cx, cy, oR, 0, Math.PI * 2);
            sx.strokeStyle = 'rgba(112,88,48,0.6)'; sx.lineWidth = 2; sx.stroke();
            sx.beginPath(); sx.arc(cx, cy, iR, 0, Math.PI * 2); sx.stroke();

            // Inner star field
            sx.beginPath(); sx.arc(cx, cy, iR - 1, 0, Math.PI * 2);
            sx.fillStyle = 'rgba(8,12,16,0.92)'; sx.fill();

            var stars = [[0.3,0.2],[0.7,0.3],[0.5,0.7],[0.2,0.6],[0.8,0.8],[0.4,0.4],[0.6,0.5],[0.15,0.4],[0.85,0.5]];
            for (var i = 0; i < stars.length; i++) {
                var stx = cx - iR + stars[i][0] * iR * 2;
                var sty = cy - iR + stars[i][1] * iR * 2;
                if (Math.sqrt((stx-cx)*(stx-cx) + (sty-cy)*(sty-cy)) < iR - 5) {
                    sx.beginPath(); sx.arc(stx, sty, 0.9, 0, Math.PI * 2);
                    sx.fillStyle = 'rgba(200,200,220,0.45)'; sx.fill();
                }
            }

            // Sun
            var sunA = (sunLon() / 360) * Math.PI * 2 - Math.PI/2;
            var sunR = (oR + iR) / 2;
            var sunX = cx + Math.cos(sunA) * sunR, sunY = cy + Math.sin(sunA) * sunR;
            var sg = sx.createRadialGradient(sunX, sunY, 0, sunX, sunY, 11);
            sg.addColorStop(0, '#ffdd44'); sg.addColorStop(0.5, '#dd9900'); sg.addColorStop(1, 'transparent');
            sx.beginPath(); sx.arc(sunX, sunY, 9, 0, Math.PI * 2);
            sx.fillStyle = sg; sx.fill();
            sx.fillStyle = '#ffdd44'; sx.font = '11px serif';
            sx.fillText('\u2609', sunX, sunY + 3);

            // Moon
            var mA = (moonLon() / 360) * Math.PI * 2 - Math.PI/2;
            var mR = iR - 15;
            var mX = cx + Math.cos(mA) * mR, mY = cy + Math.sin(mA) * mR;
            sx.beginPath(); sx.arc(mX, mY, 6, 0, Math.PI * 2);
            sx.fillStyle = '#c0c0d0'; sx.fill();
            sx.strokeStyle = '#808090'; sx.lineWidth = 1; sx.stroke();
            sx.fillStyle = '#e0e0f0'; sx.font = '9px serif';
            sx.fillText('\u263D', mX, mY + 3);

            // Eclipse warning glow
            var ei = eclInfo();
            if (ei.imm && ei.tp) {
                sx.beginPath(); sx.arc(cx, cy, oR + 8, 0, Math.PI * 2);
                sx.strokeStyle = 'rgba(200,60,40,0.6)'; sx.lineWidth = 3; sx.stroke();
            }
        }

        // === Moon Phase Display ===
        function drawMoon() {
            var mc = document.getElementById('moonc');
            var mx = mc.getContext('2d');
            var r = 22, cx = 30, cy = 30;
            mx.clearRect(0, 0, 60, 60);

            mx.beginPath(); mx.arc(cx, cy, r, 0, Math.PI * 2);
            mx.fillStyle = '#1a1a25'; mx.fill();
            mx.strokeStyle = '#404060'; mx.lineWidth = 1; mx.stroke();

            var ph = moonPA() / 360;
            var curve = Math.cos(ph * Math.PI * 2);
            mx.beginPath();
            mx.arc(cx, cy, r, -Math.PI/2, Math.PI/2, false);
            mx.ellipse(cx, cy, Math.abs(curve) * r, r, 0, Math.PI/2, -Math.PI/2, curve > 0);
            mx.closePath();
            mx.fillStyle = '#e0dcc8';
            mx.fill();
        }

        // === UI Updates ===
        function updatePanels() {
            var sz = getZod(sunLon()), mz = getZod(moonLon());
            document.getElementById('d-sun').textContent = sz.deg + '\u00B0 ' + sz.sign.s + ' ' + sz.sign.n;
            document.getElementById('d-moon').textContent = mz.deg + '\u00B0 ' + mz.sign.s + ' ' + mz.sign.n;
            document.getElementById('d-phase').textContent = getMPName();

            var ei = eclInfo();
            var ew = document.getElementById('ecl-warn');
            if (ei.imm && ei.tp) {
                ew.classList.add('show');
                document.getElementById('ecl-det').textContent = ei.tp + ' eclipse imminent!';
            } else {
                ew.classList.remove('show');
            }
            document.getElementById('d-ecl').textContent = ei.mo > 1 ? '~' + ei.mo + ' months' : 'IMMINENT';
            document.getElementById('d-oly').textContent = olyStr();
            document.getElementById('d-met').textContent = metStr();
            document.getElementById('date-text').textContent = dateStr();
            document.getElementById('date-sub').textContent = 'Day ' + Math.round(days) + ' \u00B7 ' + (playing ? 'Playing' : 'Paused');

            drawSky();
            drawMoon();
        }

        // === Gear List UI ===
        function buildGL() {
            var c = document.getElementById('gearlist');
            c.innerHTML = '';
            for (var i = 0; i < gears.length; i++) {
                (function(idx) {
                    var d = document.createElement('div');
                    d.className = 'gear-item' + (idx === selGear ? ' active' : '');
                    d.innerHTML = '<div class="gear-dot" style="background:' + gears[idx].col + '"></div><span>' + gears[idx].name + '</span>';
                    d.addEventListener('click', function() {
                        selGear = selGear === idx ? -1 : idx;
                        buildGL();
                    });
                    c.appendChild(d);
                })(i);
            }
            if (selGear >= 0) {
                var dd = document.createElement('div');
                dd.style.cssText = 'font-size:10px;opacity:0.7;margin-top:6px;padding:6px;background:rgba(30,25,15,0.4);border-radius:4px';
                dd.textContent = gears[selGear].desc;
                c.appendChild(dd);
            }
        }

        // === Event Handlers ===
        document.getElementById('btn-play').addEventListener('click', function() { playing = true; upPause(); });
        document.getElementById('btn-stop').addEventListener('click', function() { playing = false; upPause(); });
        document.getElementById('b-day').addEventListener('click', function() { days += 1; });
        document.getElementById('b-month').addEventListener('click', function() { days += 30; });
        document.getElementById('b-year').addEventListener('click', function() { days += YEAR; });
        document.getElementById('b-oly').addEventListener('click', function() { days += OLY; });
        document.getElementById('b-saros').addEventListener('click', function() { days += SAROS; });
        document.getElementById('b-reset').addEventListener('click', function() { days = 0; });
        document.getElementById('b-xray').addEventListener('click', function() { xrayMode = !xrayMode; saveS(); });

        document.getElementById('spd').addEventListener('input', function(e) {
            var v = +e.target.value;
            if (v < 20) speed = v * 1.5;
            else if (v < 50) speed = 30 + (v - 20) * 3;
            else if (v < 80) speed = 120 + (v - 50) * 12;
            else speed = 480 + (v - 80) * 50;
            var lb;
            if (speed < 35) lb = Math.round(speed) + ' d/s';
            else if (speed < 400) lb = (speed / 30).toFixed(1) + ' mo/s';
            else lb = (speed / YEAR).toFixed(1) + ' yr/s';
            document.getElementById('spd-val').textContent = lb;
        });

        function upPause() { document.getElementById('plabel').style.display = playing ? 'none' : 'block'; }

        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') { e.preventDefault(); playing = !playing; upPause(); }
            if (e.code === 'ArrowRight') days += speed / 30;
            if (e.code === 'ArrowLeft') days = Math.max(0, days - speed / 30);
            if (e.code === 'ArrowUp') days += speed / 5;
            if (e.code === 'ArrowDown') days = Math.max(0, days - speed / 5);
        });

        // Gear dragging
        MC.addEventListener('mousedown', function(e) {
            layoutGears();
            var mx = e.clientX, my = e.clientY;
            for (var i = 0; i < gears.length; i++) {
                var g = gears[i];
                var d = Math.sqrt((mx - g.x) * (mx - g.x) + (my - g.y) * (my - g.y));
                if (d < g.r + 12) {
                    isDrag = true;
                    lastDX = mx;
                    selGear = i;
                    buildGL();
                    break;
                }
            }
        });
        MC.addEventListener('mousemove', function(e) {
            if (isDrag) { days += (e.clientX - lastDX) * 0.5; days = Math.max(0, days); lastDX = e.clientX; }
        });
        MC.addEventListener('mouseup', function() { isDrag = false; });

        // Learn panel
        document.getElementById('ltoggle').addEventListener('click', function() {
            var el = document.getElementById('lbox');
            var o = el.classList.toggle('open');
            document.getElementById('ltoggle').textContent = (o ? '\u25BC' : '\u25B6') + ' History & Science';
            saveS();
        });

        // === localStorage ===
        var SK = 'antikythera-mechanism-v2';
        function saveS() {
            try {
                localStorage.setItem(SK, JSON.stringify({
                    days: days,
                    playing: playing,
                    speed: speed,
                    xrayMode: xrayMode,
                    selGear: selGear,
                    lo: document.getElementById('lbox').classList.contains('open'),
                    sv: document.getElementById('spd').value
                }));
            } catch(e) {}
        }
        function loadS() {
            try {
                var s = JSON.parse(localStorage.getItem(SK));
                if (!s) return;
                days = s.days || 0;
                playing = s.playing || false;
                speed = s.speed || 30;
                xrayMode = s.xrayMode || false;
                selGear = (s.selGear != null) ? s.selGear : -1;
                if (s.sv) document.getElementById('spd').value = s.sv;
                if (s.lo) {
                    document.getElementById('lbox').classList.add('open');
                    document.getElementById('ltoggle').textContent = '\u25BC History & Science';
                }
                upPause();
            } catch(e) {}
        }
        setInterval(saveS, 5000);

        // === Main Loop ===
        var lt = 0;
        function animate(now) {
            var dt = Math.min(0.1, (now - lt) / 1000) || 0.016;
            lt = now;
            if (playing) days += speed * dt;

            drawBackground();
            drawAxles();
            for (var i = 0; i < gears.length; i++) {
                drawOneGear(gears[i], i);
            }
            updatePanels();
            requestAnimationFrame(animate);
        }

        // === Init ===
        loadS();
        layoutGears();
        buildGL();
        requestAnimationFrame(animate);
    })();
    </script>
</body>
</html>