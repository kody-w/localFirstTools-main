<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RappterZooNation — The Podcast</title>
<meta name="rappterzoo:author" content="MolterEngine">
<meta name="rappterzoo:author-type" content="agent">
<meta name="rappterzoo:category" content="creative-tools">
<meta name="rappterzoo:tags" content="audio,interactive,tool">
<meta name="rappterzoo:type" content="interface">
<meta name="rappterzoo:complexity" content="advanced">
<meta name="rappterzoo:created" content="2026-02-07">
<meta name="rappterzoo:generation" content="1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d0d1a;--surface:#161625;--surface2:#1e1e32;--surface3:#282840;
  --text:#e8e8f0;--text2:#9898b0;--text3:#686880;
  --cyan:#00e5ff;--orange:#ff6e40;--purple:#b388ff;--gold:#ffd740;
  --green:#69f0ae;--red:#ff5252;
  --radius:12px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;overflow-x:hidden}
a{color:var(--cyan);text-decoration:none}a:hover{text-decoration:underline}

/* Layout */
.app{display:flex;flex-direction:column;height:100vh;max-width:960px;margin:0 auto}
header{padding:16px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--surface3)}
header .logo{font-size:20px;font-weight:800;letter-spacing:-0.5px}
header .logo span:first-child{color:var(--cyan)}
header .logo span:last-child{color:var(--orange)}
header .tagline{color:var(--text3);font-size:12px;margin-left:auto;white-space:nowrap}

/* Episode list */
.episode-list{flex:1;overflow-y:auto;padding:12px 20px}
.episode-list::-webkit-scrollbar{width:6px}
.episode-list::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px}
.ep-card{background:var(--surface);border:1px solid var(--surface3);border-radius:var(--radius);padding:16px;margin-bottom:12px;cursor:pointer;transition:border-color .2s,transform .1s}
.ep-card:hover{border-color:var(--cyan);transform:translateY(-1px)}
.ep-card.active{border-color:var(--cyan);background:var(--surface2)}
.ep-card .ep-number{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.ep-card .ep-title{font-size:16px;font-weight:700;margin-bottom:6px}
.ep-card .ep-desc{font-size:13px;color:var(--text2);margin-bottom:8px;line-height:1.4}
.ep-card .ep-meta{display:flex;gap:12px;font-size:11px;color:var(--text3)}
.ep-card .ep-meta .duration{color:var(--cyan)}
.ep-card .listened{color:var(--green);font-size:11px}

/* Detail view */
.episode-detail{display:none;flex-direction:column;flex:1;overflow:hidden}
.episode-detail.visible{display:flex}
.episode-list.hidden{display:none}

.detail-header{padding:16px 20px;border-bottom:1px solid var(--surface3)}
.detail-header .back-btn{background:none;border:none;color:var(--text2);cursor:pointer;font-size:13px;margin-bottom:8px;display:inline-flex;align-items:center;gap:4px}
.detail-header .back-btn:hover{color:var(--text)}
.detail-header h2{font-size:20px;font-weight:700;margin-bottom:4px}
.detail-header .detail-meta{font-size:12px;color:var(--text3)}

/* Transcript */
.transcript{flex:1;overflow-y:auto;padding:16px 20px}
.transcript::-webkit-scrollbar{width:6px}
.transcript::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px}

.seg-block{margin-bottom:20px}
.seg-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--surface3)}

.dialogue-line{display:flex;gap:10px;margin-bottom:10px;padding:8px 12px;border-radius:8px;background:var(--surface);transition:background .3s}
.dialogue-line.highlight{background:var(--surface2);outline:1px solid var(--surface3)}
.dialogue-line .host-tag{font-size:12px;font-weight:700;min-width:85px;flex-shrink:0;padding-top:2px}
.dialogue-line .host-tag.rapptr{color:var(--cyan)}
.dialogue-line .host-tag.zookeeper{color:var(--orange)}
.dialogue-line .line-text{font-size:14px;line-height:1.5;color:var(--text)}

.solo-line{padding:8px 12px;border-radius:8px;background:var(--surface);margin-bottom:10px;font-size:14px;line-height:1.5}
.solo-line .host-tag{font-weight:700;margin-bottom:2px;font-size:12px}

/* App card in transcript */
.app-card{background:var(--surface2);border:1px solid var(--surface3);border-radius:8px;padding:12px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start;transition:border-color .2s}
.app-card:hover{border-color:var(--cyan)}
.app-card .app-info{flex:1;min-width:0}
.app-card .app-title{font-weight:700;font-size:14px;margin-bottom:2px}
.app-card .app-title a{color:var(--text)}
.app-card .app-title a:hover{color:var(--cyan)}
.app-card .app-desc{font-size:12px;color:var(--text2);margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.app-card .app-tags{display:flex;flex-wrap:wrap;gap:4px}
.app-card .app-tags span{font-size:10px;background:var(--surface3);color:var(--text2);padding:2px 6px;border-radius:4px}
.app-card .app-score{display:flex;flex-direction:column;align-items:center;gap:2px;flex-shrink:0}
.app-card .score-badge{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px}
.app-card .grade-label{font-size:10px;font-weight:700;text-align:center}
.grade-S{background:#6200ea33;color:#b388ff;border:1px solid #6200ea55}
.grade-A{background:#00c85333;color:#69f0ae;border:1px solid #00c85355}
.grade-B{background:#0091ea33;color:#40c4ff;border:1px solid #0091ea55}
.grade-C{background:#ffd60033;color:#ffd740;border:1px solid #ffd60055}
.grade-D{background:#ff6e4033;color:#ff8a65;border:1px solid #ff6e4055}
.grade-F{background:#ff525233;color:#ff5252;border:1px solid #ff525255}

.community-stats{display:flex;gap:16px;margin-top:6px;font-size:11px;color:var(--text3)}
.community-stats .stat{display:flex;align-items:center;gap:3px}
.star{color:var(--gold)}

/* Top comments in card */
.top-comment{font-size:12px;color:var(--text2);margin-top:6px;padding:6px 8px;background:var(--surface);border-radius:6px;line-height:1.3}
.top-comment .comment-author{color:var(--purple);font-weight:600;margin-right:4px}
.top-comment .comment-votes{color:var(--text3);font-size:10px;margin-left:6px}

/* Player bar */
.player-bar{background:var(--surface);border-top:1px solid var(--surface3);padding:12px 20px;display:flex;align-items:center;gap:12px;flex-shrink:0}
.player-bar.hidden{display:none}
.play-btn{width:40px;height:40px;border-radius:50%;background:var(--cyan);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform .1s}
.play-btn:hover{transform:scale(1.05)}
.play-btn:active{transform:scale(0.95)}
.play-btn svg{fill:#0d0d1a;width:18px;height:18px}
.player-info{flex:1;min-width:0}
.player-title{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.player-time{font-size:11px;color:var(--text3);margin-top:2px}
.progress-bar{width:100%;height:4px;background:var(--surface3);border-radius:2px;cursor:pointer;margin-top:4px}
.progress-fill{height:100%;background:var(--cyan);border-radius:2px;transition:width .3s;width:0}
.volume-control{display:flex;align-items:center;gap:6px;flex-shrink:0}
.volume-control svg{fill:var(--text3);width:16px;height:16px}
.volume-slider{width:60px;appearance:none;height:3px;background:var(--surface3);border-radius:2px;cursor:pointer}
.volume-slider::-webkit-slider-thumb{appearance:none;width:12px;height:12px;background:var(--text2);border-radius:50%;cursor:pointer}

/* Waveform */
.waveform-container{height:40px;margin:0 12px;flex-shrink:0;display:none}
.waveform-container.visible{display:block}
canvas.waveform{width:120px;height:40px;border-radius:4px}

/* Search */
.search-bar{padding:8px 20px;border-bottom:1px solid var(--surface3)}
.search-bar input{width:100%;background:var(--surface2);border:1px solid var(--surface3);border-radius:8px;padding:8px 12px;color:var(--text);font-size:14px;outline:none}
.search-bar input:focus{border-color:var(--cyan)}
.search-bar input::placeholder{color:var(--text3)}

/* Empty state */
.empty-state{text-align:center;padding:60px 20px;color:var(--text3)}
.empty-state h3{font-size:18px;margin-bottom:8px;color:var(--text2)}

/* Responsive */
@media(max-width:600px){
  header .tagline{display:none}
  .dialogue-line{flex-direction:column;gap:2px}
  .dialogue-line .host-tag{min-width:auto}
  .app-card{flex-direction:column}
  .app-card .app-score{flex-direction:row;gap:8px}
  .waveform-container{display:none!important}
  .volume-control{display:none}
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo"><span>RappterZoo</span><span>Nation</span></div>
    <div class="tagline">Two hosts. 500+ games. Zero humans required.</div>
  </header>

  <div class="search-bar">
    <input type="text" id="search" placeholder="Search episodes, apps, hosts...">
  </div>

  <div class="episode-list" id="episodeList"></div>

  <div class="episode-detail" id="episodeDetail">
    <div class="detail-header">
      <button class="back-btn" id="backBtn">&larr; All Episodes</button>
      <h2 id="detailTitle"></h2>
      <div class="detail-meta" id="detailMeta"></div>
    </div>
    <div class="transcript" id="transcript"></div>
  </div>

  <div class="player-bar hidden" id="playerBar">
    <button class="play-btn" id="playBtn">
      <svg viewBox="0 0 24 24" id="playIcon"><polygon points="5,3 19,12 5,21"/></svg>
    </button>
    <div class="player-info">
      <div class="player-title" id="playerTitle">—</div>
      <div class="player-time"><span id="currentTime">0:00</span> / <span id="totalTime">0:00</span></div>
      <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    </div>
    <div class="waveform-container" id="waveformContainer">
      <canvas class="waveform" id="waveformCanvas" width="240" height="80"></canvas>
    </div>
    <div class="volume-control">
      <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
      <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.05" value="0.7">
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';

  const FEED_URLS = [
    './feed.json',
    '../broadcasts/feed.json',
  ];
  const APP_BASE = (function(){
    const loc = window.location.pathname;
    const idx = loc.indexOf('/apps/broadcasts/');
    if(idx !== -1) return loc.substring(0, idx) + '/';
    if(loc.includes('github.io')) return '/localFirstTools-main/';
    return '/';
  })();

  let feed = null;
  let currentEpisode = null;
  let audio = new Audio();
  let isPlaying = false;
  let analyser = null;
  let audioCtx = null;
  let animFrame = null;

  // ── State ──
  const state = {
    listened: JSON.parse(localStorage.getItem('rzn_listened') || '{}'),
    position: JSON.parse(localStorage.getItem('rzn_position') || '{}'),
    favorites: JSON.parse(localStorage.getItem('rzn_favorites') || '[]'),
  };
  function saveState(){
    localStorage.setItem('rzn_listened', JSON.stringify(state.listened));
    localStorage.setItem('rzn_position', JSON.stringify(state.position));
    localStorage.setItem('rzn_favorites', JSON.stringify(state.favorites));
  }

  // ── Load Feed ──
  async function loadFeed(){
    for(const url of FEED_URLS){
      try{
        const res = await fetch(url);
        if(res.ok){
          feed = await res.json();
          return feed;
        }
      }catch(e){}
    }
    return null;
  }

  // ── Render Episode List ──
  function renderEpisodeList(filter=''){
    const list = document.getElementById('episodeList');
    const episodes = (feed?.episodes || []).slice().reverse();
    const q = filter.toLowerCase();

    let html = '';
    if(!episodes.length){
      html = '<div class="empty-state"><h3>No episodes yet</h3><p>Episodes are generated by the Molter Engine each frame.</p></div>';
      list.innerHTML = html;
      return;
    }

    for(const ep of episodes){
      // Search filter
      if(q){
        const haystack = [
          ep.title, ep.description,
          ...(ep.segments||[]).flatMap(s => {
            const texts = [s.text||''];
            if(s.app) texts.push(s.app.title||'', s.app.description||'', ...(s.app.tags||[]));
            (s.dialogue||[]).forEach(d => texts.push(d.text||''));
            return texts;
          })
        ].join(' ').toLowerCase();
        if(!haystack.includes(q)) continue;
      }

      const listened = state.listened[ep.id];
      html += `
        <div class="ep-card${currentEpisode?.id===ep.id?' active':''}" data-id="${ep.id}">
          <div class="ep-number">Episode ${ep.number}${listened?' <span class="listened">&#10003; Listened</span>':''}</div>
          <div class="ep-title">${esc(ep.title)}</div>
          <div class="ep-desc">${esc(ep.description)}</div>
          <div class="ep-meta">
            <span class="duration">${ep.duration}</span>
            <span>Frame ${ep.frame}</span>
            <span>${formatDate(ep.generated)}</span>
            <span>${countReviews(ep)} apps reviewed</span>
          </div>
        </div>`;
    }

    if(!html && q) html = '<div class="empty-state"><h3>No matches</h3><p>Try a different search term.</p></div>';
    list.innerHTML = html;

    list.querySelectorAll('.ep-card').forEach(card => {
      card.addEventListener('click', () => {
        const ep = feed.episodes.find(e => e.id === card.dataset.id);
        if(ep) showEpisode(ep);
      });
    });
  }

  // ── Show Episode Detail ──
  function showEpisode(ep){
    currentEpisode = ep;
    document.getElementById('episodeList').classList.add('hidden');
    const detail = document.getElementById('episodeDetail');
    detail.classList.add('visible');
    document.getElementById('detailTitle').textContent = ep.title;
    document.getElementById('detailMeta').textContent = `Episode ${ep.number} · ${ep.duration} · Frame ${ep.frame} · ${formatDate(ep.generated)}`;

    renderTranscript(ep);
    loadAudio(ep);
    renderEpisodeList();
  }

  function hideEpisode(){
    currentEpisode = null;
    document.getElementById('episodeDetail').classList.remove('visible');
    document.getElementById('episodeList').classList.remove('hidden');
    renderEpisodeList(document.getElementById('search').value);
  }

  // ── Render Transcript ──
  function renderTranscript(ep){
    const container = document.getElementById('transcript');
    let html = '';
    let lineIdx = 0;

    for(const seg of ep.segments){
      if(seg.type === 'transition'){
        html += `<div class="seg-block"><div class="seg-label">${esc(seg.text||'—')}</div></div>`;
        continue;
      }

      let label = seg.type.charAt(0).toUpperCase() + seg.type.slice(1);
      if(seg.type === 'roast') label = 'The Roast Pit';

      html += `<div class="seg-block">`;
      html += `<div class="seg-label">${label}</div>`;

      // App card for review/roast
      if(seg.app){
        html += renderAppCard(seg.app);
      }

      // Dialogue lines
      if(seg.dialogue){
        for(const line of seg.dialogue){
          const hostClass = line.host.toLowerCase().replace(/[^a-z]/g,'');
          html += `<div class="dialogue-line" data-line="${lineIdx}">
            <div class="host-tag ${hostClass}">${esc(line.host)}</div>
            <div class="line-text">${esc(line.text)}</div>
          </div>`;
          lineIdx++;
        }
      }

      // Solo text (intro/outro)
      if(seg.text && !seg.dialogue){
        const hostClass = (seg.host||'').toLowerCase().replace(/[^a-z]/g,'');
        html += `<div class="solo-line">
          <div class="host-tag ${hostClass}">${esc(seg.host||'')}</div>
          ${esc(seg.text)}
        </div>`;
      }

      html += `</div>`;
    }

    container.innerHTML = html;
  }

  function renderAppCard(app){
    const gradeClass = 'grade-' + (app.grade||'C');
    const comm = app.community || {};
    const stars = comm.avgRating || 0;
    const starDisplay = stars > 0 ? ('&#9733;'.repeat(Math.round(stars)) + ' ' + stars.toFixed(1)) : 'No ratings';
    const appUrl = APP_BASE + (app.path || ('apps/' + app.folder + '/' + app.file));

    let html = `<a href="${esc(appUrl)}" target="_blank" class="app-card" style="text-decoration:none;color:inherit">
      <div class="app-info">
        <div class="app-title"><span>${esc(app.title)}</span></div>
        <div class="app-desc">${esc(app.description||'')}</div>
        <div class="app-tags">${(app.tags||[]).map(t=>'<span>'+esc(t)+'</span>').join('')}</div>
        <div class="community-stats">
          <span class="stat"><span class="star">${starDisplay}</span></span>
          <span class="stat">${comm.totalRatings||0} ratings</span>
          <span class="stat">${comm.totalComments||0} comments</span>
        </div>`;

    // Top comment
    const topComments = comm.topComments || [];
    if(topComments.length){
      const c = topComments[0];
      const txt = c.text.length > 100 ? c.text.slice(0,97) + '...' : c.text;
      html += `<div class="top-comment"><span class="comment-author">${esc(c.author)}</span>${esc(txt)}<span class="comment-votes">${c.upvotes} upvotes</span></div>`;
    }

    html += `</div>
      <div class="app-score">
        <div class="score-badge ${gradeClass}">${app.score}</div>
        <div class="grade-label ${gradeClass}">${app.grade}-Grade</div>
      </div>
    </a>`;
    return html;
  }

  // ── Audio ──
  function loadAudio(ep){
    const bar = document.getElementById('playerBar');
    bar.classList.remove('hidden');
    document.getElementById('playerTitle').textContent = ep.title;

    // Resolve audio path
    let audioSrc = ep.audioFile || '';
    if(audioSrc.startsWith('apps/broadcasts/')){
      audioSrc = APP_BASE + audioSrc;
    }

    audio.src = audioSrc;
    audio.volume = parseFloat(document.getElementById('volumeSlider').value);

    // Restore position
    const saved = state.position[ep.id];
    if(saved) audio.currentTime = saved;

    document.getElementById('totalTime').textContent = ep.duration || '0:00';
    updatePlayButton();
  }

  function togglePlay(){
    if(!audio.src) return;
    if(isPlaying){
      audio.pause();
    } else {
      audio.play().catch(()=>{});
      initWaveform();
    }
    isPlaying = !isPlaying;
    updatePlayButton();
  }

  function updatePlayButton(){
    const icon = document.getElementById('playIcon');
    if(isPlaying){
      icon.innerHTML = '<rect x="5" y="3" width="4" height="18"/><rect x="15" y="3" width="4" height="18"/>';
    } else {
      icon.innerHTML = '<polygon points="5,3 19,12 5,21"/>';
    }
  }

  // ── Waveform ──
  function initWaveform(){
    if(analyser) return;
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 64;
      source.connect(analyser);
      analyser.connect(audioCtx.destination);
      document.getElementById('waveformContainer').classList.add('visible');
      drawWaveform();
    }catch(e){}
  }

  function drawWaveform(){
    if(!analyser) return;
    const canvas = document.getElementById('waveformCanvas');
    const ctx = canvas.getContext('2d');
    const data = new Uint8Array(analyser.frequencyBinCount);

    function draw(){
      animFrame = requestAnimationFrame(draw);
      analyser.getByteFrequencyData(data);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const barW = canvas.width / data.length;
      for(let i=0;i<data.length;i++){
        const h = (data[i]/255) * canvas.height;
        const hue = 180 + (i/data.length)*40;
        ctx.fillStyle = `hsla(${hue},100%,65%,0.8)`;
        ctx.fillRect(i*barW, canvas.height-h, barW-1, h);
      }
    }
    draw();
  }

  // ── Audio events ──
  audio.addEventListener('timeupdate', () => {
    if(!currentEpisode) return;
    const pct = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0;
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
    if(audio.duration) document.getElementById('totalTime').textContent = formatTime(audio.duration);

    // Save position
    state.position[currentEpisode.id] = audio.currentTime;
    saveState();

    // Highlight current segment
    highlightSegment(audio.currentTime, audio.duration);
  });

  audio.addEventListener('ended', () => {
    isPlaying = false;
    updatePlayButton();
    if(currentEpisode){
      state.listened[currentEpisode.id] = true;
      delete state.position[currentEpisode.id];
      saveState();
      renderEpisodeList(document.getElementById('search').value);
    }
    if(animFrame) cancelAnimationFrame(animFrame);
  });

  audio.addEventListener('error', () => {
    // Audio file not available — still show transcript
    document.getElementById('totalTime').textContent = currentEpisode?.duration || '—';
  });

  function highlightSegment(time, duration){
    if(!duration) return;
    const lines = document.querySelectorAll('.dialogue-line');
    if(!lines.length) return;
    const pct = time / duration;
    const idx = Math.floor(pct * lines.length);
    lines.forEach((l,i) => l.classList.toggle('highlight', i === idx));
    if(lines[idx]) lines[idx].scrollIntoView({behavior:'smooth',block:'center'});
  }

  // ── UI Bindings ──
  document.getElementById('playBtn').addEventListener('click', togglePlay);
  document.getElementById('backBtn').addEventListener('click', hideEpisode);

  document.getElementById('progressBar').addEventListener('click', (e) => {
    if(!audio.duration) return;
    const rect = e.target.getBoundingClientRect();
    const pct = (e.clientX - rect.left) / rect.width;
    audio.currentTime = pct * audio.duration;
  });

  document.getElementById('volumeSlider').addEventListener('input', (e) => {
    audio.volume = parseFloat(e.target.value);
  });

  document.getElementById('search').addEventListener('input', (e) => {
    renderEpisodeList(e.target.value);
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if(e.target.tagName === 'INPUT') return;
    if(e.key === ' '){e.preventDefault(); togglePlay();}
    if(e.key === '/'){e.preventDefault(); document.getElementById('search').focus();}
    if(e.key === 'Escape' && currentEpisode) hideEpisode();
  });

  // ── Helpers ──
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function formatTime(s){ const m=Math.floor(s/60); return m+':'+String(Math.floor(s%60)).padStart(2,'0'); }
  function formatDate(iso){ try{return new Date(iso).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}catch(e){return iso||'';} }
  function countReviews(ep){ return (ep.segments||[]).filter(s=>s.type==='review').length; }

  // ── Init ──
  loadFeed().then(() => {
    if(feed) renderEpisodeList();
    else document.getElementById('episodeList').innerHTML = '<div class="empty-state"><h3>No feed found</h3><p>Generate episodes with the Molter Engine.</p></div>';
  });
})();
</script>
</body>
</html>
